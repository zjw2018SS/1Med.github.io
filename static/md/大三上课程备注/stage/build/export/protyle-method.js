(()=>{var Cl=(Wt,ze)=>()=>(ze||Wt((ze={exports:{}}).exports,ze),ze.exports);var Al=Cl((yn,ga)=>{(function(ze,Ie){typeof yn=="object"&&typeof ga=="object"?ga.exports=Ie():typeof define=="function"&&define.amd?define([],Ie):typeof yn=="object"?yn.Protyle=Ie():ze.Protyle=Ie()})(self,()=>(()=>{var Wt={752:function(De){(function(ae,re){De.exports=re()})(this,function(){"use strict";var ae=1e3,re=6e4,xt=36e5,Ye="millisecond",de="second",H="minute",N="hour",U="day",z="week",K="month",Y="quarter",X="year",se="date",we="Invalid Date",_e=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,ue=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,bt={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},nt=function(ee,O,R){var Z=String(ee);return!Z||Z.length>=O?ee:""+Array(O+1-Z.length).join(R)+ee},ce={s:nt,z:function(ee){var O=-ee.utcOffset(),R=Math.abs(O),Z=Math.floor(R/60),B=R%60;return(O<=0?"+":"-")+nt(Z,2,"0")+":"+nt(B,2,"0")},m:function ee(O,R){if(O.date()<R.date())return-ee(R,O);var Z=12*(R.year()-O.year())+(R.month()-O.month()),B=O.clone().add(Z,K),V=R-B<0,J=O.clone().add(Z+(V?-1:1),K);return+(-(Z+(R-B)/(V?B-J:J-B))||0)},a:function(ee){return ee<0?Math.ceil(ee)||0:Math.floor(ee)},p:function(ee){return{M:K,y:X,w:z,d:U,D:se,h:N,m:H,s:de,ms:Ye,Q:Y}[ee]||String(ee||"").toLowerCase().replace(/s$/,"")},u:function(ee){return ee===void 0}},at="en",Ne={};Ne[at]=bt;var x=function(ee){return ee instanceof st},Be=function ee(O,R,Z){var B;if(!O)return at;if(typeof O=="string"){var V=O.toLowerCase();Ne[V]&&(B=V),R&&(Ne[V]=R,B=V);var J=O.split("-");if(!B&&J.length>1)return ee(J[0])}else{var le=O.name;Ne[le]=O,B=le}return!Z&&B&&(at=B),B||!Z&&at},pe=function(ee,O){if(x(ee))return ee.clone();var R=typeof O=="object"?O:{};return R.date=ee,R.args=arguments,new st(R)},oe=ce;oe.l=Be,oe.i=x,oe.w=function(ee,O){return pe(ee,{locale:O.$L,utc:O.$u,x:O.$x,$offset:O.$offset})};var st=function(){function ee(R){this.$L=Be(R.locale,null,!0),this.parse(R)}var O=ee.prototype;return O.parse=function(R){this.$d=function(Z){var B=Z.date,V=Z.utc;if(B===null)return new Date(NaN);if(oe.u(B))return new Date;if(B instanceof Date)return new Date(B);if(typeof B=="string"&&!/Z$/i.test(B)){var J=B.match(_e);if(J){var le=J[2]-1||0,me=(J[7]||"0").substring(0,3);return V?new Date(Date.UTC(J[1],le,J[3]||1,J[4]||0,J[5]||0,J[6]||0,me)):new Date(J[1],le,J[3]||1,J[4]||0,J[5]||0,J[6]||0,me)}}return new Date(B)}(R),this.$x=R.x||{},this.init()},O.init=function(){var R=this.$d;this.$y=R.getFullYear(),this.$M=R.getMonth(),this.$D=R.getDate(),this.$W=R.getDay(),this.$H=R.getHours(),this.$m=R.getMinutes(),this.$s=R.getSeconds(),this.$ms=R.getMilliseconds()},O.$utils=function(){return oe},O.isValid=function(){return this.$d.toString()!==we},O.isSame=function(R,Z){var B=pe(R);return this.startOf(Z)<=B&&B<=this.endOf(Z)},O.isAfter=function(R,Z){return pe(R)<this.startOf(Z)},O.isBefore=function(R,Z){return this.endOf(Z)<pe(R)},O.$g=function(R,Z,B){return oe.u(R)?this[Z]:this.set(B,R)},O.unix=function(){return Math.floor(this.valueOf()/1e3)},O.valueOf=function(){return this.$d.getTime()},O.startOf=function(R,Z){var B=this,V=!!oe.u(Z)||Z,J=oe.p(R),le=function(Pe,ve){var Te=oe.w(B.$u?Date.UTC(B.$y,ve,Pe):new Date(B.$y,ve,Pe),B);return V?Te:Te.endOf(U)},me=function(Pe,ve){return oe.w(B.toDate()[Pe].apply(B.toDate("s"),(V?[0,0,0,0]:[23,59,59,999]).slice(ve)),B)},ge=this.$W,he=this.$M,Ke=this.$D,Ce="set"+(this.$u?"UTC":"");switch(J){case X:return V?le(1,0):le(31,11);case K:return V?le(1,he):le(0,he+1);case z:var it=this.$locale().weekStart||0,ht=(ge<it?ge+7:ge)-it;return le(V?Ke-ht:Ke+(6-ht),he);case U:case se:return me(Ce+"Hours",0);case N:return me(Ce+"Minutes",1);case H:return me(Ce+"Seconds",2);case de:return me(Ce+"Milliseconds",3);default:return this.clone()}},O.endOf=function(R){return this.startOf(R,!1)},O.$set=function(R,Z){var B,V=oe.p(R),J="set"+(this.$u?"UTC":""),le=(B={},B[U]=J+"Date",B[se]=J+"Date",B[K]=J+"Month",B[X]=J+"FullYear",B[N]=J+"Hours",B[H]=J+"Minutes",B[de]=J+"Seconds",B[Ye]=J+"Milliseconds",B)[V],me=V===U?this.$D+(Z-this.$W):Z;if(V===K||V===X){var ge=this.clone().set(se,1);ge.$d[le](me),ge.init(),this.$d=ge.set(se,Math.min(this.$D,ge.daysInMonth())).$d}else le&&this.$d[le](me);return this.init(),this},O.set=function(R,Z){return this.clone().$set(R,Z)},O.get=function(R){return this[oe.p(R)]()},O.add=function(R,Z){var B,V=this;R=Number(R);var J=oe.p(Z),le=function(he){var Ke=pe(V);return oe.w(Ke.date(Ke.date()+Math.round(he*R)),V)};if(J===K)return this.set(K,this.$M+R);if(J===X)return this.set(X,this.$y+R);if(J===U)return le(1);if(J===z)return le(7);var me=(B={},B[H]=re,B[N]=xt,B[de]=ae,B)[J]||1,ge=this.$d.getTime()+R*me;return oe.w(ge,this)},O.subtract=function(R,Z){return this.add(-1*R,Z)},O.format=function(R){var Z=this,B=this.$locale();if(!this.isValid())return B.invalidDate||we;var V=R||"YYYY-MM-DDTHH:mm:ssZ",J=oe.z(this),le=this.$H,me=this.$m,ge=this.$M,he=B.weekdays,Ke=B.months,Ce=function(ve,Te,Vt,Tt){return ve&&(ve[Te]||ve(Z,V))||Vt[Te].slice(0,Tt)},it=function(ve){return oe.s(le%12||12,ve,"0")},ht=B.meridiem||function(ve,Te,Vt){var Tt=ve<12?"AM":"PM";return Vt?Tt.toLowerCase():Tt},Pe={YY:String(this.$y).slice(-2),YYYY:this.$y,M:ge+1,MM:oe.s(ge+1,2,"0"),MMM:Ce(B.monthsShort,ge,Ke,3),MMMM:Ce(Ke,ge),D:this.$D,DD:oe.s(this.$D,2,"0"),d:String(this.$W),dd:Ce(B.weekdaysMin,this.$W,he,2),ddd:Ce(B.weekdaysShort,this.$W,he,3),dddd:he[this.$W],H:String(le),HH:oe.s(le,2,"0"),h:it(1),hh:it(2),a:ht(le,me,!0),A:ht(le,me,!1),m:String(me),mm:oe.s(me,2,"0"),s:String(this.$s),ss:oe.s(this.$s,2,"0"),SSS:oe.s(this.$ms,3,"0"),Z:J};return V.replace(ue,function(ve,Te){return Te||Pe[ve]||J.replace(":","")})},O.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},O.diff=function(R,Z,B){var V,J=oe.p(Z),le=pe(R),me=(le.utcOffset()-this.utcOffset())*re,ge=this-le,he=oe.m(this,le);return he=(V={},V[X]=he/12,V[K]=he,V[Y]=he/3,V[z]=(ge-me)/6048e5,V[U]=(ge-me)/864e5,V[N]=ge/xt,V[H]=ge/re,V[de]=ge/ae,V)[J]||ge,B?he:oe.a(he)},O.daysInMonth=function(){return this.endOf(K).$D},O.$locale=function(){return Ne[this.$L]},O.locale=function(R,Z){if(!R)return this.$L;var B=this.clone(),V=Be(R,Z,!0);return V&&(B.$L=V),B},O.clone=function(){return oe.w(this.$d,this)},O.toDate=function(){return new Date(this.valueOf())},O.toJSON=function(){return this.isValid()?this.toISOString():null},O.toISOString=function(){return this.$d.toISOString()},O.toString=function(){return this.$d.toUTCString()},ee}(),wn=st.prototype;return pe.prototype=wn,[["$ms",Ye],["$s",de],["$m",H],["$H",N],["$W",U],["$M",K],["$y",X],["$D",se]].forEach(function(ee){wn[ee[1]]=function(O){return this.$g(O,ee[0],ee[1])}}),pe.extend=function(ee,O){return ee.$i||(ee(O,st,pe),ee.$i=!0),pe},pe.locale=Be,pe.isDayjs=x,pe.unix=function(ee){return pe(1e3*ee)},pe.en=Ne[at],pe.Ls=Ne,pe.p={},pe})},101:De=>{"use strict";function ae(de){if(typeof de!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(de))}function re(de,H){for(var N="",U=0,z=-1,K=0,Y,X=0;X<=de.length;++X){if(X<de.length)Y=de.charCodeAt(X);else{if(Y===47)break;Y=47}if(Y===47){if(!(z===X-1||K===1))if(z!==X-1&&K===2){if(N.length<2||U!==2||N.charCodeAt(N.length-1)!==46||N.charCodeAt(N.length-2)!==46){if(N.length>2){var se=N.lastIndexOf("/");if(se!==N.length-1){se===-1?(N="",U=0):(N=N.slice(0,se),U=N.length-1-N.lastIndexOf("/")),z=X,K=0;continue}}else if(N.length===2||N.length===1){N="",U=0,z=X,K=0;continue}}H&&(N.length>0?N+="/..":N="..",U=2)}else N.length>0?N+="/"+de.slice(z+1,X):N=de.slice(z+1,X),U=X-z-1;z=X,K=0}else Y===46&&K!==-1?++K:K=-1}return N}function xt(de,H){var N=H.dir||H.root,U=H.base||(H.name||"")+(H.ext||"");return N?N===H.root?N+U:N+de+U:U}var Ye={resolve:function(){for(var H="",N=!1,U,z=arguments.length-1;z>=-1&&!N;z--){var K;z>=0?K=arguments[z]:(U===void 0&&(U=process.cwd()),K=U),ae(K),K.length!==0&&(H=K+"/"+H,N=K.charCodeAt(0)===47)}return H=re(H,!N),N?H.length>0?"/"+H:"/":H.length>0?H:"."},normalize:function(H){if(ae(H),H.length===0)return".";var N=H.charCodeAt(0)===47,U=H.charCodeAt(H.length-1)===47;return H=re(H,!N),H.length===0&&!N&&(H="."),H.length>0&&U&&(H+="/"),N?"/"+H:H},isAbsolute:function(H){return ae(H),H.length>0&&H.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var H,N=0;N<arguments.length;++N){var U=arguments[N];ae(U),U.length>0&&(H===void 0?H=U:H+="/"+U)}return H===void 0?".":Ye.normalize(H)},relative:function(H,N){if(ae(H),ae(N),H===N||(H=Ye.resolve(H),N=Ye.resolve(N),H===N))return"";for(var U=1;U<H.length&&H.charCodeAt(U)===47;++U);for(var z=H.length,K=z-U,Y=1;Y<N.length&&N.charCodeAt(Y)===47;++Y);for(var X=N.length,se=X-Y,we=K<se?K:se,_e=-1,ue=0;ue<=we;++ue){if(ue===we){if(se>we){if(N.charCodeAt(Y+ue)===47)return N.slice(Y+ue+1);if(ue===0)return N.slice(Y+ue)}else K>we&&(H.charCodeAt(U+ue)===47?_e=ue:ue===0&&(_e=0));break}var bt=H.charCodeAt(U+ue),nt=N.charCodeAt(Y+ue);if(bt!==nt)break;bt===47&&(_e=ue)}var ce="";for(ue=U+_e+1;ue<=z;++ue)(ue===z||H.charCodeAt(ue)===47)&&(ce.length===0?ce+="..":ce+="/..");return ce.length>0?ce+N.slice(Y+_e):(Y+=_e,N.charCodeAt(Y)===47&&++Y,N.slice(Y))},_makeLong:function(H){return H},dirname:function(H){if(ae(H),H.length===0)return".";for(var N=H.charCodeAt(0),U=N===47,z=-1,K=!0,Y=H.length-1;Y>=1;--Y)if(N=H.charCodeAt(Y),N===47){if(!K){z=Y;break}}else K=!1;return z===-1?U?"/":".":U&&z===1?"//":H.slice(0,z)},basename:function(H,N){if(N!==void 0&&typeof N!="string")throw new TypeError('"ext" argument must be a string');ae(H);var U=0,z=-1,K=!0,Y;if(N!==void 0&&N.length>0&&N.length<=H.length){if(N.length===H.length&&N===H)return"";var X=N.length-1,se=-1;for(Y=H.length-1;Y>=0;--Y){var we=H.charCodeAt(Y);if(we===47){if(!K){U=Y+1;break}}else se===-1&&(K=!1,se=Y+1),X>=0&&(we===N.charCodeAt(X)?--X===-1&&(z=Y):(X=-1,z=se))}return U===z?z=se:z===-1&&(z=H.length),H.slice(U,z)}else{for(Y=H.length-1;Y>=0;--Y)if(H.charCodeAt(Y)===47){if(!K){U=Y+1;break}}else z===-1&&(K=!1,z=Y+1);return z===-1?"":H.slice(U,z)}},extname:function(H){ae(H);for(var N=-1,U=0,z=-1,K=!0,Y=0,X=H.length-1;X>=0;--X){var se=H.charCodeAt(X);if(se===47){if(!K){U=X+1;break}continue}z===-1&&(K=!1,z=X+1),se===46?N===-1?N=X:Y!==1&&(Y=1):N!==-1&&(Y=-1)}return N===-1||z===-1||Y===0||Y===1&&N===z-1&&N===U+1?"":H.slice(N,z)},format:function(H){if(H===null||typeof H!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof H);return xt("/",H)},parse:function(H){ae(H);var N={root:"",dir:"",base:"",ext:"",name:""};if(H.length===0)return N;var U=H.charCodeAt(0),z=U===47,K;z?(N.root="/",K=1):K=0;for(var Y=-1,X=0,se=-1,we=!0,_e=H.length-1,ue=0;_e>=K;--_e){if(U=H.charCodeAt(_e),U===47){if(!we){X=_e+1;break}continue}se===-1&&(we=!1,se=_e+1),U===46?Y===-1?Y=_e:ue!==1&&(ue=1):Y!==-1&&(ue=-1)}return Y===-1||se===-1||ue===0||ue===1&&Y===se-1&&Y===X+1?se!==-1&&(X===0&&z?N.base=N.name=H.slice(1,se):N.base=N.name=H.slice(X,se)):(X===0&&z?(N.name=H.slice(1,Y),N.base=H.slice(1,se)):(N.name=H.slice(X,Y),N.base=H.slice(X,se)),N.ext=H.slice(Y,se)),X>0?N.dir=H.slice(0,X-1):z&&(N.dir="/"),N},sep:"/",delimiter:":",win32:null,posix:null};Ye.posix=Ye,De.exports=Ye}},ze={};function Ie(De){var ae=ze[De];if(ae!==void 0)return ae.exports;var re=ze[De]={exports:{}};return Wt[De].call(re.exports,re,re.exports,Ie),re.exports}Ie.d=(De,ae)=>{for(var re in ae)Ie.o(ae,re)&&!Ie.o(De,re)&&Object.defineProperty(De,re,{enumerable:!0,get:ae[re]})},Ie.o=(De,ae)=>Object.prototype.hasOwnProperty.call(De,ae);var jt={};return(()=>{"use strict";Ie.d(jt,{default:()=>kl});const De=(e,t)=>{if(document.getElementById(t))return!1;const n=new XMLHttpRequest;n.open("GET",e,!1),n.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),n.send("");const a=document.createElement("script");a.type="text/javascript",a.text=n.responseText,a.id=t,document.head.appendChild(a)},ae=(e,t)=>new Promise(n=>{if(document.getElementById(t))return n(!1),!1;const a=document.createElement("script");a.src=e,a.async=!0,document.head.appendChild(a),a.onload=()=>{if(document.getElementById(t))return a.remove(),n(!1),!1;a.id=t,n(!0)}}),re=()=>!!document.getElementById("sidebar"),xt=()=>["docker","ios","android"].includes(window.siyuan.config.system.container)?window.siyuan.config.system.container:window.siyuan.config.system.os,Ye=()=>window.navigator.userAgent.startsWith("SiYuan/")?"mobile":"browser-mobile",de=()=>!document.getElementById("toolbar"),H=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,N=(e,t)=>e.length===t.length&&e.every(n=>t.includes(n)),U=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,z=(e,t=window.location.search)=>{const n=t.substring(t.indexOf("?")),a=n.indexOf("#");return new URLSearchParams(n.substring(0,a>=0?a:void 0)).get(e)},K=()=>!0,Y=e=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(e),X=e=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(e),se=e=>/^[_a-zA-Z][_.\-0-9a-zA-Z]*$/.test(e),we=e=>Function(`"use strict";return (${e})`)(),_e=(e,t)=>{if(e===t||typeof e=="number"&&isNaN(e)&&typeof t=="number"&&isNaN(t))return!0;if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(!e||!t||typeof e!="object"&&typeof t!="object")return e===t;if(e.prototype!==t.prototype)return!1;const n=Object.keys(e);return n.length!==Object.keys(t).length?!1:n.every(a=>_e(e[a],t[a]))},ue=e=>{const t=e.match(/^(.*) \((\d+)\)$/);return t?e=`${t[1]} (${parseInt(t[2])+1})`:e=`${e} (1)`,e},bt="3.1.10",nt="production",ce=navigator.platform.toUpperCase().indexOf("MAC")>-1?"\u2303":"\u2325",at=()=>{const e={};for(let t=1;t<=32;t++)e[t+111]="F"+t;return e},Ne=class{};let x=Ne;x.SIYUAN_VERSION=bt,x.NODE_ENV=nt,x.SIYUAN_APPID=Math.random().toString(36).substring(8),x.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",x.PROTYLE_CDN="/stage/protyle",x.UPLOAD_ADDRESS="/upload",x.SERVICE_WORKER_PATH="/service-worker.js",x.SIYUAN_DROP_FILE="application/siyuan-file",x.SIYUAN_DROP_GUTTER="application/siyuan-gutter",x.SIYUAN_DROP_TAB="application/siyuan-tab",x.SIYUAN_DROP_EDITOR="application/siyuan-editor",x.SIYUAN_CMD="siyuan-cmd",x.SIYUAN_GET="siyuan-get",x.SIYUAN_EVENT="siyuan-event",x.SIYUAN_CONFIG_TRAY="siyuan-config-tray",x.SIYUAN_QUIT="siyuan-quit",x.SIYUAN_HOTKEY="siyuan-hotkey",x.SIYUAN_INIT="siyuan-init",x.SIYUAN_SEND_WINDOWS="siyuan-send-windows",x.SIYUAN_SAVE_CLOSE="siyuan-save-close",x.SIYUAN_AUTO_LAUNCH="siyuan-auto-launch",x.SIYUAN_OPEN_WORKSPACE="siyuan-open-workspace",x.SIYUAN_OPEN_URL="siyuan-open-url",x.SIYUAN_OPEN_WINDOW="siyuan-open-window",x.SIYUAN_OPEN_FOLDER="siyuan-open-folder",x.SIYUAN_OPEN_FILE="siyuan-open-file",x.SIYUAN_EXPORT_PDF="siyuan-export-pdf",x.SIYUAN_EXPORT_NEWWINDOW="siyuan-export-newwindow",x.SIYUAN_CONTEXT_MENU="siyuan-context-menu",x.CUSTOM_SY_READONLY="custom-sy-readonly",x.CUSTOM_SY_FULLWIDTH="custom-sy-fullwidth",x.CUSTOM_SY_AV_VIEW="custom-sy-av-view",x.CUSTOM_REMINDER_WECHAT="custom-reminder-wechat",x.CUSTOM_RIFF_DECKS="custom-riff-decks",x.SIZE_DATABASE_MAZ_SIZE=102400,x.SIZE_SCROLL_TB=24,x.SIZE_SCROLL_STEP=256,x.SIZE_LINK_TEXT_MAX=64,x.SIZE_TOOLBAR_HEIGHT=re()?0:32,x.SIZE_GET_MAX=102400,x.SIZE_UNDO=64,x.SIZE_TITLE=512,x.SIZE_EDITOR_WIDTH=760,x.SIZE_ZOOM=[.25,.33,.5,.67,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,2.5,3],x.CB_MOVE_NOLIST="cb-move-nolist",x.CB_MOUNT_REMOVE="cb-mount-remove",x.CB_GET_APPEND="cb-get-append",x.CB_GET_BEFORE="cb-get-before",x.CB_GET_UNCHANGEID="cb-get-unchangeid",x.CB_GET_HL="cb-get-hl",x.CB_GET_FOCUS="cb-get-focus",x.CB_GET_FOCUSFIRST="cb-get-focusfirst",x.CB_GET_SETID="cb-get-setid",x.CB_GET_ALL="cb-get-all",x.CB_GET_BACKLINK="cb-get-backlink",x.CB_GET_UNUNDO="cb-get-unundo",x.CB_GET_SCROLL="cb-get-scroll",x.CB_GET_CONTEXT="cb-get-context",x.CB_GET_ROOTSCROLL="cb-get-rootscroll",x.CB_GET_HTML="cb-get-html",x.CB_GET_HISTORY="cb-get-history",x.CB_GET_OPENNEW="cb-get-opennew",x.LOCAL_ZOOM="local-zoom",x.LOCAL_SEARCHDATA="local-searchdata",x.LOCAL_SEARCHKEYS="local-searchkeys",x.LOCAL_SEARCHASSET="local-searchasset",x.LOCAL_SEARCHUNREF="local-searchunref",x.LOCAL_DOCINFO="local-docinfo",x.LOCAL_DAILYNOTEID="local-dailynoteid",x.LOCAL_HISTORY="local-history",x.LOCAL_CODELANG="local-codelang",x.LOCAL_FONTSTYLES="local-fontstyles",x.LOCAL_EXPORTPDF="local-exportpdf",x.LOCAL_EXPORTWORD="local-exportword",x.LOCAL_EXPORTIMG="local-exportimg",x.LOCAL_BAZAAR="local-bazaar",x.LOCAL_PDFTHEME="local-pdftheme",x.LOCAL_LAYOUTS="local-layouts",x.LOCAL_AI="local-ai",x.LOCAL_PLUGINTOPUNPIN="local-plugintopunpin",x.LOCAL_FLASHCARD="local-flashcard",x.LOCAL_FILEPOSITION="local-fileposition",x.LOCAL_FILESPATHS="local-filespaths",x.LOCAL_DIALOGPOSITION="local-dialogposition",x.LOCAL_SESSION_FIRSTLOAD="local-session-firstload",x.LOCAL_OUTLINE="local-outline",x.LOCAL_PLUGIN_DOCKS="local-plugin-docks",x.DIALOG_OPENCARD="dialog-opencard",x.DIALOG_MAKECARD="dialog-makecard",x.DIALOG_VIEWCARDS="dialog-viewcards",x.DIALOG_DIALYNOTE="dialog-dialynote",x.DIALOG_RECENTDOCS="dialog-recentdocs",x.DIALOG_SWITCHTAB="dialog-switchtab",x.DIALOG_SEARCH="dialog-search",x.DIALOG_REPLACE="dialog-replace",x.DIALOG_GLOBALSEARCH="dialog-globalsearch",x.DIALOG_HISTORYCOMPARE="dialog-historycompare",x.DIALOG_ACCESSAUTHCODE="dialog-accessauthcode",x.DIALOG_AICUSTOMACTION="dialog-aicustomaction",x.DIALOG_AIUPDATECUSTOMACTION="dialog-aiupdatecustomaction",x.DIALOG_BACKGROUNDLINK="dialog-backgroundlink",x.DIALOG_BACKGROUNDRANDOM="dialog-backgroundrandom",x.DIALOG_CHANGELOG="dialog-changelog",x.DIALOG_COMMANDPANEL="dialog-commandpanel",x.DIALOG_DEACTIVATEUSER="dialog-deactivateuser",x.DIALOG_EMOJIS="dialog-emojis",x.DIALOG_EXPORTIMAGE="dialog-exportimage",x.DIALOG_EXPORTTEMPLATE="dialog-exporttemplate",x.DIALOG_EXPORTWORD="dialog-exportword",x.DIALOG_HISTORY="dialog-history",x.DIALOG_HISTORYDOC="dialog-historydoc",x.DIALOG_MOVEPATHTO="dialog-movepathto",x.DIALOG_RENAME="dialog-rename",x.DIALOG_RENAMEASSETS="dialog-renameassets",x.DIALOG_RENAMEBOOKMARK="dialog-renamebookmark",x.DIALOG_RENAMETAG="dialog-renametag",x.DIALOG_REPLACETYPE="dialog-replacetype",x.DIALOG_SAVECRITERION="dialog-savecriterion",x.DIALOG_SEARCHTYPE="dialog-searchtype",x.DIALOG_SEARCHASSETSTYPE="dialog-searchassetstype",x.DIALOG_SETTING="dialog-setting",x.DIALOG_SNAPSHOTTAG="dialog-snapshottag",x.DIALOG_SNAPSHOTMEMO="dialog-snapshotmemo",x.DIALOG_SNIPPETS="dialog-snippets",x.DIALOG_SYNCADDCLOUDDIR="dialog-syncaddclouddir",x.DIALOG_SYNCCHOOSEDIR="dialog-syncchoosedir",x.DIALOG_SYNCCHOOSEDIRECTION="dialog-syncchoosedirection",x.DIALOG_TRANSFERBLOCKREF="dialog-transferblockref",x.DIALOG_WECHATREMINDER="dialog-wechatreminder",x.DIALOG_PASSWORD="dialog-password",x.DIALOG_SETPASSWORD="dialog-setpassword",x.DIALOG_BOOTSYNCFAILED="dialog-bootsyncfailed",x.DIALOG_KERNELFAULT="dialog-kernelfault",x.DIALOG_STATEEXCEPTED="dialog-stateexcepted",x.DIALOG_ATTR="dialog-attr",x.DIALOG_SETCUSTOMATTR="dialog-setcustomattr",x.DIALOG_CREATENOTEBOOK="dialog-createnotebook",x.DIALOG_NOTEBOOKCONF="dialog-notebookconf",x.DIALOG_CREATEWORKSPACE="dialog-createworkspace",x.DIALOG_OPENWORKSPACE="dialog-openworkspace",x.DIALOG_SAVEWORKSPACE="dialog-saveworkspace",x.TIMEOUT_DBLCLICK=190,x.TIMEOUT_INPUT=256,x.TIMEOUT_LOAD=300,x.TIMEOUT_TRANSITION=300,x.TIMEOUT_COUNT=1e3,x.HELP_PATH={zh_CN:"20210808180117-czj9bvb",zh_CHT:"20211226090932-5lcq56f",en_US:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr",es_ES:"20210808180117-6v0mkxr",ja_JP:"20240530133126-axarxgx",it_IT:"20210808180117-6v0mkxr",de_DE:"20210808180117-6v0mkxr",he_IL:"20210808180117-6v0mkxr",ru_RU:"20210808180117-6v0mkxr",pl_PL:"20210808180117-6v0mkxr"},x.QUICK_DECK_ID="20230218211946-2kw8jgx",x.KEYCODELIST=Object.assign(at(),{8:"\u232B",9:"\u21E5",13:"\u21A9",16:"\u21E7",17:"\u2303",18:"\u2325",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"\u2190",38:"\u2191",39:"\u2192",40:"\u2193",44:"PrintScreen",45:"Insert",46:"\u2326",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"\u2318",92:"\u2318",93:"ContextMenu",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",182:"MyComputer",183:"MyCalculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}),x.SIYUAN_KEYMAP={general:{mainMenu:{default:"\u2325\\",custom:"\u2325\\"},commandPanel:{default:"\u2325\u21E7P",custom:"\u2325\u21E7P"},editReadonly:{default:"\u21E7\u2318G",custom:"\u21E7\u2318G"},syncNow:{default:"F9",custom:"F9"},enterBack:{default:"\u2325\u2190",custom:"\u2325\u2190"},enter:{default:"\u2325\u2192",custom:"\u2325\u2192"},goForward:{default:"\u2318]",custom:"\u2318]"},goBack:{default:"\u2318[",custom:"\u2318["},newFile:{default:"\u2318N",custom:"\u2318N"},search:{default:"\u2318F",custom:"\u2318F"},globalSearch:{default:"\u2318P",custom:"\u2318P"},stickSearch:{default:"\u21E7\u2318F",custom:"\u21E7\u2318F"},replace:{default:"\u2318R",custom:"\u2318R"},closeTab:{default:"\u2318W",custom:"\u2318W"},fileTree:{default:ce+"1",custom:ce+"1"},outline:{default:ce+"2",custom:ce+"2"},bookmark:{default:ce+"3",custom:ce+"3"},tag:{default:ce+"4",custom:ce+"4"},dailyNote:{default:ce+"5",custom:ce+"5"},inbox:{default:ce+"6",custom:ce+"6"},backlinks:{default:ce+"7",custom:ce+"7"},graphView:{default:ce+"8",custom:ce+"8"},globalGraph:{default:ce+"9",custom:ce+"9"},riffCard:{default:ce+"0",custom:ce+"0"},config:{default:"\u2325P",custom:"\u2325P"},dataHistory:{default:"\u2325H",custom:"\u2325H"},toggleWin:{default:"\u2325M",custom:"\u2325M"},lockScreen:{default:"\u2325N",custom:"\u2325N"},recentDocs:{default:"\u2318E",custom:"\u2318E"},goToTab1:{default:"\u23181",custom:"\u23181"},goToTab2:{default:"\u23182",custom:"\u23182"},goToTab3:{default:"\u23183",custom:"\u23183"},goToTab4:{default:"\u23184",custom:"\u23184"},goToTab5:{default:"\u23185",custom:"\u23185"},goToTab6:{default:"\u23186",custom:"\u23186"},goToTab7:{default:"\u23187",custom:"\u23187"},goToTab8:{default:"\u23188",custom:"\u23188"},goToTab9:{default:"\u23189",custom:"\u23189"},goToTabNext:{default:"\u21E7\u2318]",custom:"\u21E7\u2318]"},goToTabPrev:{default:"\u21E7\u2318[",custom:"\u21E7\u2318["},goToEditTabNext:{default:"\u2303\u21E5",custom:"\u2303\u21E5"},goToEditTabPrev:{default:"\u2303\u21E7\u21E5",custom:"\u2303\u21E7\u21E5"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""},toggleDock:{default:"",custom:""},splitLR:{default:"",custom:""},splitMoveR:{default:"",custom:""},splitTB:{default:"",custom:""},splitMoveB:{default:"",custom:""},closeOthers:{default:"",custom:""},closeAll:{default:"",custom:""},closeUnmodified:{default:"",custom:""},closeLeft:{default:"",custom:""},closeRight:{default:"",custom:""},tabToWindow:{default:"",custom:""},addToDatabase:{default:"",custom:""},unsplit:{default:"",custom:""},unsplitAll:{default:"",custom:""}},editor:{general:{duplicate:{default:"\u2318D",custom:"\u2318D"},expandDown:{default:"\u2325\u21E7\u2193",custom:"\u2325\u21E7\u2193"},expandUp:{default:"\u2325\u21E7\u2191",custom:"\u2325\u21E7\u2191"},expand:{default:"\u2318\u2193",custom:"\u2318\u2193"},collapse:{default:"\u2318\u2191",custom:"\u2318\u2191"},insertBottom:{default:"\u2325\u2318.",custom:"\u2325\u2318."},refTab:{default:"\u21E7\u2318.",custom:"\u21E7\u2318."},openBy:{default:"\u2325,",custom:"\u2325,"},insertRight:{default:"\u2325.",custom:"\u2325."},attr:{default:"\u2325\u2318A",custom:"\u2325\u2318A"},quickMakeCard:{default:"\u2325\u2318F",custom:"\u2325\u2318F"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"\u21E7\u2318C",custom:"\u21E7\u2318C"},copyProtocol:{default:"\u21E7\u2318H",custom:"\u21E7\u2318H"},copyBlockEmbed:{default:"\u21E7\u2318E",custom:"\u21E7\u2318E"},copyHPath:{default:"\u21E7\u2318P",custom:"\u21E7\u2318P"},undo:{default:"\u2318Z",custom:"\u2318Z"},redo:{default:"\u2318Y",custom:"\u2318Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},newNameSettingFile:{default:"\u2318F3",custom:"\u2318F3"},showInFolder:{default:"\u2325A",custom:"\u2325A"},outline:{default:"\u2325O",custom:"\u2325O"},backlinks:{default:"\u2325B",custom:"\u2325B"},graphView:{default:"\u2325G",custom:"\u2325G"},spaceRepetition:{default:"\u2325F",custom:"\u2325F"},fullscreen:{default:"\u2325Y",custom:"\u2325Y"},alignLeft:{default:"\u2325L",custom:"\u2325L"},alignCenter:{default:"\u2325C",custom:"\u2325C"},alignRight:{default:"\u2325R",custom:"\u2325R"},wysiwyg:{default:"\u2325\u23187",custom:"\u2325\u23187"},preview:{default:"\u2325\u23189",custom:"\u2325\u23189"},insertBefore:{default:"\u21E7\u2318B",custom:"\u21E7\u2318B"},insertAfter:{default:"\u21E7\u2318A",custom:"\u21E7\u2318A"},jumpToParentNext:{default:"\u21E7\u2318N",custom:"\u21E7\u2318N"},jumpToParentPrev:{default:"\u21E7\u2318M",custom:"\u21E7\u2318M"},jumpToParent:{default:"\u21E7\u2318J",custom:"\u21E7\u2318J"},moveToUp:{default:"\u21E7\u2318\u2191",custom:"\u21E7\u2318\u2191"},moveToDown:{default:"\u21E7\u2318\u2193",custom:"\u21E7\u2318\u2193"},duplicateCompletely:{default:"",custom:""},copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},copyProtocolInMd:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},netAssets2LocalAssets:{default:"",custom:""},optimizeTypography:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},copyText:{default:"",custom:""},exitFocus:{default:"",custom:""},ai:{default:"",custom:""},switchReadonly:{default:"",custom:""}},insert:{appearance:{default:"\u2325\u2318X",custom:"\u2325\u2318X"},lastUsed:{default:"\u2325X",custom:"\u2325X"},ref:{default:"\u2325[",custom:"\u2325["},kbd:{default:"\u2318'",custom:"\u2318'"},sup:{default:"\u2318H",custom:"\u2318H"},sub:{default:"\u2318J",custom:"\u2318J"},bold:{default:"\u2318B",custom:"\u2318B"},"inline-math":{default:"\u2318M",custom:"\u2318M"},memo:{default:"\u2325\u2318M",custom:"\u2325\u2318M"},underline:{default:"\u2318U",custom:"\u2318U"},italic:{default:"\u2318I",custom:"\u2318I"},mark:{default:"\u2325D",custom:"\u2325D"},tag:{default:"\u2318T",custom:"\u2318T"},strike:{default:"\u21E7\u2318S",custom:"\u21E7\u2318S"},"inline-code":{default:"\u2318G",custom:"\u2318G"},link:{default:"\u2318K",custom:"\u2318K"},check:{default:"\u2318L",custom:"\u2318L"},"ordered-list":{default:"",custom:""},list:{default:"",custom:""},table:{default:"\u2318O",custom:"\u2318O"},code:{default:"\u21E7\u2318K",custom:"\u21E7\u2318K"},quote:{default:"",custom:""},clearInline:{default:"\u2318\\",custom:"\u2318\\"}},heading:{paragraph:{default:"\u2325\u23180",custom:"\u2325\u23180"},heading1:{default:"\u2325\u23181",custom:"\u2325\u23181"},heading2:{default:"\u2325\u23182",custom:"\u2325\u23182"},heading3:{default:"\u2325\u23183",custom:"\u2325\u23183"},heading4:{default:"\u2325\u23184",custom:"\u2325\u23184"},heading5:{default:"\u2325\u23185",custom:"\u2325\u23185"},heading6:{default:"\u2325\u23186",custom:"\u2325\u23186"}},list:{indent:{default:"\u21E5",custom:"\u21E5"},outdent:{default:"\u21E7\u21E5",custom:"\u21E7\u21E5"},checkToggle:{default:"\u2318\u21A9",custom:"\u2318\u21A9"}},table:{insertRowAbove:{default:"\u21E7\u2318T",custom:"\u21E7\u2318T"},insertRowBelow:{default:"\u21E7\u2318D",custom:"\u21E7\u2318D"},insertColumnLeft:{default:"\u21E7\u2318L",custom:"\u21E7\u2318L"},insertColumnRight:{default:"\u21E7\u2318R",custom:"\u21E7\u2318R"},moveToUp:{default:"\u2325\u2318T",custom:"\u2325\u2318T"},moveToDown:{default:"\u2325\u2318B",custom:"\u2325\u2318B"},moveToLeft:{default:"\u2325\u2318L",custom:"\u2325\u2318L"},moveToRight:{default:"\u2325\u2318R",custom:"\u2325\u2318R"},"delete-row":{default:"\u2318-",custom:"\u2318-"},"delete-column":{default:"\u21E7\u2318-",custom:"\u21E7\u2318-"}}},plugin:{}},x.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},bottom:{pin:!0,data:[]},left:{pin:!0,data:[[{type:"file",size:{width:232,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:232,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:320,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:232,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:232,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]]},right:{pin:!0,data:[[{type:"graph",size:{width:320,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:320,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"}],[{type:"backlink",size:{width:320,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]}},x.SIYUAN_DEFAULT_REPLACETYPES={text:!0,imgText:!0,imgTitle:!0,imgSrc:!1,aText:!0,aTitle:!0,aHref:!1,code:!1,em:!0,strong:!0,inlineMath:!1,inlineMemo:!0,blockRef:!1,kbd:!0,mark:!0,s:!0,sub:!0,sup:!0,tag:!0,u:!0,docTitle:!0,codeBlock:!1,mathBlock:!1,htmlBlock:!1},x.SIYUAN_IMAGE_VIP=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>
<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>
<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>
<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>
<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>
</svg>`,x.SIYUAN_IMAGE_FILE="1f4c4",x.SIYUAN_IMAGE_NOTE="1f5c3",x.SIYUAN_IMAGE_FOLDER="1f4d1",x.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg",".avif"],x.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a",".aac"],x.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],x.SIYUAN_ASSETS_EXTS=[".pdf"].concat(Ne.SIYUAN_ASSETS_IMAGE).concat(Ne.SIYUAN_ASSETS_AUDIO).concat(Ne.SIYUAN_ASSETS_VIDEO),x.SIYUAN_ASSETS_SEARCH=[".txt",".md",".markdown",".docx",".xlsx",".pptx",".pdf",".json",".log",".sql",".html",".xml",".java",".h",".c",".cpp",".go",".rs",".swift",".kt",".py",".php",".js",".css",".ts",".sh",".bat",".cmd",".ini",".yaml",".rst",".adoc",".textile",".opml",".org",".wiki",".epub"],x.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","panda-syntax-dark","paraiso-dark","pojoaque","qtcreator-dark","rainbow","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],x.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","panda-syntax-light","paraiso-light","purebasic","qtcreator-light","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],x.ZWSP="\u200B",x.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo","clear"],x.BLOCK_HINT_KEYS=["((","[[","\uFF08\uFF08","\u3010\u3010"],x.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","\uFF08\uFF08":"\uFF09\uFF09","\u3010\u3010":"\u3011\u3011"},x.ALIAS_CODE_LANGUAGES=["js","ts","html","toml","c#","bat"],x.SIYUAN_RENDER_CODE_LANGUAGES=["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"],x.ANALYTICS_EVT_ON_GET_CONFIG="siyuan.onGetConfig";const Be=e=>{let t=!0;if(e)if(typeof e.getAttribute("contenteditable")=="string")t=e.getAttribute("contenteditable")==="true";else return'<div class="protyle-icons"></div>';return`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit${t?"":" fn__none"}"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last${t?"":" protyle-icon--first"}"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`},pe=e=>{if(e.getAttribute("data-type")==="NodeHTMLBlock"){const t=e.querySelector("protyle-html");t.setAttribute("data-content",Lute.UnEscapeHTMLStr(t.getAttribute("data-content")))}return e},oe=(e,t)=>{if(!e)return!1;e.nodeType===3&&(e=e.parentElement);let n=e,a=!1;for(;n&&!a&&!n.classList.contains("b3-typography");)n.nodeName.indexOf(t)===0?a=!0:n=n.parentElement;return a&&n},st=(e,t,n=!1)=>{let a=B(e,t,n),i=!1,s=!1;for(;a&&(n?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"))&&!s;)i=B(a.parentElement,t,n),i?a=i:s=!0;return a||!1},wn=(e,t)=>{let n=oe(e,t),a=!1,i=!1;for(;n&&!n.classList.contains("protyle-wysiwyg")&&!i;)a=oe(n.parentElement,t),a?n=a:i=!0;return n||!1},ee=(e,t,n,a=!1)=>{let i=O(e,t,n,a),s=!1,o=!1;for(;i&&!i.classList.contains("protyle-wysiwyg")&&!o;)s=O(i.parentElement,t,n,a),s?i=s:o=!0;return i||!1},O=(e,t,n,a=!1)=>{var i;if(!e)return!1;e.nodeType===3&&(e=e.parentElement);let s=e,o=!1;for(;s&&!o&&(a?s.tagName!=="BODY":!s.classList.contains("protyle-wysiwyg"));)typeof n=="string"&&((i=s.getAttribute(t))!=null&&i.split(" ").includes(n))||typeof n!="string"&&s.hasAttribute(t)?o=!0:s=s.parentElement;return o&&s},R=e=>{var t;const n=O(e,"data-node-id",null);return n&&n.tagName!=="BUTTON"&&((t=n.getAttribute("data-type"))!=null&&t.startsWith("Node"))?n:!1},Z=(e,t)=>{if(!e)return!1;e.nodeType===3&&(e=e.parentElement);let n=e,a=!1;for(;n&&!a&&!n.classList.contains("protyle-wysiwyg");)n.nodeName===t?a=!0:n=n.parentElement;return a&&n},B=(e,t,n=!1)=>{var a;if(!e)return!1;e.nodeType===3&&(e=e.parentElement);let i=e,s=!1;for(;i&&!s&&(n?i.tagName!=="BODY":!i.classList.contains("protyle-wysiwyg"));)(a=i.classList)!=null&&a.contains(t)?s=!0:i=i.parentElement;return s&&i},V=e=>{const t=ee(e,"data-type","NodeBlockQueryEmbed");return t?t.isSameNode(e)?!1:t:!1},J=(e,t=x.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="graphviz"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="graphviz"]')),n.length!==0&&ae(`${t}/js/graphviz/viz.js?v=0.0.0`,"protyleGraphVizScript").then(()=>{const a=B(e,"protyle-wysiwyg",!0);n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",Be(a));const s=i.firstElementChild.nextElementSibling;try{const o=new Blob([`importScripts('${document.getElementById("protyleGraphVizScript").src.replace("viz.js","full.render.js")}');`],{type:"application/javascript"}),r=(window.URL||window.webkitURL).createObjectURL(o),d=new Worker(r);new Viz({worker:d}).renderSVGElement(Lute.UnEscapeHTMLStr(i.getAttribute("data-content"))).then(c=>{s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${x.ZWSP}</span><div contenteditable="false">${c.outerHTML}</div>`}).catch(c=>{s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${x.ZWSP}</span><div class="ft__error" contenteditable="false">graphviz render error: <br>${c}</div>`})}catch(o){console.error("Graphviz error",o)}i.setAttribute("data-render","true")})})},le=e=>{let t=e;for(;t;){if(t.previousElementSibling&&t.previousElementSibling.getAttribute("data-node-id"))return t.previousElementSibling;const n=R(t.parentElement);if(n)t=n;else return!1}},me=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).reverse().find(n=>{if(!isInEmbedBlock(n))return t=n,!0}),t||e},ge=e=>{let t;return Array.from(e.querySelectorAll("[data-node-id]")).find(n=>{if(!isInEmbedBlock(n)&&!n.classList.contains("li")&&!n.classList.contains("sb"))return t=n,!0}),t||e},he=e=>{let t=e;for(;t;){if(t.nextElementSibling&&!t.nextElementSibling.classList.contains("protyle-attr"))return t.nextElementSibling;const n=R(t.parentElement);if(n)t=n;else return!1}return!1},Ke=e=>{let t=e;for(;t;)if(t.classList.contains("list")||t.classList.contains("li")||t.classList.contains("bq")||t.classList.contains("sb"))t=t.querySelector("[data-node-id]");else return t;return!1},Ce=e=>!e||e.getAttribute("contenteditable")==="true"&&!e.classList.contains("protyle-wysiwyg")?e:e.querySelector('[contenteditable="true"]'),it=e=>["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(e.getAttribute("data-type"))||e.getAttribute("data-type")==="NodeCodeBlock"&&e.classList.contains("render-node"),ht=e=>{var t,n;let a=e;for(;a.parentElement&&!a.parentElement.classList.contains("protyle-wysiwyg");)if(!a.parentElement.getAttribute("data-node-id"))a=a.parentElement;else{let i=!1;if(Array.from(a.parentElement.querySelectorAll('[contenteditable="true"]')).find(s=>{if(s.textContent.replace(Constants.ZWSP,"").replace(`
`,"")!=="")return i=!0,!0}),i||(t=a.previousElementSibling)!=null&&t.getAttribute("data-node-id")||(n=a.nextElementSibling)!=null&&n.getAttribute("data-node-id"))break;a=a.parentElement}return a},Pe=e=>{if(e.parentElement.getAttribute("data-type")==="NodeBlockquote"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeBlockquote"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=Pe(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=Pe(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)e=e.parentElement;else if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)e=e.parentElement;else{e=Pe(e);break}else if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)for(;!e.parentElement.classList.contains("protyle-wysiwyg");)if(e.parentElement.getAttribute("data-type")==="NodeList"&&e.parentElement.childElementCount===2)e=e.parentElement;else if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&e.parentElement.childElementCount===3)e=e.parentElement;else{e=Pe(e);break}return e},ve=e=>{let t=e.nextSibling;for(;t;)if(t.textContent===""&&t.nodeType===3)t=t.nextSibling;else return t;return!1},Te=e=>{let t=e.previousSibling;for(;t;)if(t.textContent===""&&t.nodeType===3)t=t.previousSibling;else return t;return!1},Vt=e=>{let t=e.nextElementSibling;if(t)return t.tagName==="LI"?t:t.tagName==="UL"?t.firstElementChild:!1;for(t=e.parentElement;t.tagName==="UL";)if(!t.nextElementSibling)t=t.parentElement;else{if(t.nextElementSibling.tagName==="LI")return t.nextElementSibling;if(t.nextElementSibling.tagName==="UL")return t.nextElementSibling.firstElementChild}return!1},Tt=e=>{let t=e.previousElementSibling;if(t)return t.tagName==="LI"?t:t.tagName==="UL"?t.lastElementChild:!1;for(t=e.parentElement;t.tagName==="UL";)if(!t.previousElementSibling)t=t.parentElement;else{if(t.previousElementSibling.tagName==="LI")return t.previousElementSibling;if(t.previousElementSibling.tagName==="UL"){const n=t.previousElementSibling.querySelectorAll(".b3-list-item");return n[n.length-1]}}return!1},Qs=(e,t)=>{if(!t){if(getSelection().rangeCount===0)return!1;t=getSelection().getRangeAt(0)}const n=t.commonAncestorContainer;return e.isEqualNode(n)||e.contains(n)},ei=e=>{const t=O(e.startContainer,"data-type","NodeTable");if(e.toString()!==""&&t&&e.commonAncestorContainer.nodeType!==3){const n=e.commonAncestorContainer.tagName;if(n!=="TH"&&n!=="TD"){const a=Z(e.startContainer,"TD")||Z(e.startContainer,"TH"),i=Z(e.endContainer,"TD")||Z(e.endContainer,"TH");if(!a&&!i){const s=t.querySelector("th")||t.querySelector("td");e.setStart(s.firstChild,0),e.setEnd(s.lastChild,s.lastChild.textContent.length)}else a&&!a.contains(e.endContainer)&&zt(a,e,!1)}}},Ll=(e,t,n)=>{const a=getContenteditableElement(t);if(a){let o;if(a.tagName==="TABLE"){const l=hasClosestByMatchTag(n.startContainer,"TD")||hasClosestByMatchTag(n.startContainer,"TH");if(l&&(o=pa(l,t,n),o.start!==0||o.end!==l.textContent.length))return n.setStart(l.firstChild,0),n.setEndAfter(l.lastChild),e.toolbar.render(e,n),countSelectWord(n,e.block.rootID),!0}else if(o=pa(a,t,n),o.start!==0||o.end!==a.textContent.length){let l=a.firstChild;for(;l;)if(l.nodeType===3){if(l.textContent!==""){n.setStart(l,0);break}l=l.nextSibling}else{if(l.classList.contains("render-node")||l.classList.contains("img")){n.setStartBefore(l);break}l=l.firstChild}let r=a.lastChild;for(;r;)if(r.nodeType===3){if(r.textContent!==""){n.setEnd(r,r.textContent.length);break}r=r.previousSibling}else{if(r.classList.contains("render-node")||r.classList.contains("img")||r.tagName==="BR"){n.setEndAfter(r);break}r=r.lastChild}return Re(n),e.toolbar.render(e,n),countSelectWord(n,e.block.rootID),!0}}n.collapse(!0);const i=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.wysiwyg.element.childElementCount===i.length&&i[0].parentElement.isSameNode(e.wysiwyg.element))return!0;hideElements(["select"],e);const s=[];Array.from(e.wysiwyg.element.children).forEach(o=>{o.classList.add("protyle-wysiwyg--select"),s.push(o.getAttribute("data-node-id"))}),countBlockWord(s,e.block.rootID)},Sl=(e,t)=>{const n=document.caretRangeFromPoint(e,t),a=hasClosestByAttribute(n.startContainer,"data-type","img");return a&&(n.setStart(a.nextSibling,0),n.collapse()),n},ot=e=>{let t;if(getSelection().rangeCount>0&&(t=getSelection().getRangeAt(0),e.isSameNode(t.startContainer)||e.contains(t.startContainer)))return t;e.focus({preventScroll:!0});let n;return e.classList.contains("table")?n=e.querySelector("th")||e.querySelector("td"):(n=Ce(e),n?n.tagName==="TABLE"&&(n=n.querySelector("th")||e.querySelector("td")):n=e),t=n.ownerDocument.createRange(),t.setStart(n||e,0),t.collapse(!0),t},xl=(e,t)=>{var n,a;if(t||(t=ot(e)),!e.contains(t.startContainer))return{left:0,top:0};let i;if(t.getClientRects().length===0)if(t.startContainer.nodeType===3){const s=(n=t.startContainer.parentElement)==null?void 0:n.getClientRects(),o=(a=t.startContainer.previousElementSibling)==null?void 0:a.getClientRects();if(s.length>0||o.length>0)s.length===0||o&&o.length>0&&s[0].top<o[o.length-1].bottom?i={left:o[o.length-1].left,top:o[o.length-1].bottom}:i=s[0];else return{left:0,top:0}}else{const s=t.startContainer.children;if(s[t.startOffset]&&s[t.startOffset].getClientRects().length>0)i=s[t.startOffset].getClientRects()[0];else if(t.startContainer.childNodes.length>0){const o=t.cloneRange();t.selectNode(t.startContainer.childNodes[Math.max(0,t.startOffset-1)]),i=t.getClientRects()[0],t.setEnd(o.endContainer,o.endOffset),t.setStart(o.startContainer,o.startOffset)}else i=t.startContainer.getClientRects()[0];if(!i){let o=t.startContainer.childNodes[t.startOffset];if(o||(o=t.startContainer.childNodes[t.startOffset-1]),!o)i=t.getBoundingClientRect();else{for(;!o.getClientRects||o.getClientRects&&o.getClientRects().length===0;)o=o.parentElement;i=o.getClientRects()[0]}}}else{const s=t.getClientRects();return{left:s[s.length-1].left,top:s[0].top}}return{left:i.left,top:i.top}},pa=(e,t,n)=>{const a={end:0,start:0};if(!n){if(getSelection().rangeCount===0)return a;n=window.getSelection().getRangeAt(0)}if(t&&!Qs(t,n))return a;const i=n.cloneRange();return e.childNodes[0]&&e.childNodes[0].childNodes[0]?i.setStart(e.childNodes[0].childNodes[0],0):i.selectNodeContents(e),i.setEnd(n.startContainer,n.startOffset),a.start=i.toString().length+i.cloneContents().querySelectorAll("br").length,a.end=a.start+n.toString().length+n.cloneContents().querySelectorAll("br").length,a};function Gt(e,t,n,a){if(!t)return!1;if(n(t))return!0;for(let i=0,s=t.childNodes.length;i<s;i++)if(Gt(t,t.childNodes[i],n,!0))return!0;if(!a){let i=t;for(;i&&i!==e;){let s=i.nextSibling;for(;s;){if(Gt(e,s,n,!0))return!0;s=s.nextSibling}i=i.parentNode}}return!1}const zt=(e,t,n=!0)=>{if(!e)return t;let a=e.lastChild;for(;a&&a.nodeType!==3;){if(a.nodeType!==3&&a.tagName==="BR")return t;if(!a.lastChild)break;a=a.lastChild}return a||(a=e),n?a.nodeType!==3&&a.classList.contains("render-node")&&a.innerHTML===""?t.setStartAfter(a):t.setStart(a,a.textContent.length):a.nodeType!==3&&a.classList.contains("render-node")&&a.innerHTML===""?t.setStartAfter(a):t.setEnd(a,a.textContent.length),t},ti=(e,t)=>{if(!e)return t;let n=e.firstChild;for(;n&&n.nodeType!==3&&!n.classList.contains("render-node");){if(n.classList.contains("img"))return t.setStartBefore(n),t;n=n.firstChild}return n?(n.nodeType!==3&&n.classList.contains("render-node")?t.setStartBefore(n):t.setStart(n,0),t):(t.selectNodeContents(e),t)},ma=(e,t,n)=>{if(!e)return!1;const a=Ce(e);if(a)e=a;else if(it(e)||e.classList.contains("av"))return Je(e);let i;Gt(e,e.firstChild,l=>{if(l.nodeType===Node.TEXT_NODE){const r=l.data.length;return t<=r?(i=l,!0):(t-=r,n-=r,!1)}});let s;i&&Gt(e,i,l=>{if(l.nodeType===Node.TEXT_NODE){const r=l.data.length;return n<=r?(s=l,!0):(n-=r,!1)}});const o=document.createRange();return i?t<i.data.length?o.setStart(i,t):o.setStartAfter(i):t===0?o.setStart(e,0):zt(Ce(e),o),s?n<s.data.length?o.setEnd(s,n):o.setEndAfter(s):n===0?o.setEnd(e,0):zt(Ce(e),o,!1),Re(o),o},Kt=(e,t)=>{var n;const a=e.querySelectorAll("wbr");if(a.length===0)return;a.forEach((s,o)=>{o!==0&&s.remove()});const i=a[0];if(!i.previousElementSibling)i.previousSibling?t.setStart(i.previousSibling,i.previousSibling.textContent.length):i.nextSibling?i.nextSibling.nodeType===3?t.setStart(i.nextSibling,0):t.setStartAfter(i):t.setStart(i.parentElement,0);else{const s=Te(i);s&&i.previousElementSibling.isSameNode(s)?((n=i.previousElementSibling.lastChild)==null?void 0:n.nodeType)===3?t.setStart(i.previousElementSibling.lastChild,i.previousElementSibling.lastChild.textContent.length):s.nodeType!==3&&s.classList.contains("img")?t.setStartAfter(s):t.setStartBefore(i):t.setStart(i.previousSibling,i.previousSibling.textContent.length)}t.collapse(!0),i.remove(),Re(t)},Re=e=>{if(!e)return;const t=e.startContainer.childNodes[e.startOffset];if(t&&t.nodeType!==3&&["INPUT","TEXTAREA"].includes(t.tagName)){t.focus();return}const n=window.getSelection();n.removeAllRanges(),n.addRange(e)},Je=(e,t,n=!0)=>{var a,i,s;if(!e)return!1;if(e.classList.contains("render-node")||e.classList.contains("iframe")||e.classList.contains("hr")||e.classList.contains("av")){const l=document.createRange(),r=e.getAttribute("data-type");let d=!1;if(r==="NodeThematicBreak")l.selectNodeContents(e.firstElementChild),d=!0;else if(r==="NodeBlockQueryEmbed")(a=e.lastElementChild.previousElementSibling)!=null&&a.firstChild?(l.selectNodeContents(e.lastElementChild.previousElementSibling.firstChild),l.collapse(!0)):(l.selectNodeContents(e),l.collapse(!0)),d=!0;else if(["NodeMathBlock","NodeHTMLBlock"].includes(r))(s=(i=e.lastElementChild.previousElementSibling)==null?void 0:i.lastElementChild)!=null&&s.firstChild?(l.selectNodeContents(e.lastElementChild.previousElementSibling.lastElementChild.firstChild),l.collapse(!0)):e.lastElementChild.previousElementSibling&&(l.selectNodeContents(e.lastElementChild.previousElementSibling),l.collapse(!0)),d=!0;else if(r==="NodeIFrame"||r==="NodeWidget")l.setStart(e,0),d=!0;else if(r==="NodeVideo")l.setStart(e.firstElementChild,0),d=!0;else if(r==="NodeAudio")l.setStart(e.firstElementChild.lastChild,0),d=!0;else if(r==="NodeCodeBlock")l.selectNodeContents(e),l.collapse(!0),d=!0;else if(r==="NodeAttributeView")return!1;return d?(Re(l),l):(ni(e),!1)}let o;if(n?o=Ce(e):Array.from(e.querySelectorAll('[contenteditable="true"]')).reverse().find(l=>{if(l.getBoundingClientRect().width>0)return o=l,!0}),o){if(o.tagName==="TABLE")if(n)o=o.querySelector("th, td");else{const r=o.querySelectorAll("th, td");o=r[r.length-1]}let l;if(n)l=ti(o,ot(o)),l.collapse(!0);else{let r=!1;if(o.classList.contains("hljs")){let d=o.lastChild;if(d||(o.innerHTML=`
`,d=o.lastChild),d.textContent===""&&d.nodeType===3&&(d=Te(o.lastChild)),d&&d.textContent.endsWith(`
`)){if(d.nodeType===1)for(d=d.lastChild;d&&d.textContent.indexOf(`
`)===-1;)d=d.previousSibling;l=ot(o),l.setStart(d,d.textContent.length-1),r=!0}}r||(l=zt(o,ot(o))),l.collapse(!1)}return Re(l),l}else if(t)t.focus();else if(e.classList.contains("li"))return Je(e.querySelector("[data-node-id]"),t,n);return!1},ni=e=>{if(e.getAttribute("data-node-id")){let n,a;e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr")?(a=!0,n=he(e)):e.previousElementSibling&&(a=!1,n=le(e)),n||(n=e),Je(n,void 0,a);return}const t=ot(e);e.nextSibling?(t.selectNodeContents(e.nextSibling),t.collapse(!0)):e.previousSibling&&(t.selectNodeContents(e.previousSibling),t.collapse(!1)),Re(t)},_n=(e,t)=>{if(!document.getElementById(t)){const n=document.createElement("link");n.id=t,n.rel="stylesheet",n.type="text/css",n.href=e;const a=document.querySelector("#pluginsStyle");a?a.before(n):document.getElementsByTagName("head")[0].appendChild(n)}},ba=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(parseInt(e,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(e,10)/4).toString(16)),Tl=()=>{const e=document.getElementById("message");e.innerHTML=`<div class="fn__flex-1"></div>
<button class="b3-button ft__smaller">${window.siyuan.languages.clearMessage}</button>`,e.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(e);){if(a.classList.contains("b3-snackbar__close")){It(a.parentElement.getAttribute("data-id")),n.preventDefault();break}else if(a.isSameNode(e.lastElementChild)){a.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{a.parentElement.firstElementChild.innerHTML=""},Constants.TIMEOUT_INPUT),n.preventDefault();break}else{if(a.tagName==="A"||a.tagName==="BUTTON")break;if(a.classList.contains("b3-snackbar")){(getSelection().rangeCount===0||!getSelection().getRangeAt(0).toString())&&It(a.getAttribute("data-id")),n.preventDefault(),n.stopPropagation();break}}a=a.parentElement}});const t=document.getElementById("tempMessage");t&&(Qe(t.innerHTML),t.remove())},Qe=(e,t=6e3,n="info",a)=>{const i=document.getElementById("message").firstElementChild;if(!i){document.body.insertAdjacentHTML("beforeend",`<div style="top: 10px;
    position: fixed;
    z-index: 100;
    background: white;
    padding: 10px;
    border-radius: 5px;
    right: 10px;
    border: 1px solid #e0e0e0;" id='tempMessage'>${e}</div>`);return}const s=a||ba(),o=i.querySelector(`.b3-snackbar[data-id="${s}"]`),l=e+(n==="error"?" v"+x.SIYUAN_VERSION:"");if(o){if(window.clearTimeout(parseInt(o.getAttribute("data-timeoutid"))),o.innerHTML=`<div data-type="textMenu" class="b3-snackbar__content${t===0?" b3-snackbar__content--close":""}">${l}</div>${t===0?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,n==="error"?o.classList.add("b3-snackbar--error"):o.classList.remove("b3-snackbar--error"),t>0){const d=window.setTimeout(()=>{It(s)},t);o.setAttribute("data-timeoutid",d.toString())}return}let r=`<div data-id="${s}" class="b3-snackbar--hide b3-snackbar${n==="error"?" b3-snackbar--error":""}"><div data-type="textMenu" class="b3-snackbar__content${t===0?" b3-snackbar__content--close":""}">${l}</div>`;if(t===0)r+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(t!==-1){const d=window.setTimeout(()=>{It(s)},t);r=r.replace("<div data-id",`<div data-timeoutid="${d}" data-id`)}return i.parentElement.classList.add("b3-snackbars--show"),i.parentElement.style.zIndex=(++window.siyuan.zIndex).toString(),i.insertAdjacentHTML("afterbegin",r+"</div>"),setTimeout(()=>{i.querySelectorAll(".b3-snackbar--hide").forEach(d=>{d.classList.remove("b3-snackbar--hide")})}),i.firstElementChild.nextElementSibling&&i.firstElementChild.nextElementSibling.innerHTML===i.firstElementChild.innerHTML&&i.firstElementChild.nextElementSibling.remove(),i.scrollTo({top:0,behavior:"smooth"}),s},It=e=>{const t=document.getElementById("message").firstElementChild;if(t)if(e){const n=t.querySelector(`[data-id="${e}"]`);n&&(n.classList.add("b3-snackbar--hide"),window.clearTimeout(parseInt(n.getAttribute("data-timeoutid"))),setTimeout(()=>{n.remove(),t.childElementCount===0&&(t.parentElement.classList.remove("b3-snackbars--show"),t.innerHTML="")},x.TIMEOUT_INPUT));let a=!1;Array.from(t.children).find(i=>{if(!i.classList.contains("b3-snackbar--hide"))return a=!0,!0}),a?t.parentElement.classList.add("b3-snackbars--show"):t.parentElement.classList.remove("b3-snackbars--show")}else t.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{t.innerHTML=""},x.TIMEOUT_INPUT)};var ai=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const ha=e=>{if(e)if(Zt())if(e.startsWith("assets/"))window.webkit.messageHandlers.openLink.postMessage(encodeURI(location.origin+"/"+e));else try{new URL(e),window.webkit.messageHandlers.openLink.postMessage(encodeURI(e))}catch(t){window.webkit.messageHandlers.openLink.postMessage(encodeURI("https://"+e))}else Mt()?window.JSAndroid.openExternal(e):window.open(e)},si=()=>Mt()?window.JSAndroid.readClipboard():navigator.clipboard.readText(),Dt=e=>{let t;getSelection().rangeCount>0&&(t=getSelection().getRangeAt(0).cloneRange());try{if(Mt()){window.JSAndroid.writeClipboard(e);return}if(Zt()){window.webkit.messageHandlers.setClipboard.postMessage(e);return}navigator.clipboard.writeText(e)}catch(n){if(Zt())window.webkit.messageHandlers.setClipboard.postMessage(e);else if(Mt())window.JSAndroid.writeClipboard(e);else{const a=document.createElement("textarea");a.value=e,a.style.position="fixed",document.body.appendChild(a),a.focus(),a.select(),document.execCommand("copy"),document.body.removeChild(a),t&&Re(t)}}},Il=e=>ai(void 0,null,function*(){e=e.replace(new RegExp(Constants.ZWSP,"g"),""),yield Dt(e)}),ii=()=>li()?"touchstart":"click",Dl=e=>ya()?!!(e.metaKey&&!e.ctrlKey):!!(!e.metaKey&&e.ctrlKey),oi=e=>!e.metaKey&&!e.ctrlKey,Ml=()=>window.siyuan.config.system.osPlatform.toLowerCase().indexOf("huawei")>-1,li=()=>navigator.userAgent.indexOf("iPhone")>-1,$l=()=>navigator.userAgent.indexOf("iPad")>-1,ya=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1,Mt=()=>window.siyuan.config.system.container==="android"&&window.JSAndroid,Zt=()=>{var e;return window.siyuan.config.system.container==="ios"&&((e=window.webkit)==null?void 0:e.messageHandlers)},vn=e=>{if(ya())return e;const t=new Map(Object.entries({"\u2318":"Ctrl","\u2303":"Ctrl","\u21E7":"Shift","\u2325":"Alt","\u21E5":"Tab","\u232B":"Backspace","\u2326":"Delete","\u21A9":"Enter"})),n=[];(e.indexOf("\u2318")>-1||e.indexOf("\u2303")>-1)&&n.push(t.get("\u2318")),e.indexOf("\u21E7")>-1&&n.push(t.get("\u21E7")),e.indexOf("\u2325")>-1&&n.push(t.get("\u2325"));const a=e.replace(/⌘|⇧|⌥|⌃/g,"");return a&&n.push(t.get(a)||a),n.join("+")},Hl=e=>{fetchPost("/api/storage/getLocalStorage",void 0,t=>{window.siyuan.storage=t.data;const n={};n[Constants.LOCAL_SEARCHASSET]={keys:[],col:"",row:"",layout:0,method:0,types:{},sort:0,k:""},n[Constants.LOCAL_SEARCHUNREF]={col:"",row:"",layout:0},Constants.SIYUAN_ASSETS_SEARCH.forEach(a=>{n[Constants.LOCAL_SEARCHASSET].types[a]=!0}),n[Constants.LOCAL_SEARCHKEYS]={keys:[],replaceKeys:[],col:"",row:"",layout:0,colTab:"",rowTab:"",layoutTab:0},n[Constants.LOCAL_PDFTHEME]={light:"light",dark:"dark",annoColor:"var(--b3-pdf-background1)"},n[Constants.LOCAL_LAYOUTS]=[],n[Constants.LOCAL_AI]=[],n[Constants.LOCAL_PLUGIN_DOCKS]={},n[Constants.LOCAL_PLUGINTOPUNPIN]=[],n[Constants.LOCAL_OUTLINE]={keepExpand:!0},n[Constants.LOCAL_FILEPOSITION]={},n[Constants.LOCAL_DIALOGPOSITION]={},n[Constants.LOCAL_HISTORY]={notebookId:"%",type:0,operation:"all"},n[Constants.LOCAL_FLASHCARD]={fullscreen:!1},n[Constants.LOCAL_BAZAAR]={theme:"0",template:"0",icon:"0",widget:"0"},n[Constants.LOCAL_EXPORTWORD]={removeAssets:!1,mergeSubdocs:!1},n[Constants.LOCAL_EXPORTPDF]={landscape:!1,marginType:"0",scale:1,pageSize:"A4",removeAssets:!0,keepFold:!1,mergeSubdocs:!1,watermark:!1},n[Constants.LOCAL_EXPORTIMG]={keepFold:!1,watermark:!1},n[Constants.LOCAL_DOCINFO]={id:""},n[Constants.LOCAL_FONTSTYLES]=[],n[Constants.LOCAL_FILESPATHS]=[],n[Constants.LOCAL_SEARCHDATA]={page:1,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},n[Constants.LOCAL_ZOOM]=1,[Constants.LOCAL_EXPORTIMG,Constants.LOCAL_SEARCHKEYS,Constants.LOCAL_PDFTHEME,Constants.LOCAL_BAZAAR,Constants.LOCAL_EXPORTWORD,Constants.LOCAL_EXPORTPDF,Constants.LOCAL_DOCINFO,Constants.LOCAL_FONTSTYLES,Constants.LOCAL_SEARCHDATA,Constants.LOCAL_ZOOM,Constants.LOCAL_LAYOUTS,Constants.LOCAL_AI,Constants.LOCAL_PLUGINTOPUNPIN,Constants.LOCAL_SEARCHASSET,Constants.LOCAL_FLASHCARD,Constants.LOCAL_DIALOGPOSITION,Constants.LOCAL_SEARCHUNREF,Constants.LOCAL_HISTORY,Constants.LOCAL_OUTLINE,Constants.LOCAL_FILEPOSITION,Constants.LOCAL_FILESPATHS,Constants.LOCAL_PLUGIN_DOCKS].forEach(a=>{if(typeof t.data[a]=="string")try{const i=JSON.parse(t.data[a]);typeof i=="number"?window.siyuan.storage[a]=i:window.siyuan.storage[a]=Object.assign(n[a],i)}catch(i){window.siyuan.storage[a]=n[a]}else typeof t.data[a]=="undefined"&&(window.siyuan.storage[a]=n[a])}),(!window.siyuan.storage[Constants.LOCAL_SEARCHDATA].replaceTypes||Object.keys(window.siyuan.storage[Constants.LOCAL_SEARCHDATA].replaceTypes).length===0)&&(window.siyuan.storage[Constants.LOCAL_SEARCHDATA].replaceTypes=Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)),e()})},wa=(e,t,n)=>{window.siyuan.config.readonly||Se("/api/storage/setLocalStorageVal",{app:x.SIYUAN_APPID,key:e,val:t},()=>{n&&n()})},_a=e=>{var t;if(e.cmd==="msg")return Qe(e.msg,e.data.closeTimeout,e.code===0?"info":"error",e.data.id),!1;if(e.cmd==="cmsg")return It(e.data.id),!1;if(e.cmd==="cprogress"){const n=document.getElementById("progress");return n&&n.remove(),!1}return e.cmd==="reloadui"?((t=e.data)!=null&&t.resetScroll?(window.siyuan.storage[x.LOCAL_FILEPOSITION]={},wa(x.LOCAL_FILEPOSITION,window.siyuan.storage[x.LOCAL_FILEPOSITION],()=>{window.location.reload()})):window.location.reload(),!1):e.code<0?(Qe(e.msg,e.data&&e.data.closeTimeout||0,e.code===-1?"error":"info"),!1):e};class va{constructor(t){this.disableClose=t.disableClose,this.id=ba(),window.siyuan.dialogs.push(this),this.destroyCallback=t.destroyCallback,this.element=document.createElement("div");let n,a;if(!re()&&t.positionId){const i=window.siyuan.storage[x.LOCAL_DIALOGPOSITION][t.positionId];i&&i.left+i.width+34<=window.innerWidth&&i.top+i.height<=window.innerHeight&&(n=i.left+"px",a=i.top+"px",t.width=i.width+"px",t.height=i.height+"px")}this.element.innerHTML=`<div class="b3-dialog" style="z-index: ${++window.siyuan.zIndex};${typeof n=="string"?"display:block":""}">
<div class="b3-dialog__scrim"${t.transparent?'style="background-color:transparent"':""}></div>
<div class="b3-dialog__container" style="width:${t.width||"auto"};height:${t.height||"auto"};left:${n};top:${a}">
  <svg ${re()&&t.title?'style="top:0;right:0;"':""} class="b3-dialog__close${this.disableClose||t.hideCloseIcon?" fn__none":""}"><use xlink:href="#iconCloseRound"></use></svg>
  <div class="resize__move b3-dialog__header${t.title?"":" fn__none"}" onselectstart="return false;">${t.title||""}</div>
  <div class="b3-dialog__body">${t.content}</div>
  <div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>
</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",i=>{this.disableClose||this.destroy(),i.preventDefault(),i.stopPropagation()}),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",i=>{this.destroy(),i.preventDefault(),i.stopPropagation()}),document.body.append(this.element),t.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout(()=>{this.element.classList.add("b3-dialog--open")})}destroy(t){var n;this.element.querySelector(".b3-dialog").style.zIndex<window.siyuan.menus.menu.element.style.zIndex&&window.siyuan.menus.menu.remove(),this.element.remove(),this.destroyCallback&&this.destroyCallback(t),window.siyuan.dialogs.find((a,i)=>{if(a.id===this.id)return window.siyuan.dialogs.splice(i,1),!0}),(n=document.getElementById("drag"))==null||n.classList.remove("fn__hidden")}bindInput(t,n,a=!0){t.focus(),t.addEventListener("keydown",i=>{if(i.isComposing){i.preventDefault();return}if(i.key==="Escape"){this.destroy(),i.preventDefault(),i.stopPropagation();return}!i.shiftKey&&oi(i)&&i.key==="Enter"&&n&&a&&(n(),i.preventDefault(),i.stopPropagation())})}}const Nl=(e,t,n,a)=>{if(!t&&!e){n();return}const i=new Dialog({title:e,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${t}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text" id="confirmDialogConfirmBtn">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{a&&a(i),i.destroy()}),s[1].addEventListener("click",()=>{n&&n(i),i.destroy()})};var En=Ie(101);const Bl=(e,t,n,a=0,i=0)=>{e.style.top=n+"px",e.style.left=t+"px";const s=e.getBoundingClientRect();if(s.bottom>window.innerHeight||s.top<Constants.SIZE_TOOLBAR_HEIGHT){const o=n-s.height-a;o>Constants.SIZE_TOOLBAR_HEIGHT&&o+s.height<window.innerHeight?e.style.top=o+"px":o<=Constants.SIZE_TOOLBAR_HEIGHT?e.style.top=Constants.SIZE_TOOLBAR_HEIGHT+"px":e.style.top=Math.max(Constants.SIZE_TOOLBAR_HEIGHT,window.innerHeight-s.height)+"px"}s.right>window.innerWidth?e.style.left=`${window.innerWidth-s.width-i}px`:s.left<0&&(e.style.left="0")},ri=()=>{const e=window.siyuan.emojis[getRandom(0,window.siyuan.emojis.length-1)];return typeof e.items[getRandom(0,e.items.length-1)]=="undefined"?"1f600":e.items[getRandom(0,e.items.length-1)].unicode},Me=(e,t="",n=!1,a=!1)=>{if(!e)return"";let i="";if(e.indexOf(".")>-1)i=`<img class="${t}" ${a?"data-":""}src="/emojis/${e}"/>`;else try{e.split("-").forEach(s=>{s.length<5?i+=String.fromCodePoint(parseInt("0"+s,16)):i+=String.fromCodePoint(parseInt(s,16))}),n&&(i=`<span class="${t}">${i}</span>`)}catch(s){}return i},kn=e=>{const t=new IntersectionObserver(n=>{n.forEach(a=>{const i=a.target.getAttribute("data-index");if((typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&i){let s="";window.siyuan.emojis[parseInt(i)].items.forEach(o=>{s+=`<button data-unicode="${o.unicode}" class="emojis__item ariaLabel" aria-label="${wt(o)}">
${Me(o.unicode)}</button>`}),a.target.innerHTML=s,a.target.removeAttribute("data-index")}})});e.querySelectorAll(".emojis__content").forEach(n=>{t.observe(n)})},Cn=e=>{const t=new IntersectionObserver(n=>{n.forEach(a=>{const i=a.target.getAttribute("data-src");(typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&i&&(a.target.src=i,a.target.removeAttribute("data-src"))})});e.querySelectorAll("img").forEach(n=>{t.observe(n)})},An=(e="",t)=>{let n="";const a=[];e&&(n=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let i=0,s="";const o=[];window.siyuan.emojis.forEach((r,d)=>{e||(n+=`<div class="emojis__title" data-type="${d+1}">${We(d)}</div><div style="min-height:${d===0?"28px":"336px"}" class="emojis__content"${d>1?' data-index="'+d+'"':""}>`),r.items.length===0&&d===0&&!e&&(n+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),r.items.forEach(c=>{if(e){if(window.siyuan.config.editor.emoji.includes(c.unicode)&&(Me(c.unicode)===e||c.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||c.description.toLowerCase().indexOf(e.toLowerCase())>-1||c.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1||c.description_ja_jp.toLowerCase().indexOf(e.toLowerCase())>-1)&&a.push(c),t&&i>t)return;(Me(c.unicode)===e||c.keywords.toLowerCase().indexOf(e.toLowerCase())>-1||c.description.toLowerCase().indexOf(e.toLowerCase())>-1||c.description_zh_cn.toLowerCase().indexOf(e.toLowerCase())>-1||c.description_ja_jp.toLowerCase().indexOf(e.toLowerCase())>-1)&&(r.id==="custom"?o.push(c):s+=`<button data-unicode="${c.unicode}" class="emojis__item ariaLabel" aria-label="${wt(c)}">
${Me(c.unicode,void 0,!1,!0)}</button>`,i++)}else window.siyuan.config.editor.emoji.includes(c.unicode)&&a.push(c),d<2&&(n+=`<button data-unicode="${c.unicode}" class="emojis__item ariaLabel" aria-label="${wt(c)}">
${Me(c.unicode,void 0,!1,!0)}</button>`)}),e||(n+="</div>")}),e&&(o.sort((r,d)=>{const c=r.keywords.split("/"),u=d.keywords.split("/");return c[c.length-1].toLowerCase().indexOf(e.toLowerCase())<u[u.length-1].toLowerCase().indexOf(e.toLowerCase())?-1:0}).sort((r,d)=>{const c=r.keywords.split("/"),u=d.keywords.split("/");return c[c.length-1].toLowerCase().indexOf(e.toLowerCase())===u[u.length-1].toLowerCase().indexOf(e.toLowerCase())&&c[c.length-1].length<u[u.length-1].length?-1:0}).forEach(r=>{n+=`<button data-unicode="${r.unicode}" class="emojis__item ariaLabel" aria-label="${wt(r)}">
${Me(r.unicode,void 0,!1,!0)}</button>`}),n=n+s+"</div>");let l="";return a.length>0&&(l=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach(r=>{const d=a.filter(c=>c.unicode===r);d[0]&&(l+=`<button data-unicode="${d[0].unicode}" class="emojis__item ariaLabel" aria-label="${wt(d[0])}">
${Me(d[0].unicode,void 0,!1,!0)}
</button>`)}),l+="</div>"),l+n===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:l+n},Xt=e=>{window.siyuan.config.editor.emoji.unshift(e),window.siyuan.config.editor.emoji.length>Constants.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),fetchPost("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})},Pl=(e,t,n,a)=>{t!=="av"?window.siyuan.menus.menu.remove():window.siyuan.menus.menu.removeScrollEvent();const i=new Dialog({disableAnimation:!0,transparent:!0,hideCloseIcon:!0,width:isMobile()?"80vw":"360px",height:"50vh",content:`<div class="emojis">
    <div class="fn__flex">
        <span class="fn__space"></span>
        <label class="b3-form__icon fn__flex-1" style="overflow:initial;">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
            <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
        </label>
        <span class="fn__space"></span>
        <span class="block__icon block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="fn__space"></span>
        <span class="block__icon block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
        <span class="fn__space"></span>
    </div>
    <div class="emojis__panel">${An()}</div>
    <div class="fn__flex">
        ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",We(0)],["1f60d",We(1)],["1f433",We(2)],["1f96a",We(3)],["1f3a8",We(4)],["1f3dd-fe0f",We(5)],["1f52e",We(6)],["267e-fe0f",We(7)],["1f6a9",We(8)]].map(([r,d],c)=>`<div data-type="${c}" class="emojis__type ariaLabel" aria-label="${d}">${Me(r)}</div>`).join("")}
    </div>
</div>`});i.element.setAttribute("data-key",Constants.DIALOG_EMOJIS),i.element.querySelector(".b3-dialog__container").setAttribute("data-menu","true");const s=i.element.querySelector(".b3-dialog");s.style.justifyContent="inherit",s.style.alignItems="inherit",setPosition(i.element.querySelector(".b3-dialog__container"),n.x,n.y,n.h,n.w),i.element.querySelector(".emojis__item").classList.add("emojis__item--current");const o=i.element.querySelector(".b3-text-field"),l=i.element.querySelector(".emojis__panel");o.addEventListener("compositionend",()=>{var r;l.innerHTML=An(o.value),o.value?l.nextElementSibling.classList.add("fn__none"):l.nextElementSibling.classList.remove("fn__none"),l.scrollTop=0,(r=i.element.querySelector(".emojis__item"))==null||r.classList.add("emojis__item--current"),o.value===""&&kn(i.element),Cn(i.element)}),o.addEventListener("input",r=>{var d;r.isComposing||(l.innerHTML=An(o.value),o.value?l.nextElementSibling.classList.add("fn__none"):l.nextElementSibling.classList.remove("fn__none"),l.scrollTop=0,(d=i.element.querySelector(".emojis__item"))==null||d.classList.add("emojis__item--current"),o.value===""&&kn(i.element),Cn(i.element))}),o.addEventListener("keydown",r=>{var d,c,u,f;if(r.isComposing||r.key.indexOf("Arrow")===-1&&r.key!=="Enter")return;const g=i.element.querySelector(".emojis__item--current");if(!g)return;if(r.key==="Enter"){const m=g.getAttribute("data-unicode");t==="notebook"?fetchPost("/api/notebook/setNotebookIcon",{notebook:e,icon:m},()=>{i.destroy(),Xt(m),yt(m,e,"iconFilesRoot")}):t==="doc"?fetchPost("/api/attr/setBlockAttrs",{id:e,attrs:{icon:m}},()=>{i.destroy(),Xt(m),yt(m,e),Ln(m,e)}):a(m),r.preventDefault(),r.stopPropagation();return}let p;if(r.key==="ArrowLeft")g.previousElementSibling?(g.classList.remove("emojis__item--current"),p=g.previousElementSibling,r.preventDefault(),r.stopPropagation()):(d=g.parentElement.previousElementSibling)!=null&&d.previousElementSibling&&(g.classList.remove("emojis__item--current"),p=g.parentElement.previousElementSibling.previousElementSibling.lastElementChild,r.preventDefault(),r.stopPropagation());else if(r.key==="ArrowRight")g.nextElementSibling?(g.classList.remove("emojis__item--current"),p=g.nextElementSibling,r.preventDefault(),r.stopPropagation()):(c=g.parentElement.nextElementSibling)!=null&&c.nextElementSibling&&(g.classList.remove("emojis__item--current"),p=g.parentElement.nextElementSibling.nextElementSibling.firstElementChild,r.preventDefault(),r.stopPropagation());else if(r.key==="ArrowDown"){if(g.nextElementSibling){g.classList.remove("emojis__item--current");let m=Math.floor(g.parentElement.clientWidth/(g.clientWidth+2));for(p=g;p.nextElementSibling&&m>0;)p=p.nextElementSibling,m--}else{const m=(u=g.parentElement.nextElementSibling)==null?void 0:u.nextElementSibling;m&&(p=m.firstElementChild,g.classList.remove("emojis__item--current"))}r.preventDefault(),r.stopPropagation()}else if(r.key==="ArrowUp"){if(g.previousElementSibling){g.classList.remove("emojis__item--current");let m=Math.floor(g.parentElement.clientWidth/(g.clientWidth+2));for(p=g;p.previousElementSibling&&m>0;)p=p.previousElementSibling,m--}else{const m=(f=g.parentElement.previousElementSibling)==null?void 0:f.previousElementSibling;m&&(p=m.lastElementChild,g.classList.remove("emojis__item--current"))}r.preventDefault(),r.stopPropagation()}if(p){p.classList.add("emojis__item--current");const m=o.clientHeight+6;p.offsetTop-m<l.scrollTop?l.scrollTop=p.offsetTop-m-6:p.offsetTop-m-l.clientHeight+p.clientHeight>l.scrollTop&&(l.scrollTop=p.offsetTop-m-l.clientHeight+p.clientHeight)}}),isMobile()||o.focus(),kn(i.element),Cn(i.element),i.element.addEventListener("click",r=>{const d=r.target,c=hasClosestByClassName(d,"emojis__type");if(c){const g=l.querySelector(`[data-type="${c.getAttribute("data-type")}"]`);if(g){const p=g.nextElementSibling.getAttribute("data-index");if(p){let m="";window.siyuan.emojis[parseInt(p)].items.forEach(y=>{m+=`<button data-unicode="${y.unicode}" class="emojis__item ariaLabel" aria-label="${wt(y)}">
${Me(y.unicode)}</button>`}),g.nextElementSibling.innerHTML=m,g.nextElementSibling.removeAttribute("data-index")}l.scrollTo({top:g.offsetTop-34})}return}const u=hasClosestByClassName(d,"block__icon");if(u&&u.getAttribute("aria-label")===window.siyuan.languages.remove){t==="notebook"?fetchPost("/api/notebook/setNotebookIcon",{notebook:e,icon:""},()=>{i.destroy(),yt("",e,"iconFilesRoot")}):t==="doc"?fetchPost("/api/attr/setBlockAttrs",{id:e,attrs:{icon:""}},()=>{i.destroy(),yt("",e),Ln("",e)}):a("");return}const f=hasClosestByClassName(d,"emojis__item");if(f||u){let g="";f?(g=f.getAttribute("data-unicode"),t!=="av"&&i.destroy()):g=ri(),t==="notebook"?fetchPost("/api/notebook/setNotebookIcon",{notebook:e,icon:g},()=>{Xt(g),yt(g,e,"iconFilesRoot")}):t==="doc"?fetchPost("/api/attr/setBlockAttrs",{id:e,attrs:{icon:g}},()=>{Xt(g),yt(g,e),Ln(g,e)}):a(g);return}})},Ln=(e,t)=>{},yt=(e,t,n="iconFile")=>{let a;a=document.querySelector(`#sidebar [data-type="sidebar-file"] [data-node-id="${t}"] .b3-list-item__icon`),a&&(a.innerHTML=Me(e||(n==="iconFile"?a.previousElementSibling.classList.contains("fn__hidden")?Constants.SIYUAN_IMAGE_FILE:Constants.SIYUAN_IMAGE_FOLDER:Constants.SIYUAN_IMAGE_NOTE))),n!=="iconFile"&&setNoteBook()},wt=e=>window.siyuan.config.lang==="zh_CN"?e.description_zh_cn:window.siyuan.config.lang==="ja_JP"?e.description_ja_jp:e.description,We=e=>window.siyuan.config.lang==="zh_CN"?window.siyuan.emojis[e].title_zh_cn:window.siyuan.config.lang==="ja_JP"?window.siyuan.emojis[e].title_ja_jp:window.siyuan.emojis[e].title,di=e=>{if(window.siyuan.emojis[0].items.length>0){const t={};window.siyuan.emojis[0].items.forEach(n=>{t[n.keywords]=e.options.hint.emojiPath+"/"+n.unicode}),e.lute.PutEmojis(t)}},Rl=()=>{fetchPost("/api/system/getEmojiConf",{},e=>{window.siyuan.emojis=e.data,getAllEditor().forEach(t=>{di(t.protyle)})})},Ol=e=>{},ql=()=>{const e=new URLSearchParams(window.location.search),t=e.get("url");let n="",a=!1;if(/^web\+siyuan:\/\/blocks\/\d{14}-\w{7}/.test(t))n=t.substring(20,20+22),a=getSearch("focus",t)==="1";else if(window.JSAndroid){const i=window.JSAndroid.getBlockURL();n=ci(i),a=getSearch("focus",i)==="1"}else n=e.get("id"),a=e.get("focus")==="1";return{id:n,isZoomIn:a}},Fl=e=>/^siyuan:\/\/blocks\/\d{14}-\w{7}/.test(e),ci=e=>e.substring(16,16+22),Yl=(e=window.location.href)=>{const t=new URL(window.location.origin);t.pathname="/check-auth",t.searchParams.set("to",e),window.location.href=t.href},Ul=()=>{let e=document.getElementById("baseURL");e||(e=document.createElement("base"),e.id="baseURL"),e.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(e)},Ea=(e,t=!0,n=!1)=>{let a=e;return t&&(a=ka().basename(e)),n&&a.endsWith(".sy")&&(a=a.substr(0,a.length-3)),a},ui=e=>e.substring(7,e.length-ka().extname(e).length-23),Wl=e=>!e||(e=e.trim(),1>e.length)?!1:(e=e.toLowerCase(),e.startsWith("assets/")||e.startsWith("file://")||e.startsWith("\\\\")?!0:e.indexOf(":")===1),ka=()=>En.posix?En.posix:En,jl=()=>path,Vl=e=>{const t=[];return e.forEach(n=>{if(n.getAttribute("data-type")!=="navigation-root"){const a=n.getAttribute("data-path");t.find(s=>{if(a.startsWith(s.replace(".sy","")))return!0})||t.push(a)}}),t},Gl=(e,t,n)=>{fetchPost("/api/filetree/moveDocs",{toNotebook:t,fromPaths:e,toPath:n})},zl=(e,t,n,a,i=!1)=>{if(window.siyuan.dialogs.find(f=>{if(f.element.querySelector("#foldList"))return f.destroy(),!0}))return;const o=new Dialog({title:`${a||window.siyuan.languages.move}
<div style="max-height: 16px;overflow: auto;line-height: 14px;-webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 0, #000 6px);padding-bottom: 4px;margin-bottom: -4px" class="ft__smaller ft__on-surface fn__hidescrollbar"></div>`,content:`<div class="b3-form__icon" style="margin: 8px">
    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
    <input class="b3-text-field fn__block b3-form__icon-input" value="" placeholder="${window.siyuan.languages.search}">
</div>
<ul id="foldList" class="fn__flex-1 fn__none b3-list b3-list--background${isMobile()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></ul>
<div id="foldTree" class="fn__flex-1${isMobile()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></div>
<div class="fn__hr"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"50vw",height:isMobile()?"80vh":"70vh",destroyCallback(){n&&focusByRange(n)}});o.element.setAttribute("data-key",Constants.DIALOG_MOVEPATHTO),t&&t.length>0&&fetchPost("/api/filetree/getHPathsByPaths",{paths:t},f=>{o.element.querySelector(".b3-dialog__header .ft__smaller").innerHTML=escapeHtml(f.data.join(" "))});const l=o.element.querySelector("#foldList"),r=o.element.querySelector("#foldTree");fi(f=>{let g="";f.forEach(p=>{if(!p.closed){let m="";i&&(m=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${p.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${p.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${p.flashcardCount}</span>`),g+=`<ul class="b3-list b3-list--background">
<li class="b3-list-item${g===""?" b3-list-item--focus":""}" data-path="/" data-box="${p.id}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${unicode2Emoji(p.icon||Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${escapeHtml(p.name)}</span>
    ${m}
</li></ul>`}}),r.innerHTML=g},i);const d=o.element.querySelector(".b3-text-field"),c=f=>{if(!(f&&f.isComposing)){if(d.value.trim()===""){l.classList.add("fn__none"),r.classList.remove("fn__none");return}r.classList.add("fn__none"),l.classList.remove("fn__none"),l.scrollTo(0,0),fetchPost("/api/filetree/searchDocs",{k:d.value,flashcard:i},g=>{let p="";g.data.forEach(m=>{let y="";i&&(y=`<span class="fn__flex-1"></span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${m.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${m.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${m.flashcardCount}</span>`),p+=`<li class="b3-list-item${p===""?" b3-list-item--focus":""}" data-path="${m.path}" data-box="${m.box}">
    ${unicode2Emoji(m.boxIcon||Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__showall" style="padding:4px 0">${escapeHtml(m.hPath)}</span>
    ${y}
</li>`}),l.innerHTML=p})}};c(),d.addEventListener("compositionend",f=>{c(f)}),d.addEventListener("input",f=>{c(f)});const u=28;d.addEventListener("keydown",f=>{if(f.isComposing)return;const g=l.classList.contains("fn__none")?r:l,p=g.querySelectorAll(".b3-list-item--focus");if(p.length===0)return;let m=p[0];if(f.key.startsWith("Arrow")&&p.forEach((y,v)=>{v!==0&&y.classList.remove("b3-list-item--focus")}),l.classList.contains("fn__none")){if(f.key==="ArrowRight"&&!m.querySelector(".b3-list-item__arrow--open")&&!m.querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||f.key==="ArrowLeft"&&m.querySelector(".b3-list-item__arrow--open")){Sn(m,i),f.preventDefault();return}if(f.key==="ArrowLeft"){let y=m.parentElement.previousElementSibling;if(y){y.tagName!=="LI"&&(y=g.querySelector(".b3-list-item")),m.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus");const v=y.getBoundingClientRect(),b=g.getBoundingClientRect();(v.top<b.top||v.bottom>b.bottom)&&y.scrollIntoView(v.top<b.top)}return f.preventDefault(),!0}if(f.key==="ArrowDown"||f.key==="ArrowRight"){let y=m;for(;y;)if(y.nextElementSibling)if(y.nextElementSibling.classList.contains("fn__none"))y=y.nextElementSibling;else{y.nextElementSibling.tagName==="UL"?y=y.nextElementSibling.firstElementChild:y=y.nextElementSibling;break}else{if(y.parentElement.id==="foldTree")break;y=y.parentElement}if(y.classList.contains("b3-list-item")){m.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus");const v=y.getBoundingClientRect(),b=r.getBoundingClientRect();(v.top<b.top||v.bottom>b.bottom)&&y.scrollIntoView(v.top<b.top)}return f.preventDefault(),!0}if(f.key==="ArrowUp"){let y=m;for(;y;)if(y.previousElementSibling)if(y.previousElementSibling.classList.contains("fn__none"))y=y.previousElementSibling;else{if(y.previousElementSibling.tagName==="LI")y=y.previousElementSibling;else{const v=y.previousElementSibling.querySelectorAll(".b3-list-item");y=v[v.length-1]}break}else{if(y.parentElement.id==="foldTree")break;y=y.parentElement}if(y.classList.contains("b3-list-item")){m.classList.remove("b3-list-item--focus"),y.classList.add("b3-list-item--focus");const v=y.getBoundingClientRect(),b=r.getBoundingClientRect();(v.top<b.top||v.bottom>b.bottom)&&y.scrollIntoView(v.top<b.top)}f.preventDefault()}}else{if(f.key==="ArrowDown"){m.classList.remove("b3-list-item--focus"),m.nextElementSibling?m.nextElementSibling.classList.add("b3-list-item--focus"):g.children[0].classList.add("b3-list-item--focus"),m=g.querySelector(".b3-list-item--focus"),(g.scrollTop<m.offsetTop-g.clientHeight+u||g.scrollTop>m.offsetTop)&&(g.scrollTop=m.offsetTop-g.clientHeight+u),f.preventDefault();return}if(f.key==="ArrowUp"){if(m.classList.remove("b3-list-item--focus"),m.previousElementSibling)m.previousElementSibling.classList.add("b3-list-item--focus");else{const y=g.children.length;g.children[y-1].classList.add("b3-list-item--focus")}m=g.querySelector(".b3-list-item--focus"),(g.scrollTop<m.offsetTop-g.clientHeight+u||g.scrollTop>m.offsetTop-u*2)&&(g.scrollTop=m.offsetTop-u*2),f.preventDefault();return}}if(f.key==="Enter"){const y=g.querySelectorAll(".b3-list-item--focus");if(y.length===0)return;const v=[],b=[];y.forEach(w=>{v.push(w.getAttribute("data-path")),b.push(w.getAttribute("data-box"))}),e(v,b),o.destroy(),f.preventDefault()}}),o.element.addEventListener("click",f=>{let g=f.target;for(;g&&!g.isEqualNode(o.element);){if(g.classList.contains("b3-list-item__toggle")){Sn(g.parentElement,i),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-button--text")){const m=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(m.length===0)return;const y=[],v=[];m.forEach(b=>{y.push(b.getAttribute("data-path")),v.push(b.getAttribute("data-box"))}),e(y,v),o.destroy(),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-button--cancel")){o.destroy(),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-list-item")){const m=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(m.length===0)return;a===window.siyuan.languages.specifyPath&&isOnlyMeta(f)?m.length===1&&m[0].isSameNode(g)||g.classList.toggle("b3-list-item--focus"):(m[0].classList.remove("b3-list-item--focus"),g.classList.add("b3-list-item--focus")),g.getAttribute("data-path")==="/"&&Sn(g,i),f.preventDefault(),f.stopPropagation();break}g=g.parentElement}})},Sn=(e,t)=>{const n=e.querySelector(".b3-list-item__arrow");if(n.classList.contains("b3-list-item__arrow--open")){n.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling&&e.nextElementSibling.tagName==="UL"&&e.nextElementSibling.classList.add("fn__none");return}if(e.nextElementSibling&&e.nextElementSibling.tagName==="UL"){n.classList.add("b3-list-item__arrow--open"),e.nextElementSibling.classList.remove("fn__none");return}const a=e.getAttribute("data-box");fetchPost("/api/filetree/listDocsByPath",{notebook:a,path:e.getAttribute("data-path"),flashcard:t},i=>{if(i.data.files.length===0){showMessage(window.siyuan.languages.emptyContent);return}let s="";if(i.data.files.forEach(l=>{let r="";t?r=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${l.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardDueCard}">${l.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${l.flashcardCount}</span>`:l.count&&l.count>0&&(r=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${l.count}</span>`),s+=`<li data-box="${a}" class="b3-list-item" data-path="${l.path}">
    <span style="padding-left: ${l.path.split("/").length*8}px" class="b3-list-item__toggle b3-list-item__toggle--hl${l.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${unicode2Emoji(l.icon||(l.subFileCount===0?Constants.SIYUAN_IMAGE_FILE:Constants.SIYUAN_IMAGE_FOLDER),"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" aria-label="${Ea(l.name,!0,!0)} <small class='ft__on-surface'>${l.hSize}</small>${l.bookmark?"<br>"+window.siyuan.languages.bookmark+" "+l.bookmark:""}${l.name1?"<br>"+window.siyuan.languages.name+" "+l.name1:""}${l.alias?"<br>"+window.siyuan.languages.alias+" "+l.alias:""}${l.memo?"<br>"+window.siyuan.languages.memo+" "+l.memo:""}${l.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",l.subFileCount):""}<br>${window.siyuan.languages.modifiedAt} ${l.hMtime}<br>${window.siyuan.languages.createdAt} ${l.hCtime}">${Ea(l.name,!0,!0)}</span>
    ${r}
</li>`}),s==="")return;n.classList.add("b3-list-item__arrow--open"),e.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${s}</ul>`);const o=e.nextElementSibling;setTimeout(()=>{o.setAttribute("style",`height:${o.childElementCount*e.clientHeight}px;`),setTimeout(()=>{o.classList.remove("file-tree__sliderDown"),o.removeAttribute("style")},120)},2)})},Kl=e=>{let t="";return window.siyuan.notebooks.find(n=>{if(n.id===e)return t=n.name,!0}),t},Zl=e=>{let t="";return window.siyuan.notebooks.find(n=>{if(n.id===e)return t=n.icon,!0}),t},Xl=(e,t)=>{window.siyuan.notebooks.find(n=>{if(n.id===e)return n.name=t,!0})},Jl=()=>{let e=0;return window.siyuan.notebooks.forEach(t=>{t.closed||e++}),e},fi=(e,t=!1)=>{fetchPost("/api/notebook/lsNotebooks",{flashcard:t},n=>{t||(window.siyuan.notebooks=n.data.notebooks),e&&e(n.data.notebooks)})},Ql=e=>{const t=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value="${e}"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});t.element.setAttribute("data-key",Constants.DIALOG_RENAMETAG);const n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{t.destroy()});const a=t.element.querySelector("input");t.bindInput(a,()=>{n[1].click()}),a.focus(),a.select(),n[1].addEventListener("click",()=>{fetchPost("/api/tag/renameTag",{oldLabel:e,newLabel:a.value})})},er=()=>pathPosix().basename(window.siyuan.config.system.workspaceDir.replace(/\\/g,"/")),tr=(e,t)=>{e&&fetchPost("/api/block/checkBlockFold",{id:e},n=>{t(n.data.isFolded,n.data.isFolded?[Constants.CB_GET_FOCUS,Constants.CB_GET_ALL]:[Constants.CB_GET_FOCUS,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL],n.data.isRoot)})},nr=()=>{const e=new Dialog({title:window.siyuan.languages.about5,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.about5}" value="${window.siyuan.config.accessAuthCode}">
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),t=e.element.querySelector("input"),n=e.element.querySelectorAll(".b3-button");e.element.setAttribute("data-key",Constants.DIALOG_ACCESSAUTHCODE),e.bindInput(t,()=>{n[1].click()}),t.select(),n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{fetchPost("/api/system/setAccessAuthCode",{accessAuthCode:t.value})})},gi=e=>`${window.siyuan.config.cloudRegion===0?"https://ld246.com":"https://liuyun.io"}/${e}`,ar=e=>`https://b3log.org/siyuan${window.siyuan.config.lang==="zh_CN"?"":"/en"}/${e}`,pi=(e=window.siyuan.languages._kernel[29])=>window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1||window.siyuan.user.userSiYuanProExpireTime>0)?!1:(e&&(e===window.siyuan.languages._kernel[29]&&window.siyuan.config.system.container==="ios"?Qe(window.siyuan.languages._kernel[122]):(e===window.siyuan.languages._kernel[29]&&(e=window.siyuan.languages._kernel[29].replace("${url}",gi("subscribe/siyuan"))),Qe(e))),!0),mi=()=>window.siyuan.user&&(window.siyuan.user.userSiYuanSubscriptionStatus===0||window.siyuan.user.userSiYuanOneTimePayStatus===1),Ca="%%params",bi=e=>{let t={responsive:"resize"};const n=e.substring(0,e.indexOf(`
`));if(n.startsWith(Ca))try{t=we(n.substring(Ca.length))}catch(a){console.error(`Failed to parse ABCJS params: ${a}`)}return t},xn=(e,t=x.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="abc"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="abc"]')),n.length!==0&&n.length>0&&ae(`${t}/js/abcjs/abcjs-basic-min.js?v=6.2.2`,"protyleAbcjsScript").then(()=>{const a=B(e,"protyle-wysiwyg",!0);n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",Be(a));const s=i.firstElementChild.nextElementSibling;s.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${x.ZWSP}</span><div contenteditable="false"></div>`;const o=Lute.UnEscapeHTMLStr(i.getAttribute("data-content"));window.ABCJS.renderAbc(s.lastElementChild,o,bi(o)),i.setAttribute("data-render","true")})})};var hi=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const Tn=(e,t=x.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="echarts"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="echarts"]')),n.length!==0&&n.length>0&&ae(`${t}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then(()=>{ae(`${t}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then(()=>{let a;if(n[0].firstElementChild.clientWidth===0){const s=B(n[0],"layout-tab-container",!0);s&&Array.from(s.children).find(o=>{if(o.classList.contains("protyle")&&!o.classList.contains("fn__none"))return a=o.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0})}const i=B(e,"protyle-wysiwyg",!0);n.forEach(s=>hi(void 0,null,function*(){if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",Be(i));const o=s.firstElementChild.nextElementSibling;try{o.style.height=s.style.height;const l=yield we(Lute.UnEscapeHTMLStr(s.getAttribute("data-content")));window.echarts.init(o,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:a}).setOption(l),s.setAttribute("data-render","true"),o.classList.remove("ft__error"),o.textContent.endsWith(x.ZWSP)||o.firstElementChild.insertAdjacentText("beforeend",x.ZWSP)}catch(l){window.echarts.dispose(o),o.classList.add("ft__error"),o.innerHTML=`echarts render error: <br>${l}`}}))})})},In=(e,t=x.PROTYLE_CDN,n=!1)=>{let a=[];e.getAttribute("data-subtype")==="math"?a=[e]:a=Array.from(e.querySelectorAll('[data-subtype="math"]')),a.length!==0&&(_n(`${t}/js/katex/katex.min.css?v=0.16.9`,"protyleKatexStyle"),ae(`${t}/js/katex/katex.min.js?v=0.16.9`,"protyleKatexScript").then(()=>{ae(`${t}/js/katex/mhchem.min.js?v=0.16.9`,"protyleKatexMhchemScript").then(()=>{a.forEach(i=>{var s,o;if(i.getAttribute("data-render")==="true")return;i.setAttribute("data-render","true");let l=i;i.tagName==="DIV"&&(l=i.firstElementChild);let r={};try{r=we(window.siyuan.config.editor.katexMacros||"{}")}catch(d){console.warn("KaTex macros is not JSON",d)}try{l.innerHTML=window.katex.renderToString(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")),{displayMode:i.tagName==="DIV",output:"html",macros:r,trust:!0,strict:c=>c==="unicodeTextInMathMode"?"ignore":"warn"}),l.classList.remove("ft__error");const d=R(i);if(i.tagName==="DIV"){l.firstElementChild.setAttribute("contenteditable","false"),l.childElementCount<2&&l.insertAdjacentHTML("beforeend",`<span style="position: absolute;right: 0;top: 0;">${x.ZWSP}</span>`);const c=l.querySelectorAll(".base");c.length>0&&c[c.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const u=l.querySelector(".katex-html > .newline");u&&(u.parentElement.style.display="block")}else{d&&i.getBoundingClientRect().width>d.clientWidth?(i.style.maxWidth="100%",i.style.overflowX="auto",i.style.overflowY="hidden",i.style.display="inline-block"):(i.style.maxWidth="",i.style.overflowX="",i.style.overflowY="",i.style.display="");const c=ve(i);c?c&&c.nodeType!==3&&(((s=c.getAttribute("data-type"))==null?void 0:s.indexOf("inline-math"))>-1||c.classList.contains("img"))?i.after(document.createTextNode(x.ZWSP)):c&&!c.textContent.startsWith(`
`)&&c.textContent!==x.ZWSP&&i.insertAdjacentHTML("beforeend","&#xFEFF;"):i.parentElement.tagName!=="TH"&&i.parentElement.tagName!=="TD"?i.insertAdjacentText("afterend",`
`):i.insertAdjacentText("afterend",x.ZWSP),(o=i.previousSibling)!=null&&o.textContent.endsWith(`
`)?i.insertAdjacentText("beforebegin",x.ZWSP):!Te(i)&&["TH","TD"].includes(i.parentElement.tagName)&&i.insertAdjacentText("afterbegin",x.ZWSP)}n&&setTimeout(()=>{if(i.tagName==="DIV"){const c=i.querySelector(".katex-display");c.clientWidth<c.scrollWidth&&c.firstElementChild.setAttribute("style",`font-size:${c.clientWidth*100/c.scrollWidth}%`)}else d&&i.offsetWidth>d.clientWidth&&i.firstElementChild.setAttribute("style",`font-size:${d.clientWidth*100/i.offsetWidth}%`)})}catch(d){l.innerHTML=d.message,l.classList.add("ft__error")}})})}))};var yi=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const Dn=(e,t=x.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="mermaid"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="mermaid"]')),n.length!==0&&ae(`${t}/js/mermaid/mermaid.min.js?v=10.9.1`,"protyleMermaidScript").then(()=>{const a={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};if(window.siyuan.config.appearance.mode===1&&(a.theme="dark"),window.mermaid.initialize(a),n[0].firstElementChild.clientWidth===0){const i=O(n[0],"fold","1");if(!i)return;const s=new MutationObserver(()=>{Aa(n),s.disconnect()});s.observe(i,{attributeFilter:["fold"]})}else Aa(n)})},Aa=e=>{const t=B(e[0],"protyle-wysiwyg",!0);e.forEach(n=>yi(void 0,null,function*(){if(n.getAttribute("data-render")==="true")return;n.firstElementChild.classList.contains("protyle-icons")||n.insertAdjacentHTML("afterbegin",Be(t));const a=n.firstElementChild.nextElementSibling,i="mermaid"+Lute.NewNodeID();a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${x.ZWSP}</span><div contenteditable="false"><span id="${i}"></span></div>`;try{const s=yield window.mermaid.render(i,Lute.UnEscapeHTMLStr(n.getAttribute("data-content")));a.lastElementChild.innerHTML=s.svg}catch(s){const o=document.querySelector("#"+i);a.lastElementChild.innerHTML=`${o.outerHTML}<div class="fn__hr"></div><div class="ft__error">${s.message.replace(/\n/,"<br>")}</div>`,o.parentElement.remove()}n.setAttribute("data-render","true")}))},Mn=(e,t=x.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="mindmap"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="mindmap"]')),n.length!==0&&ae(`${t}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then(()=>{let a;if(n[0].firstElementChild.clientWidth===0){const s=B(n[0],"layout-tab-container",!0);s&&Array.from(s.children).find(o=>{if(o.classList.contains("protyle")&&!o.classList.contains("fn__none")&&o.querySelector(".protyle-wysiwyg").firstElementChild)return a=o.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0})}const i=B(e,"protyle-wysiwyg",!0);n.forEach(s=>{if(s.getAttribute("data-render")==="true")return;s.firstElementChild.classList.contains("protyle-icons")||s.insertAdjacentHTML("afterbegin",Be(i));const o=s.firstElementChild.nextElementSibling;try{o.style.height=s.style.height,window.echarts.init(o,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:a}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(s.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:6,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(l,r)=>{var d;return(d=r==null?void 0:r.data)!=null&&d.children?"circle":"path://"},type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"}),s.setAttribute("data-render","true"),o.textContent.endsWith(x.ZWSP)||o.firstElementChild.insertAdjacentText("beforeend",x.ZWSP),o.classList.remove("ft__error")}catch(l){o.classList.add("ft__error"),o.innerHTML=`Mindmap render error: <br>${l}`}})})},$n=(e,t=x.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="flowchart"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="flowchart"]')),n.length!==0&&ae(`${t}/js/flowchart.js/flowchart.min.js?v=0.0.0`,"protyleFlowchartScript").then(()=>{if(n[0].firstElementChild.clientWidth===0){const a=O(n[0],"fold","1");if(!a)return;const i=new MutationObserver(()=>{La(n),i.disconnect()});i.observe(a,{attributeFilter:["fold"]})}else La(n)})},La=e=>{const t=B(e[0],"protyle-wysiwyg",!0);e.forEach(n=>{if(n.getAttribute("data-render")==="true")return;n.firstElementChild.classList.contains("protyle-icons")||n.insertAdjacentHTML("afterbegin",Be(t));const a=n.firstElementChild.nextElementSibling;a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${x.ZWSP}</span><div class="ft__error" contenteditable="false"></div>`;try{flowchart.parse(Lute.UnEscapeHTMLStr(n.getAttribute("data-content"))).drawSVG(a.lastElementChild)}catch(i){a.innerHTML=`<span style="position: absolute;left:0;top:0;width: 1px;">${x.ZWSP}</span><div class="ft__error" contenteditable="false">Flow Chart render error: <br>${i}</div>`}n.setAttribute("data-render","true")})},Hn=(e,t=x.PROTYLE_CDN)=>{let n=[];e.getAttribute("data-subtype")==="plantuml"?n=[e]:n=Array.from(e.querySelectorAll('[data-subtype="plantuml"]')),n.length!==0&&ae(`${t}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then(()=>{const a=B(e,"protyle-wysiwyg",!0);n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",Be(a));const s=i.firstElementChild.nextElementSibling;try{s.innerHTML=`<img src=${window.siyuan.config.editor.plantUMLServePath}${window.plantumlEncoder.encode(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")))}">`,s.classList.remove("ft__error"),i.setAttribute("data-render","true")}catch(o){s.classList.add("ft__error"),s.innerHTML=`plantuml render error: <br>${o}`}})})},Nn=e=>{let t=[];e.getAttribute("data-type")==="NodeHTMLBlock"?t=[e]:t=Array.from(e.querySelectorAll('[data-type="NodeHTMLBlock"]')),t.length!==0&&t.length>0&&t.forEach(n=>{n.firstElementChild.firstElementChild.setAttribute("aria-label",window.siyuan.languages.edit),n.firstElementChild.lastElementChild.setAttribute("aria-label",window.siyuan.languages.more)})},sr=(e,t)=>{const n=document.createElement("div");n.innerHTML=e;let a=!1;if((n.childElementCount===1&&n.lastElementChild.style.fontFamily.indexOf("monospace")>-1||n.childElementCount===1&&n.querySelectorAll("pre").length===1||e.indexOf(`
<p class="p1">`)===0||n.childElementCount===1&&n.firstElementChild.tagName==="TABLE"&&n.querySelector(".line-number")&&n.querySelector(".line-content"))&&(a=!0),a){let i=t||e;return/\n/.test(i)?`<div data-type="NodeCodeBlock" class="code-block" data-node-id="${Lute.NewNodeID()}"><div class="protyle-action"><span class="protyle-action--first protyle-action__language" contenteditable="false">${window.siyuan.storage[Constants.LOCAL_CODELANG]}</span><span class="fn__flex-1"></span><span aria-label="${window.siyuan.languages.copy}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__copy"><svg><use xlink:href="#iconCopy"></use></svg></span><span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--last protyle-action__menu"><svg><use xlink:href="#iconMore"></use></svg></span></div><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${i.replace(/&/g,"&amp;").replace(/</g,"&lt;")}<wbr></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`:(i=i.replace("<","&lt;").replace(">","&gt;"),"`"+i+"`")}return!1},_t=e=>{const t=e.getAttribute("data-subtype");if(!x.SIYUAN_RENDER_CODE_LANGUAGES.includes(t)||e.getAttribute("data-type")!=="NodeHTMLBlock"){xn(e),Nn(e),Hn(e),Dn(e),$n(e),Tn(e),Mn(e),J(e),In(e);return}t==="abc"?xn(e):t==="plantuml"?Hn(e):t==="mermaid"?Dn(e):t==="flowchart"?$n(e):t==="echarts"?Tn(e):t==="mindmap"?Mn(e):t==="graphviz"?J(e):t==="math"?In(e):e.getAttribute("data-type")==="NodeHTMLBlock"&&Nn(e)},Sa=(e,t)=>{let n="";switch(e){case"NodeDocument":n="iconFile";break;case"NodeThematicBreak":n="iconLine";break;case"NodeParagraph":n="iconParagraph";break;case"NodeHeading":t?n="icon"+t.toUpperCase():n="iconHeadings";break;case"NodeBlockquote":n="iconQuote";break;case"NodeList":t==="t"?n="iconCheck":t==="o"?n="iconOrderedList":n="iconList";break;case"NodeListItem":n="iconListItem";break;case"NodeCodeBlock":case"NodeYamlFrontMatter":n="iconCode";break;case"NodeTable":n="iconTable";break;case"NodeBlockQueryEmbed":n="iconSQL";break;case"NodeSuperBlock":n="iconSuper";break;case"NodeMathBlock":n="iconMath";break;case"NodeHTMLBlock":n="iconHTML5";break;case"NodeWidget":n="iconBoth";break;case"NodeIFrame":n="iconLanguage";break;case"NodeVideo":n="iconVideo";break;case"NodeAudio":n="iconRecord";break;case"NodeAttributeView":n="iconDatabase";break}return n},vt=(e,t,n=!1)=>{if(!t){if(e.includes("dialog"))for(let a=0;a<window.siyuan.dialogs.length;a++)window.siyuan.dialogs[a].destroy(),a--;return}if(e.includes("hint")&&(clearTimeout(t.hint.timeId),t.hint.element.classList.add("fn__none")),t.gutter&&e.includes("gutter")&&(t.gutter.element.classList.add("fn__none"),t.gutter.element.innerHTML="",t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")})),t.gutter&&e.includes("gutterOnly")&&(t.gutter.element.classList.add("fn__none"),t.gutter.element.innerHTML=""),t.toolbar&&e.includes("toolbar")&&(t.toolbar.element.classList.add("fn__none"),t.toolbar.element.style.display=""),t.toolbar&&e.includes("util")){const a=t.toolbar.subElement.querySelector('[data-type="pin"]');(n||!a||a&&a.getAttribute("aria-label")===window.siyuan.languages.pin)&&(t.toolbar.subElement.classList.add("fn__none"),t.toolbar.subElementCloseCB&&(t.toolbar.subElementCloseCB(),t.toolbar.subElementCloseCB=void 0))}e.includes("select")&&t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{a.classList.remove("protyle-wysiwyg--select"),a.removeAttribute("select-start"),a.removeAttribute("select-end")})},ir=e=>{e.includes("toolbar")&&document.querySelectorAll(".protyle-toolbar").forEach(t=>{t.classList.add("fn__none"),t.style.display=""}),e.includes("util")&&getAllEditor().forEach(t=>{t.protyle.toolbar&&(t.protyle.toolbar.subElement.classList.add("fn__none"),t.protyle.toolbar.subElementCloseCB&&(t.protyle.toolbar.subElementCloseCB(),t.protyle.toolbar.subElementCloseCB=void 0))}),e.includes("pdfutil")&&document.querySelectorAll(".pdf__util").forEach(t=>{t.classList.add("fn__none")}),e.includes("gutter")&&document.querySelectorAll(".protyle-gutters").forEach(t=>{t.classList.add("fn__none"),t.innerHTML=""})},Jt=e=>{e.classList.add("protyle-wysiwyg--hl"),setTimeout(function(){e.classList.remove("protyle-wysiwyg--hl")},1024)},or=(e,t,n=!1)=>{let a;const i=e.wysiwyg.element;if(!e.preview.element.classList.contains("fn__none")){a=document.getElementById(t),a&&(e.preview.element.scrollTop=a.offsetTop,Jt(a));return}if(Array.from(i.querySelectorAll(`[data-node-id="${t}"]`)).find(s=>{if(!hasClosestByAttribute(s,"data-type","block-render",!0))return a=s,!0}),a)return Bn(e,a,n),Jt(a),a;if(t===e.block.rootID&&e.options.render.title&&e.title.editElement)return Jt(e.title.editElement),e.title.editElement},Bn=(e,t,n=!1,a="auto")=>{var i,s,o,l;if(!e.disabled&&!n&&getSelection().rangeCount>0){const f=getSelection().getRangeAt(0),g=R(f.startContainer);if(g){if(g.classList.contains("code-block")){const b=document.createElement("br");f.insertNode(b),b.scrollIntoView({block:"center",behavior:a}),b.remove();return}if(g.classList.contains("av")&&g.dataset.render==="true"&&(((i=g.querySelector(".av__row--header").getAttribute("style"))==null?void 0:i.indexOf("transform"))>-1||((s=g.querySelector(".av__row--footer").getAttribute("style"))==null?void 0:s.indexOf("transform"))>-1))return;const p=document.createElement("br");f.insertNode(p);const m=e.contentElement,y=p.getBoundingClientRect().top-m.getBoundingClientRect().top;let v=0;y<0?v=m.scrollTop+y:y>m.clientHeight-74&&(v=m.scrollTop+(y+74-m.clientHeight)),v!==0&&m.scroll({top:v,behavior:a}),p.remove();return}}if(!t&&((o=document.activeElement)==null?void 0:o.tagName)!=="TEXTAREA"&&((l=document.activeElement)==null?void 0:l.tagName)!=="INPUT"&&(t=R(ot(e.wysiwyg.element).startContainer)),!t)return;let r=0,d=t;for(;d&&!d.classList.contains("protyle-wysiwyg");)r+=d.offsetTop,d=d.parentElement;let c=0,u=e.element.firstElementChild;for(;u&&!u.classList.contains("protyle-content");)c+=u.clientHeight,u=u.nextElementSibling;if(n){e.contentElement.scroll({top:r-c,behavior:a});return}e.contentElement.scrollTop>r-32?e.contentElement.scroll({top:r-c,behavior:a}):e.contentElement.scrollTop+e.contentElement.clientHeight<r+t.clientHeight-c&&e.contentElement.scroll({top:r+t.clientHeight-c-e.contentElement.clientHeight,behavior:a})},Pn=(e,t=0,n=1e3)=>{e.scroll.lastScrollTop=-1,setTimeout(()=>{e.scroll.lastScrollTop=t},n)};var wi=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const _i=e=>({label:window.siyuan.languages.export,icon:"iconUpload",click(){return wi(this,null,function*(){ha(e)})}}),lr=(e,t,n,a)=>{},rr=e=>{if(isInAndroid()){window.JSAndroid.writeImageClipboard(e);return}else{const t=document.createElement("canvas"),n=document.createElement("img");n.onload=a=>{t.width=a.target.width,t.height=a.target.height,t.getContext("2d").drawImage(a.target,0,0,a.target.width,a.target.height),t.toBlob(i=>{navigator.clipboard.write([new ClipboardItem({["image/png"]:i})])},"image/png",1)},n.src=e}};class dr{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.querySelector(".b3-menu__title .b3-menu__label").innerHTML=window.siyuan.languages.back,this.element.addEventListener(isMobile()?"click":"mouseover",t=>{const n=t.target;if(isMobile()&&(hasClosestByClassName(n,"b3-menu__title")||typeof t.detail=="string"&&t.detail==="back")){const o=this.element.querySelectorAll(".b3-menu__item--show");o.length>0?o[o.length-1].classList.remove("b3-menu__item--show"):this.remove();return}const a=hasClosestByClassName(n,"b3-menu__item");if(!a||a.classList.contains("b3-menu__item--readonly"))return;const i=a.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach(s=>{!s.contains(a)&&!s.isSameNode(a)&&!a.contains(s)&&s.classList.remove("b3-menu__item--show")}),this.element.querySelectorAll(".b3-menu__item--current").forEach(s=>{s.classList.remove("b3-menu__item--current")}),a.classList.add("b3-menu__item--current"),i&&(a.classList.add("b3-menu__item--show"),this.element.classList.contains("b3-menu--fullscreen")||this.showSubMenu(i))})}showSubMenu(t){const n=t.parentElement.getBoundingClientRect();t.style.top=n.top-8+"px",t.style.left=n.right+8+"px",t.style.bottom="auto";const a=t.getBoundingClientRect();a.right>window.innerWidth&&(n.left-8>a.width?t.style.left=n.left-8-a.width+"px":t.style.left=window.innerWidth-a.width+"px"),a.bottom>window.innerHeight&&(t.style.top="auto",t.style.bottom="8px")}preventDefault(t){!hasClosestByClassName(t.target,"b3-menu")&&!hasClosestByClassName(t.target,"keyboard__bar")&&t.preventDefault()}addSeparator(t){return this.addItem({type:"separator",index:t})}addItem(t){const n=new Ee(t);return this.append(n.element,t.index),n.element}removeScrollEvent(){window.removeEventListener(isMobile()?"touchmove":this.wheelEvent,this.preventDefault,!1)}remove(){window.siyuan.menus.menu.removeCB&&(window.siyuan.menus.menu.removeCB(),window.siyuan.menus.menu.removeCB=void 0),this.removeScrollEvent(),this.element.firstElementChild.classList.add("fn__none"),this.element.lastElementChild.innerHTML="",this.element.lastElementChild.removeAttribute("style"),this.element.classList.add("fn__none"),this.element.classList.remove("b3-menu--list","b3-menu--fullscreen"),this.element.removeAttribute("style"),this.element.removeAttribute("data-name"),this.element.removeAttribute("data-from"),this.data=void 0}append(t,n){if(t){if(typeof n=="number"){const a=this.element.querySelectorAll(".b3-menu__items > .b3-menu__separator")[n];if(a){a.before(t);return}}this.element.lastElementChild.append(t)}}popup(t){this.element.lastElementChild.innerHTML!==""&&(window.addEventListener(isMobile()?"touchmove":this.wheelEvent,this.preventDefault,{passive:!1}),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.classList.remove("fn__none"),setPosition(this.element,t.x-(t.isLeft?this.element.clientWidth:0),t.y,t.h,t.w))}fullscreen(t="all"){this.element.lastElementChild.innerHTML!==""&&(this.element.classList.add("b3-menu--fullscreen"),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.firstElementChild.classList.remove("fn__none"),this.element.classList.remove("fn__none"),window.addEventListener("touchmove",this.preventDefault,{passive:!1}),setTimeout(()=>{t==="bottom"?(this.element.style.transform="translateY(-50vh)",this.element.style.height="50vh"):this.element.style.transform="translateY(-100vh)"}),this.element.lastElementChild.scrollTop=0)}}class Ee{constructor(t){if(!t.ignore){if(t.type==="empty"){this.element=document.createElement("div"),this.element.innerHTML=t.label,t.bind&&t.bind(this.element);return}if(this.element=document.createElement("button"),t.disabled&&this.element.setAttribute("disabled","disabled"),t.id&&this.element.setAttribute("data-id",t.id),t.type==="separator"){this.element.classList.add("b3-menu__separator");return}if(this.element.classList.add("b3-menu__item"),t.current&&this.element.classList.add("b3-menu__item--selected"),t.click&&this.element.addEventListener("click",n=>{if(this.element.getAttribute("disabled"))return;let a=t.click(this.element,n);a instanceof Promise&&(a=!1),n.preventDefault(),n.stopImmediatePropagation(),n.stopPropagation(),this.element.parentElement&&!a&&window.siyuan.menus.menu.remove()}),t.type==="readonly"&&this.element.classList.add("b3-menu__item--readonly"),t.element)this.element.append(t.element);else{let n=`<span class="b3-menu__label">${t.label||"&nbsp;"}</span>`;typeof t.iconHTML=="string"?n=t.iconHTML+n:n=`<svg class="b3-menu__icon ${t.iconClass||""}" style="${t.icon==="iconClose"?"height:10px;":""}"><use xlink:href="#${t.icon||""}"></use></svg>${n}`,t.accelerator&&(n+=`<span class="b3-menu__accelerator">${vn(t.accelerator)}</span>`),t.action&&(n+=`<svg class="b3-menu__action${t.action==="iconCloseRound"?" b3-menu__action--close":""}"><use xlink:href="#${t.action}"></use></svg>`),t.checked&&(n+='<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>'),this.element.innerHTML=n}if(t.bind&&(this.element.classList.add("b3-menu__item--custom"),t.bind(this.element)),t.submenu){const n=document.createElement("div");n.classList.add("b3-menu__submenu"),n.innerHTML='<div class="b3-menu__items"></div>',t.submenu.forEach(a=>{n.firstElementChild.append(new Ee(a).element)}),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>'),this.element.append(n)}}}}const lt=(e,t)=>{let n=e;for(;n&&(n.classList.contains("b3-menu__separator")||n.classList.contains("b3-menu__item--readonly")||n.getBoundingClientRect().height===0)&&!n.querySelector(".b3-text-field");)t?n=n.nextElementSibling:n=n.previousElementSibling;return n},cr=e=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||e.altKey||e.shiftKey||e.ctrlKey||e.metaKey)return!1;const t=e.target;if(window.siyuan.menus.menu.element.contains(t)&&["INPUT","TEXTAREA"].includes(t.tagName))return!1;const n=Constants.KEYCODELIST[e.keyCode];if(n==="\u2193"||n==="\u2191"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let i;if(a?(a.classList.remove("b3-menu__item--current","b3-menu__item--show"),n==="\u2191"?(i=lt(a.previousElementSibling,!1),i||(i=lt(a.parentElement.lastElementChild,!1))):(i=lt(a.nextElementSibling,!0),i||(i=lt(a.parentElement.firstElementChild,!0)))):n==="\u2191"?i=lt(window.siyuan.menus.menu.element.lastElementChild.lastElementChild,!1):i=lt(window.siyuan.menus.menu.element.lastElementChild.firstElementChild,!0),i){i.classList.add("b3-menu__item--current"),i.classList.remove("b3-menu__item--show");const s=i.parentElement.getBoundingClientRect(),o=i.getBoundingClientRect();(s.top>o.top||s.bottom<o.bottom)&&i.scrollIntoView(s.top>o.top)}return!0}else if(n==="\u2192"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!a)return!0;const i=a.querySelector(".b3-menu__submenu");if(!i)return!0;a.classList.remove("b3-menu__item--current"),a.classList.add("b3-menu__item--show");const s=lt(i.firstElementChild.firstElementChild,!0);return s&&s.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(i),!0}else if(n==="\u2190"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");if(!a)return!0;const i=hasClosestByClassName(a,"b3-menu__item--show");return i&&(i.classList.remove("b3-menu__item--show"),i.classList.add("b3-menu__item--current"),a.classList.remove("b3-menu__item--current")),!0}else if(n==="\u21A9"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(a){const i=a.querySelector(".b3-text-field"),s=a.querySelector(".b3-switch");if(i)return i.focus(),!0;s?s.click():a.dispatchEvent(new CustomEvent(getEventName())),window.siyuan.menus.menu.element.contains(a)&&window.siyuan.menus.menu.remove()}else return!1;return!0}};class vi{constructor(){this.menus=[]}addSeparator(t){typeof t=="number"?this.menus.splice(t,0,{type:"separator"}):this.menus.push({type:"separator"})}addItem(t){typeof t.index=="number"?this.menus.splice(t.index,0,t):this.menus.push(t)}}const Ei=()=>{const e=[];return window.siyuan.mobile.editor&&e.push(window.siyuan.mobile.editor),window.siyuan.mobile.popEditor&&e.push(window.siyuan.mobile.popEditor),e},ur=()=>{const e={editor:[],graph:[],asset:[],outline:[],backlink:[],search:[],inbox:[],files:[],bookmark:[],tag:[],custom:[]},t=n=>{for(let a=0;a<n.children.length;a++){const i=n.children[a];if(i instanceof Tab){const s=i.model;s instanceof Editor?e.editor.push(s):s instanceof Graph?e.graph.push(s):s instanceof Outline?e.outline.push(s):s instanceof Backlink?e.backlink.push(s):s instanceof Asset?e.asset.push(s):s instanceof Search?e.search.push(s):s instanceof Files?e.files.push(s):s instanceof Bookmark?e.bookmark.push(s):s instanceof Tag?e.tag.push(s):s instanceof Custom&&e.custom.push(s)}else t(i)}};return window.siyuan.layout.layout&&t(window.siyuan.layout.layout),e},ki=(e,t)=>{for(let n=0;n<e.children.length;n++){const a=e.children[n];a instanceof Wnd?t.push(a):a instanceof Layout&&ki(a,t)}},fr=()=>{const e=[],t=n=>{for(let a=0;a<n.children.length;a++){const i=n.children[a];i instanceof Tab?e.push(i):t(i)}};return window.siyuan.layout.centerLayout&&t(window.siyuan.layout.centerLayout),e},gr=()=>{const e=[];return window.siyuan.config.uiLayout.left.data.forEach(t=>{t.forEach(n=>{e.push(n)})}),window.siyuan.config.uiLayout.right.data.forEach(t=>{t.forEach(n=>{e.push(n)})}),window.siyuan.config.uiLayout.bottom.data.forEach(t=>{t.forEach(n=>{e.push(n)})}),e},Ci=(e,t)=>/\r\n|\r|\n|\u2028|\u2029|\t|\//.test(e)?(t?showTooltip(window.siyuan.languages.fileNameRule,t,"error"):showMessage(window.siyuan.languages.fileNameRule),!1):e.length>Constants.SIZE_TITLE?(t?showTooltip(window.siyuan.languages._kernel[106],t,"error"):showMessage(window.siyuan.languages._kernel[106]),!1):!0,Rn=e=>e.replace(/\r\n|\r|\n|\u2028|\u2029|\t|\//g,"").substring(0,x.SIZE_TITLE),pr=e=>e.replace(/\\\\|\/|"|:|\*|\?|\\|'|<|>|\|/g,""),mr=e=>{if(window.siyuan.config.readonly)return;const t=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",destroyCallback(){e.range&&focusByRange(e.range)}});t.element.setAttribute("data-key",Constants.DIALOG_RENAME);const n=t.element.querySelector("input"),a=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{a[1].click()}),n.value=Lute.UnEscapeHTMLStr(e.name),n.focus(),n.select(),a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{if(!Ci(n.value))return!1;if(n.value===e.name)return t.destroy(),!1;n.value.trim()===""?n.value=window.siyuan.languages.untitled:n.value=Rn(n.value),e.type==="notebook"?fetchPost("/api/notebook/renameNotebook",{notebook:e.notebookId,name:n.value},()=>{setNotebookName(e.notebookId,n.value)}):fetchPost("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:n.value}),t.destroy()})},Ai=e=>{const t=new va({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:re()?"92vw":"520px"});t.element.setAttribute("data-key",x.DIALOG_RENAMEASSETS);const n=t.element.querySelector("input"),a=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{a[1].click()});const i=ui(e);n.value=i,n.focus(),n.select(),a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{if(n.value===i||!n.value)return t.destroy(),!1;Se("/api/asset/renameAsset",{oldPath:e,newName:n.value},s=>{Ei().forEach(o=>{o.reload(!1)}),t.destroy()})})},br=e=>{if(getSelection().rangeCount===0)return;const t=getSelection().getRangeAt(0),n=hasClosestBlock(t.startContainer);if(!n)return;let a=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&(a=[n]);let i="",s=t.toString();if(s===""){if(s=a[0].textContent,a.forEach(o=>{i+=removeEmbed(o)}),!s)return}else{const o=document.createElement("div");o.appendChild(t.cloneContents()),i=o.innerHTML}s.length>10&&(s=s.substr(0,10)+"..."),s=Rn(s),fetchPost("/api/filetree/createDoc",{notebook:e.notebookId,path:pathPosix().join(getDisplayName(e.path,!1,!0),Lute.NewNodeID()+".sy"),title:s,md:e.lute.BlockDOM2StdMd(i)})};var je=Ie(752);const hr=(e,t)=>{},yr=e=>{const t=new Dialog({title:window.siyuan.languages.exportAsImage,content:`<div class="b3-dialog__content" style="${isMobile()?"padding:8px;":""};background-color: var(--b3-theme-background)">
    <div style="${isMobile()?"padding: 16px;margin: 8px 0":"padding: 48px;margin: 8px 0"};" class="export-img">
        <div class="protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}"></div>
        <div class="export-img__watermark"></div>
    </div>
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        ${window.siyuan.languages.exportPDF5}
        <span class="fn__space"></span>
        <input id="keepFold" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[Constants.LOCAL_EXPORTIMG].keepFold?"checked":""}>
    </label>
    <label class="fn__flex" style="margin-left: 24px">
        ${window.siyuan.languages.export30}
        <span class="fn__space"></span>
        <input id="watermark" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[Constants.LOCAL_EXPORTIMG].watermark?"checked":""}>
    </label>
    <span class="fn__flex-1 export-img__space"></span>
    <button disabled class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button disabled class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>
 <div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>`,width:isMobile()?"92vw":"990px",height:"70vh"});t.element.setAttribute("data-key",Constants.DIALOG_EXPORTIMAGE);const n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{const r=showMessage(window.siyuan.languages.exporting,0);t.element.querySelector(".b3-dialog__container").style.height="",setStorageVal(Constants.LOCAL_EXPORTIMG,window.siyuan.storage[Constants.LOCAL_EXPORTIMG]),setTimeout(()=>{addScript("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(t.element.querySelector(".b3-dialog__content"),{useCORS:!0}).then(d=>{d.toBlob(c=>{const u=new FormData;u.append("file",c,n[1].getAttribute("data-title")),u.append("type","image/png"),fetchPost("/api/export/exportAsFile",u,f=>{openByMobile(f.data.file)}),hideMessage(r),t.destroy()})})})},Constants.TIMEOUT_LOAD)});const a=t.element.querySelector(".protyle-wysiwyg"),i=t.element.querySelector("#keepFold");i.addEventListener("change",()=>{n[0].setAttribute("disabled","disabled"),n[1].setAttribute("disabled","disabled"),n[1].parentElement.insertAdjacentHTML("afterend",'<div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>'),window.siyuan.storage[Constants.LOCAL_EXPORTIMG].keepFold=i.checked,fetchPost("/api/export/exportPreviewHTML",{id:e,keepFold:i.checked,image:!0},r=>{l(r)})});const s=t.element.querySelector("#watermark");s.addEventListener("change",()=>{window.siyuan.storage[Constants.LOCAL_EXPORTIMG].watermark=s.checked,s.checked&&!isPaidUser()&&(s.checked=!1,showMessage(window.siyuan.languages._kernel[214])),o()});const o=()=>{if(!isPaidUser())return;const r=t.element.querySelector(".export-img__watermark");r.innerHTML="",s.checked?window.siyuan.config.export.imageWatermarkDesc?r.innerHTML=window.siyuan.config.export.imageWatermarkDesc:window.siyuan.config.export.imageWatermarkStr&&(window.siyuan.config.export.imageWatermarkStr.startsWith("http")?r.setAttribute("style",`background-image: url(${window.siyuan.config.export.imageWatermarkStr});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`):addScript("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{const d=Math.max(t.element.querySelector(".export-img").clientWidth/3,150);r.setAttribute("style",`width: ${d}px;height: ${d}px;display: flex;justify-content: center;align-items: center;color: var(--b3-border-color);font-size: 14px;`),r.innerHTML=`<div style="transform: rotate(-45deg)">${window.siyuan.config.export.imageWatermarkStr}</div>`,window.html2canvas(r,{useCORS:!0,scale:1}).then(c=>{r.innerHTML="",r.setAttribute("style",`background-image: url(${c.toDataURL("image/png")});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`)})})):r.removeAttribute("style")},l=r=>{a.innerHTML=r.data.content,a.querySelectorAll('[data-type~="mark"], [data-type~="u"], [data-type~="text"], [data-type~="code"], [data-type~="tag"], [data-type~="kbd"]').forEach(d=>{d.childNodes.forEach(c=>{let u="";Array.from(c.textContent).forEach(g=>{u+=`<span style="${d.getAttribute("style")||""};border-radius: 0;padding-left: 0;padding-right: 0;box-shadow: none;border-left:0;border-right:0;border-top:0" data-type="${d.getAttribute("data-type")}">${g}</span>`});const f=document.createElement("template");f.innerHTML=u,c.after(f.content),c.remove()}),d.childNodes.length>0&&(d.setAttribute("style",""),d.setAttribute("data-type",d.getAttribute("data-type").replace(/mark|u|text|code|tag|kbd/g,"")))}),a.setAttribute("data-doc-type",r.data.type||"NodeDocument"),r.data.attrs.memo&&a.setAttribute("memo",r.data.attrs.memo),r.data.attrs.name&&a.setAttribute("name",r.data.attrs.name),r.data.attrs.bookmark&&a.setAttribute("bookmark",r.data.attrs.bookmark),r.data.attrs.alias&&a.setAttribute("alias",r.data.attrs.alias),a.querySelectorAll(".code-block").forEach(d=>{d.setAttribute("linewrap","true")}),processRender(a),highlightRender(a),a.querySelectorAll("table").forEach(d=>{d.clientWidth>d.parentElement.clientWidth&&(d.setAttribute("style",`margin-bottom:${d.parentElement.clientWidth*d.clientHeight/d.clientWidth-d.parentElement.clientHeight+1}px;transform: scale(${d.parentElement.clientWidth/d.clientWidth});transform-origin: top left;`),d.parentElement.style.overflow="hidden")}),a.querySelectorAll(".li > .protyle-action > svg").forEach(d=>{const c=d.firstElementChild.getAttribute("xlink:href"),u=document.querySelectorAll(c);let f="0 0 32 32";c==="#iconDot"&&(f="0 0 20 20"),d.setAttribute("viewBox",f),d.innerHTML=u[u.length-1].innerHTML}),a.querySelectorAll(".img img").forEach(d=>{const c=d.getAttribute("src");c.endsWith(".svg")?fetchGet(d.src,u=>{d.src=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(u)))}`}):c.startsWith("assets/")&&(d.src=location.origin+"/"+c)}),o(),n[0].removeAttribute("disabled"),n[1].removeAttribute("disabled"),t.element.querySelector(".fn__loading").remove()};fetchPost("/api/export/exportPreviewHTML",{id:e,keepFold:i.checked,image:!0},r=>{l(r),n[1].setAttribute("data-title",r.data.name+".png")})},wr=(e,t)=>{if(e.includes("\u2303")){if(!t.ctrlKey)return!1}else if(isMac()?t.ctrlKey:e.includes("\u2318")?!t.ctrlKey:t.ctrlKey)return!1;if(e.includes("\u2325")){if(!t.altKey)return!1}else if(t.altKey)return!1;if(e.includes("\u21E7")){if(!t.shiftKey)return!1}else if(t.shiftKey)return!1;if(e.includes("\u2318")){if(isMac()?!t.metaKey:!t.ctrlKey)return!1}else if(isMac()?t.metaKey:e.includes("\u2303")?!t.ctrlKey:t.ctrlKey)return!1;return!0},Qt=(e,t)=>{const n=e.replace(t,Constants.ZWSP).split("");return n.forEach((a,i)=>{a===Constants.ZWSP&&(n[i]=t)}),n},_r=(e,t)=>{if(!e)return!1;if(e.startsWith("\u2303")&&!isMac()){if(e==="\u2303D")return!1;e=e.replace("\u2318","").replace("\u2303","\u2318").replace("\u2318\u21E7","\u21E7\u2318").replace("\u2318\u2325\u21E7","\u2325\u21E7\u2318").replace("\u2318\u2325","\u2325\u2318")}if(e.indexOf("\u21E7")===-1&&e.indexOf("\u2318")===-1&&e.indexOf("\u2325")===-1&&e.indexOf("\u2303")===-1)return!!(isNotCtrl(t)&&!t.altKey&&!t.shiftKey&&e===Constants.KEYCODELIST[t.keyCode]);let n=e.split("");if(e.indexOf("F")>-1?n.forEach((i,s)=>{i==="F"&&(n[s]="F"+n.splice(s+1,1),n[s+1]&&(n[s+1]+=n.splice(s+1,1)))}):e.indexOf("PageUp")>-1?n=Qt(e,"PageUp"):e.indexOf("PageDown")>-1?n=Qt(e,"PageDown"):e.indexOf("Home")>-1?n=Qt(e,"Home"):e.indexOf("End")>-1&&(n=Qt(e,"End")),e.startsWith("\u21E7")&&n.length===2)return!!(isNotCtrl(t)&&!t.altKey&&t.shiftKey&&n[1]===Constants.KEYCODELIST[t.keyCode]);if(e.startsWith("\u2325")){let i=n.length===3?n[2]:n[1];n.length===4&&(i=n[3]);const s=i===Constants.KEYCODELIST[t.keyCode];return!!(s&&t.altKey&&!t.shiftKey&&n.length<4&&(n.length===3?isOnlyMeta(t)&&e.startsWith("\u2325\u2318"):isNotCtrl(t))||s&&e.startsWith("\u2325\u21E7\u2318")&&n.length===4&&t.altKey&&t.shiftKey&&isOnlyMeta(t)||s&&e.startsWith("\u2325\u21E7")&&n.length===3&&t.altKey&&t.shiftKey&&isNotCtrl(t))}if(e.startsWith("\u2303")){if(!isMac())return!1;let i=n.length===3?n[2]:n[1];n.length===4?i=n[3]:n.length===5&&(i=n[4]);const s=i===Constants.KEYCODELIST[t.keyCode];return!!(s&&t.ctrlKey&&!t.altKey&&!t.shiftKey&&n.length<4&&(n.length===3?t.metaKey&&e.startsWith("\u2303\u2318"):!t.metaKey)||s&&e.startsWith("\u2303\u21E7")&&n.length===3&&t.ctrlKey&&!t.altKey&&t.shiftKey&&!t.metaKey||s&&e.startsWith("\u2303\u2325")&&n.length===3&&t.ctrlKey&&t.altKey&&!t.shiftKey&&!t.metaKey||s&&n.length===4&&t.ctrlKey&&(e.startsWith("\u2303\u2325\u21E7")&&t.shiftKey&&!t.metaKey&&t.altKey||e.startsWith("\u2303\u2325\u2318")&&!t.shiftKey&&t.metaKey&&t.altKey||e.startsWith("\u2303\u21E7\u2318")&&t.shiftKey&&t.metaKey&&!t.altKey)||s&&n.length===5&&t.ctrlKey&&t.shiftKey&&t.metaKey&&t.altKey)}const a=n.length>2&&n[0]==="\u21E7";return isOnlyMeta(t)&&!t.altKey&&(!a&&!t.shiftKey||a&&t.shiftKey)?(a?n[2]:n[1])===Constants.KEYCODELIST[t.keyCode]:!1},On=(e,t,n)=>{if(e.getAttribute("custom-pinthead")==="true"){const a=e.querySelector("table");a.clientHeight+a.scrollTop<t.offsetTop+t.clientHeight?a.scrollTop=t.offsetTop-a.clientHeight+t.clientHeight+1:a.scrollTop>t.offsetTop-t.clientHeight&&(a.scrollTop=t.offsetTop-t.clientHeight+1)}else scrollCenter(n,t)},Ze=e=>{let t=e.previousElementSibling,n=0;for(;t;)n++,t=t.previousElementSibling;return n},xa=(e,t,n=!0)=>{let a=e.previousElementSibling;return a||(e.parentElement.previousElementSibling?a=e.parentElement.previousElementSibling.lastElementChild:e.parentElement.parentElement.tagName==="TBODY"&&e.parentElement.parentElement.previousElementSibling?a=e.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:a=null),a&&(t.selectNodeContents(a),n||t.collapse(!1),focusByRange(t)),a},qn=(e,t,n,a,i)=>{i.insertNode(document.createElement("wbr"));const s=n.outerHTML,o=n.querySelector("table"),l=o.rows[0].cells.length,r=o.rows.length,d=[];for(let c=0;c<r;c++){for(let u=0;u<l;u++)o.rows[c].cells[u].isSameNode(t[d.length])&&d.push(u);if(d.length>0)break}for(let c=0;c<r;c++)d.forEach(u=>{o.rows[c].cells[u].setAttribute("align",a)});updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,s),focusByWbr(o,i)},Ta=(e,t,n,a)=>{const i=document.createElement("wbr");t.insertNode(i);const s=a.outerHTML;i.remove();let o="";for(let r=0;r<n.parentElement.childElementCount;r++)o+=`<td align="${n.parentElement.children[r].getAttribute("align")||""}"></td>`;let l;if(n.tagName==="TH"){const r=a.querySelector("tbody");r?(r.insertAdjacentHTML("afterbegin",`<tr>${o}</tr>`),l=r.firstElementChild):(n.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${o}</tr></tbody>`),l=n.parentElement.parentElement.nextElementSibling.firstElementChild)}else n.parentElement.insertAdjacentHTML("afterend",`<tr>${o}</tr>`),l=n.parentElement.nextElementSibling;t.selectNodeContents(l.cells[Ze(n)]),t.collapse(!0),focusByRange(t),updateTransaction(e,a.getAttribute("data-node-id"),a.outerHTML,s),On(a,l,e)},Li=(e,t,n,a)=>{const i=document.createElement("wbr");t.insertNode(i);const s=a.outerHTML;i.remove();let o="",l=!1;for(let d=0;d<n.parentElement.childElementCount;d++){const c=n.parentElement.children[d];c.className==="fn__none"&&(l=!0),n.tagName==="TH"?o+=`<th class="${c.className}" colspan="${c.colSpan}" align="${c.getAttribute("align")}"></th>`:o+=`<td class="${c.className}" colspan="${c.colSpan}" align="${c.getAttribute("align")}"></td>`}if(l){let d=n.parentElement.previousElementSibling,c=1;for(;d;)c++,Array.from(d.children).forEach(u=>{u.rowSpan>=c&&u.rowSpan>1&&(u.rowSpan=u.rowSpan+1)}),d=d.previousElementSibling}let r;n.parentElement.parentElement.tagName==="THEAD"&&!n.parentElement.previousElementSibling?(n.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${o}</tr></thead>`),r=a.querySelector("thead tr"),n.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",n.parentElement.parentElement.innerHTML),n.parentElement.parentElement.remove()):(n.parentElement.insertAdjacentHTML("beforebegin",`<tr>${o}</tr>`),r=n.parentElement.previousElementSibling),t.selectNodeContents(r.cells[Ze(n)]),t.collapse(!0),focusByRange(t),updateTransaction(e,a.getAttribute("data-node-id"),a.outerHTML,s),On(a,r,e)},Ia=(e,t,n,a,i)=>{const s=document.createElement("wbr");i.insertNode(s);const o=t.outerHTML;s.remove();const l=Ze(n),r=t.querySelector("table");for(let d=0;d<r.rows.length;d++){const c=r.rows[d].cells[l],u=document.createElement(c.tagName);c.insertAdjacentElement(a,u),c.isSameNode(n)?(u.innerHTML="<wbr> ",u.offsetLeft+u.clientWidth>t.firstElementChild.scrollLeft+t.firstElementChild.clientWidth&&(t.firstElementChild.scrollLeft=u.offsetLeft+u.clientWidth-t.firstElementChild.clientWidth)):u.textContent=" "}r.querySelectorAll("col")[l].insertAdjacentHTML(a,"<col>"),focusByWbr(t,i),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,o)},Si=(e,t,n,a)=>{if(n.parentElement.parentElement.tagName!=="THEAD"){const i=document.createElement("wbr");t.insertNode(i);const s=a.outerHTML;i.remove();const o=Ze(n),l=n.parentElement.parentElement;let r=l.previousElementSibling.lastElementChild;n.parentElement.previousElementSibling&&(r=n.parentElement.previousElementSibling),l.childElementCount===1?l.remove():n.parentElement.remove(),t.selectNodeContents(r.cells[o]),t.collapse(!0),focusByRange(t),On(a,r,e),updateTransaction(e,a.getAttribute("data-node-id"),a.outerHTML,s)}},xi=(e,t,n,a)=>{var i;const s=document.createElement("wbr");t.insertNode(s);const o=n.outerHTML;s.remove();const l=Ze(a),r=a.previousElementSibling||a.nextElementSibling;if(r)t.selectNodeContents(r),t.collapse(!0),r.offsetLeft+r.clientWidth>n.firstElementChild.scrollLeft+n.firstElementChild.clientWidth&&(n.firstElementChild.scrollLeft=r.offsetLeft+r.clientWidth-n.firstElementChild.clientWidth);else{n.classList.add("protyle-wysiwyg--select"),removeBlock(e,n,t,"remove");return}const d=n.querySelector("table");for(let c=0;c<d.rows.length;c++){const u=d.rows[c].cells;if(u.length===1){d.remove();break}u[l].remove()}(i=n.querySelectorAll("col")[l])==null||i.remove(),updateTransaction(e,n.getAttribute("data-node-id"),n.outerHTML,o),focusByRange(t)},Ti=(e,t,n,a)=>{const i=n.parentElement;if(i.parentElement.tagName==="THEAD")return;t.insertNode(document.createElement("wbr"));const s=a.outerHTML;if(i.previousElementSibling)i.after(i.previousElementSibling);else{const o=i.parentElement.previousElementSibling.firstElementChild;o.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.after(o),i.parentElement.previousElementSibling.append(i)}updateTransaction(e,a.getAttribute("data-node-id"),a.outerHTML,s),focusByWbr(a,t),scrollCenter(e,i)},Ii=(e,t,n,a)=>{const i=n.parentElement;if(i.parentElement.tagName==="TBODY"&&!i.nextElementSibling||i.parentElement.tagName==="THEAD"&&!i.parentElement.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const s=a.outerHTML;if(i.nextElementSibling)i.before(i.nextElementSibling);else{const o=i.parentElement.nextElementSibling.firstElementChild;o.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.after(o),i.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",i)}updateTransaction(e,a.getAttribute("data-node-id"),a.outerHTML,s),focusByWbr(a,t),scrollCenter(e,i)},Di=(e,t,n,a)=>{if(!n.previousElementSibling)return;t.insertNode(document.createElement("wbr"));const i=a.outerHTML;let s=0;Array.from(n.parentElement.children).find((l,r)=>{if(n.isSameNode(l))return s=r,!0}),a.querySelectorAll("tr").forEach(l=>{l.cells[s].after(l.cells[s-1])}),n.offsetLeft<a.firstElementChild.scrollLeft&&(a.firstElementChild.scrollLeft=n.offsetLeft);const o=a.querySelectorAll("col");o[s].after(o[s-1]),updateTransaction(e,a.getAttribute("data-node-id"),a.outerHTML,i),focusByWbr(a,t)},Mi=(e,t,n,a)=>{if(!n.nextElementSibling)return;t.insertNode(document.createElement("wbr"));const i=a.outerHTML;let s=0;Array.from(n.parentElement.children).find((l,r)=>{if(n.isSameNode(l))return s=r,!0}),a.querySelectorAll("tr").forEach(l=>{l.cells[s].before(l.cells[s+1])}),n.offsetLeft+n.clientWidth>a.firstElementChild.scrollLeft+a.firstElementChild.clientWidth&&(a.firstElementChild.scrollLeft=n.offsetLeft+n.clientWidth-a.firstElementChild.clientWidth);const o=a.querySelectorAll("col");o[s].before(o[s+1]),updateTransaction(e,a.getAttribute("data-node-id"),a.outerHTML,i),focusByWbr(a,t)},vr=(e,t,n)=>{var a,i;const s=hasClosestByMatchTag(n.startContainer,"TD")||hasClosestByMatchTag(n.startContainer,"TH"),o=hasClosestBlock(n.startContainer);if(!s||!o||o.classList.contains("protyle-wysiwyg--select"))return!1;if(t.key==="Enter"&&t.shiftKey&&isNotCtrl(t)&&!t.altKey){const E=document.createElement("wbr");n.insertNode(E);const _=o.outerHTML;if(E.remove(),s&&!s.innerHTML.endsWith("<br>")&&s.insertAdjacentHTML("beforeend","<br>"),n.extractContents(),e.toolbar.getCurrentType(n).includes("code")&&n.startContainer.nodeType!==3){const A=document.createElement("br");n.startContainer.after(A),n.setStartAfter(A)}else n.insertNode(document.createElement("br"));return n.collapse(!1),scrollCenter(e),updateTransaction(e,o.getAttribute("data-node-id"),o.outerHTML,_),t.preventDefault(),!0}if(isNotCtrl(t)&&!t.shiftKey&&!t.altKey&&t.key==="Enter"){t.preventDefault();const E=s.parentElement;if(!E.nextElementSibling&&E.parentElement.tagName==="TBODY"||E.parentElement.tagName==="THEAD"&&!E.parentElement.nextElementSibling)return insertEmptyBlock(e,"afterend",o.getAttribute("data-node-id")),!0;let _=E.nextElementSibling;return _||(_=E.parentElement.nextElementSibling.firstChild),_&&(n.selectNodeContents(_.cells[Ze(s)]),n.collapse(!0),scrollCenter(e)),!0}if(t.key==="ArrowRight"&&n.toString()===""&&!o.nextElementSibling&&s.isSameNode(o.querySelector("table").lastElementChild.lastElementChild.lastElementChild)&&getSelectionOffset(s,e.wysiwyg.element,n).start===s.textContent.length)return t.preventDefault(),insertEmptyBlock(e,"afterend",o.getAttribute("data-node-id")),!0;if(t.key==="Tab"&&isNotCtrl(t)){if(t.shiftKey)return xa(s,n),t.preventDefault(),!0;let E=s.nextElementSibling;return E||(s.parentElement.nextElementSibling?E=s.parentElement.nextElementSibling.firstElementChild:s.parentElement.parentElement.tagName==="THEAD"&&s.parentElement.parentElement.nextElementSibling?E=s.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:E=null),E?n.selectNodeContents(E):(Ta(e,n,s,o),n.selectNodeContents(o.querySelector("tbody").lastElementChild.firstElementChild)),t.preventDefault(),!0}if(t.key==="ArrowUp"&&isNotCtrl(t)&&!t.shiftKey&&!t.altKey){const E=n.startContainer;let _;for(E.nodeType!==3&&(E.tagName==="TH"||E.tagName==="TD")?_=E.childNodes[Math.min(n.startOffset,E.childNodes.length-1)]:E.parentElement.tagName==="SPAN"?_=E.parentElement.previousElementSibling:_=E.previousElementSibling;_;){if(_.tagName==="BR"&&hasPreviousSibling(_))return!1;_=_.previousElementSibling}const L=s.parentElement;let A=L.previousElementSibling;return A||(A=L.parentElement.previousElementSibling.lastElementChild),!A||(A==null?void 0:A.tagName)==="COL"?!1:(n.selectNodeContents(A.cells[Ze(s)]),n.collapse(!1),scrollCenter(e),t.preventDefault(),!0)}if(t.key==="ArrowDown"&&isNotCtrl(t)&&!t.shiftKey&&!t.altKey){const E=n.endContainer;let _;for(E.nodeType!==3&&(E.tagName==="TH"||E.tagName==="TD")?_=(a=E.childNodes[Math.max(0,n.endOffset-1)])==null?void 0:a.nextElementSibling:E.parentElement.tagName==="SPAN"?_=E.parentElement.nextElementSibling:_=E.nextElementSibling;_;){if(_.tagName==="BR"&&_.nextSibling)return!1;_=_.nextElementSibling}const L=s.parentElement;if(!L.nextElementSibling&&L.parentElement.tagName==="TBODY"||L.parentElement.tagName==="THEAD"&&!L.parentElement.nextElementSibling)return!1;let A=L.nextElementSibling;return A||(A=L.parentElement.nextElementSibling.firstChild),A?(n.selectNodeContents(A.cells[Ze(s)]),n.collapse(!0),scrollCenter(e),t.preventDefault(),!0):!1}if(isNotCtrl(t)&&!t.shiftKey&&!t.altKey&&t.key==="Backspace"&&getSelectionOffset(s,e.wysiwyg.element,n).start===0&&n.toString()===""&&(n.startOffset===0||n.startOffset===1&&s.querySelectorAll("br").length===1))return!xa(s,n,!1)&&o.previousElementSibling&&focusBlock(o.previousElementSibling,void 0,!1),scrollCenter(e),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignLeft.custom,t))return qn(e,[s],o,"left",n),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignCenter.custom,t))return qn(e,[s],o,"center",n),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.alignRight.custom,t))return qn(e,[s],o,"right",n),t.preventDefault(),!0;const l=o.querySelector("table"),r=s.parentElement.querySelector(".fn__none");let d=!1,c=!1;Array.from(s.parentElement.children).forEach(E=>{E.colSpan>1&&(d=!0),E.rowSpan>1&&(c=!0)});let u=!1,f=!1,g=!1,p=s.parentElement.previousElementSibling;!p&&s.parentElement.parentElement.tagName==="TBODY"&&(p=l.querySelector("thead").lastElementChild),p&&(u=p.querySelector(".fn__none"),Array.from(p.children).forEach(E=>{E.colSpan>1&&(f=!0),E.rowSpan>1&&(g=!0)}));let m=!1,y=!1,v=!1,b=s.parentElement.nextElementSibling;!b&&s.parentElement.parentElement.tagName==="THEAD"&&(b=(i=l.querySelector("tbody"))==null?void 0:i.firstElementChild),b&&(m=b.querySelector(".fn__none"),Array.from(b.children).forEach(E=>{E.colSpan>1&&(y=!0),E.rowSpan>1&&(v=!0)}));const w=Ze(s);let h=!0;Array.from(l.rows).find(E=>{const _=E.cells[w];if(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1)return h=!1,!0});let C=!0;Array.from(l.rows).find(E=>{const _=E.cells[w+1];if(_&&(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1))return C=!1,!0});let k=!0;if(Array.from(l.rows).find(E=>{const _=E.cells[w-1];if(_&&(_.classList.contains("fn__none")||_.colSpan>1||_.rowSpan>1))return k=!1,!0}),matchHotKey(window.siyuan.config.keymap.editor.table.moveToUp.custom,t))return(!r||r&&!c&&d)&&(!u||u&&!g&&f)&&Ti(e,n,s,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToDown.custom,t))return(!r||r&&!c&&d)&&(!m||m&&!v&&y)&&Ii(e,n,s,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToLeft.custom,t))return h&&k&&Di(e,n,s,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.moveToRight.custom,t))return h&&C&&Mi(e,n,s,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,t))return Li(e,n,s,o),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,t))return(!m||m&&!v&&y)&&Ta(e,n,s,o),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,t))return(h||k)&&Ia(e,o,s,"beforebegin",n),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,t))return(h||C)&&Ia(e,o,s,"afterend",n),t.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table["delete-row"].custom,t))return(!r&&!c||r&&!c&&d)&&Si(e,n,s,o),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.table["delete-column"].custom,t))return h&&xi(e,n,o,s),t.preventDefault(),!0};class Er{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(t){if(t.disabled||this.undoStack.length===0)return;const n=this.undoStack.pop();if(this.render(t,n,!1),this.hasUndo=!0,this.redoStack.push(n),t.breadcrumb){const a=t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');a&&(this.undoStack.length===0&&a.setAttribute("disabled","true"),t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').removeAttribute("disabled"))}}redo(t){if(t.disabled||this.redoStack.length===0)return;const n=this.redoStack.pop();if(this.render(t,n,!0),this.undoStack.push(n),t.breadcrumb){const a=t.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');a&&(t.breadcrumb.element.parentElement.querySelector('[data-type="undo"]').removeAttribute("disabled"),this.redoStack.length===0&&a.setAttribute("disabled","true"))}}render(t,n,a){hideElements(["hint","gutter"],t),t.wysiwyg.lastHTMLs={},a?(n.doOperations.forEach(i=>{onTransaction(t,i,!0)}),transaction(t,n.doOperations)):(n.undoOperations.forEach(i=>{onTransaction(t,i,!0)}),transaction(t,n.undoOperations)),preventScroll(t),scrollCenter(t)}replace(t,n){if(this.hasUndo&&this.redoStack.length>0&&(this.undoStack.push(this.redoStack.pop()),this.redoStack=[],this.hasUndo=!1,n.breadcrumb)){const a=n.breadcrumb.element.parentElement.querySelector('[data-type="redo"]');a&&a.setAttribute("disabled","true")}this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=t)}add(t,n,a){if(this.undoStack.push({undoOperations:n,doOperations:t}),this.undoStack.length>Constants.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1),a.breadcrumb){const i=a.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');i&&i.removeAttribute("disabled")}}clear(){this.undoStack=[],this.redoStack=[]}}const Fn=e=>!1,kr=(e,t,n)=>{var a,i,s,o,l,r,d,c,u;let f,g="",p=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(p.length===0){let y=getTopAloneElement(t);const v=hasClosestByAttribute(y,"fold","1");v&&(y=v),(a=y.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(y=getTopAloneElement(y.parentElement)),p=[y]}const m=p[0].getAttribute("data-type");if(m==="NodeListItem"&&!p[0].previousElementSibling&&((s=(i=p[0].parentElement.previousElementSibling)==null?void 0:i.previousElementSibling)!=null&&s.classList.contains("protyle-action")))if((o=p[0].parentElement.parentElement.previousElementSibling)!=null&&o.classList.contains("li")){if(f=p[0].parentElement.parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),g=p[0].parentElement.parentElement.parentElement.outerHTML,!f){const y=Lute.NewNodeID();p[0].parentElement.parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${p[0].getAttribute("data-subtype")}" data-node-id="${y}" data-type="NodeList" class="list" updated="${y.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),f=p[0].parentElement.parentElement.previousElementSibling.querySelector(".list")}}else return;if(m==="NodeList"&&((r=(l=p[0].previousElementSibling)==null?void 0:l.previousElementSibling)!=null&&r.classList.contains("protyle-action")))if((d=p[0].parentElement.previousElementSibling)!=null&&d.classList.contains("li")){if(f=p[0].parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),g=p[0].parentElement.parentElement.outerHTML,!f){const y=Lute.NewNodeID();p[0].parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${p[0].getAttribute("data-subtype")}" data-node-id="${y}" data-type="NodeList" class="list" updated="${y.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),f=p[0].parentElement.previousElementSibling.querySelector(".list")}}else return;if(f){f=f.lastElementChild.previousElementSibling;const y=p[0].classList.contains("list")?p[0]:p[0].parentElement;p.reverse().forEach(v=>{v.classList.contains("list")?f.after(v.firstElementChild):f.after(v)}),f.id==="moveTempLi"&&(f=f.nextElementSibling,f.previousElementSibling.remove()),y.childElementCount===1?y.remove():y.getAttribute("data-subtype")==="o"&&y.classList.contains("list")&&updateListOrder(y,1),f.getAttribute("data-subtype")==="o"&&updateListOrder(f.parentElement),updateTransaction(e,f.parentElement.parentElement.parentElement.getAttribute("data-node-id"),f.parentElement.parentElement.parentElement.outerHTML,g),preventScroll(e),scrollCenter(e),focusByWbr(f.parentElement,n);return}if(!(!p[0].previousElementSibling||(c=p[0].previousElementSibling)!=null&&c.classList.contains("protyle-action"))){if(f=p[0].previousElementSibling,p[0].getAttribute("data-subtype")==="o"&&m==="NodeListItem"){const y=p[0].parentElement.outerHTML;p[p.length-1].after(f),updateListOrder(p[0].parentElement,1),updateTransaction(e,p[0].parentElement.getAttribute("data-node-id"),p[0].parentElement.outerHTML,y)}else{const y=f.getAttribute("data-node-id");transaction(e,[{action:"move",id:y,previousID:p[p.length-1].getAttribute("data-node-id")}],[{action:"move",id:y,previousID:(u=f.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:f.parentElement.getAttribute("data-node-id")||e.block.parentID}]),p[p.length-1].after(f)}preventScroll(e),scrollCenter(e)}},Cr=(e,t,n)=>{var a,i,s,o,l,r,d;let c,u="",f=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(f.length===0){let p=getTopAloneElement(t);const m=hasClosestByAttribute(p,"fold","1");m&&(p=m),(a=p.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(p=getTopAloneElement(p.parentElement)),f=[p]}const g=f[0].getAttribute("data-type");if(g==="NodeListItem"&&f[f.length-1].nextElementSibling.classList.contains("protyle-attr")&&((i=f[0].parentElement.parentElement)!=null&&i.classList.contains("li")))if((s=f[0].parentElement.parentElement.nextElementSibling)!=null&&s.classList.contains("li")){if(c=f[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),u=f[0].parentElement.parentElement.parentElement.outerHTML,!c){const p=Lute.NewNodeID();f[0].parentElement.parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${f[0].getAttribute("data-subtype")}" data-node-id="${p}" data-type="NodeList" class="list" updated="${p.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),c=f[0].parentElement.parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(g==="NodeList"&&f[f.length-1].nextElementSibling.classList.contains("protyle-attr")&&((o=f[0].parentElement)!=null&&o.classList.contains("li")))if((l=f[0].parentElement.nextElementSibling)!=null&&l.classList.contains("li")){if(c=f[0].parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),u=f[0].parentElement.parentElement.outerHTML,!c){const p=Lute.NewNodeID();f[0].parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${f[0].getAttribute("data-subtype")}" data-node-id="${p}" data-type="NodeList" class="list" updated="${p.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),c=f[0].parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(c){const p=f[0].classList.contains("list")?f[0]:f[0].parentElement;f.forEach(m=>{m.classList.contains("list")?c.before(m.firstElementChild):c.before(m)}),p.childElementCount===1?p.remove():p.getAttribute("data-subtype")==="o"&&p.classList.contains("list")&&updateListOrder(p,1),c.getAttribute("data-subtype")==="o"&&updateListOrder(c.parentElement,1),updateTransaction(e,c.parentElement.parentElement.parentElement.getAttribute("data-node-id"),c.parentElement.parentElement.parentElement.outerHTML,u),preventScroll(e),scrollCenter(e),focusByWbr(c.parentElement,n);return}if(!(!f[f.length-1].nextElementSibling||(r=f[f.length-1].nextElementSibling)!=null&&r.classList.contains("protyle-attr"))){if(c=f[f.length-1].nextElementSibling,c.getAttribute("data-subtype")==="o"&&c.getAttribute("data-type")==="NodeListItem"){const p=c.parentElement.outerHTML;f[0].before(c),updateListOrder(c.parentElement,1),updateTransaction(e,c.parentElement.getAttribute("data-node-id"),c.parentElement.outerHTML,p)}else{const p=c.getAttribute("data-node-id");transaction(e,[{action:"move",id:p,previousID:(d=f[0].previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:c.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:p,previousID:f[f.length-1].getAttribute("data-node-id")}]),f[0].before(c)}preventScroll(e),scrollCenter(e)}},Ar=e=>{if(!e)return"";const t=pathPosix().extname(e).toLowerCase();return Constants.SIYUAN_ASSETS_IMAGE.includes(t)?`<img style="max-height: 100%" src="${e}">`:Constants.SIYUAN_ASSETS_AUDIO.includes(t)?`<audio style="max-width: 100%" controls="controls" src="${e}"></audio>`:Constants.SIYUAN_ASSETS_VIDEO.includes(t)?`<video style="max-width: 100%" controls="controls" src="${e}"></video>`:e},Lr=()=>{},Sr=(e,t,n,a)=>{let i="";if(Constants.SIYUAN_ASSETS_AUDIO.includes(e))i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeAudio" class="iframe" updated="${dayjs().format("YYYYMMDDHHmmss")}"><div class="iframe-content"><audio controls="controls" src="${t}" data-src="${t}"></audio>${Constants.ZWSP}</div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`;else if(Constants.SIYUAN_ASSETS_IMAGE.includes(e)){let s="";t.startsWith("assets/")||(s='<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>'),i=`<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg><use xlink:href="#iconMore"></use></svg></span></span><img src="${t}" data-src="${t}" alt="${n}" /><span class="protyle-action__drag"></span>${s}<span class="protyle-action__title"></span></span><span> </span></span>`}else Constants.SIYUAN_ASSETS_VIDEO.includes(e)?i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeVideo" class="iframe" updated="${dayjs().format("YYYYMMDDHHmmss")}"><div class="iframe-content">${Constants.ZWSP}<video controls="controls" src="${t}" data-src="${t}"></video><span class="protyle-action__drag" contenteditable="false"></span></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`:i=`<span data-type="a" data-href="${t}">${a}</span>`;return i},Ue=(e,t)=>e?`<span class="b3-menu__accelerator">${updateHotkeyTip(e)}</span>`:`<span class="b3-list-item__meta">${t}</span>`,xr=(e,t)=>{const n=[{filter:["\u6A21\u7248","moban","muban","mb","template"],id:"template",value:Constants.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:["\u6302\u4EF6","widget","gj","guajian"],id:"widget",value:Constants.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`},{filter:["\u8D44\u6E90","assets","zy","ziyuan"],id:"assets",value:Constants.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:["\u5757\u5F15\u7528","kuaiyinyong","kyy","block reference"],id:"ref",value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRef"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.ref}</span><span class="b3-list-item__meta">((</span></div>`},{filter:["\u5D4C\u5165\u5757","qianrukuai","qrk","embed block"],id:"blockEmbed",value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:["\u4EBA\u5DE5\u667A\u80FD","ai","rgzn"],id:"aiWriting",value:Constants.ZWSP+5,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.aiWriting}</span></div>`},{filter:["\u6570\u636E\u5E93","\u89C6\u56FE","shujuku","shitu","sjk","st","database","view","db"],id:"database",value:'<div data-type="NodeAttributeView" data-av-type="table"></div>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDatabase"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.database}</span></div>`},{filter:["\u65B0\u5EFA\u6587\u6863\u5E76\u5F15\u7528","xinjianwendangbingyinyong","xjwdbyy","new doc"],id:"newFileRef",value:Constants.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFileRef}</span></div>`},{filter:["\u65B0\u5EFA\u5B50\u6587\u6863\u5E76\u5F15\u7528","xinjianziwendangbingyinyong","xjzwdbyy","create sub doc"],id:"newSubDocRef",value:Constants.ZWSP+6,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newSubDocRef}</span></div>`},{value:"",id:"separator_1",html:"separator"},{filter:["yijibiaoti","\u4E00\u7EA7\u6807\u9898","yjbt","h1","heading"],id:"heading1",value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span>${Ue(window.siyuan.config.keymap.editor.heading.heading1.custom,"# ")}</div>`},{filter:["erjibiaoti","\u4E8C\u7EA7\u6807\u9898","ejbt","h2","heading"],id:"heading2",value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span>${Ue(window.siyuan.config.keymap.editor.heading.heading2.custom,"## ")}</div>`},{filter:["sanjibiaoti","\u4E09\u7EA7\u6807\u9898","sjbt","h3","heading"],id:"heading3",value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span>${Ue(window.siyuan.config.keymap.editor.heading.heading3.custom,"### ")}</div>`},{filter:["sijibiaoti","\u56DB\u7EA7\u6807\u9898","sjbt","h4","heading"],id:"heading4",value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span>${Ue(window.siyuan.config.keymap.editor.heading.heading4.custom,"#### ")}</div>`},{filter:["wujibiaoti","\u4E94\u7EA7\u6807\u9898","wjbt","h5","heading"],id:"heading5",value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span>${Ue(window.siyuan.config.keymap.editor.heading.heading5.custom,"##### ")}</div>`},{filter:["liujibiaoti","\u516D\u7EA7\u6807\u9898","ljbt","h6","heading"],id:"heading6",value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span>${Ue(window.siyuan.config.keymap.editor.heading.heading6.custom,"###### ")}</div>`},{filter:["\u65E0\u5E8F\u5217\u8868","wuxuliebiao","wxlb","unordered list"],id:"list",value:"* "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span>${Ue(window.siyuan.config.keymap.editor.insert.list.custom,"* ")}</div>`},{filter:["\u6709\u5E8F\u5217\u8868","youxuliebiao","yxlb","ordered list"],id:"orderedList",value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span>${Ue(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,"1. ")}</div>`},{filter:["\u4EFB\u52A1\u5217\u8868","renwuliebiao","rwlb","task list","todo list"],id:"check",value:"* [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span>${Ue(window.siyuan.config.keymap.editor.insert.check.custom,"[]")}</div>`},{filter:["\u5F15\u8FF0","yinshu","ys","bq","blockquote"],id:"quote",value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span>${Ue(window.siyuan.config.keymap.editor.insert.quote.custom,">")}</div>`},{filter:["\u4EE3\u7801\u5757","daimakuai","dmk","code block"],id:"code",value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span>${Ue(window.siyuan.config.keymap.editor.insert.code.custom,"```"+window.siyuan.languages.enterKey)}</div>`},{filter:["\u8868\u683C","biaoge","bg","table"],id:"table",value:`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:["\u5206\u5272\u7EBF","\u5206\u9694\u7EBF","fengexian","fgx","divider","thematic","break"],id:"line",value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-list-item__meta">---</span></div>`},{filter:["\u6570\u5B66\u516C\u5F0F\u5757","shuxuegongshikuai","sxgsk","math block"],id:"math",value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],id:"html",value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",id:"separator_2",html:"separator"},{filter:["\u8868\u60C5","biaoqing","bq","emoji"],id:"emoji",value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-list-item__meta">:</span></div>`},{filter:["\u94FE\u63A5","lianjie","lj","link","a"],id:"link",value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:["\u7C97\u4F53","cuti","ct","bold","strong"],id:"bold",value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:["\u659C\u4F53","xieti","xt","italic","em"],id:"italic",value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:["\u4E0B\u5212\u7EBF","xiahuaxian","xhx","underline"],id:"underline",value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:["\u5220\u9664\u7EBF","shanchuxian","scx","strike"],id:"strike",value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:["\u6807\u8BB0","biaoji","bj","mark"],id:"mark",value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:["\u4E0A\u6807","shangbiao","sb","superscript"],id:"sup",value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:["\u4E0B\u6807","xiaobiao","xb","subscript"],id:"sub",value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:["\u6807\u7B7E","biaoqian","bq","tag"],id:"tag",value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:["\u884C\u7EA7\u4EE3\u7801","hangjidaima","hjdm","\u884C\u5185\u4EE3\u7801","hangneidaima","hndm","inline code"],id:"inlineCode",value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:["\u884C\u7EA7\u516C\u5F0F","hangjigongshi","hjgs","\u884C\u7EA7\u6570\u5B66\u516C\u5F0F","hangjishuxuegongshi","hjsxgs","\u884C\u5185\u6570\u5B66\u516C\u5F0F","hangneishuxuegongshi","hnsxgs","inline math"],id:"inlineMath",value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator">${updateHotkeyTip(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",id:"separator_3",html:"separator"},{filter:["\u63D2\u5165\u56FE\u7247\u6216\u6587\u4EF6","upload","\u4E0A\u4F20","crtphwj","sc"],id:"insertAsset",value:Constants.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>
<input class="b3-form__upload" type="file" ${t.options.upload.accept?'multiple="'+t.options.upload.accept+'"':""}></div>`},{filter:["iframe","\u5D4C\u5165\u7F51\u5740","qianruwangzhan","qrwz"],id:"insertIframeURL",value:'<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:["\u63D2\u5165\u56FE\u7247\u94FE\u63A5","insert image link","charutupianlianjie","crtptp"],id:"insertImgURL",value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:["\u63D2\u5165\u89C6\u9891\u94FE\u63A5","charushipinlianjie","crsplj","insert video url"],id:"insertVideoURL",value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:["\u63D2\u5165\u97F3\u9891\u94FE\u63A5","charuyinpinlianjie","cryplj","insert audio url"],id:"insertAudioURL",value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",id:"separator_4",html:"separator"},{filter:["\u4E94\u7EBF\u8C31","wuxianpu","wxp","staff"],id:"staff",value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:["\u56FE\u8868","tubiao","tb","chart"],id:"chart",value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["\u6D41\u7A0B\u56FE","liuchengtu","lct","flow chart"],id:"flowChart",value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["\u72B6\u6001\u56FE","zhuangtaitu","ztt","graph viz"],id:"graph",value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["\u6D41\u7A0B\u56FE","\u65F6\u5E8F\u56FE","\u7518\u7279\u56FE","liuchengtu","shixutu","gantetu","lct","sxt","gtt","mermaid"],id:"mermaid",value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:["\u8111\u56FE","naotu","nt","mind map"],id:"mindmap",value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["\u7EDF\u4E00\u5EFA\u6A21\u8BED\u8A00","tongyijianmoyuyan","tyjmyy","plant uml"],id:"UML",value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",id:"separator_5",html:"separator"},{filter:["\u4FE1\u606F\u6837\u5F0F","xinxiyangshi","xxys","info style"],id:"infoStyle",value:`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:["\u6210\u529F\u6837\u5F0F","chenggongyangshi","cgys","success style"],id:"successStyle",value:`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:["\u8B66\u544A\u6837\u5F0F","jinggaoyangshi","jgys","warning style"],id:"warningStyle",value:`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:["\u9519\u8BEF\u6837\u5F0F","cuowuyangshi","cwys","error style"],id:"errorStyle",value:`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:["\u6E05\u9664\u6837\u5F0F","qingchuyangshi","qcys","remove style"],id:"clearFontStyle",value:`style${Constants.ZWSP}`,html:`<div class="b3-list-item__first"><div class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`},{value:"",id:"separator_6",html:"separator"}];let a=!1;return t.app.plugins.forEach(i=>{i.protyleSlash.forEach(s=>{n.push({filter:s.filter,value:`plugin${Constants.ZWSP}${i.name}${Constants.ZWSP}${s.id}`,html:s.html}),a=!0})}),a||n.pop(),e===""?n:n.filter(i=>i.filter?!!i.filter.find(o=>{if(o.indexOf(e.toLowerCase())>-1)return!0}):!1)},Tr=(e,t)=>(t.hint.genLoading(t),fetchPost("/api/search/searchTag",{k:e},n=>{const a=[];let i=!1;n.data.tags.forEach(s=>{const o=s.replace(/<mark>/g,"").replace(/<\/mark>/g,"");a.push({value:`<span data-type="tag">${o}</span>`,html:`<div class="b3-list-item__text">${s}</div>`}),o===n.data.k&&(i=!0)}),n.data.k&&!i&&(a.splice(0,0,{value:`<span data-type="tag">${n.data.k}</span>`,html:`<div class="b3-list-item__text">${window.siyuan.languages.new} <mark>${escapeHtml(n.data.k)}</mark></div>`}),a.length>1&&(a[1].focus=!0)),t.hint.genHTML(a,t,!0,"hint")}),[]),Da=e=>{let t;e.type==="NodeDocument"&&e.ial.icon?(t=Me(e.ial.icon,"b3-list-item__graphic popover__block",!0),t=t.replace('popover__block"',`popover__block" data-id="${e.id}"`)):t=`<svg class="b3-list-item__graphic popover__block" data-id="${e.id}"><use xlink:href="#${Sa(e.type)}"></use></svg>`;let n="";return e.name&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${e.name}</span></span><span class="fn__space"></span>`),e.alias&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${e.alias}</span></span><span class="fn__space"></span>`),e.memo&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${e.memo}</span></span>`),n&&(n=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${n}</div>`),`${n}<div class="b3-list-item__first">
    ${t}
    <span class="b3-list-item__text">${e.content}</span>
</div>
<div class="b3-list-item__meta b3-list-item__showall">${e.hPath}</div>`},$i=(e,t,n)=>{const a=R(ot(t.wysiwyg.element).startContainer);return t.hint.genLoading(t),Se("/api/search/searchRefBlock",{k:e,id:a?a.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:n==="av"?"":t.block.rootID,isDatabase:n==="av",isSquareBrackets:["[[","\u3010\u3010"].includes(t.hint.splitChar)},i=>{const s=[];if(i.data.newDoc){const o=Lute.UnEscapeHTMLStr(Rn(i.data.k));s.push({value:`((newFile "${o}"${x.ZWSP}'${o}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${i.data.k}</mark></span></div>`})}i.data.blocks.forEach(o=>{let l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="d">${o.name||o.refText.replace(new RegExp(x.ZWSP,"g"),"")}</span>`;n==="search"&&(l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="s">${e}${x.ZWSP}${o.name||o.refText.replace(new RegExp(x.ZWSP,"g"),"")}</span>`),s.push({value:l,html:Da(o)})}),n==="search"&&(t.hint.splitChar="((",t.hint.lastIndex=-1),s.length===0?s.push({value:"",html:window.siyuan.languages.emptyContent}):i.data.newDoc&&s.length>1&&(s[1].focus=!0),t.hint.genHTML(s,t,!0,n)}),[]},Ir=(e,t)=>{if(e.endsWith("}}")||e.endsWith("\u300D\u300D"))return[];t.hint.genLoading(t);const n=hasClosestBlock(getEditorRange(t.wysiwyg.element).startContainer);return fetchPost("/api/search/searchRefBlock",{k:e,isDatabase:!1,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),id:n?n.getAttribute("data-node-id"):t.block.parentID,rootID:t.block.rootID},a=>{const i=[];a.data.blocks.forEach(s=>{i.push({value:`{{select * from blocks where id='${s.id}'}}`,html:Da(s)})}),i.length===0&&i.push({value:"",html:window.siyuan.languages.emptyContent}),t.hint.genHTML(i,t,!0,"hint")}),[]},Dr=(e,t,n)=>{fetchPost("/api/template/render",{id:t.block.parentID,path:e},a=>{focusByRange(t.toolbar.range);const i=getContenteditableElement(n);i&&i.textContent.trim()===""?insertHTML(a.data.content,t,!0):insertHTML(a.data.content,t),t.wysiwyg.element.querySelectorAll('[status="temp"]').forEach(s=>{s.remove()}),blockRender(t,t.wysiwyg.element),processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element,t),hideElements(["util"],t)})},Mr=(e,t)=>{focusByRange(t.toolbar.range),insertHTML(t.lute.SpinBlockDOM(`<iframe src="/widgets/${e}/" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),t,!0),hideElements(["util"],t)},$r=(e,t)=>{focusByRange(t.toolbar.range);const n=pathPosix().extname(e).toLowerCase(),a=e.startsWith("assets/")?getAssetName(e):e;insertHTML(genAssetHTML(n,e,a,e.startsWith("assets/")?a+n:e),t),hideElements(["util"],t)},Hr=(e,t,n)=>{if(e==="/")return;const a=getDisplayName(e,!0,!0);if(n.block.rootID===a)return;const i=[];let s;const o=t[0].parentElement;let l;if(t.forEach((r,d)=>{d===t.length-1&&r.parentElement&&(s=getTopAloneElement(r),l=s.nextElementSibling||s.previousElementSibling,s.isSameNode(r)&&(s=void 0)),i.push({action:"append",id:r.getAttribute("data-node-id"),parentID:a}),r.remove()}),s)i.push({action:"delete",id:s.getAttribute("data-node-id")}),s.remove();else if(o.classList.contains("list")&&o.getAttribute("data-subtype")==="o"&&o.childElementCount>1)updateListOrder(o,1),Array.from(o.children).forEach(r=>{r.classList.contains("protyle-attr")||i.push({action:"update",id:r.getAttribute("data-node-id"),data:r.outerHTML})});else if(n.block.showAll&&o.classList.contains("protyle-wysiwyg")&&o.childElementCount===0)setTimeout(()=>{zoomOut({protyle:n,id:n.block.parent2ID,focusId:n.block.parent2ID})},Constants.TIMEOUT_INPUT*2+100);else if(o.classList.contains("protyle-wysiwyg")&&o.innerHTML===""&&!hasClosestByClassName(o,"block__edit",!0)&&n.block.id===n.block.rootID){const r=Lute.NewNodeID(),d=genEmptyElement(!1,!1,r);i.splice(0,0,{action:"insert",id:r,data:d.outerHTML,parentID:n.block.parentID}),o.innerHTML=d.outerHTML,focusBlock(d)}else l&&focusBlock(l);transaction(n,i)},Hi=e=>{let t="",n="";return window.siyuan.mobile.editor&&document.getElementById("empty").classList.contains("fn__none")&&(t=window.siyuan.mobile.editor.protyle.notebookId,e?n=window.siyuan.mobile.editor.protyle.path:n=pathPosix().dirname(window.siyuan.mobile.editor.protyle.path)),t||window.siyuan.notebooks.find(a=>{if(!a.closed)return t=a.id,n="/",!0}),{notebookId:t,currentPath:n}},Ni=e=>{if(getOpenNotebookCount()===0){showMessage(window.siyuan.languages.newFileTip);return}if(!e.notebookId){const t=Hi(e.useSavePath);e.notebookId=t.notebookId,e.currentPath=t.currentPath}fetchPost("/api/filetree/getDocCreateSavePath",{notebook:e.notebookId},t=>{if(e.useSavePath||(t.data.box=e.notebookId),t.data.path.indexOf("/")>-1&&e.useSavePath||e.name)if(t.data.path.startsWith("/")||e.currentPath==="/"){const n=pathPosix().join(t.data.path,e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));fetchPost("/api/filetree/createDocWithMd",{notebook:t.data.box,path:n,markdown:""},a=>{e.afterCB&&e.afterCB(a.data,pathPosix().basename(n)),openMobileFileById(e.app,a.data,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])})}else fetchPost("/api/filetree/getHPathByPath",{notebook:t.data.box,path:e.notebookId===t.data.box?e.currentPath.endsWith(".sy")?e.currentPath:e.currentPath+".sy":t.data.path||"/"},n=>{const a=pathPosix().join(n.data,t.data.path,e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));fetchPost("/api/filetree/createDocWithMd",{notebook:t.data.box,path:a,parentID:getDisplayName(e.currentPath,!0,!0),markdown:""},i=>{e.afterCB&&e.afterCB(i.data,pathPosix().basename(a)),openMobileFileById(e.app,i.data,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])})});else{const n=pathPosix().basename(t.data.path||window.siyuan.languages.untitled);if(!validateName(n))return;if(e.notebookId!==t.data.box){const s=pathPosix().join(t.data.path||"/",e.name||(t.data.path.endsWith("/")?window.siyuan.languages.untitled:""));fetchPost("/api/filetree/createDocWithMd",{notebook:t.data.box,path:s,markdown:""},o=>{e.afterCB&&e.afterCB(o.data,pathPosix().basename(s)),openMobileFileById(e.app,o.data,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])});return}const a=Lute.NewNodeID(),i=pathPosix().join(getDisplayName(e.currentPath,!1,!0),a+".sy");e.paths&&(e.paths[e.paths.indexOf(void 0)]=i),fetchPost("/api/filetree/createDoc",{notebook:t.data.box,path:i,title:n,md:"",sorts:e.paths},()=>{e.afterCB&&e.afterCB(a,n),openMobileFileById(e.app,a,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])})}})},Nr=(e,t,n)=>{fetchPost("/api/filetree/getRefCreateSavePath",{notebook:t},a=>{let i=e;t!==a.data.box&&(i=a.data.path||"/"),a.data.path?a.data.path.startsWith("/")?n(getDisplayName(a.data.path,!1,!0),a.data.box):fetchPost("/api/filetree/getHPathByPath",{notebook:a.data.box,path:i},s=>{n(getDisplayName(pathPosix().join(s.data,a.data.path),!1,!0),a.data.box)}):fetchPost("/api/filetree/getHPathByPath",{notebook:a.data.box,path:i},s=>{n(getDisplayName(s.data,!1,!0),a.data.box)})})},Br=(e,t)=>{hideElements(["dialog"]),Ni({app:e,useSavePath:!0,name:replaceFileName(t.trim())||window.siyuan.languages.untitled})},Pr=(e,t,n,a,i)=>{const s=replaceFileName(t.trim()?t.trim():e.lute.BlockDOM2Content(n.outerHTML).replace(/\n/g,""))||window.siyuan.languages.untitled,o=pathPosix().join(a,s);fetchPost("/api/filetree/getIDsByHPath",{path:o,notebook:i},l=>{const r=escapeHtml(s.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen));l.data&&l.data.length>0?e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${l.data[0]}${Constants.ZWSP}d${Constants.ZWSP}${r}`}):fetchPost("/api/filetree/createDocWithMd",{notebook:i,path:o,parentID:e.notebookId===i?e.block.rootID:"",markdown:""},d=>{e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${d.data}${Constants.ZWSP}d${Constants.ZWSP}${r}`})}),hideElements(["toolbar"],e)})},Yn=(e,t,n)=>{t&&(setLastNodeRange(getContenteditableElement(n[n.length-1]),e.toolbar.range),e.toolbar.range.collapse(!0),insertHTML(t,e,!0,!0),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element))},Bi=(e,t)=>{const n=new Dialog({title:window.siyuan.languages.update,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--error">${window.siyuan.languages.delete}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});n.element.setAttribute("data-key",Constants.DIALOG_AIUPDATECUSTOMACTION);const a=n.element.querySelector("input");a.value=e;const i=n.element.querySelector("textarea"),s=n.element.querySelectorAll(".b3-button");n.bindInput(i,()=>{s[2].click()}),i.value=t,s[1].addEventListener("click",()=>{n.destroy()}),s[2].addEventListener("click",()=>{window.siyuan.storage[Constants.LOCAL_AI].find(o=>{if(e===o.name&&t===o.memo)return o.name=a.value,o.memo=i.value,setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),!0}),n.destroy()}),s[0].addEventListener("click",()=>{window.siyuan.storage[Constants.LOCAL_AI].find((o,l)=>{if(e===o.name&&t===o.memo)return window.siyuan.storage[Constants.LOCAL_AI].splice(l,1),setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),!0}),n.destroy()}),a.focus()},Ma=(e,t,n)=>{const a=new Dialog({title:window.siyuan.languages.aiCustomAction,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.use}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.save}</button>
</div>`,width:isMobile()?"92vw":"520px"});a.element.setAttribute("data-key",Constants.DIALOG_AICUSTOMACTION);const i=a.element.querySelector("input"),s=a.element.querySelector("textarea"),o=a.element.querySelectorAll(".b3-button");a.bindInput(s,()=>{o[1].click()}),o[0].addEventListener("click",()=>{a.destroy()}),o[1].addEventListener("click",()=>{if(!s.value){showMessage(window.siyuan.languages._kernel[142]);return}fetchPost("/api/ai/chatGPTWithAction",{ids:t,action:s.value},l=>{a.destroy(),Yn(e,l.data,n)})}),o[2].addEventListener("click",()=>{if(!i.value&&!s.value){showMessage(window.siyuan.languages._kernel[142]);return}window.siyuan.storage[Constants.LOCAL_AI].push({name:i.value,memo:s.value}),setStorageVal(Constants.LOCAL_AI,window.siyuan.storage[Constants.LOCAL_AI]),a.destroy()}),i.focus()},$a=(e,t)=>{e.querySelectorAll(".b3-list-item").forEach(n=>{n.textContent.indexOf(t.value)>-1?n.classList.remove("fn__none"):n.classList.add("fn__none")}),e.querySelectorAll(".b3-menu__separator").forEach(n=>{t.value?n.classList.add("fn__none"):n.classList.remove("fn__none")}),e.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),e.querySelector(".b3-list-item:not(.fn__none)").classList.add("b3-list-item--focus")},Rr=(e,t)=>{window.siyuan.menus.menu.remove();const n=[];e.forEach(o=>{n.push(o.getAttribute("data-node-id"))});const a=new Menu("ai",()=>{focusByRange(t.toolbar.range)});let i="";window.siyuan.storage[Constants.LOCAL_AI].forEach((o,l)=>{i+=`<div data-action="${escapeAttr(o.memo||o.name)}" data-index="${l}" class="b3-list-item b3-list-item--narrow ariaLabel" aria-label="${escapeAriaLabel(o.memo)}">
    <span class="b3-list-item__text">${escapeHtml(o.name)}</span>
    <span data-type="edit" class="b3-list-item__action"><svg><use xlink:href="#iconEdit"></use></svg></span>
</div>`}),i&&(i=`<div class="b3-menu__separator"></div>${i}`);const s="Clear context";a.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.ai}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
       <div class="b3-list-item b3-list-item--narrow b3-list-item--focus" data-action="Continue writing">
            ${window.siyuan.languages.aiContinueWrite}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiExtractSummary}">
            ${window.siyuan.languages.aiExtractSummary}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiBrainStorm}">
            ${window.siyuan.languages.aiBrainStorm}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${window.siyuan.languages.aiFixGrammarSpell}">
            ${window.siyuan.languages.aiFixGrammarSpell}
        </div>
        <div class="b3-list-item b3-list-item--narrow" data-action="${s}">
            ${window.siyuan.languages.clearContext}
        </div>
        <div class="b3-menu__separator"></div>
        <div class="b3-list-item b3-list-item--narrow" data-type="custom">
            ${window.siyuan.languages.aiCustomAction}
        </div>
        ${i}
    </div>
</div>`,bind(o){o.setAttribute("style","height: 100%;padding: 0 16px;"),o.querySelectorAll(".b3-menu__separator").forEach(d=>{d.remove()});const l=o.querySelector(".b3-list"),r=o.querySelector("input");r.addEventListener("keydown",d=>{if(d.isComposing)return;if(upDownHint(l,d)&&d.stopPropagation(),d.key==="Enter"){d.preventDefault(),d.stopPropagation();const u=l.querySelector(".b3-list-item--focus");u.dataset.type==="custom"?(Ma(t,n,e),a.close()):(fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:u.dataset.action},f=>{Yn(t,f.data,e)}),u.dataset.action===s?showMessage(window.siyuan.languages.clearContextSucc):a.close())}}),r.addEventListener("compositionend",()=>{$a(o,r)}),r.addEventListener("input",d=>{d.isComposing||$a(o,r)}),o.addEventListener("click",d=>{let c=d.target;for(;c&&!c.isSameNode(o);){if(c.classList.contains("b3-list-item__action")){const u=window.siyuan.storage[Constants.LOCAL_AI][c.parentElement.dataset.index];Bi(u.name,u.memo),a.close(),d.stopPropagation(),d.preventDefault();break}else if(c.classList.contains("b3-list-item")){c.dataset.type==="custom"?(Ma(t,n,e),a.close()):(fetchPost("/api/ai/chatGPTWithAction",{ids:n,action:c.dataset.action},u=>{Yn(t,u.data,e)}),c.dataset.action===s?showMessage(window.siyuan.languages.clearContextSucc):a.close()),d.stopPropagation(),d.preventDefault();break}c=c.parentElement}})}}),a.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial"),a.fullscreen()},Or=(e,t)=>{const n=new Dialog({title:"\u2728 "+window.siyuan.languages.aiWriting,content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),a=n.element.querySelector("textarea"),i=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{i[1].click()}),a.focus(),i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{let s=a.value;fetchPost("/api/ai/chatGPT",{msg:s},o=>{n.destroy();let l="";o.data&&o.data!==""&&(l=`

`+o.data),s==="Clear context"&&(s=""),fillContent(e,`${s}${l}`,[t])})})};class qr{constructor(t){this.enableSlash=!0,this.enableEmoji=!0,this.enableExtend=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.setAttribute("style",`width:${Math.max(t.element.clientWidth/2,320)}px;`),this.element.className="protyle-hint b3-list b3-list--background fn__none",this.element.addEventListener("click",n=>{var a;const i=n.target;if(i.tagName==="INPUT"){n.stopPropagation();return}const s=hasClosestByMatchTag(i,"BUTTON");if(s&&!s.classList.contains("emojis__item")&&!s.classList.contains("emojis__type")){this.fill(decodeURIComponent(s.getAttribute("data-value")),t,!1,this.source==="search"?isNotCtrl(n):isOnlyMeta(n)),n.preventDefault(),n.stopPropagation();return}const o=this.element.querySelector(".emojis__panel"),l=hasClosestByClassName(i,"emojis__type");if(l){const d=o.querySelector(`[data-type="${l.getAttribute("data-type")}"]`);if(d){const c=d.nextElementSibling.getAttribute("data-index");if(c){let u="";window.siyuan.emojis[parseInt(c)].items.forEach(f=>{u+=`<button data-unicode="${f.unicode}" class="emojis__item ariaLabel" aria-label="${getEmojiDesc(f)}">
${unicode2Emoji(f.unicode)}</button>`}),d.nextElementSibling.innerHTML=u,d.nextElementSibling.removeAttribute("data-index")}o.scrollTo({top:d.offsetTop})}return}const r=hasClosestByClassName(i,"emojis__item");if(r){const d=r.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const c=getSelection().getRangeAt(0);c.endContainer.nodeType!==3?(a=c.endContainer.childNodes[c.endOffset-1])==null||a.remove():c.endContainer.textContent===":"&&(c.endContainer.textContent=""),addEmoji(d);let u;d.indexOf(".")>-1?u=`:${d.split(".")[0]}: `:u=unicode2Emoji(d)+" ",insertHTML(t.lute.SpinBlockDOM(u),t,!1,!0),this.element.classList.add("fn__none")}else this.fill(d,t)}})}render(t){if(!window.getSelection().focusNode){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(!this.enableExtend){clearTimeout(this.timeId);return}if(t.toolbar.range=getSelection().getRangeAt(0),t.toolbar.range.startContainer.nodeType===3&&t.toolbar.range.startContainer.textContent===""){const s=hasPreviousSibling(t.toolbar.range.startContainer);if(s&&s.nodeType===3){if(s.wholeText!==s.textContent){let o=s.previousSibling;for(;o&&o.nodeType===3;)if(o.textContent==="")o=o.previousSibling,o.nextSibling.remove();else{s.textContent=o.textContent+s.textContent,o.remove();break}}t.toolbar.range.setStart(s,s.textContent.length),t.toolbar.range.collapse(!0)}}const n=getSelectionOffset(t.toolbar.range.startContainer,t.wysiwyg.element).start,a=t.toolbar.range.startContainer.textContent.substring(0,n)||"",i=this.getKey(a,t.options.hint.extend);if(typeof i=="undefined"||hasClosestByAttribute(t.toolbar.range.startContainer,"data-type","code")||hasClosestByAttribute(t.toolbar.range.startContainer,"data-type","NodeCodeBlock")){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(this.splitChar==="#"){const s=hasClosestBlock(t.toolbar.range.startContainer);if(s&&s.getAttribute("data-type")==="NodeHeading"){const o=getSelectionOffset(t.toolbar.range.startContainer,s).start;if(s.textContent.startsWith("#".repeat(o))){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}}}if(this.splitChar===":"){clearTimeout(this.timeId),i?this.genEmojiHTML(t,i):this.element.classList.add("fn__none");return}if(this.splitChar==="/"||this.splitChar==="\u3001"){clearTimeout(this.timeId),this.enableSlash&&!isMobile()&&this.genHTML(hintSlash(i,t),t,!1,"hint");return}t.options.hint.extend.forEach(s=>{s.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout(()=>{this.genHTML(s.hint(i,t,"hint"),t,!1,"hint")},t.options.hint.delay))})}genLoading(t){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const n=getSelectionPosition(t.wysiwyg.element);setPosition(this.element,n.left,n.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}bindUploadEvent(t,n){n.querySelectorAll('input[type="file"]').forEach(a=>{a.addEventListener("change",i=>{if(i.target.files.length===0)return;const s=getEditorRange(t.wysiwyg.element);this.lastIndex>-1&&s.setStart(s.startContainer,this.lastIndex),s.deleteContents(),uploadFiles(t,i.target.files,i.target),hideElements(["hint","toolbar"],t)})})}getHTMLByData(t){let n='<div style="flex: 1;overflow:auto;">';return this.source!=="hint"&&(n='<input style="margin:0 8px 4px 8px" class="b3-text-field"><div style="flex: 1;overflow:auto;">'),t.forEach((a,i)=>{let s="";(i===1&&t[i].focus||i===0&&(t.length===1||!t[1].focus))&&(s=" b3-list-item--focus"),a.html==="separator"?n+=`<button data-id="${a.id||""}" class="b3-menu__separator"></button>`:n+=`<button data-id="${a.id||""}" style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${s}" data-value="${encodeURIComponent(a.value)}">${a.html}</button>`}),`${n}</div>`}genHTML(t,n,a=!1,i){var s;if(this.source=i,t.length===0){(!this.element.querySelector(".fn__loading")||a)&&this.element.classList.add("fn__none");return}if(this.element.innerHTML=this.getHTMLByData(t),this.element.classList.remove("fn__none"),t[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.element.style.width=Math.max(n.element.clientWidth/2,320)+"px",this.source==="av"){const o=hasClosestByClassName(n.toolbar.range.startContainer,"av__cell");if(o){const l=o.getBoundingClientRect();setPosition(this.element,l.left,l.bottom,l.height)}}else{const o=getSelectionPosition(n.wysiwyg.element);setPosition(this.element,o.left,o.top+26,30)}if(this.element.scrollTop=0,this.bindUploadEvent(n,this.element),this.source!=="hint"){const o=this.element.querySelector("input.b3-text-field"),l=((s=this.element.querySelector("mark"))==null?void 0:s.textContent)||"";o.value=l,o.select(),o.addEventListener("keydown",d=>{d.key!=="Meta"&&d.key!=="Control"&&d.stopPropagation(),!d.isComposing&&(upDownHint(this.element.lastElementChild,d),d.key==="Enter"?(this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),n,!1,isNotCtrl(d)),d.preventDefault()):d.key==="Escape"&&(this.element.classList.add("fn__none"),focusByRange(n.toolbar.range)))});const r=n.toolbar.range?hasClosestBlock(n.toolbar.range.startContainer):!1;o.addEventListener("input",d=>{d.isComposing||(d.stopPropagation(),this.genSearchHTML(n,o,r,l,i))}),o.addEventListener("compositionend",d=>{d.stopPropagation(),this.genSearchHTML(n,o,r,l,i)})}}genSearchHTML(t,n,a,i,s){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',fetchPost("/api/search/searchRefBlock",{k:n.value,id:a?a.getAttribute("data-node-id"):t.block.parentID,beforeLen:Math.floor((Math.max(t.element.clientWidth/2,320)-58)/28.8),rootID:s==="av"?"":t.block.rootID,isDatabase:s==="av"},o=>{let l="";if(o.data.newDoc){const r=`((newFile "${i}"${Constants.ZWSP}'${o.data.k}${Lute.Caret}'))`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${o.data.blocks.length===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(r)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${o.data.k}</mark></span></div></button>`}o.data.blocks.forEach((r,d)=>{let c;s==="av"?c=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${r.name||r.refText.replace(new RegExp(Constants.ZWSP,"g"),"")}</span>`:c=`<span data-type="block-ref" data-id="${r.id}" data-subtype="s">${i}</span>`,l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${d===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(c)}">
${genHintItemHTML(r)}
</button>`}),l===""&&(l=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=l,setPosition(this.element,parseInt(this.element.style.left),parseInt(this.element.style.right))})}genEmojiHTML(t,n=""){if(n&&!this.enableEmoji)return;const a=this.element.querySelector(".emojis__panel");a?(a.innerHTML=filterEmoji(n,256),n?a.nextElementSibling.classList.add("fn__none"):a.nextElementSibling.classList.remove("fn__none"),lazyLoadEmojiImg(a)):(this.element.innerHTML=`<div style="padding: 0;max-height:402px" class="emojis">
<div class="emojis__panel">${filterEmoji(n,256)}</div>
<div class="fn__flex${n?" fn__none":""}">
    ${[["2b50",window.siyuan.languages.recentEmoji],["1f527",getEmojiTitle(0)],["1f60d",getEmojiTitle(1)],["1f433",getEmojiTitle(2)],["1f96a",getEmojiTitle(3)],["1f3a8",getEmojiTitle(4)],["1f3dd-fe0f",getEmojiTitle(5)],["1f52e",getEmojiTitle(6)],["267e-fe0f",getEmojiTitle(7)],["1f6a9",getEmojiTitle(8)]].map(([s,o],l)=>`<button data-type="${l}" class="emojis__type ariaLabel" aria-label="${o}">${unicode2Emoji(s)}</button>`).join("")}
</div>
</div>`,lazyLoadEmoji(this.element),lazyLoadEmojiImg(this.element));const i=this.element.querySelector(".emojis__item");if(i){i.classList.add("emojis__item--current"),this.element.classList.remove("fn__none"),this.element.style.width=Math.max(t.element.clientWidth/2,320)+"px";const s=getSelectionPosition(t.wysiwyg.element);setPosition(this.element,s.left,s.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(t,n,a=!0,i=!1){var s;hideElements(["hint","toolbar"],n),a&&this.source!=="av"&&(n.toolbar.range=getEditorRange(n.wysiwyg.element));const o=n.toolbar.range;let l=hasClosestBlock(n.toolbar.range.startContainer);if(!l)return;if(this.source==="av"){let u=hasClosestByClassName(n.toolbar.range.startContainer,"av__cell");if(u||(u=l.querySelector(".av__cell--select")),!u)return;const f=hasClosestByClassName(u,"av__row");if(!f)return;const g=u.dataset.blockId,p=l.getAttribute("data-av-id");let m=document.createElement("div");if(m.innerHTML=t.replace(/<mark>/g,"").replace(/<\/mark>/g,""),m=m.firstElementChild,t.startsWith("((newFile ")&&t.endsWith(`${Lute.Caret}'))`)){const y=t.substring(11,t.length-4).split(`"${Constants.ZWSP}'`),v=y.length===1?y[0]:y[1],b=Lute.NewNodeID();f.dataset.id=b,getSavePath(n.path,n.notebookId,(w,h)=>{fetchPost("/api/filetree/createDocWithMd",{notebook:h,path:pathPosix().join(w,v),parentID:n.notebookId===h?n.block.rootID:"",markdown:"",id:b},()=>{transaction(n,[{action:"replaceAttrViewBlock",avID:p,previousID:g,nextID:b,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:p,previousID:b,nextID:g,isDetached:!0}])})}),updateAttrViewCellAnimation(u,{type:"block",isDetached:!1,block:{content:v,id:b}})}else{const y=m.getAttribute("data-id");f.dataset.id=y,transaction(n,[{action:"replaceAttrViewBlock",avID:p,previousID:g,nextID:y,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:p,previousID:y,nextID:g,isDetached:!0}]),updateAttrViewCellAnimation(u,{type:"block",isDetached:!1,block:{content:m.textContent,id:y}})}return}this.enableExtend=!1;let r="";l&&(r=l.getAttribute("data-node-id"));const d=l.outerHTML,c=Constants.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&c&&o.startContainer.nodeType===3&&o.startContainer.wholeText.indexOf(c)>-1&&o.startContainer.wholeText.indexOf(this.splitChar)>-1){let u=0,f=o.startContainer;for(;f&&u<2;){const g=f.textContent.indexOf(c),p=f.textContent.indexOf(this.splitChar);if(g>-1&&(g<p||p<0)){u=2,o.setEnd(f,g+2);break}const m=f.textContent.indexOf(c.substr(1));if(m>-1&&(u+=1),u===2){o.setEnd(f,m+1);break}f=f.nextSibling}}if(this.lastIndex>-1&&(o.setStart(o.startContainer,this.lastIndex),isIPhone()&&focusByRange(o)),Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&t.startsWith("((newFile ")&&t.endsWith(`${Lute.Caret}'))`)){const u=t.substring(11,t.length-4).split(`"${Constants.ZWSP}'`),f=u.length===1?u[0]:u[1];getSavePath(n.path,n.notebookId,(g,p)=>{fetchPost("/api/filetree/createDocWithMd",{notebook:p,path:pathPosix().join(g,f),parentID:n.notebookId===p?n.block.rootID:"",markdown:""},m=>{n.toolbar.range=o,n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${m.data}${Constants.ZWSP}${i?"s":"d"}${Constants.ZWSP}${(i?u[0]:f).substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen)}`})})});return}if(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)){if(t===""){const f=getContenteditableElement(l);f.textContent===""&&(f.innerHTML="<wbr>",focusByWbr(f,o));return}let u=document.createElement("div");if(u.innerHTML=t.replace(/<mark>/g,"").replace(/<\/mark>/g,""),u=u.firstElementChild,i){const f=o.toString().replace(this.splitChar,"");f&&(u.setAttribute("data-subtype","s"),u.innerText=f)}else{u.setAttribute("data-subtype","d");const f=u.innerText.split(Constants.ZWSP);f.length===2&&(u.innerText=f[1])}n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${u.getAttribute("data-id")}${Constants.ZWSP}${u.getAttribute("data-subtype")}${Constants.ZWSP}${u.textContent}`});return}else if(this.splitChar===":"){addEmoji(t);let u;t.indexOf(".")>-1?u=`:${t.split(".")[0]}: `:u=unicode2Emoji(t)+" ",insertHTML(n.lute.SpinBlockDOM(u),n)}else if(["\u300C\u300C","\u300C\u300E","\u300E\u300C","\u300E\u300E","{{"].includes(this.splitChar)||this.splitChar==="#"||this.splitChar===":"){if(t===""){const u=getContenteditableElement(l);u.textContent===""&&(u.innerHTML="<wbr>",focusByWbr(u,o));return}insertHTML(n.lute.SpinBlockDOM(t),n,!1,isMobile()),blockRender(n,n.wysiwyg.element);return}else if(this.splitChar==="/"||this.splitChar==="\u3001")if(this.enableExtend=!0,t==="(("||t==="{{"){t==="(("?hintRef("",n,"hint"):hintEmbed("",n),this.splitChar=t,this.lastIndex=0,o.deleteContents();const u=document.createTextNode(t);o.insertNode(u),o.setEnd(u,t.length),o.collapse(!1),focusByRange(o);return}else if(t===Constants.ZWSP){o.deleteContents(),this.fixImageCursor(o),n.toolbar.showTpl(n,l,o),updateTransaction(n,r,l.outerHTML,d);return}else if(t===Constants.ZWSP+1){o.deleteContents(),this.fixImageCursor(o),n.toolbar.showWidget(n,l,o),updateTransaction(n,r,l.outerHTML,d);return}else if(t===Constants.ZWSP+2){o.deleteContents(),this.fixImageCursor(o),n.toolbar.range=o;const u=getSelectionPosition(l,o);assetMenu(n,{x:u.left,y:u.top+26,w:0,h:26}),updateTransaction(n,r,l.outerHTML,d);return}else if(t===Constants.ZWSP+3){o.deleteContents();return}else if(t===Constants.ZWSP+4){newFile({app:n.app,notebookId:n.notebookId,useSavePath:!0,currentPath:n.path,afterCB:(u,f)=>{insertHTML(`<span data-type="block-ref" data-id="${u}" data-subtype="d">${f}</span>`,n)}});return}else if(t===Constants.ZWSP+6){const u=Lute.NewNodeID();fetchPost("/api/filetree/createDoc",{notebook:n.notebookId,path:pathPosix().join(getDisplayName(n.path,!1,!0),u+".sy"),title:window.siyuan.languages.untitled,md:""},()=>{insertHTML(`<span data-type="block-ref" data-id="${u}" data-subtype="d">${window.siyuan.languages.untitled}</span>`,n),openMobileFileById(n.app,u,[Constants.CB_GET_CONTEXT,Constants.CB_GET_OPENNEW])});return}else if(t===Constants.ZWSP+5){o.deleteContents(),AIChat(n,l);return}else if(Constants.INLINE_TYPE.includes(t)){if(o.deleteContents(),focusByRange(o),["a","block-ref","inline-math","inline-memo","text"].includes(t)){n.toolbar.element.querySelector(`[data-type="${t}"]`).dispatchEvent(new CustomEvent("click"));return}n.toolbar.setInlineMark(n,t,"range");return}else if(t==="emoji"){o.deleteContents(),o.insertNode(document.createTextNode(":")),o.collapse(!1),focusByRange(o),this.genEmojiHTML(n);return}else if(t.indexOf("style")>-1){o.deleteContents(),this.fixImageCursor(o),l.setAttribute("style",t.split(Constants.ZWSP)[1]||""),updateTransaction(n,r,l.outerHTML,d);return}else if(t.startsWith("plugin")){n.app.plugins.find(u=>{const f=t.split(Constants.ZWSP);if(f[1]===u.name)return u.protyleSlash.find(g=>{if(g.id===f[2])return g.callback(n.getInstance()),!0}),!0});return}else{o.deleteContents(),t!=="![]()"&&this.fixImageCursor(o);let u=t;t==="```"&&(u=t+(Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(window.siyuan.storage[Constants.LOCAL_CODELANG])?"":window.siyuan.storage[Constants.LOCAL_CODELANG])+Lute.Caret+"\n```");const f=getContenteditableElement(l);if(t==="![]()"){let g="";o.insertNode(document.createElement("wbr")),o.insertNode(document.createTextNode(t)),g=n.lute.SpinBlockDOM(l.outerHTML),l.outerHTML=g,l=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),focusByWbr(l,o),updateTransaction(n,r,l.outerHTML,d);let p=o.startContainer.childNodes[o.startOffset-1]||o.startContainer;p&&p.nodeType!==3&&p.classList.contains("img")||(((s=p.previousSibling)==null?void 0:s.nodeType)!==3&&p.previousSibling.classList.contains("img")?p=p.previousSibling:Array.from(l.querySelectorAll(".img")).find(y=>{if(y.querySelector("img").getAttribute("data-src")==="")return p=y,!0}));const m=p.getBoundingClientRect();imgMenu(n,o,p,{clientX:m.left,clientY:m.top});return}else if(f.textContent===""&&l.getAttribute("data-type")==="NodeParagraph"){let g="";t==="<div>"?g=`<div data-node-id="${r}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${genIconHTML()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(f.textContent=u,g=n.lute.SpinBlockDOM(l.outerHTML)),l.outerHTML=g,l=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),l.getAttribute("data-type")==="NodeTable"&&(l.querySelectorAll("colgroup col").forEach(p=>{p.style.minWidth="60px"}),g=l.outerHTML),updateTransaction(n,r,g,d)}else{let g=n.lute.SpinBlockDOM(u);t==="<div>"&&(g=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${genIconHTML()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`),l.insertAdjacentHTML("afterend",g);const p=l.outerHTML,m=g.substr(g.indexOf('data-node-id="')+14,22);l=n.wysiwyg.element.querySelector(`[data-node-id="${m}"]`),l.getAttribute("data-type")==="NodeTable"&&l.querySelectorAll("colgroup col").forEach(y=>{y.style.minWidth="60px"}),transaction(n,[{data:p,id:r,action:"update"},{data:l.outerHTML,id:m,previousID:r,action:"insert"}],[{id:m,action:"delete"},{data:d,id:r,action:"update"}])}if(t==="<div>"||t==="$$"||t.indexOf("```")>-1&&(t.length>3||l.classList.contains("render-node")))n.toolbar.showRender(n,l),processRender(l);else if(t.startsWith("```"))highlightRender(l);else if(t.startsWith("<iframe")||t.startsWith("<video")||t.startsWith("<audio")){n.gutter.renderMenu(n,l);const g=l.getBoundingClientRect();window.siyuan.menus.menu.popup({x:g.left,y:g.top,isLeft:!0});const p=window.siyuan.menus.menu.element.querySelector('[data-id="assetVideo"], [data-id="assetAudio"], [data-id="assetIFrame"]');p.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(p.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelector("textarea").focus()}else t==="---"?focusBlock(l):l.classList.contains("av")?avRender(l,n,()=>{l.querySelector(".av__title").focus()}):focusByWbr(l,o)}}select(t,n){var a,i,s,o,l;const r=this.element.firstElementChild.classList.contains("emojis");if(this.element.querySelectorAll("button").length===0&&!r)return!1;if(t.key==="Enter"){if(r){const d=this.element.querySelector(".emojis__item--current");if(!d)return!1;const c=d.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const u=getSelection().getRangeAt(0);u.endContainer.nodeType!==3&&((a=u.endContainer.childNodes[u.endOffset-1])==null||a.remove()),addEmoji(c);let f;c.indexOf(".")>-1?f=`:${c.split(".")[0]}: `:f=unicode2Emoji(c)+" ",insertHTML(n.lute.SpinBlockDOM(f),n),this.element.classList.add("fn__none")}else this.fill(c,n)}else{const d=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));d===Constants.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(d,n,!0,isOnlyMeta(t))}return t.preventDefault(),t.stopPropagation(),!0}if(r){const d=this.element.querySelector(".emojis__item--current");if(!d)return!1;let c;if(t.key==="ArrowLeft")d.previousElementSibling?(d.classList.remove("emojis__item--current"),c=d.previousElementSibling):(i=d.parentElement.previousElementSibling)!=null&&i.previousElementSibling&&(d.classList.remove("emojis__item--current"),c=d.parentElement.previousElementSibling.previousElementSibling.lastElementChild);else if(t.key==="ArrowRight")d.nextElementSibling?(d.classList.remove("emojis__item--current"),c=d.nextElementSibling):(s=d.parentElement.nextElementSibling)!=null&&s.nextElementSibling&&(d.classList.remove("emojis__item--current"),c=d.parentElement.nextElementSibling.nextElementSibling.firstElementChild);else if(t.key==="ArrowDown"){if(d.nextElementSibling){d.classList.remove("emojis__item--current");let u=Math.floor(d.parentElement.clientWidth/(d.clientWidth+2));for(c=d;c.nextElementSibling&&u>0;)c=c.nextElementSibling,u--}else{const u=(o=d.parentElement.nextElementSibling)==null?void 0:o.nextElementSibling;u&&(c=u.firstElementChild,d.classList.remove("emojis__item--current"))}t.preventDefault(),t.stopPropagation()}else if(t.key==="ArrowUp"){if(d.previousElementSibling){d.classList.remove("emojis__item--current");let u=Math.floor(d.parentElement.clientWidth/(d.clientWidth+2));for(c=d;c.previousElementSibling&&u>0;)c=c.previousElementSibling,u--}else{const u=(l=d.parentElement.previousElementSibling)==null?void 0:l.previousElementSibling;u&&(c=u.lastElementChild,d.classList.remove("emojis__item--current"))}t.preventDefault(),t.stopPropagation()}if(c){c.classList.add("emojis__item--current");const u=this.element.querySelector(".emojis__panel");if(c.offsetTop-8<u.scrollTop)u.scrollTop=c.offsetTop-8;else{const f=u.nextElementSibling.classList.contains("fn__none")?8:36;c.offsetTop+f-this.element.clientHeight+c.clientHeight>u.scrollTop&&(u.scrollTop=c.offsetTop+f-this.element.clientHeight+c.clientHeight)}}return t.preventDefault(),t.stopPropagation(),!0}else if(t.key==="ArrowDown"||t.key==="ArrowUp")return upDownHint(this.element.firstElementChild,t),t.preventDefault(),t.stopPropagation(),!0;return t.key==="ArrowLeft"||t.key==="ArrowRight"?(hideElements(["hint"],n),!0):!1}fixImageCursor(t){const n=hasPreviousSibling(t.startContainer);n&&n.nodeType!==3&&n.classList.contains("img")&&(hasNextSibling(n)||(t.insertNode(document.createTextNode(Constants.ZWSP)),t.collapse(!1)))}getKey(t,n){if(this.lastIndex=-1,this.splitChar="",n.forEach(s=>{let o=t.lastIndexOf(s.key);Constants.BLOCK_HINT_KEYS.includes(s.key)&&o>-1&&t.lastIndexOf(s.key+s.key.substring(0,1))>-1&&(o=Math.min(o,t.lastIndexOf(s.key+s.key.substring(0,1)))),this.lastIndex<o&&(Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&(s.key===":"||s.key==="#"||s.key==="/"||s.key==="\u3001")||this.splitChar==="#"&&(s.key==="/"||s.key==="\u3001")||(this.splitChar=s.key,this.lastIndex=o))}),this.lastIndex===-1)return;this.splitChar===":"&&(this.enableEmoji=!(/\d/.test(t.substr(this.lastIndex-1,1))||t.substr(this.lastIndex-1,2)==="::"));const a=t.split(this.splitChar),i=a[a.length-1];if(a.length>1&&i.trimStart()===i&&i.length<Constants.SIZE_TITLE)return this.splitChar==="\u3010\u3010"&&t.endsWith("\u3010\u3010\u3011")?"":i}}const Fr=e=>{addScript(`${Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.10.4`,"protyleViewerScript").then(()=>{const t=document.createElement("ul");t.innerHTML=`<li><img src="${e}"></li>`,window.siyuan.viewer=new Viewer(t,{title:[1,(n,a)=>{let i=n.alt;return i||(i=n.src.substring(n.src.lastIndexOf("/")+1)),i=i.substring(0,i.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${i} [${a.naturalWidth} \xD7 ${a.naturalHeight}]`}],button:!1,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})},Yr=(e,t)=>{addScript(`${Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.10.4`,"protyleViewerScript").then(()=>{fetchPost("/api/asset/getDocImageAssets",{id:t},n=>{const a=document.createElement("ul");let i="",s=-1;n.data.forEach((o,l)=>{o&&(i+=`<li><img src="${o}"></li>`,s===-1&&(e.endsWith(encodeURI(o))||e.endsWith(o))&&(s=l))}),a.innerHTML=i,window.siyuan.viewer=new Viewer(a,{title:[1,(o,l)=>{let r=o.alt;return r||(r=o.src.substring(o.src.lastIndexOf("/")+1)),r=r.substring(0,r.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${r} [${l.naturalWidth} \xD7 ${l.naturalHeight}]`}],button:!1,initialViewIndex:s,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})})},Ur=(e,t)=>{if(typeof speechSynthesis=="undefined"||typeof SpeechSynthesisUtterance=="undefined")return;const n='<svg><use xlink:href="#iconPlay"></use></svg>',a='<svg><use xlink:href="#iconPause"></use></svg>';let i=document.querySelector(".protyle-speech");if(!i){i=document.createElement("div"),i.className="protyle-speech",document.body.insertAdjacentElement("beforeend",i);const s=()=>{const l=speechSynthesis.getVoices();let r,d;return l.forEach(c=>{c.lang===t.replace("_","-")&&(r=c),c.default&&(d=c)}),r||(r=d),r};speechSynthesis.onvoiceschanged!==void 0&&(speechSynthesis.onvoiceschanged=s);const o=s();i.onclick=()=>{if(i.className==="protyle-speech"){const l=new SpeechSynthesisUtterance(i.getAttribute("data-text"));l.voice=o,l.onend=()=>{i.className="protyle-speech",speechSynthesis.cancel(),i.innerHTML=n},speechSynthesis.speak(l),i.className="protyle-speech protyle-speech--current",i.innerHTML=a}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),i.innerHTML=a):(speechSynthesis.pause(),i.innerHTML=n));focusByRange(window.protyleSpeechRange)},document.body.addEventListener("click",()=>{getSelection().toString().trim()===""&&i.style.display==="block"&&(i.className="protyle-speech",speechSynthesis.cancel(),i.style.display="none")})}e.addEventListener("mouseup",s=>{const o=getSelection().toString().trim();if(speechSynthesis.cancel(),getSelection().toString().trim()===""){i.style.display==="block"&&(i.className="protyle-speech",i.style.display="none");return}window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const l=getSelection().getRangeAt(0).getBoundingClientRect();i.innerHTML=n,i.style.display="block",i.style.top=l.top+l.height+document.querySelector("html").scrollTop-20+"px",i.style.left=s.screenX+2+"px",i.setAttribute("data-text",o)})};class Wr{constructor(t){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const n=document.createElement("div");n.className="b3-typography",t.options.classes.preview&&n.classList.add(t.options.classes.preview);const a=t.options.preview.actions,i=document.createElement("div");i.className="protyle-preview__action";const s=[];for(let o=0;o<a.length;o++){const l=a[o];if(typeof l=="object"){s.push(`<button type="button" data-type="${l.key}" class="${l.className}">${l.text}</button>`);continue}switch(l){case"desktop":s.push(`<button type="button" class="protyle-preview__action--current" data-type="desktop">${window.siyuan.languages.desktop}</button>`);break;case"tablet":s.push(`<button type="button" data-type="tablet">${window.siyuan.languages.tablet}</button>`);break;case"mobile":s.push(`<button type="button" data-type="mobile">${window.siyuan.languages.mobile}</button>`);break;case"mp-wechat":s.push(`<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToWechatMP}"><svg><use xlink:href="#iconMp"></use></svg></button>`);break;case"zhihu":s.push(`<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToZhihu}"><svg><use xlink:href="#iconZhihu"></use></svg></button>`);break;case"yuque":s.push(`<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.copyToYuque}"><svg><use xlink:href="#iconYuque"></use></svg></button>`);break}}i.innerHTML=s.join(""),this.element.appendChild(i),this.element.appendChild(n),this.element.addEventListener("click",o=>{let l=o.target;for(;l&&!l.isEqualNode(this.element);){if(l.tagName==="A"){const d=l.getAttribute("href");if(d.startsWith("#")){n.querySelector(d).scrollIntoView(),o.stopPropagation(),o.preventDefault();break}if(isMobile()){openByMobile(d),o.stopPropagation(),o.preventDefault();break}o.stopPropagation(),o.preventDefault(),isLocalPath(d)||window.open(d);break}else if(l.tagName==="IMG"){previewDocImage(o.target.src,t.block.rootID),o.stopPropagation(),o.preventDefault();break}else if(l.tagName==="BUTTON"){const d=l.getAttribute("data-type"),c=a.find(u=>(u==null?void 0:u.key)===d);c?c.click(d):d==="mp-wechat"||d==="zhihu"||d==="yuque"?this.copyToX(this.element.lastElementChild.cloneNode(!0),t,d):d==="desktop"?(n.style.width="",n.style.padding=t.wysiwyg.element.style.padding):d==="tablet"?(n.style.width="1024px",n.style.padding="8px 16px"):(n.style.width="360px",n.style.padding="8px"),d!=="mp-wechat"&&d!=="zhihu"&&d!=="yuque"&&(i.querySelectorAll("button").forEach(u=>{u.classList.remove("protyle-preview__action--current")}),l.classList.add("protyle-preview__action--current"))}l=l.parentElement}const r=hasClosestByAttribute(o.target,"id",void 0);r&&(this.element.querySelectorAll(".protyle-wysiwyg--select").forEach(d=>{d.classList.remove("selected")}),r.classList.add("selected"))}),this.previewElement=n}render(t){var n;if(this.element.style.display==="none")return;if((n=this.element.querySelector('.protyle-preview__action [data-type="desktop"]'))!=null&&n.classList.contains("protyle-preview__action--current")){const i=getPadding(t);this.previewElement.style.padding=`${i.top}px ${i.left}px ${i.bottom}px ${i.right}px`}let a=this.element.querySelector(".fn__loading");a||(this.element.insertAdjacentHTML("beforeend",`<div style="flex-direction: column;" class="fn__loading">
    <img width="48px" src="/stage/loading-pure.svg">
</div>`),a=this.element.querySelector(".fn__loading")),this.mdTimeoutId=window.setTimeout(()=>{fetchPost("/api/export/preview",{id:t.block.parentID||t.options.blockId},i=>{const s=t.preview.previewElement.scrollTop;t.preview.previewElement.innerHTML=i.data.html,processRender(t.preview.previewElement),highlightRender(t.preview.previewElement),avRender(t.preview.previewElement,t),speechRender(t.preview.previewElement,t.options.lang),t.preview.previewElement.scrollTop=s,a.remove()})},t.options.preview.delay)}link2online(t){needSubscribe("")||t.querySelectorAll("[href],[src]").forEach(n=>{const a=n.getAttribute("href")||n.getAttribute("src");if(a&&a.startsWith("assets/")){const i=Constants.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+a;n.getAttribute("href")?n.setAttribute("href",i):n.setAttribute("src",i)}})}copyToX(t,n,a){if(a==="mp-wechat")this.link2online(t),t.querySelectorAll(".katex-html .base").forEach(o=>{o.style.display="initial"}),t.querySelectorAll("mjx-container > svg").forEach(o=>{o.setAttribute("width",parseInt(o.getAttribute("width"))*8+"px")});else if(a==="zhihu")this.link2online(t),t.querySelectorAll('[data-subtype="math"]').forEach(o=>{o.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${o.getAttribute("data-content")}" style="${o.tagName==="DIV"?"display: block; max-width: 100%;":""}margin: 0 auto;">`}),t.querySelectorAll("blockquote").forEach(o=>{const l=[];this.processZHBlockquote(o,l),l.reverse().forEach(r=>{o.insertAdjacentElement("afterend",r)}),o.remove()}),this.processZHTable(t);else if(a==="yuque"){fetchPost("/api/lute/copyStdMarkdown",{id:n.block.rootID},o=>{writeText(o.data),showMessage(`${window.siyuan.languages.pasteToYuque}`)});return}t.style.backgroundColor="#fff",t.querySelectorAll("code").forEach(o=>{o.style.backgroundImage="none"}),this.element.append(t);let i;getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0).cloneRange());const s=t.ownerDocument.createRange();s.selectNodeContents(t),focusByRange(s),document.execCommand("copy"),this.element.lastElementChild.remove(),focusByRange(i),a&&showMessage(`${a==="zhihu"?window.siyuan.languages.pasteToZhihu:window.siyuan.languages.pasteToWechatMP}`)}processZHBlockquote(t,n){Array.from(t.children).forEach(a=>{if(a.tagName==="BLOCKQUOTE")this.processZHBlockquote(a,n);else if(a.tagName!=="P"||a.querySelector("img"))n.push(a);else{const i=n[n.length-1];(!i||i&&i.tagName!=="BLOCKQUOTE")&&n.push(document.createElement("blockquote")),n[n.length-1].append(a)}})}processZHTable(t){t.querySelectorAll("table").forEach(n=>{const a=n.querySelector("thead");if(!a)return;const i=n.querySelector("tbody");i?i.insertAdjacentElement("afterbegin",a.firstElementChild):n.innerHTML=`<tbody>${a.innerHTML}</tbody>`,a.remove()})}}class jr{constructor(t){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1},action:[],after:void 0,classes:{preview:""},debugger:Constants.NODE_ENV==="development",hint:{delay:200,emoji:{"+1":"\u{1F44D}","-1":"\u{1F44E}",confused:"\u{1F615}",eyes:"\u{1F440}\uFE0F",heart:"\u2764\uFE0F",rocket:"\u{1F680}\uFE0F",smile:"\u{1F604}",tada:"\u{1F389}\uFE0F"},emojiPath:"/emojis",extend:[{key:"((",hint:hintRef},{key:"\u3010\u3010",hint:hintRef},{key:"\uFF08\uFF08",hint:hintRef},{key:"[[",hint:hintRef},{key:"{{",hint:hintEmbed},{key:"\u300C\u300C",hint:hintEmbed},{key:"\u300C\u300E",hint:hintEmbed},{key:"\u300E\u300C",hint:hintEmbed},{key:"\u300E\u300E",hint:hintEmbed},{key:"#",hint:hintTag},{key:"/",hint:hintSlash},{key:"\u3001",hint:hintSlash},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:0,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:isMobile()?["block-ref","a","|","text","strong","em","u","clear","|","code","tag","inline-math","inline-memo"]:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo"],typewriterMode:!1,upload:{max:1024*1024*1024*4,url:Constants.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:n=>n.replace(/[\\/:*?"'<>|\[\]\(\)~!`&{}=#%$]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=t}merge(){var t;return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),(t=this.options.hint)!=null&&t.emoji&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),merge(this.defaultOptions,this.options)}mergeToolbar(t){const n=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.ref.custom,lang:"ref",icon:"iconRef",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"appearance",hotkey:window.siyuan.config.keymap.editor.insert.appearance.custom,icon:"iconFont",tipPosition:"n"},{name:"clear",lang:"clearInline",hotkey:window.siyuan.config.keymap.editor.insert.clearInline.custom,icon:"iconClear",tipPosition:"n"},{name:"|"}],a=[];return t.forEach(i=>{let s=i;n.find(o=>{if(typeof i=="string"&&o.name===i)return s=o,!0;if(typeof i=="object"&&o.name===i.name)return s=Object.assign({},o,i),!0}),a.push(s)}),a}}const Vr=(e,t)=>{e.element.querySelector(".wysiwygLoading")||(addLoading(e),hideElements(["toolbar"],e),fetchPost(`/api/format/net${t}2LocalAssets`,{id:e.block.rootID},()=>{reloadProtyle(e,!1)}))},Gr=(e,t)=>{var n,a;setTimeout(()=>{hideAllElements(["gutter"])},Constants.TIMEOUT_TRANSITION);const i=e.className.includes("fullscreen");if(i?(e.classList.remove("fullscreen"),(n=document.getElementById("drag"))==null||n.classList.remove("fn__hidden")):(e.classList.add("fullscreen"),(a=document.getElementById("drag"))==null||a.classList.add("fn__hidden")),isWindow(),t){i?t.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):t.querySelector("use").setAttribute("xlink:href","#iconFullscreenExit");const s=hasClosestByClassName(e,"layout--float");s&&(i?(s.setAttribute("data-temp",s.style.transform),s.style.transform="none"):(s.style.transform=s.getAttribute("data-temp"),s.removeAttribute("data-temp")));return}},Pi=(e,t)=>{if(!window.siyuan.config.readonly){const n=e.querySelector("use").getAttribute("xlink:href")!=="#iconUnlock";window.siyuan.config.editor.readOnly?n?Ds(t):mn(t):Se("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[x.CUSTOM_SY_READONLY]:n?"false":"true"}})}},zr=(e,t,n)=>{if(matchHotKey(window.siyuan.config.keymap.editor.general.copyHPath.custom,t))return fetchPost("/api/filetree/getHPathByID",{id:e.block.rootID},a=>{writeText(a.data)}),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,t))return net2LocalAssets(e,"Img"),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,t))return net2LocalAssets(e,"Assets"),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.optimizeTypography.custom,t))return fetchPost("/api/format/autoSpace",{id:e.block.rootID}),t.preventDefault(),t.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,t)){const a=n?n.getAttribute("data-node-id"):e.block.rootID;return fetchPost("/api/block/getRefText",{id:a},i=>{writeText(`[${i.data}](siyuan://blocks/${a})`)}),t.preventDefault(),t.stopPropagation(),!0}},Kr=e=>{const t=e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0)e.event.stopPropagation(),e.event.preventDefault();else{const i=hasClosestByMatchTag(e.range.startContainer,"TD")||hasClosestByMatchTag(e.range.startContainer,"TH")||getContenteditableElement(e.nodeElement)||e.nodeElement,s=getSelectionOffset(i,e.editorElement,e.range).start,o=i.innerText,l=matchHotKey(window.siyuan.config.keymap.editor.general.expandUp.custom,e.event);if(!(!isMac()&&l)){if(s>0){o.substr(0,s).indexOf(`
`)===-1&&e.range.getBoundingClientRect().top-i.getBoundingClientRect().top-parseInt(getComputedStyle(i).paddingTop)<14&&(setFirstNodeRange(i,e.range),e.event.preventDefault());return}}}e.range.collapse(!0),hideElements(["toolbar"],e.protyle),t.length===0?e.nodeElement.classList.add("protyle-wysiwyg--select"):e.cb(t);const n=[];e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),countBlockWord(n,e.protyle.block.rootID),e.event.stopPropagation(),e.event.preventDefault()},Zr=e=>{const t=e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.length>0)e.event.stopPropagation(),e.event.preventDefault();else{const i=hasClosestByMatchTag(e.range.startContainer,"TD")||hasClosestByMatchTag(e.range.startContainer,"TH")||getContenteditableElement(e.nodeElement)||e.nodeElement,s=getSelectionOffset(i,e.editorElement,e.range).end,o=i.innerText,l=matchHotKey(window.siyuan.config.keymap.editor.general.expandDown.custom,e.event);if(!(!isMac()&&l)){if(s<o.length){!getNextBlock(e.nodeElement)&&o.trimRight().substr(s).indexOf(`
`)===-1&&i.getBoundingClientRect().bottom-e.range.getBoundingClientRect().bottom-parseInt(getComputedStyle(i).paddingBottom)<14&&(setLastNodeRange(i,e.range,!1),e.nodeElement.classList.contains("code-block")&&l&&e.event.preventDefault());return}}}e.range.collapse(!1),hideElements(["toolbar"],e.protyle),t.length===0?e.nodeElement.classList.add("protyle-wysiwyg--select"):e.cb(t);const n=[];e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),countBlockWord(n,e.protyle.block.rootID),e.event.stopPropagation(),e.event.preventDefault()},Xr=e=>{let t,n;return e.forEach(a=>{a.getAttribute("select-start")&&(t=a),a.getAttribute("select-end")&&(n=a)}),t||(t=e[0],t.setAttribute("select-start","true")),n||(n=e[e.length-1],n.setAttribute("select-end","true")),{startElement:t,endElement:n}},Jr=(e,t)=>{let n;const a=[],i=[];let s;if(e[e.length-1].getAttribute("data-subtype")==="o"&&(s=parseInt(e[e.length-1].getAttribute("data-marker"),10)),e.reverse().forEach((o,l)=>{const r=o.cloneNode(!0);l===0&&(n=r);const d=Lute.NewNodeID();if(r.setAttribute("data-node-id",d),r.querySelectorAll("[data-node-id]").forEach(c=>{c.setAttribute("data-node-id",Lute.NewNodeID())}),o.classList.remove("protyle-wysiwyg--select"),typeof s=="number"){const c=s+(e.length-l);r.setAttribute("data-marker",c+"."),r.querySelector(".protyle-action--order").textContent=c+"."}e[0].after(processClonePHElement(r)),a.push({action:"insert",data:r.outerHTML,id:d,previousID:e[0].getAttribute("data-node-id")}),i.push({action:"delete",id:d})}),typeof s=="number"){let o=n.nextElementSibling;for(s=s+e.length;o&&o.getAttribute("data-subtype")==="o";){s++;const l=o.getAttribute("data-node-id");i.push({action:"update",id:l,data:o.outerHTML}),o.setAttribute("data-marker",s+"."),o.querySelector(".protyle-action--order").textContent=s+".",a.push({action:"update",data:o.outerHTML,id:l}),o=o.nextElementSibling}}transaction(t,a,i),focusBlock(n),scrollCenter(t)},Qr=e=>{e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0"||e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.options.backlinkData?(focusBlock(e.wysiwyg.element.firstElementChild),e.contentElement.scrollTop=0,e.scroll.lastScrollTop=1):fetchPost("/api/filetree/getDoc",{id:e.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{onGet({data:t,protyle:e,action:[Constants.CB_GET_FOCUS]})})},ed=e=>{!e.scroll.element.classList.contains("fn__none")&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"?fetchPost("/api/filetree/getDoc",{id:e.block.rootID,mode:4,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{onGet({data:t,protyle:e,action:[Constants.CB_GET_FOCUS],afterCB(){focusBlock(e.wysiwyg.element.lastElementChild,void 0,!1)}})}):(e.contentElement.scrollTop=e.contentElement.scrollHeight,e.scroll.lastScrollTop=e.contentElement.scrollTop,focusBlock(e.wysiwyg.element.lastElementChild,void 0,!1))},td=(e,t,n,a,i)=>{t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),n.forEach(s=>{s.style.minWidth="calc(100% - 0.1em)"}),updateTransaction(e,a,t.outerHTML,i)},nd=(e,t,n,a,i)=>{t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),n.forEach(s=>{s.removeAttribute("style")}),updateTransaction(e,a,t.outerHTML,i)};class ad{constructor(t){this.parentElement=document.createElement("div"),this.parentElement.classList.add("protyle-scroll"),isMobile()||(this.parentElement.style.right="10px"),this.parentElement.innerHTML=`<div class="protyle-scroll__up ariaLabel" data-position="right4top" aria-label="${updateHotkeyTip("\u2318Home")}">
    <svg><use xlink:href="#iconUp"></use></svg>
</div>
<div class="fn__none protyle-scroll__bar ariaLabel" data-position="right18bottom" aria-label="Blocks 1/1">
    <input class="b3-slider" type="range" max="1" min="1" step="1" value="1" />
</div>
<div class="protyle-scroll__down ariaLabel" data-position="right4bottom" aria-label="${updateHotkeyTip("\u2318End")}">
    <svg><use xlink:href="#iconDown"></use></svg>
</div>`,this.element=this.parentElement.querySelector(".protyle-scroll__bar"),this.keepLazyLoad=!1,t.options.render.scroll||this.parentElement.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=this.element.firstElementChild,this.inputElement.addEventListener("input",()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${t.block.blockCount}`),showTooltip(this.element.getAttribute("aria-label"),this.element)}),this.inputElement.addEventListener("change",()=>{this.setIndex(t)}),this.inputElement.addEventListener("touchend",()=>{this.setIndex(t)}),this.parentElement.addEventListener("click",n=>{const a=n.target;hasClosestByClassName(a,"protyle-scroll__up")?goHome(t):hasClosestByClassName(a,"protyle-scroll__down")?goEnd(t):a.classList.contains("b3-slider")&&this.setIndex(t)})}setIndex(t){t.wysiwyg.element.getAttribute("data-top")||(t.wysiwyg.element.setAttribute("data-top",t.wysiwyg.element.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:t.block.parentID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{onGet({data:n,protyle:t,action:[Constants.CB_GET_FOCUSFIRST,Constants.CB_GET_UNCHANGEID],afterCB:()=>{showTooltip(this.element.getAttribute("aria-label"),this.element)}})}))}updateIndex(t,n,a){fetchPost("/api/block/getBlockIndex",{id:n},i=>{if(!i.data)return;const s=t.scroll.element.querySelector(".b3-slider");s.value=i.data,t.scroll.element.setAttribute("aria-label",`Blocks ${i.data}/${t.block.blockCount}`),a&&a(i.data)})}update(t){typeof t.block.blockCount=="number"&&(this.inputElement.setAttribute("max",t.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${t.block.blockCount}`)),t.block.showAll?this.element.classList.add("fn__none"):t.block.scroll&&!t.contentElement.classList.contains("fn__none")?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}class sd{constructor(t){this.app=t.app,t.msgCallback&&this.connect(t)}connect(t){const n=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,a=new WebSocket(`${n}?app=${Constants.SIYUAN_APPID}&id=${t.id}${t.type?"&type="+t.type:""}`);a.onopen=()=>{t.callback&&t.callback.call(this),document.getElementById("errorLog")&&(reloadSync(this.app,{upsertRootIDs:[],removeRootIDs:[]}),window.siyuan.dialogs.find(s=>{if(s.element.id==="errorLog")return s.destroy(),!0}))},a.onmessage=i=>{if(t.msgCallback){const s=processMessage(JSON.parse(i.data));t.msgCallback.call(this,s)}},a.onclose=i=>{0<=i.reason.indexOf("unauthenticated")||0>i.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",i),setTimeout(()=>{this.connect({id:t.id,type:t.type,msgCallback:t.msgCallback})},3e3))},a.onerror=i=>{i.target.url.endsWith("&type=main")&&i.target.readyState===3&&kernelError()},this.ws=a}send(t,n,a=!1){this.ws&&(this.reqId=a?0:new Date().getTime(),this.ws.send(JSON.stringify({cmd:t,reqId:this.reqId,param:n})))}}var Un=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const Ri=e=>{const t=e.dataset.type;let n="";if(["NodeHeading","NodeParagraph"].includes(t))n=getContenteditableElement(e).innerHTML;else if(t==="NodeHTMLBlock")n="HTML";else if(t==="NodeAttributeView")n=e.querySelector(".av__title").textContent||window.siyuan.languages.database;else if(t==="NodeThematicBreak")n=window.siyuan.languages.line;else if(t==="NodeIFrame")n="IFrame";else if(t==="NodeWidget")n=window.siyuan.languages.widget;else if(t==="NodeVideo")n=window.siyuan.languages.video;else if(t==="NodeAudio")n=window.siyuan.languages.audio;else if(["NodeCodeBlock","NodeTable"].includes(t))n=Ha(e);else if(e.classList.contains("render-node"))n+=e.dataset.subtype||Lute.UnEscapeHTMLStr(e.getAttribute("data-content"));else if(["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(t)&&(Array.from(e.querySelectorAll("[data-node-id]")).find(a=>{if(!["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(a.getAttribute("data-type")))return n=Ri(e.querySelector("[data-node-id]")),!0}),n))return n;return n+` <span data-type="block-ref" data-subtype="s" data-id="${e.getAttribute("data-node-id")}">*</span>`},Ha=(e,t=!1)=>{let n="";const a=e.dataset.type;return a==="NodeHTMLBlock"?n+=Lute.UnEscapeHTMLStr(e.querySelector("protyle-html").getAttribute("data-content")):a==="NodeAttributeView"?(e.querySelectorAll(".av__row").forEach(i=>{i.querySelectorAll(".av__cell").forEach(s=>{n+=getCellText(s)+" "}),n+=`
`}),n=n.trimEnd()):a==="NodeThematicBreak"?n+="---":a==="NodeIFrame"||a==="NodeWidget"?n+=e.querySelector("iframe").getAttribute("src"):a==="NodeVideo"?n+=e.querySelector("video").getAttribute("src"):a==="NodeAudio"?n+=e.querySelector("audio").getAttribute("src"):e.classList.contains("render-node")?n+=Lute.UnEscapeHTMLStr(e.getAttribute("data-content")):["NodeHeading","NodeParagraph","NodeCodeBlock","NodeTable"].includes(a)?n+=e.querySelector("[spellcheck]").textContent:!t&&["NodeBlockquote","NodeList","NodeSuperBlock","NodeListItem"].includes(a)&&e.querySelectorAll("[data-node-id]").forEach(i=>{const s=Ha(i,!0);n+=s?s+`
`:""}),n},id=(e,t)=>Un(void 0,null,function*(){try{let n=yield readText();n=n.replace(/\\/g,"\\\\").replace(/\*/g,"\\*").replace(/_/g,"\\_").replace(/\[/g,"\\[").replace(/]/g,"\\]").replace(/!/g,"\\!").replace(/`/g,"\\`").replace(/</g,"\\<").replace(/>/g,"\\>").replace(/&/g,"\\&").replace(/~/g,"\\~").replace(/\{/g,"\\{").replace(/}/g,"\\}").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/=/g,"\\=").replace(/#/g,"\\#").replace(/\$/g,"\\$").replace(/\^/g,"\\^").replace(/\|/g,"\\|").replace(/\./g,"\\."),Oi(e,n,t,!1)}catch(n){console.log(n)}}),$t=(e,t)=>{let n=!0;e.options.hint.extend.find(a=>{if(a.key===t)return n=!1,!0}),n&&e.hint.render(e)},od=e=>Un(void 0,null,function*(){[].length===0&&navigator.clipboard.readText().then(n=>{n=n.replace(/<sub>/g,"__@sub@__").replace(/<\/sub>/g,"__@/sub@__"),n=n.replace(/<sup>/g,"__@sup@__").replace(/<\/sup>/g,"__@/sup@__"),n=n.replace(/<kbd>/g,"__@kbd@__").replace(/<\/kbd>/g,"__@/kbd@__"),n=n.replace(/<u>/g,"__@u@__").replace(/<\/u>/g,"__@/u@__"),n=n.replace(/</g,";;;lt;;;").replace(/>/g,";;;gt;;;"),n=n.replace(/__@sub@__/g,"<sub>").replace(/__@\/sub@__/g,"</sub>"),n=n.replace(/__@sup@__/g,"<sup>").replace(/__@\/sup@__/g,"</sup>"),n=n.replace(/__@kbd@__/g,"<kbd>").replace(/__@\/kbd@__/g,"</kbd>"),n=n.replace(/__@u@__/g,"<u>").replace(/__@\/u@__/g,"</u");const a=e.lute.BlockDOM2EscapeMarkerContent(e.lute.Md2BlockDOM(n));insertHTML(a,e,!1,!1,!0),$t(e,n)})}),Oi=(e,t,n,a=!0)=>{const i=getEditorRange(e.wysiwyg.element);if(n.getAttribute("data-type")==="NodeCodeBlock"){insertHTML(t,e);return}if(i.toString()!=="")if(isDynamicRef(t))t=t.replace(/'.+'\)\)$/,` "${i.toString()}"))`);else if(isFileAnnotation(t))t=t.replace(/".+">>$/,`"${i.toString()}">>`);else{const s=e.lute.GetLinkDest(t);s&&(t=`[${i.toString()}](${s})`)}insertHTML(a?e.lute.Md2BlockDOM(t):t,e,!1,!1,!0),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),$t(e,t),scrollCenter(e,void 0,!1,"smooth")},ld=(e,t)=>Un(void 0,null,function*(){t.stopPropagation(),t.preventDefault();let n,a,i,s;if("clipboardData"in t?(n=t.clipboardData.getData("text/html"),a=t.clipboardData.getData("text/plain"),i=t.clipboardData.getData("text/siyuan"),s=t.clipboardData.files):(n=t.dataTransfer.getData("text/html"),a=t.dataTransfer.getData("text/plain"),i=t.dataTransfer.getData("text/siyuan"),t.dataTransfer.types[0]==="Files"&&(s=t.dataTransfer.items)),a=a.replace(/\r\n|\r|\u2028|\u2029/g,`
`),(n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<a href="${a}">${a}</a>`||n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<!--StartFragment--><a href="${a}">${a}</a><!--EndFragment-->`)&&(n=""),a.endsWith(Constants.ZWSP)&&!n&&!i&&(i=a.substr(0,a.length-1)),!i){const c=new DOMParser().parseFromString(n,"text/html");c.body&&c.body.innerHTML&&(n=c.body.innerHTML),n.startsWith(`
<!--StartFragment-->`)&&n.endsWith(`<!--EndFragment-->

`)&&(n=c.body.innerHTML.trim().replace("<!--StartFragment-->","").replace("<!--EndFragment-->","")),n=Lute.Sanitize(n)}if(e&&e.app&&e.app.plugins)for(let c=0;c<e.app.plugins.length;c++){const u=yield new Promise(f=>{e.app.plugins[c].eventBus.emit("paste",{protyle:e,resolve:f,textHTML:n,textPlain:a,siyuanHTML:i,files:s})&&f(void 0)});u!=null&&u.textHTML&&(n=u.textHTML),u!=null&&u.textPlain&&(a=u.textPlain),u!=null&&u.siyuanHTML&&(i=u.siyuanHTML),u!=null&&u.files&&(s=u.files)}const o=hasClosestBlock(t.target);if(!o){s&&s.length>0&&uploadFiles(e,s);return}hideElements(["select"],e),e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(c=>{c.classList.remove("protyle-wysiwyg--hl")});const l=processPasteCode(n,a),r=getEditorRange(e.wysiwyg.element);if(o.getAttribute("data-type")==="NodeCodeBlock"||e.toolbar.getCurrentType(r).includes("code")){insertHTML(a,e);return}else if(i){const c=document.createElement("div");c.innerHTML=i;let u=!1;c.querySelectorAll("[data-node-id]").forEach(g=>{const p=Lute.NewNodeID();g.setAttribute("data-node-id",p),g.removeAttribute(Constants.CUSTOM_RIFF_DECKS),g.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),g.setAttribute("updated",p.split("-")[0]),u=!0}),o.classList.contains("table")&&(u=!1),c.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(g=>{g.setAttribute("contenteditable","true")});const f=c.innerHTML;if(!o.classList.contains("av")&&f.startsWith("[[{")&&f.endsWith("}]]"))try{const g=JSON.parse(f);g.length>0&&g[0].length>0&&g[0][0].id&&g[0][0].type?insertHTML(a,e,u):insertHTML(f,e,u)}catch(g){insertHTML(f,e,u)}else insertHTML(f,e,u,!1,!0);$t(e,e.lute.BlockDOM2StdMd(f)),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e)}else if(l)l.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="')?(insertHTML(l,e,!0,!1,!0),highlightRender(e.wysiwyg.element)):insertHTML(l,e),hideElements(["hint"],e);else{let c=!1;if(n.replace("<!--StartFragment--><!--EndFragment-->","").trim()!==""&&(n=n.replace("<!--StartFragment-->","").replace("<!--EndFragment-->","").trim(),s&&s.length===1&&(n.startsWith("<img")||n.startsWith("<table")&&n.indexOf("<img")>-1)?c=!1:c=!0),c){const u=document.createElement("div");u.innerHTML=n,u.querySelectorAll("[style]").forEach(f=>{f.removeAttribute("style")}),u.querySelectorAll("a").forEach(f=>{f.innerHTML.trim()===""&&f.remove()}),fetchPost("/api/lute/html2BlockDOM",{dom:u.innerHTML},f=>{insertHTML(f.data,e,!1,!1,!0),e.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(g=>{g.textContent===""&&fetchPost("/api/block/getRefText",{id:g.getAttribute("data-id")},p=>{g.innerHTML=p.data})}),blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),$t(e,f.data),scrollCenter(e,void 0,!1,"smooth")});return}else if(s&&s.length>0)uploadFiles(e,s);else if(a.trim()!==""&&s&&s.length===0){if(r.toString()!==""){const f=a.split(`
`)[0];if(isDynamicRef(a)){e.toolbar.setInlineMark(e,"block-ref","range",{type:"id",color:`${a.substring(2,22+2)}${Constants.ZWSP}s${Constants.ZWSP}${r.toString()}`});return}else if(isFileAnnotation(f)){e.toolbar.setInlineMark(e,"file-annotation-ref","range",{type:"file-annotation-ref",color:f.substring(2).replace(/ ".+">>$/,"")});return}else{const g=e.lute.GetLinkDest(a);if(g){e.toolbar.setInlineMark(e,"a","range",{type:"a",color:g});return}}}const u=e.lute.Md2BlockDOM(a);insertHTML(u,e,!1,!1,!0),$t(e,a)}blockRender(e,e.wysiwyg.element),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e)}const d=o.querySelector(".av__cell--select");o.classList.contains("av")&&d?cellScrollIntoView(o,d):scrollCenter(e,void 0,!1,"smooth")}),qi=e=>{e.menuElement.querySelector("input").addEventListener("change",t=>{t.target.files.length!==0&&uploadFiles(e.protyle,t.target.files,t.target,n=>{const a=JSON.parse(n),i=[];Object.keys(a.data.succMap).forEach(s=>{i.push({name:s,content:a.data.succMap[s],type:Constants.SIYUAN_ASSETS_IMAGE.includes(pathPosix().extname(a.data.succMap[s]).toLowerCase())?"image":"file"})}),Ht({protyle:e.protyle,cellElements:e.cellElements,addValue:i,blockElement:e.blockElement})})})},Fi=e=>{let t="";return genCellValueByElement("mAsset",e[0]).mAsset.forEach((n,a)=>{let i;n.type==="image"?i=`<span data-type="openAssetItem" class="fn__flex-1 ariaLabel" aria-label="${n.content}">
    <img style="max-height: 180px;max-width: 360px;border-radius: var(--b3-border-radius);margin: 4px 0;" src="${n.content}"/>
</span>`:i=`<span data-type="openAssetItem" class="fn__ellipsis b3-menu__label ariaLabel" aria-label="${escapeAttr(n.content)}" style="max-width: 360px">${n.name||n.content}</span>`,t+=`<button class="b3-menu__item" draggable="true" data-index="${a}" data-name="${escapeAttr(n.name)}" data-type="${n.type}" data-content="${escapeAttr(n.content)}">
<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
${i}
<svg class="b3-menu__action" data-type="editAssetItem"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items">
    ${t}
    <button data-type="addAssetExist" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconImage"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.assets}</span>
    </button>
    <button class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconDownload"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.insertAsset}</span> 
        <input multiple class="b3-form__upload" type="file">
    </button>
    <button data-type="addAssetLink" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconLink"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.link}</span>
    </button>
</div>`},Ht=e=>{const t=e.cellElements[0].dataset.colId,n=[],a=[];let i;e.cellElements.forEach((o,l)=>{var r,d;if(!e.blockElement.contains(o)){const p=hasClosestByClassName(o,"av__row");p&&(o=e.cellElements[l]=e.blockElement.querySelector(`.av__row[data-id="${p.dataset.id}"] .av__cell[data-col-id="${o.dataset.colId}"]`)||e.blockElement.querySelector(`.fn__flex-1[data-col-id="${o.dataset.colId}"]`))}const c=genCellValueByElement(getTypeByCellElement(o)||o.dataset.type,o),u=hasClosestByClassName(o,"av__row").dataset.id,f=JSON.parse(JSON.stringify(c));l===0?(typeof e.removeIndex=="number"?c.mAsset.splice(e.removeIndex,1):((r=e.addValue)==null?void 0:r.length)>0?c.mAsset=c.mAsset.concat(e.addValue):e.updateValue?c.mAsset.find((p,m)=>{if(m===e.updateValue.index)return p.content=e.updateValue.value.content,p.type=e.updateValue.value.type,p.name=e.updateValue.value.name,!0}):((d=e.replaceValue)==null?void 0:d.length)>0&&(c.mAsset=e.replaceValue),i=c.mAsset):c.mAsset=i;const g=e.blockElement.getAttribute("data-av-id");n.push({action:"updateAttrViewCell",id:c.id,keyID:t,rowID:u,avID:g,data:c}),a.push({action:"updateAttrViewCell",id:c.id,keyID:t,rowID:u,avID:g,data:f}),o.classList.contains("custom-attr__avvalue")?o.innerHTML=genAVValueHTML(c):updateAttrViewCellAnimation(o,c)}),transaction(e.protyle,n,a);const s=document.querySelector(".av__panel > .b3-menu");if(s){s.innerHTML=Fi(e.cellElements),qi({protyle:e.protyle,menuElement:s,cellElements:e.cellElements,blockElement:e.blockElement});const o=(e.cellElements[0].classList.contains("custom-attr__avvalue")?e.cellElements[0]:e.protyle.wysiwyg.element.querySelector(`.av__cell[data-id="${e.cellElements[0].dataset.id}"]`)).getBoundingClientRect();setTimeout(()=>{setPosition(s,o.left,o.bottom,o.height)},Constants.TIMEOUT_LOAD)}},rd=e=>{const t=e.content,n=e.type,a=new Menu("av-asset-edit",()=>{!s[1]&&s[0].value===t||s[1]&&s[0].value===t&&s[1].value===e.name||Ht({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,updateValue:{index:e.index,value:{content:s[0].value,name:s[1]?s[1].value:"",type:n}}})});if(a.isOpen)return;n==="file"?a.addItem({iconHTML:"",type:"readonly",label:`${window.siyuan.languages.link}
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
${window.siyuan.languages.title}
<textarea style="width: ${isMobile()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`}):(a.addItem({iconHTML:"",type:"readonly",label:`${window.siyuan.languages.link}
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>`}),a.addItem({icon:"iconPreview",label:window.siyuan.languages.cardPreview,click(){previewImage(t)}}),a.addItem({label:window.siyuan.languages.copy,icon:"iconCopy",click(){writeText(`![](${t.replace(/%20/g," ")})`)}}),a.addItem({label:window.siyuan.languages.copyAsPNG,icon:"iconImage",click(){copyPNGByLink(t)}}),a.addSeparator()),a.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){Ht({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,removeIndex:e.index})}}),openMenu(e.protyle?e.protyle.app:window.siyuan.ws.app,t,!1,!1),t!=null&&t.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem(exportAsset(t)).element);const i=e.rect;a.open({x:i.right,y:i.top,w:i.width,h:i.height});const s=a.element.querySelectorAll("textarea");s[0].value=t,s[0].focus(),s[0].select(),s.length>1&&(s[1].value=e.name)},dd=(e,t,n,a)=>{const i=new Menu("av-asset-link",()=>{const o=i.element.querySelectorAll("textarea");!o[0].value&&!o[1].value||Ht({protyle:e,cellElements:t,blockElement:a,addValue:[{type:"file",name:o[1].value,content:o[0].value}]})});if(i.isOpen)return;i.addItem({iconHTML:"",type:"readonly",label:`${window.siyuan.languages.link}
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px;resize: vertical;" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
${window.siyuan.languages.title}
<textarea style="width: ${isMobile()?"200":"360"}px;margin: 4px 0;resize: vertical;" rows="1" class="b3-text-field"></textarea>`});const s=n.getBoundingClientRect();i.open({x:s.right,y:s.bottom,w:n.parentElement.clientWidth+8,h:s.height}),i.element.querySelector("textarea").focus()},cd=(e,t,n)=>{const a=showMessage(window.siyuan.languages.uploading,0);fetchPost("/api/asset/insertLocalAssets",{assetPaths:e,isUpload:!0,id:t.block.rootID},i=>{const s=hasClosestBlock(n);if(s){hideMessage(a);const o=[];Object.keys(i.data.succMap).forEach(l=>{const r=pathPosix().extname(l).toLowerCase(),d=l.substring(0,l.length-r.length);Constants.SIYUAN_ASSETS_IMAGE.includes(r)?o.push({type:"image",name:d,content:i.data.succMap[l]}):o.push({type:"file",name:d,content:i.data.succMap[l]})}),Ht({protyle:t,blockElement:s,cellElements:[n],addValue:o})}})};var en=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const Na=(e,t,n,a,i,s,o)=>{let l;const r=n.getAttribute("data-node-id"),d=a.getAttribute("data-node-id"),c=[],u=[];return n.insertAdjacentElement(s?"afterend":"beforebegin",a),s?c.push({action:"insert",data:a.outerHTML,id:d,previousID:r}):c.push({action:"insert",data:a.outerHTML,id:d,nextID:r}),t.reverse().forEach((f,g)=>{var p;const m=f.getAttribute("data-node-id");g===t.length-1&&(l=getTopAloneElement(f),l.isSameNode(f)&&(l=void 0));const y=Lute.NewNodeID();if(o?u.push({action:"delete",id:y}):u.push({action:"move",id:m,previousID:(p=f.previousElementSibling)==null?void 0:p.getAttribute("data-node-id"),parentID:f.parentElement.getAttribute("data-node-id")||e.block.rootID}),!i&&!o){const v=e.wysiwyg.element.querySelector(`[data-node-id="${m}"]`);v&&v.remove()}if(o){const v=f.cloneNode(!0);v.setAttribute("data-node-id",y),v.querySelectorAll("[data-node-id]").forEach(b=>{const w=Lute.NewNodeID();b.setAttribute("data-node-id",w),b.setAttribute("updated",w.split("-")[0])}),a.insertAdjacentElement("afterbegin",v),c.push({action:"insert",id:y,data:v.outerHTML,parentID:d})}else a.insertAdjacentElement("afterbegin",f),c.push({action:"move",id:m,parentID:d})}),u.reverse(),a.getAttribute("data-subtype")==="o"&&(u.splice(0,0,{action:"update",id:d,data:a.outerHTML}),updateListOrder(a,1),c.push({action:"update",id:d,data:a.outerHTML})),u.push({action:"delete",id:d}),{doOperations:c,undoOperations:u,topSourceElement:l}},Ba=(e,t,n,a,i,s)=>en(void 0,null,function*(){let o;const l=[],r=[],d=[],c=n.getAttribute("data-node-id");let u=n;t.reverse().forEach((f,g)=>{var p,m,y,v,b;const w=f.getAttribute("data-node-id"),h=f.parentElement.getAttribute("data-node-id")||e.block.rootID;g===t.length-1&&(o=getTopAloneElement(f),o.isSameNode(f)?o=void 0:o.contains(f)&&o.contains(n)&&(o=n)),s&&f.getAttribute("data-type")==="NodeHeading"&&f.getAttribute("fold")==="1"&&(f.removeAttribute("fold"),d.push({id:w,parentID:h}));let C,k;if(s?(C=Lute.NewNodeID(),r.push({action:"delete",id:C})):r.push({action:"move",id:w,previousID:(p=f.previousElementSibling)==null?void 0:p.getAttribute("data-node-id"),parentID:h}),!a&&!s){const E=e.wysiwyg.element.querySelector(`[data-node-id="${w}"]`);E&&E.remove()}s?(k=f.cloneNode(!0),k.setAttribute("data-node-id",C),k.querySelectorAll("[data-node-id]").forEach(E=>{const _=Lute.NewNodeID();E.setAttribute("data-node-id",_),E.setAttribute("updated",_.split("-")[0])}),u.insertAdjacentElement(i,k),l.push({action:"insert",id:C,data:k.outerHTML,previousID:i==="afterend"?c:(m=k.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:((y=k.parentElement)==null?void 0:y.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID})):(u.insertAdjacentElement(i,f),l.push({action:"move",id:w,previousID:i==="afterend"?c:(v=f.previousElementSibling)==null?void 0:v.getAttribute("data-node-id"),parentID:((b=f.parentElement)==null?void 0:b.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID})),i!=="afterend"&&(u=s?k:f)}),r.reverse();for(let f=0;f<d.length;f++){const g=d[f];(yield fetchSyncPost("/api/block/getHeadingChildrenIDs",{id:g.id})).data.reverse().forEach(m=>{r.push({action:"move",id:m,previousID:g.id,parentID:g.parentID})}),r.push({action:"foldHeading",id:g.id,data:"remove"}),l.push({action:"unfoldHeading",id:g.id})}return{doOperations:l,undoOperations:r,topSourceElement:o}}),Pa=(e,t,n,a,i,s)=>en(void 0,null,function*(){var o,l,r,d,c,u;const f=e.element.contains(t[0]);let g;t[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(g=document.createElement("div"),g.setAttribute("data-node-id",Lute.NewNodeID()),g.setAttribute("data-type","NodeList"),g.setAttribute("data-subtype",t[0].getAttribute("data-subtype")),g.className="list",g.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`));const p=[{action:"move",id:n.getAttribute("data-node-id"),previousID:(o=n.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:((l=n.parentElement)==null?void 0:l.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}];let m,y=t[0].parentElement;const v=genSBElement(i);n.parentElement.replaceChild(v,n);const b=[{action:"insert",data:v.outerHTML,id:v.getAttribute("data-node-id"),nextID:(r=v.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"),previousID:(d=v.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:v.parentElement.getAttribute("data-node-id")||e.block.parentID||e.block.rootID}];let w=!1;if(g){const h=g.getAttribute("data-node-id");v.insertAdjacentElement("afterbegin",n),b.push({action:"move",id:n.getAttribute("data-node-id"),parentID:v.getAttribute("data-node-id")}),a?(n.insertAdjacentElement("afterend",g),b.push({action:"insert",data:g.outerHTML,id:h,previousID:n.getAttribute("data-node-id")})):(n.insertAdjacentElement("beforebegin",g),b.push({action:"insert",data:g.outerHTML,id:h,nextID:n.getAttribute("data-node-id")})),t.reverse().forEach((C,k)=>{var E;k===t.length-1&&(m=getTopAloneElement(C),m.isSameNode(C)&&(m=void 0));const _=Lute.NewNodeID();if(s?p.push({action:"delete",id:_}):p.push({action:"move",id:C.getAttribute("data-node-id"),previousID:(E=C.previousElementSibling)==null?void 0:E.getAttribute("data-node-id"),parentID:C.parentElement.getAttribute("data-node-id")||e.block.rootID}),!f&&!s){const L=e.wysiwyg.element.querySelector(`[data-node-id="${C.getAttribute("data-node-id")}"]`);L&&L.remove()}if(s){const L=C.cloneNode(!0);L.setAttribute("data-node-id",_),L.querySelectorAll("[data-node-id]").forEach(A=>{const S=Lute.NewNodeID();A.setAttribute("data-node-id",S),A.setAttribute("updated",S.split("-")[0])}),g.insertAdjacentElement("afterbegin",L),b.push({action:"insert",id:_,data:L.outerHTML,parentID:h})}else g.insertAdjacentElement("afterbegin",C),b.push({action:"move",id:C.getAttribute("data-node-id"),parentID:h})}),p.reverse(),p.push({action:"delete",id:h})}else{const h=[];let C;t.reverse().forEach((k,E)=>{var _;const L=k.getAttribute("data-node-id"),A=k.parentElement.getAttribute("data-node-id")||e.block.rootID;E===t.length-1&&(m=getTopAloneElement(k),m.isSameNode(k)&&(m=void 0));const S=Lute.NewNodeID();if(E===0&&(C=s?S:L),k.getAttribute("data-type")==="NodeHeading"&&k.getAttribute("fold")==="1"&&(s&&(k.removeAttribute("fold"),h.push({id:L,parentID:A})),w=!0),s?p.push({action:"delete",id:S}):p.push({action:"move",id:L,previousID:(_=k.previousElementSibling)==null?void 0:_.getAttribute("data-node-id"),parentID:A}),!f&&!s){const I=e.wysiwyg.element.querySelector(`[data-node-id="${L}"]`);I&&I.remove()}if(s){const I=k.cloneNode(!0);I.setAttribute("data-node-id",S),I.querySelectorAll("[data-node-id]").forEach(T=>{const D=Lute.NewNodeID();T.setAttribute("data-node-id",D),T.setAttribute("updated",D.split("-")[0])}),v.insertAdjacentElement("afterbegin",I),b.push({action:"insert",id:S,data:I.outerHTML,parentID:v.getAttribute("data-node-id")})}else v.insertAdjacentElement("afterbegin",k),b.push({action:"move",id:L,parentID:v.getAttribute("data-node-id")})}),p.reverse();for(let k=0;k<h.length;k++){const E=h[k],_=yield fetchSyncPost("/api/block/getHeadingChildrenIDs",{id:E.id});_.data.reverse().forEach(L=>{p.push({action:"move",id:L,previousID:E.id,parentID:E.parentID})}),k===0&&(C=_.data[0]),p.push({action:"foldHeading",id:E.id,data:"remove"}),b.push({action:"unfoldHeading",id:E.id})}a?(v.insertAdjacentElement("afterbegin",n),b.push({action:"move",id:n.getAttribute("data-node-id"),parentID:v.getAttribute("data-node-id")})):(v.lastElementChild.insertAdjacentElement("beforebegin",n),b.push({action:"move",id:n.getAttribute("data-node-id"),previousID:C}))}if(p.push({action:"delete",id:v.getAttribute("data-node-id")}),!s&&y&&y.classList.contains("list")&&y.getAttribute("data-subtype")==="o"&&!y.isSameNode(t[0].parentElement)&&y.childElementCount>1&&(Array.from(y.children).forEach(h=>{h.classList.contains("protyle-attr")||p.splice(0,0,{action:"update",id:h.getAttribute("data-node-id"),data:h.outerHTML})}),updateListOrder(y,1),Array.from(y.children).forEach(h=>{h.classList.contains("protyle-attr")||b.push({action:"update",id:h.getAttribute("data-node-id"),data:h.outerHTML})})),!s&&m){if(b.push({action:"delete",id:m.getAttribute("data-node-id")}),p.splice(0,0,{action:"insert",data:m.outerHTML,id:m.getAttribute("data-node-id"),previousID:(c=m.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:((u=m.parentElement)==null?void 0:u.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),!f){const h=e.wysiwyg.element.querySelector(`[data-node-id="${m.getAttribute("data-node-id")}"]`);h&&h.remove()}y=m.parentElement,m.remove()}if(!s&&y&&y.classList.contains("sb")&&y.childElementCount===2){if(f){const h=cancelSB(e,y);b.push(h.doOperations[0],h.doOperations[1]),p.splice(0,0,h.undoOperations[0],h.undoOperations[1])}}else!s&&y&&y.classList.contains("protyle-wysiwyg")&&y.innerHTML;f||s?transaction(e,b,p):transaction(e,b),!s&&i==="col"&&(n.getAttribute("data-type")==="NodeHeading"&&n.getAttribute("fold")==="1"&&turnsIntoOneTransaction({protyle:e,selectsElement:[n],type:"BlocksMergeSuperBlock",level:"row"}),(t.length>1||w)&&turnsIntoOneTransaction({protyle:e,selectsElement:t.reverse(),type:"BlocksMergeSuperBlock",level:"row"})),focusBlock(t[0])}),Ra=(e,t,n,a,i)=>en(void 0,null,function*(){var s,o;const l=e.element.contains(t[0]),r=[],d=[];let c;t[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(c=document.createElement("div"),c.setAttribute("data-node-id",Lute.NewNodeID()),c.setAttribute("data-type","NodeList"),c.setAttribute("data-subtype",t[0].getAttribute("data-subtype")),c.className="list",c.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`));let u,f=t[0].parentElement;if(a)if(c){const p=Na(e,t,n,c,l,a,i);r.push(...p.doOperations),d.push(...p.undoOperations),u=p.topSourceElement}else{const p=yield Ba(e,t,n,l,"afterend",i);r.push(...p.doOperations),d.push(...p.undoOperations),u=p.topSourceElement}else if(c){const p=Na(e,t,n,c,l,a,i);r.push(...p.doOperations),d.push(...p.undoOperations),u=p.topSourceElement}else{const p=yield Ba(e,t,n,l,"beforebegin",i);r.push(...p.doOperations),d.push(...p.undoOperations),u=p.topSourceElement}if(n.getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-subtype")==="o"&&(Array.from(n.parentElement.children).forEach(p=>{p.classList.contains("protyle-attr")||d.splice(0,0,{action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML})}),updateListOrder(n.parentElement,1),Array.from(n.parentElement.children).forEach(p=>{p.classList.contains("protyle-attr")||r.push({action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML})})),!i&&l&&f&&f.classList.contains("list")&&f.getAttribute("data-subtype")==="o"&&!f.isSameNode(t[0].parentElement)&&f.childElementCount>1&&(Array.from(f.children).forEach(p=>{p.classList.contains("protyle-attr")||(f.contains(n)?d.splice(0,0,{action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML}):d.splice(n.parentElement.childElementCount-1,0,{action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML}))}),updateListOrder(f,1),Array.from(f.children).forEach(p=>{p.classList.contains("protyle-attr")||r.push({action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML})})),!i&&u&&(r.push({action:"delete",id:u.getAttribute("data-node-id")}),d.splice(0,0,{action:"insert",data:u.outerHTML,id:u.getAttribute("data-node-id"),previousID:(s=u.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:((o=u.parentElement)==null?void 0:o.getAttribute("data-node-id"))||e.block.parentID||e.block.rootID}),f=u.parentElement,u.remove(),!l)){const p=e.wysiwyg.element.querySelector(`[data-node-id="${u.getAttribute("data-node-id")}"]`);p&&p.remove()}if(!i&&f&&f.classList.contains("sb")&&f.childElementCount===2){if(l){const p=cancelSB(e,f);r.push(p.doOperations[0],p.doOperations[1]),d.splice(0,0,p.undoOperations[0],p.undoOperations[1])}}else!i&&f&&f.classList.contains("protyle-wysiwyg")&&f.childElementCount;l||i?transaction(e,r,d):transaction(e,r);let g=!1;t.find(p=>{if(p.getAttribute("data-type")==="NodeHeading"&&p.getAttribute("fold")==="1")return g=!0,!0}),!i&&(t.length>1||g)&&t[0].parentElement.classList.contains("sb")&&t[0].parentElement.getAttribute("data-sb-layout")==="col"&&turnsIntoOneTransaction({protyle:e,selectsElement:t.reverse(),type:"BlocksMergeSuperBlock",level:"row"}),focusBlock(t[0])}),ud=(e,t)=>{t.addEventListener("dragstart",s=>{const o=s.target;if(o.tagName==="IMG"){window.siyuan.dragElement=void 0,s.preventDefault();return}if(o.classList){if(hasClosestByClassName(o,"protyle-wysiwyg__embed"))window.siyuan.dragElement=void 0,s.preventDefault();else if(o.classList.contains("protyle-action")){window.siyuan.dragElement=e.wysiwyg.element,s.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}NodeListItem${Constants.ZWSP}${o.parentElement.getAttribute("data-subtype")}${Constants.ZWSP}${[o.parentElement.getAttribute("data-node-id")]}`,e.wysiwyg.element.innerHTML);return}else if(o.classList.contains("av__cell--header")){window.siyuan.dragElement=o,s.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}Col${Constants.ZWSP}${[o.getAttribute("data-col-id")]}`,o.outerHTML);return}}s.dataTransfer.setData(Constants.SIYUAN_DROP_EDITOR,Constants.SIYUAN_DROP_EDITOR),e.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null}),t.addEventListener("drop",s=>en(void 0,null,function*(){var o,l,r,d,c;if(i=0,e.disabled||s.dataTransfer.getData(Constants.SIYUAN_DROP_EDITOR)){s.preventDefault(),s.stopPropagation();return}let u="";for(const g of s.dataTransfer.items)g.type.startsWith(Constants.SIYUAN_DROP_GUTTER)&&(u=g.type);const f=t.querySelector(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top");if(f&&(f.classList.remove("protyle-wysiwyg--select","dragover"),f.removeAttribute("select-start"),f.removeAttribute("select-end")),u){const g=[],p=u.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP),m=p[2].split(",");if(s.altKey||s.shiftKey)if(s.y>e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)insertEmptyBlock(e,"afterend",e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const y=getRangeByPoint(s.clientX,s.clientY);if(hasClosestByAttribute(y.startContainer,"data-type","NodeBlockQueryEmbed"))return;focusByRange(y)}if(s.altKey){let y="";for(let v=0;v<m.length;v++){const b=yield fetchSyncPost("/api/block/getRefText",{id:m[v]});y+=`((${m[v]} '${b.data}')) `}insertHTML(y,e)}else if(s.shiftKey){let y="";m.forEach(v=>{y+=`{{select * from blocks where id='${v}'}}
`}),insertHTML(e.lute.SpinBlockDOM(y),e,!0),blockRender(e,e.wysiwyg.element)}else if(f&&f.className.indexOf("dragover__")>-1){let y="";if(m.forEach(h=>{y+=`[data-node-id="${h}"],`}),window.siyuan.dragElement)window.siyuan.dragElement.querySelectorAll(y.substring(0,y.length-1)).forEach(h=>{isInEmbedBlock(h)||g.push(h)});else{const h=document.createElement("template");h.innerHTML=`<div>${s.dataTransfer.getData(u)}</div>`,h.content.querySelectorAll(y.substring(0,y.length-1)).forEach(C=>{isInEmbedBlock(C)||g.push(C)})}const v=[],b=[];g.forEach(h=>{h.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),h.removeAttribute("select-start"),h.removeAttribute("select-end"),h.querySelectorAll('[data-type="search-mark"]').forEach(k=>{k.outerHTML=k.innerHTML});const C=h.getAttribute("data-node-id");v.push(C),b.push({id:C,isDetached:!1})}),hideElements(["gutter"],e);const w=f.className.split(" ");if(f.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right"),f.classList.contains("av__cell")){const h=hasClosestBlock(f);if(h){const C=h.getAttribute("data-av-id");let k="";w.includes("dragover__left")?f.previousElementSibling&&(f.previousElementSibling.classList.contains("av__colsticky")?k=f.previousElementSibling.lastElementChild.getAttribute("data-col-id"):k=f.previousElementSibling.getAttribute("data-col-id")):k=f.getAttribute("data-col-id");let E="";const _=hasClosestByClassName(f,"av__row");if(_){const L=(o=_.querySelector(`[data-col-id="${p[2]}"`))==null?void 0:o.previousElementSibling;L&&(L.classList.contains("av__colsticky")?E=L.lastElementChild.getAttribute("data-col-id"):E=L.getAttribute("data-col-id"))}k!==E&&k!==p[2]&&transaction(e,[{action:"sortAttrViewCol",avID:C,previousID:k,id:p[2],blockID:h.dataset.nodeId}],[{action:"sortAttrViewCol",avID:C,previousID:E,id:p[2],blockID:h.dataset.nodeId}])}}else if(f.classList.contains("av__row")){const h=hasClosestBlock(f);if(h){let C="";w.includes("dragover__bottom")?C=f.getAttribute("data-id")||"":C=((l=f.previousElementSibling)==null?void 0:l.getAttribute("data-id"))||"";const k=h.getAttribute("data-av-id");if(p[0]==="nodeattributeviewrowmenu"){const E=[],_=[],L=h.querySelector(`.av__row[data-id="${m[0]}"]`).previousElementSibling.getAttribute("data-id")||"";m.reverse().forEach(A=>{C!==A&&L!==C&&(E.push({action:"sortAttrViewRow",avID:k,previousID:C,id:A,blockID:h.dataset.nodeId}),_.push({action:"sortAttrViewRow",avID:k,previousID:L,id:A,blockID:h.dataset.nodeId}))}),transaction(e,E,_)}else{const E=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"insertAttrViewBlock",avID:k,previousID:C,srcs:b,blockID:h.dataset.nodeId},{action:"doUpdateUpdated",id:h.dataset.nodeId,data:E}],[{action:"removeAttrViewBlock",srcIDs:v,avID:k},{action:"doUpdateUpdated",id:h.dataset.nodeId,data:h.getAttribute("updated")}]),h.setAttribute("updated",E),insertAttrViewBlockAnimation(e,h,v,C)}}}else g.length>0&&(f.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&f.parentElement.getAttribute("data-sb-layout")==="col"?w.includes("dragover__left")||w.includes("dragover__right")?Ra(e,g,f,w.includes("dragover__right"),s.ctrlKey):Pa(e,g,f,w.includes("dragover__bottom"),"row",s.ctrlKey):w.includes("dragover__left")||w.includes("dragover__right")?Pa(e,g,f,w.includes("dragover__right"),"col",s.ctrlKey):Ra(e,g,f,w.includes("dragover__bottom"),s.ctrlKey),t.querySelectorAll(".protyle-wysiwyg--empty").forEach(h=>{h.classList.remove("protyle-wysiwyg--empty")}),g.forEach(h=>{h.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(h.removeAttribute("data-render"),blockRender(e,h))}),f.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(f.removeAttribute("data-render"),blockRender(e,f)));n=void 0}}else if(((r=s.dataTransfer.getData(Constants.SIYUAN_DROP_FILE))==null?void 0:r.split("-").length)>1){const g=s.dataTransfer.getData(Constants.SIYUAN_DROP_FILE).split(",");if(s.altKey){if(s.y>e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom)insertEmptyBlock(e,"afterend",e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"));else{const m=getRangeByPoint(s.clientX,s.clientY);if(hasClosestByAttribute(m.startContainer,"data-type","NodeBlockQueryEmbed"))return;focusByRange(m)}let p="";for(let m=0;m<g.length;m++){const y=yield fetchSyncPost("/api/block/getRefText",{id:g[m]});p+=`((${g[m]} '${y.data}')) `}insertHTML(p,e)}else if(f&&!e.options.backlinkData&&f.className.indexOf("dragover__")>-1){const p=e.contentElement.scrollTop;if(f.classList.contains("av__row")){const m=hasClosestBlock(f);if(m){let y="";f.classList.contains("dragover__bottom")?y=f.getAttribute("data-id")||"":y=((d=f.previousElementSibling)==null?void 0:d.getAttribute("data-id"))||"";const v=m.getAttribute("data-av-id"),b=dayjs().format("YYYYMMDDHHmmss"),w=[];g.forEach(h=>{w.push({id:h,isDetached:!1})}),transaction(e,[{action:"insertAttrViewBlock",avID:v,previousID:y,srcs:w,blockID:m.dataset.nodeId},{action:"doUpdateUpdated",id:m.dataset.nodeId,data:b}],[{action:"removeAttrViewBlock",srcIDs:g,avID:v},{action:"doUpdateUpdated",id:m.dataset.nodeId,data:m.getAttribute("updated")}]),insertAttrViewBlockAnimation(e,m,g,y),m.setAttribute("updated",b)}}else{for(let m=0;m<g.length;m++)g[m]&&(yield fetchSyncPost("/api/filetree/doc2Heading",{srcID:g[m],after:f.classList.contains("dragover__bottom"),targetID:f.getAttribute("data-node-id")}));fetchPost("/api/filetree/getDoc",{id:e.block.id,size:window.siyuan.config.editor.dynamicLoadBlocks},m=>{onGet({data:m,protyle:e}),setTimeout(()=>{e.contentElement.scrollTop=p,e.scroll.lastScrollTop=p-1},Constants.TIMEOUT_LOAD)})}f.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right")}}else if(!window.siyuan.dragElement&&(s.dataTransfer.types[0]==="Files"||s.dataTransfer.types.includes("text/html"))){const g=hasClosestByClassName(s.target,"av");if(g){const p=hasClosestByClassName(s.target,"av__cell");if(p&&((c=g.querySelector(`.av__row--header [data-col-id="${p.dataset.colId}"]`))==null?void 0:c.getAttribute("data-dtype"))==="mAsset"&&s.dataTransfer.types[0]==="Files"&&!isBrowser()){const y=[];for(let v=0;v<s.dataTransfer.files.length;v++)y.push(webUtils.getPathForFile(s.dataTransfer.files[v]));dragUpload(y,e,p)}}else if(focusByRange(getRangeByPoint(s.clientX,s.clientY)),s.dataTransfer.types[0]==="Files"&&!isBrowser()){const p=[];for(let m=0;m<s.dataTransfer.files.length;m++)p.push(webUtils.getPathForFile(s.dataTransfer.files[m]));uploadLocalFiles(p,e,!s.altKey)}else paste(e,s)}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}));let n,a;t.addEventListener("dragover",s=>{var o,l,r;if(e.disabled||s.dataTransfer.types.includes(Constants.SIYUAN_DROP_EDITOR)){s.preventDefault(),s.stopPropagation(),s.dataTransfer.dropEffect="none";return}const d=e.contentElement.getBoundingClientRect();if(!hasClosestByClassName(s.target,"av__cell")&&(s.clientY<d.top+Constants.SIZE_SCROLL_TB||s.clientY>d.bottom-Constants.SIZE_SCROLL_TB)&&e.contentElement.scroll({top:e.contentElement.scrollTop+(s.clientY<d.top+Constants.SIZE_SCROLL_TB?-Constants.SIZE_SCROLL_STEP:Constants.SIZE_SCROLL_STEP),behavior:"smooth"}),s.dataTransfer.types.includes("Files")&&s.target.classList.contains("protyle-wysiwyg")){s.preventDefault();return}let c="";for(const p of s.dataTransfer.items)p.type.startsWith(Constants.SIYUAN_DROP_GUTTER)&&(c=p.type);if(!c&&!window.siyuan.dragElement){s.preventDefault();return}if(s.shiftKey||s.altKey){const p=hasClosestBlock(s.target);p&&(p.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),p.removeAttribute("select-start"),p.removeAttribute("select-end")),s.preventDefault();return}s.preventDefault();let u=hasClosestByClassName(s.target,"av__row")||hasClosestByClassName(s.target,"av__row--util")||hasClosestBlock(s.target);const f={x:s.clientX,y:s.clientY,className:""};if(u&&(u.classList.contains("bq")||u.classList.contains("sb")||u.classList.contains("list")||u.classList.contains("li"))){let p=hasClosestBlock(document.elementFromPoint(f.x,f.y-6));for(;p&&u.contains(p);)(o=p.nextElementSibling)!=null&&o.getAttribute("data-node-id")&&(u=p),p=p.parentElement}if(u)u&&u.classList.contains("list")&&(c&&c.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP)[0]!=="nodelistitem"?u=hasClosestBlock(document.elementFromPoint(s.clientX,s.clientY-6)):u=hasClosestByClassName(document.elementFromPoint(s.clientX,s.clientY-6),"li"));else if(s.clientY>t.lastElementChild.getBoundingClientRect().bottom)u=t.lastElementChild,f.className="dragover__bottom";else if(s.clientY<t.firstElementChild.getBoundingClientRect().top)u=t.firstElementChild,f.className="dragover__top";else if(d){const p={left:d.left+parseInt(t.style.paddingLeft),right:d.left+e.contentElement.clientWidth-parseInt(t.style.paddingRight)};s.clientX<p.left?(f.x=p.left,f.className="dragover__left"):s.clientX>=p.right&&(f.x=p.right-6,f.className="dragover__right"),u=document.elementFromPoint(f.x,f.y),u.classList.contains("protyle-wysiwyg")&&(u=document.elementFromPoint(f.x,f.y-6)),u=hasTopClosestByAttribute(u,"data-node-id",null)}if(c&&c.startsWith(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${Constants.ZWSP}Col${Constants.ZWSP}`.toLowerCase())){if(u=hasClosestByClassName(s.target,"av__cell"),u){const p=hasClosestByClassName(u,"av__row--header"),m=hasClosestByClassName(window.siyuan.dragElement,"av__row--header");(u.isSameNode(window.siyuan.dragElement)||!p||!m||p&&m&&!p.isSameNode(m))&&(u=!1)}}else u&&c&&c.startsWith(`${Constants.SIYUAN_DROP_GUTTER}NodeAttributeViewRowMenu${Constants.ZWSP}`.toLowerCase())&&(!u.classList.contains("av__row")&&!u.classList.contains("av__row--util")||!window.siyuan.dragElement.contains(u))&&(u=!1);if(!u)return;const g=s.dataTransfer.types.includes(Constants.SIYUAN_DROP_FILE)&&window.siyuan.dragElement?window.siyuan.dragElement.innerText:"";if(u&&n&&u.isSameNode(n)){const p=u.getBoundingClientRect();if(t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(m=>{m.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),m.removeAttribute("select-start"),m.removeAttribute("select-end")}),u.getAttribute("data-type")==="NodeAttributeView"&&hasClosestByTag(s.target,"TD"))return;if(f.className){u.classList.add(f.className),rt(u);return}if(u.getAttribute("data-type")==="NodeListItem"||g.indexOf("-")>-1){s.clientY>p.top+p.height/2?(u.classList.add("dragover__bottom"),rt(u)):u.classList.contains("av__row--header")||(u.classList.add("dragover__top"),rt(u));return}if(u.classList.contains("av__cell")){s.clientX<p.left+p.width/2&&s.clientX>p.left&&!u.classList.contains("av__row")&&!u.previousElementSibling.isSameNode(window.siyuan.dragElement)?u.classList.add("dragover__left"):s.clientX>p.right-p.width/2&&s.clientX<=p.right+1&&!u.classList.contains("av__row")&&!u.isSameNode(window.siyuan.dragElement.previousElementSibling)&&(window.siyuan.dragElement.previousElementSibling.classList.contains("av__colsticky")&&u.isSameNode(window.siyuan.dragElement.previousElementSibling.lastElementChild)||u.classList.add("dragover__right"));return}s.clientX<p.left+32&&s.clientX>=p.left-1&&!u.classList.contains("av__row")?(u.classList.add("dragover__left"),rt(u)):s.clientX>p.right-32&&s.clientX<p.right&&!u.classList.contains("av__row")?(u.classList.add("dragover__right"),rt(u)):u.classList.contains("av__row--header")?u.classList.add("dragover__bottom"):u.classList.contains("av__row--util")?u.previousElementSibling.classList.add("dragover__bottom"):s.clientY>p.top+p.height/2&&a!=="bottom"?(u.classList.add("dragover__bottom"),rt(u)):a!=="top"&&(u.classList.add("dragover__top"),rt(u));return}if(g.indexOf("-")>-1){g.split(",").includes(e.block.rootID)&&!u.classList.contains("av__row")?n=void 0:n=u;return}if(c){a="",n&&(n.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover"),n=void 0);const p=c.replace(Constants.SIYUAN_DROP_GUTTER,"").split(Constants.ZWSP);if(p[0]==="nodeattributeview"&&p[1]==="col"&&u.getAttribute("data-id")===p[2]||p[0]==="nodeattributeviewrowmenu"&&p[2]===u.getAttribute("data-id")||p[2].split(",").find(y=>{if(y&&hasClosestByAttribute(u,"data-node-id",y))return!0})||isInEmbedBlock(u)||p[0]==="nodelistitem"&&p[1]!==u.getAttribute("data-subtype")&&u.getAttribute("data-type")==="NodeListItem"||p[0]!=="nodelistitem"&&u.getAttribute("data-type")==="NodeListItem")return;p[0]==="nodelistitem"&&u.parentElement.classList.contains("li")&&((l=u.previousElementSibling)!=null&&l.classList.contains("protyle-action"))&&(a="top"),p[0]==="nodelistitem"&&((r=u.nextElementSibling)!=null&&r.classList.contains("list"))&&(a="bottom"),u&&u.classList.contains("av__row--header")&&(a="top"),n=u}});let i=0;t.addEventListener("dragleave",s=>{if(e.disabled){s.preventDefault(),s.stopPropagation();return}i--,i===0&&(t.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top, .dragover").forEach(o=>{o.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","dragover")}),n=void 0)}),t.addEventListener("dragenter",s=>{s.preventDefault(),i++})},rt=e=>{(e.classList.contains("sb")||e.classList.contains("li")||e.classList.contains("list")||e.classList.contains("bq"))&&e.classList.add("dragover")},fd=(e,t,n)=>{var a;if(hasClosestByClassName(e,"protyle-wysiwyg__embed"))return;const i=isNotEditBlock(e);if(!i&&e.classList.contains("protyle-wysiwyg--select")){setLastNodeRange(getContenteditableElement(e),t,!1),t.collapse(!1),hideElements(["select"],n);return}if(i||e.classList.contains("table")){if(e.parentElement.classList.contains("li")){const h=e.parentElement.parentElement.outerHTML,C=genListItemElement(e.parentElement,0,!0);e.parentElement.insertAdjacentElement("afterend",C),updateTransaction(n,e.parentElement.parentElement.getAttribute("data-node-id"),e.parentElement.parentElement.outerHTML,h),focusByWbr(C,t),Nt(C),scrollCenter(n);return}if(e.classList.contains("hr")){insertEmptyBlock(n,"afterend");return}e.classList.contains("protyle-wysiwyg--select")&&e.classList.contains("render-node")?n.toolbar.showRender(n,e):insertEmptyBlock(n,"afterend");return}const s=getContenteditableElement(e);if(s.querySelectorAll(".img--select").forEach(h=>{h.classList.remove("img--select")}),e.getAttribute("data-type")==="NodeAttributeView")return!0;const o=s.innerHTML.trimStart();if((o.startsWith("```")||o.startsWith("\xB7\xB7\xB7")||o.startsWith("~~~")||o.indexOf("\n```")>-1||o.indexOf(`
~~~`)>-1||o.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(o.indexOf(`
`)===-1&&o.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){if(e.classList.contains("p")){const h=e.outerHTML;let C=s.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");C.endsWith("\n```")||(C+="<wbr>\n```"),s.innerHTML=C,e.outerHTML=n.lute.SpinBlockDOM(e.outerHTML),e=n.wysiwyg.element.querySelector(`[data-node-id="${e.getAttribute("data-node-id")}"]`);const k=e.querySelector(".protyle-action__language");return k?(window.siyuan.storage[Constants.LOCAL_CODELANG]&&k.textContent===""?k.textContent=window.siyuan.storage[Constants.LOCAL_CODELANG]:Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(k.textContent)||(window.siyuan.storage[Constants.LOCAL_CODELANG]=k.textContent,setStorageVal(Constants.LOCAL_CODELANG,window.siyuan.storage[Constants.LOCAL_CODELANG])),Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(k.textContent)?(e.dataset.content="",e.dataset.subtype=k.textContent,e.className="render-node",e.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,n.toolbar.showRender(n,e),processRender(e)):highlightRender(e)):(n.toolbar.showRender(n,e),processRender(e)),updateTransaction(n,e.getAttribute("data-node-id"),e.outerHTML,h),!0}}if(e.getAttribute("data-type")==="NodeCodeBlock"){const h=document.createElement("wbr");t.insertNode(h);const C=e.outerHTML;return h.remove(),t.extractContents(),s.textContent.endsWith(`
`)||s.insertAdjacentText("beforeend",`
`),t.insertNode(document.createTextNode(`
`)),t.collapse(!1),t.insertNode(h),s.parentElement.removeAttribute("data-render"),highlightRender(e),updateTransaction(n,e.getAttribute("data-node-id"),e.outerHTML,C),!0}if(s.textContent.replace(Constants.ZWSP,"").replace(`
`,"")===""&&e.nextElementSibling&&e.nextElementSibling.classList.contains("protyle-attr")&&e.parentElement.getAttribute("data-type")==="NodeBlockquote"){t.insertNode(document.createElement("wbr"));const h=getTopEmptyElement(e),C=e.getAttribute("data-node-id"),k=h.getAttribute("data-node-id"),E={action:"insert",id:C,data:e.outerHTML},_={action:"insert",id:k,data:h.outerHTML};return k===C?(E.previousID=e.parentElement.getAttribute("data-node-id"),_.previousID=e.previousElementSibling.getAttribute("data-node-id"),e.parentElement.after(e)):(E.previousID=h.previousElementSibling?h.previousElementSibling.getAttribute("data-node-id"):void 0,E.parentID=h.parentElement.getAttribute("data-node-id")||n.block.parentID,_.previousID=E.previousID,_.parentID=E.parentID,h.after(e),h.remove()),transaction(n,[{action:"delete",id:k},E],[{action:"delete",id:C},_]),focusByWbr(e,t),!0}const l=getSelectionOffset(s,n.wysiwyg.element,t);if(e.parentElement.getAttribute("data-type")==="NodeListItem"&&(e.nextElementSibling.classList.contains("protyle-attr")||e.nextElementSibling.classList.contains("list")&&((a=e.previousElementSibling)!=null&&a.classList.contains("protyle-action"))||l.start===0&&e.previousElementSibling.classList.contains("protyle-action")||e.parentElement.getAttribute("fold")==="1")&&Yi(n,e,t))return!0;if(s.textContent!==""&&t.toString()===""&&l.start===0){const h=genEmptyElement(!1,!0),C=h.getAttribute("data-node-id");return transaction(n,[{action:"insert",data:h.outerHTML,id:C,previousID:e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):"",parentID:e.parentElement.getAttribute("data-node-id")||n.block.parentID}],[{action:"delete",id:C}]),h.querySelector("wbr").remove(),e.insertAdjacentElement("beforebegin",h),Nt(h),!0}const r=document.createElement("wbr");t.insertNode(r);const d=e.outerHTML;if(r.remove(),t.toString()!==""){const h=hasClosestByAttribute(t.startContainer,"data-type","inline-math");if(h){const C=hasNextSibling(h);return C&&(t=getSelection().getRangeAt(0),t.setEnd(C,C.textContent.startsWith(Constants.ZWSP)?1:0),t.collapse(!1)),!0}t.extractContents()}s.lastChild&&t.setEndAfter(s.lastChild);const c=e.getAttribute("data-node-id"),u=document.createElement("div");u.appendChild(genEmptyElement(!1,!1));const f=u.querySelector('[contenteditable="true"]');f.appendChild(t.extractContents());const g=f.innerHTML.trimStart();if((g.startsWith("```")||g.startsWith("\xB7\xB7\xB7")||g.startsWith("~~~")||g.indexOf("\n```")>-1||g.indexOf(`
~~~`)>-1||g.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(g.indexOf(`
`)===-1&&g.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let h=f.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");h.endsWith("\n```")||(h+="\n```"),f.innerHTML=h}u.innerHTML=n.lute.SpinBlockDOM(u.innerHTML);const p=document.createElement("div");p.innerHTML=n.lute.SpinBlockDOM(s.parentElement.outerHTML);const m=[],y=[];let v=e;const b=[];Array.from(p.children).forEach(h=>{h.dataset.nodeId===c?(e.before(h),e.remove(),m.push({action:"update",data:h.outerHTML,id:c}),y.push({action:"update",data:d,id:c})):(m.push({action:"insert",data:h.outerHTML,id:h.dataset.nodeId,nextID:c}),v.insertAdjacentElement("afterend",h),y.push({action:"delete",id:h.dataset.nodeId})),mathRender(h),v=h,b.push(h)}),Array.from(u.children).forEach(h=>{const C=h.getAttribute("data-node-id");m.push({action:"insert",data:h.outerHTML,id:C,previousID:v.getAttribute("data-node-id")}),y.push({action:"delete",id:C}),v.insertAdjacentElement("afterend",h),h.classList.contains("code-block")?highlightRender(h):mathRender(v.nextElementSibling),v=h,b.push(h)});const w=v.parentElement;return transaction(n,m,y),w.classList.contains("sb")&&w.getAttribute("data-sb-layout")==="col"&&turnsIntoOneTransaction({protyle:n,selectsElement:b,type:"BlocksMergeSuperBlock",level:"row"}),focusBlock(v),scrollCenter(n),!0},Yi=(e,t,n)=>{var a,i,s;const o=t.parentElement,l=getContenteditableElement(t);if(["",`
`].includes(l.textContent)&&t.previousElementSibling.classList.contains("protyle-action")&&!t.querySelector("img")){if((a=o.nextElementSibling)!=null&&a.classList.contains("protyle-attr"))return listOutdent(e,[t.parentElement],n),!0;if(!o.parentElement.classList.contains("protyle-wysiwyg"))return breakList(e,t,n),!0}const r=getSelectionOffset(l,e.wysiwyg.element,n);if(n.toString()===""&&r.start===0&&!hasPreviousSibling(n.startContainer)){if(o.parentElement.classList.contains("protyle-wysiwyg"))return!0;const p=document.createElement("wbr");n.insertNode(p);const m=o.parentElement.outerHTML;p.remove();let y=genListItemElement(o,-1,!0);if(t.previousElementSibling.classList.contains("protyle-action"))getContenteditableElement(t).textContent===""?o.insertAdjacentElement("afterend",y):o.insertAdjacentElement("beforebegin",y);else{if(getContenteditableElement(t).textContent!=="")return!1;t.remove(),y=genListItemElement(o,-1,!0),o.insertAdjacentElement("afterend",y)}return o.getAttribute("data-subtype")==="o"&&updateListOrder(o.parentElement),updateTransaction(e,o.parentElement.getAttribute("data-node-id"),o.parentElement.outerHTML,m),focusByWbr(y,n),scrollCenter(e),Nt(y),!0}const d=o.querySelector(".list");let c;if(d&&o.getAttribute("fold")!=="1"&&t.nextElementSibling.isSameNode(d)){if(r.end>=l.textContent.length-(l.textContent.endsWith(Constants.ZWSP)?1:0)){n.insertNode(document.createElement("wbr"));const p=d.outerHTML;t.querySelector("wbr").remove(),c=genListItemElement(d.firstElementChild,-1,!0),d.firstElementChild.before(c),d.getAttribute("data-subtype")==="o"&&updateListOrder(d),updateTransaction(e,d.getAttribute("data-node-id"),d.outerHTML,p),focusByWbr(o,n),scrollCenter(e)}else{n.insertNode(document.createElement("wbr"));const p=o.outerHTML,m=o.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(l.lastChild),c=genListItemElement(o,0,!1);const y=getContenteditableElement(c);y.appendChild(n.extractContents()),y.parentElement.after(d),o.insertAdjacentElement("afterend",c),o.getAttribute("data-subtype")==="o"&&updateListOrder(o.parentElement),o.parentElement.classList.contains("protyle-wysiwyg")?transaction(e,[{action:"update",data:o.outerHTML,id:o.getAttribute("data-node-id")},{action:"insert",id:c.getAttribute("data-node-id"),data:c.outerHTML,previousID:o.getAttribute("data-node-id")}],[{action:"delete",id:c.getAttribute("data-node-id")},{action:"update",data:p,id:o.getAttribute("data-node-id")}]):updateTransaction(e,o.parentElement.getAttribute("data-node-id"),o.parentElement.outerHTML,m),focusByWbr(c,n),scrollCenter(e)}return Nt(c),!0}if((n.toString()===""||n.toString()===Constants.ZWSP)&&n.startContainer.nodeType===3&&n.startOffset===0){let p=n.startContainer;for(;p;)if(p.textContent===Constants.ZWSP){n.setStart(p,1),n.collapse(!1);break}else p=p.nextSibling}n.insertNode(document.createElement("wbr"));const u=o.outerHTML,f=o.parentElement.outerHTML;if(n.toString()!==""){const p=hasClosestByAttribute(n.startContainer,"data-type","inline-math");if(p){const m=hasNextSibling(p);return m&&(n=getSelection().getRangeAt(0),n.setEnd(m,m.textContent.startsWith(Constants.ZWSP)?1:0),n.collapse(!1)),!0}n.extractContents(),n.insertNode(document.createElement("wbr"))}n.setEndAfter(l.lastChild),c=genListItemElement(o,0,!1);const g=n.extractContents();return g.firstChild.nodeType!==3&&g.firstChild.textContent===""&&(g.firstChild.after(document.createElement("wbr")),g.firstChild.remove()),(((i=l==null?void 0:l.lastElementChild)==null?void 0:i.getAttribute("data-type"))||"").indexOf("inline-math")>-1&&!hasNextSibling(l==null?void 0:l.lastElementChild)&&l.insertAdjacentText("beforeend",`
`),(s=l==null?void 0:l.lastElementChild)!=null&&s.classList.contains("img")&&!hasNextSibling(l==null?void 0:l.lastElementChild)&&l.insertAdjacentText("beforeend",Constants.ZWSP),getContenteditableElement(c).appendChild(g),o.insertAdjacentElement("afterend",c),o.getAttribute("data-subtype")==="o"&&updateListOrder(o.parentElement),o.parentElement.classList.contains("protyle-wysiwyg")?transaction(e,[{action:"update",id:o.getAttribute("data-node-id"),data:o.outerHTML},{action:"insert",id:c.getAttribute("data-node-id"),data:c.outerHTML,previousID:o.getAttribute("data-node-id")}],[{action:"delete",id:c.getAttribute("data-node-id")},{action:"update",id:o.getAttribute("data-node-id"),data:u}]):updateTransaction(e,o.parentElement.getAttribute("data-node-id"),o.parentElement.outerHTML,f),focusByWbr(c,n),scrollCenter(e),Nt(c),!0},Nt=e=>{const t=getContenteditableElement(e).childNodes;for(let n=0;n<t.length;n++)t[n].nodeType===3&&t[n].textContent.length===0&&(t[n].remove(),n--)},gd=(e,t,n)=>{let a=e.startContainer;const i=hasNextSibling(a);if(i&&i.nodeType!==3&&i.classList.contains("img")){i.insertAdjacentHTML("beforebegin","<wbr>");const s=t.outerHTML;i.previousElementSibling.remove();const o=document.createTextNode(`
`);return a.after(document.createTextNode(Constants.ZWSP)),a.after(o),e.selectNode(o),e.collapse(!1),updateTransaction(n,t.getAttribute("data-node-id"),t.outerHTML,s),!0}if(a.nodeType===3&&(a=a.parentElement),a&&n.toolbar.getCurrentType(e).length>0&&getSelectionOffset(a,a,e).end===a.textContent.length)return Oa(e,t,n,a),!0;if(isIPad()||isMobile()){a=e.startContainer;const s=hasNextSibling(a);return s&&s.textContent.trim()!==""?(document.execCommand("insertHTML",!1,`
`),!0):(Oa(e,t,n,a),!0)}return!1},Oa=(e,t,n,a)=>{const i=document.createElement("wbr");a.nodeType===3?e.insertNode(i):a.insertAdjacentElement("afterend",i);const s=t.outerHTML;i.remove();let o;hasNextSibling(a)||(o=document.createTextNode(`
`),a.after(o));const l=document.createTextNode(`
`);a.after(l),o?e.setStart(o,0):e.setStart(l,1),e.collapse(!0),focusByRange(e),updateTransaction(n,t.getAttribute("data-node-id"),t.outerHTML,s)};class Bt{constructor(t,n){this.element=document.createElement("button");const a=n.hotkey?` ${vn(n.hotkey)}`:"",i=n.tip||window.siyuan.languages[n.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${n.tipPosition}`),this.element.setAttribute("data-type",n.name),this.element.setAttribute("aria-label",i+a),this.element.innerHTML=`<svg><use xlink:href="#${n.icon}"></use></svg>`,!["text","a","block-ref","inline-math","inline-memo"].includes(n.name)&&this.element.addEventListener(ii(),s=>{s.preventDefault(),x.INLINE_TYPE.includes(n.name)?t.toolbar.setInlineMark(t,n.name,"toolbar"):n.click&&n.click(t.getInstance())})}}class pd extends Bt{constructor(t,n){super(t,n),this.element.addEventListener("click",()=>{t.toolbar.element.classList.add("fn__none"),t.toolbar.subElement.innerHTML="",t.toolbar.subElement.style.width="",t.toolbar.subElement.style.padding="",t.toolbar.subElement.append(Ui(t,Wi(t))),t.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),t.toolbar.subElement.classList.remove("fn__none"),t.toolbar.subElementCloseCB=void 0,Re(t.toolbar.range)})}}const Ui=(e,t)=>{let n="";["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(c=>{n+=`<button class="color__square" data-type="color" style="color:${c}">A</button>`});let a="";["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(c=>{a+=`<button class="color__square" data-type="backgroundColor" style="background-color:${c}"></button>`});const i=document.createElement("div");i.classList.add("protyle-font");let s=!1;t==null||t.find(c=>{if(c.classList.contains("list")||c.classList.contains("li"))return s=!0,!0});let o="";const l=window.siyuan.storage[x.LOCAL_FONTSTYLES];l.length>0&&(o=`<div class="fn__flex">
    ${window.siyuan.languages.lastUsed}
    <span class="fn__space"></span>
    <kbd class="ft__on-surface fn__flex-center">${vn(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</kbd>
</div>
<div class="fn__hr--small"></div>
<div class="fn__flex" style="align-items: center">`,l.forEach(c=>{const u=c.split(x.ZWSP);switch(u[0]){case"color":o+=`<button class="color__square" data-type="${u[0]}" style="color:${u[1]}">A</button>`;break;case"backgroundColor":o+=`<button class="color__square" data-type="${u[0]}" style="background-color:${u[1]}"></button>`;break;case"style2":o+=`<button data-type="${u[0]}" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":o+=`<button data-type="${u[0]}" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>`;break;case"fontSize":s||(o+=`<button data-type="${u[0]}" class="protyle-font__style">${u[1]}</button>`);break;case"style1":o+=`<button data-type="${u[0]}" style="background-color:${u[1]};color:${u[2]}" class="color__square">A</button>`;break;case"clear":o+=`<button data-type="${u[0]}" class="protyle-font__style">${window.siyuan.languages.clearFontStyle}</button>`;break}}),o+="</div>");let r,d="16px";return t&&t.length>0?r=t[0]:(r=e.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=O(e.toolbar.range.startContainer,"data-type","text"))),r&&(d=r.style.fontSize||"16px"),i.innerHTML=`${o}
<div class="fn__hr"></div>
<div>${window.siyuan.languages.color}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button class="color__square" data-type="style1" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</button>
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorFont}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    ${n}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorPrimary}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    ${a}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.fontStyle}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>
    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>
</div>
<div class="fn__hr${s?" fn__none":""}"></div>
<div class="${s?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="fn__hr--small${s?" fn__none":""}"></div>
<div class="fn__flex${s?" fn__none":""}">
    <select class="b3-select fn__block">
        <option ${d==="12px"?"selected":""} value="12px">12px</option>
        <option ${d==="13px"?"selected":""} value="13px">13px</option>
        <option ${d==="14px"?"selected":""} value="14px">14px</option>
        <option ${d==="15px"?"selected":""} value="15px">15px</option>
        <option ${d==="16px"?"selected":""} value="16px">16px</option>
        <option ${d==="19px"?"selected":""} value="19px">19px</option>
        <option ${d==="22px"?"selected":""} value="22px">22px</option>
        <option ${d==="24px"?"selected":""} value="24px">24px</option>
        <option ${d==="29px"?"selected":""} value="29px">29px</option>
        <option ${d==="32px"?"selected":""} value="32px">32px</option>
        <option ${d==="40px"?"selected":""} value="40px">40px</option>
        <option ${d==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>
<div class="fn__hr"></div>
<button class="b3-button b3-button--cancel" data-type="clear">
    <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.clearFontStyle}
</button>`,i.addEventListener("click",function(c){let u=c.target;for(;u&&!u.isEqualNode(i);){const f=u.getAttribute("data-type");if(u.tagName==="BUTTON"){f==="style1"?Et(e,t,f,u.style.backgroundColor+x.ZWSP+u.style.color):f==="fontSize"?Et(e,t,f,u.textContent.trim()):f==="backgroundColor"?Et(e,t,f,u.style.backgroundColor):f==="color"?Et(e,t,f,u.style.color):Et(e,t,f);break}u=u.parentElement}}),i.querySelector("select").addEventListener("change",function(c){Et(e,t,"fontSize",c.target.value)}),i},Et=(e,t,n,a)=>{let i=window.siyuan.storage[x.LOCAL_FONTSTYLES];if(n)i.splice(0,0,`${n}${x.ZWSP}${a}`),i=[...new Set(i)],i.length>8&&i.splice(8,1),window.siyuan.storage[x.LOCAL_FONTSTYLES]=i,wa(x.LOCAL_FONTSTYLES,window.siyuan.storage[x.LOCAL_FONTSTYLES]);else if(i.length===0)n="style1",a="var(--b3-card-error-color)"+x.ZWSP+"var(--b3-card-error-background)";else{const s=i[0].split(x.ZWSP);n=s.splice(0,1)[0],a=s.join(x.ZWSP)}t&&t.length>0?(rl(t,e,s=>{if(n==="clear")s.style.color="",s.style.webkitTextFillColor="",s.style.webkitTextStroke="",s.style.textShadow="",s.style.backgroundColor="",s.style.fontSize="",s.classList.contains("av")&&s.querySelector(".av__container").setAttribute("style","--av-background:var(--b3-theme-background)");else if(n==="style1"){const o=a.split(x.ZWSP);s.style.backgroundColor=o[0],s.style.color=o[1],s.classList.contains("av")&&s.querySelector(".av__container").setAttribute("style",`--av-background:${o[0]}`)}else n==="style2"?(s.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",s.style.webkitTextFillColor="transparent"):n==="style4"?s.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)":n==="color"?s.style.color=a:n==="backgroundColor"?(s.style.backgroundColor=a,s.classList.contains("av")&&s.querySelector(".av__container").setAttribute("style",`--av-background:${a}`)):n==="fontSize"&&(s.style.fontSize=a);(n==="fontSize"||n==="clear")&&s.getAttribute("data-type")==="NodeCodeBlock"&&zs(s.querySelector(".hljs"))}),Re(e.toolbar.range)):n==="clear"?e.toolbar.setInlineMark(e,"clear","range",{type:"text"}):e.toolbar.setInlineMark(e,"text","range",{type:n,color:a})},md=(e,t)=>{const n=s=>{const o=s.split(Constants.ZWSP);e.setAttribute("data-id",o.splice(0,1)[0]),e.setAttribute("data-subtype",o.splice(0,1)[0]),e.removeAttribute("data-href"),e.innerText=o.join("")},a=s=>{const o=s.split(Constants.ZWSP);e.setAttribute("data-href",o[0]),e.removeAttribute("data-subtype"),e.removeAttribute("data-id"),o[1]&&(e.textContent=o[1])},i=s=>{const o=s.split(Constants.ZWSP);e.setAttribute("data-id",o[0]),e.removeAttribute("data-href"),e.removeAttribute("data-subtype"),o[1]&&(e.textContent=o[1])};if(t)switch(t.type){case"color":e.style.color=t.color;break;case"fontSize":e.style.fontSize=t.color;break;case"backgroundColor":e.style.backgroundColor=t.color;break;case"style1":e.style.backgroundColor=t.color.split(Constants.ZWSP)[0],e.style.color=t.color.split(Constants.ZWSP)[1];break;case"style2":e.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",e.style.webkitTextFillColor="transparent";break;case"style4":e.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";break;case"id":n(t.color);break;case"inline-math":e.className="render-node",e.setAttribute("contenteditable","false"),e.setAttribute("data-subtype","math"),e.setAttribute("data-content",e.textContent.replace(Constants.ZWSP,"")),e.removeAttribute("data-render"),e.textContent="";break;case"a":a(t.color);break;case"file-annotation-ref":i(t.color);break;case"inline-memo":e.removeAttribute("contenteditable"),e.removeAttribute("data-subtype"),e.removeAttribute("data-content");break}},bd=(e,t,n)=>{if(!n)return!0;if(n.type==="inline-math"||n.type==="inline-memo"||n.type==="a")return!1;if(n.type==="id"){if(e.nodeType!==3)return e.getAttribute("data-id")===t.getAttribute("data-id")&&e.getAttribute("data-subtype")===t.getAttribute("data-subtype")&&e.textContent===t.textContent;const d=n.color.split(Constants.ZWSP);return d[0]===t.getAttribute("data-id")&&d[1]===t.getAttribute("data-subtype")&&d[2]===t.textContent}if(n.type==="file-annotation-ref")return e.nodeType!==3?e.getAttribute("data-id")===t.getAttribute("data-id")&&e.textContent===t.textContent:n.color===t.getAttribute("data-id");let a="",i="",s="",o="",l="",r="";return e.nodeType!==3&&(a=e.style.color,i=e.style.webkitTextFillColor,s=e.style.webkitTextStroke,o=e.style.textShadow,l=e.style.backgroundColor,r=e.style.fontSize),n.type==="text"?a===t.style.color&&i===t.style.webkitTextFillColor&&s===t.style.webkitTextStroke&&o===t.style.textShadow&&r===t.style.fontSize&&l===t.style.backgroundColor:n.type==="color"?n.color===t.style.color&&i===t.style.webkitTextFillColor&&s===t.style.webkitTextStroke&&o===t.style.textShadow&&r===t.style.fontSize&&l===t.style.backgroundColor:n.type==="backgroundColor"?a===t.style.color&&i===t.style.webkitTextFillColor&&s===t.style.webkitTextStroke&&o===t.style.textShadow&&r===t.style.fontSize&&n.color===t.style.backgroundColor:n.type==="style1"?n.color.split(Constants.ZWSP)[0]===t.style.color&&i===t.style.webkitTextFillColor&&s===t.style.webkitTextStroke&&o===t.style.textShadow&&r===t.style.fontSize&&n.color.split(Constants.ZWSP)[1]===t.style.backgroundColor:n.type==="style2"?a===t.style.color&&t.style.webkitTextFillColor==="transparent"&&t.style.webkitTextStroke==="0.2px var(--b3-theme-on-background)"&&o===t.style.textShadow&&r===t.style.fontSize&&l===t.style.backgroundColor:n.type==="style4"?a===t.style.color&&i===t.style.webkitTextFillColor&&s===t.style.webkitTextStroke&&r===t.style.fontSize&&t.style.textShadow==="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)"&&l===t.style.backgroundColor:n.type==="fontSize"?a===t.style.color&&i===t.style.webkitTextFillColor&&s===t.style.webkitTextStroke&&o===t.style.textShadow&&n.color===t.style.fontSize&&l===t.style.backgroundColor:!0},Wi=e=>{let t;if(e.toolbar.range.toString()===""&&(t=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),t.length===0)){const n=R(e.toolbar.range.startContainer);n&&(t=[n])}return t},hd=(e,t,n)=>{if(!e){t.innerHTML="";return}fetchPost("/api/template/render",{id:n,path:e,preview:!0},a=>{t.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${a.data.content.replace(/contenteditable="true"/g,"")}</div>`})},qa=(e,t,n=!0)=>{if(!e.getAttribute("data-type")||!t.getAttribute("data-type"))return!1;e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim()),t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim());const a=e.attributes;let i=!0;for(let s=0;s<a.length;s++)t.getAttribute(a[s].name)!==a[s].value&&(i=!1);return i&&(n?e.innerHTML=e.innerHTML+t.innerHTML:e.innerHTML=t.innerHTML+e.innerHTML,t.remove()),i},yd=e=>{let t=e.previousSibling;for(;t&&t.nodeType!==3&&qa(e,t,!1);)t=e.previousSibling;let n=e.nextSibling;for(;n&&n.nodeType!==3&&qa(e,n);)n=e.nextSibling;(e.getAttribute("data-type")||"").includes("search-mark")&&e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim())},ji=(e,t,n)=>{const a=e.getAttribute("data-type").split(" ");if(a.length===1){const i=e.parentElement;e.outerHTML=e.innerHTML.replace(x.ZWSP,"")+"<wbr>",n&&Kt(i,n)}else a.find((i,s)=>{if(t===i)return a.splice(s,1),!0}),e.setAttribute("data-type",a.join(" ")),t==="a"?e.removeAttribute("data-href"):t==="file-annotation-ref"?e.removeAttribute("data-id"):t==="block-ref"&&(e.removeAttribute("data-id"),e.removeAttribute("data-subtype")),n&&(n.selectNodeContents(e),n.collapse(!1),Re(n))},wd=(e,t,n)=>{var a,i,s,o,l;if(!t.classList.contains("av")||!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(e.isComposing)return!0;if(matchHotKey("\u2318B",e)||matchHotKey("\u2318I",e)||matchHotKey("\u2318U",e))return e.preventDefault(),!0;const r=t.querySelector(".av__cell--select");if(r){const c=hasClosestByClassName(r,"av__row");if(!c)return!1;const u=document.querySelector(".av__panel");if(u&&(e.key==="Backspace"||e.key==="Delete"||e.key==="Escape"||e.key.startsWith("ArrowLeft")||e.key==="Enter"||matchHotKey("\u21E5",e)||matchHotKey("\u21E7\u21E5",e)))return u.remove(),e.preventDefault(),e.stopPropagation(),!0;if(e.key==="Backspace"||e.key==="Delete")return updateCellsValue(n,t,void 0,Array.from(t.querySelectorAll(".av__cell--active, .av__cell--select"))),e.preventDefault(),!0;if(e.key==="Escape")return r.classList.remove("av__cell--select","av__cell--active"),(a=r.querySelector(".av__drag-fill"))==null||a.remove(),selectRow(c.querySelector(".av__firstcol"),"select"),e.preventDefault(),!0;if(e.key==="Enter")return popTextCell(n,[r]),e.preventDefault(),!0;let f;if(e.key==="ArrowLeft"||matchHotKey("\u21E7\u21E5",e)){const g=c.previousElementSibling;if(r.previousElementSibling&&!r.previousElementSibling.classList.contains("av__firstcol"))r.previousElementSibling.classList.contains("av__cell")?f=r.previousElementSibling:f=r.previousElementSibling.lastElementChild;else if(g&&!g.classList.contains("av__row--header")){const p=g.querySelectorAll(".av__cell");f=p[p.length-1]}return f&&(r.classList.remove("av__cell--select","av__cell--active"),(i=r.querySelector(".av__drag-fill"))==null||i.remove(),f.classList.add("av__cell--select"),addDragFill(f),cellScrollIntoView(t,f,!1)),e.preventDefault(),!0}if(e.key==="ArrowRight"||matchHotKey("\u21E5",e)){const g=c.nextElementSibling;return r.nextElementSibling&&r.nextElementSibling.classList.contains("av__cell")?f=r.nextElementSibling:!r.nextElementSibling&&r.parentElement.nextElementSibling?f=r.parentElement.nextElementSibling:g&&!g.classList.contains("av__row--footer")&&(f=g.querySelector(".av__cell")),f&&(r.classList.remove("av__cell--select","av__cell--active"),(s=r.querySelector(".av__drag-fill"))==null||s.remove(),f.classList.add("av__cell--select"),addDragFill(f),cellScrollIntoView(t,f,!1)),e.preventDefault(),!0}if(e.key==="ArrowUp"){const g=c.previousElementSibling;return g&&!g.classList.contains("av__row--header")&&(f=g.querySelector(`.av__cell[data-col-id="${r.dataset.colId}"]`)),f&&(r.classList.remove("av__cell--select","av__cell--active"),(o=r.querySelector(".av__drag-fill"))==null||o.remove(),f.classList.add("av__cell--select"),addDragFill(f),cellScrollIntoView(t,f)),e.preventDefault(),!0}if(e.key==="ArrowDown"){const g=c.nextElementSibling;return g&&!g.classList.contains("av__row--footer")&&(f=g.querySelector(`.av__cell[data-col-id="${r.dataset.colId}"]`)),f&&(r.classList.remove("av__cell--select","av__cell--active"),(l=r.querySelector(".av__drag-fill"))==null||l.remove(),f.classList.add("av__cell--select"),addDragFill(f),cellScrollIntoView(t,f)),e.preventDefault(),!0}if(!Constants.KEYCODELIST[e.keyCode]||Constants.KEYCODELIST[e.keyCode].length===1&&!e.metaKey&&!e.ctrlKey&&!["\u21E7","\u2303","\u2325","\u2318"].includes(Constants.KEYCODELIST[e.keyCode]))return r.style.backgroundColor?e.preventDefault():popTextCell(n,[r]),!0}const d=t.querySelectorAll(".av__row--select:not(.av__row--header)");if(d.length>0){if(matchHotKey("\u2318/",e))return e.stopPropagation(),e.preventDefault(),avContextmenu(n,d[0],{x:t.querySelector(".layout-tab-bar").getBoundingClientRect().left,y:d[0].getBoundingClientRect().bottom}),!0;if(e.key==="Escape")return e.preventDefault(),selectRow(d[0].querySelector(".av__firstcol"),"unselectAll"),!0;if(e.key==="Backspace")return e.preventDefault(),deleteRow(t,n),!0;if(e.key==="Enter")return selectRow(d[0].querySelector(".av__firstcol"),"unselectAll"),popTextCell(n,[d[0].querySelector(".av__cell")]),e.preventDefault(),!0;if(e.key==="ArrowUp"){const c=d[0].previousElementSibling;return selectRow(d[0].querySelector(".av__firstcol"),"unselectAll"),c&&!c.classList.contains("av__row--header")?(selectRow(c.querySelector(".av__firstcol"),"select"),cellScrollIntoView(t,c)):t.classList.add("protyle-wysiwyg--select"),e.preventDefault(),!0}if(e.key==="ArrowDown"){const c=d[d.length-1].nextElementSibling;return selectRow(d[0].querySelector(".av__firstcol"),"unselectAll"),c&&!c.classList.contains("av__row--util")?(selectRow(c.querySelector(".av__firstcol"),"select"),cellScrollIntoView(t,c)):t.classList.add("protyle-wysiwyg--select"),e.preventDefault(),!0}}return!1},_d=(e,t,n,a=!1)=>{let i=Lute.UnEscapeHTMLStr(t),s;if(isLocalPath(i)&&!i.startsWith("file://")&&i.indexOf(".pdf")>-1){const o=i.split("/");o.length===3&&o[0]==="assets"&&o[1].endsWith(".pdf")&&/\d{14}-\w{7}/.test(o[2])?(i=`assets/${o[1]}`,s=o[2]):(s=parseInt(getSearch("page",i)),i=i.split("?page")[0])}openByMobile(i)},vd=e=>{var t;const n=hasClosestBlock(e.previousRange.startContainer);if(!n)return!1;if(e.command==="enter"){let a=getTopAloneElement(n);return a.parentElement.classList.contains("li")&&a.parentElement.parentElement.classList.contains("list")&&((t=a.nextElementSibling)!=null&&t.classList.contains("list"))&&a.previousElementSibling.classList.contains("protyle-action")&&(a=a.parentElement),zoomOut({protyle:e.protyle,id:a.getAttribute("data-node-id")}),!0}return e.command==="enterBack"?(enterBack(e.protyle,n.getAttribute("data-node-id")),!0):!1},Fa=(e,t)=>{let n="";Array.from(e.cloneContents().childNodes).forEach(a=>{a.nodeType===3?n+=a.textContent:n+=a.outerHTML}),fetchPost("/api/block/getDOMText",{dom:n},a=>{t(a.data)})},Ed=(e,t)=>{t.addEventListener("keydown",n=>{var a,i,s,o,l,r;if(n.target.localName==="protyle-html"||n.target.localName==="input"){n.stopPropagation();return}if(e.disabled||!e.selectElement.classList.contains("fn__none")){n.stopPropagation(),n.preventDefault();return}e.wysiwyg.preventKeyup=!1,hideElements(["util"],e),n.shiftKey&&n.key.indexOf("Arrow")>-1||!n.repeat&&n.code!==""&&hideElements(["toolbar"],e);let d=getEditorRange(e.wysiwyg.element);const c=hasClosestBlock(d.startContainer);if(!c)return;const u=hasClosestBlock(d.endContainer);if(!matchHotKey("\u2318C",n)&&u&&!c.isSameNode(u)){n.stopPropagation(),n.preventDefault();return}if(avKeydown(n,c,e))return;if(c.classList.contains("protyle-wysiwyg--select")&&isNotCtrl(n)&&!n.shiftKey&&!n.altKey){if(n.key.toLowerCase()==="a")return n.stopPropagation(),n.preventDefault(),e.wysiwyg.element.blur(),setTimeout(()=>{insertEmptyBlock(e,"afterend")},100),!1;if(n.key.toLowerCase()==="b")return n.stopPropagation(),n.preventDefault(),e.wysiwyg.element.blur(),setTimeout(()=>{insertEmptyBlock(e,"beforebegin")},100),!1}if(n.isComposing){n.stopPropagation();return}if(["\u2318","\u21E7","\u2325","\u2303"].includes(Constants.KEYCODELIST[n.keyCode])||(Constants.KEYCODELIST[n.keyCode]==="/"||n.key==="/"||n.code==="Slash"&&n.key==="Process"&&n.keyCode===229?e.hint.enableSlash=!0:(Constants.KEYCODELIST[n.keyCode]==="\\"||n.key==="\\"||n.code==="Backslash"&&n.key==="Process"&&n.keyCode===229)&&(e.hint.enableSlash=!1,hideElements(["hint"],e))),n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&n.key!=="Escape"&&n.key!=="Shift"&&n.key!=="Meta"&&n.key!=="Alt"&&n.key!=="Control"&&n.key!=="CapsLock"&&!isNotEditBlock(c)&&!/^F\d{1,2}$/.test(n.key)&&typeof e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=="undefined"){const b=d.cloneRange();d.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=c.outerHTML,c.querySelector("wbr").remove(),d=b}if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&(["\u2190","\u2191","\u2192","\u2193"].includes(Constants.KEYCODELIST[n.keyCode])||Constants.KEYCODELIST[n.keyCode]==="\u21A9")&&!n.altKey&&!n.shiftKey&&isNotCtrl(n)){n.preventDefault();return}else n.key!=="Escape"&&window.siyuan.menus.menu.remove();if(!["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(n.key)&&e.options.render.breadcrumb&&e.breadcrumb.hide(),!n.altKey&&!n.shiftKey&&isNotCtrl(n)&&(n.key==="ArrowDown"||n.key==="ArrowUp")){const b=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(b.length>0){if(n.preventDefault(),n.stopPropagation(),hideElements(["select"],e),n.key==="ArrowDown"){const w=b[b.length-1];let h=getNextBlock(w);if(h)if(h.getBoundingClientRect().width===0){const k=hasTopClosestByAttribute(h,"fold","1");k?(h=getNextBlock(k),h?h=getFirstBlock(h):h=w):h=w}else h.getAttribute("fold")==="1"&&(h.classList.contains("sb")||h.classList.contains("bq"))||(h=getFirstBlock(h));else h=w;h.classList.add("protyle-wysiwyg--select"),countBlockWord([h.getAttribute("data-node-id")]);const C=h.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;C>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+C,e.scroll.lastScrollTop=e.contentElement.scrollTop-1),focusBlock(h)}else if(n.key==="ArrowUp"){let w=getPreviousBlock(b[0]);if(w){if(w=getLastBlock(w),w.getBoundingClientRect().width===0){const h=hasTopClosestByAttribute(w,"fold","1");h?w=getFirstBlock(h):w=b[0]}else if(w){const h=hasTopClosestByAttribute(w,"fold","1");h&&(h.classList.contains("sb")||h.classList.contains("bq"))&&(w=h)}}else if(e.title&&e.title.editElement&&(e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.contentElement.scrollTop===0)){const h=setLastNodeRange(e.title.editElement,d,!1);h.collapse(!1),focusByRange(h),n.stopPropagation(),n.preventDefault()}else e.contentElement.scrollTop!==0?(e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8):w=b[0];if(w){w.classList.add("protyle-wysiwyg--select"),countBlockWord([w.getAttribute("data-node-id")]);const h=w.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;h<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+h,e.scroll.lastScrollTop=e.contentElement.scrollTop+1),focusBlock(w)}}return}}if(n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&isNotCtrl(n)&&n.key!=="Escape"&&!n.shiftKey&&!n.altKey&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Enter"&&n.key!=="Tab"&&n.key!=="Backspace"&&n.key!=="Delete"&&n.key!=="ContextMenu")return n.stopPropagation(),hideElements(["select"],e),!1;if(matchHotKey(window.siyuan.config.keymap.editor.general.collapse.custom,n)&&!n.repeat){const b=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return b.length>0?setFold(e,b[0]):c.parentElement.getAttribute("data-type")==="NodeListItem"?c.parentElement.childElementCount>3?setFold(e,c.parentElement):setFold(e,c):c.getAttribute("data-type")==="NodeHeading"?setFold(e,c):setFold(e,getTopAloneElement(c)),n.stopPropagation(),n.preventDefault(),!1}if(matchHotKey(window.siyuan.config.keymap.editor.general.expand.custom,n)&&!n.repeat){const b=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");b.length>0?setFold(e,b[0],!0):c.parentElement.getAttribute("data-type")==="NodeListItem"?c.parentElement.childElementCount>3?setFold(e,c.parentElement,!0):setFold(e,c,!0):c.getAttribute("data-type")==="NodeHeading"?setFold(e,c,!0):setFold(e,getTopAloneElement(c),!0),n.stopPropagation(),n.preventDefault();return}if((matchHotKey("\u21E7\u2190",n)||matchHotKey("\u21E7\u2192",n))&&e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0){n.stopPropagation(),n.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.expandUp.custom,n)){upSelect({protyle:e,event:n,nodeElement:c,editorElement:t,range:d,cb(b){const w=b[0].previousElementSibling;if(w&&w.getAttribute("data-node-id")){w.classList.add("protyle-wysiwyg--select"),b.forEach(C=>{C.removeAttribute("select-end")}),w.setAttribute("select-end","true");const h=w.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;h<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+h,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else b[0].parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),b[0].parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(matchHotKey(window.siyuan.config.keymap.editor.general.expandDown.custom,n)){downSelect({protyle:e,event:n,nodeElement:c,editorElement:t,range:d,cb(b){const w=b[b.length-1],h=w.nextElementSibling;if(h&&h.getAttribute("data-node-id")){h.classList.add("protyle-wysiwyg--select"),b.forEach(k=>{k.removeAttribute("select-end")}),h.setAttribute("select-end","true");const C=h.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;C>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+C,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else w.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),w.parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(matchHotKey("\u21E7\u2191",n)){upSelect({protyle:e,event:n,nodeElement:c,editorElement:t,range:d,cb(b){const w=getStartEndElement(b);if(w.startElement.getBoundingClientRect().top>=w.endElement.getBoundingClientRect().top){const h=w.endElement.previousElementSibling;if(h&&h.getAttribute("data-node-id")){h.classList.add("protyle-wysiwyg--select"),h.setAttribute("select-end","true"),w.endElement.removeAttribute("select-end");const C=h.getBoundingClientRect().top-e.contentElement.getBoundingClientRect().top;C<0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+C,e.scroll.lastScrollTop=e.contentElement.scrollTop+1)}else w.endElement.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),w.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{w.endElement.classList.remove("protyle-wysiwyg--select"),w.endElement.removeAttribute("select-end");const h=getPreviousBlock(w.endElement);h&&(h.setAttribute("select-end","true"),h.getBoundingClientRect().top<=e.contentElement.getBoundingClientRect().top&&(preventScroll(e),h.scrollIntoView(!0)))}}});return}if(matchHotKey("\u21E7\u2193",n)){downSelect({protyle:e,event:n,nodeElement:c,editorElement:t,range:d,cb(b){const w=getStartEndElement(b);if(w.startElement.getBoundingClientRect().top<=w.endElement.getBoundingClientRect().top){const h=w.endElement.nextElementSibling;if(h&&h.getAttribute("data-node-id"))if(h.getBoundingClientRect().width===0)hideElements(["select"],e),w.endElement.parentElement.classList.add("protyle-wysiwyg--select");else{h.classList.add("protyle-wysiwyg--select"),h.setAttribute("select-end","true"),w.endElement.removeAttribute("select-end");const C=h.getBoundingClientRect().bottom-e.contentElement.getBoundingClientRect().bottom;C>0&&(e.contentElement.scrollTop=e.contentElement.scrollTop+C,e.scroll.lastScrollTop=e.contentElement.scrollTop-1)}else w.endElement.parentElement.classList.contains("protyle-wysiwyg")||(hideElements(["select"],e),w.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{w.endElement.classList.remove("protyle-wysiwyg--select"),w.endElement.removeAttribute("select-end");const h=getNextBlock(w.endElement);h&&(h.setAttribute("select-end","true"),h.getBoundingClientRect().bottom>=e.contentElement.getBoundingClientRect().bottom&&(preventScroll(e),h.scrollIntoView(!1)))}}});return}if(matchHotKey(window.siyuan.config.keymap.general.enter.custom,n)){onlyProtyleCommand({protyle:e,command:"enter",previousRange:d}),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.general.enterBack.custom,n)){onlyProtyleCommand({protyle:e,command:"enterBack",previousRange:d}),n.preventDefault(),n.stopPropagation();return}if(n.shiftKey&&!n.altKey&&isNotCtrl(n)&&(n.key==="Home"||n.key==="End")&&isMac()||n.shiftKey&&!n.altKey&&isOnlyMeta(n)&&(n.key==="Home"||n.key==="End")&&!isMac()){const b=hasTopClosestByAttribute(c,"data-node-id",null);if(b){b.querySelectorAll(".protyle-wysiwyg--select").forEach(h=>{h.classList.remove("protyle-wysiwyg--select")}),b.classList.add("protyle-wysiwyg--select");let w=n.key==="Home"?b.previousElementSibling:b.nextElementSibling;for(;w;)w.classList.add("protyle-wysiwyg--select"),w=n.key==="Home"?w.previousElementSibling:w.nextElementSibling;n.key==="Home"?e.wysiwyg.element.firstElementChild.scrollIntoView():e.wysiwyg.element.lastElementChild.scrollIntoView(!1)}n.stopPropagation(),n.preventDefault();return}if((n.key==="Home"||n.key==="End")&&!n.shiftKey&&!n.altKey&&isNotCtrl(n)&&hideElements(["hint"],e),!n.altKey&&!n.shiftKey&&isNotCtrl(n)&&(n.key==="PageUp"||n.key==="PageDown")){n.key==="PageUp"?(e.contentElement.scrollTop=e.contentElement.scrollTop-e.contentElement.clientHeight+60,e.scroll.lastScrollTop=e.contentElement.scrollTop+1):(e.contentElement.scrollTop=e.contentElement.scrollTop+e.contentElement.clientHeight-60,e.scroll.lastScrollTop=e.contentElement.scrollTop-1);const b=e.contentElement.getBoundingClientRect();let w=document.elementFromPoint(b.x+b.width/2,b.y+b.height/2);w.classList.contains("protyle-wysiwyg")&&(w=document.elementFromPoint(b.x+b.width/2,b.y+b.height/2+Constants.SIZE_TOOLBAR_HEIGHT));const h=hasClosestBlock(w);h&&!h.isSameNode(c)&&focusBlock(h,void 0,!1),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&(n.key.indexOf("Arrow")>-1&&isNotCtrl(n)||n.key==="Enter")&&!e.hint.element.classList.contains("fn__none")&&e.hint.select(n,e))return;if(matchHotKey("\u2318/",n)){n.stopPropagation(),n.preventDefault();const b=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(b.length===0){const h=hasClosestByAttribute(d.startContainer,"data-type",null);if(h&&h.tagName==="SPAN"){const C=h.getAttribute("data-type").split(" ");if(C.length>0&&(e.toolbar.range=d,removeSearchMark(h)),C.includes("block-ref")){refMenu(e,h);return}else if(C.includes("inline-memo")){e.toolbar.showRender(e,h);return}else if(C.includes("file-annotation-ref")){fileAnnotationRefMenu(e,h);return}else if(C.includes("a")){linkMenu(e,h);return}else if(C.includes("tag")){tagMenu(e,h);return}}if(d.startOffset===0&&d.startContainer.nodeType===3){const C=hasPreviousSibling(d.startContainer);if(C&&C.nodeType!==3&&((a=C.getAttribute("data-type"))==null?void 0:a.indexOf("inline-math"))>-1){inlineMathMenu(e,C);return}else if(!C&&d.startContainer.parentElement.previousSibling&&d.startContainer.parentElement.previousSibling.isSameNode(d.startContainer.parentElement.previousElementSibling)&&((i=d.startContainer.parentElement.previousElementSibling.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1){inlineMathMenu(e,d.startContainer.parentElement.previousElementSibling);return}}b.push(c)}b.length===1?e.gutter.renderMenu(e,b[0]):e.gutter.renderMultipleMenu(e,b);const w=c.getBoundingClientRect();window.siyuan.menus.menu.popup({x:w.left,y:w.top,isLeft:!0});return}if(fixTable(e,n,d)){n.preventDefault();return}const f=d.toString();if(!n.altKey&&!n.shiftKey&&isNotCtrl(n)&&!n.isComposing&&n.key.indexOf("Arrow")>-1){const b=hasClosestByMatchTag(d.startContainer,"TD")||hasClosestByMatchTag(d.startContainer,"TH"),w=b||getContenteditableElement(c)||c,h=getSelectionOffset(w,e.wysiwyg.element,d);if(c.classList.contains("code-block")&&h.end===w.innerText.length&&(h.end-=1),n.key==="ArrowDown"&&(w==null?void 0:w.innerText.trimRight().substr(h.start).indexOf(`
`))===-1&&(b&&!b.parentElement.nextElementSibling&&c.getAttribute("data-type")==="NodeTable"&&!getNextBlock(c)||c.getAttribute("data-type")==="NodeCodeBlock"&&!getNextBlock(c)||c.parentElement.getAttribute("data-type")==="NodeBlockquote"&&c.nextElementSibling.classList.contains("protyle-attr")&&!getNextBlock(c.parentElement)))c.parentElement.getAttribute("data-type")==="NodeBlockquote"?insertEmptyBlock(e,"afterend",c.parentElement.getAttribute("data-node-id")):insertEmptyBlock(e,"afterend",c.getAttribute("data-node-id"));else if(n.key==="ArrowUp"){const C=getContenteditableElement(e.wysiwyg.element.firstElementChild);if(!getPreviousBlock(c)&&c.contains(C)||!C&&c.isSameNode(e.wysiwyg.element.firstElementChild)){if(getSelectionPosition(w,d).top-w.getBoundingClientRect().top<20||c.classList.contains("av"))if(e.title&&e.title.editElement&&(e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.contentElement.scrollTop===0)){const k=setLastNodeRange(e.title.editElement,d,!1);k.collapse(!1),focusByRange(k),n.stopPropagation(),n.preventDefault()}else e.contentElement.scrollTop=0,e.scroll.lastScrollTop=8}else if(((w==null?void 0:w.innerText.substr(0,h.end).indexOf(`
`))===-1||h.start===0)&&getSelectionPosition(w,d).top-w.getBoundingClientRect().top<20){let k=getPreviousBlock(c);if(k&&(k=getLastBlock(k),k)){const E=hasClosestByAttribute(k,"fold","1");!E&&k.classList.contains("code-block")?(focusBlock(k,void 0,!1),scrollCenter(e,k),n.stopPropagation(),n.preventDefault()):E&&E.getAttribute("data-type")!=="NodeListItem"&&(E.scrollTop=0,focusBlock(E,void 0,!0),scrollCenter(e,E),n.stopPropagation(),n.preventDefault())}}}else if(f===""&&(n.key==="ArrowDown"||n.key==="ArrowRight")&&c.isSameNode(getLastBlock(e.wysiwyg.element.lastElementChild))&&!hasClosestByMatchTag(d.startContainer,"TD")&&!hasClosestByMatchTag(d.startContainer,"TH")){const C=getContenteditableElement(c);C&&!C.querySelector(".emoji")&&C.textContent.replace(/\n$/,"").length<=getSelectionOffset(C,void 0,d).end&&(n.stopPropagation(),n.preventDefault(),focusByRange(d))}else if(f===""&&n.key==="ArrowLeft"&&c.isSameNode(getFirstBlock(e.wysiwyg.element.firstElementChild))){const C=getContenteditableElement(c);C&&getSelectionOffset(C,void 0,d).start===0&&(n.stopPropagation(),n.preventDefault(),focusByRange(d))}if(n.key==="ArrowDown"){if((w==null?void 0:w.innerText.trimRight().substr(h.start).indexOf(`
`))===-1&&c.isSameNode(e.wysiwyg.element.lastElementChild)){setLastNodeRange(getContenteditableElement(w),d,!1),d.collapse(!1),n.stopPropagation(),n.preventDefault();return}const C=hasClosestByAttribute(d.startContainer,"fold","1");if(C){let k=getNextBlock(C);k&&(k.getAttribute("fold")==="1"&&(k.classList.contains("sb")||k.classList.contains("bq"))||(k=getFirstBlock(k)),focusBlock(k),scrollCenter(e,k)),n.stopPropagation(),n.preventDefault()}else if((w==null?void 0:w.innerText.substr(h.end).indexOf(`
`))===-1||h.end>=w.innerText.trimEnd().length){d.collapse(!1);const k=getNextBlock(c);k&&(k.getAttribute("fold")==="1"||k.classList.contains("code-block"))&&w.getBoundingClientRect().bottom-getSelectionPosition(c,d).top<40&&(focusBlock(k),scrollCenter(e,k),n.stopPropagation(),n.preventDefault())}}return}if(!n.altKey&&(n.key==="Backspace"||n.key==="Delete")||matchHotKey("\u2303D",n)){if(e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")){removeBlock(e,c,d,n.key==="Backspace"?"Backspace":"Delete"),n.stopPropagation(),n.preventDefault();return}if(f===""&&n.key==="Backspace"&&d.startOffset===d.startContainer.textContent.length&&d.startContainer.textContent.endsWith(`
`+Constants.ZWSP)){d.setStart(d.startContainer,d.startOffset-1),d.collapse(!0),n.stopPropagation(),n.preventDefault();return}const b=hasPreviousSibling(d.startContainer);if(d.startOffset===1&&d.startContainer.textContent===Constants.ZWSP&&b&&b.nodeType!==3&&n.key==="Backspace"){if(b.classList.contains("img"))b.classList.add("img--select");else if(((s=b.getAttribute("data-type"))==null?void 0:s.indexOf("inline-math"))>-1){b.after(document.createElement("wbr"));const h=c.outerHTML;d.startContainer.textContent="",b.remove(),updateTransaction(e,c.getAttribute("data-node-id"),c.outerHTML,h),focusByWbr(c,d),n.stopPropagation(),n.preventDefault();return}}const w=e.wysiwyg.element.querySelector(".img--select");if(w){if(w.classList.remove("img--select"),c.contains(w)){removeImage(w,c,d,e),n.stopPropagation(),n.preventDefault();return}}else if(f===""){const h=getContenteditableElement(c);if(!h){c.classList.add("protyle-wysiwyg--select"),removeBlock(e,c,d,n.key==="Backspace"?"Backspace":"Delete"),n.stopPropagation(),n.preventDefault();return}const C=getSelectionOffset(h,e.wysiwyg.element,d);if(n.key==="Delete"||matchHotKey("\u2303D",n))if(C.end===h.innerText.length||C.end===h.innerText.length-1&&h.innerText.endsWith(`
`)||C.end===h.innerText.length-1&&h.innerText.endsWith(Constants.ZWSP)){const k=getNextBlock(getTopAloneElement(c));if(k){const E=focusBlock(k);if(E){const _=hasClosestBlock(E.startContainer);_&&removeBlock(e,_,E,"Delete")}n.stopPropagation(),n.preventDefault();return}}else if(C.end===h.innerText.length-1&&c.getAttribute("data-type")==="NodeCodeBlock"){n.stopPropagation(),n.preventDefault();return}else{let k=hasNextSibling(d.startContainer);if(k&&(k.nodeType===3&&k.textContent===Constants.ZWSP&&(k=k.nextSibling),k.nodeType===1&&k.classList.contains("img")&&getSelectionOffset(d.startContainer,e.wysiwyg.element,d).start===d.startContainer.textContent.length)){removeImage(k,c,d,e),n.stopPropagation(),n.preventDefault();return}}else{const k=d.startContainer.childNodes[d.startOffset-1];if(C.start===0&&(d.startOffset===0||k&&k.nodeType===3&&!hasPreviousSibling(k)&&k.textContent==="")){removeBlock(e,c,d,"Backspace"),n.stopPropagation(),n.preventDefault();return}if(d.startContainer.nodeType!==3&&c.getAttribute("data-type")==="NodeTable"&&((o=d.startContainer.children[d.startOffset-1])==null?void 0:o.tagName)==="TABLE"){c.classList.add("protyle-wysiwyg--select"),removeBlock(e,c,d,"Backspace"),n.stopPropagation(),n.preventDefault();return}if(k&&k.nodeType!==3&&k.classList.contains("img")){removeImage(k,c,d,e),n.stopPropagation(),n.preventDefault();return}if(c.classList.contains("code-block")&&isOnlyMeta(n)&&d.startContainer.nodeType===3&&d.startContainer.textContent.substring(d.startOffset-1,d.startOffset)===`
`){n.stopPropagation(),n.preventDefault();return}const E=hasClosestByMatchTag(d.startContainer,"SPAN");if(C.start===2&&E&&getSelectionOffset(E,e.wysiwyg.element,d).start===1&&E.innerText.startsWith(Constants.ZWSP)&&h.innerText.startsWith(Constants.ZWSP)){focusBlock(c),n.stopPropagation(),n.preventDefault();return}if(C.start===1&&!E&&h.innerText.startsWith(Constants.ZWSP)&&h.innerText.length>1){setFirstNodeRange(h,d),removeBlock(e,c,d,"Backspace"),n.stopPropagation(),n.preventDefault();return}}}else if(c.classList.contains("code-block")&&getContenteditableElement(c).textContent===`
`){d.collapse(!0),n.stopPropagation(),n.preventDefault();return}}if(matchHotKey("\u21E7\u21A9",n)&&f===""&&softEnter(d,c,e)){n.stopPropagation(),n.preventDefault();return}if(isNotCtrl(n)&&n.key==="Enter")if(n.altKey)addSubList(e,c,d);else if(n.shiftKey){if(c.getAttribute("data-type")==="NodeAttributeView"){n.stopPropagation(),n.preventDefault();return}}else{enter(c,d,e),n.stopPropagation(),n.preventDefault();return}if(matchHotKey("\u2318A",n))return n.preventDefault(),selectAll(e,c,d),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.undo.custom,n)){e.undo.undo(e),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.redo.custom,n)){e.undo.redo(e),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyProtocol.custom,n)){const b=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let w;return b.length===1?w=b[0]:w=c,writeText(`siyuan://blocks/${w.getAttribute("data-node-id")}`),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyID.custom,n))return writeText(c.getAttribute("data-node-id")),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyText.custom,n)){if(f!=="")Fa(d,b=>{writeText(`${b.trim()} ((${c.getAttribute("data-node-id")} "*"))`)});else{const b=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");b.length>0?(b[0].setAttribute("data-reftext","true"),focusByRange(getEditorRange(c)),document.execCommand("copy")):writeText(`((${c.getAttribute("data-node-id")} "*"))`)}return n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,n)){const b=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let w;return b.length===1?w=b[0]:w=c,writeText(`{{select * from blocks where id='${w.getAttribute("data-node-id")}'}}`),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.attr.custom,n)){const b=getTopAloneElement(c);if(f===""){const w=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let h;w.length===1?h=w[0]:h=b,openAttr(h,"bookmark",e)}else Fa(d,w=>{const h=b.outerHTML,C=b.lastElementChild.querySelector(".protyle-attr--name");C?C.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${w.trim()}`:b.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${w.trim()}</div>`),b.setAttribute("name",w.trim()),updateTransaction(e,b.getAttribute("data-node-id"),b.outerHTML,h)});return n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.general.rename.custom,n)&&!e.disabled){f===""?fetchPost("/api/block/getDocInfo",{id:e.block.rootID},b=>{rename({notebookId:e.notebookId,path:e.path,name:b.data.ial.title,range:d,type:"file"})}):fetchPost("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:replaceFileName(f)}),n.preventDefault(),n.stopPropagation();return}const g=matchHotKey(window.siyuan.config.keymap.editor.general.newNameFile.custom,n);if(g||matchHotKey(window.siyuan.config.keymap.editor.general.newNameSettingFile.custom,n)){!f.trim()&&(c.querySelector("tr")||c.querySelector("span"))||(!f.trim()&&getContenteditableElement(c).textContent&&selectAll(e,c,d),g?fetchPost("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:e.path},b=>{newFileBySelect(e,f,c,b.data,e.notebookId)}):getSavePath(e.path,e.notebookId,(b,w)=>{newFileBySelect(e,f,c,b,w)})),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.newContentFile.custom,n)){newFileContentBySelect(e),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignLeft.custom,n)){const b=c.querySelectorAll(".img--select");if(b.length>0)alignImgLeft(e,c,Array.from(b),c.getAttribute("data-node-id"),c.outerHTML);else{let w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));w.length===0&&(w=[c]),updateBatchTransaction(w,e,h=>{h.classList.contains("av")?h.style.justifyContent="":h.style.textAlign="left"})}n.stopPropagation(),n.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignCenter.custom,n)){const b=c.querySelectorAll(".img--select");if(b.length>0)alignImgCenter(e,c,Array.from(b),c.getAttribute("data-node-id"),c.outerHTML);else{let w=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));w.length===0&&(w=[c]),updateBatchTransaction(w,e,h=>{h.classList.contains("av")?h.style.justifyContent="center":h.style.textAlign="center"})}n.stopPropagation(),n.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.alignRight.custom,n)){let b=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));b.length===0&&(b=[c]),updateBatchTransaction(b,e,w=>{w.classList.contains("av")?w.style.justifyContent="flex-end":w.style.textAlign="right"}),n.stopPropagation(),n.preventDefault();return}if(n.key==="Escape"){!e.toolbar.element.classList.contains("fn__none")||!e.hint.element.classList.contains("fn__none")||!e.toolbar.subElement.classList.contains("fn__none")?(hideElements(["toolbar","hint","util"],e),e.hint.enableExtend=!1):c.classList.contains("protyle-wysiwyg--select")?(hideElements(["select"],e),countBlockWord([],e.block.rootID)):window.siyuan.menus.menu.element.classList.contains("fn__none")?(hideElements(["select"],e),d.collapse(!1),c.classList.add("protyle-wysiwyg--select"),countBlockWord([c.getAttribute("data-node-id")],e.block.rootID)):window.siyuan.menus.menu.remove(),n.preventDefault();return}if(matchHotKey(window.siyuan.config.keymap.editor.heading.paragraph.custom,n)){const b=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(b.length===0&&b.push(c),b.length>1)turnsIntoTransaction({protyle:e,nodeElement:b[0],type:"Blocks2Ps"});else{const w=b[0].getAttribute("data-type");w==="NodeHeading"?turnsIntoTransaction({protyle:e,nodeElement:b[0],type:"Blocks2Ps"}):w==="NodeList"?turnsOneInto({protyle:e,nodeElement:b[0],id:b[0].getAttribute("data-node-id"),type:"CancelList"}):w==="NodeBlockquote"&&turnsOneInto({protyle:e,nodeElement:b[0],id:b[0].getAttribute("data-node-id"),type:"CancelBlockquote"})}return n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading1.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:c,type:"Blocks2Hs",level:1}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading2.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:c,type:"Blocks2Hs",level:2}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading3.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:c,type:"Blocks2Hs",level:3}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading4.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:c,type:"Blocks2Hs",level:4}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading5.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:c,type:"Blocks2Hs",level:5}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.heading.heading6.custom,n))return turnsIntoTransaction({protyle:e,nodeElement:c,type:"Blocks2Hs",level:6}),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.insert.code.custom,n)&&!["NodeCodeBlock","NodeHeading"].includes(c.getAttribute("data-type"))){const b=c.getAttribute("data-node-id"),w=c.outerHTML,h=getContenteditableElement(c);h.innerHTML="```"+window.siyuan.storage[Constants.LOCAL_CODELANG]+`
`+Lute.EscapeHTMLStr(h.textContent)+"<wbr>\n```";const C=e.lute.SpinBlockDOM(c.outerHTML);c.outerHTML=C;const k=e.wysiwyg.element.querySelector(`[data-node-id="${b}"]`);return updateTransaction(e,b,C,w),highlightRender(k),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.insert.lastUsed.custom,n)){e.toolbar.range=d;let b=[];f===""&&e.toolbar.getCurrentType(d).length===0&&(b=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),b.length===0&&(b=[c])),fontEvent(e,b),n.stopPropagation(),n.preventDefault();return}if(!c.classList.contains("code-block")&&!n.repeat&&!isInEmbedBlock(c)){let b=!1;if(e.options.toolbar.find(w=>{if(!w.hotkey)return!1;if(matchHotKey(w.hotkey,n))return e.toolbar.range=d,["block-ref"].includes(w.name)&&e.toolbar.range.toString()===""||(b=!0,["a","block-ref","inline-math","inline-memo","text"].includes(w.name)?e.toolbar.element.querySelector(`[data-type="${w.name}"]`).dispatchEvent(new CustomEvent("click")):Constants.INLINE_TYPE.includes(w.name)?e.toolbar.setInlineMark(e,w.name,"range"):w.click&&w.click(e.getInstance())),!0}),b)return n.preventDefault(),n.stopPropagation(),e.wysiwyg.preventKeyup=!0,!0}if(matchHotKey(window.siyuan.config.keymap.editor.list.outdent.custom,n)){const b=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(b.length>0&&b[0].getAttribute("data-type")==="NodeListItem")return listOutdent(e,Array.from(b),d),n.preventDefault(),n.stopPropagation(),!0;if(c.parentElement.classList.contains("li")&&c.getAttribute("data-type")!=="NodeCodeBlock")return listOutdent(e,[c.parentElement],d),n.preventDefault(),n.stopPropagation(),!0}if(matchHotKey(window.siyuan.config.keymap.editor.list.indent.custom,n)){const b=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(b.length>0&&b[0].getAttribute("data-type")==="NodeListItem")return listIndent(e,Array.from(b),d),n.preventDefault(),n.stopPropagation(),!0;if(c.parentElement.classList.contains("li")&&c.getAttribute("data-type")!=="NodeCodeBlock")return listIndent(e,[c.parentElement],d),n.preventDefault(),n.stopPropagation(),!0}const p=matchHotKey(window.siyuan.config.keymap.editor.insert.list.custom,n),m=matchHotKey(window.siyuan.config.keymap.editor.insert.check.custom,n),y=matchHotKey(window.siyuan.config.keymap.editor.insert["ordered-list"].custom,n),v=matchHotKey(window.siyuan.config.keymap.editor.insert.quote.custom,n);if(p||y||m||v){const b=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(b.length===0&&b.push(c),b.length===1){const w=b[0].dataset.subtype,h=b[0].dataset.type;if(v)["NodeHeading","NodeParagraph","NodeList"].includes(h)?turnsIntoOneTransaction({protyle:e,selectsElement:b,type:"Blocks2Blockquote"}):(e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill(">"+Lute.Caret,e));else if(h==="NodeParagraph")turnsIntoOneTransaction({protyle:e,selectsElement:b,type:m?"Blocks2TLs":p?"Blocks2ULs":"Blocks2OLs"});else if(h==="NodeList"){const C=b[0].dataset.nodeId;w==="o"&&(p||m)?turnsOneInto({protyle:e,nodeElement:b[0],id:C,type:m?"UL2TL":"OL2UL"}):w==="t"&&(p||y)?turnsOneInto({protyle:e,nodeElement:b[0],id:C,type:p?"TL2UL":"TL2OL"}):w==="u"&&(m||y)&&turnsOneInto({protyle:e,nodeElement:b[0],id:C,type:m?"OL2TL":"UL2OL"})}else e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill((m?"* [ ] ":p?"* ":"1. ")+Lute.Caret,e)}else{let w=!1,h=!1;b.find((C,k)=>{if(C.classList.contains("li"))return w=!0,!0;if(C.nextElementSibling&&b[k+1]&&C.nextElementSibling.isSameNode(b[k+1]))h=!0;else if(k!==b.length-1)return h=!1,!0}),!w&&h&&turnsIntoOneTransaction({protyle:e,selectsElement:b,type:v?"Blocks2Blockquote":m?"Blocks2TLs":p?"Blocks2ULs":"Blocks2OLs"})}n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.insert.table.custom,n)){e.hint.splitChar="/",e.hint.lastIndex=-1,e.hint.fill(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,e),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.list.checkToggle.custom,n)){const b=hasClosestByAttribute(d.startContainer,"data-subtype","t");if(!b)return;const w=b.outerHTML;b.classList.contains("protyle-task--done")?(b.querySelector("use").setAttribute("xlink:href","#iconUncheck"),b.classList.remove("protyle-task--done")):(b.querySelector("use").setAttribute("xlink:href","#iconCheck"),b.classList.add("protyle-task--done")),b.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,b.getAttribute("data-node-id"),b.outerHTML,w),n.preventDefault(),n.stopPropagation();return}if(matchHotKey(window.siyuan.config.keymap.editor.general.insertBefore.custom,n))return insertEmptyBlock(e,"beforebegin"),n.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.insertAfter.custom,n))return insertEmptyBlock(e,"afterend"),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,n))return jumpToParent(e,c,"next"),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.jumpToParent.custom,n))return jumpToParent(e,c,"parent"),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,n))return jumpToParent(e,c,"previous"),n.preventDefault(),n.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.moveToUp.custom,n)){n.preventDefault(),n.stopPropagation(),moveToUp(e,c,d);return}if(matchHotKey(window.siyuan.config.keymap.editor.general.moveToDown.custom,n)){n.preventDefault(),n.stopPropagation(),moveToDown(e,c,d);return}if(matchHotKey(window.siyuan.config.keymap.editor.general.vLayout.custom,n)){n.preventDefault(),n.stopPropagation();const b=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(b.length<2||(l=b[0])!=null&&l.classList.contains("li"))return;turnsIntoOneTransaction({protyle:e,selectsElement:b,type:"BlocksMergeSuperBlock",level:"row"});return}if(matchHotKey(window.siyuan.config.keymap.editor.general.hLayout.custom,n)){n.preventDefault(),n.stopPropagation();const b=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(b.length<2||(r=b[0])!=null&&r.classList.contains("li"))return;turnsIntoOneTransaction({protyle:e,selectsElement:b,type:"BlocksMergeSuperBlock",level:"col"});return}if(!n.repeat&&matchHotKey(window.siyuan.config.keymap.editor.general.ai.custom,n)){n.preventDefault(),n.stopPropagation();let b=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));b.length===0&&(b=[c]),AIActions(b,e);return}if(n.key==="Tab"&&isNotCtrl(n)&&!n.altKey){n.preventDefault();const b=window.siyuan.config.editor.codeTabSpaces===0?"	":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if(c.getAttribute("data-type")==="NodeCodeBlock"&&f!==""){!hasNextSibling(d.endContainer)&&d.endContainer.textContent.endsWith(`
`)&&d.endOffset>0&&d.setEnd(d.endContainer,d.endOffset-1);const w=document.createElement("wbr");d.insertNode(w),d.setStartAfter(w);const h=c.outerHTML;let C="";n.shiftKey?d.extractContents().textContent.split(`
`).forEach(_=>{_.startsWith(b)?C+=_.replace(b,"")+`
`:C+=_+`
`}):d.extractContents().textContent.split(`
`).forEach(_=>{C+=b+_+`
`});let k=c.querySelector(".protyle-action__language").textContent;window.hljs.getLanguage(k)||(k="plaintext"),w.insertAdjacentHTML("afterend",window.hljs.highlight(C.substr(0,C.length-1),{language:k,ignoreIllegals:!0}).value+"<br>"),d.setStart(w.nextSibling,0);const E=w.parentElement.querySelector("br");setLastNodeRange(E.previousSibling,d,!1),E.remove(),updateTransaction(e,c.getAttribute("data-node-id"),c.outerHTML,h),w.remove();return}if(!n.shiftKey){const w=document.createElement("wbr");d.insertNode(w);const h=c.outerHTML;return d.extractContents(),d.insertNode(document.createTextNode(b)),d.collapse(!1),focusByRange(d),w.remove(),updateTransaction(e,c.getAttribute("data-node-id"),c.outerHTML,h),!0}}if(n.key==="ContextMenu"){const b=getSelectionPosition(c,d);e.wysiwyg.element.dispatchEvent(new CustomEvent("contextmenu",{detail:{target:c,y:b.top+8,x:b.left}})),n.preventDefault(),n.stopPropagation();return}if(matchHotKey("\u21E7\u2318V",n)){n.returnValue=!1,n.preventDefault(),n.stopPropagation(),pasteAsPlainText(e);return}if(matchHotKey(window.siyuan.config.keymap.editor.general.openBy.custom,n)){const b=hasClosestByAttribute(d.startContainer,"data-type","a");if(b){openLink(e,b.getAttribute("data-href"),void 0,!1),n.preventDefault(),n.stopPropagation();return}const w=hasClosestByAttribute(d.startContainer,"data-type","file-annotation-ref");if(w){const C=`assets/${w.getAttribute("data-id").split("/")[1]}`;openLink(e,C,void 0,!1),n.preventDefault(),n.stopPropagation();return}return}isNotCtrl(n)&&n.key!=="Backspace"&&n.key!=="Escape"&&n.key!=="Delete"&&!n.shiftKey&&!n.altKey&&n.key!=="Enter"&&hideElements(["select"],e)})};var Vi=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const Gi=(e,t)=>{const n=new Dialog({title:window.siyuan.languages.searchType,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconMath"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.math}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="mathBlock" type="checkbox"${e.types.mathBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconTable"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.table}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="table" type="checkbox"${e.types.table?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconParagraph"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.paragraph}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="paragraph" type="checkbox"${e.types.paragraph?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHeadings"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.headings}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="heading" type="checkbox"${e.types.heading?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconCode"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.code}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="codeBlock" type="checkbox"${e.types.codeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHTML5"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            HTML
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="htmlBlock" type="checkbox"${e.types.htmlBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.database}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="databaseBlock" type="checkbox"${e.types.databaseBlock?" checked":""}>
    </label>    
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSQL"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.embedBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="embedBlock" type="checkbox"${e.types.embedBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconVideo"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.video}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="videoBlock" type="checkbox"${e.types.videoBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconRecord"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.audio}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="audioBlock" type="checkbox"${e.types.audioBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconLanguage"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            IFrame
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="iframeBlock" type="checkbox"${e.types.iframeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconBoth"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.widget}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="widgetBlock" type="checkbox"${e.types.widgetBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconQuote"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.quote} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="blockquote" type="checkbox"${e.types.blockquote?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSuper"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.superBlock} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="superBlock" type="checkbox"${e.types.superBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconList"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.list1} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="list" type="checkbox"${e.types.list?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconListItem"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.listItem} <sup>[1]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="listItem" type="checkbox"${e.types.listItem?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconFile"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.doc} <sup>[1] [2]</sup>
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="document" type="checkbox"${e.types.document?" checked":""}>
    </label>
    <span class="fn__space"></span>
    <div class="fn__flex-1">
        <div class="b3-label__text">[1] ${window.siyuan.languages.containerBlockTip1}</div>
        <div class="b3-label__text">[2] ${window.siyuan.languages.containerBlockTip2}</div>
    </div>    
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",height:"70vh"});n.element.setAttribute("data-key",Constants.DIALOG_SEARCHTYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{e.types[i.getAttribute("data-type")]=i.checked}),t(),n.destroy()})},zi=e=>{let t="";Object.keys(Constants.SIYUAN_DEFAULT_REPLACETYPES).forEach(i=>{t+=`<label class="fn__flex b3-label">
    <span class="fn__space"></span>
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.replaceTypes[i]}
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" data-type="${i}" type="checkbox"${e.replaceTypes[i]?" checked":""}>
</label>`});const n=new Dialog({title:window.siyuan.languages.replaceType,content:`<div class="b3-dialog__content">${t}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px",height:"70vh"});n.element.setAttribute("data-key",Constants.DIALOG_REPLACETYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{e.replaceTypes[i.getAttribute("data-type")]=i.checked}),n.destroy()})},kd=(e,t)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMethod"),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.keyword,current:e.method===0,click(){e.method=0,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.querySyntax,current:e.method===1,click(){e.method=1,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:"SQL",current:e.method===2,click(){e.method=2,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.regex,current:e.method===3,click(){e.method=3,t()}}).element)},tn=(e,t,n,a,i)=>{e.removed=!1;const s=e;s.name=a,t.push(Object.assign({},s)),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},e),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),fetchPost("/api/storage/setCriterion",{criterion:s},()=>{var o;i.destroy();const l=n.querySelector("#criteria").firstElementChild;l.classList.remove("fn__none"),(o=l.querySelector(".b3-chip--current"))==null||o.classList.remove("b3-chip--current"),l.insertAdjacentHTML("beforeend",`<div data-type="set-criteria" class="b3-chip b3-chip--current b3-chip--middle b3-chip--pointer b3-chip--${["secondary","primary","info","success","warning","error",""][l.childElementCount%7]}">${s.name}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`)})},Ki=(e,t,n)=>{const a=new Dialog({title:window.siyuan.languages.saveCriterion,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});a.element.setAttribute("data-key",Constants.DIALOG_SAVECRITERION);const i=a.element.querySelectorAll(".b3-button");a.bindInput(a.element.querySelector("input"),()=>{i[1].dispatchEvent(new CustomEvent("click"))}),i[0].addEventListener("click",()=>{a.destroy()}),i[1].addEventListener("click",()=>{const s=a.element.querySelector("input"),o=s.value.trim();if(!o){showMessage(window.siyuan.languages._kernel[142]);return}isMobile()?(e.k=document.querySelector("#toolbarSearch").value,e.r=n.querySelector("#toolbarReplace").value):(e.k=n.querySelector("#searchInput").value,e.r=n.querySelector("#replaceInput").value);const l=n.querySelector("#criteria").firstElementChild;let r="",d="";if(t.forEach(c=>{c.name===o&&(r=c.name),Ya(c,e)&&(d=c.name)}),s.blur(),r&&!d)confirmDialog(window.siyuan.languages.confirm,window.siyuan.languages.searchOverwrite,()=>{Array.from(l.children).forEach(c=>{c.textContent===o&&c.remove()}),t.find((c,u)=>{if(c.name===o)return t.splice(u,1),!0}),tn(e,t,n,o,a)});else if(r&&d)if(r===d)a.destroy();else{const c=r===o?d:r;confirmDialog(window.siyuan.languages.confirm,window.siyuan.languages.searchRemoveName.replace("${x}",c).replace("${y}",o),()=>{Array.from(l.children).forEach(u=>{(u.textContent===d||u.textContent===r)&&u.remove()}),t.find((u,f)=>{if(u.name===c||u.name===r)return fetchPost("/api/storage/removeCriterion",{name:c}),t.splice(f,1),!0}),tn(e,t,n,o,a)})}else!r&&d?confirmDialog(window.siyuan.languages.confirm,window.siyuan.languages.searchUpdateName.replace("${x}",d).replace("${y}",o),()=>{Array.from(l.children).forEach(c=>{c.textContent===d&&c.remove()}),t.find((c,u)=>{if(c.name===d)return fetchPost("/api/storage/removeCriterion",{name:d}),t.splice(u,1),!0}),tn(e,t,n,o,a)}):tn(e,t,n,o,a)})},Cd=(e,t,n,a,i,s)=>Vi(void 0,null,function*(){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMore"),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.listInvalidRefBlocks,click(){goUnRef()}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.searchType,click(){Gi(e,()=>{updateSearchResult(e,n,!0)})}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.replaceType,click(){zi(e)}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.searchMethod,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.keyword,current:e.method===0,click(){e.method=0,e.page=1,updateSearchResult(e,n,!0)}},{iconHTML:"",label:window.siyuan.languages.querySyntax,current:e.method===1,click(){e.method=1,e.page=1,updateSearchResult(e,n,!0)}},{iconHTML:"",label:"SQL",current:e.method===2,click(){e.method=2,e.page=1,updateSearchResult(e,n,!0)}},{iconHTML:"",label:window.siyuan.languages.regex,current:e.method===3,click(){e.method=3,e.page=1,updateSearchResult(e,n,!0)}}]}).element);const o=[{iconHTML:"",label:window.siyuan.languages.type,current:e.sort===0,click(){e.sort=0,a()}},{iconHTML:"",label:window.siyuan.languages.createdASC,current:e.sort===1,click(){e.sort=1,a()}},{iconHTML:"",label:window.siyuan.languages.createdDESC,current:e.sort===2,click(){e.sort=2,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:e.sort===3,click(){e.sort=3,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:e.sort===4,click(){e.sort=4,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:e.sort===6,click(){e.sort=6,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:e.sort===7,click(){e.sort=7,a()}}];e.group===1&&o.push({iconHTML:"",label:window.siyuan.languages.sortByContent,current:e.sort===5,click(){e.sort=5,a()}}),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.group,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.noGroupBy,current:e.group===0,click(){isMobile()?(n.querySelector('[data-type="expand"]').classList.add("fn__none"),n.querySelector('[data-type="contract"]').classList.add("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.add("fn__none"),e.group=0,e.sort===5&&(e.sort=0),a()}},{iconHTML:"",label:window.siyuan.languages.groupByDoc,current:e.group===1,click(){isMobile()?(n.querySelector('[data-type="expand"]').classList.remove("fn__none"),n.querySelector('[data-type="contract"]').classList.remove("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.remove("fn__none"),e.group=1,a()}}]}).element),s&&s(),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.saveCriterion,iconHTML:"",click(){Ki(e,t,n)}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.removeCriterion,click(){i()}}).element)}),Ya=(e,t)=>!!(t.group===e.group&&t.hPath===e.hPath&&t.hasReplace===e.hasReplace&&t.k===e.k&&t.method===e.method&&t.r===e.r&&t.sort===e.sort&&objEquals(t.types,e.types)&&objEquals(t.replaceTypes,e.replaceTypes)&&objEquals(t.idPath,e.idPath)),Ad=(e,t,n)=>{fetchPost("/api/storage/getCriteria",{},a=>{let i="";a.data.forEach((s,o)=>{t.push(s);let l=!1;Ya(s,n)&&(l=!0),i+=`<div data-type="set-criteria" class="${l?"b3-chip--current ":""}b3-chip b3-chip--middle b3-chip--pointer b3-chip--${["secondary","primary","info","success","warning","error",""][o%7]}">${escapeHtml(s.name)}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`}),e.innerHTML=`<div class="b3-chips${i?"":" fn__none"}">
    ${i}
</div>`})},Ld=e=>{const t=[];return e.querySelectorAll("mark").forEach(n=>{t.push(n.textContent)}),[...new Set(t)].join(" ")},Sd=(e,t)=>{};let Ua;const Wn=(e,t,n=1)=>{var a;const i=e.parentElement.querySelector(".fn__loading--top");if(!isPaidUser()){i.classList.add("fn__none"),(a=e.querySelector(".search__drag"))==null||a.classList.add("fn__none"),e.querySelector("#searchAssetPreview").classList.add("fn__none"),e.querySelector("#searchAssetList").innerHTML=`<div class="search__empty">
    ${window.siyuan.languages._kernel[214]}
</div>`;return}i.classList.remove("fn__none"),clearTimeout(Ua),Ua=window.setTimeout(()=>{t||(t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET]);const s=e.querySelector('[data-type="assetPrevious"]');n>1?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled");const o=e.querySelector("#searchAssetInput");fetchPost("/api/search/fullTextSearchAssetContent",{page:n,query:o.value,types:t.types,method:t.method,orderBy:t.sort},l=>{var r,d;i.classList.add("fn__none");const c=e.querySelector('[data-type="assetNext"]');n<l.data.pageCount?c.removeAttribute("disabled"):c.setAttribute("disabled","disabled");let u="";l.data.assetContents.forEach((g,p)=>{u+=`<div data-type="search-item" class="b3-list-item${p===0?" b3-list-item--focus":""}" data-id="${g.id}">
<span class="ft__on-surface">${g.ext}</span>
<span class="fn__space"></span>
<span class="b3-list-item__text">${g.content}</span>
<span class="b3-list-item__meta">${g.hSize}</span>
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${escapeAriaLabel(g.path)}">${g.name}</span>
</div>`});const f=e.querySelector("#searchAssetPreview");l.data.assetContents.length>0?(f.classList.remove("fn__none"),(r=e.querySelector(".search__drag"))==null||r.classList.remove("fn__none"),Zi(f,l.data.assetContents[0].id,o.value,t.method)):(f.classList.add("fn__none"),(d=e.querySelector(".search__drag"))==null||d.classList.add("fn__none")),e.querySelector("#searchAssetResult").innerHTML=`<span class="fn__flex-center">${n}/${l.data.pageCount||1}</span><span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.total} ${l.data.matchedAssetCount}</span>`,e.querySelector("#searchAssetList").innerHTML=u||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},Constants.TIMEOUT_INPUT)},xd=e=>{const t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys;if(!t||t.length===0)return;const n=new Menu("search-asset-history");if(n.isOpen)return;n.element.classList.add("b3-menu--list"),n.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys=[],setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET])}});const a=n.addSeparator(1);let i=!0;const s=e.querySelector("#searchAssetInput");t.forEach(l=>{if(l!==s.value&&l){const r=n.addItem({iconHTML:"",label:escapeHtml(l),action:"iconCloseRound",bind(d){d.addEventListener("click",c=>{var u;hasClosestByClassName(c.target,"b3-menu__action")?(t.find((f,g)=>{if(f===l)return t.splice(g,1),!0}),window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys=t,setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET]),(u=d.previousElementSibling)!=null&&u.classList.contains("b3-menu__separator")&&!d.nextElementSibling?window.siyuan.menus.menu.remove():d.remove()):(s.value=d.textContent,Wn(e),window.siyuan.menus.menu.remove()),c.preventDefault(),c.stopPropagation()})}});i&&r.classList.add("b3-menu__item--current"),i=!1}}),i&&a.remove();const o=s.getBoundingClientRect();n.open({x:o.left,y:o.bottom})},Zi=(e,t,n,a)=>{fetchPost("/api/search/getAssetContent",{id:t,query:n,queryMethod:a},i=>{e.innerHTML=`<p style="white-space: pre-wrap;">${i.data.assetContent.content}</p>`;const s=e.querySelector("mark");if(s){s.classList.add("mark--hl");const o=e.getBoundingClientRect();e.scrollTop=e.scrollTop+s.getBoundingClientRect().top-o.top-o.height/2}})},Td=e=>{let t;const n=Array.from(e.querySelectorAll("mark"));if(n.find((a,i)=>{if(a.classList.contains("mark--hl")){a.classList.remove("mark--hl"),t=n[i+1];return}}),t||(t=n[0]),t){t.classList.add("mark--hl");const a=e.getBoundingClientRect();e.scrollTop=e.scrollTop+t.getBoundingClientRect().top-a.top-a.height/2}},Id=(e,t)=>{const n=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method;if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMethod"),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.keyword,current:n===0,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method=0,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.querySyntax,current:n===1,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method=1,t()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.regex,current:n===3,click(){window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method=3,t()}}).element),window.siyuan.menus.menu.fullscreen()},Xi=e=>{let t="";return Constants.SIYUAN_ASSETS_SEARCH.sort((n,a)=>n.localeCompare(a)).forEach(n=>{t+=`<label class="fn__flex b3-label">
        <div class="fn__flex-1 fn__flex-center">
            ${n}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="${n}" type="checkbox" ${e[n]?" checked":""}>
    </label>`}),t},Dd=e=>{const t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].types,n=new Dialog({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">${Xi(t)}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px",height:"70vh"});n.element.setAttribute("data-key",Constants.DIALOG_SEARCHASSETSTYPE);const a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{t[i.getAttribute("data-type")]=i.checked}),Wn(e),setStorageVal(Constants.LOCAL_SEARCHASSET,window.siyuan.storage[Constants.LOCAL_SEARCHASSET]),n.destroy()})},Md=(e,t,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMore");const a=window.siyuan.storage[Constants.LOCAL_SEARCHASSET],i=[{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:a.sort===1,click(){a.sort=1,n()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:a.sort===0,click(){a.sort=0,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:a.sort===3,click(){a.sort=3,n()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:a.sort===2,click(){a.sort=2,n()}}];window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:i}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.rebuildIndex,click(){if(!isPaidUser()){showMessage(window.siyuan.languages._kernel[214]);return}t.parentElement.querySelector(".fn__loading--top").classList.remove("fn__none"),fetchPost("/api/asset/fullReindexAssetContent",{},()=>{Wn(t,a)})}}).element),window.siyuan.menus.menu.fullscreen()},Wa=(e,t,n)=>{if(t.method===1||t.method===2){showMessage(window.siyuan.languages._kernel[132]);return}const a=e.querySelector("#searchList"),i=e.querySelector("#toolbarReplace"),s=i.parentElement.querySelector(".fn__rotate");if(!s.classList.contains("fn__none"))return;let o=a.querySelector(".b3-list-item--focus");if(!o)return;s.classList.remove("fn__none"),s.nextElementSibling.classList.add("fn__none");let l=[];n?a.querySelectorAll('.b3-list-item[data-type="search-item"]').forEach(r=>{l.push(r.getAttribute("data-node-id"))}):l=[o.getAttribute("data-node-id")],fetchPost("/api/search/findReplace",{k:t.method===0?getKeyByLiElement(o):document.querySelector("#toolbarSearch").value,r:i.value,ids:l,types:t.types,method:t.method,replaceTypes:t.replaceTypes},r=>{var d;if(s.classList.add("fn__none"),s.nextElementSibling.classList.remove("fn__none"),r.code===1){showMessage(r.msg);return}if(!(l.length>1)){if(reloadProtyle(window.siyuan.mobile.editor.protyle,!1),o.nextElementSibling?o.nextElementSibling.classList.add("b3-list-item--focus"):o.previousElementSibling&&o.previousElementSibling.classList.add("b3-list-item--focus"),t.group===1)if(o.nextElementSibling||o.previousElementSibling)o.remove();else{const c=o.parentElement.nextElementSibling||((d=o.parentElement.previousElementSibling.previousElementSibling)==null?void 0:d.previousElementSibling);c&&(c.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"),c.nextElementSibling.classList.remove("fn__none"),c.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open")),o.parentElement.previousElementSibling.remove(),o.parentElement.remove()}else o.remove();if(o=a.querySelector(".b3-list-item--focus"),!o){a.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`;return}(a.scrollTop<o.offsetTop-a.clientHeight+30||a.scrollTop>o.offsetTop)&&(a.scrollTop=o.offsetTop-a.clientHeight+30)}})},jn=(e,t,n)=>{n.hasReplace!==t.hasReplace&&(t.hasReplace?(e.querySelector('[data-type="toggle-replace"]').classList.add("toolbar__icon--active"),e.querySelector(".toolbar").classList.remove("fn__none")):(e.querySelector('[data-type="toggle-replace"]').classList.remove("toolbar__icon--active"),e.querySelector(".toolbar").classList.add("fn__none")));const a=e.querySelector("#searchPath");t.hPath?(a.classList.remove("fn__none"),a.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(t.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`):a.classList.add("fn__none"),n.group!==t.group&&(t.group===0?(e.querySelector('[data-type="expand"]').classList.add("fn__none"),e.querySelector('[data-type="contract"]').classList.add("fn__none")):(e.querySelector('[data-type="expand"]').classList.remove("fn__none"),e.querySelector('[data-type="contract"]').classList.remove("fn__none")));let i=!0,s=!1;t.idPath.forEach(l=>{l.endsWith(".sy")&&(i=!1),l.split("/").length>1&&(s=!0)});const o=e.querySelector('[data-type="include"]');i?o.classList.add("toolbar__icon--active"):o.classList.remove("toolbar__icon--active"),s?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),document.querySelector("#toolbarSearch").value=t.k,e.querySelector("#toolbarReplace").value=t.r,Object.assign(n,t),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},n),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),Oe(n,e),window.siyuan.menus.menu.remove()},ja=(e,t,n)=>{const a=document.querySelector("#searchList");let i="";e.forEach((o,l)=>{const r=getNotebookName(o.box)+getDisplayName(o.hPath,!1);o.children?(i+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${unicode2Emoji(getNotebookIcon(o.box)||Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text" style="color: var(--b3-theme-on-surface)">${escapeGreat(r)}</span>
</div><div>`,o.children.forEach((d,c)=>{i+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item${c===0&&l===0?" b3-list-item--focus":""}" data-node-id="${d.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(d.type)}"></use></svg>
${unicode2Emoji(d.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${d.content}</span>
</div>`}),i+="</div>"):i+=`<div class="b3-list-item b3-list-item--two${l===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${o.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(o.type)}"></use></svg>
    ${unicode2Emoji(o.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${o.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${escapeGreat(r)}</span>
</div>`}),a.innerHTML=i||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${document.querySelector("#toolbarSearch").value}</mark>
    </span>
</div>`,a.scrollTop=0;let s="";n&&(s=`<span class="fn__flex-center">${window.siyuan.languages.findInDoc.replace("${x}",n.data.matchedRootCount).replace("${y}",n.data.matchedBlockCount)}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${t.page}/${n.data.pageCount||1}</span>`),a.previousElementSibling.querySelector('[data-type="result"]').innerHTML=s};let Va=0;const Oe=(e,t,n=!1)=>{clearTimeout(Va),Va=window.setTimeout(()=>{var a;n&&((a=t.querySelector("#criteria .b3-chip--current"))==null||a.classList.remove("b3-chip--current"));const i=t.querySelector(".fn__loading--top");i.classList.remove("fn__none");const s=t.querySelector('[data-type="previous"]'),o=t.querySelector('[data-type="next"]'),l=document.getElementById("toolbarSearch");l.value===""&&(!e.idPath||e.idPath.length===0)?fetchPost("/api/block/getRecentUpdatedBlocks",{},r=>{ja(r.data,e),i.classList.add("fn__none"),s.setAttribute("disabled","true"),o.setAttribute("disabled","true")}):(e.page||(e.page=1),e.page>1?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),fetchPost("/api/search/fullTextSearchBlock",{query:l.value,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page},r=>{ja(r.data.blocks,e,r),i.classList.add("fn__none"),e.page<r.data.pageCount?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled")}))},Constants.TIMEOUT_INPUT)},Ji=(e,t,n)=>{const a=document.getElementById("toolbarSearch");a.value=n.k||"",a.addEventListener("compositionend",c=>{c&&c.isComposing||(n.page=1,Oe(n,t,!0))}),a.addEventListener("input",c=>{c&&c.isComposing||(n.page=1,Oe(n,t,!0))}),a.addEventListener("blur",()=>{n.removed&&(n.k=a.value,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},n),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]))}),addClearButton({inputElement:a,className:"toolbar__icon",clearCB(){n.page=1,Oe(n,t)}});const i=t.querySelector(".toolbar .toolbar__title");i.value=n.r||"",addClearButton({inputElement:i,className:"toolbar__icon"});const s=[];initCriteriaMenu(t.querySelector("#criteria"),s,n);const o=document.querySelector("#searchAssetsPanel"),l=document.querySelector("#searchUnRefPanel"),r=t.querySelector("#searchList"),d=window.siyuan.storage[Constants.LOCAL_SEARCHASSET];t.addEventListener("click",c=>{var u,f;let g=c.target;for(;g&&!g.isSameNode(t);){const p=g.getAttribute("data-type");if(p==="previous"){g.getAttribute("disabled")||(n.page--,Oe(n,t)),c.stopPropagation(),c.preventDefault();break}else if(p==="next"){g.getAttribute("disabled")||(n.page++,Oe(n,t)),c.stopPropagation(),c.preventDefault();break}else if(p==="set-criteria"){n.removed=!1,(u=g.parentElement.querySelector(".b3-chip--current"))==null||u.classList.remove("b3-chip--current"),g.classList.add("b3-chip--current"),s.find(m=>{if(m.name===g.innerText.trim())return jn(t,m,n),!0}),c.stopPropagation(),c.preventDefault();break}else if(p==="remove-criteria"){const m=g.parentElement.innerText.trim();fetchPost("/api/storage/removeCriterion",{name:m}),s.find((y,v)=>{if(y.name===m)return s.splice(v,1),!0}),g.parentElement.classList.contains("b3-chip--current")&&jn(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:getDefaultType(),replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},n),g.parentElement.parentElement.childElementCount===1&&g.parentElement.parentElement.classList.add("fn__none"),g.parentElement.remove(),c.stopPropagation(),c.preventDefault();break}else if(p==="remove-path"){n.idPath=[],n.hPath="",t.querySelector("#searchPath").classList.add("fn__none"),n.page=1,Oe(n,t,!0);const m=t.querySelector('[data-type="include"]');m.classList.remove("toolbar__icon--active"),m.setAttribute("disabled","disabled"),c.stopPropagation(),c.preventDefault();break}else if(p==="expand"){Array.from(r.children).forEach(m=>{m.classList.contains("b3-list-item")&&(m.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),m.nextElementSibling.classList.remove("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(p==="contract"){Array.from(r.children).forEach(m=>{m.classList.contains("b3-list-item")&&(m.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),m.nextElementSibling.classList.add("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(p==="currentPath"&&!g.hasAttribute("disabled")){const m=getCurrentEditor().protyle;fetchPost("/api/filetree/getHPathsByPaths",{paths:[m.path]},y=>{n.idPath=[pathPosix().join(m.notebookId,m.path)],n.hPath=y.data[0];const v=t.querySelector("#searchPath");v.classList.remove("fn__none"),v.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const b=t.querySelector('[data-type="include"]');b.classList.remove("toolbar__icon--active"),b.removeAttribute("disabled"),n.page=1,Oe(n,t,!0)}),c.stopPropagation(),c.preventDefault();break}else if(p==="path"){movePathTo((m,y)=>{fetchPost("/api/filetree/getHPathsByPaths",{paths:m},v=>{n.idPath=[];const b=[];let w=!1;m.forEach((k,E)=>{k==="/"?(n.idPath.push(y[E]),b.push(getNotebookName(y[E]))):(w=!0,n.idPath.push(pathPosix().join(y[E],k.replace(".sy",""))))}),v.data&&b.push(...v.data),n.hPath=b.join(" ");const h=t.querySelector("#searchPath");h.classList.remove("fn__none"),h.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const C=t.querySelector('[data-type="include"]');C.classList.add("toolbar__icon--active"),w?C.removeAttribute("disabled"):C.setAttribute("disabled","disabled"),n.page=1,Oe(n,t,!0)})},[],void 0,window.siyuan.languages.specifyPath),c.stopPropagation(),c.preventDefault();break}else if(p==="include"&&!g.hasAttribute("disabled")){g.classList.toggle("toolbar__icon--active"),g.classList.contains("toolbar__icon--active")?n.idPath.forEach((m,y)=>{m.endsWith(".sy")&&(n.idPath[y]=m.replace(".sy",""))}):n.idPath.forEach((m,y)=>{!m.endsWith(".sy")&&m.split("/").length>1&&(n.idPath[y]=m+".sy")}),n.page=1,Oe(n,t,!0),c.stopPropagation(),c.preventDefault();break}else if(p==="toggle-replace"){n.hasReplace=!n.hasReplace,i.parentElement.classList.toggle("fn__none"),g.classList.toggle("toolbar__icon--active"),c.stopPropagation(),c.preventDefault();break}else if(p==="more"){moreMenu(n,s,t,()=>{n.page=1,Oe(n,t,!0)},()=>{jn(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:getDefaultType(),replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},n)}),window.siyuan.menus.menu.fullscreen(),c.stopPropagation(),c.preventDefault();break}else if(p==="replace-all"){Wa(t,n,!0),c.stopPropagation(),c.preventDefault();break}else if(p==="refreshUnRef"){nn(l),c.stopPropagation(),c.preventDefault();break}else if(p==="unRefPrevious"){if(!g.getAttribute("disabled")){let m=parseInt(l.querySelector("#searchUnRefResult").lastElementChild.textContent);m>1&&(m--,nn(l,m))}c.stopPropagation(),c.preventDefault();break}else if(p==="unRefNext"){const m=l.querySelector("#searchUnRefResult").lastElementChild;let y=parseInt(m.textContent);y<parseInt(m.textContent.split("/")[1])&&(y++,nn(l,y)),c.stopPropagation(),c.preventDefault();break}else if(p==="queryAsset"){assetMethodMenu(g,()=>{assetInputEvent(o,d),setStorageVal(Constants.LOCAL_SEARCHASSET,d)}),c.stopPropagation(),c.preventDefault();break}else if(p==="filterAsset"){assetFilterMenu(o),c.stopPropagation(),c.preventDefault();break}else if(p==="moreAsset"){assetMoreMenu(g,o,()=>{assetInputEvent(o),setStorageVal(Constants.LOCAL_SEARCHASSET,d)}),c.stopPropagation(),c.preventDefault();break}else if(p==="goAsset"){Qi(),c.stopPropagation(),c.preventDefault();break}else if(p==="goSearch"){o.classList.add("fn__none"),l.classList.add("fn__none"),c.stopPropagation(),c.preventDefault();break}else if(p==="assetPrevious"){g.getAttribute("disabled")||assetInputEvent(o,d,parseInt(o.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])-1),c.stopPropagation(),c.preventDefault();break}else if(p==="assetNext"){g.getAttribute("disabled")||assetInputEvent(o,d,parseInt(o.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])+1),c.stopPropagation(),c.preventDefault();break}else if(p==="replace"){Wa(t,n,!1),c.stopPropagation(),c.preventDefault();break}else if(g.classList.contains("b3-list-item__toggle")){g.parentElement.nextElementSibling.classList.toggle("fn__none"),g.firstElementChild.classList.toggle("b3-list-item__arrow--open"),c.stopPropagation(),c.preventDefault();break}else if(g.classList.contains("b3-list-item")){if(g.getAttribute("data-type")==="search-new")newFileByName(e,a.value);else if(g.getAttribute("data-type")==="search-item"){const m=g.getAttribute("data-node-id");m?((f=window.siyuan.mobile.editor)!=null&&f.protyle&&preventScroll(window.siyuan.mobile.editor.protyle),checkFold(m,y=>{openMobileFileById(e,m,y?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL])}),closePanel()):g.classList.contains("b3-list-item--focus")?g.classList.contains("b3-list-item--focus")&&renderNextAssetMark(t.querySelector("#searchAssetPreview")):(t.querySelector("#searchAssetList .b3-list-item--focus").classList.remove("b3-list-item--focus"),g.classList.add("b3-list-item--focus"),renderPreview(t.querySelector("#searchAssetPreview"),g.dataset.id,t.querySelector("#searchAssetInput").value,window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method))}else g.querySelector(".b3-list-item__toggle")&&(g.nextElementSibling.classList.toggle("fn__none"),g.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));c.stopPropagation(),c.preventDefault();break}g=g.parentElement}},!1)},$d=(e,t)=>{var n;const a=JSON.parse(JSON.stringify(window.siyuan.storage[Constants.LOCAL_SEARCHDATA])),i=(((n=getCurrentEditor())==null?void 0:n.protyle.toolbar.range)||(getSelection().rangeCount>0?getSelection().getRangeAt(0):document.createRange())).toString();i&&(a.k=i),t&&Object.keys(t).forEach(l=>{a[l]=t[l]}),activeBlur(),hideKeyboardToolbar();let s=!0,o=!1;a.idPath.forEach(l=>{l.endsWith(".sy")&&(s=!1),l.split("/").length>1&&(o=!0)}),openModel({title:`<div class="fn__flex">
    <input id="toolbarSearch" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" class="toolbar__title fn__block">
    <svg id="toolbarSearchNew" class="toolbar__icon"><use xlink:href="#iconFile"></use></svg>
</div>`,icon:"iconSearch",html:`<div class="fn__flex-column" style="height: 100%">
    <div class="toolbar toolbar--border${a.hasReplace?"":" fn__none"}">
        <svg class="toolbar__icon"><use xlink:href="#iconReplace"></use></svg>
        <input id="toolbarReplace" class="toolbar__title">
        <svg class="fn__rotate fn__none toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
        <div class="fn__space"></div>
        <button data-type="replace-all" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button data-type="replace" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" style="background-color: var(--b3-theme-background);"></div>
    <div class="toolbar">
        <span class="fn__space"></span>
        <span data-type="result" class="fn__flex-1 fn__flex"></span>
        <span class="fn__space"></span>
        <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
        <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
    </div>
    <div id="searchList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
    <div id="searchPath" class="b3-chips${a.hPath?"":" fn__none"}" style="background-color: var(--b3-theme-background);">
        <div class="b3-chip b3-chip--middle">
            ${escapeHtml(a.hPath)}
            <svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg>
        </div>
    </div>
    <div class="toolbar">
        <span class="fn__flex-1"></span>
        <svg data-type="toggle-replace" class="toolbar__icon${a.hasReplace?" toolbar__icon--active":""}"><use xlink:href="#iconReplace"></use></svg>
        <svg ${o?"":"disabled"} data-type="include" class="toolbar__icon${s?" toolbar__icon--active":""}"><use xlink:href="#iconCopy"></use></svg>
        <svg data-type="path" class="toolbar__icon"><use xlink:href="#iconFolder"></use></svg>
        <svg ${document.querySelector("#empty").classList.contains("fn__none")?"":"disabled"} data-type="currentPath" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
        <svg data-type="expand" class="toolbar__icon${a.group===0?" fn__none":""}"><use xlink:href="#iconExpand"></use></svg>
        <svg data-type="contract" class="toolbar__icon${a.group===0?" fn__none":""}"><use xlink:href="#iconContract"></use></svg>
        <svg data-type="more" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
        <svg data-type="goAsset" class="toolbar__icon"><use xlink:href="#iconExact"></use></svg>
        <span class="fn__flex-1"></span>
     </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchAssetsPanel">
        <div class="toolbar toolbar--border">
            <svg class="toolbar__icon"><use xlink:href="#iconSearch"></use></svg>
            <input id="searchAssetInput" placeholder="${window.siyuan.languages.keyword}" class="toolbar__title fn__block">
        </div>
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchAssetResult" class="fn__flex-1 fn__flex"><span class="fn__flex-1"></span></span>
            <span class="fn__space"></span>
            <svg data-type="assetPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="assetNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchAssetList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;border-bottom: 1px solid var(--b3-border-color);"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="queryAsset" class="toolbar__icon"><use xlink:href="#iconRegex"></use></svg>
            <svg data-type="filterAsset" class="toolbar__icon"><use xlink:href="#iconFilter"></use></svg>
            <svg data-type="moreAsset" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchUnRefPanel">
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchUnRefResult" class="fn__flex-1 fn__flex"></span>
            <span class="fn__space"></span>
            <svg data-type="unRefPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="unRefNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchUnRefList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="refreshUnRef" class="toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>
</div>`,bindEvent(l){document.querySelector("#toolbarSearchNew").addEventListener("click",()=>{newFileByName(e,document.querySelector("#toolbarSearch").value)}),Ji(e,l.firstElementChild,a),Oe(a,l)}})},Qi=()=>{const e=document.querySelector("#searchAssetsPanel");if(e.classList.remove("fn__none"),e.querySelector("#searchAssetList").innerHTML)return;const n=window.siyuan.storage[Constants.LOCAL_SEARCHASSET],a=e.querySelector("input");a.value=n.k,a.addEventListener("compositionend",i=>{i.isComposing||assetInputEvent(e,n)}),a.addEventListener("input",i=>{i.isComposing||assetInputEvent(e,n)}),assetInputEvent(e,n),addClearButton({inputElement:a,className:"toolbar__icon",clearCB(){assetInputEvent(e,n)}})},Hd=()=>{window.siyuan.menus.menu.remove();const e=document.querySelector("#searchUnRefPanel");e.classList.remove("fn__none"),!e.querySelector("#searchUnRefList").innerHTML&&nn(e)},nn=(e,t=1)=>{const n=e.querySelector('[data-type="unRefPrevious"]');t>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled"),fetchPost("/api/search/listInvalidBlockRefs",{page:t},a=>{e.parentElement.querySelector(".fn__loading--top").classList.add("fn__none");const i=e.querySelector('[data-type="unRefNext"]');t<a.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled");let s="";a.data.blocks.forEach((o,l)=>{const r=getNotebookName(o.box)+getDisplayName(o.hPath,!1);s+=`<div class="b3-list-item b3-list-item--two${l===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${o.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(o.type)}"></use></svg>
    ${unicode2Emoji(o.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${o.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${escapeGreat(r)}</span>
</div>`}),e.querySelector("#searchUnRefResult").innerHTML=`<span class="fn__flex-center">${window.siyuan.languages.findInDoc.replace("${x}",a.data.matchedRootCount).replace("${y}",a.data.matchedBlockCount)}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${t}/${a.data.pageCount||1}</span>`,e.querySelector("#searchUnRefList").innerHTML=s||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},Nd=(e,t,n)=>{const a=isMobile(),i=hasClosestByClassName(e.target,"protyle-attr--bookmark");if(i)return!a&&isOnlyMeta(e)||(n?openFileAttr(n,"bookmark",t):openAttr(i.parentElement.parentElement,"bookmark",t)),e.stopPropagation(),!0;const s=hasClosestByClassName(e.target,"protyle-attr--name");if(s)return!a&&isOnlyMeta(e)||(n?openFileAttr(n,"name",t):openAttr(s.parentElement.parentElement,"name",t)),e.stopPropagation(),!0;const o=hasClosestByClassName(e.target,"protyle-attr--av");if(o)return n?openFileAttr(n,"av",t):openAttr(o.parentElement.parentElement,"av",t),e.stopPropagation(),!0;const l=hasClosestByClassName(e.target,"protyle-attr--alias");if(l)return!a&&isOnlyMeta(e)||(n?openFileAttr(n,"alias",t):openAttr(l.parentElement.parentElement,"alias",t)),e.stopPropagation(),!0;const r=hasClosestByClassName(e.target,"protyle-attr--memo");if(r)return!a&&isOnlyMeta(e)||(n?openFileAttr(n,"memo",t):openAttr(r.parentElement.parentElement,"memo",t)),e.stopPropagation(),!0},Bd=e=>{if(e.protyle.disabled)return;const t=new Menu("av-view");if(t.isOpen)return;t.addItem({icon:"iconEdit",label:window.siyuan.languages.rename,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove(),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"config",cb:i=>{i.querySelector('.b3-text-field[data-type="name"]').focus()}})}}),t.addItem({icon:"iconSettings",label:window.siyuan.languages.config,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove(),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"config"})}}),t.addSeparator(),t.addItem({icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove();const i=Lute.NewNodeID();transaction(e.protyle,[{action:"duplicateAttrViewView",avID:e.blockElement.dataset.avId,previousID:e.element.dataset.id,id:i,blockID:e.blockElement.dataset.nodeId}],[{action:"removeAttrViewView",avID:e.blockElement.dataset.avId,id:i,blockID:e.blockElement.dataset.nodeId}]),e.blockElement.setAttribute(Constants.CUSTOM_SY_AV_VIEW,i)}}),e.blockElement.querySelectorAll(".layout-tab-bar .item").length>1&&t.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){var a;(a=document.querySelector(".av__panel"))==null||a.remove(),transaction(e.protyle,[{action:"removeAttrViewView",avID:e.blockElement.dataset.avId,id:e.element.dataset.id,blockID:e.blockElement.dataset.nodeId}])}});const n=e.element.getBoundingClientRect();t.open({x:n.left,y:n.bottom})},Pd=e=>{const t=e.menuElement.querySelector('.b3-text-field[data-type="name"]');t.addEventListener("blur",()=>{t.value!==t.dataset.value&&(transaction(e.protyle,[{action:"setAttrViewViewName",avID:e.data.id,id:e.data.viewID,data:t.value}],[{action:"setAttrViewViewName",avID:e.data.id,id:e.data.viewID,data:t.dataset.value}]),t.dataset.value=t.value)}),t.addEventListener("keydown",a=>{a.isComposing||a.key==="Enter"&&(a.preventDefault(),t.blur(),e.menuElement.parentElement.remove())}),t.select();const n=e.menuElement.querySelector('.b3-switch[data-type="toggle-view-title"]');n.addEventListener("change",()=>{const a=e.blockElement.getAttribute("data-av-id"),i=e.blockElement.getAttribute("data-node-id");n.checked?(transaction(e.protyle,[{action:"hideAttrViewName",avID:a,blockID:i,data:!1}],[{action:"hideAttrViewName",avID:a,blockID:i,data:!0}]),e.blockElement.querySelector(".av__title").classList.remove("fn__none")):(transaction(e.protyle,[{action:"hideAttrViewName",avID:a,blockID:i,data:!0}],[{action:"hideAttrViewName",avID:a,blockID:i,data:!1}]),e.blockElement.querySelector(".av__title").classList.add("fn__none"))})},Rd=e=>{const t=e.view;return`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label ft__center">${window.siyuan.languages.config}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span style="padding: 5px;margin-right: 8px;width: 14px;font-size: 14px;" class="block__icon block__icon--show" data-icon="${t.icon}" data-type="update-view-icon">${t.icon?unicode2Emoji(t.icon):'<svg><use xlink:href="#iconTable"></use></svg>'}</span>
    <span class="b3-menu__label" style="padding: 4px;display: flex;"><input data-type="name" class="b3-text-field fn__block" type="text" value="${t.name}" data-value="${t.name}"></span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="go-properties">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.attr}</span>
    <span class="b3-menu__accelerator">${t.columns.filter(n=>!n.hidden).length}/${t.columns.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconFilter"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.filter}</span>
    <span class="b3-menu__accelerator">${t.filters.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconSort"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${t.sorts.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="set-page-size" data-size="${t.pageSize}">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.entryNum}</span>
    <span class="b3-menu__accelerator">${t.pageSize===Constants.SIZE_DATABASE_MAZ_SIZE?window.siyuan.languages.all:t.pageSize}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <svg class="b3-menu__icon"></svg>
    <span class="fn__flex-center">${window.siyuan.languages.showTitle}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="toggle-view-title" type="checkbox" class="b3-switch b3-switch--menu" ${t.hideAttrViewName?"":"checked"}>
</label>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="duplicate-view">
    <svg class="b3-menu__icon">
        <use xlink:href="#iconCopy"></use>
    </svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item${e.views.length>1?"":" fn__none"}" data-type="delete-view">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},Od=e=>{const t=e.menuElement.querySelector(".b3-text-field");t.focus(),t.addEventListener("keydown",n=>{if(n.stopPropagation(),!n.isComposing)if(upDownHint(e.menuElement.querySelector(".fn__flex-1"),n,"b3-menu__item--current"),n.key==="Enter"){const a=e.menuElement.querySelector(".b3-menu__item--current");a&&(e.blockElement.removeAttribute("data-render"),avRender(e.blockElement,e.protyle,void 0,a.dataset.id),e.menuElement.remove(),focusBlock(e.blockElement))}else n.key==="Escape"&&(e.menuElement.remove(),focusBlock(e.blockElement))}),t.addEventListener("input",n=>{n.isComposing||Ga(e.menuElement)}),t.addEventListener("compositionend",()=>{Ga(e.menuElement)})},Ga=e=>{var t;const a=e.querySelector(".b3-text-field").value;e.querySelectorAll('.b3-menu__item[draggable="true"]').forEach(i=>{!a||a.toLowerCase().indexOf(i.textContent.trim().toLowerCase())>-1||i.textContent.trim().toLowerCase().indexOf(a.toLowerCase())>-1?i.classList.remove("fn__none"):(i.classList.add("fn__none"),i.classList.remove("b3-menu__item--current"))}),e.querySelector(".b3-menu__item--current")||(t=e.querySelector(".fn__flex-1 .b3-menu__item:not(.fn__none)"))==null||t.classList.add("b3-menu__item--current")},qd=(e,t)=>{let n="";return e.forEach(a=>{n+=`<button draggable="true" class="b3-menu__item${a.id===t?" b3-menu__item--current":""}" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex" data-type="av-view-switch">
        ${a.icon?unicode2Emoji(a.icon,"b3-menu__icon",!0):'<svg class="b3-menu__icon"><use xlink:href="#iconTable"></use></svg>'}
        ${a.name}
    </div>
    <svg class="b3-menu__action" data-type="av-view-edit"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items fn__flex-column">
<button class="b3-menu__item" data-type="av-add">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.newView}</span>
</button>
<button class="b3-menu__separator"></button>
<div class="b3-menu__item b3-menu__item--readonly fn__flex-shrink" data-type="nobg">
    <input class="b3-text-field fn__block" type="text" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">
</div>
<div class="fn__flex-1" style="overflow: auto">
    ${n}
</div>
</div>`},Fd=(e,t)=>{const n=Lute.NewNodeID(),a=t.getAttribute("data-av-id");transaction(e,[{action:"addAttrViewView",avID:a,id:n,blockID:t.getAttribute("data-node-id")}],[{action:"removeAttrViewView",avID:a,id:n,blockID:t.getAttribute("data-node-id")}]),t.setAttribute(Constants.CUSTOM_SY_AV_VIEW,n)};class Yd{constructor(t){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),isMobile()?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(t),!t.options.action.includes(Constants.CB_GET_HISTORY)&&(this.bindEvent(t),keydown(t,this.element),dropEvent(t,this.element))}renderCustom(t){let n=t[Constants.CUSTOM_SY_FULLWIDTH];n||(n=window.siyuan.config.editor.fullWidth?"true":"false"),n==="true"?this.element.parentElement.setAttribute("data-fullwidth","true"):this.element.parentElement.removeAttribute("data-fullwidth");const a=Object.keys(t);for(let i=0;i<this.element.attributes.length;i++){const s=this.element.attributes[i].nodeName;!["type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(s)&&!a.includes(s)&&(this.element.removeAttribute(s),i--)}a.forEach(i=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth","data-readonly"].includes(i)||this.element.setAttribute(i,t[i])})}escapeInline(t,n,a){if(!a.data&&a.inputType!=="insertLineBreak")return;const i=a.data;t.toolbar.range=n;const s=n.startContainer.parentElement,o=t.toolbar.getCurrentType();if(a.inputType==="insertLineBreak"){o.length>0&&n.toString()===""&&s.tagName==="SPAN"&&s.textContent.startsWith(`
`)&&n.startContainer.previousSibling&&n.startContainer.previousSibling.textContent===`
`&&s.before(n.startContainer.previousSibling);return}let l=i.length;if(i==="<"||i===">"?l=4:i==="&"&&(l=5),o.length>0&&n.toString()===""&&n.startOffset===i.length&&s.tagName==="SPAN"&&s.textContent.replace(Constants.ZWSP,"")!==i&&s.textContent.replace(Constants.ZWSP,"").length>=i.length&&!hasPreviousSibling(n.startContainer)&&!hasPreviousSibling(s)){const r=s.innerHTML.replace(Constants.ZWSP,"");s.innerHTML=r.substr(l);const d=document.createTextNode(i);s.before(d),n.selectNodeContents(d),n.collapse(!1);return}if(s.tagName==="SPAN"&&s.textContent!==i&&!o.includes("search-mark")&&n.toString()===""&&n.startContainer.nodeType===3&&(o.includes("inline-memo")||o.includes("text")||o.includes("block-ref")||o.includes("file-annotation-ref")||o.includes("a"))&&!hasNextSibling(n.startContainer)&&n.startContainer.textContent.length===n.startOffset&&s.textContent.length>i.length){const r=getSelectionOffset(s,t.wysiwyg.element,n),d=s.innerHTML;if(r.start===s.textContent.length){s.innerHTML=d.substr(0,d.length-l);const c=document.createTextNode(i);s.after(c),n.selectNodeContents(c),n.collapse(!1)}}}setEmptyOutline(t,n){t.wysiwyg.element.querySelectorAll(".img--select, .av__cell--select, .av__cell--active, .av__row--select").forEach(i=>{var s;i.classList.contains("av__row--select")&&!hasClosestByClassName(n,"av")?(i.classList.remove("av__row--select"),i.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),updateHeader(i)):(i.classList.remove("img--select","av__cell--select","av__cell--active"),(s=i.querySelector(".av__drag-fill"))==null||s.remove())});let a=n;if(!n.getAttribute("data-node-id")){const i=hasClosestBlock(n);if(!i)return;a=i}t.disabled&&(t.toolbar.range=getEditorRange(a))}emojiToMd(t){t.querySelectorAll(".emoji").forEach(n=>{n.outerHTML=`:${n.getAttribute("alt")}:`})}bindCommonEvent(t){this.element.addEventListener("copy",n=>{if(window.siyuan.ctrlIsPressed=!1,n.target.tagName==="PROTYLE-HTML"||n.target.localName==="input"){n.stopPropagation();return}n.stopPropagation(),n.preventDefault();const a=getEditorRange(t.wysiwyg.element),i=hasClosestBlock(a.startContainer);if(!i)return;const s=i.querySelector(".img--select"),o=i.querySelector(".av__row--select, .av__cell--select");let l=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));l.length===0&&a.toString()===""&&!a.cloneContents().querySelector("img")&&!s&&!o&&(i.classList.add("protyle-wysiwyg--select"),countBlockWord([i.getAttribute("data-node-id")]),l=[i]);let r="",d="";if(l.length>0){const c=l[0].getAttribute("data-reftext")==="true";l[0].getAttribute("data-type")==="NodeListItem"&&l[0].parentElement.classList.contains("list")&&l[0].parentElement.childElementCount-1===l.length?c?r=getTextStar(l[0].parentElement):r=l[0].parentElement.outerHTML:l.forEach((u,f)=>{c&&f===0?r+=getTextStar(u)+`

`:r+=removeEmbed(u)}),c&&l[0].removeAttribute("data-reftext")}else if(o){const c=Array.from(i.querySelectorAll(".av__cell--active, .av__cell--select"))||[];c.length===0&&i.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(u=>{u.querySelectorAll(".av__cell").forEach(f=>{c.push(f)})}),c.length>0&&(r="[",c.forEach((u,f)=>{const g=getCellText(u);(f===0||!c[f-1].isSameNode(u.previousElementSibling))&&(r+="["),r+=JSON.stringify(genCellValueByElement(getTypeByCellElement(u),u))+",",(f===c.length-1||!c[f+1].isSameNode(u.nextElementSibling))&&(r=r.substring(0,r.length-1)+"],"),d+=g+(c[f+1]&&u.nextElementSibling&&u.nextElementSibling.isSameNode(c[f+1])?"	":`

`)}),d=d.substring(0,d.length-2),r=r.substring(0,r.length-1)+"]")}else{const c=document.createElement("div"),u=t.toolbar.getCurrentType(a);if((u.length>0||a.startContainer.parentElement.parentElement.getAttribute("data-type")==="NodeHeading")&&(a.startContainer.nodeType===3&&a.startContainer.parentElement.textContent===a.toString()||a.startContainer.nodeType!==3&&a.startContainer.textContent===a.toString()))a.startContainer.parentElement.parentElement.getAttribute("data-type")==="NodeHeading"?c.append(a.startContainer.parentElement.parentElement.cloneNode(!0)):["DIV","TD","TH","TR"].includes(a.startContainer.parentElement.tagName)?(c.append(a.cloneContents()),this.emojiToMd(c)):(c.append(a.startContainer.parentElement.cloneNode(!0)),this.emojiToMd(c)),r=c.innerHTML;else if(s)r=s.outerHTML;else if(u.length>0&&a.startContainer.nodeType===3&&a.startContainer.parentElement.tagName==="SPAN"&&a.startContainer.parentElement.isSameNode(a.endContainer.parentElement)){const f=a.startContainer.parentElement.attributes,g=document.createElement("span");for(let p=0;p<f.length;p++)g.setAttribute(f[p].name,f[p].value);g.getAttribute("data-type").indexOf("block-ref")>-1&&g.getAttribute("data-subtype")==="d"&&g.setAttribute("data-subtype","s"),g.textContent=a.toString(),r=g.outerHTML}else{c.append(a.cloneContents()),this.emojiToMd(c);const f=hasClosestByAttribute(a.commonAncestorContainer,"data-type","inline-math");f?r=f.outerHTML:r=c.innerHTML,hasClosestByAttribute(a.startContainer,"data-type","NodeCodeBlock")?d=c.textContent.replace(Constants.ZWSP,"").replace(/\n$/,""):hasClosestByMatchTag(a.startContainer,"CODE")&&(d=c.textContent.replace(Constants.ZWSP,""))}}t.disabled&&(r=getEnableHTML(r)),d=d||t.lute.BlockDOM2StdMd(r).trimEnd(),d=d.replace(/\u00A0/g," "),n.clipboardData.setData("text/plain",d),n.clipboardData.setData("text/html",t.lute.BlockDOM2HTML(o?d:r)),n.clipboardData.setData("text/siyuan",r)}),this.element.addEventListener("mousedown",n=>{var a;if(n.button===2||window.siyuan.ctrlIsPressed)return;window.siyuan.shiftIsPressed&&getSelection().rangeCount>0&&(this.shiftStartElement=hasClosestBlock(getSelection().getRangeAt(0).startContainer)),window.siyuan.shiftIsPressed||hideElements(["select"],t);const i=n.target;if(hasClosestByClassName(i,"protyle-action")||hasClosestByClassName(i,"av__cell--header")&&!hasClosestByClassName(i,"av__widthdrag"))return;const s=document,o=t.element.getBoundingClientRect(),l=o.left+(parseInt(t.wysiwyg.element.style.paddingLeft)||24)+1,r=l+(t.wysiwyg.element.clientWidth-(parseInt(t.wysiwyg.element.style.paddingLeft)||24)-(parseInt(t.wysiwyg.element.style.paddingRight)||16))-2,d=o.bottom,c=n.clientY,u=t.contentElement.getBoundingClientRect();if(!t.disabled&&i.classList.contains("av__widthdrag")){const k=hasClosestBlock(i);if(!k)return;const E=k.getAttribute("data-av-id"),_=k.dataset.nodeId,L=i.parentElement,A=L.clientWidth,S=L.getAttribute("data-col-id");let I;const T=k.querySelector(".av__scroll");s.onmousemove=D=>{I=Math.max(A+(D.clientX-n.clientX),25),T.querySelectorAll(".av__row, .av__row--footer").forEach(M=>{M.querySelector(`[data-col-id="${S}"]`).style.width=I+"px"}),stickyRow(k,u,"bottom")},s.onmouseup=()=>{if(s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,!I||I===A)return;const D=k.getAttribute("custom-sy-av-view");transaction(t,[{action:"setAttrViewColWidth",id:S,avID:E,data:I+"px",blockID:_,keyID:D}],[{action:"setAttrViewColWidth",id:S,avID:E,data:A+"px",blockID:_,keyID:D}])},this.preventClick=!0,n.preventDefault();return}const f=hasClosestByClassName(i,"av__drag-fill");if(!t.disabled&&f){const k=hasClosestBlock(f);if(!k)return;const E={};let _;const L=[];k.querySelectorAll(".av__cell--active").forEach(D=>{const M=hasClosestByClassName(D,"av__row");M&&(E[M.dataset.id]||(E[M.dataset.id]=[]),E[M.dataset.id].push(genCellValueByElement(getTypeByCellElement(D),D)),_=D,L.push(D.dataset.id))});const A=getPositionByCellElement(_),S=getPositionByCellElement(k.querySelector(".av__cell--active"));let I,T;return s.onmousemove=D=>{const M=hasClosestByClassName(D.target,"av__cell");if(!(I&&M&&M.isSameNode(I))&&(I=M,I&&I.dataset.id)){const $=getPositionByCellElement(I);if(k.querySelectorAll(".av__cell--active").forEach(q=>{L.includes(q.dataset.id)||q.classList.remove("av__cell--active")}),$.celIndex!==A.celIndex||A.rowIndex>=$.rowIndex){T=void 0;return}k.querySelectorAll(".av__row").forEach((q,j)=>{j>=A.rowIndex&&j<=$.rowIndex&&q.querySelectorAll(".av__cell").forEach((P,G)=>{G>=S.celIndex&&G<=$.celIndex&&(P.classList.add("av__cell--active"),T=P)})})}},s.onmouseup=()=>(s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,T&&(dragFillCellsValue(t,k,E,L),addDragFill(T)),!1),this.preventClick=!0,!1}const g=hasClosestByClassName(i,"av__cell");if(!t.disabled&&g&&g.dataset.id&&!isInEmbedBlock(g)){const k=hasClosestBlock(g);if(!k)return;k.querySelectorAll(".av__cell--select").forEach(I=>{I.classList.remove("av__cell--select")}),k.querySelectorAll(".av__drag-fill").forEach(I=>{I.remove()}),g.classList.add("av__cell--select");const E=getPositionByCellElement(g);let _,L;const A=k.getBoundingClientRect(),S=k.querySelector(".av__scroll");return s.onmousemove=I=>{const T=hasClosestByClassName(I.target,"av__cell");if(S.scrollWidth>S.clientWidth+2&&(I.clientX>A.right-10?S.scrollLeft+=10:I.clientX<A.left+34&&(S.scrollLeft-=10),I.clientY<u.top+48?t.contentElement.scrollTop-=5:I.clientY>u.bottom-48&&(t.contentElement.scrollTop+=5)),!(_&&T&&T.isSameNode(_))&&T&&T.dataset.id&&(n.clientX!==I.clientX||n.clientY!==I.clientY)){const D=getPositionByCellElement(T);k.querySelectorAll(".av__cell--active").forEach(M=>{M.classList.remove("av__cell--active")}),k.querySelectorAll(".av__row").forEach((M,$)=>{$>=Math.min(E.rowIndex,D.rowIndex)&&$<=Math.max(E.rowIndex,D.rowIndex)&&M.querySelectorAll(".av__cell").forEach((q,j)=>{j>=Math.min(E.celIndex,D.celIndex)&&j<=Math.max(E.celIndex,D.celIndex)&&(q.classList.add("av__cell--active"),L=q)})}),_=T}},s.onmouseup=()=>(s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,L&&(selectRow(k.querySelector(".av__firstcol"),"unselectAll"),focusBlock(k),addDragFill(L),this.preventClick=!0),!1),!1}if(!t.disabled&&i.classList.contains("protyle-action__drag")){const k=hasClosestBlock(i);if(!k)return;let E=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(k.getAttribute("data-type"))?(k.classList.add("iframe--drag"),(k.style.textAlign==="left"||k.style.textAlign==="right")&&(E=!1)):i.parentElement.parentElement.getAttribute("data-type")==="img"&&i.parentElement.parentElement.classList.add("img--drag");const _=k.getAttribute("data-node-id"),L=k.outerHTML,A=n.clientX,S=i.previousElementSibling,I=S.clientWidth,T=S.clientHeight;s.onmousemove=D=>{S.tagName==="IMG"&&(S.parentElement.parentElement.style.width="",S.style.height=""),D.clientX>A-I+8&&D.clientX<r&&(S.tagName==="IMG"&&!S.parentElement.parentElement.style.minWidth&&k.style.textAlign!=="center"||!E?S.style.width=Math.max(17,I+(D.clientX-A))+"px":S.style.width=Math.max(17,I+(D.clientX-A)*2)+"px"),S.tagName!=="IMG"&&D.clientY>c-T+8&&D.clientY<d&&(S.style.height=T+(D.clientY-c)+"px")},s.onmouseup=()=>{s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,i.classList.contains("protyle-action__drag")&&k&&updateTransaction(t,_,k.outerHTML,L),k.classList.remove("iframe--drag"),i.parentElement.parentElement.classList.remove("img--drag")};return}let p;if((i.tagName==="TH"||i.tagName==="TD"||((a=i.firstElementChild)==null?void 0:a.tagName)==="TABLE"||i.classList.contains("table__resize")||i.classList.contains("table__select"))&&(p=hasClosestBlock(i),p&&(p.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),n.stopPropagation())),!t.disabled&&i.classList.contains("table__resize")){const k=hasClosestBlock(i);if(!k)return;const E=k.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),k.firstElementChild.style.webkitUserModify="read-only",k.style.cursor="col-resize",i.removeAttribute("style");const _=k.getAttribute("data-node-id"),L=n.clientX,A=parseInt(i.getAttribute("data-col-index")),S=k.querySelectorAll("table col")[A];S.style.minWidth&&(S.style.width=k.querySelectorAll("table td, table th")[A].offsetWidth+"px",S.style.minWidth=""),k.querySelectorAll("tr").forEach(D=>{D.cells[A].style.width=""});const I=S.clientWidth,T=k.firstElementChild.clientWidth<k.firstElementChild.scrollWidth;s.onmousemove=D=>{k.style.textAlign==="center"&&!T?S.style.width=I+(D.clientX-L)*2+"px":S.style.width=I+(D.clientX-L)+"px"},s.onmouseup=()=>{k.firstElementChild.style.webkitUserModify="",k.style.cursor="",s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,k&&updateTransaction(t,_,k.outerHTML,E)};return}let m=n.clientX;n.clientX>r?m=r:n.clientX<l&&(m=l);const y=o.top+(t.options.render.breadcrumb?t.breadcrumb.element.parentElement.clientHeight:0);let v,b,w,h;this.element.querySelectorAll("iframe").forEach(k=>{k.style.pointerEvents="none"});const C=["IMG","VIDEO","AUDIO"].includes(i.tagName)||i.classList.contains("img");s.onmousemove=k=>{const E=k.target;if(!t.disabled&&p&&p.contains(E)&&!hasClosestByClassName(p,"protyle-wysiwyg__embed")){if((E.tagName==="TH"||E.tagName==="TD")&&!E.isSameNode(i)&&(!b||!b.isSameNode(E))){p.firstElementChild.style.webkitUserModify="read-only";let P=i.offsetLeft+i.clientWidth-E.offsetLeft,G=E.offsetLeft;i.offsetLeft===E.offsetLeft?P=Math.max(i.clientWidth,E.clientWidth):i.offsetLeft<E.offsetLeft&&(P=E.offsetLeft+E.clientWidth-i.offsetLeft,G=i.offsetLeft);let ne=i.offsetTop+i.clientHeight-E.offsetTop,ie=E.offsetTop;i.offsetTop===E.offsetTop?ne=Math.max(i.clientHeight,E.clientHeight):i.offsetTop<E.offsetTop&&(ne=E.offsetTop+E.clientHeight-i.offsetTop,ie=i.offsetTop),Array.from(p.querySelectorAll("th, td")).find(W=>{const Fe=W.offsetLeft<G+P&&W.offsetLeft+W.clientWidth>G+P,te=W.offsetLeft<G&&W.offsetLeft+W.clientWidth>G;W.offsetTop<ie&&W.offsetTop+W.clientHeight>ie?((W.offsetLeft+6>G&&W.offsetLeft+W.clientWidth-6<G+P||Fe||te)&&(ne=ie+ne-W.offsetTop,ie=W.offsetTop),Fe&&(P=W.offsetLeft+W.clientWidth-G),te&&(P=G+P-W.offsetLeft,G=W.offsetLeft)):W.offsetTop<ie+ne&&W.offsetTop+W.clientHeight>ie+ne?((W.offsetLeft+6>G&&W.offsetLeft+W.clientWidth-6<G+P||Fe||te)&&(ne=W.clientHeight+W.offsetTop-ie),Fe&&(P=W.offsetLeft+W.clientWidth-G),te&&(P=G+P-W.offsetLeft,G=W.offsetLeft)):te&&W.offsetTop+6>ie&&W.offsetTop+W.clientHeight-6<ie+ne?(P=G+P-W.offsetLeft,G=W.offsetLeft):Fe&&W.offsetTop+6>ie&&W.offsetTop+W.clientHeight-6<ie+ne&&(P=W.offsetLeft+W.clientWidth-G)}),p.querySelector(".table__select").setAttribute("style",`left:${G-p.firstElementChild.scrollLeft}px;top:${ie}px;height:${ne}px;width:${P+1}px;`),b=E}return}C&&(k.clientY<u.top+Constants.SIZE_SCROLL_TB||k.clientY>u.bottom-Constants.SIZE_SCROLL_TB)&&t.contentElement.scroll({top:t.contentElement.scrollTop+(k.clientY<u.top+Constants.SIZE_SCROLL_TB?-Constants.SIZE_SCROLL_STEP:Constants.SIZE_SCROLL_STEP),behavior:"smooth"}),t.selectElement.classList.remove("fn__none"),hideElements(["gutter"],t);let _=0,L=0,A=0,S=0;if(k.clientX<m?(k.clientX<l?L=l:L=k.clientX,A=m-L):k.clientX>r?(L=m,A=r-L):(L=m,A=k.clientX-m),k.clientY>c?k.clientY>d?(_=c,S=d-c):(_=c,S=k.clientY-c):(k.clientY<y?_=y:_=k.clientY,S=c-_),S<4)return;t.selectElement.setAttribute("style",`background-color: ${t.selectElement.style.backgroundColor};top:${_}px;height:${S}px;left:${L+2}px;width:${A-2}px;`);const I=document.elementFromPoint(k.clientX,k.clientY);if(v&&v.isSameNode(I)&&!v.classList.contains("protyle-wysiwyg")&&!v.classList.contains("list")&&!v.classList.contains("bq")&&!v.classList.contains("sb"))return;v=I,hideElements(["select"],t);let T;if(k.clientY>c?(T=w||document.elementFromPoint(L,_),h=void 0):(T=document.elementFromPoint(L,_),w=void 0),!T||((T.classList.contains("protyle-wysiwyg")||T.classList.contains("list")||T.classList.contains("sb")||T.classList.contains("bq"))&&(T=document.elementFromPoint(L,_+16)),!T))return;let D=hasClosestBlock(T);!D&&T.classList.contains("protyle-breadcrumb__bar")&&(D=T.nextElementSibling),k.clientY>c?w||(D||(D=t.wysiwyg.element.firstElementChild,D.classList.contains("protyle-breadcrumb__bar")&&(D=D.nextElementSibling)),w=D):!D&&k.clientY<t.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom&&(D=t.wysiwyg.element.firstElementChild,D.classList.contains("protyle-breadcrumb__bar")&&(D=D.nextElementSibling));let M=[],$=D;if($){const P=isInEmbedBlock($);P&&($=P)}let q=!1;const j=h?h.getBoundingClientRect().bottom:_+S;for(;$;)if($&&!$.classList.contains("protyle-attr")){const P=$.getBoundingClientRect();if(P.height>0&&P.top<j&&P.left<L+A)if(q)if($.nextElementSibling&&!$.nextElementSibling.classList.contains("protyle-attr")){const G=$.nextElementSibling.getBoundingClientRect();if(G.top<j&&G.left<L+A)M=[$],$=$.nextElementSibling,q=!1;else if($.parentElement.classList.contains("sb"))$=hasClosestBlock($.parentElement),q=!0;else break}else $=hasClosestBlock($.parentElement),q=!0;else $.classList.contains("protyle-breadcrumb__bar")||M.push($),$=$.nextElementSibling;else if($.parentElement.classList.contains("sb"))$=hasClosestBlock($.parentElement),q=!0;else if(P.height===0&&P.width===0&&$.parentElement.getAttribute("fold")==="1")$=$.parentElement,M=[];else break}else $=hasClosestBlock($.parentElement),q=!0;k.clientY<=c&&!h&&(h=M[M.length-1]),M.length===1&&!M[0].classList.contains("list")&&!M[0].classList.contains("bq")&&!M[0].classList.contains("sb")?t.selectElement.style.backgroundColor="transparent":(M.forEach(P=>{hasClosestByClassName(P,"protyle-wysiwyg__embed")||P.classList.add("protyle-wysiwyg--select")}),t.selectElement.style.backgroundColor="")},s.onmouseup=k=>{var E;if(s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,w=void 0,h=void 0,this.element.querySelectorAll("iframe").forEach(A=>{A.style.pointerEvents=""}),t.selectElement.classList.add("fn__none"),t.selectElement.removeAttribute("style"),!t.disabled&&p){p.firstElementChild.style.webkitUserModify="";const A=p.querySelector(".table__select");A.getAttribute("style")&&(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.mergeCell,click:()=>{if(p){const S=[],I=[],T=p.querySelectorAll("th").length;let D=0;const M=p.firstElementChild.scrollLeft;let $=!1,q=!1;p.querySelectorAll("th, td").forEach((te,xe)=>{te.classList.contains("fn__none")?(te.previousElementSibling&&te.previousElementSibling.isSameNode(S[S.length-1])||xe<D&&I.includes((xe+1)%T))&&(S.push(te),!$&&te.parentElement.parentElement.tagName==="THEAD"?$=!0:!q&&te.parentElement.parentElement.tagName==="TBODY"&&(q=!0)):te.offsetLeft+6>A.offsetLeft+M&&te.offsetLeft+te.clientWidth-6<A.offsetLeft+M+A.clientWidth&&te.offsetTop+6>A.offsetTop&&te.offsetTop+te.clientHeight-6<A.offsetTop+A.clientHeight&&(S.push(te),!$&&te.parentElement.parentElement.tagName==="THEAD"?$=!0:!q&&te.parentElement.parentElement.tagName==="TBODY"&&(q=!0),I.push((xe+1)%T),D=Math.max((te.rowSpan-1)*T+xe+1,D))}),A.removeAttribute("style");const j=p.outerHTML;let P=S[0],G=P.colSpan,ne=1;for(;P.nextElementSibling&&P.nextElementSibling.isSameNode(S[ne]);)P=P.nextElementSibling,P.classList.contains("fn__none")||(G+=P.colSpan),ne++;let ie="",W=S[0].parentElement,Fe=S[0].rowSpan;if(S.forEach((te,xe)=>{let F=te.innerHTML.trim();F.endsWith("<br>")&&(F=F.substr(0,F.length-4)),ie+=F+(!F||xe===S.length-1?"":"<br>"),xe!==0&&(W.isSameNode(te.parentElement)||(te.classList.contains("fn__none")||(Fe+=te.rowSpan),W=te.parentElement,S[0].parentElement.parentElement.tagName==="THEAD"&&te.parentElement.parentElement.tagName!=="THEAD"&&S[0].parentElement.parentElement.insertAdjacentElement("beforeend",te.parentElement)),te.classList.add("fn__none"),te.innerHTML="")}),$&&q)for(W=W.parentElement.nextElementSibling.firstElementChild;W&&W.parentElement.tagName!=="THEAD";){let te=0,xe=0;if(Array.from(W.children).forEach(F=>{te+=F.colSpan-1,F.classList.contains("fn__none")&&xe++}),te!==xe)S[0].parentElement.parentElement.insertAdjacentElement("beforeend",W),W=W.parentElement.nextElementSibling.firstElementChild;else break}setTimeout(()=>{p&&(S[0].innerHTML=ie+"<wbr>",S[0].colSpan=G,S[0].rowSpan=Fe,focusByWbr(S[0],document.createRange()),updateTransaction(t,p.getAttribute("data-node-id"),p.outerHTML,j))})}}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(p){const S=[],I=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(T=>{!T.classList.contains("fn__none")&&T.offsetLeft+6>A.offsetLeft+I&&T.offsetLeft+T.clientWidth-6<A.offsetLeft+I+A.clientWidth&&T.offsetTop+6>A.offsetTop&&T.offsetTop+T.clientHeight-6<A.offsetTop+A.clientHeight&&(S.length===0||S.length>0&&T.offsetTop===S[0].offsetTop)&&S.push(T)}),A.removeAttribute("style"),setTableAlign(t,S,p,"left",getEditorRange(p))}}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(p){const S=[],I=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(T=>{!T.classList.contains("fn__none")&&T.offsetLeft+6>A.offsetLeft+I&&T.offsetLeft+T.clientWidth-6<A.offsetLeft+I+A.clientWidth&&T.offsetTop+6>A.offsetTop&&T.offsetTop+T.clientHeight-6<A.offsetTop+A.clientHeight&&(S.length===0||S.length>0&&T.offsetTop===S[0].offsetTop)&&S.push(T)}),A.removeAttribute("style"),setTableAlign(t,S,p,"center",getEditorRange(p))}}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(p){const S=[],I=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(T=>{!T.classList.contains("fn__none")&&T.offsetLeft+6>A.offsetLeft+I&&T.offsetLeft+T.clientWidth-6<A.offsetLeft+I+A.clientWidth&&T.offsetTop+6>A.offsetTop&&T.offsetTop+T.clientHeight-6<A.offsetTop+A.clientHeight&&(S.length===0||S.length>0&&T.offsetTop===S[0].offsetTop)&&S.push(T)}),A.removeAttribute("style"),setTableAlign(t,S,p,"right",getEditorRange(p))}}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{if(p){const S=[],I=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(T=>{!T.classList.contains("fn__none")&&T.offsetLeft+6>A.offsetLeft+I&&T.offsetLeft+T.clientWidth-6<A.offsetLeft+I+A.clientWidth&&T.offsetTop+6>A.offsetTop&&T.offsetTop+T.clientHeight-6<A.offsetTop+A.clientHeight&&(S.length===0||S.length>0&&T.offsetTop===S[0].offsetTop)&&S.push(T)}),A.removeAttribute("style"),setTableAlign(t,S,p,"",getEditorRange(p))}}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.clear,icon:"iconTrashcan",click(){if(p){const S=[],I=p.firstElementChild.scrollLeft;p.querySelectorAll("th, td").forEach(D=>{!D.classList.contains("fn__none")&&D.offsetLeft+6>A.offsetLeft+I&&D.offsetLeft+D.clientWidth-6<A.offsetLeft+I+A.clientWidth&&D.offsetTop+6>A.offsetTop&&D.offsetTop+D.clientHeight-6<A.offsetTop+A.clientHeight&&S.push(D)}),A.removeAttribute("style");const T=p.outerHTML;S.forEach(D=>{D.innerHTML=""}),updateTransaction(t,p.getAttribute("data-node-id"),p.outerHTML,T)}}}).element),window.siyuan.menus.menu.popup({x:k.clientX-8,y:k.clientY-16}))}const _=[],L=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(L.forEach(A=>{_.push(A.getAttribute("data-node-id"))}),countBlockWord(_),getSelection().rangeCount>0){const A=getSelection().getRangeAt(0);if((A.toString()===""||window.siyuan.shiftIsPressed)&&n.detail>2){let T=hasClosestBlock(A.startContainer);if(T){if((E=T.nextElementSibling)!=null&&E.classList.contains("table"))setLastNodeRange(getContenteditableElement(T),A,!1);else if(T.classList.contains("table")){const D=T.querySelectorAll("th, td");T=D[D.length-1],T.contains(A.startContainer)&&setLastNodeRange(T,A,!1)}}return}if(L.length>0){A.collapse(!0);return}const S=hasClosestBlock(A.startContainer);let I;k.detail>2&&A.endContainer.nodeType!==3&&A.endContainer.tagName==="DIV"&&A.endOffset===0?A.endContainer.classList.contains("protyle-attr")&&S&&setLastNodeRange(getContenteditableElement(S),A,!1):I=hasClosestBlock(A.endContainer),S&&I&&!I.isSameNode(S)&&(A.startContainer.nodeType===1&&A.startContainer.tagName==="DIV"&&A.startContainer.classList.contains("protyle-attr")||n.clientY>k.clientY?setFirstNodeRange(getContenteditableElement(I),A):A.endOffset===0&&A.endContainer.nodeType===1&&A.endContainer.tagName==="DIV"?setLastNodeRange(getContenteditableElement(S),A,!1):A.collapse(!0))}}})}bindEvent(t){t.observer=new ResizeObserver(()=>{const l=t.contentElement.getBoundingClientRect();t.wysiwyg.element.querySelectorAll(".av").forEach(r=>{r.querySelector(".av__title")&&stickyRow(r,l,"all")})}),this.element.addEventListener("focusout",()=>{if(getSelection().rangeCount===0)return;const l=getSelection().getRangeAt(0);(this.element.isSameNode(l.startContainer)||this.element.contains(l.startContainer))&&(t.toolbar.range=l)}),this.element.addEventListener("cut",l=>{var r,d,c;if(window.siyuan.ctrlIsPressed=!1,t.disabled)return;if(l.target.tagName==="PROTYLE-HTML"||l.target.localName==="input"){l.stopPropagation();return}t.options.render.breadcrumb&&t.breadcrumb.hide();const u=getEditorRange(t.wysiwyg.element);let f=hasClosestBlock(u.startContainer);if(!f){l.stopPropagation(),l.preventDefault();return}const g=isInEmbedBlock(f);g&&(f=g),l.stopPropagation(),l.preventDefault();const p=f.querySelector(".img--select"),m=f.querySelector(".av__row--select, .av__cell--select");let y=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));y.length===0&&u.toString()===""&&!u.cloneContents().querySelector("img")&&!p&&!m&&(f.classList.add("protyle-wysiwyg--select"),y=[f]);let v="",b="";if(y.length>0){y[0].getAttribute("data-type")==="NodeListItem"&&y[0].parentElement.classList.contains("list")&&y[0].parentElement.childElementCount-1===y.length?v=y[0].parentElement.outerHTML:(y.forEach(h=>{const C=getTopAloneElement(h);h.getAttribute("data-type")==="NodeHeading"&&h.getAttribute("fold")==="1"?v+=removeEmbed(C).replace('fold="1"',""):v+=removeEmbed(C)}),y[0].getAttribute("data-type")==="NodeListItem"&&(v=`<div data-subtype="${y[0].getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${v}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`));const w=getNextBlock(y[y.length-1]);removeBlock(t,f,u,"remove"),w&&focusBlock(w)}else if(m){const w=updateCellsValue(t,f);v=JSON.stringify(w.json),b=w.text}else{const w=f.getAttribute("data-node-id"),h=f.outerHTML,C=document.createElement("div");let k=u.startContainer;if(k.nodeType===3&&k.textContent===""){const L=hasNextSibling(u.startContainer);L&&(k=L)}const E=hasClosestByAttribute(k,"data-type","NodeHeading");let _=!1;if(E&&u.toString()===E.firstElementChild.textContent){const L=[{action:"delete",id:E.getAttribute("data-node-id")}],A=[{action:"insert",id:E.getAttribute("data-node-id"),data:E.outerHTML,previousID:(r=E.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:((d=E.parentElement)==null?void 0:d.getAttribute("data-node-id"))||t.block.parentID}];if(E.getAttribute("fold")==="1"){_=!0;const S=E.cloneNode(!0);S.removeAttribute("fold"),C.append(S),A[0].data=S.outerHTML,setFold(t,E,void 0,!0)}else{if(E.parentElement.childElementCount===3&&E.parentElement.classList.contains("li")||E.parentElement.childElementCount===2&&(E.parentElement.classList.contains("bq")||E.parentElement.classList.contains("sb"))||E.parentElement.childElementCount===1&&E.parentElement.classList.contains("protyle-wysiwyg")){const S=Lute.NewNodeID(),I=genEmptyElement(!1,!1,S);L.push({id:S,data:I.outerHTML,action:"insert",parentID:E.parentElement.getAttribute("data-node-id")||t.block.parentID}),A.push({id:S,action:"delete"}),E.before(I)}focusSideBlock(E),C.append(E)}transaction(t,L,A)}else if(u.toString()!==""&&k.isSameNode(u.endContainer)&&u.startContainer.nodeType===3&&u.endOffset===u.endContainer.textContent.length&&u.startOffset===0&&!["DIV","TD","TH","TR"].includes(u.startContainer.parentElement.tagName))C.append(u.startContainer.parentElement);else if(p)C.append(p);else if(u.startContainer.nodeType===3&&u.startContainer.parentElement.tagName==="SPAN"&&u.startContainer.parentElement.getAttribute("data-type")&&u.startContainer.parentElement.isSameNode(u.endContainer.parentElement)){const L=u.startContainer.parentElement,A=L.attributes,S=document.createElement("span");for(let I=0;I<A.length;I++)S.setAttribute(A[I].name,A[I].value);L.getAttribute("data-type").indexOf("block-ref")>-1&&L.getAttribute("data-subtype")==="d"&&(S.setAttribute("data-subtype","s"),L.setAttribute("data-subtype","s")),S.textContent=u.toString(),u.deleteContents(),C.append(S)}else if(u.cloneContents().querySelectorAll("td, th").length>0){const L=document.createElement("wbr");u.insertNode(L),u.setStartAfter(L),C.append(u.extractContents()),f.outerHTML=t.lute.SpinBlockDOM(f.outerHTML),f=t.wysiwyg.element.querySelector(`[data-node-id="${w}"]`),mathRender(f),focusByWbr(f,u)}else{const L=hasClosestByAttribute(u.commonAncestorContainer,"data-type","inline-math");if(L)C.append(L);else{C.append(u.extractContents());let A;f.classList.contains("av")?updateAVName(t,f):f.classList.contains("table")?A=hasClosestByMatchTag(u.startContainer,"TD")||hasClosestByMatchTag(u.startContainer,"TH"):A=getContenteditableElement(f),A&&Array.from(A.children).forEach(S=>{S.textContent===""&&S.nodeType===1&&!["BR","IMG"].includes(S.tagName)&&S.remove()})}}if(this.emojiToMd(C),v=C.innerHTML,(hasClosestByAttribute(u.startContainer,"data-type","NodeCodeBlock")||hasClosestByMatchTag(u.startContainer,"CODE"))&&(b=C.textContent.replace(Constants.ZWSP,"")),!f.classList.contains("table")){const L=getContenteditableElement(f);L&&L.textContent===""&&(L.innerHTML="")}f.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),f.getAttribute("data-type")==="NodeCodeBlock"&&(u.insertNode(document.createElement("wbr")),(c=f.querySelector('[data-render="true"]'))==null||c.removeAttribute("data-render"),highlightRender(f)),f.parentElement.parentElement&&!_&&!f.classList.contains("av")&&updateTransaction(t,w,f.outerHTML,h)}t.hint.render(t),m||(b=b||t.lute.BlockDOM2StdMd(v).trimEnd()),b=b.replace(/\u00A0/g," "),l.clipboardData.setData("text/plain",b),l.clipboardData.setData("text/html",t.lute.BlockDOM2HTML(m?b:v)),l.clipboardData.setData("text/siyuan",v)});let n;this.element.addEventListener("contextmenu",l=>{var r,d,c,u;if(l.shiftKey)return;l.stopPropagation(),l.preventDefault();const f=l.clientX||l.detail.x,g=l.clientY||l.detail.y,p=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(p.length>1){hideElements(["util"],t),t.gutter.renderMenu(t,p[0]),window.siyuan.menus.menu.popup({x:f,y:g});return}const m=l.detail.target||l.target,y=isInEmbedBlock(m);if(y)return getSelection().rangeCount===0&&focusSideBlock(y),t.gutter.renderMenu(t,y),window.siyuan.menus.menu.fullscreen(),!1;const v=hasClosestBlock(m);if(!v)return!1;const b=hasClosestByClassName(m,"av__cell");if(b){if(b.classList.contains("av__cell--header")){t.disabled||showColMenu(t,v,b),l.stopPropagation(),l.preventDefault();return}if(getTypeByCellElement(b)==="mAsset"){const k=hasClosestByClassName(m,"av__cellassetimg")||hasClosestByClassName(m,"av__celltext--url");if(k){let E=0;Array.from(b.children).find((_,L)=>{if(_===k)return E=L,!0}),editAssetItem({protyle:t,cellElements:[b],blockElement:hasClosestBlock(k),content:m.tagName==="IMG"?m.getAttribute("src"):m.getAttribute("data-url"),type:m.tagName==="IMG"?"image":"file",name:m.tagName==="IMG"?"":m.getAttribute("data-name"),index:E,rect:m.getBoundingClientRect()}),l.stopPropagation(),l.preventDefault();return}}}const w=hasClosestByClassName(m,"av__row");if(w&&avContextmenu(t,w,{x:l.clientX,y:w.getBoundingClientRect().bottom,h:w.clientHeight})){l.stopPropagation(),l.preventDefault();return}const h=hasClosestByClassName(m,"item");if(v.classList.contains("av")&&h){h.classList.contains("item--focus")?openViewMenu({protyle:t,blockElement:v,element:h}):(v.removeAttribute("data-render"),avRender(v,t,()=>{openViewMenu({protyle:t,blockElement:v,element:v.querySelector(".item.item--focus")})},h.dataset.id)),l.stopPropagation(),l.preventDefault();return}if(t.toolbar.range=getEditorRange(t.element),m.tagName==="SPAN"&&!isNotEditBlock(v)){let k=t.toolbar.getCurrentType(t.toolbar.range);if(k.length===0&&(k=(m.dataset.type||"").split(" ")),k.length>0&&removeSearchMark(m),k.includes("block-ref"))return refMenu(t,m),m.setAttribute("prevent-popover","true"),setTimeout(()=>{m.removeAttribute("prevent-popover")},620),!1;if(k.includes("file-annotation-ref")&&!t.disabled)return fileAnnotationRefMenu(t,m),!1;if(k.includes("tag")&&!t.disabled)return tagMenu(t,m),!1;if(k.includes("inline-memo"))return t.toolbar.showRender(t,m),!1;if(k.includes("a"))return linkMenu(t,m),window.siyuan.config.editor.floatWindowMode===0&&((r=m.getAttribute("data-href"))!=null&&r.startsWith("siyuan://blocks"))&&(m.setAttribute("prevent-popover","true"),setTimeout(()=>{m.removeAttribute("prevent-popover")},620)),!1}const C=hasClosestByAttribute(m,"data-type","inline-math");if(C)return inlineMathMenu(t,C),!1;if(m.tagName==="IMG"&&hasClosestByClassName(m,"img"))return imgMenu(t,t.toolbar.range,m.parentElement.parentElement,{clientX:f+4,clientY:g}),!1;!isNotEditBlock(v)&&!v.classList.contains("protyle-wysiwyg--select")&&!hasClosestByClassName(m,"protyle-action")&&(isMobile()||l.detail.target||n&&v.contains(n.startContainer))?(!isMobile()||(d=t.toolbar)!=null&&d.element.classList.contains("fn__none"))&&!v.classList.contains("av")&&(contentMenu(t,v),window.siyuan.menus.menu.popup({x:f,y:g+13,h:26}),(c=t.toolbar)==null||c.element.classList.add("fn__none"),v.classList.contains("table")&&v.querySelector(".table__select").removeAttribute("style")):t.toolbar.range.toString()===""&&(hideElements(["util"],t),t.gutter&&t.gutter.renderMenu(t,v),window.siyuan.menus.menu.fullscreen(),(u=t.toolbar)==null||u.element.classList.add("fn__none"))}),this.element.addEventListener("pointerdown",()=>{getSelection().rangeCount>0?n=getSelection().getRangeAt(0):n=void 0});let a=!1;this.element.addEventListener("mousewheel",l=>{if(!a&&l.deltaY<0&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.clientHeight===t.contentElement.scrollHeight&&t.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(fetchPost("/api/filetree/getDoc",{id:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},d=>{a=!1,onGet({data:d,protyle:t,action:[Constants.CB_GET_BEFORE,Constants.CB_GET_UNCHANGEID]})}),a=!0),l.deltaX===0)return;const r=hasClosestByClassName(l.target,"table");if(r){const d=r.querySelector(".table__select");d!=null&&d.style.width&&(d.removeAttribute("style"),window.siyuan.menus.menu.remove())}},{passive:!0});let i=!1;this.element.addEventListener("mouseover",l=>{const r=hasClosestByClassName(l.target,"protyle-attr");if(r){i=!0,r.parentElement.classList.add("protyle-wysiwyg--hl");return}else if(i){const c=t.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");c&&c.classList.remove("protyle-wysiwyg--hl"),i=!1}if(hasClosestByClassName(l.target,"protyle-action")||!t.options.render.gutter)return;const d=hasClosestBlock(l.target);if(!(d&&(d.classList.contains("list")||d.classList.contains("li")))&&d){const c=isInEmbedBlock(d);c?t.gutter.render(t,c,this.element):t.gutter.render(t,d,this.element,l.target)}}),this.element.addEventListener("paste",l=>{if(l.target.localName==="input"&&l.target.getAttribute("data-type")==="av-search")return;if(t.disabled){l.stopPropagation(),l.preventDefault();return}if(window.siyuan.ctrlIsPressed=!1,l.target.tagName==="PROTYLE-HTML"||l.target.localName==="input"){l.stopPropagation();return}if(!hasClosestByAttribute(l.target,"contenteditable","true")){l.stopPropagation(),l.preventDefault();return}const r=hasClosestBlock(l.target);if(r&&!getContenteditableElement(r)){l.stopPropagation(),l.preventDefault();return}if(!r)return;const d=getSelection().getRangeAt(0),c=d.startContainer.parentElement;if(d.toString()===""&&c.tagName==="SPAN"){const u=(c.getAttribute("data-type")||"").split(" ");if(u.includes("inline-memo")||u.includes("text")||u.includes("block-ref")||u.includes("file-annotation-ref")||u.includes("a")){const f=getSelectionOffset(c,r,d);f.start===0?(d.setStartBefore(c),d.collapse(!0)):f.start===c.textContent.length&&(d.setEndAfter(c),d.collapse(!1))}}paste(t,l)});let s=!1;this.element.addEventListener("compositionstart",l=>{const r=getEditorRange(t.wysiwyg.element),d=hasClosestBlock(r.startContainer);d&&typeof t.wysiwyg.lastHTMLs[d.getAttribute("data-node-id")]=="undefined"&&(r.insertNode(document.createElement("wbr")),t.wysiwyg.lastHTMLs[d.getAttribute("data-node-id")]=d.outerHTML,d.querySelector("wbr").remove()),s=!0,l.stopPropagation()}),this.element.addEventListener("compositionend",l=>{l.stopPropagation(),s=!1;const r=getEditorRange(this.element),d=hasClosestBlock(r.startContainer);if(d)if(l.data!=="")this.escapeInline(t,r,l),input(t,d,r,!0);else{const c=d.getAttribute("data-node-id");t.wysiwyg.lastHTMLs[c]&&updateTransaction(t,c,d.outerHTML,t.wysiwyg.lastHTMLs[c])}});let o;this.element.addEventListener("input",l=>{const r=l.target;if(r.tagName==="VIDEO"||r.tagName==="AUDIO"||l.inputType==="historyRedo")return;if(l.inputType==="historyUndo"){window.siyuan.menus.menu.remove();return}const d=getEditorRange(this.element),c=hasClosestBlock(d.startContainer);c&&([":","(","\u3010","\uFF08","[","{","\u300C","\u300E","#","/","\u3001"].includes(l.data)&&(t.hint.enableExtend=!0),!(l.isComposing||s||l.inputType==="deleteByDrag"||l.inputType==="insertFromDrop")&&(this.escapeInline(t,d,l),/^\d{1}$/.test(l.data)||l.data==="\u2018"||l.data==="\u201C"||l.data==="\u201D"||l.data==="\u300C"?(clearTimeout(o),o=window.setTimeout(()=>{input(t,c,d,!0)})):input(t,c,d,!0,l),l.stopPropagation()))}),this.element.addEventListener("keyup",l=>{const r=getEditorRange(this.element).cloneRange(),d=hasClosestBlock(r.startContainer);if(l.key!=="PageUp"&&l.key!=="PageDown"&&l.key!=="Home"&&l.key!=="End"&&l.key.indexOf("Arrow")===-1&&l.key!=="Alt"&&l.key!=="Shift"&&l.key!=="CapsLock"&&l.key!=="Escape"&&l.key!=="Meta"&&!/^F\d{1,2}$/.test(l.key)&&(!l.isComposing||l.isComposing&&r.toString()!=="")){r.toString()===""&&d&&typeof t.wysiwyg.lastHTMLs[d.getAttribute("data-node-id")]=="undefined"&&(r.insertNode(document.createElement("wbr")),t.wysiwyg.lastHTMLs[d.getAttribute("data-node-id")]=d.outerHTML,d.querySelector("wbr").remove());return}if(!this.preventKeyup){if((l.shiftKey||isOnlyMeta(l))&&!l.isComposing&&r.toString()!==""&&(t.toolbar.render(t,r,l),countSelectWord(r)),l.eventPhase!==3&&!l.shiftKey&&(l.key.indexOf("Arrow")>-1||l.key==="Home"||l.key==="End"||l.key==="PageUp"||l.key==="PageDown")&&!l.isComposing){if(d&&(this.setEmptyOutline(t,d),r.toString()===""&&countSelectWord(r,t.block.rootID),t.breadcrumb)){const c=t.breadcrumb.element.parentElement.querySelector('[data-type="indent"]');if(c){const u=t.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]');d.parentElement.classList.contains("li")?(c.removeAttribute("disabled"),u.removeAttribute("disabled")):(c.setAttribute("disabled","true"),u.setAttribute("disabled","true"))}}l.stopPropagation()}if((l.key==="ArrowLeft"||l.key==="ArrowRight"||l.key==="Alt"||l.key==="Shift")&&d&&!d.classList.contains("protyle-wysiwyg--select")){const c=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let u=!1;c.find(f=>{if(f.contains(r.startContainer))return u=!0,!0}),!u&&c.length>0&&(c.forEach(f=>{f.classList.remove("protyle-wysiwyg--select")}),d.classList.add("protyle-wysiwyg--select"))}}}),this.element.addEventListener("dblclick",l=>{if(l.target.tagName==="IMG"&&!l.target.classList.contains("emoji")){previewDocImage(l.target.src,t.block.rootID);return}}),this.element.addEventListener("click",l=>{if(this.preventClick){this.preventClick=!1;return}t.app.plugins.forEach(S=>{S.eventBus.emit("click-editorcontent",{protyle:t,event:l})}),hideElements(["hint","util"],t);const r=isOnlyMeta(l);l.shiftKey||(this.shiftStartElement=void 0),this.setEmptyOutline(t,l.target);const d=hasClosestByClassName(l.target,"table");this.element.querySelectorAll(".table").forEach(S=>{(!d||!S.isSameNode(d))&&S.querySelector(".table__select").removeAttribute("style"),d&&d.isSameNode(S)&&S.querySelector(".table__select").getAttribute("style")&&l.stopPropagation()}),t.options.render.breadcrumb&&t.breadcrumb.render(t,!1,hasClosestBlock(l.target));const c=getEditorRange(this.element);c.startContainer.nodeType!==3&&c.startContainer.classList.contains("protyle-action")&&c.startContainer.parentElement.classList.contains("code-block")&&setFirstNodeRange(c.startContainer.parentElement.querySelector(".hljs").lastElementChild,c);const u=hasClosestByAttribute(l.target,"data-type","a")||hasClosestByClassName(l.target,"av__celltext--url");let f=u&&u.getAttribute("data-href")||"";u&&!f&&u.classList.contains("av__celltext--url")&&(f=u.textContent.trim(),u.dataset.type==="phone"?f="tel:"+f:u.dataset.type==="email"?f="mailto:"+f:u.classList.contains("b3-chip")&&(f=u.dataset.url));const g=hasClosestByAttribute(l.target,"data-type","block-ref");if(g||f.startsWith("siyuan://blocks/")){if(l.stopPropagation(),l.preventDefault(),hideElements(["dialog","toolbar"],t),c.toString()!==""&&!l.shiftKey)return;let S;g?S=g.getAttribute("data-id"):u&&(S=f.substring(16,38)),checkFold(S,(I,T,D)=>{D||T.push(Constants.CB_GET_HL),openMobileFileById(t.app,S,I?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL]),activeBlur(),hideKeyboardToolbar()});return}const p=hasClosestByAttribute(l.target,"data-type","virtual-block-ref");if(p){const S=hasClosestBlock(p);S&&fetchPost("/api/block/getBlockDefIDsByRefText",{anchor:p.textContent,excludeIDs:[S.getAttribute("data-node-id")]},I=>{checkFold(I.data[0],T=>{openMobileFileById(t.app,I.data[0],T?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL]),activeBlur(),hideKeyboardToolbar()})});return}const m=hasClosestByAttribute(l.target,"data-type","file-annotation-ref");if(m&&c.toString()===""){l.stopPropagation(),l.preventDefault(),openLink(t,m.getAttribute("data-id"),l,r);return}if(u&&(l.shiftKey||c.toString()==="")&&f){l.stopPropagation(),l.preventDefault(),openLink(t,f,l,r);return}if(u&&u.classList.contains("av__celltext--url")&&!f){let S=0;Array.from(u.parentElement.children).find((I,T)=>{if(I===u)return S=T,!0}),editAssetItem({protyle:t,cellElements:[u.parentElement],blockElement:hasClosestBlock(u),content:u.getAttribute("data-url"),type:"file",name:u.getAttribute("data-name"),index:S,rect:u.getBoundingClientRect()});return}const y=hasClosestByAttribute(l.target,"data-type","tag");if(y&&!l.altKey){popSearch(t.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${y.textContent}#`,r:"",page:1});return}const v=hasClosestByClassName(l.target,"protyle-wysiwyg__embed");if(v){const S=v.getAttribute("data-id");if(checkFold(S,(I,T)=>{openMobileFileById(t.app,S,I?[Constants.CB_GET_ALL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL]),activeBlur(),hideKeyboardToolbar()}),!r){l.stopPropagation();return}}if(commonClick(l,t)||hasTopClosestByClassName(l.target,"protyle-action__copy"))return;const b=hasClosestByClassName(l.target,"protyle-action__edit");if(b&&!t.disabled){t.toolbar.showRender(t,b.parentElement.parentElement),l.stopPropagation(),l.preventDefault();return}const w=hasClosestByClassName(l.target,"protyle-action__menu");if(w){t.gutter.renderMenu(t,w.parentElement.parentElement),window.siyuan.menus.menu.fullscreen(),l.stopPropagation(),l.preventDefault();return}const h=hasClosestByClassName(l.target,"protyle-action__reload");if(h){const S=isInEmbedBlock(h);S&&(S.removeAttribute("data-render"),blockRender(t,S)),l.stopPropagation(),l.preventDefault();return}const C=hasClosestByClassName(l.target,"protyle-action__language");if(C&&!t.disabled&&!r){t.toolbar.showCodeLanguage(t,C),l.stopPropagation(),l.preventDefault();return}const k=hasClosestByAttribute(l.target,"data-subtype","math");if(!l.shiftKey&&!r&&k&&!t.disabled){t.toolbar.showRender(t,k),l.stopPropagation();return}const E=hasClosestByClassName(l.target,"protyle-action");if(E){if(E.parentElement.parentElement.getAttribute("data-type")==="img"&&!t.disabled){imgMenu(t,c,E.parentElement.parentElement,{clientX:l.clientX+4,clientY:l.clientY}),l.stopPropagation();return}else if(E.parentElement.classList.contains("li")){const I=E.parentElement.getAttribute("data-node-id");if(l.altKey&&!t.disabled){if(E.parentElement.parentElement.classList.contains("protyle-wysiwyg"))setFold(t,E.parentElement);else{let T=!0;const D=E.parentElement.parentElement.outerHTML;Array.from(E.parentElement.parentElement.children).find(M=>{if(M.classList.contains("li")&&M.getAttribute("fold")!=="1"&&M.childElementCount>3)return T=!1,!0}),Array.from(E.parentElement.parentElement.children).find(M=>{M.classList.contains("li")&&(T?M.removeAttribute("fold"):M.childElementCount>3&&M.setAttribute("fold","1"))}),updateTransaction(t,E.parentElement.parentElement.getAttribute("data-node-id"),E.parentElement.parentElement.outerHTML,D)}hideElements(["gutter"],t)}else if(l.shiftKey&&!t.disabled)openAttr(E.parentElement,"bookmark",t);else if(r)zoomOut({protyle:t,id:I});else if(E.classList.contains("protyle-action--task")){if(!t.disabled){const T=E.parentElement.outerHTML;E.parentElement.classList.contains("protyle-task--done")?(E.querySelector("use").setAttribute("xlink:href","#iconUncheck"),E.parentElement.classList.remove("protyle-task--done")):(E.querySelector("use").setAttribute("xlink:href","#iconCheck"),E.parentElement.classList.add("protyle-task--done")),E.parentElement.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,I,E.parentElement.outerHTML,T)}}else window.siyuan.config.editor.listItemDotNumberClickFocus&&(t.block.showAll&&t.block.id===I?enterBack(t,I):zoomOut({protyle:t,id:I}));l.stopPropagation();return}}const _=hasClosestByClassName(l.target,"hr")||hasClosestByClassName(l.target,"iframe");if(!l.shiftKey&&!r&&_){_.classList.add("protyle-wysiwyg--select"),l.stopPropagation();return}const L=hasTopClosestByClassName(l.target,"img");if(!l.shiftKey&&!r&&L){L.classList.add("img--select");const S=hasNextSibling(L);S&&(S.textContent.startsWith(Constants.ZWSP)?c.setStart(S,1):c.setStart(S,0),c.collapse(!0),focusByRange(c),t.options.render.breadcrumb&&t.breadcrumb.render(t));return}const A=hasTopClosestByClassName(l.target,"emoji");if(!l.shiftKey&&!r&&A){const S=hasClosestBlock(A);if(S){const I=A.getBoundingClientRect();openEmojiPanel("","av",{x:I.left,y:I.bottom,h:I.height,w:I.width},T=>{A.insertAdjacentHTML("afterend","<wbr>");const D=S.outerHTML;let M;if(T.indexOf(".")>-1){const $=T.split(".");M=`<img alt="${$[0]}" class="emoji" src="/emojis/${T}" title="${$[0]}">`}else M=unicode2Emoji(T);A.outerHTML=M,hideElements(["dialog"]),updateTransaction(t,S.getAttribute("data-node-id"),S.outerHTML,D),focusByWbr(S,c)})}return}if(!avClick(t,l)){if(setTimeout(()=>{let S=getEditorRange(this.element);const I=hasClosestByClassName(S.endContainer,"protyle-attr");I&&(S=setLastNodeRange(I.previousElementSibling,S,!1)),t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||countSelectWord(S,t.block.rootID),getSelection().rangeCount===0&&focusByRange(S)},isMobile()||isInIOS()?520:0),t.hint.enableExtend=!1,l.shiftKey){l.preventDefault(),l.stopPropagation();let S=this.shiftStartElement,I=hasClosestBlock(l.target);if(this.shiftStartElement&&I&&!this.shiftStartElement.isSameNode(I)){let T=!0;c.collapse(!0);const D=S.getBoundingClientRect(),M=I.getBoundingClientRect();let $=D.top,q=M.top;if($===q&&($=D.left,q=M.left),$>q){const ne=I;I=S,S=ne;const ie=q;q=$,$=ie,T=!1}let j=[],P=S,G=!1;for(;P;)if(P&&!P.classList.contains("protyle-attr")){const ne=P.getBoundingClientRect();if(D.top===M.top?ne.left<=q:ne.top<=q)if(G)if(P.nextElementSibling&&!P.nextElementSibling.classList.contains("protyle-attr")){const ie=P.nextElementSibling.getBoundingClientRect();if(D.top===M.top?ie.left<=q&&ie.bottom<=M.bottom:ie.top<=q)j=[P],P=P.nextElementSibling,G=!1;else if(P.parentElement.classList.contains("sb"))P=hasClosestBlock(P.parentElement),G=!0;else break}else P=hasClosestBlock(P.parentElement),G=!0;else j.push(P),P=P.nextElementSibling;else if(P.parentElement.classList.contains("sb"))P=hasClosestBlock(P.parentElement),G=!0;else break}else P=hasClosestBlock(P.parentElement),G=!0;if(j.length===1&&!j[0].classList.contains("list")&&!j[0].classList.contains("bq")&&!j[0].classList.contains("sb"))this.shiftStartElement=void 0;else{const ne=[];!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&t.scroll&&!t.scroll.element.classList.contains("fn__none")&&!t.scroll.keepLazyLoad&&(S.getBoundingClientRect().top<-t.contentElement.clientHeight*2||I.getBoundingClientRect().bottom>t.contentElement.clientHeight*2)&&showMessage(window.siyuan.languages.crossKeepLazyLoad),j.forEach(ie=>{ie.classList.add("protyle-wysiwyg--select"),ne.push(ie.getAttribute("data-node-id")),ie.querySelectorAll(".protyle-wysiwyg--select").forEach(W=>{W.classList.remove("protyle-wysiwyg--select")})}),countBlockWord(ne),T?focusBlock(j[j.length-1],t.wysiwyg.element,!1):focusBlock(j[0],t.wysiwyg.element,!1)}}}if(this.element.querySelector(".protyle-wysiwyg--select")&&c.toString()!==""&&(c.collapse(!1),focusByRange(c)),r&&c.toString()===""){let S=hasClosestBlock(l.target);if(S){const I=isInEmbedBlock(S);I&&(S=I),S=getTopAloneElement(S),S.classList.contains("protyle-wysiwyg--select")?(S.classList.remove("protyle-wysiwyg--select"),S.removeAttribute("select-start"),S.removeAttribute("select-end")):S.classList.add("protyle-wysiwyg--select"),S.querySelectorAll(".protyle-wysiwyg--select").forEach(M=>{M.classList.remove("protyle-wysiwyg--select"),M.removeAttribute("select-start"),M.removeAttribute("select-end")});const T=hasClosestByClassName(S.parentElement,"protyle-wysiwyg--select");T&&(T.classList.remove("protyle-wysiwyg--select"),T.removeAttribute("select-start"),T.removeAttribute("select-end"));const D=[];t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(M=>{D.push(M.getAttribute("data-node-id"))}),countBlockWord(D)}}}})}}var eo=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});class Ud extends Bt{constructor(t,n){super(t,n),this.element.addEventListener("click",a=>eo(this,null,function*(){t.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=t.toolbar.range;if(!R(i.startContainer))return;const o=O(i.startContainer,"data-type","a");if(o){ko(t,o);return}const l=i.toString().trim().replace(x.ZWSP,"");let r="",d="";try{const c=yield si();if(r=t.lute.GetLinkDest(l),r||(r=t.lute.GetLinkDest(c)),!r){const u=c.lastIndexOf(" ");u>-1&&(r=t.lute.GetLinkDest(c.substring(u)),r&&(d=c.substring(0,u)))}!r&&c.startsWith("assets/")&&(r=c)}catch(c){console.log(c)}t.toolbar.setInlineMark(t,"a","range",{type:"a",color:r+(d?x.ZWSP+d:"")})}))}}class Wd extends Bt{constructor(t,n){super(t,n),this.element.addEventListener("click",a=>{t.toolbar.range.toString()!==""&&(ei(t.toolbar.range),$i(t.toolbar.range.toString(),t,"search"),t.toolbar.element.classList.add("fn__none"),a.stopPropagation())})}}var to=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});class jd extends Bt{constructor(t,n){super(t,n),this.element.addEventListener("click",a=>to(this,null,function*(){t.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=t.toolbar.range;if(!R(i.startContainer))return;let o=O(i.startContainer,"data-type","inline-math");if(!o&&i.startContainer.nodeType!==3&&i.startContainer.childNodes[i.startOffset]){const l=Te(i.startContainer.childNodes[i.startOffset]);l&&l.nodeType!==3&&l.getAttribute("data-type").indexOf("inline-math")>-1&&(o=l)}if(!o&&i.startOffset===i.startContainer.textContent.length&&i.startContainer.nodeType===3){let l=!0,r=!1;if(i.cloneContents().childNodes.forEach(d=>{d.nodeType!==3&&(d.getAttribute("data-type")||"").indexOf("inline-math")>-1||d.nodeType==3&&d.textContent===""?r=!0:l=!1}),l&&r){const d=ve(i.startContainer);if(d&&d.nodeType!==3&&d.getAttribute("data-type").indexOf("inline-math")>-1)o=d;else{const c=Te(i.startContainer);i.startOffset===0&&c&&c.nodeType!==3&&c.getAttribute("data-type").indexOf("inline-math")>-1&&(o=c)}}}if(o){t.toolbar.showRender(t,o);return}t.toolbar.setInlineMark(t,"inline-math","range",{type:"inline-math"})}))}}var no=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});class Vd extends Bt{constructor(t,n){super(t,n),this.element.addEventListener("click",a=>no(this,null,function*(){t.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=t.toolbar.range;if(!R(i.startContainer))return;const o=O(i.startContainer,"data-type","inline-memo");if(o&&o.textContent===i.toString()){t.toolbar.showRender(t,o);return}i.toString()!==""&&t.toolbar.setInlineMark(t,"inline-memo","range",{type:"inline-memo"})}))}}var ao=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});class Gd{constructor(t){const n=t.options,a=document.createElement("div");a.className="protyle-toolbar fn__none",this.element=a,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none protyle-util--mobile",this.toolbarHeight=29,n.toolbar.forEach(i=>{const s=this.genItem(t,i);this.element.appendChild(s)})}render(t,n,a){this.range=n;let i=hasClosestBlock(n.startContainer);if(isMobile()||!i||t.disabled||i.classList.contains("av")){this.element.classList.add("fn__none");return}let s=!1;if(Array.from(n.cloneContents().childNodes).find(u=>{if(u.textContent.length>0&&u.textContent!==Constants.ZWSP&&!(u.nodeType===1&&u.classList.contains("img")))return s=!0,!0}),!s||n.commonAncestorContainer.nodeType!==3&&n.commonAncestorContainer.classList.contains("img")){this.element.classList.add("fn__none");return}const o=hasClosestBlock(n.startContainer),l=hasClosestBlock(n.endContainer);if(o&&l&&!o.isSameNode(l)){if(a)if(a.key==="ArrowLeft")this.range=setLastNodeRange(getContenteditableElement(o),n,!1);else if(a.key==="ArrowRight")this.range=setFirstNodeRange(getContenteditableElement(l),n),this.range.collapse(!1);else if(a.key==="ArrowUp"){if(this.range=setFirstNodeRange(getContenteditableElement(l),n),i=hasClosestBlock(l),!i)return}else a.key==="ArrowDown"&&(this.range=setLastNodeRange(getContenteditableElement(o),n,!1));else this.range=setLastNodeRange(getContenteditableElement(i),n,!1);if(focusByRange(this.range),this.range.toString()===""){this.element.classList.add("fn__none");return}}if(i.getAttribute("data-type")==="NodeCodeBlock"){this.element.classList.add("fn__none");return}const r=getSelectionPosition(i,n);this.element.classList.remove("fn__none"),this.toolbarHeight=this.element.clientHeight;const d=r.top-this.toolbarHeight-4;this.element.setAttribute("data-inity",d+Constants.ZWSP+t.contentElement.scrollTop.toString()),setPosition(this.element,r.left-52,d),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach(u=>{u.classList.remove("protyle-toolbar__item--current")}),this.getCurrentType().forEach(u=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(u))return;const f=this.element.querySelector(`[data-type="${u}"]`);f&&f.classList.add("protyle-toolbar__item--current")})}getCurrentType(t=this.range){var n,a;let i=[],s=t.startContainer;if(s.nodeType===3?s=s.parentElement:s.childElementCount>0&&((n=s.childNodes[t.startOffset])==null?void 0:n.nodeType)!==3&&(s=s.childNodes[t.startOffset]),!s||s.nodeType===3)return[];["DIV","TD","TH","TR"].includes(s.tagName)||(i=(s.getAttribute("data-type")||"").split(" "));let o=t.endContainer;return o.nodeType===3?o=o.parentElement:o.childElementCount>0&&((a=o.childNodes[t.endOffset])==null?void 0:a.nodeType)!==3&&(o=o.childNodes[t.endOffset]),!o||o.nodeType===3?[]:(!["DIV","TD","TH","TR"].includes(o.tagName)&&!s.isSameNode(o)&&(i=i.concat((o.getAttribute("data-type")||"").split(" "))),t.cloneContents().childNodes.forEach(l=>{l.nodeType!==3&&(i=i.concat((l.getAttribute("data-type")||"").split(" ")))}),i=[...new Set(i)],i.find((l,r)=>{if(l==="")return i.splice(r,1),!0}),i)}genItem(t,n){let a;switch(n.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"clear":case"sub":case"kbd":a=new ToolbarItem(t,n);break;case"block-ref":a=new BlockRef(t,n);break;case"inline-math":a=new InlineMath(t,n);break;case"inline-memo":a=new InlineMemo(t,n);break;case"|":a=new Divider;break;case"text":a=new Font(t,n);break;case"a":a=new Link(t,n);break;default:a=new ToolbarItem(t,n);break}if(a)return a.element}mergeNode(t){for(let n=0;n<t.length;n++)t[n].nodeType!==3&&t[n].tagName==="WBR"&&(t[n].remove(),n--);for(let n=0;n<t.length;n++)t[n].nodeType===3&&(t[n].textContent===""?(t[n].remove(),n--):t[n+1]&&t[n+1].nodeType===3&&(t[n].textContent=t[n].textContent+t[n+1].textContent,t[n+1].remove(),n--))}setInlineMark(t,n,a,i){var s;const o=hasClosestBlock(this.range.startContainer);if(!o)return;const l=hasClosestBlock(this.range.endContainer);if(!l)return;o.isSameNode(l)||(this.range=setLastNodeRange(getContenteditableElement(o),this.range,!1));const r=this.getCurrentType(this.range),d=this.range.toString();fixTableRange(this.range);let c,u,f,g;const p=hasPreviousSibling(this.range.startContainer);["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)?p&&p.nodeType!==3&&this.range.startOffset===0&&(c=p):this.range.startOffset===0&&!p?(c=this.range.startContainer.parentElement.previousSibling,this.range.setStartBefore(this.range.startContainer.parentElement)):c=this.range.startContainer.parentElement;let m=!1;const y=hasNextSibling(this.range.endContainer);["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)?y&&y.nodeType!==3&&this.range.endOffset===this.range.endContainer.textContent.length&&(u=y):this.range.endOffset===this.range.endContainer.textContent.length&&!y?(u=this.range.endContainer.parentElement.nextSibling,this.range.setEndAfter(this.range.endContainer.parentElement),d===""&&(m=!0,this.range.collapse(!1))):u=this.range.endContainer.parentElement,this.range.insertNode(document.createElement("wbr"));const v=o.outerHTML,b=this.range.extractContents();if(this.mergeNode(b.childNodes),c&&u&&c.isSameNode(u)&&((s=b.firstChild)==null?void 0:s.nodeType)===3){const _=c.attributes;b.childNodes.forEach(L=>{const A=document.createElement("span");for(let S=0;S<_.length;S++)A.setAttribute(_[S].name,_[S].value);A.innerHTML=L.textContent,L.replaceWith(A)})}const w=isMobile()?document.querySelector("#keyboardToolbar .keyboard__dynamic").nextElementSibling:this.element,h=a==="toolbar"?w.querySelector(`[data-type="${n}"]`):void 0,C=[];if(n==="clear"||h!=null&&h.classList.contains("protyle-toolbar__item--current")||a==="range"&&r.length>0&&r.includes(n)&&!i){if(n==="clear"?w.querySelectorAll('[data-type="em"],[data-type="u"],[data-type="s"],[data-type="mark"],[data-type="sup"],[data-type="sub"],[data-type="strong"]').forEach(_=>{_.classList.remove("protyle-toolbar__item--current")}):h&&h.classList.remove("protyle-toolbar__item--current"),b.childNodes.length===0)if(r.find((_,L)=>{if(n===_)return r.splice(L,1),!0}),r.length===0||n==="clear")C.push(document.createTextNode(Constants.ZWSP));else{let _=0;for(;_<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[_])?r.splice(_,1):++_;const L=document.createElement("span");L.setAttribute("data-type",r.join(" ")),L.textContent=Constants.ZWSP,C.push(L)}b.childNodes.forEach((_,L)=>{if(_.nodeType!==3&&_.tagName!=="BR"&&_.tagName!=="IMG"&&!_.classList.contains("img")){if(_.textContent==="")return;const A=(_.getAttribute("data-type")||"").split(" ");if(n==="clear")for(let S=0;S<A.length;S++)i&&i.type==="text"?A[S]==="text"&&(A.splice(S,1),S--):["kbd","text","strong","em","u","s","mark","sup","sub","code"].includes(A[S])&&(A.splice(S,1),S--);else A.find((S,I)=>{if(n===S)return A.splice(I,1),!0});if(A.length===0)_.textContent===""&&(_.textContent=Constants.ZWSP),C.push(document.createTextNode(_.textContent));else{if(d&&n==="clear"&&i&&i.type==="text"&&_.style.color===""&&_.style.webkitTextFillColor===""&&_.style.webkitTextStroke===""&&_.style.textShadow===""&&_.style.backgroundColor===""&&_.style.fontSize==="")return _.setAttribute("data-type",A.join(" ")),C.push(_),!0;n==="clear"&&(_.style.color="",_.style.webkitTextFillColor="",_.style.webkitTextStroke="",_.style.textShadow="",_.style.backgroundColor="",_.style.fontSize=""),L===0&&c&&c.nodeType!==3&&isArrayEqual(A,(c.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(_,c,i)?(f=c.textContent.length,c.innerHTML=c.innerHTML+_.innerHTML):L===b.childNodes.length-1&&u&&u.nodeType!==3&&isArrayEqual(A,(u.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(_,u,i)?(g=_.textContent.length,u.innerHTML=_.innerHTML+u.innerHTML):(_.setAttribute("data-type",A.join(" ")),C.push(_))}}else C.push(_)})}else if(!this.element.classList.contains("fn__none")&&n!=="text"&&h&&h.classList.add("protyle-toolbar__item--current"),d===""){const _=document.createElement("span");if(r.push(n),m){let L=0;for(;L<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[L])?r.splice(L,1):++L}_.setAttribute("data-type",[...new Set(r)].join(" ")),_.textContent=Constants.ZWSP,setFontStyle(_,i),C.push(_)}else{if(n==="block-ref")for(;b.childNodes.length>1;)b.childNodes[0].remove();b.childNodes.forEach((_,L)=>{if(_.nodeType===3)if(L===0&&c&&c.nodeType!==3&&n===c.getAttribute("data-type")&&hasSameTextStyle(_,c,i))f=c.textContent.length,c.innerHTML=c.innerHTML+_.textContent;else if(L===b.childNodes.length-1&&u&&u.nodeType!==3&&n===u.getAttribute("data-type")&&hasSameTextStyle(_,u,i))g=_.textContent.length,u.innerHTML=_.textContent+u.innerHTML;else if(_.textContent!==Constants.ZWSP){const A=document.createElement("span");A.setAttribute("data-type",n),A.textContent=_.textContent,setFontStyle(A,i),C.push(A)}else C.push(_);else{let A=(_.getAttribute("data-type")||"").split(" ");for(let S=0;S<A.length;S++)["backslash","virtual-block-ref","search-mark"].includes(A[S])&&(A.splice(S,1),S--);A.includes("img")||A.push(n),n==="sub"&&A.includes("sup")?A.find((S,I)=>{if(S==="sup")return A.splice(I,1),w.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="sup"&&A.includes("sub")?A.find((S,I)=>{if(S==="sub")return A.splice(I,1),w.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="block-ref"&&(A.includes("a")||A.includes("file-annotation-ref"))?A.find((S,I)=>{if(S==="a"||S==="file-annotation-ref")return A.splice(I,1),!0}):n==="a"&&(A.includes("block-ref")||A.includes("file-annotation-ref"))?A.find((S,I)=>{if(S==="block-ref"||S==="file-annotation-ref")return A.splice(I,1),!0}):n==="file-annotation-ref"&&(A.includes("block-ref")||A.includes("a"))?A.find((S,I)=>{if(S==="block-ref"||S==="a")return A.splice(I,1),!0}):n==="inline-memo"&&A.includes("inline-math")?(A.find((S,I)=>{if(S==="inline-math")return A.splice(I,1),!0}),_.textContent=_.getAttribute("data-content")):n==="inline-math"&&A.includes("inline-memo")&&A.find((S,I)=>{if(S==="inline-memo")return A.splice(I,1),!0}),A=[...new Set(A)],L===0&&c&&c.nodeType!==3&&isArrayEqual(A,(c.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(_,c,i)?(f=c.textContent.length,c.innerHTML=c.innerHTML+_.innerHTML):L===b.childNodes.length-1&&u&&u.nodeType!==3&&isArrayEqual(A,(u.getAttribute("data-type")||"").split(" "))&&hasSameTextStyle(_,u,i)?(g=_.textContent.length,u.innerHTML=_.innerHTML+u.innerHTML):(_.tagName!=="BR"&&_.tagName!=="IMG"&&(_.setAttribute("data-type",A.join(" ")),setFontStyle(_,i)),C.push(_))}})}if(this.range.startContainer.nodeType!==3&&this.range.startContainer.tagName==="SPAN"&&this.range.startContainer.isSameNode(this.range.endContainer)&&!m){const _=this.range.startContainer,L=document.createElement("span"),A=_.attributes;for(let S=0;S<A.length;S++)L.setAttribute(A[S].name,A[S].value);this.range.setEnd(_.lastChild,_.lastChild.textContent.length),L.append(this.range.extractContents()),_.after(L),this.range.setStartBefore(L),this.range.collapse(!0)}for(let _=0;_<C.length;_++){const L=C[_],A=C[_+1],S=L.nodeType!==3&&L.getAttribute("data-type")||"";if(L.nodeType!==3&&A&&A.nodeType!==3&&A.tagName===L.tagName&&L.tagName!=="BR"&&isArrayEqual((A.getAttribute("data-type")||"").split(" "),S.split(" "))&&L.getAttribute("data-id")===A.getAttribute("data-id")&&L.getAttribute("data-subtype")===A.getAttribute("data-subtype")&&L.style.color===A.style.color&&L.style.webkitTextFillColor===A.style.webkitTextFillColor&&L.style.webkitTextStroke===A.style.webkitTextStroke&&L.style.textShadow===A.style.textShadow&&L.style.fontSize===A.style.fontSize&&L.style.backgroundColor===A.style.backgroundColor)S.indexOf("inline-math")>-1?A.setAttribute("data-content",L.getAttribute("data-content")+A.getAttribute("data-content")):(A.innerHTML=L.innerHTML+A.innerHTML,S.indexOf("inline-memo")>-1&&A.setAttribute("data-inline-memo-content",(L.getAttribute("data-inline-memo-content")||"")+(A.getAttribute("data-inline-memo-content")||""))),C.splice(_,1),_--;else{if(this.range.insertNode(L),L.nodeType===1&&["code","tag","kbd"].includes(n)){const I=hasPreviousSibling(L);(!I||I.textContent.endsWith(`
`))&&L.before(document.createTextNode(Constants.ZWSP)),L.textContent.startsWith(Constants.ZWSP)||(L.textContent=Constants.ZWSP+L.textContent);const T=hasNextSibling(L);(!T||T&&(T.nodeType!==3||T.nodeType===3&&!T.textContent.startsWith(Constants.ZWSP)))&&L.after(document.createTextNode(Constants.ZWSP))}else if(L.nodeType===3&&["code","tag","kbd","clear"].includes(n)){const I=hasPreviousSibling(L);let T=!1;if(I)if(I.nodeType===1){const $=I.dataset.type.split(" ");($.includes("code")||$.includes("tag")||$.includes("kbd"))&&(T=!0)}else I.textContent.endsWith(Constants.ZWSP)&&(I.textContent=I.textContent.substring(0,I.textContent.length-1));const D=hasNextSibling(L);let M=!1;if(D)if(D.nodeType===1){const $=D.dataset.type.split(" ");($.includes("code")||$.includes("tag")||$.includes("kbd"))&&(M=!0)}else D.textContent.startsWith(Constants.ZWSP)&&(D.textContent=D.textContent.substring(1));L&&(T?L.textContent.startsWith(Constants.ZWSP)||(L.textContent=Constants.ZWSP+L.textContent):L.textContent.startsWith(Constants.ZWSP)&&(L.textContent=L.textContent.substring(1)),M?D.textContent.startsWith(Constants.ZWSP)||(D.textContent=Constants.ZWSP+D.textContent):L.textContent.endsWith(Constants.ZWSP)&&(L.textContent=L.textContent.substring(0,L.textContent.length-1)))}this.range.collapse(!1)}}if(c&&(c.nodeType!==3&&c.textContent===Constants.ZWSP?c.remove():this.mergeNode(c.childNodes)),u&&this.mergeNode(u.childNodes),f?this.range.setStart(c.firstChild,f):C.length>0?C[0].nodeType!==3&&C[0].getAttribute("data-type")==="inline-math"||(C[0].firstChild?C[0].firstChild.textContent===Constants.ZWSP?this.range.setStart(C[0].firstChild,1):this.range.setStart(C[0].firstChild,0):C[0].nodeType===3?this.range.setStart(C[0],0):this.range.setStartBefore(C[0])):u&&this.range.setStart(u.firstChild,0),g)this.range.setEnd(u.lastChild,g);else if(C.length>0){const _=C[C.length-1];if(_.nodeType!==3&&_.getAttribute("data-type").indexOf("inline-math")>-1){const L=hasPreviousSibling(_);L&&L.nodeType===3?this.range.setStart(L,L.textContent.length):this.range.setStartBefore(_);const A=hasNextSibling(_);A&&A.nodeType===3?this.range.setEnd(A,0):this.range.setEndAfter(_)}else _.lastChild?_.lastChild.textContent===Constants.ZWSP?this.range.collapse(!0):this.range.setEnd(_.lastChild,_.lastChild.textContent.length):_.nodeType===3?(this.range.setEnd(_,_.textContent.length),_.textContent===Constants.ZWSP&&this.range.collapse(!1)):this.range.setEndAfter(_)}else c&&this.range.setEnd(c.firstChild,c.firstChild.textContent.length);let k=!0;if(n==="inline-math"){if(mathRender(o),d===""){t.toolbar.showRender(t,C[0],void 0,v);return}}else if(n==="inline-memo"){t.toolbar.showRender(t,C[0],C,v);return}else if(n==="block-ref")this.range.collapse(!1);else if(n==="a"){const _=C[0];_.textContent.replace(Constants.ZWSP,"")===""||!_.getAttribute("data-href")?(k=!1,linkMenu(t,_,!!_.getAttribute("data-href"))):this.range.collapse(!1)}o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,o.getAttribute("data-node-id"),o.outerHTML,v);const E=o.querySelector("wbr");E&&E.remove(),k&&focusByRange(this.range)}showRender(t,n,a,i){var s;const o=hasClosestBlock(n);if(!o)return;hideElements(["hint"],t),window.siyuan.menus.menu.remove();const l=o.getAttribute("data-node-id"),r=(n.getAttribute("data-type")||"").split(" "),d=i||o.outerHTML;let c="HTML",u="";const f=r.includes("inline-memo");switch(n.getAttribute("data-subtype")){case"abc":c=window.siyuan.languages.staff;break;case"echarts":c=window.siyuan.languages.chart;break;case"flowchart":c="Flow Chart";break;case"graphviz":c="Graphviz";break;case"mermaid":c="Mermaid";break;case"mindmap":u=`- foo
  - bar
- baz`,c=window.siyuan.languages.mindmap;break;case"plantuml":c="UML";break;case"math":r.includes("NodeMathBlock")?c=window.siyuan.languages.math:c=window.siyuan.languages["inline-math"];break}r.includes("NodeBlockQueryEmbed")?c=window.siyuan.languages.blockEmbed:f&&(c=window.siyuan.languages.memo);const g=((s=this.subElement.querySelector('[data-type="pin"]'))==null?void 0:s.getAttribute("aria-label"))===window.siyuan.languages.unpin,p={};if(g){const h=this.subElement.querySelector(".b3-text-field");p.styleH=h.style.height,p.styleW=h.style.width}else this.subElement.style.width="",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${g&&this.subElement.firstElementChild.getAttribute("data-drag")==="true"?'data-drag="true"':""}><div class="block__icons block__icons--menu fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0;">
    <span class="fn__flex-1 resize__move">
        ${c}
    </span>
    <span class="fn__space"></span>
    <button data-type="refresh" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${g&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${r.includes("NodeBlockQueryEmbed")?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="before" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${t.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-before"]}"><svg><use xlink:href="#iconBefore"></use></svg></button>
    <span class="fn__space${t.disabled?" fn__none":""}"></span>
    <button data-type="after" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${t.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-after"]}"><svg><use xlink:href="#iconAfter"></use></svg></button>
    <span class="fn__space${t.disabled?" fn__none":""}"></span>
    <button data-type="export" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.export} ${window.siyuan.languages.image}"><svg><use xlink:href="#iconImage"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${g?window.siyuan.languages.unpin:window.siyuan.languages.pin}"><svg><use xlink:href="#icon${g?"Unpin":"Pin"}"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px"><use xlink:href="#iconClose"></use></svg></button>
</div>
<textarea ${t.disabled?" readonly":""} spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${u}" style="${isMobile()?"":"width:"+Math.max(480,n.clientWidth*.7)+"px"};max-height:calc(80vh - 44px);min-height: 48px;min-width: 268px;border-radius: 0 0 var(--b3-border-radius-b) var(--b3-border-radius-b);font-family: var(--b3-font-family-code);"></textarea></div>`;const m=()=>{if(b.style.height=b.scrollHeight+"px",isMobile()){setPosition(this.subElement,0,0);return}if(this.subElement.firstElementChild.getAttribute("data-drag")==="true"){b.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px");return}const h=w.bottom===w.top?w.bottom+26:w.bottom;this.subElement.clientHeight<=window.innerHeight-h||this.subElement.clientHeight<=w.top?r.includes("inline-math")||f?setPosition(this.subElement,w.left,h,w.height||26):setPosition(this.subElement,w.left+(w.width-this.subElement.clientWidth)/2,h,w.height||26):setPosition(this.subElement,w.right,h)},y=this.subElement.querySelector(".block__icons");y.addEventListener("click",h=>{const C=h.target,k=hasClosestByClassName(C,"b3-tooltips");if(!k){if(h.detail===2){const E=y.querySelector('[data-type="pin"]');E.getAttribute("aria-label")===window.siyuan.languages.unpin?(E.querySelector("svg use").setAttribute("xlink:href","#iconPin"),E.setAttribute("aria-label",window.siyuan.languages.pin)):(E.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),E.setAttribute("aria-label",window.siyuan.languages.unpin)),h.preventDefault(),h.stopPropagation()}return}switch(h.stopPropagation(),k.getAttribute("data-type")){case"close":this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),hideElements(["util"],t);break;case"pin":k.getAttribute("aria-label")===window.siyuan.languages.unpin?(k.querySelector("svg use").setAttribute("xlink:href","#iconPin"),k.setAttribute("aria-label",window.siyuan.languages.pin)):(k.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),k.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":k.classList.toggle("block__icon--active");break;case"before":insertEmptyBlock(t,"beforebegin",l),hideElements(["util"],t);break;case"after":insertEmptyBlock(t,"afterend",l),hideElements(["util"],t);break;case"export":v();break}});const v=()=>{const h=showMessage(window.siyuan.languages.exporting,0);if(n.getAttribute("data-subtype")==="plantuml"){fetch(n.querySelector("img").getAttribute("src")).then(function(C){return C.blob()}).then(function(C){const k=new FormData;k.append("file",C),k.append("type","image/png"),fetchPost("/api/export/exportAsFile",k,E=>{openByMobile(E.data.file),hideMessage(h)})});return}setTimeout(()=>{addScript("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(n,{useCORS:!0}).then(C=>{C.toBlob(k=>{const E=new FormData;E.append("file",k),E.append("type","image/png"),fetchPost("/api/export/exportAsFile",E,_=>{openByMobile(_.data.file),hideMessage(h)})})})})},Constants.TIMEOUT_LOAD)},b=this.subElement.querySelector(".b3-text-field");r.includes("NodeHTMLBlock")?b.value=Lute.UnEscapeHTMLStr(n.querySelector("protyle-html").getAttribute("data-content")||""):f?b.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-inline-memo-content")||""):b.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-content")||""),b.addEventListener("input",h=>{if(n.parentElement&&(b.clientHeight!==b.scrollHeight&&m(),!!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))){if(r.includes("NodeHTMLBlock"))n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(b.value));else if(f){let C;a?C=a:C=[n],C.forEach(k=>{k.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(b.value))})}else n.setAttribute("data-content",Lute.EscapeHTMLStr(b.value)),n.removeAttribute("data-render");(!r.includes("NodeBlockQueryEmbed")||!r.includes("NodeHTMLBlock")||!f)&&processRender(n),h.stopPropagation()}}),b.addEventListener("keydown",h=>{if(h.stopPropagation(),matchHotKey(window.siyuan.config.keymap.editor.insert["inline-math"].custom,h)){h.preventDefault();return}if(!h.isComposing){if(h.key==="Escape"||matchHotKey("\u2318\u21A9",h))this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),hideElements(["util"],t);else if(h.key==="Tab")document.execCommand("insertText",!1,"	"),h.preventDefault();else if(electronUndo(h))return}}),this.subElementCloseCB=()=>{var h;if(!n.parentElement||t.disabled)return;let C;if(r.includes("NodeHTMLBlock")){let k=b.value;k&&(k=k.trim().replace(/\n+/g,`
`),k.startsWith("<div>")&&k.endsWith("</div>")||(k=`<div>
${k}
</div>`)),n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(k))}else if(f){let k;a?k=a:k=[n],k.forEach((E,_)=>{if(b.value)E.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(b.value));else{const L=E.getAttribute("data-type").split(" ");L.length===1&&L[0]==="inline-memo"?E.outerHTML=E.innerHTML+(_===k.length-1?"<wbr>":""):(L.find((A,S)=>{if(A==="inline-memo")return L.splice(S,1),!0}),E.setAttribute("data-type",L.join(" ")),E.removeAttribute("data-inline-memo-content")),_===k.length-1&&(C=E)}})}else r.includes("inline-math")?b.value?(n.setAttribute("data-content",Lute.EscapeHTMLStr(b.value)),n.removeAttribute("data-render"),processRender(n)):(C=n,n.outerHTML="<wbr>"):(n.setAttribute("data-content",Lute.EscapeHTMLStr(b.value)),n.removeAttribute("data-render"),r.includes("NodeBlockQueryEmbed")?blockRender(t,n):processRender(n));if(getSelection().rangeCount===0||getSelection().rangeCount>0&&hasClosestByClassName(getSelection().getRangeAt(0).startContainer,"protyle-util")?n.tagName==="SPAN"?C?C.parentElement?(this.range.setStartAfter(C),this.range.collapse(!0),focusByRange(this.range)):focusByWbr(o,this.range):n.parentElement&&(this.range.setStartAfter(n),this.range.collapse(!0),focusByRange(this.range)):(focusBlock(n),n.classList.add("protyle-wysiwyg--select")):(h=o.querySelector("wbr"))==null||h.remove(),o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),r.includes("NodeHTMLBlock")){const k=document.createElement("template");k.innerHTML=t.lute.SpinBlockDOM(o.outerHTML),k.content.childElementCount>1&&showMessage(window.siyuan.languages.htmlBlockTip)}updateTransaction(t,l,o.outerHTML,d)},this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none");const w=n.getBoundingClientRect();this.element.classList.add("fn__none"),g?(b.style.width=p.styleW,b.style.height=p.styleH):m(),t.disabled||b.select(),t.app.plugins.forEach(h=>{h.eventBus.emit("open-noneditableblock",{protyle:t,toolbar:this})})}updateLanguage(t,n,a,i,s,o){t.textContent=o===window.siyuan.languages.clear?"":o,Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(t.textContent)||(window.siyuan.storage[Constants.LOCAL_CODELANG]=t.textContent,setStorageVal(Constants.LOCAL_CODELANG,window.siyuan.storage[Constants.LOCAL_CODELANG]));const l=getContenteditableElement(i);return Constants.SIYUAN_RENDER_CODE_LANGUAGES.includes(t.textContent)?(i.dataset.content=l.textContent.trim(),i.dataset.subtype=t.textContent,i.className="render-node",i.innerHTML=`<div spin="1"></div><div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,processRender(i)):(l.textContent=l.textContent,l.parentElement.removeAttribute("data-render"),highlightRender(i)),i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(n,a,i.outerHTML,s),this.subElement.classList.add("fn__none"),focusByRange(this.range),i.outerHTML}showCodeLanguage(t,n){var a,i;const s=hasClosestBlock(n);if(!s)return;hideElements(["hint"],t),window.siyuan.menus.menu.remove(),this.range=getEditorRange(s);const o=s.getAttribute("data-node-id");let l=s.outerHTML,r=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`;const d=Constants.ALIAS_CODE_LANGUAGES.concat((i=(a=window.hljs)==null?void 0:a.listLanguages())!=null?i:[]).sort();d.forEach((f,g)=>{r+=`<div class="b3-list-item${g===0?" b3-list-item--focus":""}">${f}</div>`}),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input placeholder="${window.siyuan.languages.search}" style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${r}</div>
</div>`;const c=this.subElement.lastElementChild.lastElementChild,u=this.subElement.querySelector("input");u.addEventListener("keydown",f=>{if(f.stopPropagation(),!f.isComposing){if(upDownHint(c,f),f.key==="Enter"){l=this.updateLanguage(n,t,o,s,l,this.subElement.querySelector(".b3-list-item--focus").textContent),f.preventDefault(),f.stopPropagation();return}f.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range))}}),u.addEventListener("input",f=>{const g=u.value.toLowerCase(),p=d.filter(v=>v.includes(g));let m="",y=!1;p.sort((v,b)=>v.startsWith(g)&&b.startsWith(g)?v.length<b.length?-1:v.length===b.length?0:1:v.startsWith(g)?-1:b.startsWith(g)?1:0).forEach(v=>{u.value===v&&(y=!0),m+=`<div class="b3-list-item">${v.replace(g,"<b>"+g+"</b>")}</div>`}),u.value.trim()&&!y&&(m=`<div class="b3-list-item"><b>${escapeHtml(u.value.replace(/`| /g,"_"))}</b></div>${m}`),m=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`+m,c.innerHTML=m,c.firstElementChild.nextElementSibling?c.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus"):c.firstElementChild.classList.add("b3-list-item--focus"),f.stopPropagation()}),c.addEventListener("click",f=>{const g=f.target,p=hasClosestByClassName(g,"b3-list-item");p&&(l=this.updateLanguage(n,t,o,s,l,p.textContent))}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,setPosition(this.subElement,0,0),this.element.classList.add("fn__none"),u.select()}showTpl(t,n,a){this.range=a,hideElements(["hint"],t),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${isMobile()?"width: 100%":"min-width: 260px;max-width:50vw"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div style="width: 520px;${isMobile()||window.outerWidth<window.outerWidth/2+520?"display:none":""};overflow: auto;"></div>
</div>`;const i=this.subElement.querySelector(".b3-list"),s=this.subElement.firstElementChild.lastElementChild;let o;i.addEventListener("mouseover",r=>{const d=r.target,c=hasClosestByClassName(d,"b3-list-item");if(!c)return;const u=c.getAttribute("data-value");o!==u&&(o=u,previewTemplate(o,s,t.block.parentID))});const l=this.subElement.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),r.isComposing)return;const d=!this.subElement.querySelector(".b3-list-item");if(!d){const c=upDownHint(i,r);if(c){const u=c.getAttribute("data-value");if(o===u)return;o=u,previewTemplate(o,s,t.block.parentID)}}r.key==="Enter"?(d?focusByRange(this.range):hintRenderTemplate(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),t,n),this.subElement.classList.add("fn__none"),r.preventDefault()):r.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range))}),l.addEventListener("input",r=>{r.stopPropagation(),fetchPost("/api/search/searchTemplate",{k:l.value},d=>{var c;let u="";d.data.blocks.forEach((g,p)=>{u+=`<div data-value="${g.path}" class="b3-list-item${p===0?" b3-list-item--focus":""}">${g.content}</div>`}),i.innerHTML=u||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const f=(c=d.data.blocks[0])==null?void 0:c.path;o!==f&&(o=f,previewTemplate(o,s,t.block.parentID))})}),this.subElement.lastElementChild.addEventListener("click",r=>{const d=r.target;if(d.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),focusByRange(this.range),r.stopPropagation();return}const c=hasClosestByClassName(d,"b3-list-item__action");if(c&&c.getAttribute("data-type")==="remove"){confirmDialog(window.siyuan.languages.remove,window.siyuan.languages.confirmDelete+"?",()=>{fetchPost("/api/search/removeTemplate",{path:c.parentElement.getAttribute("data-value")},()=>{if(c.parentElement.parentElement.childElementCount===1)c.parentElement.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,previewTemplate("",s,t.block.parentID);else{if(c.parentElement.classList.contains("b3-list-item--focus")){const p=c.parentElement.previousElementSibling||c.parentElement.nextElementSibling;p.classList.add("b3-list-item--focus");const m=p.getAttribute("data-value");if(o===m)return;o=m,previewTemplate(o,s,t.block.parentID)}c.parentElement.remove()}})}),r.stopPropagation();return}if(hasClosestByAttribute(d,"data-type","previous")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),r.stopPropagation();return}if(hasClosestByAttribute(d,"data-type","next")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),r.stopPropagation();return}const g=hasClosestByClassName(d,"b3-list-item");g&&(hintRenderTemplate(decodeURIComponent(g.getAttribute("data-value")),t,n),r.stopPropagation())}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),l.select(),fetchPost("/api/search/searchTemplate",{k:""},r=>{let d="";r.data.blocks.forEach((c,u)=>{d+=`<div data-value="${c.path}" class="b3-list-item--hide-action b3-list-item${u===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${c.content}</span>`,d+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=d||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,setPosition(this.subElement,0,0),o=i.firstElementChild.getAttribute("data-value"),previewTemplate(o,s,t.block.parentID)})}showWidget(t,n,a){this.range=a,hideElements(["hint"],t),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height:64px" src="/stage/loading-pure.svg"></div>
</div>`;const i=this.subElement.lastElementChild.lastElementChild,s=this.subElement.querySelector("input");s.addEventListener("keydown",o=>{o.stopPropagation(),!o.isComposing&&(upDownHint(i,o),o.key==="Enter"?(hintRenderWidget(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-content"),t),this.subElement.classList.add("fn__none"),o.preventDefault()):o.key==="Escape"&&(this.subElement.classList.add("fn__none"),focusByRange(this.range)))}),s.addEventListener("input",o=>{o.stopPropagation(),fetchPost("/api/search/searchWidget",{k:s.value},l=>{let r="";l.data.blocks.forEach((d,c)=>{r+=`<div data-value="${d.path}" data-content="${d.content}" class="b3-list-item${c===0?" b3-list-item--focus":""}">
    ${d.name}
    <span class="b3-list-item__meta">${d.content}</span>
</div>`}),i.innerHTML=r})}),this.subElement.lastElementChild.addEventListener("click",o=>{const l=o.target,r=hasClosestByClassName(l,"b3-list-item");r&&hintRenderWidget(r.dataset.content,t)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),s.select(),fetchPost("/api/search/searchWidget",{k:""},o=>{let l="";o.data.blocks.forEach((r,d)=>{l+=`<div class="b3-list-item${d===0?" b3-list-item--focus":""}" data-content="${r.content}">
${r.name}
<span class="b3-list-item__meta">${r.content}</span>
</div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=l,setPosition(this.subElement,0,0)})}showContent(t,n,a){var i,s;this.range=n,hideElements(["hint"],t),this.subElement.style.width="auto",this.subElement.style.padding="0 8px";let o="";const l=n.toString()!==""||((s=(i=n.cloneContents().childNodes[0])==null?void 0:i.classList)==null?void 0:s.contains("emoji"));l&&(o+='<button class="keyboard__action" data-action="copy"><svg><use xlink:href="#iconCopy"></use></svg></button>',t.disabled||(o+=`<button class="keyboard__action" data-action="cut"><svg><use xlink:href="#iconCut"></use></svg></button>
<button class="keyboard__action" data-action="delete"><svg><use xlink:href="#iconTrashcan"></use></svg></button>`)),t.disabled||(o+=`<button class="keyboard__action" data-action="paste"><svg><use xlink:href="#iconPaste"></use></svg></button>
<button class="keyboard__action" data-action="select"><svg><use xlink:href="#iconSelect"></use></svg></button>`),(l||!t.disabled)&&(o+='<button class="keyboard__action" data-action="more"><svg><use xlink:href="#iconMore"></use></svg></button>'),this.subElement.innerHTML=`<div class="fn__flex">${o}</div>`,this.subElement.lastElementChild.addEventListener("click",d=>ao(this,null,function*(){const c=hasClosestByClassName(d.target,"keyboard__action");if(!c)return;const u=c.getAttribute("data-action");if(u==="copy")focusByRange(getEditorRange(a)),document.execCommand("copy"),this.subElement.classList.add("fn__none");else if(u==="cut")focusByRange(getEditorRange(a)),document.execCommand("cut"),this.subElement.classList.add("fn__none");else if(u==="delete"){const f=getEditorRange(a);f.insertNode(document.createElement("wbr"));const g=a.outerHTML;f.extractContents(),focusByWbr(a,f),focusByRange(f),updateTransaction(t,a.getAttribute("data-node-id"),a.outerHTML,g),this.subElement.classList.add("fn__none")}else if(u==="paste"){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const f=yield readText();pasteText(t,f,a)}catch(f){console.log(f)}this.subElement.classList.add("fn__none")}else u==="select"?(selectAll(t,a,n),this.subElement.classList.add("fn__none")):u==="copyPlainText"?(focusByRange(getEditorRange(a)),copyPlainText(getSelection().getRangeAt(0).toString()),this.subElement.classList.add("fn__none")):u==="pasteAsPlainText"?(focusByRange(getEditorRange(a)),pasteAsPlainText(t),this.subElement.classList.add("fn__none")):u==="pasteEscaped"?(pasteEscaped(t,a),this.subElement.classList.add("fn__none")):u==="back"?this.subElement.lastElementChild.innerHTML=o:u==="more"&&(this.subElement.lastElementChild.innerHTML=`<button class="keyboard__action${l?"":" fn__none"}" data-action="copyPlainText"><span>${window.siyuan.languages.copyPlainText}</span></button>
<div class="keyboard__split${l?"":" fn__none"}"></div>
<button class="keyboard__action${t.disabled?" fn__none":""}" data-action="pasteAsPlainText"><span>${window.siyuan.languages.pasteAsPlainText}</span></button>
<div class="keyboard__split${t.disabled?" fn__none":""}"></div>
<button class="keyboard__action${t.disabled?" fn__none":""}" data-action="pasteEscaped"><span>${window.siyuan.languages.pasteEscaped}</span></button>
<div class="keyboard__split${t.disabled?" fn__none":""}"></div>
<button class="keyboard__action" data-action="back"><svg><use xlink:href="#iconBack"></use></svg></button>`,setPosition(this.subElement,r.left,r.top+28,Constants.SIZE_TOOLBAR_HEIGHT))})),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none");const r=getSelectionPosition(a,n);setPosition(this.subElement,r.left,r.top-48,Constants.SIZE_TOOLBAR_HEIGHT)}}const zd=(e,t,n,a,i)=>{let s=1,o;fetchPost(`/api/riff/get${a}RiffCards`,{id:t,page:s},l=>{var r;const d=new Dialog({positionId:Constants.DIALOG_VIEWCARDS,content:`<div class="fn__flex-column" style="height: 100%">
    <div class="block__icons">
        <span class="fn__flex-1 fn__flex-center resize__move">${escapeHtml(n)}</span>
        <span class="fn__space"></span>
        <span data-type="resetAll" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${a===""&&t===""?" fn__none":""}" aria-label="${window.siyuan.languages.reset}"><svg><use xlink:href='#iconUndo'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span class="fn__flex-center ft__on-surface">${s}/${l.data.pageCount||1}</span>
        <span class="fn__space"></span>
        <span class="counter">${l.data.total}</span>
        ${isMobile()?`<span class="fn__space"></span>
<div data-type="close" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconCloseRound"></use></svg>
</div>`:""}
    </div>
    <div class="${isMobile()?"fn__flex-column":"fn__flex"} fn__flex-1" style="min-height: auto">
        <ul class="fn__flex-1 b3-list b3-list--background" style="user-select: none">
            ${Vn(l.data.blocks,n,a)}
        </ul>
        <div id="cardPreview" style="border-bottom-right-radius:var(--b3-border-radius-b);" class="fn__flex-1 fn__none"></div>
        <div class="fn__flex-1 card__empty">${window.siyuan.languages.emptyContent}</div>
    </div>
</div>`,width:isMobile()?"100vw":"80vw",height:isMobile()?"100vh":"70vh",destroyCallback(){o&&(o.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))},resizeCallback(g){g!=="d"&&g!=="t"&&o&&o.resize()}});l.data.blocks.length>0&&(o=new Protyle(e,d.element.querySelector("#cardPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}}),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=o),d.editors={card:o},o.resize(),dt(o,(r=d.element.querySelector(".b3-list-item--focus"))==null?void 0:r.getAttribute("data-id")));const c=d.element.querySelector('[data-type="previous"]'),u=d.element.querySelector('[data-type="next"]'),f=d.element.querySelector(".b3-list--background");l.data.pageCount>1&&u.removeAttribute("disabled"),d.element.setAttribute("data-key",Constants.DIALOG_VIEWCARDS),d.element.addEventListener("click",g=>{var p;if(typeof g.detail=="string"){let y=f.querySelector(".b3-list-item--focus");if(y){y.classList.remove("b3-list-item--focus"),g.detail==="arrowup"?y=y.previousElementSibling||y.parentElement.lastElementChild:g.detail==="arrowdown"?y=y.nextElementSibling||y.parentElement.firstElementChild:g.detail==="home"?y=y.parentElement.firstElementChild:g.detail==="end"&&(y=y.parentElement.lastElementChild);const v=y.getBoundingClientRect(),b=y.parentElement.getBoundingClientRect();(v.top<b.top||v.bottom>b.bottom)&&y.scrollIntoView(v.top<b.top),dt(o,y.getAttribute("data-id")),y.classList.add("b3-list-item--focus")}g.stopPropagation(),g.preventDefault();return}let m=g.target;for(;m&&!d.element.isSameNode(m);){const y=m.getAttribute("data-type");if(y==="close"){d.destroy(),g.stopPropagation(),g.preventDefault();break}else if(y==="previous"){if(s<=1)return;s--,s<=1&&c.setAttribute("disabled","disabled"),fetchPost(`/api/riff/get${a}RiffCards`,{id:t,page:s},v=>{var b;s===v.data.pageCount?u.setAttribute("disabled","disabled"):v.data.pageCount>1&&u.removeAttribute("disabled"),u.nextElementSibling.nextElementSibling.textContent=`${s}/${v.data.pageCount||1}`,f.innerHTML=Vn(v.data.blocks,n,a),f.scrollTop=0,dt(o,(b=d.element.querySelector(".b3-list-item--focus"))==null?void 0:b.getAttribute("data-id"))}),g.stopPropagation(),g.preventDefault();break}else if(y==="next"){if(s>=l.data.pageCount)return;s++,c.removeAttribute("disabled"),fetchPost(`/api/riff/get${a}RiffCards`,{id:t,page:s},v=>{var b;s===v.data.pageCount?u.setAttribute("disabled","disabled"):v.data.pageCount>1&&u.removeAttribute("disabled"),u.nextElementSibling.nextElementSibling.textContent=`${s}/${v.data.pageCount||1}`,f.innerHTML=Vn(v.data.blocks,n,a),f.scrollTop=0,dt(o,(b=d.element.querySelector(".b3-list-item--focus"))==null?void 0:b.getAttribute("data-id"))}),g.stopPropagation(),g.preventDefault();break}else if(y==="reset"){fetchPost("/api/riff/resetRiffCards",{type:a===""?"deck":a.toLowerCase(),deckID:a===""?t:Constants.QUICK_DECK_ID,id:t,blockIDs:[m.getAttribute("data-id")]},()=>{m.parentElement.querySelector(".ariaLabel.b3-list-item__meta").textContent=dayjs().format("YYYY-MM-DD")}),g.stopPropagation(),g.preventDefault();break}else if(y==="resetAll"){confirmDialog(window.siyuan.languages.reset,window.siyuan.languages.resetCardTip.replace("${x}",d.element.querySelector(".counter").textContent),()=>{fetchPost("/api/riff/resetRiffCards",{type:a===""?"deck":a.toLowerCase(),deckID:a===""?t:Constants.QUICK_DECK_ID,id:t},()=>{d.element.querySelectorAll(".ariaLabel.b3-list-item__meta").forEach(v=>{v.textContent=dayjs().format("YYYY-MM-DD")})})}),g.stopPropagation(),g.preventDefault();break}else if(y==="card-item"){dt(o,m.getAttribute("data-id")),(p=f.querySelector(".b3-list-item--focus"))==null||p.classList.remove("b3-list-item--focus"),m.classList.add("b3-list-item--focus"),g.stopPropagation(),g.preventDefault();break}else if(y==="remove"){fetchPost("/api/riff/removeRiffCards",{deckID:a===""?t:Constants.QUICK_DECK_ID,blockIDs:[m.getAttribute("data-id")]},v=>{var b;let w=m.parentElement.nextElementSibling;w||(w=m.parentElement.previousElementSibling),!w&&m.parentElement.parentElement.childElementCount>1&&(w=m.parentElement.parentElement.firstElementChild),w?(dt(o,w.getAttribute("data-id")),(b=f.querySelector(".b3-list-item--focus"))==null||b.classList.remove("b3-list-item--focus"),w.classList.add("b3-list-item--focus"),m.parentElement.remove()):(dt(o,""),f.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),d.element.querySelector(".counter").textContent=(parseInt(d.element.querySelector(".counter").textContent)-1).toString(),i&&i(v)}),g.stopPropagation(),g.preventDefault();break}m=m.parentElement}})})},Vn=(e,t,n)=>{let a="",i=!0;const s=t.split("/");return s.splice(0,1),e.forEach(o=>{var l,r,d,c;if(o.type){let u;n===""?u=getNotebookName(o.box)+getDisplayName(Lute.UnEscapeHTMLStr(o.hPath),!1):(u=getDisplayName(Lute.UnEscapeHTMLStr(o.hPath),!1).replace("/"+s.join("/"),""),u.startsWith("/")&&(u=u.substring(1))),a+=`<div data-type="card-item" class="b3-list-item${i?" b3-list-item--focus":""}${isMobile()?"":" b3-list-item--hide-action"}" data-id="${o.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(o.type)}"></use></svg>
${unicode2Emoji(o.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${o.content||Constants.ZWSP}</span>
<span class="${isMobile()||!u?"fn__none ":""}b3-list-item__meta b3-list-item__meta--ellipsis" title="${escapeAttr(u)}">${escapeHtml(u)}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.revisionCount}" class="ariaLabel counter${((l=o.riffCard)==null?void 0:l.reps)===0?" fn__none":""}">${(r=o.riffCard)==null?void 0:r.reps}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.nextDue}" class="ariaLabel b3-list-item__meta${(d=o.riffCard)!=null&&d.due?"":" fn__none"}">${dayjs((c=o.riffCard)==null?void 0:c.due).format("YYYY-MM-DD")}</span>
<span data-position="parentE" data-type="reset" data-id="${o.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.reset}">
    <svg><use xlink:href="#iconUndo"></use></svg>
</span>
<span data-position="parentE" data-type="remove" data-id="${o.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`,i=!1}else a+=`<div data-type="card-item" class="b3-list-item${isMobile()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">${o.content}</span>
<span data-position="parentE" data-type="remove" data-id="${o.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`}),e.length===0&&(a=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),a},dt=(e,t)=>{if(!t){e.protyle.element.classList.add("fn__none"),e.protyle.element.nextElementSibling.classList.remove("fn__none");return}e.protyle.element.classList.remove("fn__none"),e.protyle.element.nextElementSibling.classList.add("fn__none"),e.protyle.scroll.lastScrollTop=0,addLoading(e.protyle),fetchPost("/api/block/getDocInfo",{id:t},n=>{e.protyle.wysiwyg.renderCustom(n.data.ial),fetchPost("/api/filetree/getDoc",{id:t,mode:0,size:Constants.SIZE_GET_MAX},a=>{onGet({updateReadonly:!0,data:a,protyle:e.protyle,action:a.data.rootID===a.data.id?[Constants.CB_GET_HTML]:[Constants.CB_GET_ALL,Constants.CB_GET_HTML]})})})},Pt=e=>`<li data-id="${e.id}" data-name="${escapeAttr(e.name)}" class="b3-list-item b3-list-item--narrow${isMobile()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">
    <span>${escapeHtml(e.name)}</span>
    <span class="b3-list-item__meta">${e.size}</span>
</span>
<span data-type="rename" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.rename}">
    <svg><use xlink:href="#iconEdit"></use></svg>
</span>
<span data-type="delete" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span data-type="view" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
    <svg><use xlink:href="#iconEye"></use></svg>
</span>
<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconMin"></use></svg>
</span>
<span data-type="add" style="display: flex" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.addDeck}">
    <svg><use xlink:href="#iconAdd"></use></svg>
</span>
<span class="b3-list-item__meta${isMobile()?" fn__none":""}">${e.updated}</span>
</li>`,Kd=(e,t)=>{window.siyuan.dialogs.find(n=>{if(n.element.getAttribute("data-key")===Constants.DIALOG_MAKECARD)return hideElements(["dialog"]),!0}),fetchPost("/api/riff/getRiffDecks",{},n=>{let a="";n.data.forEach(s=>{a+=Pt(s)});const i=new Dialog({positionId:Constants.DIALOG_MAKECARD,width:isMobile()?"92vw":"50vw",height:"70vh",title:window.siyuan.languages.riffCard,content:`<div class="b3-dialog__content fn__flex-column" style="box-sizing: border-box;height: 100%">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1">
        <span class="fn__space"></span>
        <span data-type="create" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.createDeck}">
            <svg><use xlink:href="#iconAdd"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-type="viewall" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
            <svg><use xlink:href="#iconEye"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1">${a}</ul>
</div>`});i.element.setAttribute("data-key",Constants.DIALOG_MAKECARD),i.element.addEventListener("click",s=>{let o=s.target;for(;o&&!o.isSameNode(i.element);){const l=o.getAttribute("data-type");if(l==="create"){let r="";const d=i.element.querySelector(".b3-text-field");d.value?(r&&hideMessage(r),fetchPost("/api/riff/createRiffDeck",{name:d.value},c=>{i.element.querySelector(".b3-list").insertAdjacentHTML("afterbegin",Pt(c.data)),d.value=""})):(r=showMessage(window.siyuan.languages._kernel[142]),d.focus()),s.stopPropagation(),s.preventDefault();break}else if(l==="add"){fetchPost("/api/riff/addRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:t},r=>{o.parentElement.outerHTML=Pt(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="remove"){fetchPost("/api/riff/removeRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:t},r=>{o.parentElement.outerHTML=Pt(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="delete"){confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${escapeHtml(o.parentElement.getAttribute("data-name"))}</b>?`,()=>{fetchPost("/api/riff/removeRiffDeck",{deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.remove()})}),s.stopPropagation(),s.preventDefault();break}else if(l==="view"){viewCards(e,o.parentElement.getAttribute("data-id"),o.parentElement.getAttribute("data-name"),"",r=>{o.parentElement.outerHTML=Pt(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="viewall"){viewCards(e,"",window.siyuan.languages.all,""),s.stopPropagation(),s.preventDefault();break}else if(l==="rename"){const r=new Dialog({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),d=r.element.querySelector("input"),c=r.element.querySelectorAll(".b3-button");r.bindInput(d,()=>{c[1].click()}),d.value=o.parentElement.getAttribute("data-name"),d.focus(),d.select(),c[0].addEventListener("click",()=>{r.destroy()}),c[1].addEventListener("click",()=>{fetchPost("/api/riff/renameRiffDeck",{name:d.value,deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.querySelector(".b3-list-item__text span").textContent=d.value,o.parentElement.setAttribute("data-name",d.value)}),r.destroy()}),s.stopPropagation(),s.preventDefault();break}o=o.parentElement}})})},Zd=(e,t)=>{let n=!0;const a=[];t.forEach(i=>{i.getAttribute("data-type")!=="NodeThematicBreak"&&(i.classList.remove("protyle-wysiwyg--select"),a.push(i.getAttribute("data-node-id")),(i.getAttribute(Constants.CUSTOM_RIFF_DECKS)||"").indexOf(Constants.QUICK_DECK_ID)===-1&&(n=!1))}),n?transaction(e,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:a}]):transaction(e,[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:a}])},Xd=e=>{window.siyuan.menus.menu.append(new MenuItem({id:"transferBlockRef",label:window.siyuan.languages.transferBlockRef,icon:"iconScrollHoriz",click(){const t=new Dialog({title:window.siyuan.languages.transferBlockRef,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.targetBlockID}">
    <div class="b3-label__text">${window.siyuan.languages.transferBlockRefTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});t.element.setAttribute("data-key",Constants.DIALOG_TRANSFERBLOCKREF);const n=t.element.querySelector("input"),a=t.element.querySelectorAll(".b3-button");t.bindInput(n,()=>{a[1].click()}),n.focus(),a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{fetchPost("/api/block/transferBlockRef",{fromID:e,toID:n.value}),t.destroy()})}}).element)};class Jd{constructor(t=""){this.eventTarget=document.appendChild(document.createComment(t))}on(t,n){t==="loaded-protyle"&&console.warn("0.8.8 \u5C06\u79FB\u9664 loaded-protyle, \u8BF7\u4F7F\u7528 loaded-protyle-static \u8FDB\u884C\u66FF\u4EE3"),this.eventTarget.addEventListener(t,n)}once(t,n){this.eventTarget.addEventListener(t,n,{once:!0})}off(t,n){this.eventTarget.removeEventListener(t,n)}emit(t,n){return this.eventTarget.dispatchEvent(new CustomEvent(t,{detail:n,cancelable:!0}))}}const so=e=>{const t=new vi;e.detail.menu=t,e.plugins.forEach(n=>{n.eventBus.emit(e.type,e.detail)}),t.menus.length>0&&(e.separatorPosition==="top"&&window.siyuan.menus.menu.append(new Ee({id:"separator_pluginTop",type:"separator"}).element),window.siyuan.menus.menu.append(new Ee({id:"plugin",label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:t.menus}).element),e.separatorPosition==="bottom"&&window.siyuan.menus.menu.append(new Ee({id:"separator_pluginBottom",type:"separator"}).element))},Gn=(e,t,n,a=!0,i)=>{fetchPost("/api/av/searchAttributeView",{keyword:t,excludes:a&&n?[n]:void 0},s=>{let o="";s.data.results.forEach((l,r)=>{o+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-av-id="${l.avID}" data-block-id="${l.blockID}">
    <div class="b3-list-item--two fn__flex-1">
        <div class="b3-list-item__first">
            <span class="b3-list-item__text">${escapeHtml(l.avName||window.siyuan.languages.title)}</span>
        </div>
        <div class="b3-list-item__meta b3-list-item__showall">${escapeGreat(l.hPath)}</div>
    </div>
    <svg aria-label="${window.siyuan.languages.thisDatabase}" style="margin: 0 0 0 4px" class="b3-list-item__hinticon ariaLabel${l.avID===n?"":" fn__none"}"><use xlink:href="#iconInfo"></use></svg>
</div>`}),e.innerHTML=o,i&&i()})},za=(e,t,n)=>{t.dataset.avId=n.dataset.avId,t.dataset.blockId=n.dataset.blockId,t.querySelector(".b3-menu__accelerator").textContent=n.querySelector(".b3-list-item__hinticon").classList.contains("fn__none")?n.querySelector(".b3-list-item__text").textContent:window.siyuan.languages.thisDatabase;const a=hasClosestByClassName(t,"b3-menu__items");a&&io(a,e,!0)},Qd=(e,t,n,a=!0)=>{window.siyuan.menus.menu.remove();const i=new Menu;i.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(o){const l=o.querySelector(".b3-list"),r=o.querySelector("input");r.addEventListener("keydown",d=>{if(d.isComposing)return;if(upDownHint(l,d)&&d.stopPropagation(),d.key==="Enter"){d.preventDefault(),d.stopPropagation();const u=l.querySelector(".b3-list-item--focus");n?n(u):za(e,t,u),window.siyuan.menus.menu.remove()}}),r.addEventListener("input",d=>{d.stopPropagation(),!d.isComposing&&Gn(l,r.value,e,a)}),r.addEventListener("compositionend",()=>{Gn(l,r.value,e,a)}),o.lastElementChild.addEventListener("click",d=>{const c=hasClosestByClassName(d.target,"b3-list-item");c&&(d.stopPropagation(),n?n(c):za(e,t,c),window.siyuan.menus.menu.remove())}),Gn(l,"",e,a,()=>{const d=t.getBoundingClientRect();i.open({x:d.left,y:d.bottom,h:d.height}),o.querySelector("input").focus()})}}),i.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial");const s=hasTopClosestByClassName(t,"block__popover",!0);i.element.setAttribute("data-from",s?s.dataset.level+"popover":"app")},ec=e=>{const t=e.avElement.querySelector('input[data-type="colName"]'),a=e.avElement.querySelector('.b3-menu__item[data-type="goSearchAV"]').getAttribute("data-av-id"),i=e.avElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let s;e.colsData.find(l=>{if(l.id===i)return l.relation||(l.relation={}),s=l,!0});const o=e.avElement.querySelector('[data-type="name"]').value;transaction(e.protyle,[{action:"updateAttrViewColRelation",avID:e.avID,keyID:i,id:a||s.relation.avID,backRelationKeyID:s.relation.avID===a&&s.relation.backKeyID||Lute.NewNodeID(),isTwoWay:e.avElement.querySelector(".b3-switch").checked,name:t.value,format:o}],[{action:"updateAttrViewColRelation",avID:e.avID,keyID:i,id:s.relation.avID||a,backRelationKeyID:s.relation.backKeyID,isTwoWay:s.relation.isTwoWay,name:t.dataset.oldValue,format:s.name}]),e.avElement.remove(),updateAttrViewCellAnimation(e.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{name:o}),focusBlock(e.blockElement)},io=(e,t,n=!1)=>{const a=e.querySelector('.b3-menu__item[data-type="goSearchAV"]'),i=a.nextElementSibling,s=i.querySelector(".b3-switch"),o=i.nextElementSibling,l=o.nextElementSibling,r=JSON.parse(a.dataset.oldValue);if(r.avID){const d=o.querySelector("input");n&&(a.dataset.avId!==r.avID?(d.value="",s.checked=!1):(d.value=d.dataset.oldValue,s.checked=r.isTwoWay)),s.checked?o.classList.remove("fn__none"):o.classList.add("fn__none"),a.dataset.avId&&r.avID!==a.dataset.avId||r.isTwoWay!==s.checked||d.dataset.oldValue!==d.value?l.classList.remove("fn__none"):l.classList.add("fn__none")}else a.dataset.avId&&(s.checked?o.classList.remove("fn__none"):o.classList.add("fn__none"),l.classList.remove("fn__none"))},qe=(e,t,n,a)=>{if(e==="selected")return`<svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
<span class="b3-menu__label${n?"":" popover__block"}" ${n?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${t}">${a}</span>
<svg class="b3-menu__action"><use xlink:href="#iconMin"></use></svg>`;if(e==="empty")return`<button class="b3-menu__item">
    <span class="b3-menu__label">${window.siyuan.languages.emptyContent}</span>
</button>`;if(e=="unselect")return`<button data-id="${t}" class="b3-menu__item" data-type="setRelationCell">
    <span class="b3-menu__label${n?"":" popover__block"}" ${n?"":'style="color:var(--b3-protyle-inline-blockref-color)"'} data-id="${t}">${a}</span>
    <svg class="b3-menu__action"><use xlink:href="#iconAdd"></use></svg>
</button>`},Ka=(e,t,n)=>{fetchPost("/api/av/getAttributeViewPrimaryKeyValues",{id:e.firstElementChild.getAttribute("data-av-id"),keyword:n},a=>{const i=a.data.rows.values||[];let s="",o="";const l=[];t.querySelectorAll("span").forEach(r=>{l.push(r.dataset.id),o+=`<button data-id="${r.dataset.id}" data-type="setRelationCell" class="b3-menu__item${r.textContent.indexOf(n)>-1?"":" fn__none"}" draggable="true">${qe("selected",r.dataset.id,!r.classList.contains("av__celltext--ref"),r.textContent||window.siyuan.languages.untitled)}</button>`}),i.forEach(r=>{l.includes(r.block.id)||(s+=qe("unselect",r.block.id,r.isDetached,r.block.content||window.siyuan.languages.untitled))}),e.querySelector(".b3-menu__items").innerHTML=`${o||qe("empty")}
<button class="b3-menu__separator"></button>
${s||qe("empty")}`,e.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current")})},tc=e=>{fetchPost("/api/av/getAttributeViewPrimaryKeyValues",{id:e.menuElement.firstElementChild.getAttribute("data-av-id"),keyword:""},t=>{const n=t.data.rows.values||[];let a="",i="";const s=[];e.cellElements[0].querySelectorAll("span").forEach(c=>{s.push(c.dataset.id),i+=`<button data-id="${c.dataset.id}" data-type="setRelationCell" class="b3-menu__item" draggable="true">${qe("selected",c.dataset.id,!c.classList.contains("av__celltext--ref"),c.textContent||window.siyuan.languages.untitled)}</button>`}),n.forEach(c=>{s.includes(c.block.id)||(a+=qe("unselect",c.block.id,c.isDetached,c.block.content||window.siyuan.languages.untitled))}),e.menuElement.querySelector(".b3-menu__items").innerHTML=`${i||qe("empty")}
<button class="b3-menu__separator"></button>
${a||qe("empty")}`;const o=e.cellElements[e.cellElements.length-1].getBoundingClientRect();setPosition(e.menuElement,o.left,o.bottom,o.height),e.menuElement.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current");const l=e.menuElement.querySelector("input");l.focus();const r=l.parentElement.querySelector(".popover__block");r.innerHTML=t.data.name,r.setAttribute("data-id",t.data.blockIDs[0]);const d=e.menuElement.querySelector(".b3-menu__items");l.addEventListener("keydown",c=>{if(c.isComposing)return;upDownHint(d,c,"b3-menu__item--current");const u=e.menuElement.querySelector(".b3-menu__item--current");c.key==="Enter"&&u&&u.getAttribute("data-type")==="setRelationCell"?(oo(e.protyle,e.blockElement,u,e.cellElements),c.preventDefault(),c.stopPropagation()):c.key==="Escape"&&(e.menuElement.parentElement.remove(),c.preventDefault(),c.stopPropagation())}),l.addEventListener("input",c=>{c.isComposing||(Ka(e.menuElement,e.cellElements[0],l.value),c.stopPropagation())}),l.addEventListener("compositionend",c=>{c.stopPropagation(),Ka(e.menuElement,e.cellElements[0],l.value)})})},nc=(e,t)=>{let n;return e.view.columns.find(a=>{if(a.id===t[0].dataset.colId)return n=a.relation,!0}),n&&n.avID?`<div data-av-id="${n.avID}" class="fn__flex-column">
<div class="b3-menu__item" data-type="nobg">
    <input class="b3-text-field fn__flex-1"/>
    <span class="fn__space"></span>
    <span style="color: var(--b3-protyle-inline-blockref-color);" data-id="" class="popover__block fn__pointer"></span>
</div>
<div class="fn__hr"></div>
<div class="b3-menu__items">
    <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
</div>`:""},oo=(e,t,n,a)=>{var i;const s=hasClosestByClassName(n,"b3-menu__items");if(!s||s.querySelector(".dragover__bottom, .dragover__top"))return;const o=hasClosestByClassName(a[0],"av__row");if(!o)return;t.contains(a[0])||(a[0]=t.querySelector(`.av__row[data-id="${o.dataset.id}"] .av__cell[data-col-id="${a[0].dataset.colId}"]`)||t.querySelector(`.fn__flex-1[data-col-id="${a[0].dataset.colId}"]`));const l={blockIDs:[],contents:[]};if(s.querySelectorAll('[draggable="true"]').forEach(r=>{const d=r.getAttribute("data-id");l.blockIDs.push(d),l.contents.push({type:"block",block:{id:d,content:r.querySelector(".b3-menu__label").textContent},isDetached:!r.querySelector(".popover__block")})}),n.classList.contains("b3-menu__item")){const r=n.getAttribute("data-id"),d=s.querySelector(".b3-menu__separator");if(n.getAttribute("draggable")){d.nextElementSibling.getAttribute("data-id")||d.nextElementSibling.remove();const c=l.blockIDs.indexOf(r);l.blockIDs.splice(c,1),l.contents.splice(c,1),d.after(n),n.outerHTML=qe("unselect",r,!n.querySelector(".popover__block"),n.querySelector(".b3-menu__label").textContent),d.previousElementSibling||d.insertAdjacentHTML("beforebegin",qe("empty"))}else d.previousElementSibling.getAttribute("data-id")||d.previousElementSibling.remove(),l.blockIDs.push(r),l.contents.push({type:"block",block:{id:r,content:n.firstElementChild.textContent},isDetached:!n.firstElementChild.getAttribute("style")}),d.before(n),n.outerHTML=`<button data-id="${r}" data-type="setRelationCell" class="b3-menu__item" draggable="true">${qe("selected",r,!n.querySelector(".popover__block"),n.querySelector(".b3-menu__label").textContent)}</button>`,d.nextElementSibling||d.insertAdjacentHTML("afterend",qe("empty"));(i=s.querySelector(".b3-menu__item--current"))==null||i.classList.remove("b3-menu__item--current"),s.querySelector(".b3-menu__items .b3-menu__item:not(.fn__none)").classList.add("b3-menu__item--current")}updateCellsValue(e,t,l,a)},ac=e=>{const t=[];e.forEach(n=>{const a=n.getAttribute("data-node-id");a&&t.push({id:a,isDetached:!1})}),t.length>0&&openSearchAV("",e[0],n=>{const a=n.dataset.avId;transaction(void 0,[{action:"insertAttrViewBlock",avID:a,ignoreFillFilter:!0,srcs:t,blockID:n.dataset.blockId},{action:"doUpdateUpdated",id:n.dataset.blockId,data:dayjs().format("YYYYMMDDHHmmss")}])})},sc=(e,t,n)=>{var a,i;if((i=(a=e.title)==null?void 0:a.editElement)!=null&&i.contains(t.startContainer)||n==="title")openSearchAV("",e.breadcrumb.element,s=>{const o=s.dataset.avId;transaction(e,[{action:"insertAttrViewBlock",avID:o,ignoreFillFilter:!0,srcs:[{id:e.block.rootID,isDetached:!1}],blockID:s.dataset.blockId},{action:"doUpdateUpdated",id:s.dataset.blockId,data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:[e.block.rootID],avID:o}]),focusByRange(t)});else{let s;const o=[];if(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(l=>{s||(s=l),o.push(l.getAttribute("data-node-id"))}),!s){const l=hasClosestBlock(t.startContainer);l&&(s=l,o.push(l.getAttribute("data-node-id")))}s||(s=e.wysiwyg.element,o.push(e.block.rootID)),openSearchAV("",s,l=>{const r=[],d=[];o.forEach(u=>{r.push(u),d.push({id:u,isDetached:!1})});const c=l.dataset.avId;transaction(e,[{action:"insertAttrViewBlock",avID:c,ignoreFillFilter:!0,srcs:d,blockID:l.dataset.blockId},{action:"doUpdateUpdated",id:l.dataset.blockId,data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:r,avID:c}]),focusByRange(t)})}};class ic{constructor(t){isMac()?this.gutterTip=window.siyuan.languages.gutterTip:this.gutterTip=window.siyuan.languages.gutterTip.replace("\u2325\u2192",updateHotkeyTip(window.siyuan.config.keymap.general.enter.custom)).replace("\u2318\u2191",updateHotkeyTip(window.siyuan.config.keymap.editor.general.collapse.custom)).replace("\u2325\u2318A",updateHotkeyTip(window.siyuan.config.keymap.editor.general.attr.custom)).replace(/⌘/g,"Ctrl+").replace(/⌥/g,"Alt+").replace(/⇧/g,"Shift+").replace(/⌃/g,"Ctrl+"),this.element=document.createElement("div"),this.element.className="protyle-gutters",this.element.addEventListener("dragstart",n=>{hideTooltip(),window.siyuan.menus.menu.remove();const a=n.target.parentElement;let i=[],s=[],o;if(a.dataset.rowId)o=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"]`)).find(r=>{if(!isInEmbedBlock(r))return!0}),o.querySelector(`.av__row[data-id="${a.dataset.rowId}"]`).classList.add("av__row--select"),o.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(r=>{i.push(r.getAttribute("data-id")),s.push(r)});else{const r=a.getAttribute("data-node-id");s=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let d=!1;if(s.forEach(c=>{const u=c.getAttribute("data-node-id");u===r&&(d=!0),i.push(u)}),!d){const c=t.wysiwyg.element.querySelector(`[data-node-id="${r}"]`);c&&(s.forEach(u=>{u.classList.remove("protyle-wysiwyg--select")}),c.classList.add("protyle-wysiwyg--select"),s=[c],i=[r])}}const l=document.createElement("div");l.className=t.wysiwyg.element.className,s.forEach(r=>{const d=r.getAttribute("data-type");if(r.querySelector("iframe")){const c=genEmptyElement();c.classList.add("protyle-wysiwyg--select"),getContenteditableElement(c).innerHTML=`<svg class="svg"><use xlink:href="${a.querySelector("use").getAttribute("xlink:href")}"></use></svg> ${getLangByType(d)}`,l.append(c)}else l.append(processClonePHElement(r.cloneNode(!0)))}),l.setAttribute("style",`position:fixed;opacity:.1;width:${s[0].clientWidth}px;padding:0;`),document.body.append(l),n.dataTransfer.setDragImage(l,0,0),setTimeout(()=>{l.remove()}),a.style.opacity="0.1",window.siyuan.dragElement=o||t.wysiwyg.element,n.dataTransfer.setData(`${Constants.SIYUAN_DROP_GUTTER}${a.getAttribute("data-type")}${Constants.ZWSP}${a.getAttribute("data-subtype")}${Constants.ZWSP}${i}`,t.wysiwyg.element.innerHTML)}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll("button").forEach(n=>{n.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("click",n=>{const a=hasClosestByTag(n.target,"BUTTON");if(!a)return;n.preventDefault(),n.stopPropagation(),hideTooltip();const i=a.getAttribute("data-node-id");if(!i){if(a.getAttribute("disabled"))return;a.setAttribute("disabled","disabled");let o;if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${(a.previousElementSibling||a.nextElementSibling).getAttribute("data-node-id")}"]`)).find(l=>{if(!isInEmbedBlock(l)&&this.isMatchNode(l))return o=l,!0}),!o)return;if(n.altKey){let l=!0;Array.from(o.children).find(c=>{if(c.classList.contains("list")&&Array.from(c.children).find(f=>{if(f.classList.contains("li")&&f.getAttribute("fold")!=="1"&&f.childElementCount>3)return l=!1,!0}))return!0});const r=[],d=[];Array.from(o.children).forEach(c=>{c.classList.contains("list")&&Array.from(c.children).forEach(u=>{if(u.classList.contains("li")){l?u.removeAttribute("fold"):u.childElementCount>3&&u.setAttribute("fold","1");const f=u.getAttribute("data-node-id");r.push({action:"setAttrs",id:f,data:JSON.stringify({fold:l?"":"1"})}),d.push({action:"setAttrs",id:f,data:JSON.stringify({fold:l?"1":""})})}})}),transaction(t,r,d),a.removeAttribute("disabled")}else{const l=setFold(t,o);l===1?a.firstElementChild.style.transform="":l===0&&(a.firstElementChild.style.transform="rotate(90deg)")}hideElements(["select"],t),window.siyuan.menus.menu.remove();return}const s=a.getBoundingClientRect();if(a.dataset.type==="NodeAttributeViewRowMenu"||a.dataset.type==="NodeAttributeViewRow"){const o=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"] .av__row[data-id="${a.dataset.rowId}"]`)).find(r=>{if(!isInEmbedBlock(r))return!0});if(!o)return;const l=hasClosestBlock(o);if(!l)return;if(a.dataset.type==="NodeAttributeViewRow"){l.querySelectorAll(".av__cell--select, .av__cell--active").forEach(f=>{var g;f.classList.remove("av__cell--select","av__cell--active"),(g=f.querySelector(".av__drag-fill"))==null||g.remove()});const r=l.getAttribute("data-av-id"),d=[Lute.NewNodeID()],c=n.altKey?o.previousElementSibling.getAttribute("data-id")||"":a.dataset.rowId,u=dayjs().format("YYYYMMDDHHmmss");transaction(t,[{action:"insertAttrViewBlock",avID:r,previousID:c,srcs:[{id:d[0],isDetached:!0,content:""}],blockID:i},{action:"doUpdateUpdated",id:i,data:u}],[{action:"removeAttrViewBlock",srcIDs:d,avID:r},{action:"doUpdateUpdated",id:i,data:l.getAttribute("updated")}]),insertAttrViewBlockAnimation(t,l,d,c,r),n.altKey&&this.element.querySelectorAll("button").forEach(f=>{f.dataset.rowId=d[0]}),l.setAttribute("updated",u)}else avContextmenu(t,o,{x:s.left,y:s.bottom,w:s.width,h:s.height,isLeft:!0});return}if(isOnlyMeta(n))zoomOut({protyle:t,id:i});else if(n.altKey){let o;if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(l=>{if(!isInEmbedBlock(l)&&this.isMatchNode(l))return o=l,!0}),!o)return;if(a.getAttribute("data-type")==="NodeListItem"&&o.parentElement.getAttribute("data-node-id")){let l=!0;Array.from(o.parentElement.children).find(c=>{if(c.classList.contains("li")&&c.getAttribute("fold")!=="1"&&c.childElementCount>3)return l=!1,!0});const r=[],d=[];Array.from(o.parentElement.children).find(c=>{if(c.classList.contains("li")){l?c.removeAttribute("fold"):c.childElementCount>3&&c.setAttribute("fold","1");const u=c.getAttribute("data-node-id");r.push({action:"setAttrs",id:u,data:JSON.stringify({fold:l?"":"1"})}),d.push({action:"setAttrs",id:u,data:JSON.stringify({fold:l?"1":""})})}}),transaction(t,r,d)}else setFold(t,o);o.classList.remove("protyle-wysiwyg--hl")}else if(window.siyuan.shiftIsPressed&&!t.disabled)openAttr(t.wysiwyg.element.querySelector(`[data-node-id="${i}"]`),"bookmark",t);else if(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed)if(this.renderMenu(t,a),t.toolbar.range||(t.toolbar.range=getEditorRange(t.wysiwyg.element.firstElementChild)),isMobile())window.siyuan.menus.menu.fullscreen();else{window.siyuan.menus.menu.popup({x:s.left,y:s.bottom,isLeft:!0});const o=hasTopClosestByClassName(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",o?o.dataset.level+"popover":"app"),focusByRange(t.toolbar.range)}}),this.element.addEventListener("contextmenu",n=>{const a=hasClosestByTag(n.target,"BUTTON");if(!(!a||a.getAttribute("data-type")==="fold")){if(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed){hideTooltip();const i=a.getBoundingClientRect();if(a.dataset.type==="NodeAttributeViewRowMenu"){const s=Array.from(t.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"] .av__row[data-id="${a.dataset.rowId}"]`)).find(o=>{if(!isInEmbedBlock(o))return!0});s&&avContextmenu(t,s,{x:i.left,y:i.bottom,w:i.width,h:i.height,isLeft:!0})}else if(a.dataset.type!=="NodeAttributeViewRow"){this.renderMenu(t,a),window.siyuan.menus.menu.popup({x:i.left,y:i.bottom,isLeft:!0});const s=hasTopClosestByClassName(t.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",s?s.dataset.level+"popover":"app")}}n.preventDefault(),n.stopPropagation()}}),this.element.addEventListener("mouseover",n=>{const a=hasClosestByTag(n.target,"BUTTON");if(!a)return;const i=a.getAttribute("data-type");if(i==="fold"||i==="NodeAttributeViewRow"){Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(s=>{s.classList.remove("protyle-wysiwyg--hl","av__row--hl")});return}Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${a.getAttribute("data-node-id")}"]`)).find(s=>{if(!isInEmbedBlock(s)&&this.isMatchNode(s)){const o=s.querySelector(`.av__row[data-id="${a.dataset.rowId}"]`);return Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, av__row--hl")).forEach(l=>{s.isSameNode(l)||l.classList.remove("protyle-wysiwyg--hl"),o&&!o.isSameNode(l)&&o.classList.remove("av__row--hl")}),i==="NodeAttributeViewRowMenu"?o.classList.add("av__row--hl"):s.classList.add("protyle-wysiwyg--hl"),!0}}),n.preventDefault()}),this.element.addEventListener("mouseleave",n=>{Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(a=>{a.classList.remove("protyle-wysiwyg--hl","av__row--hl")}),n.preventDefault(),n.stopPropagation()}),this.element.addEventListener("mousewheel",n=>{hideElements(["gutter"],t),n.stopPropagation(),n.preventDefault()})}isMatchNode(t){const n=t.getBoundingClientRect();let a=this.element.getBoundingClientRect().top+6;return n.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&(a=a-(n.height-this.element.clientHeight)/2),n.top<=a&&n.bottom>=a}turnsOneInto(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){turnsOneInto(t)}}}turnsIntoOne(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){turnsIntoOneTransaction(t)}}}turnsInto(t){return{id:t.menuId,icon:t.icon,label:t.label,accelerator:t.accelerator,click(){turnsIntoTransaction(t)}}}showMobileAppearance(t){const n=document.getElementById("keyboardToolbar"),a=n.querySelectorAll("#keyboardToolbar .keyboard__dynamic");a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),n.querySelector('.keyboard__action[data-type="text"]').classList.add("protyle-toolbar__item--current"),n.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound"),n.classList.remove("fn__none");const i=t.contentElement.scrollTop+333.5;renderTextMenu(t,n),showKeyboardToolbarUtil(i)}renderMultipleMenu(t,n){var a;let i=!1,s=!1,o=!1;if(n.find((u,f)=>{if(u.classList.contains("li"))return i=!0,!0;if((u.classList.contains("sb")||u.classList.contains("p"))&&(o=!0),u.nextElementSibling&&n[f+1]&&u.nextElementSibling.isSameNode(n[f+1]))s=!0;else if(f!==n.length-1)return s=!1,!0}),!i&&!t.disabled){const u=[];s&&(u.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,protyle:t,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,selectsElement:n,type:"Blocks2ULs"})),u.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,selectsElement:n,type:"Blocks2OLs"})),u.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,selectsElement:n,type:"Blocks2TLs"})),u.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:n,type:"Blocks2Blockquote"}))),o||u.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,selectsElement:n,type:"Blocks2Ps",isContinue:s})),u.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:n,level:1,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:n,level:2,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:n,level:3,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:n,level:4,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:n,level:5,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:n,level:6,type:"Blocks2Hs",isContinue:s})),window.siyuan.menus.menu.append(new MenuItem({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:u}).element),s&&window.siyuan.menus.menu.append(new MenuItem({id:"mergeSuperBlock",icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({menuId:"hLayout",label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:t,selectsElement:n,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({menuId:"vLayout",label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:t,selectsElement:n,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}t.disabled||window.siyuan.menus.menu.append(new MenuItem({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){AIActions(n,t)}}).element);const l=[{id:"copy",iconHTML:"",label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){isNotEditBlock(n[0])?focusBlock(n[0]):focusByRange(getEditorRange(n[0])),document.execCommand("copy")}},{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let u="";n.forEach(f=>{u+=getPlainText(f)+`
`}),copyPlainText(u.trimEnd()),focusBlock(n[0])}},{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:t.disabled,click(){duplicateBlock(n,t)}}],r=this.genCopyTextRef(n);if(r&&l.splice(2,0,r),window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:l}).element),t.disabled)return;window.siyuan.menus.menu.append(new MenuItem({id:"cut",label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{focusBlock(n[0]),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"move",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{movePathTo(u=>{hintMoveBlock(u[0],n,t)})}}).element);const d=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{addEditorToDatabase(t,d)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var u;(u=t.breadcrumb)==null||u.hide(),removeBlock(t,n[0],getEditorRange(n[0]),"Backspace")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_appearance",type:"separator"}).element);const c=new MenuItem({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(t)}}).element;return window.siyuan.menus.menu.append(c),isMobile()||c.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(n,t),this.genWidths(n,t),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new MenuItem({id:"separator_quickMakeCard",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"quickMakeCard",label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){quickMakeCard(t,n)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"addToDeck",label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",ignore:!window.siyuan.config.flashcard.deck,click(){const u=[];n.forEach(f=>{f.getAttribute("data-type")!=="NodeThematicBreak"&&u.push(f.getAttribute("data-node-id"))}),makeCard(t.app,u)}}).element)),(a=t==null?void 0:t.app)!=null&&a.plugins&&emitOpenMenu({plugins:t.app.plugins,type:"click-blockicon",detail:{protyle:t,blockElements:n},separatorPosition:"top"}),window.siyuan.menus.menu}renderMenu(t,n){var a,i;if(!n)return;hideElements(["util","toolbar","hint"],t),window.siyuan.menus.menu.remove(),isMobile()&&activeBlur();const s=n.getAttribute("data-node-id"),o=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(o.length>1&&Array.from(o).find(m=>{if(s===m.getAttribute("data-node-id"))return!0}))return this.renderMultipleMenu(t,Array.from(o));let l;if(n.tagName==="BUTTON"?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s}"]`)).find(p=>{if(!isInEmbedBlock(p)&&this.isMatchNode(p))return l=p,!0}):l=n,!l)return;const r=l.getAttribute("data-type"),d=l.getAttribute("data-subtype"),c=[];hideElements(["select"],t),l.classList.add("protyle-wysiwyg--select"),countBlockWord([s],t.block.rootID),r==="NodeParagraph"&&!t.disabled?(c.push(this.turnsIntoOne({menuId:"list",icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,selectsElement:[l],type:"Blocks2ULs"})),c.push(this.turnsIntoOne({menuId:"orderedList",icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,selectsElement:[l],type:"Blocks2OLs"})),c.push(this.turnsIntoOne({menuId:"check",icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,selectsElement:[l],type:"Blocks2TLs"})),c.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[l],type:"Blocks2Blockquote"})),c.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:[l],level:1,type:"Blocks2Hs"})),c.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:[l],level:2,type:"Blocks2Hs"})),c.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:[l],level:3,type:"Blocks2Hs"})),c.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:[l],level:4,type:"Blocks2Hs"})),c.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:[l],level:5,type:"Blocks2Hs"})),c.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:[l],level:6,type:"Blocks2Hs"}))):r==="NodeHeading"&&!t.disabled?(c.push(this.turnsInto({menuId:"paragraph",icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,selectsElement:[l],type:"Blocks2Ps"})),c.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[l],type:"Blocks2Blockquote"})),d!=="h1"&&c.push(this.turnsInto({menuId:"heading1",icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:t,selectsElement:[l],level:1,type:"Blocks2Hs"})),d!=="h2"&&c.push(this.turnsInto({menuId:"heading2",icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:t,selectsElement:[l],level:2,type:"Blocks2Hs"})),d!=="h3"&&c.push(this.turnsInto({menuId:"heading3",icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:t,selectsElement:[l],level:3,type:"Blocks2Hs"})),d!=="h4"&&c.push(this.turnsInto({menuId:"heading4",icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:t,selectsElement:[l],level:4,type:"Blocks2Hs"})),d!=="h5"&&c.push(this.turnsInto({menuId:"heading5",icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:t,selectsElement:[l],level:5,type:"Blocks2Hs"})),d!=="h6"&&c.push(this.turnsInto({menuId:"heading6",icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:t,selectsElement:[l],level:6,type:"Blocks2Hs"}))):r==="NodeList"&&!t.disabled?(c.push(this.turnsOneInto({menuId:"paragraph",id:s,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,nodeElement:l,type:"CancelList"})),c.push(this.turnsIntoOne({menuId:"quote",icon:"iconQuote",label:window.siyuan.languages.quote,accelerator:window.siyuan.config.keymap.editor.insert.quote.custom,protyle:t,selectsElement:[l],type:"Blocks2Blockquote"})),l.getAttribute("data-subtype")==="o"?(c.push(this.turnsOneInto({menuId:"list",id:s,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,nodeElement:l,type:"OL2UL"})),c.push(this.turnsOneInto({menuId:"check",id:s,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,nodeElement:l,type:"UL2TL"}))):l.getAttribute("data-subtype")==="t"?(c.push(this.turnsOneInto({menuId:"list",id:s,icon:"iconList",label:window.siyuan.languages.list,accelerator:window.siyuan.config.keymap.editor.insert.list.custom,protyle:t,nodeElement:l,type:"TL2UL"})),c.push(this.turnsOneInto({menuId:"orderedList",id:s,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,nodeElement:l,type:"TL2OL"}))):(c.push(this.turnsOneInto({menuId:"orderedList",id:s,icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],accelerator:window.siyuan.config.keymap.editor.insert["ordered-list"].custom,protyle:t,nodeElement:l,type:"UL2OL"})),c.push(this.turnsOneInto({menuId:"check",id:s,icon:"iconCheck",label:window.siyuan.languages.check,accelerator:window.siyuan.config.keymap.editor.insert.check.custom,protyle:t,nodeElement:l,type:"OL2TL"})))):r==="NodeBlockquote"&&!t.disabled&&c.push(this.turnsOneInto({menuId:"paragraph",id:s,icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:t,nodeElement:l,type:"CancelBlockquote"})),c.length>0&&!t.disabled&&window.siyuan.menus.menu.append(new MenuItem({id:"turnInto",icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:c}).element),!t.disabled&&!l.classList.contains("hr")&&window.siyuan.menus.menu.append(new MenuItem({id:"ai",icon:"iconSparkles",label:window.siyuan.languages.ai,accelerator:window.siyuan.config.keymap.editor.general.ai.custom,click(){AIActions([l],t)}}).element);const u=copySubMenu(s,!0,l).concat([{id:"copyPlainText",iconHTML:"",label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){copyPlainText(getPlainText(l).trimEnd()),focusBlock(l)}},{id:r==="NodeAttributeView"?"copyMirror":"copy",iconHTML:"",label:r==="NodeAttributeView"?window.siyuan.languages.copyMirror:window.siyuan.languages.copy,accelerator:"\u2318C",click(){isNotEditBlock(l)?focusBlock(l):focusByRange(getEditorRange(l)),document.execCommand("copy")}},{id:r==="NodeAttributeView"?"duplicateMirror":"duplicate",iconHTML:"",label:r==="NodeAttributeView"?window.siyuan.languages.duplicateMirror:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:t.disabled,click(){duplicateBlock([l],t)}}]);r==="NodeAttributeView"&&u.push({id:"duplicateCompletely",iconHTML:"",label:window.siyuan.languages.duplicateCompletely,accelerator:window.siyuan.config.keymap.editor.general.duplicateCompletely.custom,disabled:t.disabled,click(){duplicateCompletely(t,l)}});const f=this.genCopyTextRef([l]);if(f&&u.splice(7,0,f),window.siyuan.menus.menu.append(new MenuItem({id:"copy",icon:"iconCopy",label:window.siyuan.languages.copy,type:"submenu",submenu:u}).element),!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"cut",icon:"iconCut",label:window.siyuan.languages.cut,accelerator:"\u2318X",click:()=>{focusBlock(l),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"move",icon:"iconMove",label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,click:()=>{movePathTo(m=>{hintMoveBlock(m[0],[l],t)})}}).element);const p=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",icon:"iconDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,click:()=>{addEditorToDatabase(t,p)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u232B",click:()=>{var m;(m=t.breadcrumb)==null||m.hide(),removeBlock(t,l,getEditorRange(l),"Backspace")}}).element)}if(r==="NodeSuperBlock"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({id:"separator_cancelSuperBlock",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"cancelSuperBlock",label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,click(){const p=cancelSB(t,l);transaction(t,p.doOperations,p.undoOperations),focusBlock(t.wysiwyg.element.querySelector(`[data-node-id="${p.previousId}"]`)),hideElements(["gutter"],t)}}).element);else if(r==="NodeCodeBlock"&&!t.disabled&&!l.getAttribute("data-subtype")){window.siyuan.menus.menu.append(new MenuItem({id:"separator_code",type:"separator"}).element);const p=l.getAttribute("linewrap"),m=l.getAttribute("ligatures"),y=l.getAttribute("linenumber");window.siyuan.menus.menu.append(new MenuItem({id:"code",type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{id:"md31",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${p==="true"||window.siyuan.config.editor.codeLineWrap&&p!=="false"?" checked":""}></div>`,bind(v){v.addEventListener("click",b=>{const w=v.querySelector("input");b.target.tagName!=="INPUT"&&(w.checked=!w.checked),l.setAttribute("linewrap",w.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),highlightRender(l),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{linewrap:w.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md2",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${m==="true"||window.siyuan.config.editor.codeLigatures&&m!=="false"?" checked":""}></div>`,bind(v){v.addEventListener("click",b=>{const w=v.querySelector("input");b.target.tagName!=="INPUT"&&(w.checked=!w.checked),l.setAttribute("ligatures",w.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),highlightRender(l),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{ligatures:w.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{id:"md27",iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${y==="true"||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&y!=="false"?" checked":""}></div>`,bind(v){v.addEventListener("click",b=>{const w=v.querySelector("input");b.target.tagName!=="INPUT"&&(w.checked=!w.checked),l.setAttribute("linenumber",w.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),highlightRender(l),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{linenumber:w.checked.toString()}}),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeCodeBlock"&&!t.disabled&&["echarts","mindmap"].includes(l.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new MenuItem({id:"separator_chart",type:"separator"}).element);const p=l.style.height;let m=l.outerHTML;window.siyuan.menus.menu.append(new MenuItem({id:"chart",label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{id:"height",label:`${window.siyuan.languages.height}<span class="fn__space"></span>
<input style="margin: 4px 0;width: 84px" type="number" step="1" min="148" class="b3-text-field" value="${p?parseInt(p):"420"}">`,bind:y=>{y.querySelector("input").addEventListener("change",v=>{const b=(v.target.value||"420")+"px";l.style.height=b,l.firstElementChild.nextElementSibling.style.height=b,updateTransaction(t,s,l.outerHTML,m),m=l.outerHTML,v.stopPropagation();const w=window.echarts.getInstanceById(l.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));w&&w.resize()})}},{id:"update",label:window.siyuan.languages.update,icon:"iconEdit",click(){t.toolbar.showRender(t,l)}}]}).element)}else if(r==="NodeTable"&&!t.disabled){let p=getEditorRange(l);const m=l.querySelector("table");m.contains(p.startContainer)||(p=getEditorRange(m.querySelector("th")));const y=hasClosestByMatchTag(p.startContainer,"TD")||hasClosestByMatchTag(p.startContainer,"TH");y&&(window.siyuan.menus.menu.append(new MenuItem({id:"separator_table",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"table",type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:tableMenu(t,l,y,p).menus}).element))}else if(r==="NodeAttributeView"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({id:"separator_exportCSV",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"exportCSV",icon:"iconDatabase",label:window.siyuan.languages.export+" CSV",click(){fetchPost("/api/export/exportAttributeView",{id:l.getAttribute("data-av-id"),blockID:s},p=>{openByMobile(p.data.zip)})}}).element);else if((r==="NodeVideo"||r==="NodeAudio")&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({id:"separator_VideoOrAudio",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:r==="NodeVideo"?"assetVideo":"assetAudio",type:"submenu",icon:r==="NodeVideo"?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:videoMenu(t,l,r)}).element);else if(r==="NodeIFrame"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({id:"separator_IFrame",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"assetIFrame",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:iframeMenu(t,l)}).element);else if(r==="NodeHTMLBlock"&&!t.disabled)window.siyuan.menus.menu.append(new MenuItem({id:"separator_html",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"html",icon:"iconHTML5",label:"HTML",click(){t.toolbar.showRender(t,l)}}).element);else if(r==="NodeBlockQueryEmbed"&&!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"separator_blockEmbed",type:"separator"}).element);const p=l.getAttribute("breadcrumb");window.siyuan.menus.menu.append(new MenuItem({id:"blockEmbed",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{id:"refresh",icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){l.removeAttribute("data-render"),blockRender(t,l)}},{id:"update",icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){t.toolbar.showRender(t,l)}},{type:"separator"},{id:"embedBlockBreadcrumb",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.embedBlockBreadcrumb}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${p==="true"||window.siyuan.config.editor.embedBlockBreadcrumb&&p!=="false"?" checked":""}></div>`,bind(m){m.addEventListener("click",y=>{const v=m.querySelector("input");y.target.tagName!=="INPUT"&&(v.checked=!v.checked),l.setAttribute("breadcrumb",v.checked.toString()),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{breadcrumb:v.checked.toString()}}),l.removeAttribute("data-render"),blockRender(t,l),window.siyuan.menus.menu.remove()})}},{id:"hideHeadingBelowBlocks",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.hideHeadingBelowBlocks}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${l.getAttribute("custom-heading-mode")==="1"?" checked":""}></div>`,bind(m){m.addEventListener("click",y=>{const v=m.querySelector("input");y.target.tagName!=="INPUT"&&(v.checked=!v.checked),l.setAttribute("custom-heading-mode",v.checked?"1":"0"),fetchPost("/api/attr/setBlockAttrs",{id:s,attrs:{"custom-heading-mode":v.checked?"1":"0"}}),l.removeAttribute("data-render"),blockRender(t,l),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeHeading"&&!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element);const p=[];d!=="h1"&&p.push(this.genHeadingTransform(t,s,1)),d!=="h2"&&p.push(this.genHeadingTransform(t,s,2)),d!=="h3"&&p.push(this.genHeadingTransform(t,s,3)),d!=="h4"&&p.push(this.genHeadingTransform(t,s,4)),d!=="h5"&&p.push(this.genHeadingTransform(t,s,5)),d!=="h6"&&p.push(this.genHeadingTransform(t,s,6)),window.siyuan.menus.menu.append(new MenuItem({id:"tWithSubtitle",type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:p}).element),window.siyuan.menus.menu.append(new MenuItem({id:"copyHeadings1",icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingChildrenDOM",{id:s},m=>{isInAndroid()?window.JSAndroid.writeHTMLClipboard(t.lute.BlockDOM2StdMd(m.data).trimEnd(),m.data+Constants.ZWSP):writeText(m.data+Constants.ZWSP)})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"cutHeadings1",icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingChildrenDOM",{id:s},m=>{isInAndroid()?window.JSAndroid.writeHTMLClipboard(t.lute.BlockDOM2StdMd(m.data).trimEnd(),m.data+Constants.ZWSP):writeText(m.data+Constants.ZWSP),fetchPost("/api/block/getHeadingDeleteTransaction",{id:s},y=>{y.data.doOperations.forEach(v=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${v.id}"]`).forEach(b=>{b.remove()})}),transaction(t,y.data.doOperations,y.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"deleteHeadings1",icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click(){fetchPost("/api/block/getHeadingDeleteTransaction",{id:s},m=>{m.data.doOperations.forEach(y=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${y.id}"]`).forEach(v=>{v.remove()})}),transaction(t,m.data.doOperations,m.data.undoOperations)})}}).element)}if(window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),t.options.backlinkData||(window.siyuan.menus.menu.append(new MenuItem({id:"enter",accelerator:`${updateHotkeyTip(window.siyuan.config.keymap.general.enter.custom)}/${updateHotkeyTip("\u2318"+window.siyuan.languages.click)}`,label:window.siyuan.languages.enter,click:()=>{zoomOut({protyle:t,id:s})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"enterBack",accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click:()=>{enterBack(t,s)}}).element)),!t.disabled){window.siyuan.menus.menu.append(new MenuItem({id:"insertBefore",icon:"iconBefore",label:window.siyuan.languages["insert-before"],accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){hideElements(["select"],t),countBlockWord([],t.block.rootID),insertEmptyBlock(t,"beforebegin",s)}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"insertAfter",icon:"iconAfter",label:window.siyuan.languages["insert-after"],accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){hideElements(["select"],t),countBlockWord([],t.block.rootID),insertEmptyBlock(t,"afterend",s)}}).element);const p=l.lastElementChild.querySelector(".protyle-attr--refcount");p&&p.textContent&&transferBlockRef(s)}if(window.siyuan.menus.menu.append(new MenuItem({id:"jumpToParentNext",label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){hideElements(["select"],t),jumpToParent(t,l,"next")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"jumpToParentPrev",label:window.siyuan.languages.jumpToParentPrev,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentPrev.custom,click(){hideElements(["select"],t),jumpToParent(t,l,"previous")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"jumpToParent",label:window.siyuan.languages.jumpToParent,accelerator:window.siyuan.config.keymap.editor.general.jumpToParent.custom,click(){hideElements(["select"],t),jumpToParent(t,l,"parent")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_3",type:"separator"}).element),r!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new MenuItem({id:"fold",label:window.siyuan.languages.fold,accelerator:`${updateHotkeyTip(window.siyuan.config.keymap.editor.general.collapse.custom)}/${updateHotkeyTip("\u2325"+window.siyuan.languages.click)}`,click(){setFold(t,l),focusBlock(l)}}).element),t.disabled||window.siyuan.menus.menu.append(new MenuItem({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+updateHotkeyTip("\u21E7"+window.siyuan.languages.click),click(){openAttr(l,"bookmark",t)}}).element)),!t.disabled){const p=new MenuItem({id:"appearance",label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(t)}}).element;window.siyuan.menus.menu.append(p),isMobile()||p.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([l],t),this.genWidths([l],t)}window.siyuan.menus.menu.append(new MenuItem({id:"separator_4",type:"separator"}).element),!["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(r)&&((a=getContenteditableElement(l))==null?void 0:a.textContent.trim())!==""&&(r!=="NodeCodeBlock"||r==="NodeCodeBlock"&&!l.getAttribute("data-subtype"))&&window.siyuan.menus.menu.append(new MenuItem({id:"wechatReminder",icon:"iconMp",label:window.siyuan.languages.wechatReminder,ignore:window.siyuan.config.readonly,click(){openWechatNotify(l)}}).element),r!=="NodeThematicBreak"&&!window.siyuan.config.readonly&&(window.siyuan.menus.menu.append(new MenuItem({id:"quickMakeCard",icon:"iconRiffCard",label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',click(){quickMakeCard(t,[l])}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"addToDeck",label:window.siyuan.languages.addToDeck,ignore:!window.siyuan.config.flashcard.deck,icon:"iconRiffCard",click(){makeCard(t.app,[s])}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_5",type:"separator"}).element)),(i=t==null?void 0:t.app)!=null&&i.plugins&&emitOpenMenu({plugins:t.app.plugins,type:"click-blockicon",detail:{protyle:t,blockElements:[l]},separatorPosition:"bottom"});let g=l.getAttribute("updated")||"";return g&&(g=`${window.siyuan.languages.modifiedAt} ${dayjs(g).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new MenuItem({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${g}${window.siyuan.languages.createdAt} ${dayjs(s.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu}genHeadingTransform(t,n,a){return{id:"heading"+a,iconHTML:"",icon:"iconHeading"+a,label:window.siyuan.languages["heading"+a],click(){fetchPost("/api/block/getHeadingLevelTransaction",{id:n,level:a},i=>{i.data.doOperations.forEach((s,o)=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(l=>{l.outerHTML=s.data}),t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(l=>{mathRender(l)}),o===0&&focusBlock(t.wysiwyg.element.querySelector(`[data-node-id="${s.id}"]`),t.wysiwyg.element,!0)}),transaction(t,i.data.doOperations,i.data.undoOperations)})}}}genClick(t,n,a){updateBatchTransaction(t,n,a),focusBlock(t[0])}genAlign(t,n){window.siyuan.menus.menu.append(new MenuItem({id:"layout",label:window.siyuan.languages.layout,type:"submenu",submenu:[{id:"alignLeft",icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")?a.style.justifyContent="":a.style.textAlign="left"})}},{id:"alignCenter",icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")?a.style.justifyContent="center":a.style.textAlign="center"})}},{id:"alignRight",icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")?a.style.justifyContent="flex-end":a.style.textAlign="right"})}},{id:"justify",icon:"iconMenu",label:window.siyuan.languages.justify,click:()=>{this.genClick(t,n,a=>{a.style.textAlign="justify"})}},{id:"separator_1",type:"separator"},{id:"ltr",icon:"iconLtr",label:window.siyuan.languages.ltr,click:()=>{this.genClick(t,n,a=>{a.style.direction="ltr"})}},{id:"rtl",icon:"iconRtl",label:window.siyuan.languages.rtl,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")||(a.style.direction="rtl")})}},{id:"separator_2",type:"separator"},{id:"clearFontStyle",icon:"iconTrashcan",label:window.siyuan.languages.clearFontStyle,click:()=>{this.genClick(t,n,a=>{a.classList.contains("av")?a.style.justifyContent="":(a.style.textAlign="",a.style.direction="")})}}]}).element)}updateNodeElements(t,n,a){const i=[],s=[];t.forEach(o=>{i.push({action:"update",id:o.getAttribute("data-node-id"),data:o.outerHTML})}),a.addEventListener(a.type==="number"?"blur":"change",()=>{t.forEach(o=>{s.push({action:"update",id:o.getAttribute("data-node-id"),data:o.outerHTML})}),transaction(n,s,i),window.siyuan.menus.menu.remove(),focusBlock(t[0])})}genWidths(t,n){let a;const i=t[0],s=[{id:"widthInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${i.style.width.endsWith("px")?parseInt(i.style.width):""}" type="number" style="margin: 4px" placeholder="${window.siyuan.languages.width}"> px
</div>`,bind:l=>{const r=l.querySelector("input");r.addEventListener("input",()=>{t.forEach(d=>{d.style.width=r.value+"px",d.style.flex="none"}),a.value="0",a.parentElement.setAttribute("aria-label",r.value+"px")}),this.updateNodeElements(t,n,r)}}];["25%","33%","50%","67%","75%","100%"].forEach(l=>{s.push({id:"width_"+l,iconHTML:"",label:l,click:()=>{this.genClick(t,n,r=>{r.style.width=l,r.style.flex="none"})}})}),s.push({id:"separator_1",type:"separator"});const o=i.style.width.endsWith("%")?parseInt(i.style.width):0;window.siyuan.menus.menu.append(new MenuItem({id:"widthDrag",label:window.siyuan.languages.width,submenu:s.concat([{id:"widthDrag",iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;"  aria-label="${i.style.width.endsWith("px")?i.style.width:i.style.width||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${isMobile()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${o}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind:l=>{a=l.querySelector("input"),a.addEventListener("input",()=>{t.forEach(r=>{r.style.width=a.value+"%",r.style.flex="none"}),a.parentElement.setAttribute("aria-label",`${a.value}%`)}),this.updateNodeElements(t,n,a)}},{id:"separator_2",type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(t,n,l=>{l.style.width&&(l.style.width="",l.style.flex="")})}}])}).element)}genHeights(t,n){if(t.find(r=>{if(!r.classList.contains("p")&&!r.classList.contains("code-block")&&!r.classList.contains("render-node"))return!0}))return;let i;const s=t[0],o=[{id:"heightInput",iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${s.style.height.endsWith("px")?parseInt(s.style.height):""}" type="number" style="margin: 4px" placeholder="${window.siyuan.languages.height}"> px
</div>`,bind:r=>{const d=r.querySelector("input");d.addEventListener("input",()=>{t.forEach(c=>{c.style.height=d.value+"px",c.style.flex="none"}),i.value="0",i.parentElement.setAttribute("aria-label",d.value+"px")}),this.updateNodeElements(t,n,d)}}];["25%","33%","50%","67%","75%","100%"].forEach(r=>{o.push({id:"height_"+r,iconHTML:"",label:r,click:()=>{this.genClick(t,n,d=>{d.style.height=r,d.style.flex="none"})}})}),o.push({type:"separator"});const l=s.style.height.endsWith("%")?parseInt(s.style.height):0;window.siyuan.menus.menu.append(new MenuItem({id:"heightDrag",label:window.siyuan.languages.height,submenu:o.concat([{iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;"  aria-label="${s.style.height.endsWith("px")?s.style.height:s.style.height||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${isMobile()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${l}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind:r=>{i=r.querySelector("input"),i.addEventListener("input",()=>{t.forEach(d=>{d.style.height=i.value+"%",d.style.flex="none"}),i.parentElement.setAttribute("aria-label",`${i.value}%`)}),this.updateNodeElements(t,n,i)}},{type:"separator"},{id:"default",iconHTML:"",label:window.siyuan.languages.default,click:()=>{this.genClick(t,n,r=>{r.style.height&&(r.style.height="",r.style.overflow="")})}}])}).element)}genCopyTextRef(t){return isNotEditBlock(t[0])?!1:{id:"copyText",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.copyText.custom,label:window.siyuan.languages.copyText,click(){t[0].setAttribute("data-reftext","true"),focusByRange(getEditorRange(t[0])),document.execCommand("copy")}}}render(t,n,a,i){if(t.title&&t.title.element.getAttribute("data-render")!=="true")return;const s=a.parentElement.parentElement.querySelector(".protyle-select");if(s&&!s.classList.contains("fn__none"))return;let o="",l=n,r=0,d=0,c,u=!1;for(;l;){const b=!u||u&&l.getAttribute("fold")==="1";if(!isInEmbedBlock(l)){let h;b&&(h=l.getAttribute("data-type"));const C=l.getAttribute("data-node-id");if(h==="NodeAttributeView"&&i){const _=hasClosestByClassName(i,"av__row");if(_&&!_.classList.contains("av__row--header")){n=_,o=`<button data-type="NodeAttributeViewRowMenu" data-node-id="${C}" data-row-id="${_.dataset.id}" class="ariaLabel" data-position="right" aria-label="${window.siyuan.languages.rowTip}"><svg><use xlink:href="#iconDrag"></use></svg><span ${t.disabled?"":'draggable="true" class="fn__grab"'}></span></button>`,t.disabled||(o=`<button data-type="NodeAttributeViewRow" data-node-id="${C}" data-row-id="${_.dataset.id}" class="ariaLabel" data-position="right" aria-label="${isMac()?window.siyuan.languages.addBelowAbove:window.siyuan.languages.addBelowAbove.replace("\u2325","Alt+")}"><svg><use xlink:href="#iconAdd"></use></svg></button>${o}`);break}}if(d===0){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes(h))return;const _=getTopAloneElement(l);c=_.querySelector(".li")||_.querySelector(".list"),isInEmbedBlock(c)&&(c=void 0),!_.isSameNode(l)&&h!=="NodeHeading"&&(l=_,h=l.getAttribute("data-type"))}h==="NodeListItem"&&d===1&&!b&&(o=""),d+=1;const k=`<button class="ariaLabel" data-position="right" aria-label="${this.gutterTip}" 
data-type="${h}" data-subtype="${l.getAttribute("data-subtype")}" data-node-id="${l.getAttribute("data-node-id")}">
    <svg><use xlink:href="#${getIconByType(h,l.getAttribute("data-subtype"))}"></use></svg>
    <span ${t.disabled?"":'draggable="true"'}></span>
</button>`;b&&(o=k+o);let E="";if(h==="NodeListItem"&&l.childElementCount>3||h==="NodeHeading"){const _=l.getAttribute("fold");E=`<button class="ariaLabel" data-position="right" aria-label="${window.siyuan.languages.fold}" 
data-type="fold" style="cursor:inherit;"><svg style="width:10px${_&&_==="1"?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}(h==="NodeListItem"||h==="NodeList")&&(c=l,h==="NodeListItem"&&l.childElementCount>3&&(o=k+E)),h==="NodeHeading"&&(o=o+E),h==="NodeBlockquote"&&(r+=8),l.previousElementSibling&&l.previousElementSibling.getAttribute("data-node-id")&&(u=!0)}const w=hasClosestBlock(l.parentElement);if(w)l=w;else break}let f=!0;const g=this.element.querySelectorAll("button");if(g.length!==o.split("</button>").length-1?f=!1:Array.from(g).find(b=>{const w=b.getAttribute("data-node-id");if(w&&o.indexOf(w)===-1)return f=!1,!0;const h=b.getAttribute("data-row-id");if(h&&o.indexOf(h)===-1||!h&&o.indexOf("NodeAttributeViewRowMenu")>-1)return f=!1,!0}),f&&this.element.childElementCount>0){this.element.classList.remove("fn__none");return}this.element.innerHTML=o,this.element.classList.remove("fn__none"),this.element.style.width="";const p=a.parentElement.getBoundingClientRect().top;let m=n.getBoundingClientRect(),y=0;c?(m=c.firstElementChild.getBoundingClientRect(),r=0):l.getAttribute("data-type")==="NodeBlockQueryEmbed"?(m=l.getBoundingClientRect(),r=0):n.classList.contains("av__row")||(m.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8||m.height>Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&m.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)*2+8?y=(m.height-this.element.clientHeight)/2:(l.getAttribute("data-type")==="NodeAttributeView"||n.getAttribute("data-type")==="NodeAttributeView")&&p<m.top&&(y=8)),this.element.style.top=`${Math.max(m.top,p)+y}px`;let v=m.left-this.element.clientWidth-r;l.getAttribute("data-type")==="NodeBlockQueryEmbed"&&this.element.childElementCount===1?v=l.getBoundingClientRect().left-this.element.clientWidth-r:n.classList.contains("av__row")&&(v=l.getBoundingClientRect().left-this.element.clientWidth-r+parseInt(getComputedStyle(l).paddingLeft)),this.element.style.left=`${v}px`,v<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=`${m.left-this.element.clientWidth-r/2+3}px`,o="",Array.from(this.element.children).reverse().forEach((b,w)=>{w!==0&&(b.firstElementChild.style.height="14px"),o+=b.outerHTML}),this.element.innerHTML=o):this.element.querySelectorAll("svg").forEach(b=>{b.style.height=""})}}const lo=(e,t)=>{if(window.siyuan.config.fileTree.removeDocWithoutConfirm){fetchPost("/api/filetree/removeDoc",{notebook:e,path:t});return}fetchPost("/api/block/getDocInfo",{id:getDisplayName(t,!0,!0)},n=>{const a=escapeHtml(n.data.name);let i=`${window.siyuan.languages.confirmDeleteTip.replace("${x}",a)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`;n.data.subFileCount>0&&(i=`${window.siyuan.languages.andSubFile.replace("${x}",a).replace("${y}",n.data.subFileCount)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`),confirmDialog(window.siyuan.languages.deleteOpConfirm,i,()=>{fetchPost("/api/filetree/removeDoc",{notebook:e,path:t})})})},oc=e=>{if(e.length===1){const t=hasTopClosestByTag(e[0],"UL");if(t){const n=t.getAttribute("data-url");e[0].getAttribute("data-type")==="navigation-file"?lo(n,e[0].getAttribute("data-path")):confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDeleteTip.replace("${x}",Lute.EscapeHTMLStr(getNotebookName(n)))}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{fetchPost("/api/notebook/removeNotebook",{notebook:n,callback:Constants.CB_MOUNT_REMOVE})})}}else{const t=[];if(e.forEach(n=>{n.getAttribute("data-path")!=="/"&&t.push(n.getAttribute("data-path"))}),t.length===0){showMessage(window.siyuan.languages.notBatchRemove);return}confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmRemoveAll.replace("${count}",t.length)}
<div class="fn__hr"></div>
<div class="ft__smaller ft__on-surface">${window.siyuan.languages.rollbackTip.replace("${x}",window.siyuan.config.editor.historyRetentionDays)}</div>`,()=>{fetchPost("/api/filetree/removeDocs",{paths:t})})}};var an=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const sn=(e,t=0)=>{let n=0,a=0;return e.cards.forEach((i,s)=>{s>t||(i.state===0?n++:a++)}),`<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardNewCard}">
    <span class="ft__error">${n}</span> /
    <span class="ariaLabel ft__primary" aria-label="${window.siyuan.languages.flashcardNewCard}">${e.unreviewedNewCardCount}</span>
</span>
<span class="fn__space"></span>+<span class="fn__space"></span>
<span class="ariaLabel" aria-label="${window.siyuan.languages.flashcardReviewCard}">
    <span class="ft__error">${a}</span> /
    <span class="ft__success">${e.unreviewedOldCardCount}</span>
</span>`},ro=e=>{let t;return t=`<div class="toolbar toolbar--border">
    <svg class="toolbar__icon"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="fn__flex-1 fn__flex-center toolbar__text">${window.siyuan.languages.riffCard}</span>
    <div data-type="count" class="${e.cardsData.cards.length===0?"fn__none":"fn__flex"}">${sn(e.cardsData)}</span></div>
    <svg class="toolbar__icon" data-id="${e.id||""}" data-cardtype="${e.cardType}" data-type="filter"><use xlink:href="#iconFilter"></use></svg>
    <svg class="toolbar__icon" data-type="more"><use xlink:href="#iconMore"></use></svg>
    <svg class="toolbar__icon" data-type="close"><use xlink:href="#iconCloseRound"></use></svg>
</div>`,`<div class="card__main">
    ${t}
    <div class="card__block fn__flex-1 ${e.cardsData.cards.length===0?"fn__none":""} 
${window.siyuan.config.flashcard.mark?"card__block--hidemark":""} 
${window.siyuan.config.flashcard.superBlock?"card__block--hidesb":""} 
${window.siyuan.config.flashcard.heading?"card__block--hideh":""} 
${window.siyuan.config.flashcard.list?"card__block--hideli":""}" data-type="render"></div>
    <div class="card__empty card__empty--space${e.cardsData.cards.length===0?"":" fn__none"}" data-type="empty">
        <div>\u{1F52E}</div>
        ${window.siyuan.languages.noDueCard}
    </div>
    <div class="fn__flex card__action${e.cardsData.cards.length===0?" fn__none":""}">
        <button class="b3-button b3-button--cancel" disabled="disabled" data-type="-2" style="width: 25%;min-width: 86px;display: flex">
            <svg><use xlink:href="#iconLeft"></use></svg>
            (p / q)
        </button>
        <span class="fn__space"></span>
        <button data-type="-1" class="b3-button fn__flex-1">${window.siyuan.languages.cardShowAnswer} (${window.siyuan.languages.space} / ${window.siyuan.languages.enterKey})</button>
    </div>
    <div class="fn__flex card__action fn__none">
        <div>
            <span>${window.siyuan.languages.nextRound}</span>
            <button data-type="-3" aria-label="0 / x" class="b3-button b3-button--cancel b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F4A4}</div>
                ${window.siyuan.languages.skip} (0)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="1" aria-label="1 / j / a" class="b3-button b3-button--error b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F648}</div>
                ${window.siyuan.languages.cardRatingAgain} (1)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="2" aria-label="2 / k / s" class="b3-button b3-button--warning b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F62C}</div>
                ${window.siyuan.languages.cardRatingHard} (2)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="3" aria-label="3 / l / d / ${window.siyuan.languages.space} / ${window.siyuan.languages.enterKey}" class="b3-button b3-button--info b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F60A}</div>
                ${window.siyuan.languages.cardRatingGood} (3)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="4" aria-label="4 / ; / f" class="b3-button b3-button--success b3-tooltips__n b3-tooltips">
                <div class="card__icon">\u{1F308}</div>
                ${window.siyuan.languages.cardRatingEasy} (4)
            </button>
        </div>
    </div>
</div>`},co=e=>an(void 0,null,function*(){window.siyuan.storage[Constants.LOCAL_FLASHCARD].fullscreen&&fullscreen(e.element.querySelector(".card__main"),e.element.querySelector('[data-type="fullscreen"]'));let t=0;typeof e.index=="number"&&(t=e.index);const n=new Protyle(e.app,e.element.querySelector("[data-type='render']"),{blockId:"",action:[Constants.CB_GET_ALL],render:{background:!1,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1});window.siyuan.mobile&&(window.siyuan.mobile.popEditor=n),e.cardsData.cards.length>0&&fetchPost("/api/block/getDocInfo",{id:e.cardsData.cards[t].blockID},l=>{n.protyle.wysiwyg.renderCustom(l.data.ial),fetchPost("/api/filetree/getDoc",{id:e.cardsData.cards[t].blockID,mode:0,size:Constants.SIZE_GET_MAX},r=>{onGet({updateReadonly:!0,data:r,protyle:n.protyle,action:r.data.rootID===r.data.id?[Constants.CB_GET_HTML]:[Constants.CB_GET_ALL,Constants.CB_GET_HTML]})})}),e.element.setAttribute("data-key",Constants.DIALOG_OPENCARD);const a=e.element.querySelectorAll(".card__action");e.index===0?a[0].firstElementChild.setAttribute("disabled","disabled"):a[0].firstElementChild.removeAttribute("disabled");const i=e.element.querySelector('[data-type="count"]'),s=e.element.querySelector('[data-type="filter"]'),o=()=>{const l=s.getAttribute("data-cardtype"),r=s.getAttribute("data-id");fetchPost(l==="all"?"/api/riff/getRiffDueCards":l==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:r,deckID:r,notebook:r},d=>an(void 0,null,function*(){t=0,e.cardsData=d.data;for(let c=0;c<e.app.plugins.length;c++)e.cardsData=yield e.app.plugins[c].updateCards(e.cardsData);e.cardsData.cards.length>0?ln({countElement:i,editor:n,actionElements:a,index:t,cardsData:e.cardsData}):Za(i,n,a)}))};return i.innerHTML=sn(e.cardsData,t),e.element.addEventListener("click",l=>{const r=l.target;let d="";const c=e.cardsData.cards[t],u=s.getAttribute("data-id");if(typeof l.detail=="string")["1","j","a"].includes(l.detail)?d="1":["2","k","s"].includes(l.detail)?d="2":["3","l","d"].includes(l.detail)?d="3":["4",";","f"].includes(l.detail)?d="4":[" ","enter"].includes(l.detail)?d="-1":["p","q"].includes(l.detail)?d="-2":["0","x"].includes(l.detail)&&(d="-3");else{if(hasClosestByAttribute(r,"data-type","fullscreen")){fullscreen(e.element.querySelector(".card__main"),e.element.querySelector('[data-type="fullscreen"]')),resize(n.protyle),window.siyuan.storage[Constants.LOCAL_FLASHCARD].fullscreen=!window.siyuan.storage[Constants.LOCAL_FLASHCARD].fullscreen,setStorageVal(Constants.LOCAL_FLASHCARD,window.siyuan.storage[Constants.LOCAL_FLASHCARD]),l.stopPropagation(),l.preventDefault();return}if(hasClosestByAttribute(r,"data-type","more")){if(l.stopPropagation(),l.preventDefault(),s.getAttribute("data-cardtype")==="all"&&s.getAttribute("data-id")){showMessage(window.siyuan.languages.noSupportTip);return}const v=new Menu;v.addItem({icon:"iconClock",label:window.siyuan.languages.setDueTime,click(){const b=new Dialog({title:window.siyuan.languages.setDueTime,content:`<div class="b3-dialog__content">
    <div class="b3-label__text">${window.siyuan.languages.showCardDay}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" value="1" type="number" step="1" min="1">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"}),w=b.element.querySelector("input"),h=b.element.querySelectorAll(".b3-button");b.bindInput(w,()=>{h[1].click()}),w.focus(),w.select(),h[0].addEventListener("click",()=>{b.destroy()}),h[1].addEventListener("click",()=>{fetchPost("/api/riff/batchSetRiffCardsDueTime",{cardDues:[{id:c.cardID,due:dayjs().add(parseInt(w.value),"day").format("YYYYMMDDHHmmss")}]},()=>{a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),c.state===0?e.cardsData.unreviewedNewCardCount--:e.cardsData.unreviewedOldCardCount--,e.element.dispatchEvent(new CustomEvent("click",{detail:"0"})),e.cardsData.cards.splice(t,1),t--,b.destroy()})})}}),c.state!==0&&v.addItem({icon:"iconRefresh",label:window.siyuan.languages.reset,click(){fetchPost("/api/riff/resetRiffCards",{type:s.getAttribute("data-cardtype"),id:u,deckID:Constants.QUICK_DECK_ID,blockIDs:[c.blockID]},()=>{const b=window.siyuan.languages._time["1m"].replace("%s","");c.lapses=0,c.lastReview=-621355968e5,c.reps=0,c.state=0,c.nextDues={1:b,2:b.replace("1","5"),3:b.replace("1","10"),4:window.siyuan.languages._time["1d"].replace("%s","").replace("1","6")},a[1].querySelectorAll(".b3-button").forEach((w,h)=>{w.previousElementSibling.textContent=c.nextDues[h]}),e.cardsData.unreviewedOldCardCount--,e.cardsData.unreviewedNewCardCount++,i.innerHTML=sn(e.cardsData,t)})}}),v.addItem({icon:"iconTrashcan",label:`${window.siyuan.languages.remove} <b>${window.siyuan.languages.riffCard}</b>`,click(){a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),c.state===0?e.cardsData.unreviewedNewCardCount--:e.cardsData.unreviewedOldCardCount--,e.element.dispatchEvent(new CustomEvent("click",{detail:"0"})),transaction(void 0,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[c.blockID]}]),e.cardsData.cards.splice(t,1),t--}}),v.addSeparator(),v.addItem({iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.forgetCount}</div>
    <div class="fn__space"></div>
    <div>${c.lapses}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.revisionCount}</div>
    <div class="fn__space"></div>
    <div>${c.reps}</div>
</div><div class="fn__flex">
    <div class="fn__flex-1 ft__breakword">${window.siyuan.languages.cardStatus}</div>
    <div class="fn__space"></div>
    <div class="${c.state===0?"ft__primary":"ft__success"}">${c.state===0?window.siyuan.languages.flashcardNewCard:window.siyuan.languages.flashcardReviewCard}</div>
</div><div class="fn__flex${c.lastReview>0?"":" fn__none"}">
    <div class="fn__flex-1 ft__breakword" style="width: 170px;">${window.siyuan.languages.lastReviewTime}</div>
    <div class="fn__space"></div>
    <div>${dayjs(c.lastReview).format("YYYY-MM-DD")}</div>
</div>`}),v.fullscreen();return}if(hasClosestByAttribute(r,"data-type","close")){e.dialog&&e.dialog.destroy(),l.stopPropagation(),l.preventDefault();return}const m=hasClosestByAttribute(r,"data-type","filter");if(m){fetchPost("/api/riff/getRiffDecks",{},v=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.all,click(){s.setAttribute("data-id",""),s.setAttribute("data-cardtype","all"),o()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.fileTree,click(){movePathTo((w,h)=>{s.setAttribute("data-id",w[0]==="/"?h[0]:getDisplayName(w[0],!0,!0)),s.setAttribute("data-cardtype",w[0]==="/"?"notebook":"doc"),o()},[],void 0,window.siyuan.languages.specifyPath,!0)}}).element),(e.title||v.data.length>0)&&window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),e.title&&(window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:escapeHtml(e.title),click(){s.setAttribute("data-id",e.id),s.setAttribute("data-cardtype",e.cardType),o()}}).element),v.data.length>0&&window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element)),v.data.forEach(w=>{window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:escapeHtml(w.name),click(){s.setAttribute("data-id",w.id),s.setAttribute("data-cardtype","all"),o()}}).element)});const b=m.getBoundingClientRect();window.siyuan.menus.menu.popup({x:b.left,y:b.bottom})}),l.stopPropagation(),l.preventDefault();return}if(hasClosestByAttribute(r,"data-type","newround")){o(),l.stopPropagation(),l.preventDefault();return}}if(!d){const f=hasClosestByClassName(r,"b3-button");f&&(d=f.getAttribute("data-type"))}if(!(!d||!c)){if(l.preventDefault(),l.stopPropagation(),hideElements(["toolbar","hint","util","gutter"],n.protyle),d==="-1")if(a[0].classList.contains("fn__none"))d="3";else{n.protyle.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),a[0].classList.add("fn__none"),a[1].querySelectorAll(".b3-button").forEach((f,g)=>{f.previousElementSibling.textContent=c.nextDues[g]}),a[1].classList.remove("fn__none"),on(e.app,c,d);return}else if(d==="-2"){if(a[0].classList.contains("fn__none"))return;t>0&&(t--,ln({countElement:i,editor:n,actionElements:a,index:t,cardsData:e.cardsData}),on(e.app,e.cardsData.cards[t+1],d));return}["1","2","3","4","-3"].includes(d)&&a[0].classList.contains("fn__none")&&fetchPost(d==="-3"?"/api/riff/skipReviewRiffCard":"/api/riff/reviewRiffCard",{deckID:c.deckID,cardID:c.cardID,rating:parseInt(d),reviewedCards:e.cardsData.cards},()=>{if(d!=="-3"&&(window.siyuan.config.sync.provider!==0&&isPaidUser()||window.siyuan.config.sync.provider===0&&!needSubscribe(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none"),t++,t>e.cardsData.cards.length-1){const f=s.getAttribute("data-cardtype");fetchPost(f==="all"?"/api/riff/getRiffDueCards":f==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:u,deckID:u,notebook:u,reviewedCards:e.cardsData.cards},g=>an(void 0,null,function*(){on(e.app,e.cardsData.cards[t-1],d),t=0,e.cardsData=g.data;for(let p=0;p<e.app.plugins.length;p++)e.cardsData=yield e.app.plugins[p].updateCards(e.cardsData);e.cardsData.cards.length===0?e.cardsData.unreviewedCount>0?fo(i,n,a,g.data.unreviewedCount):Za(i,n,a):ln({countElement:i,editor:n,actionElements:a,index:t,cardsData:e.cardsData})}));return}ln({countElement:i,editor:n,actionElements:a,index:t,cardsData:e.cardsData}),on(e.app,e.cardsData.cards[t-1],d)})}}),n}),on=(e,t,n)=>{e.plugins.forEach(a=>{a.eventBus.emit("click-flashcard-action",{type:n,card:t})})},lc=e=>{window.siyuan.config.readonly||fetchPost("/api/riff/getRiffDueCards",{deckID:""},t=>{uo(e,t.data,"all")})},uo=(e,t,n,a,i)=>an(void 0,null,function*(){if(window.siyuan.dialogs.find(d=>{if(d.element.getAttribute("data-key")===Constants.DIALOG_OPENCARD)return d.destroy(),!0}))return;let o;getSelection().rangeCount>0&&(o=getSelection().getRangeAt(0));for(let d=0;d<e.plugins.length;d++)t=yield e.plugins[d].updateCards(t);const l=new Dialog({positionId:Constants.DIALOG_OPENCARD,content:ro({id:a,cardType:n,cardsData:t,isTab:!1}),width:isMobile()?"100vw":"80vw",height:isMobile()?"100vh":"70vh",destroyCallback(){r&&(r.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null)),o&&focusByRange(o)},resizeCallback(d){d!=="d"&&d!=="t"&&r&&r.resize()}});l.element.querySelector(".b3-dialog__scrim").style.backgroundColor="var(--b3-theme-background)",l.element.querySelector(".b3-dialog__container").style.maxWidth="1024px";const r=yield co({app:e,element:l.element,cardsData:t,title:i,id:a,cardType:n,dialog:l});r.resize(),l.editors={card:r},updateCardHV()}),ln=e=>{e.editor.protyle.element.classList.add("card__block--hide"),window.siyuan.config.flashcard.superBlock&&e.editor.protyle.element.classList.add("card__block--hidesb"),window.siyuan.config.flashcard.heading&&e.editor.protyle.element.classList.add("card__block--hideh"),window.siyuan.config.flashcard.list&&e.editor.protyle.element.classList.add("card__block--hideli"),window.siyuan.config.flashcard.mark&&e.editor.protyle.element.classList.add("card__block--hidemark"),e.actionElements[0].classList.remove("fn__none"),e.actionElements[1].classList.add("fn__none"),e.editor.protyle.element.classList.remove("fn__none"),e.editor.protyle.element.nextElementSibling.classList.add("fn__none"),e.countElement.innerHTML=sn(e.cardsData,e.index),e.countElement.classList.remove("fn__none"),e.index===0?e.actionElements[0].firstElementChild.setAttribute("disabled","disabled"):e.actionElements[0].firstElementChild.removeAttribute("disabled"),fetchPost("/api/block/getDocInfo",{id:e.cardsData.cards[e.index].blockID},t=>{e.editor.protyle.wysiwyg.renderCustom(t.data.ial),fetchPost("/api/filetree/getDoc",{id:e.cardsData.cards[e.index].blockID,mode:0,size:Constants.SIZE_GET_MAX},n=>{onGet({updateReadonly:!0,data:n,protyle:e.editor.protyle,action:n.data.rootID===n.data.id?[Constants.CB_GET_HTML]:[Constants.CB_GET_ALL,Constants.CB_GET_HTML]})})})},Za=(e,t,n)=>{e.classList.add("fn__none"),t.protyle.element.classList.add("fn__none");const a=t.protyle.element.nextElementSibling;a.innerHTML=`<div>\u{1F52E}</div>${window.siyuan.languages.noDueCard}`,a.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")},fo=(e,t,n,a)=>{e.classList.add("fn__none"),t.protyle.element.classList.add("fn__none");const i=t.protyle.element.nextElementSibling;i.innerHTML=`<div>\u267B\uFE0F </div>
<span>${window.siyuan.languages.continueReview2.replace("${count}",a)}</span>
<div class="fn__hr"></div>
<button data-type="newround" class="b3-button fn__size200">${window.siyuan.languages.continueReview1}</button>`,i.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")};let Rt,Ot=!1;const zn=(e,t,n)=>{const a=e.querySelector('[data-type="docprevious"]'),i=e.querySelector('[data-type="docnext"]');e.setAttribute("data-page",t.toString()),t>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const s=e.querySelector('.b3-select[data-type="opselect"]'),o=e.querySelector(".b3-list--background");e.querySelector('.history__text[data-type="docPanel"]').classList.add("fn__none"),e.querySelector('.history__text[data-type="mdPanel"]').classList.remove("fn__none"),fetchPost("/api/history/searchHistory",{query:n,page:t,op:s.value,type:3},l=>{if(t<l.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),i.nextElementSibling.nextElementSibling.textContent=`${t}/${l.data.pageCount||1}`,l.data.histories.length===0){o.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let r="";l.data.histories.forEach(d=>{r+=`<li class="b3-list-item b3-list-item--hide-action" data-created="${d}">
    <span class="b3-list-item__text">${dayjs(parseInt(d)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),o.innerHTML=r})},rc=e=>{const t=`<div class="fn__flex-column" style="height: 100%;">
        <div class="block__icons">
            ${isMobile()?"":e.pathString}
            <span class="fn__space"></span>
            <div class="fn__flex-1"></div>
            <select data-type="opselect" class="b3-select">
                <option value="all" selected>${window.siyuan.languages.allOp}</option>
                <option value="clean">${window.siyuan.languages.historyClean}</option>
                <option value="update">${window.siyuan.languages.historyUpdate}</option>
                <option value="delete">${window.siyuan.languages.historyDelete}</option>
                <option value="format">${window.siyuan.languages.historyFormat}</option>
                <option value="sync">${window.siyuan.languages.historySync}</option>
                <option value="replace">${window.siyuan.languages.historyReplace}</option>
                <option value="outline">${window.siyuan.languages.historyOutline}</option>
            </select>
            <span class="fn__space"></span>
            <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__s" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
            <span class="fn__space"></span>
            <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__s" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
            <span class="fn__space"></span>
            <span>1/1</span>
            ${isMobile()?'<span class="fn__space"></span><span data-type="close" class="block__icon block__icon--show"><svg><use xlink:href="#iconClose"></use></svg></span>':""}
        </div>
        <div class="fn__flex fn__flex-1 history__panel">
            <ul class="b3-list b3-list--background" style="overflow:auto;">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
            <textarea class="fn__flex-1 history__text fn__none" readonly data-type="mdPanel"></textarea>
            <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
        </div>
</div>`,n=new Dialog({content:t,width:isMobile()?"100vw":"90vw",height:isMobile()?"100vh":"80vh",destroyCallback(){Rt=void 0}});n.element.setAttribute("data-key",Constants.DIALOG_HISTORYDOC);const a=n.element.querySelector(".b3-select");a.addEventListener("change",()=>{zn(n.element,1,e.id)});const i=n.element.querySelector('.history__text[data-type="docPanel"]'),s=n.element.querySelector('.history__text[data-type="mdPanel"]');zn(n.element,1,e.id),Rt=new Protyle(e.app,i,{blockId:"",history:{created:""},action:[Constants.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(Rt.protyle),n.element.addEventListener("click",o=>{let l=o.target;for(;l&&!l.isEqualNode(n.element);){const r=l.getAttribute("data-type");if(r==="close")n.destroy();else if(r==="rollback"&&!Ot){Xa(l.parentElement,a.value,e.id,d=>{const c=d.path;Ot=!1;const u=window.siyuan.languages.rollbackConfirm.replace("${name}",d.title).replace("${time}",l.previousElementSibling.previousElementSibling.textContent.trim());confirmDialog("\u26A0\uFE0F "+window.siyuan.languages.rollback,u,()=>{fetchPost("/api/history/rollbackDocHistory",{notebook:e.notebookId,historyPath:c})})}),o.stopPropagation(),o.preventDefault();break}else if(l.classList.contains("b3-list-item")&&!Ot){Xa(l,a.value,e.id,d=>{var c;const u=d.path;fetchPost("/api/history/getDocHistoryContent",{historyPath:u},f=>{f.data.isLargeDoc?(s.value=f.data.content,s.classList.remove("fn__none"),i.classList.add("fn__none")):(s.classList.add("fn__none"),i.classList.remove("fn__none"),onGet({data:f,protyle:Rt.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),Ot=!1}),(c=l.parentElement.querySelector(".b3-list-item--focus"))==null||c.classList.remove("b3-list-item--focus"),l.classList.add("b3-list-item--focus")}),o.stopPropagation(),o.preventDefault();break}else if((r==="docprevious"||r==="docnext")&&l.getAttribute("disabled")!=="disabled"){const d=parseInt(n.element.getAttribute("data-page"));zn(n.element,r==="docprevious"?d-1:d+1,e.id),o.stopPropagation(),o.preventDefault();break}l=l.parentElement}})},Xa=(e,t,n,a)=>{Ot=!0;const i=e.getAttribute("data-path");i&&a(i);const s=e.getAttribute("data-created");Rt.protyle.options.history.created=s,fetchPost("/api/history/getHistoryItems",{query:n,op:t,type:3,created:s},o=>{a(o.data.items[0])})},Ja=(e,t)=>{let n=`<option value="">${window.siyuan.languages.currentNotebook}</option>`;const a=[];return Object.keys(Constants.HELP_PATH).forEach(i=>{a.push(Constants.HELP_PATH[i])}),window.siyuan.notebooks.forEach(i=>{a.includes(i.id)||i.id===t||(n+=`<option value="${i.id}" ${e===i.id?"selected":""}>${i.name}</option>`)}),n},dc=e=>{const t=`<div class="fn__flex">${escapeHtml(e.name)}
<div class="fn__space"></div>
<button class="b3-button b3-button--small fn__flex-center">${window.siyuan.languages.copy} ID</button></div>`,n=`<div class="b3-dialog__content" style="background-color: var(--b3-theme-background);">
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree12}
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="docCreateSaveBox">${Ja(e.conf.docCreateSaveBox,e.box)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="docCreateSavePath" value="">
    </div>
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.fileTree5}
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    <span class="fn__hr"></span>
    <div class="fn__flex">
        <select style="min-width: 200px" class="b3-select" id="refCreateSaveBox">${Ja(e.conf.refCreateSaveBox,e.box)}</select>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" id="refCreateSavePath" value="">
    </div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree11}
    <div class="b3-label__text">${window.siyuan.languages.fileTree14}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteSavePath" value="">
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree15}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteTemplatePath" value="${e.conf.dailyNoteTemplatePath}">
</div></div>`;if(isMobile())openModel({title:t,icon:"iconSettings",html:`<div>${n}</div>`,bindEvent(){Qa(document.querySelector("#model"),e)}});else{const a=new Dialog({width:"80vw",title:t,content:n});a.element.setAttribute("data-key",Constants.DIALOG_NOTEBOOKCONF),Qa(a.element,e)}},Qa=(e,t)=>{e.querySelector(".b3-button--small").addEventListener("click",()=>{writeText(t.box),showMessage(window.siyuan.languages.copied)});const n=e.querySelector("#dailyNoteSavePath");n.value=t.conf.dailyNoteSavePath;const a=e.querySelector("#docCreateSavePath");a.value=t.conf.docCreateSavePath;const i=e.querySelector("#refCreateSavePath");i.value=t.conf.refCreateSavePath;const s=e.querySelector("#dailyNoteTemplatePath");s.value=t.conf.dailyNoteTemplatePath,e.querySelectorAll("input, select").forEach(o=>{o.addEventListener("change",()=>{fetchPost("/api/notebook/setNotebookConf",{notebook:t.box,conf:{refCreateSavePath:i.value,refCreateSaveBox:e.querySelector("#refCreateSaveBox").value,docCreateSaveBox:e.querySelector("#docCreateSaveBox").value,docCreateSavePath:a.value,dailyNoteSavePath:n.value,dailyNoteTemplatePath:s.value}})})})};var es=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const ts=(e,t)=>{if(!Array.from(e).find(i=>{if(i.getAttribute("data-type")==="navigation-file")return!0}))return window.siyuan.menus.menu;window.siyuan.menus.menu.append(movePathToMenu(getTopPaths(Array.from(e))));const a=[];if(e.forEach(i=>{const s=i.getAttribute("data-node-id");s&&a.push(s)}),a.length>0&&window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{addFilesToDatabase(Array.from(e))}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{deleteFiles(Array.from(e))}}).element),a.length===0)return window.siyuan.menus.menu;if(window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element),!window.siyuan.config.readonly){const i=[{id:"quickMakeCard",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{transaction(void 0,[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:a}])}},{id:"removeCard",iconHTML:"",label:window.siyuan.languages.removeCard,click:()=>{transaction(void 0,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:a}])}}];window.siyuan.config.flashcard.deck&&i.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{makeCard(t,a)}}),window.siyuan.menus.menu.append(new MenuItem({id:"riffCard",label:window.siyuan.languages.riffCard,icon:"iconRiffCard",submenu:i}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element)}return openEditorTab(t,a),t.plugins&&emitOpenMenu({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:e,type:"docs"},separatorPosition:"top"}),window.siyuan.menus.menu},cc=(e,t)=>{window.siyuan.menus.menu.remove();const n=hasClosestByTag(t,"DIV");if(!n)return window.siyuan.menus.menu;t.classList.contains("b3-list-item--focus")||(n.querySelectorAll(".b3-list-item--focus").forEach(o=>{o.classList.remove("b3-list-item--focus"),o.removeAttribute("select-end"),o.removeAttribute("select-start")}),t.classList.add("b3-list-item--focus"));const a=n.querySelectorAll(".b3-list-item--focus");if(a.length>1)return ts(a,e);const i=t.parentElement.getAttribute("data-url"),s=getNotebookName(i);if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(renameMenu({path:"/",notebookId:i,name:s,type:"notebook"})),window.siyuan.menus.menu.append(new MenuItem({id:"config",label:window.siyuan.languages.config,icon:"iconSettings",click:()=>{fetchPost("/api/notebook/getNotebookConf",{notebook:i},l=>{onGetnotebookconf(l.data)})}}).element);const o=go("notebook",parseInt(t.parentElement.getAttribute("data-sortmode")),l=>(fetchPost("/api/notebook/setNotebookConf",{notebook:i,conf:{sortMode:l}},()=>{var r;t.parentElement.setAttribute("data-sortmode",l.toString());let d;d=window.siyuan.mobile.files;const c=t.querySelector(".b3-list-item__arrow--open");c&&(c.classList.remove("b3-list-item__arrow--open"),(r=t.nextElementSibling)==null||r.remove(),d.getLeaf(t,i))}),!0));window.siyuan.menus.menu.append(new MenuItem({id:"sort",icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element)}return window.siyuan.config.readonly||window.siyuan.menus.menu.append(new MenuItem({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{fetchPost("/api/riff/getNotebookRiffDueCards",{notebook:i},o=>{openCardByData(e,o.data,"notebook",i,s)}),closePanel()}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{viewCards(e,i,s,"Notebook"),closePanel()}}]}).element),window.siyuan.menus.menu.append(new MenuItem({id:"search",label:window.siyuan.languages.search,accelerator:window.siyuan.config.keymap.general.search.custom,icon:"iconSearch",click(){popSearch(e,{hasReplace:!1,hPath:getNotebookName(i),idPath:[i],page:1})}}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new MenuItem({id:"replace",label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){popSearch(e,{hasReplace:!0,hPath:getNotebookName(i),idPath:[i],page:1})}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"close",label:window.siyuan.languages.close,icon:"iconClose",click:()=>{fetchPost("/api/notebook/closeNotebook",{notebook:i})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{deleteFiles(Array.from(n.querySelectorAll(".b3-list-item--focus")))}}).element)),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),ns(i,"/"),window.siyuan.menus.menu.append(new MenuItem({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportMarkdown",label:"Markdown",icon:"iconMarkdown",click:()=>{const o=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/batchExportMd",{notebook:i,path:"/"},l=>{hideMessage(o),openByMobile(l.data.zip)})}},{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const o=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportNotebookSY",{id:i},l=>{hideMessage(o),openByMobile(l.data.zip)})}}]}).element),e.plugins&&emitOpenMenu({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:a,type:"notebook"},separatorPosition:"top"}),window.siyuan.menus.menu},uc=(e,t,n,a)=>{window.siyuan.menus.menu.remove();const i=hasClosestByTag(a,"DIV");if(!i)return window.siyuan.menus.menu;a.classList.contains("b3-list-item--focus")||(i.querySelectorAll(".b3-list-item--focus").forEach(r=>{r.classList.remove("b3-list-item--focus"),r.removeAttribute("select-end"),r.removeAttribute("select-start")}),a.classList.add("b3-list-item--focus"));const s=i.querySelectorAll(".b3-list-item--focus");if(s.length>1)return ts(s,e);const o=a.getAttribute("data-node-id");let l=a.getAttribute("data-name");if(l=getDisplayName(l,!1,!0),!window.siyuan.config.readonly){let r,d;const c=hasTopClosestByTag(a,"UL");if((window.siyuan.config.fileTree.sort===6||c&&c.dataset.sortmode==="6")&&(window.siyuan.menus.menu.append(new MenuItem({id:"newDocAbove",icon:"iconBefore",label:window.siyuan.languages.newDocAbove,click:()=>{const u=[];Array.from(a.parentElement.children).forEach(f=>{f.tagName==="LI"&&(f.isSameNode(a)&&u.push(void 0),u.push(f.getAttribute("data-path")))}),newFile({app:e,notebookId:t,currentPath:pathPosix().dirname(n),paths:u,useSavePath:!1})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"newDocBelow",icon:"iconAfter",label:window.siyuan.languages.newDocBelow,click:()=>{const u=[];Array.from(a.parentElement.children).forEach(f=>{f.tagName==="LI"&&(u.push(f.getAttribute("data-path")),f.isSameNode(a)&&u.push(void 0))}),newFile({app:e,notebookId:t,currentPath:pathPosix().dirname(n),paths:u,useSavePath:!1})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element)),window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:copySubMenu(o,!1).concat([{id:"duplicate",iconHTML:"",label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){fetchPost("/api/filetree/duplicateDoc",{id:o})}}])}).element),window.siyuan.menus.menu.append(movePathToMenu(getTopPaths(Array.from(i.querySelectorAll(".b3-list-item--focus"))))),window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{addFilesToDatabase([a])}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{deleteFiles(Array.from(i.querySelectorAll(".b3-list-item--focus")))}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(renameMenu({path:n,notebookId:t,name:l,type:"file"})),window.siyuan.menus.menu.append(new MenuItem({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",click(){fetchPost("/api/block/getDocInfo",{id:o},u=>{openFileAttr(u.data.ial)})}}).element),!window.siyuan.config.readonly){const u=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{fetchPost("/api/riff/getTreeRiffDueCards",{rootID:o},f=>{openCardByData(e,f.data,"doc",o,l)}),closePanel()}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{fetchPost("/api/filetree/getHPathByID",{id:o},f=>{viewCards(e,o,pathPosix().join(getNotebookName(t),f.data),"Tree")}),closePanel()}},{id:"quickMakeCard",iconHTML:"",accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{transaction(void 0,[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[o]}],[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[o]}])}},{id:"removeCard",iconHTML:"",label:window.siyuan.languages.removeCard,click:()=>{transaction(void 0,[{action:"removeFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[o]}],[{action:"addFlashcards",deckID:Constants.QUICK_DECK_ID,blockIDs:[o]}])}}];window.siyuan.config.flashcard.deck&&u.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{makeCard(e,[o])}}),window.siyuan.menus.menu.append(new MenuItem({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:u}).element)}window.siyuan.menus.menu.append(new MenuItem({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return es(this,null,function*(){const u=getDisplayName(n,!1,!0),f=yield fetchSyncPost("/api/filetree/getHPathByPath",{notebook:t,path:u+".sy"});popSearch(e,{hasReplace:!1,hPath:pathPosix().join(getNotebookName(t),f.data),idPath:[pathPosix().join(t,u)],page:1})})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"replace",label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){return es(this,null,function*(){const u=getDisplayName(n,!1,!0),f=yield fetchSyncPost("/api/filetree/getHPathByPath",{notebook:t,path:u+".sy"});popSearch(e,{hasReplace:!0,hPath:pathPosix().join(getNotebookName(t),f.data),idPath:[pathPosix().join(t,u)],page:1})})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"separator_3",type:"separator"}).element)}return openEditorTab(e,[o],t,n),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new MenuItem({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){openDocHistory({app:e,id:o,notebookId:t,pathString:l})}}).element),ns(t,n),window.siyuan.menus.menu.append(exportMd(o)),e.plugins&&emitOpenMenu({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:s,type:"doc"},separatorPosition:"top"}),window.siyuan.menus.menu},ns=(e,t)=>{if(window.siyuan.config.readonly)return;const n=()=>{var a;let i;i=window.siyuan.mobile.files;const s=i.element.querySelector(`[data-path="${t}"]`),o=s.querySelector(".b3-list-item__arrow--open");o&&(o.classList.remove("b3-list-item__arrow--open"),(a=s.nextElementSibling)==null||a.remove()),i.getLeaf(s,e),window.siyuan.menus.menu.remove()};window.siyuan.menus.menu.append(new MenuItem({id:"import",icon:"iconDownload",label:window.siyuan.languages.import,submenu:[{id:"importSiYuanZip",icon:"iconSiYuan",label:'SiYuan .sy.zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:a=>{a.querySelector(".b3-form__upload").addEventListener("change",i=>{const s=new FormData;s.append("file",i.target.files[0]),s.append("notebook",e),s.append("toPath",t),fetchPost("/api/import/importSY",s,()=>{n()})})}}]}).element)},go=(e,t,n)=>{const a=[{id:"fileNameASC",icon:t===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{n(0)}},{id:"fileNameDESC",icon:t===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{n(1)}},{id:"fileNameNatASC",icon:t===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{n(4)}},{id:"fileNameNatDESC",icon:t===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{n(5)}},{id:"separator_1",type:"separator"},{id:"createdASC",icon:t===9?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{n(9)}},{id:"createdDESC",icon:t===10?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{n(10)}},{id:"modifiedASC",icon:t===2?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{n(2)}},{id:"modifiedDESC",icon:t===3?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{n(3)}},{id:"separator_2",type:"separator"},{id:"refCountASC",icon:t===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{n(7)}},{id:"refCountDESC",icon:t===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{n(8)}},{id:"separator_3",type:"separator"},{id:"docSizeASC",icon:t===11?"iconSelect":void 0,label:window.siyuan.languages.docSizeASC,click:()=>{n(11)}},{id:"docSizeDESC",icon:t===12?"iconSelect":void 0,label:window.siyuan.languages.docSizeDESC,click:()=>{n(12)}},{id:"separator_4",type:"separator"},{id:"subDocCountASC",icon:t===13?"iconSelect":void 0,label:window.siyuan.languages.subDocCountASC,click:()=>{n(13)}},{id:"subDocCountDESC",icon:t===14?"iconSelect":void 0,label:window.siyuan.languages.subDocCountDESC,click:()=>{n(14)}},{id:"separator_5",type:"separator"},{id:"customSort",icon:t===6?"iconSelect":void 0,label:window.siyuan.languages.customSort,click:()=>{n(6)}}];return e==="notebook"&&a.push({id:"sortByFiletree",icon:t===15?"iconSelect":void 0,label:window.siyuan.languages.sortByFiletree,click:()=>{n(15)}}),a};var po=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const fc=(e,t)=>{if(hideTooltip(),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="titleMenu"){window.siyuan.menus.menu.remove();return}fetchPost("/api/block/getDocInfo",{id:e.block.rootID},n=>{var a;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","titleMenu"),window.siyuan.menus.menu.append(new MenuItem({id:"copy",label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:copySubMenu(e.block.rootID)}).element),!e.disabled){window.siyuan.menus.menu.append(movePathToMenu([e.path]));const i=getSelection().rangeCount>0?getSelection().getRangeAt(0):void 0;window.siyuan.menus.menu.append(new MenuItem({id:"addToDatabase",label:window.siyuan.languages.addToDatabase,accelerator:window.siyuan.config.keymap.general.addToDatabase.custom,icon:"iconDatabase",click:()=>{addEditorToDatabase(e,i,"title")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"delete",icon:"iconTrashcan",label:window.siyuan.languages.delete,click:()=>{deleteFile(e.notebookId,e.path)}}).element)}if(window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"attr",label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+updateHotkeyTip("\u21E7"+window.siyuan.languages.click),click(){openFileAttr(n.data.ial,"bookmark",e)}}).element),!window.siyuan.config.readonly){window.siyuan.menus.menu.append(new MenuItem({id:"wechatReminder",label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){openFileWechatNotify(e)}}).element);const i=[{id:"spaceRepetition",iconHTML:"",label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{fetchPost("/api/riff/getTreeRiffDueCards",{rootID:e.block.rootID},s=>{openCardByData(e.app,s.data,"doc",e.block.rootID,s.data.name)})}},{id:"manage",iconHTML:"",label:window.siyuan.languages.manage,click:()=>{fetchPost("/api/filetree/getHPathByID",{id:e.block.rootID},s=>{viewCards(e.app,e.block.rootID,pathPosix().join(getNotebookName(e.notebookId),s.data),"Tree")})}},{id:"quickMakeCard",iconHTML:"",label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click:()=>{var s;let o=(s=e.title)==null?void 0:s.element;o||(o=document.createElement("div"),o.setAttribute("data-node-id",e.block.rootID),o.setAttribute(Constants.CUSTOM_RIFF_DECKS,n.data.ial[Constants.CUSTOM_RIFF_DECKS])),quickMakeCard(e,[o])}}];window.siyuan.config.flashcard.deck&&i.push({id:"addToDeck",iconHTML:"",label:window.siyuan.languages.addToDeck,click:()=>{makeCard(e.app,[e.block.rootID])}}),window.siyuan.menus.menu.append(new MenuItem({id:"riffCard",label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:i}).element)}window.siyuan.menus.menu.append(new MenuItem({id:"search",label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return po(this,null,function*(){const i=getDisplayName(e.path,!1,!0),s=yield fetchSyncPost("/api/filetree/getHPathByPath",{notebook:e.notebookId,path:i+".sy"});popSearch(e.app,{hasReplace:!1,hPath:pathPosix().join(getNotebookName(e.notebookId),s.data),idPath:[pathPosix().join(e.notebookId,i)],page:1})})}}).element),e.disabled||transferBlockRef(e.block.rootID),window.siyuan.menus.menu.append(new MenuItem({id:"separator_3",type:"separator"}).element),e.disabled||window.siyuan.menus.menu.append(new MenuItem({id:"fileHistory",label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){openDocHistory({app:e.app,id:e.block.rootID,notebookId:e.notebookId,pathString:n.data.name})}}).element),genImportMenu(e.notebookId,e.path),window.siyuan.menus.menu.append(exportMd(e.block.showAll?e.block.id:e.block.rootID)),window.siyuan.menus.menu.append(new MenuItem({id:"separator_4",type:"separator"}).element),(a=e==null?void 0:e.app)!=null&&a.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"click-editortitleicon",detail:{protyle:e,data:n.data},separatorPosition:"bottom"}),window.siyuan.menus.menu.append(new MenuItem({id:"updateAndCreatedAt",iconHTML:"",type:"readonly",label:`${window.siyuan.languages.modifiedAt} ${dayjs(n.data.ial.updated).format("YYYY-MM-DD HH:mm:ss")}<br>${window.siyuan.languages.createdAt} ${dayjs(n.data.ial.id.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu.fullscreen()})};var mo=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});class gc{constructor(t){const n=document.createElement("div");n.className="protyle-breadcrumb";let a="";n.innerHTML=`${isMobile()?`<button class="protyle-breadcrumb__icon" data-type="mobile-menu">${window.siyuan.languages.breadcrumb}</button>`:'<div class="protyle-breadcrumb__bar"></div>'}
<span class="protyle-breadcrumb__space"></span>
<button class="protyle-breadcrumb__icon fn__none ariaLabel" aria-label="${updateHotkeyTip(window.siyuan.config.keymap.editor.general.exitFocus.custom)}" data-type="exit-focus">${window.siyuan.languages.exitFocus}</button>
${a}
<button class="block__icon fn__flex-center ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.lockEdit}" data-type="readonly"><svg><use xlink:href="#iconUnlock"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="doc" aria-label="${isMac()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}"><svg><use xlink:href="#iconFile"></use></svg></button>
<button class="block__icon fn__flex-center ariaLabel" data-type="more" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>
<button class="block__icon fn__flex-center fn__none ariaLabel" data-type="context" aria-label="${window.siyuan.languages.context}"><svg><use xlink:href="#iconAlignCenter"></use></svg></button>`,this.element=n.firstElementChild,n.addEventListener("click",i=>{let s=i.target;for(;s&&!s.isEqualNode(n);){const o=s.getAttribute("data-node-id"),l=s.getAttribute("data-type");if(o){i.preventDefault();break}else if(l==="mobile-menu"){this.genMobileMenu(t),i.preventDefault(),i.stopPropagation();break}else if(l==="doc"){if(window.siyuan.shiftIsPressed)fetchPost("/api/block/getDocInfo",{id:t.block.rootID},r=>{openFileAttr(r.data.ial,"bookmark",t)});else{const r=s.getBoundingClientRect();openTitleMenu(t,{x:r.right,y:r.bottom,isLeft:!0})}i.stopPropagation(),i.preventDefault();break}else if(l==="more"){const r=s.getBoundingClientRect();this.showMenu(t,{x:r.right,y:r.bottom,isLeft:!0}),i.stopPropagation(),i.preventDefault();break}else if(l==="readonly"){updateReadonly(s,t),i.stopPropagation(),i.preventDefault();break}else if(l==="exit-focus"){zoomOut({protyle:t,id:t.block.rootID,focusId:t.block.id}),i.stopPropagation(),i.preventDefault();break}else if(l==="context"){i.stopPropagation(),i.preventDefault(),s.classList.contains("block__icon--active")?(zoomOut({protyle:t,id:t.options.blockId}),s.classList.remove("block__icon--active")):(fetchPost("/api/filetree/getDoc",{id:t.options.blockId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},r=>{onGet({data:r,protyle:t,action:[Constants.CB_GET_HL]})}),s.classList.add("block__icon--active"));break}else if(l==="undo"){t.undo.undo(t),i.preventDefault(),i.stopPropagation();break}else if(l==="redo"){t.undo.redo(t),i.preventDefault(),i.stopPropagation();break}else if(l==="outdent"){if(t.toolbar.range){const r=hasClosestBlock(t.toolbar.range.startContainer);r&&listOutdent(t,[r.parentElement],t.toolbar.range)}i.preventDefault(),i.stopPropagation();break}else if(l==="indent"){if(t.toolbar.range){const r=hasClosestBlock(t.toolbar.range.startContainer);r&&listIndent(t,[r.parentElement],t.toolbar.range)}i.preventDefault(),i.stopPropagation();break}s=s.parentElement}}),n.addEventListener("mouseleave",()=>{t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(i=>{i.classList.remove("protyle-wysiwyg--hl")})}),this.element.addEventListener("mouseover",i=>{if(!t.selectElement.classList.contains("fn__none"))return;const s=i.target,o=hasClosestByAttribute(s,"data-node-id",null);if(o){t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(r=>{r.classList.remove("protyle-wysiwyg--hl")});const l=t.wysiwyg.element.querySelector(`[data-node-id="${o.getAttribute("data-node-id")}"]`);l&&l.classList.add("protyle-wysiwyg--hl")}}),this.element.addEventListener("mousewheel",i=>{this.element.scrollLeft=this.element.scrollLeft+i.deltaY},{passive:!0})}startRecord(t){this.messageId=showMessage(`<div class="fn__flex fn__flex-wrap">
<span class="fn__flex-center">${window.siyuan.languages.recording}</span><span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.endRecord}</button></div>`,-1),document.querySelector(`#message [data-id="${this.messageId}"] button`).addEventListener("click",()=>{this.mediaRecorder.stopRecording(),hideMessage(this.messageId);const n=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});uploadFiles(t,[n])}),this.mediaRecorder.startRecordingNewWavFile()}genMobileMenu(t){const n=new Menu("breadcrumb-mobile-path");let a;if(getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);!t.wysiwyg.element.isEqualNode(s.startContainer)&&!t.wysiwyg.element.contains(s.startContainer)?a=getNoContainerElement(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild:a=hasClosestBlock(s.startContainer)}a||(a=getNoContainerElement(t.wysiwyg.element.firstElementChild)||t.wysiwyg.element.firstElementChild);const i=a.getAttribute("data-node-id");fetchPost("/api/block/getBlockBreadcrumb",{id:i,excludeTypes:[]},s=>{s.data.forEach(o=>{let l=!1;(!t.block.showAll&&o.id===t.block.parentID||t.block.showAll&&o.id===t.block.id)&&(l=!0),n.addItem({current:l,icon:getIconByType(o.type,o.subType),label:o.name,click(){zoomOut({protyle:t,id:o.id,focusId:i})}})}),n.fullscreen()})}toggleExit(t){const n=this.element.parentElement.querySelector('[data-type="exit-focus"]');t?n.classList.add("fn__none"):n.classList.remove("fn__none")}showMenu(t,n){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="breadcrumbMore"){window.siyuan.menus.menu.remove();return}let a;const i=hasClosestBlock(getEditorRange(t.element).startContainer);i&&(a=i.getAttribute("data-node-id")),fetchPost("/api/block/getTreeStat",{id:a||(t.block.showAll?t.block.id:t.block.rootID)},s=>{var o,l,r,d;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","breadcrumbMore"),!t.contentElement.classList.contains("fn__none")&&!t.disabled){let c="";c='<input class="b3-form__upload" type="file" multiple="multiple"',t.options.upload.accept?c+=` accept="${t.options.upload.accept}">`:c+=">";const u=new MenuItem({id:"insertAsset",icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${c}`}).element;u.querySelector("input").addEventListener("change",f=>{f.target.files.length!==0&&(uploadFiles(t,f.target.files,f.target),window.siyuan.menus.menu.remove())}),window.siyuan.menus.menu.append(u),isInAndroid()||window.siyuan.menus.menu.append(new MenuItem({id:(o=this.mediaRecorder)!=null&&o.isRecording?"endRecord":"startRecord",current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:(l=this.mediaRecorder)!=null&&l.isRecording?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:()=>mo(this,null,function*(){if(!this.mediaRecorder){navigator.mediaDevices.getUserMedia({audio:!0}).then(f=>{this.mediaRecorder=new RecordMedia(f),this.mediaRecorder.recorder.onaudioprocess=g=>{if(!this.mediaRecorder.isRecording)return;const p=g.inputBuffer.getChannelData(0),m=g.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(p,m)},this.startRecord(t)}).catch(()=>{showMessage(window.siyuan.languages["record-tip"])});return}if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),hideMessage(this.messageId);const f=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});uploadFiles(t,[f])}else hideMessage(this.messageId),this.startRecord(t)})}).element)}if(t.disabled||(window.siyuan.menus.menu.append(new MenuItem({id:"netImg2LocalAsset",label:window.siyuan.languages.netImg2LocalAsset,icon:"iconImgDown",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){net2LocalAssets(t,"Img")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"netAssets2LocalAssets",label:window.siyuan.languages.netAssets2LocalAssets,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,click(){net2LocalAssets(t,"Assets")}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"uploadAssets2CDN",label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloudSucc",click(){needSubscribe()||confirmDialog("\u{1F4E6} "+window.siyuan.languages.uploadAssets2CDN,window.siyuan.languages.uploadAssets2CDNConfirmTip,()=>{fetchPost("/api/asset/uploadCloud",{id:t.block.parentID})})}}).element),window.siyuan.user&&window.siyuan.menus.menu.append(new MenuItem({id:"share2Liandi",label:window.siyuan.languages.share2Liandi,icon:"iconLiandi",click(){confirmDialog("\u{1F680} "+window.siyuan.languages.share2Liandi,window.siyuan.languages.share2LiandiConfirmTip,()=>{fetchPost("/api/export/export2Liandi",{id:t.block.parentID})})}}).element)),(r=t.scroll)!=null&&r.element.classList.contains("fn__none")||window.siyuan.menus.menu.append(new MenuItem({id:"keepLazyLoad",current:t.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{t.scroll.keepLazyLoad=!t.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.element.lastElementChild.childElementCount>0&&window.siyuan.menus.menu.append(new MenuItem({id:"separator_1",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"refresh",icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{reloadProtyle(t,!isMobile())}}).element),t.disabled||window.siyuan.menus.menu.append(new MenuItem({id:"optimizeTypography",label:window.siyuan.languages.optimizeTypography,accelerator:window.siyuan.config.keymap.editor.general.optimizeTypography.custom,icon:"iconFormat",click:()=>{hideElements(["toolbar"],t),fetchPost("/api/format/autoSpace",{id:t.block.rootID})}}).element),window.siyuan.menus.menu.append(new MenuItem({id:"editMode",icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:[{id:"wysiwyg",current:!t.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{setEditMode(t,"wysiwyg"),t.scroll.lastScrollTop=0,fetchPost("/api/filetree/getDoc",{id:t.block.parentID,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{onGet({data:c,protyle:t})})}},{id:"preview",current:!t.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{setEditMode(t,"preview"),window.siyuan.menus.menu.remove()}}]}).element),!window.siyuan.config.editor.readOnly&&!window.siyuan.config.readonly){const c=t.wysiwyg.element.getAttribute(Constants.CUSTOM_SY_READONLY);window.siyuan.menus.menu.append(new MenuItem({id:"editReadonly",label:window.siyuan.languages.editReadonly,icon:"iconLock",type:"submenu",submenu:[{id:"enable",iconHTML:"",current:c==="true",label:window.siyuan.languages.enable,click(){fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[Constants.CUSTOM_SY_READONLY]:"true"}})}},{id:"disable",iconHTML:"",current:!c||c==="false",label:window.siyuan.languages.disable,click(){fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{[Constants.CUSTOM_SY_READONLY]:"false"}})}}]}).element)}(d=t==null?void 0:t.app)!=null&&d.plugins&&emitOpenMenu({plugins:t.app.plugins,type:"open-menu-breadcrumbmore",detail:{protyle:t,data:s.data},separatorPosition:"top"}),window.siyuan.menus.menu.append(new MenuItem({id:"separator_2",type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({id:"docInfo",iconHTML:"",type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.runeCount}<span class="fn__space fn__flex-1"></span>${s.data.runeCount}</div><div class="fn__flex">${window.siyuan.languages.wordCount}<span class="fn__space fn__flex-1"></span>${s.data.wordCount}</div><div class="fn__flex">${window.siyuan.languages.linkCount}<span class="fn__space fn__flex-1"></span>${s.data.linkCount}</div><div class="fn__flex">${window.siyuan.languages.imgCount}<span class="fn__space fn__flex-1"></span>${s.data.imageCount}</div><div class="fn__flex">${window.siyuan.languages.refCount}<span class="fn__space fn__flex-1"></span>${s.data.refCount}</div>`}).element),window.siyuan.menus.menu.fullscreen()})}render(t,n=!1,a){}hide(){isMobile()||(this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0)}}class pc{constructor(t){this.element=document.createElement("div"),this.element.className="protyle-title",window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.element.innerHTML='<div class="protyle-attr"></div>',this.element.querySelector(".protyle-attr").addEventListener("click",n=>{fetchPost("/api/block/getDocInfo",{id:t.block.rootID},a=>{commonClick(n,t,a.data.ial)})})}rename(t){if(clearTimeout(this.timeout),!validateName(this.editElement.textContent,this.editElement)){const n=getSelectionOffset(this.editElement);return this.setTitle(this.editElement.textContent.substring(0,Constants.SIZE_TITLE)),focusByOffset(this.editElement,n.start,n.end),!1}hideTooltip(),this.timeout=window.setTimeout(()=>{const n=replaceFileName(this.editElement.textContent);fetchPost("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:n}),this.setTitle(n),setTitle(n)},Constants.TIMEOUT_INPUT)}setTitle(t){const n=document.getElementById("toolbarName");code160to32(t)!==code160to32(n.value)&&(n.value=t===window.siyuan.languages.untitled?"":t)}render(t,n){var a;if(this.element.getAttribute("data-render")==="true")return!1;this.element.setAttribute("data-node-id",t.block.rootID),n.data.ial[Constants.CUSTOM_RIFF_DECKS]&&this.element.setAttribute(Constants.CUSTOM_RIFF_DECKS,n.data.ial[Constants.CUSTOM_RIFF_DECKS]),(a=t.background)==null||a.render(n.data.ial,t.block.rootID),t.wysiwyg.renderCustom(n.data.ial),this.element.setAttribute("data-render","true"),this.setTitle(n.data.ial.title);let i="";if(n.data.ial.bookmark&&(i+=`<div class="protyle-attr--bookmark">${Lute.EscapeHTMLStr(n.data.ial.bookmark)}</div>`),n.data.ial.name&&(i+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${Lute.EscapeHTMLStr(n.data.ial.name)}</div>`),n.data.ial.alias&&(i+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${Lute.EscapeHTMLStr(n.data.ial.alias)}</div>`),n.data.ial.memo&&(i+=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${Lute.EscapeHTMLStr(n.data.ial.memo)}"><svg><use xlink:href="#iconM"></use></svg></div>`),n.data.ial["custom-avs"]){let s="";n.data.attrViews.forEach(o=>{s+=`<span data-av-id="${o.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block">${o.name}</span>&nbsp;`}),s&&(s=s.substring(0,s.length-6)),i+=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${s}</div>`}if(this.element.querySelector(".protyle-attr").innerHTML=i,n.data.refCount!==0&&this.element.querySelector(".protyle-attr").insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block" data-defids='${JSON.stringify([t.block.rootID])}' data-id='${JSON.stringify(n.data.refIDs)}'>${n.data.refCount}</div>`),this.editElement&&new Date().getTime()-dayjs(n.data.id.split("-")[0]).toDate().getTime()<2e3){const s=this.editElement.ownerDocument.createRange();s.selectNodeContents(this.editElement),focusByRange(s)}}}var as=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const rn=null;class mc{constructor(t){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">
    <img src="${this.transparentData}">
    <div class="protyle-icons">
        <span class="protyle-icon protyle-icon--first" style="position: relative;overflow: hidden"><input aria-label="${window.siyuan.languages.upload}" class="ariaLabel" data-position="right4bottom" type="file" style="position: absolute;height: 100%;top: 0;right: 0;opacity: .001;overflow: hidden;cursor: pointer;"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-position="right4bottom" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-position="right4bottom" data-type="asset" aria-label="${window.siyuan.languages.assets}"><svg><use xlink:href="#iconImage"></use></svg></span>
        <span class="protyle-icon ariaLabel" data-position="right4bottom" data-type="show-random" aria-label="${window.siyuan.languages.builtIn}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="protyle-icon ariaLabel fn__none" data-position="right4bottom" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>
        <span class="protyle-icon protyle-icon--last ariaLabel" data-position="right4bottom" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>
    <div class="protyle-icons fn__none" style="opacity: .86;">
        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>
        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>
    </div>
</div>
<div class="protyle-background__ia">
    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>
    <div class="b3-chips fn__none"></div>
    <div class="protyle-background__action">
        <button class="b3-button b3-button--cancel" data-menu="true" data-type="tag">
            <svg><use xlink:href="#iconTags"></use></svg>
            ${window.siyuan.languages.addTag}
        </button>
        <button class="b3-button b3-button--cancel" data-type="icon">
            <svg><use xlink:href="#iconEmoji"></use></svg>
            ${window.siyuan.languages.addIcon}
        </button>
        <button class="b3-button b3-button--cancel" data-type="random">
            <svg><use xlink:href="#iconImage"></use></svg>
            ${window.siyuan.languages.titleBg}
        </button>
    </div>
</div>`,this.tagsElement=this.element.querySelector(".b3-chips"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.querySelector(".protyle-background__img img"),this.actionElements=this.element.querySelectorAll(".protyle-background__action:not(.fn__flex-center) .b3-button"),this.element.addEventListener("dragover",n=>as(this,null,function*(){n.preventDefault()})),this.element.addEventListener("drop",n=>as(this,null,function*(){n.dataTransfer.types[0]==="Files"&&n.dataTransfer.files[0].type.indexOf("image")!==-1&&uploadFiles(t,[n.dataTransfer.files[0]],void 0,a=>{const i=JSON.parse(a),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":s}})})})),this.imgElement.addEventListener("mousedown",n=>{if(n.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const a=n.clientY,i=document,s=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let o=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(o=-parseInt(this.imgElement.style.objectPosition.substring(7))/s*100),i.onmousemove=l=>{this.imgElement.style.objectPosition=`center ${((a-l.clientY)/s*100+o).toFixed(2)}%`,n.preventDefault()},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null}}),this.element.querySelector("input").addEventListener("change",n=>{n.target.files.length!==0&&uploadFiles(t,n.target.files,n.target,a=>{const i=JSON.parse(a),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":s}})})}),this.element.addEventListener(getEventName(),n=>{if(t.disabled)return;let a=n.target;for(hideElements(["gutter"],t);a&&!a.isEqualNode(this.element);){const i=a.getAttribute("data-type");if(a.tagName==="IMG"&&a.parentElement.classList.contains("protyle-background__img")){const s=a.getAttribute("src");n.detail>1&&!s.startsWith("data:image/png;base64")&&(previewImage(s),n.preventDefault(),n.stopPropagation()),window.siyuan.menus.menu.remove();break}else if(i==="position"){const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");s[0].classList.add("fn__none"),s[1].classList.remove("fn__none"),s[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",n.preventDefault(),n.stopPropagation();break}else if(i==="cancel"||i==="confirm"){this.imgElement.style.cursor="";const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(s[0].classList.remove("fn__none"),s[1].classList.add("fn__none"),s[2].classList.add("fn__none"),i==="confirm"){const o=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=o,fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":o}})}else this.render(this.ial,t.block.rootID);n.preventDefault(),n.stopPropagation();break}else if(i==="open-emoji"){const s=this.iconElement.getBoundingClientRect();openEmojiPanel(t.block.rootID,"doc",{x:s.left,y:s.bottom,h:s.height,w:s.width}),n.preventDefault(),n.stopPropagation();break}else if(i==="show-random"){let s="";rn.forEach((l,r)=>{s+=`<div data-index="${r}" style="height: 128px;${l}" class="b3-card b3-card--wrap"></div>`});const o=new Dialog({title:window.siyuan.languages.builtIn,content:`<div class="b3-cards">${s}</div>`,width:isMobile()?"92vw":"912px",height:isMobile()?"80vh":"70vh"});o.element.setAttribute("data-key",Constants.DIALOG_BACKGROUNDRANDOM),o.element.addEventListener("click",l=>{const r=l.target;r.classList.contains("b3-card")&&(this.ial["title-img"]=rn[parseInt(r.getAttribute("data-index"))],this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),o.destroy())}),n.preventDefault(),n.stopPropagation();break}else if(i==="random"){this.ial["title-img"]=rn[getRandom(0,rn.length-1)],this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),n.preventDefault(),n.stopPropagation();break}else if(i==="asset"){const s=a.getBoundingClientRect();assetMenu(t,{x:a.parentElement.getBoundingClientRect().right,y:s.bottom+8,isLeft:!0},o=>{this.ial["title-img"]=`background-image:url("${o}")`,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),window.siyuan.menus.menu.remove()},Constants.SIYUAN_ASSETS_IMAGE),n.preventDefault(),n.stopPropagation();break}else if(i==="remove"){delete this.ial["title-img"],this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":""}}),n.preventDefault(),n.stopPropagation();break}else if(i==="icon"){const s=getRandomEmoji();if(s){updateFileTreeEmoji(s,t.block.rootID),updateOutlineEmoji(s,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{icon:s}}),t.model&&t.model.parent.setDocIcon(s),this.iconElement.classList.remove("fn__none");const o=this.iconElement.getBoundingClientRect();openEmojiPanel(t.block.rootID,"doc",{x:o.left,y:o.bottom,h:o.height,w:o.width})}n.preventDefault(),n.stopPropagation();break}else if(i==="tag"){this.openTag(t,a),n.preventDefault(),n.stopPropagation();break}else if(i==="link"){const s=new Dialog({title:window.siyuan.languages.link,width:isMobile()?"92vw":"520px",content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" value="${this.imgElement.src.startsWith("data:")?"":this.imgElement.getAttribute("src")}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});s.element.setAttribute("data-key",Constants.DIALOG_BACKGROUNDLINK);const o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{const l=`background-image:url("${s.element.querySelector("input").value}");`;this.ial["title-img"]=l,this.render(this.ial,t.block.rootID),fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),s.destroy()}),s.element.querySelector("input").focus(),n.preventDefault(),n.stopPropagation();break}else if(i==="open-search"){popSearch(t.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${a.textContent}#`,r:"",page:1}),n.preventDefault(),n.stopPropagation();break}else if(i==="remove-tag"){a.parentElement.remove(),this.removeTag(t),n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})}removeTag(t){const n=this.getTags();fetchPost("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{tags:n.toString()}}),n.length===0?delete this.ial.tags:this.ial.tags=n.toString(),this.render(this.ial,t.block.rootID)}render(t,n){var a;const i=t["title-img"],s=t.icon,o=t.tags;if(this.ial=t,this.element.setAttribute("data-node-id",n),o){let l="";const r=["secondary","primary","info","success","warning","error","pink"];o.split(",").forEach((d,c)=>{l+=`<div class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${r[c%7]}" data-type="open-search">${d}<svg class="b3-chip__close" data-type="remove-tag"><use xlink:href="#iconCloseRound"></use></svg></div>`}),this.tagsElement.innerHTML=`${l}<span class="fn__space"></span>
<div class="protyle-background__action fn__flex-center">
    <button class="b3-button b3-button--cancel" style="margin-top: 0" data-menu="true" data-type="tag"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addTag}</button>
</div>`,this.tagsElement.classList.remove("fn__none"),this.actionElements[0].classList.add("fn__none")}else this.tagsElement.classList.add("fn__none"),this.actionElements[0].classList.remove("fn__none");if(s?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=unicode2Emoji(s),this.actionElements[1].classList.add("fn__none")):(this.actionElements[1].classList.remove("fn__none"),this.iconElement.classList.add("fn__none")),i){if(this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(i)),i.indexOf("url(")>-1){const l=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,r=(a=this.imgElement.style.backgroundImage)==null?void 0:a.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",r),this.imgElement.style.objectPosition=l,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");this.actionElements[2].classList.add("fn__none"),this.imgElement.parentElement.classList.remove("fn__none"),this.iconElement.style.marginTop="",this.imgElement.style.height="200px"}else this.imgElement.parentElement.classList.add("fn__none"),this.actionElements[2].classList.remove("fn__none"),this.iconElement.style.marginTop="8px"}openTag(t,n){window.siyuan.menus.menu.remove();const a=new Menu;a.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages.tag}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind:s=>{const o=s.querySelector(".b3-list--background");fetchPost("/api/search/searchTag",{k:""},r=>{let d="";r.data.tags.forEach((c,u)=>{d+=`<div class="b3-list-item b3-list-item--narrow${u===0?" b3-list-item--focus":""}">${c}</div>`}),o.innerHTML=d});const l=s.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),!r.isComposing)if(upDownHint(o,r),r.key==="Enter"){const d=o.querySelector(".b3-list-item--focus");d?this.addTags(d.textContent,t):this.addTags(l.value,t),window.siyuan.menus.menu.remove()}else r.key==="Escape"&&window.siyuan.menus.menu.remove()}),l.addEventListener("input",r=>{r.stopPropagation(),fetchPost("/api/search/searchTag",{k:l.value},d=>{let c="",u=!1;d.data.tags.forEach(f=>{c+=`<div class="b3-list-item b3-list-item--narrow">${f}</div>`,f===`<mark>${d.data.k}</mark>`&&(u=!0)}),!u&&d.data.k&&(c=`<div class="b3-list-item b3-list-item--narrow"><mark>${d.data.k}</mark></div>`+c),o.innerHTML=c,o.firstElementChild.classList.add("b3-list-item--focus")})}),o.addEventListener("click",r=>{const d=r.target,c=hasClosestByClassName(d,"b3-list-item");c&&this.addTags(c.textContent,t)})}}),a.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial");const i=n.getBoundingClientRect();a.open({x:i.left,y:i.top+i.height}),a.element.querySelector("input").focus()}getTags(t){const n=[];return this.tagsElement.querySelectorAll(".b3-chip").forEach(a=>{const i=a.textContent.trim();t&&i===t&&a.remove(),n.push(i)}),n}addTags(t,n){const a=this.getTags(t);if(a.includes(t)){this.removeTag(n);return}a.push(t),fetchPost("/api/attr/setBlockAttrs",{id:n.block.rootID,attrs:{tags:a.toString()}}),this.ial.tags=a.toString(),this.render(this.ial,n.block.rootID)}}const Kn=(e,t)=>{fetchPost("/api/filetree/createDailyNote",{notebook:t,app:Constants.SIYUAN_APPID},n=>{openMobileFileById(e,n.data.id)})},bc=e=>{if(window.siyuan.dialogs.find(s=>{if(s.element.getAttribute("data-key")===Constants.DIALOG_DIALYNOTE)return s.destroy(),!0}))return;const n=getOpenNotebookCount();if(n===0){showMessage(window.siyuan.languages.newFileTip);return}if(n===1){let s="";window.siyuan.notebooks.find(o=>{o.closed||(s=o.id)}),Kn(e,s);return}const a=window.siyuan.storage[Constants.LOCAL_DAILYNOTEID],i=window.siyuan.notebooks.find(s=>{if(s.id===a&&!s.closed)return!0});if(a&&i&&!isMobile())Kn(e,a);else{let s="";window.siyuan.notebooks.forEach(d=>{d.closed||(s+=`<option value="${d.id}">${d.name}</option>`)});const o=new Dialog({positionId:Constants.DIALOG_DIALYNOTE,title:window.siyuan.languages.plsChoose,content:`<div class="b3-dialog__content">
    <select class="b3-select fn__block">${s}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});o.element.setAttribute("data-key",Constants.DIALOG_DIALYNOTE);const l=o.element.querySelectorAll(".b3-button"),r=o.element.querySelector(".b3-select");r.value=a,l[0].addEventListener("click",()=>{o.destroy()}),l[1].addEventListener("click",()=>{const d=r.value;window.siyuan.storage[Constants.LOCAL_DAILYNOTEID]=d,setStorageVal(Constants.LOCAL_DAILYNOTEID,window.siyuan.storage[Constants.LOCAL_DAILYNOTEID]),Kn(e,d),o.destroy()})}},hc=()=>{const e=Constants.HELP_PATH[window.siyuan.config.appearance.lang];fetchPost("/api/notebook/removeNotebook",{notebook:e,callback:Constants.CB_MOUNT_REMOVE},()=>{fetchPost("/api/notebook/openNotebook",{notebook:e,app:Constants.SIYUAN_APPID})})},yc=()=>{const e=new Dialog({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">
    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});e.element.setAttribute("data-key",Constants.DIALOG_CREATENOTEBOOK);const t=e.element.querySelectorAll(".b3-button");e.bindInput(e.element.querySelector("input"),()=>{t[1].dispatchEvent(new CustomEvent("click"))}),t[0].addEventListener("click",()=>{e.destroy()}),t[1].addEventListener("click",()=>{const n=e.element.querySelector("input").value;if(!validateName(n))return!1;fetchPost("/api/notebook/createNotebook",{name:n}),e.destroy()})},wc=e=>{fetchPost("/api/storage/getRecentDocs",{},t=>{let n="";t.data.forEach((a,i)=>{n+=`<li data-index="${i}" data-node-id="${a.rootID}" class="b3-list-item${i===0?" b3-list-item--focus":""}">
${unicode2Emoji(a.icon||Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${escapeHtml(a.title)}</span>
</li>`}),openModel({title:window.siyuan.languages.recentDocs,icon:"iconList",html:`<ul class="b3-list b3-list--mobile">${n}</ul>`,bindEvent(a){a.firstElementChild.addEventListener("click",i=>{const s=hasClosestByClassName(i.target,"b3-list-item");s&&openMobileFileById(e,s.dataset.nodeId,[Constants.CB_GET_SCROLL])})}})})},Zn=(e,t)=>{if(!e||e.length===0)return`<li style="padding-left: 40px;" class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let n="";return e.forEach((a,i)=>{let s="";t&&(s=`data-id2="${t[i].fileID}"`),n+=`<li style="padding-left: 40px;" class="b3-list-item" ${s} data-id="${a.fileID}">
    <span class="b3-list-item__text" title="${escapeAttr(a.path)} ${a.hSize}">${escapeHtml(a.title)}</span>
</li>`}),n};let ct,kt;const ss=(e,t)=>{const n=hasClosestByClassName(t,"history__diff");if(!n)return;const a=hasClosestByClassName(t,"b3-dialog__container");if(!a)return;const i=n.nextElementSibling.firstElementChild,s=n.nextElementSibling.lastElementChild;ct||(ct=new Protyle(e,i.lastElementChild,{blockId:"",history:{snapshot:""},action:[Constants.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(ct.protyle),kt=new Protyle(e,s.lastElementChild,{blockId:"",action:[Constants.CB_GET_HISTORY],history:{snapshot:""},render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(kt.protyle)),fetchPost("/api/repo/openRepoSnapshotDoc",{id:t.getAttribute("data-id")},l=>{i.classList.remove("fn__none");const r=i.querySelector("textarea"),d=pathPosix().extname(l.data.content).toLowerCase();Constants.SIYUAN_ASSETS_IMAGE.concat(Constants.SIYUAN_ASSETS_AUDIO).concat(Constants.SIYUAN_ASSETS_VIDEO).includes(d)?(r.previousElementSibling.innerHTML=renderAssetsPreview(l.data.content),r.previousElementSibling.classList.remove("fn__none"),r.classList.add("fn__none"),i.lastElementChild.classList.add("fn__none")):l.data.isProtyleDoc?(r.value=l.data.content,r.classList.remove("fn__none"),i.lastElementChild.classList.add("fn__none"),r.previousElementSibling.classList.add("fn__none")):(r.classList.add("fn__none"),i.lastElementChild.classList.remove("fn__none"),r.previousElementSibling.classList.add("fn__none"),ct.protyle.options.history.snapshot=a.querySelector(".b3-dialog__header code").getAttribute("data-snapshot"),onGet({data:l,protyle:ct.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),i.querySelector(".history__date").textContent=dayjs(l.data.updated).format("YYYY-MM-DD HH:mm")});const o=t.getAttribute("data-id2");o?(s.classList.remove("fn__none"),fetchPost("/api/repo/openRepoSnapshotDoc",{id:o},l=>{const r=s.querySelector("textarea"),d=pathPosix().extname(l.data.content).toLowerCase();Constants.SIYUAN_ASSETS_IMAGE.concat(Constants.SIYUAN_ASSETS_AUDIO).concat(Constants.SIYUAN_ASSETS_VIDEO).includes(d)?(r.previousElementSibling.innerHTML=renderAssetsPreview(l.data.content),r.previousElementSibling.classList.remove("fn__none"),r.classList.add("fn__none"),s.lastElementChild.classList.add("fn__none")):l.data.isProtyleDoc?(r.value=l.data.content,r.classList.remove("fn__none"),s.lastElementChild.classList.add("fn__none"),r.previousElementSibling.classList.add("fn__none")):(r.classList.add("fn__none"),s.lastElementChild.classList.remove("fn__none"),r.previousElementSibling.classList.add("fn__none"),kt.protyle.options.history.snapshot=a.querySelectorAll(".b3-dialog__header code")[1].getAttribute("data-snapshot"),onGet({data:l,protyle:kt.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]})),s.querySelector(".history__date").textContent=dayjs(l.data.updated).format("YYYY-MM-DD HH:mm")})):s.classList.add("fn__none")},_c=(e,t)=>{if(t.length!==2)return;let n,a;t[0].time>t[1].time?(n=t[1].id,a=t[0].id):(n=t[0].id,a=t[1].id);const i=new Dialog({title:window.siyuan.languages.compare,content:"",width:isMobile()?"92vw":"90vw",height:"80vh",destroyCallback(){ct=void 0,kt=void 0}});i.element.setAttribute("data-key",Constants.DIALOG_HISTORYCOMPARE),i.element.addEventListener("click",s=>{var o;if(typeof s.detail=="string"){ss(e,i.element.querySelector(".history__diff .b3-list-item--focus")),s.stopPropagation(),s.preventDefault();return}let l=s.target;for(;l&&l!==i.element;){if(l.classList.contains("b3-list-item")&&!l.dataset.id){l.nextElementSibling.classList.toggle("fn__none"),l.querySelector("svg").classList.toggle("b3-list-item__arrow--open"),s.preventDefault(),s.stopPropagation();break}else if(l.classList.contains("b3-list-item")&&l.dataset.id){if(l.classList.contains("b3-list-item--focus"))return;(o=i.element.querySelector(".history__diff .b3-list-item--focus"))==null||o.classList.remove("b3-list-item--focus"),l.classList.add("b3-list-item--focus"),ss(e,l),s.preventDefault(),s.stopPropagation();break}else if(l.classList.contains("block__icon")){l.getAttribute("data-direct")==="left"?(l.setAttribute("data-direct","right"),Xn(a,n,i,"right")):(l.setAttribute("data-direct","left"),Xn(n,a,i,"left")),s.preventDefault(),s.stopPropagation();break}l=l.parentElement}}),Xn(n,a,i,"left")},Xn=(e,t,n,a)=>{ct=void 0,kt=void 0;const i=isMobile();fetchPost("/api/repo/diffRepoSnapshots",{left:e,right:t},s=>{const o=n.element.querySelector(".b3-dialog__header");o.innerHTML=`<div style="padding: 0;min-height: auto;" class="block__icons">
    <span class="fn__flex-1"></span>
    <code class="fn__code${i?" fn__none":""}" data-snapshot="${e}">${e.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${dayjs(s.data.left.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show b3-tooltips b3-tooltips__s" aria-label="${window.siyuan.languages.switchDirect}" data-direct="${a}"><svg><use xlink:href="#iconScrollHoriz"></use></svg></span>
    <span class="fn__space"></span>
    <code class="fn__code${i?" fn__none":""}" data-snapshot="${t}">${t.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${dayjs(s.data.right.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__flex-1"></span>
</div>`,o.nextElementSibling.innerHTML=`<div class="fn__flex history__panel" style="height: 100%">
    <div class="history__diff">
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.update}</span>
                <span class="counter${s.data.updatesLeft.length===0?" fn__none":""}">${s.data.updatesLeft.length}</span>
            </li>
            <ul class="fn__none">${Zn(s.data.updatesLeft,s.data.updatesRight)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.addAttr}</span>
                <span class="counter${s.data.addsLeft.length===0?" fn__none":""}">${s.data.addsLeft.length}</span>
            </li>
            <ul class="fn__none">${Zn(s.data.addsLeft)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.remove}</span>
                <span class="counter${s.data.removesRight.length===0?" fn__none":""}">${s.data.removesRight.length}</span>
            </li>
            <ul class="fn__none">${Zn(s.data.removesRight)}</ul>
        </ul>
    </div>
    <div class="fn__flex-1 fn__flex">
        <div class="fn__none fn__flex-1 fn__flex-column">
            <div class="history__date">${dayjs(s.data.left.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
        <div class="fn__none fn__flex-1 fn__flex-column" style="border-left: 1px solid var(--b3-border-color);">
            <div class="history__date">${dayjs(s.data.right.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
    </div>
</div>`})};let Ct;const At=(e,t)=>{const n=e.querySelector('[data-type="docprevious"]'),a=e.querySelector('[data-type="docnext"]');e.setAttribute("data-page",t.toString()),t>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled");const i=e.querySelector('button[data-type="jumpHistoryPage"]');i.textContent=`${t}`;const s=e.querySelector(".b3-text-field"),o=e.querySelector('.b3-select[data-type="opselect"]'),l=e.querySelector('.b3-select[data-type="typeselect"]'),r=e.querySelector('.b3-select[data-type="notebookselect"]'),d=e.querySelector('.history__text[data-type="docPanel"]'),c=e.querySelector('.history__text[data-type="assetPanel"]'),u=e.querySelector('.history__text[data-type="mdPanel"]'),f=e.querySelector(".b3-list");c.classList.add("fn__none"),u.classList.add("fn__none"),d.classList.add("fn__none"),l.value==="2"?(r.setAttribute("disabled","disabled"),window.siyuan.storage[Constants.LOCAL_HISTORY].type!==2&&(o.value="all"),o.querySelector('option[value="clean"]').classList.remove("fn__none"),o.querySelector('option[value="update"]').classList.remove("fn__none"),o.querySelector('option[value="delete"]').classList.add("fn__none"),o.querySelector('option[value="format"]').classList.add("fn__none"),o.querySelector('option[value="sync"]').classList.remove("fn__none"),o.querySelector('option[value="replace"]').classList.add("fn__none"),o.querySelector('option[value="outline"]').classList.add("fn__none")):(r.removeAttribute("disabled"),window.siyuan.storage[Constants.LOCAL_HISTORY].type===2&&(o.value="all"),o.querySelector('option[value="clean"]').classList.add("fn__none"),o.querySelector('option[value="update"]').classList.remove("fn__none"),o.querySelector('option[value="delete"]').classList.remove("fn__none"),o.querySelector('option[value="format"]').classList.remove("fn__none"),o.querySelector('option[value="sync"]').classList.remove("fn__none"),o.querySelector('option[value="replace"]').classList.remove("fn__none"),o.querySelector('option[value="outline"]').classList.remove("fn__none")),window.siyuan.storage[Constants.LOCAL_HISTORY]={notebookId:r.value,type:parseInt(l.value),operation:o.value},setStorageVal(Constants.LOCAL_HISTORY,window.siyuan.storage[Constants.LOCAL_HISTORY]),fetchPost("/api/history/searchHistory",{notebook:r.value,query:s.value,page:t,op:o.value,type:parseInt(l.value)},g=>{t<g.data.pageCount?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),i.setAttribute("data-totalpage",(g.data.pageCount||1).toString());const p=a.nextElementSibling.nextElementSibling;if(p.textContent=`${window.siyuan.languages.pageCountAndHistoryCount.replace("${x}",g.data.pageCount).replace("${y}",g.data.totalCount||1)}`,p.classList.remove("fn__none"),g.data.histories.length===0){f.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let m="";g.data.histories.forEach(y=>{m+=`<li class="b3-list-item" data-type="toggle" data-created="${y}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
    <span style="padding-left: 4px" class="b3-list-item__text">${dayjs(parseInt(y)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>`}),f.innerHTML=m})},is=(e,t,n)=>{if(e.data.snapshots.length===0){t.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let a="";n==="getCloudRepoTagSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeCloudRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:n==="getCloudRepoSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>`:n==="getRepoTagSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="uploadSnapshot">
    <svg><use xlink:href="#iconUpload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.upload}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:n==="getRepoSnapshots"&&(a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="genTag">
    <svg><use xlink:href="#iconTags"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.tagSnapshot}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>`);let i="";const s=isMobile();e.data.snapshots.forEach(o=>{let l="";o.typesCount&&(l=`<div class="b3-list-item__meta${s?" fn__none":""}">
${window.siyuan.languages.fileCount} ${o.count}<span class="fn__space"></span>`,o.typesCount.forEach(d=>{l+=`${d.type} ${d.count}<span class="fn__space"></span>`}),l+="</div>");const r=`<div${s?' style="padding-top:8px"':""}>
    <span data-type="hCreated">${o.hCreated}</span>
    <span class="fn__space"></span>
    ${o.hSize}
    <span class="fn__space"></span>
    ${o.systemOS}${o.systemName&&o.systemOS?"/":""}${o.systemName}
    <span class="fn__space"></span>
    <span class="b3-chip b3-chip--secondary b3-chip--small${o.tag?"":" fn__none"}">${o.tag}</span>
</div>
<div class="b3-list-item__meta${s?" fn__none":""}">
    ${escapeHtml(o.memo)}
    <span class="fn__space"></span>
    <code class="fn__code">${o.id.substring(0,7)}</code>
</div>
${l}`;i+=`<li class="b3-list-item" data-type="repoitem" data-id="${o.id}" data-tag="${o.tag}">
<div class="fn__flex-1">
    ${r}
    <div class="fn__flex" style="height: 26px" data-id="${o.id}" data-tag="${o.tag}">
        ${a}
        <span class="b3-list-item__action" data-type="more">
            <svg><use xlink:href="#iconMore"></use></svg>
            <span class="fn__space"></span>
            ${window.siyuan.languages.more}
        </span>
        <span class="fn__flex-1"></span>
    </div>
</div>
</li>`}),t.lastElementChild.innerHTML=`${i}`},et=(e,t)=>{const n=e.querySelector(".b3-select");n.disabled=!0;const a=n.value;e.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const i=e.querySelector('button[data-type="jumpRepoPage"]');i.textContent=`${t}`;const s=e.querySelector('[data-type="previous"]'),o=e.querySelector('[data-type="next"]'),l=o.nextElementSibling.nextElementSibling;e.setAttribute("data-init","true"),a==="getRepoTagSnapshots"||a==="getCloudRepoTagSnapshots"?(fetchPost(`/api/repo/${a}`,{},r=>{is(r,e,a),n.disabled=!1}),s.classList.add("fn__none"),o.classList.add("fn__none"),l.classList.add("fn__none"),i.classList.add("fn__none")):(s.classList.remove("fn__none"),o.classList.remove("fn__none"),i.classList.remove("fn__none"),e.setAttribute("data-page",t.toString()),t>1?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),o.setAttribute("disabled","disabled"),fetchPost(`/api/repo/${a}`,{page:t},r=>{n.disabled=!1,t<r.data.pageCount?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),i.setAttribute("data-totalpage",(r.data.pageCount||1).toString()),l.textContent=`${window.siyuan.languages.pageCountAndSnapshotCount.replace("${x}",r.data.pageCount).replace("${y}",r.data.totalCount||1)}`,l.classList.remove("fn__none"),is(r,e,a)}))},bo=e=>{e.setAttribute("data-init","true"),fetchPost("/api/history/getNotebookHistory",{},t=>{if(t.data.histories.length===0){e.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let n="";t.data.histories.forEach((a,i)=>{n+=`<li class="b3-list-item" style="padding-left: 0" data-type="rmtoggle">
    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${i===0?" b3-list-item__arrow--open":""}${a.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>
    <span class="b3-list-item__text">${a.hCreated}</span>
</li>`,a.items.length>0&&(n+=`<ul class="${i===0?"":"fn__none"}">`,a.items.forEach(s=>{n+=`<li data-type="notebook" data-path="${s.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">
    <span class="b3-list-item__text">${escapeHtml(s.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),n+="</ul>")}),e.innerHTML=n})},vc=e=>{if(window.siyuan.config.readonly||window.siyuan.dialogs.find(s=>{if(s.element.querySelector("#historyContainer"))return s.destroy(),!0}))return;const n=window.siyuan.storage[Constants.LOCAL_HISTORY];let a=`<option value='%' ${n.notebookId==="%"?"selected":""}>${window.siyuan.languages.allNotebooks}</option>`;window.siyuan.notebooks.forEach(s=>{s.closed||(a+=` <option value="${s.id}"${s.id===n.notebookId?" selected":""}>${escapeHtml(s.name)}</option>`)});const i=`<div class="fn__flex-column" style="height: 100%;">
    <div class="layout-tab-bar fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div data-type="doc" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.fileHistory}</span><span class="fn__flex-1"></span></div>
        <div data-type="notebook" style="min-width: 160px" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.removedNotebook}</span><span class="fn__flex-1"></span></div>
        <div data-type="repo" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.dataSnapshot}</span><span class="fn__flex-1"></span></div>
    </div>
    <div class="fn__flex-1 fn__flex" id="historyContainer">
        <div data-type="doc" class="history__repo fn__block" data-init="true">
            <div style="overflow:auto;">
                <div class="block__icons">
                    <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpHistoryPage" data-totalpage="1">1</button>
                    <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndHistoryCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <div style="position: relative">
                        <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>
                        <input class="b3-text-field b3-form__icon-input ${isMobile()?"fn__size96":"fn__size200"}">
                    </div>
                    <span class="fn__space"></span>
                    <select data-type="typeselect" class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        <option value="0" ${n.type===0?"selected":""}>${window.siyuan.languages.docName}</option>
                        <option value="1" ${n.type===1?"selected":""}>${window.siyuan.languages.docNameAndContent}</option>
                        <option value="2" ${n.type===2?"selected":""}>${window.siyuan.languages.assets}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="opselect" class="b3-select${isMobile()?" fn__size96":""}">
                        <option value="all" ${n.operation==="all"?"selected":""}>${window.siyuan.languages.allOp}</option>
                        <option value="clean" ${n.operation==="clean"?"selected":""}>${window.siyuan.languages.historyClean}</option>
                        <option value="update" ${n.operation==="update"?"selected":""}>${window.siyuan.languages.historyUpdate}</option>
                        <option value="delete" ${n.operation==="delete"?"selected":""}>${window.siyuan.languages.historyDelete}</option>
                        <option value="format" ${n.operation==="format"?"selected":""}>${window.siyuan.languages.historyFormat}</option>
                        <option value="sync" ${n.operation==="sync"?"selected":""}>${window.siyuan.languages.historySync}</option>
                        <option value="replace" ${n.operation==="replace"?"selected":""}>${window.siyuan.languages.historyReplace}</option>
                        <option value="outline" ${n.operation==="outline"?"selected":""}>${window.siyuan.languages.historyOutline}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="notebookselect" class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        ${a}
                    </select>
                    <span class="fn__space"></span>
                    <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>
                </div>
            </div>
            <div class="fn__flex fn__flex-1 history__panel">
                <ul class="b3-list b3-list--background" style="overflow:auto;">
                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
                </ul>
                <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>
                <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>
                <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
            </div>
        </div>
        <ul data-type="notebook" style="padding: 8px 0;" class="fn__none b3-list b3-list--background">
            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
        </ul>
        <div data-type="repo" class="fn__none history__repo">
            <div style="overflow: auto"">
                <div class="block__icons">
                    <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <button class="b3-button b3-button--text ft__selectnone" data-type="jumpRepoPage" data-totalpage="1">1</button>
                    <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span class="ft__on-surface fn__flex-shrink ft__selectnone fn__none">${window.siyuan.languages.pageCountAndSnapshotCount}</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <select class="b3-select ${isMobile()?"fn__size96":"fn__size200"}">
                        <option value="getRepoSnapshots">${window.siyuan.languages.localSnapshot}</option>
                        <option value="getRepoTagSnapshots">${window.siyuan.languages.localTagSnapshot}</option>
                        <option value="getCloudRepoSnapshots">${window.siyuan.languages.cloudSnapshot}</option>
                        <option value="getCloudRepoTagSnapshots">${window.siyuan.languages.cloudTagSnapshot}</option>
                    </select>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" disabled data-type="compare">${window.siyuan.languages.compare}</button>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" data-type="genRepo">
                        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}
                    </button>
                </div>    
            </div>
            <ul class="b3-list b3-list--background fn__flex-1" style="padding-bottom: 8px">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
        </div>
    </div>
</div>`;if(isMobile())openModel({html:i,icon:"iconHistory",title:window.siyuan.languages.dataHistory,bindEvent(s){os(e,s.firstElementChild)}});else{const s=new Dialog({content:i,width:"90vw",height:"80vh",destroyCallback(){Ct=void 0}});s.element.setAttribute("data-key",Constants.DIALOG_HISTORY),os(e,s.element,s)}},os=(e,t,n)=>{const a=t.querySelector("#historyContainer [data-type=doc]");a.querySelectorAll(".b3-select").forEach(c=>{c.addEventListener("change",()=>{At(a,1)})}),a.querySelector(".b3-text-field").addEventListener("input",c=>{c.isComposing||At(a,1)}),a.querySelector(".b3-text-field").addEventListener("compositionend",()=>{At(a,1)});const i=a.querySelector('.history__text[data-type="docPanel"]'),s=a.querySelector('.history__text[data-type="assetPanel"]'),o=a.querySelector('.history__text[data-type="mdPanel"]');At(a,1),Ct=new Protyle(e,i,{blockId:"",history:{created:""},action:[Constants.CB_GET_HISTORY],render:{background:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),disabledProtyle(Ct.protyle);const l=t.querySelector('#historyContainer [data-type="repo"]'),r=t.querySelector('#historyContainer [data-type="doc"]'),d=l.querySelector(".b3-select");d.addEventListener("change",()=>{et(l,1);const c=t.querySelector(".b3-button[data-type='compare']");c.setAttribute("disabled","disabled"),c.removeAttribute("data-ids")}),t.addEventListener("click",c=>{var u;let f=c.target;for(;f&&!f.isEqualNode(t);){const g=f.getAttribute("data-type");if(f.classList.contains("item")){f.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(t.querySelector("#historyContainer").children).forEach(p=>{p.getAttribute("data-type")===g?(p.classList.remove("fn__none"),p.classList.add("fn__block"),f.classList.add("item--focus"),p.getAttribute("data-init")!=="true"&&(g==="notebook"?bo(p):g==="repo"&&et(p,1))):(p.classList.add("fn__none"),p.classList.remove("fn__block"))}),c.stopPropagation(),c.preventDefault();break}else if(f.classList.contains("b3-list-item__action")&&g==="rollback"&&!window.siyuan.config.readonly){const p=f.parentElement.getAttribute("data-type");let m=f.previousElementSibling.previousElementSibling.textContent.trim(),y=dayjs(parseInt(f.parentElement.getAttribute("data-created"))*1e3).format("YYYY-MM-DD HH:mm:ss");p==="notebook"?y=f.parentElement.parentElement.previousElementSibling.textContent.trim():p==="repoitem"&&(m=window.siyuan.languages.workspaceData,y=f.parentElement.querySelector("span[data-type='hCreated']").textContent.trim());const v=window.siyuan.languages.rollbackConfirm.replace("${name}",m).replace("${time}",y);confirmDialog("\u26A0\uFE0F "+window.siyuan.languages.rollback,v,()=>{p==="assets"?fetchPost("/api/history/rollbackAssetsHistory",{historyPath:f.parentElement.getAttribute("data-path")}):p==="doc"?fetchPost("/api/history/rollbackDocHistory",{notebook:f.parentElement.getAttribute("data-notebook-id"),historyPath:f.parentElement.getAttribute("data-path")}):p==="notebook"?fetchPost("/api/history/rollbackNotebookHistory",{historyPath:f.parentElement.getAttribute("data-path")}):fetchPost("/api/repo/checkoutRepo",{id:f.parentElement.getAttribute("data-id")})}),c.stopPropagation(),c.preventDefault();break}else if(g==="more"){f.parentElement.parentElement.querySelectorAll(".b3-list-item__meta").forEach(p=>{p.classList.toggle("fn__none")}),c.stopPropagation(),c.preventDefault();break}else if(g==="toggle"){const p=f.firstElementChild.firstElementChild;if(p.classList.contains("b3-list-item__arrow--open"))f.nextElementSibling.classList.add("fn__none"),p.classList.remove("b3-list-item__arrow--open");else if(f.nextElementSibling&&f.nextElementSibling.tagName==="UL")f.nextElementSibling.classList.remove("fn__none"),p.classList.add("b3-list-item__arrow--open");else{const m=a.querySelector(".b3-text-field"),y=a.querySelector('.b3-select[data-type="opselect"]'),v=a.querySelector('.b3-select[data-type="typeselect"]'),b=a.querySelector('.b3-select[data-type="notebookselect"]'),w=f.getAttribute("data-created");fetchPost("/api/history/getHistoryItems",{notebook:b.value,query:m.value,op:y.value,type:parseInt(v.value),created:w},h=>{p.classList.add("b3-list-item__arrow--open");let C="",k="";h.data.items.forEach(E=>{let _=" b3-chip b3-chip--list ";E.op==="clean"?(_+="b3-chip--primary ",k=window.siyuan.languages.historyClean):E.op==="update"?(_+="b3-chip--info ",k=window.siyuan.languages.historyUpdate):E.op==="delete"?(_+="b3-chip--error ",k=window.siyuan.languages.historyDelete):E.op==="format"?(_+="b3-chip--pink ",k=window.siyuan.languages.historyFormat):E.op==="sync"?(_+="b3-chip--success ",k=window.siyuan.languages.historySync):E.op==="replace"?(_+="b3-chip--secondary ",k=window.siyuan.languages.historyReplace):E.op==="outline"&&(_+="b3-chip--warning ",k=window.siyuan.languages.historyOutline),C+=`<li data-notebook-id="${E.notebook}" data-created="${w}" data-type="${v.value==="2"?"assets":"doc"}" data-path="${E.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 22px">
    <span class="${y.value==="all"?"":"fn__none"}${_}ariaLabel" data-position="6bottom" aria-label="${k}">${E.op.substring(0,1).toUpperCase()}</span>
    <span class="b3-list-item__text" title="${escapeAttr(E.title)}">${escapeHtml(E.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action ariaLabel" data-type="rollback" data-position="6bottom" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),f.insertAdjacentHTML("afterend",`<ul>${C}</ul>`)})}c.stopPropagation(),c.preventDefault();break}else if(g==="rmtoggle"){f.nextElementSibling.classList.toggle("fn__none"),f.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"),c.stopPropagation(),c.preventDefault();break}else if(f.classList.contains("b3-list-item")&&g==="repoitem"&&["getRepoSnapshots","getRepoTagSnapshots"].includes(d.value)){const p=t.querySelector(".b3-button[data-type='compare']"),m=JSON.parse(p.getAttribute("data-ids")||"[]"),y=f.getAttribute("data-id");if(f.classList.contains("b3-list-item--focus"))f.classList.remove("b3-list-item--focus"),m.forEach((v,b)=>{y===v.id&&m.splice(b,1)});else{for(f.classList.add("b3-list-item--focus");m.length>1;)m[0].id!==y&&((u=f.parentElement.querySelector(`.b3-list-item[data-id="${m.splice(0,1)[0].id}"]`))==null||u.classList.remove("b3-list-item--focus"));m.push({id:y,time:f.querySelector('[data-type="hCreated"]').textContent})}m.length===2?p.removeAttribute("disabled"):p.setAttribute("disabled","disabled"),p.setAttribute("data-ids",JSON.stringify(m)),c.stopPropagation(),c.preventDefault();break}else if(f.classList.contains("b3-list-item")&&(g==="assets"||g==="doc")){const p=f.getAttribute("data-path");g==="assets"?(s.classList.remove("fn__none"),s.innerHTML=renderAssetsPreview(p)):g==="doc"&&fetchPost("/api/history/getDocHistoryContent",{historyPath:p,k:a.querySelector(".b3-text-field").value},y=>{y.data.isLargeDoc?(o.value=y.data.content,o.classList.remove("fn__none"),i.classList.add("fn__none")):(o.classList.add("fn__none"),i.classList.remove("fn__none"),Ct.protyle.options.history.created=f.dataset.created,onGet({data:y,protyle:Ct.protyle,action:[Constants.CB_GET_HISTORY,Constants.CB_GET_HTML]}))});let m=hasClosestByClassName(f,"b3-list");m&&(m=m.querySelector(".b3-list-item--focus"),m&&m.classList.remove("b3-list-item--focus")),f.classList.add("b3-list-item--focus"),c.stopPropagation(),c.preventDefault();break}else if(g==="genRepo"){const p=new Dialog({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});p.element.setAttribute("data-key",Constants.DIALOG_SNAPSHOTMEMO);const m=p.element.querySelector("textarea");m.focus();const y=p.element.querySelectorAll(".b3-button");p.bindInput(m,()=>{y[1].click()}),y[0].addEventListener("click",()=>{p.destroy()}),y[1].addEventListener("click",()=>{fetchPost("/api/repo/createSnapshot",{memo:m.value},()=>{et(l,1)}),p.destroy()}),c.stopPropagation(),c.preventDefault();break}else if(g==="removeRepoTagSnapshot"||g==="removeCloudRepoTagSnapshot"){const p=f.parentElement.getAttribute("data-tag");confirmDialog(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <i>${p}</i>?`,()=>{fetchPost("/api/repo/"+g,{tag:p},()=>{et(l,1)})}),c.stopPropagation(),c.preventDefault();break}else if(g==="uploadSnapshot"){fetchPost("/api/repo/uploadCloudSnapshot",{tag:f.parentElement.getAttribute("data-tag"),id:f.parentElement.getAttribute("data-id")}),c.stopPropagation(),c.preventDefault();break}else if(g==="downloadSnapshot"){fetchPost("/api/repo/downloadCloudSnapshot",{tag:f.parentElement.getAttribute("data-tag"),id:f.parentElement.getAttribute("data-id")}),c.stopPropagation(),c.preventDefault();break}else if(g==="genTag"){const p=new Dialog({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="${dayjs().format("YYYYMMDDHHmmss")}" placeholder="${window.siyuan.languages.tagSnapshotTip}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshot}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshotUpload}</button>
</div>`,width:isMobile()?"92vw":"520px"});p.element.setAttribute("data-key",Constants.DIALOG_SNAPSHOTTAG);const m=p.element.querySelector(".b3-text-field");m.select();const y=p.element.querySelectorAll(".b3-button");y[0].addEventListener("click",()=>{p.destroy()}),y[2].addEventListener("click",()=>{fetchPost("/api/repo/tagSnapshot",{id:f.parentElement.getAttribute("data-id"),name:m.value},()=>{fetchPost("/api/repo/uploadCloudSnapshot",{tag:m.value,id:f.parentElement.getAttribute("data-id")},()=>{et(l,1)})}),p.destroy()}),y[1].addEventListener("click",()=>{fetchPost("/api/repo/tagSnapshot",{id:f.parentElement.getAttribute("data-id"),name:m.value},()=>{et(l,1)}),p.destroy()}),c.stopPropagation(),c.preventDefault();break}else if((g==="previous"||g==="next")&&f.getAttribute("disabled")!=="disabled"){const p=parseInt(l.getAttribute("data-page"));et(l,g==="previous"?p-1:p+1),c.stopPropagation(),c.preventDefault();break}else if(g==="jumpRepoPage"){const p=parseInt(l.getAttribute("data-page")),m=parseInt(f.getAttribute("data-totalpage")||"1");m>1&&confirmDialog(window.siyuan.languages.jumpToPage.replace("${x}",m),`<input style="width: 100%;" class="b3-text-field fn__flex-center" type="number" min="1" max="${m}" value="${p}">`,y=>{const v=y.element.querySelector(".b3-text-field");if(v.value==="")return;let b=parseInt(v.value);b=Math.max(1,Math.min(b,m)),et(l,b)})}else if(g==="jumpHistoryPage"){const p=parseInt(r.getAttribute("data-page")),m=parseInt(f.getAttribute("data-totalpage")||"1");m>1&&confirmDialog(window.siyuan.languages.jumpToPage.replace("${x}",m),`<input style="width: 100%;" class="b3-text-field fn__flex-center" type="number" min="1" max="${m}" value="${p}">`,y=>{const v=y.element.querySelector(".b3-text-field");if(v.value==="")return;let b=parseInt(v.value);b=Math.max(1,Math.min(b,m)),At(a,b)})}else if((g==="docprevious"||g==="docnext")&&f.getAttribute("disabled")!=="disabled"){const p=parseInt(a.getAttribute("data-page"));At(a,g==="docprevious"?p-1:p+1),c.stopPropagation(),c.preventDefault();break}else if(g==="rebuildIndex"){fetchPost("/api/history/reindexHistory"),n?n.destroy():(closeModel(),Ct=void 0),c.stopPropagation(),c.preventDefault();break}else if(g==="compare"&&!f.getAttribute("disabled")){showDiff(e,JSON.parse(f.getAttribute("data-ids")||"[]")),c.stopPropagation(),c.preventDefault();break}f=f.parentElement}})},Ec=e=>{setTitle(window.siyuan.languages.siyuanNote),document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const t=document.getElementById("empty");t.classList.remove("fn__none"),t.innerHTML===""&&(t.innerHTML=`<div id="emptySearch" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.search}</span>
</div>
<div id="emptyRecent" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.recentDocs}</span>
</div>
<div id="emptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>
</div>
<div id="emptyNewFile" class="b3-list-item${getOpenNotebookCount()>0||!window.siyuan.config.readonly?"":" fn__none"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>
</div>
<div class="b3-list-item" id="emptyNewNotebook${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>
</div>
<div class="b3-list-item${isIPhone()||window.siyuan.config.readonly?" fn__none":""}" id="emptyHelp">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.userGuide}</span>
</div>`,t.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(t);){if(a.id==="emptySearch"){popSearch(e),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyRecent"){getRecentDocs(e),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHistory"){openHistory(e),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewFile"){newFile({app:e,useSavePath:!0}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewNotebook"){newNotebook(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHelp"){mountHelp(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}}))},kc=()=>{const e=document.getElementById("toolbarName");setTitle(e.value),e.classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")},Cc=(e,t=!1)=>{if(!e.wysiwyg.element.firstElementChild||window.siyuan.config.readonly)return;const n={rootId:e.block.rootID,startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:e.contentElement.scrollTop||parseInt(e.contentElement.getAttribute("data-scrolltop"))||0};let a;if(getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0)),(!a||!e.wysiwyg.element.contains(a.startContainer))&&(a=e.toolbar.range),a&&e.wysiwyg.element.contains(a.startContainer)){const i=hasClosestBlock(a.startContainer);if(i){const s=getSelectionOffset(i,void 0,a);n.focusId=i.getAttribute("data-node-id"),n.focusStart=s.start,n.focusEnd=s.end}}return e.block.showAll&&(n.zoomInId=e.block.id),t?n:(window.siyuan.storage[Constants.LOCAL_FILEPOSITION][e.block.rootID]=n,new Promise(i=>{setStorageVal(Constants.LOCAL_FILEPOSITION,window.siyuan.storage[Constants.LOCAL_FILEPOSITION],()=>{i(!0)})}))},Ac=e=>{var t,n,a,i,s,o,l,r,d,c,u,f,g;let p=[];if(e.mergedOptions?p=e.mergedOptions.action:e.focus?p=[Constants.CB_GET_UNUNDO,Constants.CB_GET_FOCUS]:p=[Constants.CB_GET_UNUNDO],(t=e.scrollAttr)!=null&&t.zoomInId){fetchPost("/api/filetree/getDoc",{id:e.scrollAttr.zoomInId,size:Constants.SIZE_GET_MAX,query:(n=e.protyle.query)==null?void 0:n.key,queryMethod:(a=e.protyle.query)==null?void 0:a.method,queryTypes:(i=e.protyle.query)==null?void 0:i.types},m=>{var y,v,b,w,h;m.code===1?fetchPost("/api/filetree/getDoc",{id:e.scrollAttr.rootId||((y=e.mergedOptions)==null?void 0:y.blockId)||((v=e.protyle.block)==null?void 0:v.rootID)||e.scrollAttr.startId,query:(b=e.protyle.query)==null?void 0:b.key,queryMethod:(w=e.protyle.query)==null?void 0:w.method,queryTypes:(h=e.protyle.query)==null?void 0:h.types},C=>{onGet({data:C,protyle:e.protyle,action:p,scrollAttr:e.scrollAttr,afterCB:e.cb,updateReadonly:e.updateReadonly})}):(p.push(Constants.CB_GET_ALL),onGet({data:m,protyle:e.protyle,action:p,scrollAttr:e.scrollAttr,afterCB:e.cb,updateReadonly:e.updateReadonly}))});return}fetchPost("/api/filetree/getDoc",{id:((s=e.scrollAttr)==null?void 0:s.rootId)||((o=e.mergedOptions)==null?void 0:o.blockId)||((l=e.protyle.block)==null?void 0:l.rootID)||((r=e.scrollAttr)==null?void 0:r.startId),startID:(d=e.scrollAttr)==null?void 0:d.startId,endID:(c=e.scrollAttr)==null?void 0:c.endId,query:(u=e.protyle.query)==null?void 0:u.key,queryMethod:(f=e.protyle.query)==null?void 0:f.method,queryTypes:(g=e.protyle.query)==null?void 0:g.types},m=>{onGet({data:m,protyle:e.protyle,action:p,scrollAttr:e.scrollAttr,afterCB:e.cb,updateReadonly:e.updateReadonly})})};class Lc{constructor(t,n,a){this.version=Constants.SIYUAN_VERSION;let i=a;t.plugins.forEach(l=>{l.protyleOptions&&(i=merge(i,l.protyleOptions))});const o=new Options(i).merge();if(this.protyle={getInstance:()=>this,app:t,transactionTime:new Date().getTime(),id:genUUID(),disabled:!1,updated:!1,element:n,options:o,block:{}},this.protyle.hint=new Hint(this.protyle),o.render.breadcrumb&&(this.protyle.breadcrumb=new Breadcrumb(this.protyle)),o.render.title&&(this.protyle.title=new Title(this.protyle)),o.render.background&&(this.protyle.background=new Background(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),o.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new Undo,this.protyle.wysiwyg=new WYSIWYG(this.protyle),this.protyle.toolbar=new Toolbar(this.protyle),this.protyle.scroll=new Scroll(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new Gutter(this.protyle)),(o.upload.url||o.upload.handler)&&(this.protyle.upload=new Upload),this.init(),o.action.includes(Constants.CB_GET_HISTORY))this.protyle.contentElement.classList.add("protyle-content--transition");else{if(this.protyle.ws=new Model({app:t,id:this.protyle.id,type:"protyle",msgCallback:l=>{var r;switch(l.cmd){case"reload":l.data===this.protyle.block.rootID&&reloadProtyle(this.protyle,!1);break;case"refreshAttributeView":Array.from(this.protyle.wysiwyg.element.querySelectorAll(`[data-av-id="${l.data.id}"]`)).forEach(d=>{d.removeAttribute("data-render"),avRender(d,this.protyle)});break;case"addLoading":l.data===this.protyle.block.rootID&&addLoading(this.protyle,l.msg);break;case"transactions":l.data[0].doOperations.forEach(d=>{!this.protyle.preview.element.classList.contains("fn__none")&&d.action!=="updateAttrs"?this.protyle.preview.render(this.protyle):onTransaction(this.protyle,d,!1)});break;case"readonly":window.siyuan.config.editor.readOnly=l.data,setReadonlyByConfig(this.protyle,!0);break;case"heading2doc":case"li2doc":this.protyle.block.rootID===l.data.srcRootBlockID&&(this.protyle.block.showAll&&l.cmd==="heading2doc"&&!this.protyle.options.backlinkData?fetchPost("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},d=>{onGet({data:d,protyle:this.protyle})}):reloadProtyle(this.protyle,!1));break;case"rename":this.protyle.path===l.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(l.data.title),this.protyle.background&&(this.protyle.background.ial.title=l.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===l.data.id&&(!document.body.classList.contains("body--blur")&&getSelection().rangeCount>0&&((r=this.protyle.title.editElement)!=null&&r.contains(getSelection().getRangeAt(0).startContainer))||this.protyle.title.setTitle(l.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${l.data.id}"]`).forEach(d=>{d.getAttribute("data-subtype")==="d"&&(d.innerHTML=l.data.refText)});break;case"moveDoc":this.protyle.path===l.data.fromPath&&(this.protyle.path=l.data.newPath,this.protyle.notebookId=l.data.toNotebook);break;case"unmount":this.protyle.notebookId===l.data.box&&setEmpty(t);break;case"removeDoc":l.data.ids.includes(this.protyle.block.rootID)&&(setEmpty(t),delete window.siyuan.storage[Constants.LOCAL_FILEPOSITION][this.protyle.block.rootID],setStorageVal(Constants.LOCAL_FILEPOSITION,window.siyuan.storage[Constants.LOCAL_FILEPOSITION]));break}}}),a.backlinkData){this.protyle.block.rootID=a.blockId,renderBacklink(this.protyle,a.backlinkData),this.protyle.wysiwyg.element.style.paddingLeft="16px";return}if(!a.blockId){removeLoading(this.protyle);return}this.protyle.options.mode!=="preview"&&a.rootId&&window.siyuan.storage[Constants.LOCAL_FILEPOSITION][a.rootId]&&(o.action.includes(Constants.CB_GET_SCROLL)||o.action.includes(Constants.CB_GET_ROOTSCROLL)&&a.rootId===a.blockId)?getDocByScroll({protyle:this.protyle,scrollAttr:window.siyuan.storage[Constants.LOCAL_FILEPOSITION][a.rootId],mergedOptions:o,cb:()=>{this.afterOnGet(o)}}):this.getDoc(o)}}getDoc(t){var n;fetchPost("/api/filetree/getDoc",{id:t.blockId,isBacklink:t.action.includes(Constants.CB_GET_BACKLINK),mode:t.action&&t.action.includes(Constants.CB_GET_CONTEXT)?3:0,size:(n=t.action)!=null&&n.includes(Constants.CB_GET_ALL)?Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks},a=>{onGet({data:a,protyle:this.protyle,action:t.action,afterCB:()=>{this.afterOnGet(t)}})})}afterOnGet(t){this.protyle.model,resize(this.protyle),this.protyle.wysiwyg.element.addEventListener("focusin",()=>{}),t.after&&t.after(this),this.protyle.contentElement.classList.add("protyle-content--transition")}init(){this.protyle.lute=setLute({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new Preview(this.protyle),initUI(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){destroy(this.protyle)}resize(){resize(this.protyle)}reload(t){reloadProtyle(this.protyle,t)}insert(t,n=!1,a=!1){insertHTML(t,this.protyle,n,a)}transaction(t,n){transaction(this.protyle,t,n)}turnIntoOneTransaction(t,n,a){turnsIntoOneTransaction({protyle:this.protyle,selectsElement:t,type:n,level:a})}turnIntoTransaction(t,n,a){turnsIntoTransaction({protyle:this.protyle,nodeElement:t,type:n,level:a})}updateTransaction(t,n,a){updateTransaction(this.protyle,t,n,a)}updateBatchTransaction(t,n){updateBatchTransaction(t,this.protyle,n)}getRange(t){return getEditorRange(t)}hasClosestBlock(t){return hasClosestBlock(t)}focusBlock(t,n=!0){return focusBlock(t,void 0,n)}}const Sc=()=>window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,xc=(e,t,n=[Constants.CB_GET_HL])=>{window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:t},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]);const a=document.querySelector(".av__panel");if(a&&!a.classList.contains("fn__none")&&a.dispatchEvent(new CustomEvent("click",{detail:"close"})),window.siyuan.mobile.editor){saveScroll(window.siyuan.mobile.editor.protyle),hideElements(["toolbar","hint","util"],window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.contentElement.classList.contains("fn__none")&&setEditMode(window.siyuan.mobile.editor.protyle,"wysiwyg");let i;if(Array.from(window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${t}"]`)).find(s=>{if(!isInEmbedBlock(s))return i=s,!0}),i){pushBack(),scrollCenter(window.siyuan.mobile.editor.protyle,i,!0),closePanel();return}}fetchPost("/api/block/getBlockInfo",{id:t},i=>{if(i.code===3){showMessage(i.msg);return}const s={blockId:t,rootId:i.data.rootID,action:n,render:{scroll:!0,title:!0,background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu"]}};window.siyuan.mobile.editor?(window.siyuan.mobile.editor.protyle.title.element.removeAttribute("data-render"),pushBack(),addLoading(window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.block.rootID!==i.data.rootID&&(window.siyuan.mobile.editor.protyle.wysiwyg.element.innerHTML=""),n.includes(Constants.CB_GET_SCROLL)&&window.siyuan.storage[Constants.LOCAL_FILEPOSITION][i.data.rootID]?getDocByScroll({protyle:window.siyuan.mobile.editor.protyle,scrollAttr:window.siyuan.storage[Constants.LOCAL_FILEPOSITION][i.data.rootID],mergedOptions:s,cb(){e.plugins.forEach(o=>{o.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}}):fetchPost("/api/filetree/getDoc",{id:t,size:n.includes(Constants.CB_GET_ALL)?Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,mode:n.includes(Constants.CB_GET_CONTEXT)?3:0},o=>{onGet({data:o,protyle:window.siyuan.mobile.editor.protyle,action:n,afterCB(){e.plugins.forEach(l=>{l.eventBus.emit("switch-protyle",{protyle:window.siyuan.mobile.editor.protyle})})}})}),window.siyuan.mobile.editor.protyle.undo.clear()):window.siyuan.mobile.editor=new Protyle(e,document.getElementById("editor"),s),setEditor(),closePanel()})};let ls,qt=!1;const Q=(e,t,n,a="false")=>{let i;return t&&t.startsWith("icon")?i=`<svg class="keyboard__slash-icon"><use xlink:href="#${t}"></use></svg>`:i=t,`<button class="keyboard__slash-item" data-focus="${a}" data-value="${encodeURIComponent(e)}">
    ${i}
    <span class="keyboard__slash-text">${n}</span>
</button>`},ho=(e,t)=>{let n="";["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach((u,f)=>{n+=`<button class="keyboard__slash-item" data-type="color">
    <span class="keyboard__slash-icon" style="color:${u}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${f+1}</span>
</button>`});let a="";["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach((u,f)=>{a+=`<button class="keyboard__slash-item" data-type="backgroundColor">
    <span class="keyboard__slash-icon" style="background-color:${u}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${f+1}</span>
</button>`});const i=getFontNodeElements(e);let s=!1;i==null||i.find(u=>{if(u.classList.contains("list")||u.classList.contains("li"))return s=!0,!0});let o="";const l=window.siyuan.storage[Constants.LOCAL_FONTSTYLES];l.length>0&&(o=`<div class="keyboard__slash-title">
    ${window.siyuan.languages.lastUsed}
</div>
<div class="keyboard__slash-block">`,l.forEach(u=>{const f=u.split(Constants.ZWSP);switch(f[0]){case"color":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-icon" style="color:${f[1]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${parseInt(f[1].replace("var(--b3-font-color",""))+1}</span>
</button>`;break;case"backgroundColor":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-icon" style="background-color:${f[1]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${parseInt(f[1].replace("var(--b3-font-background",""))+1}</span>
</button>`;break;case"style2":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
</button>`;break;case"style4":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
</button>`;break;case"fontSize":s||(o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text">${f[1]}</span>
</button>`);break;case"style1":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-icon" style="background-color:${f[1]};color:${f[2]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages[f[2].replace("var(--b3-card-","").replace("-color)","")+"Style"]}</span>
</button>`;break;case"clear":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
</button>`;break}}),o+="</div>");let r,d="16px";i&&i.length>0?r=i[0]:(r=e.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=hasClosestByAttribute(e.toolbar.range.startContainer,"data-type","text"))),r&&(d=r.style.fontSize||"16px");const c=t.querySelector(".keyboard__util");c.innerHTML=`${o}
<div class="keyboard__slash-title">${window.siyuan.languages.color}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.errorStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.warningStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.infoStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.successStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorFont}</div>
<div class="keyboard__slash-block">
    ${n}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorPrimary}</div>
<div class="keyboard__slash-block">
    ${a}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.fontStyle}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style2">
        <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style4">
        <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="clear">
        <svg class="keyboard__slash-icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title${s?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="keyboard__slash-block${s?" fn__none":""}">
    <select class="b3-select fn__block" style="width: calc(50% - 8px);margin: 4px 0 8px 0;">
        <option ${d==="12px"?"selected":""} value="12px">12px</option>
        <option ${d==="13px"?"selected":""} value="13px">13px</option>
        <option ${d==="14px"?"selected":""} value="14px">14px</option>
        <option ${d==="15px"?"selected":""} value="15px">15px</option>
        <option ${d==="16px"?"selected":""} value="16px">16px</option>
        <option ${d==="19px"?"selected":""} value="19px">19px</option>
        <option ${d==="22px"?"selected":""} value="22px">22px</option>
        <option ${d==="24px"?"selected":""} value="24px">24px</option>
        <option ${d==="29px"?"selected":""} value="29px">29px</option>
        <option ${d==="32px"?"selected":""} value="32px">32px</option>
        <option ${d==="40px"?"selected":""} value="40px">40px</option>
        <option ${d==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>`,c.querySelector("select").addEventListener("change",function(u){fontEvent(e,i,"fontSize",u.target.value)})},yo=(e,t)=>{e.hint.splitChar="/",e.hint.lastIndex=-1;let n="";e.app.plugins.forEach(i=>{i.protyleSlash.forEach(s=>{n+=Q(`plugin${Constants.ZWSP}${i.name}${Constants.ZWSP}${s.id}`,"",s.html,"true")})}),n&&(n=`<div class="keyboard__slash-title"></div><div class="keyboard__slash-block">${n}</div>`);const a=t.querySelector(".keyboard__util");a.innerHTML=`<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Q(Constants.ZWSP,"iconMarkdown",window.siyuan.languages.template)}
    ${Q(Constants.ZWSP+1,"iconBoth",window.siyuan.languages.widget)}
    ${Q(Constants.ZWSP+2,"iconImage",window.siyuan.languages.assets)}
    ${Q("((","iconRef",window.siyuan.languages.ref,"true")}
    ${Q("{{","iconSQL",window.siyuan.languages.blockEmbed,"true")}
    ${Q(Constants.ZWSP+5,"iconSparkles",window.siyuan.languages.aiWriting)}
    ${Q('<div data-type="NodeAttributeView" data-av-type="table"></div>',"iconDatabase",window.siyuan.languages.database,"true")}
    ${Q(Constants.ZWSP+4,"iconFile",window.siyuan.languages.newSubDocRef)}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Q(Constants.ZWSP+3,"iconDownload",window.siyuan.languages.insertAsset+'<input class="b3-form__upload" type="file"'+(e.options.upload.accept?' multiple="'+e.options.upload.accept+'"':"")+"/>","true")}
    ${isInAndroid()?Q(Constants.ZWSP+3,"iconCamera",window.siyuan.languages.insertPhoto+'<input class="b3-form__upload" capture="user" type="file"'+(e.options.upload.accept?' multiple="'+e.options.upload.accept+'"':"")+"/>","true"):""}
    ${Q('<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals allow-popups" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',"iconLanguage",window.siyuan.languages.insertIframeURL,"true")}
    ${Q("![]()","iconImage",window.siyuan.languages.insertImgURL,"true")}
    ${Q('<video controls="controls" src=""></video>',"iconVideo",window.siyuan.languages.insertVideoURL,"true")}
    ${Q('<audio controls="controls" src=""></audio>',"iconRecord",window.siyuan.languages.insertAudioURL,"true")}
    ${Q("emoji","iconEmoji",window.siyuan.languages.emoji,"true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Q("# "+Lute.Caret,"iconH1",window.siyuan.languages.heading1,"true")}
    ${Q("## "+Lute.Caret,"iconH2",window.siyuan.languages.heading2,"true")}
    ${Q("### "+Lute.Caret,"iconH3",window.siyuan.languages.heading3,"true")}
    ${Q("#### "+Lute.Caret,"iconH4",window.siyuan.languages.heading4,"true")}
    ${Q("##### "+Lute.Caret,"iconH5",window.siyuan.languages.heading5,"true")}
    ${Q("###### "+Lute.Caret,"iconH6",window.siyuan.languages.heading6,"true")}
    ${Q("* "+Lute.Caret,"iconList",window.siyuan.languages.list,"true")}
    ${Q("1. "+Lute.Caret,"iconOrderedList",window.siyuan.languages["ordered-list"],"true")}
    ${Q("* [ ] "+Lute.Caret,"iconCheck",window.siyuan.languages.check,"true")}
    ${Q("> "+Lute.Caret,"iconQuote",window.siyuan.languages.quote,"true")}
    ${Q("```","iconCode",window.siyuan.languages.code,"true")}
    ${Q(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,"iconTable",window.siyuan.languages.table,"true")}
    ${Q("---","iconLine",window.siyuan.languages.line,"true")}
    ${Q("$$","iconMath",window.siyuan.languages.math)}
    ${Q("<div>","iconHTML5","HTML")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Q("```abc\n```","",window.siyuan.languages.staff,"true")}
    ${Q("```echarts\n```","",window.siyuan.languages.chart,"true")}
    ${Q("```flowchart\n```","","Flow Chart","true")}
    ${Q("```graphviz\n```","","Graph","true")}
    ${Q("```mermaid\n```","","Mermaid","true")}
    ${Q("```mindmap\n```","",window.siyuan.languages.mindmap,"true")}
    ${Q("```plantuml\n```","","UML","true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Q(`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,'<div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.infoStyle,"true")}
    ${Q(`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,'<div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.successStyle,"true")}
    ${Q(`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,'<div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.warningStyle,"true")}
    ${Q(`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,'<div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.errorStyle,"true")}
    ${Q(`style${Constants.ZWSP}`,'<div class="keyboard__slash-icon">A</div>',window.siyuan.languages.clearFontStyle,"true")}
</div>${n}`,e.hint.bindUploadEvent(e,a)},rs=e=>{window.siyuan.menus.menu.remove(),qt=!0;const t=document.getElementById("keyboardToolbar");let n=t.getAttribute("data-keyboardheight");n=(n?parseInt(n)+42:window.outerHeight/2)+"px";const a=getCurrentEditor();a&&(a.protyle.element.parentElement.style.paddingBottom=n,a.protyle.contentElement.scrollTop=e),setTimeout(()=>{t.style.height=n},Constants.TIMEOUT_TRANSITION),setTimeout(()=>{qt=!1},1e3)},Ft=()=>{const e=document.getElementById("keyboardToolbar");e.style.height="";const t=getCurrentEditor();t&&(t.protyle.element.parentElement.style.paddingBottom="42px"),e.querySelector('.keyboard__action[data-type="add"]').classList.remove("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="text"]').classList.remove("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconKeyboardHide")},wo=()=>{clearTimeout(ls),ls=window.setTimeout(()=>{if(getSelection().rangeCount===0||window.siyuan.config.readonly||document.getElementById("toolbarName").getAttribute("readonly")==="readonly"||window.screen.height-window.innerHeight<160||!document.activeElement||document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&!document.activeElement.classList.contains("protyle-wysiwyg")&&document.activeElement.getAttribute("contenteditable")!=="true"){dn();return}if(document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("model").style.transform==="translateY(0px)")){dn();return}qt||Ft(),_o();const e=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic"),t=getSelection().getRangeAt(0);if(!hasClosestByClassName(t.startContainer,"protyle-wysiwyg",!0)){e[0].classList.add("fn__none"),e[1].classList.add("fn__none");return}t.toString()||e[0].querySelector('[data-type="goinline"]').classList.contains("protyle-toolbar__item--current")?(e[0].classList.add("fn__none"),e[1].classList.remove("fn__none")):(e[0].classList.remove("fn__none"),e[1].classList.add("fn__none"));const i=getCurrentEditor().protyle;if(!e[0].classList.contains("fn__none")){i.undo.undoStack.length===0?e[0].querySelector('[data-type="undo"]').setAttribute("disabled","disabled"):e[0].querySelector('[data-type="undo"]').removeAttribute("disabled"),i.undo.redoStack.length===0?e[0].querySelector('[data-type="redo"]').setAttribute("disabled","disabled"):e[0].querySelector('[data-type="redo"]').removeAttribute("disabled");const s=hasClosestBlock(t.startContainer);if(s){const o=e[0].querySelector('[data-type="outdent"]');s.parentElement.classList.contains("li")?(o.classList.remove("fn__none"),o.nextElementSibling.classList.remove("fn__none")):(o.classList.add("fn__none"),o.nextElementSibling.classList.add("fn__none"))}}e[1].classList.contains("fn__none")||(e[1].querySelectorAll(".protyle-toolbar__item--current").forEach(o=>{o.classList.remove("protyle-toolbar__item--current")}),i.toolbar.getCurrentType(t).forEach(o=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(o))return;const l=e[1].querySelector(`[data-type="${o}"]`);l&&l.classList.add("protyle-toolbar__item--current")}))},620)},_o=()=>{qt||Ft();const e=document.getElementById("keyboardToolbar");if(!e.classList.contains("fn__none"))return;e.classList.remove("fn__none"),e.style.zIndex=(++window.siyuan.zIndex).toString();const t=document.getElementById("model");t.style.transform==="translateY(0px)"&&(t.style.paddingBottom="42px");const n=getSelection().getRangeAt(0),a=getCurrentEditor();a&&a.protyle.wysiwyg.element.contains(n.startContainer)&&(a.protyle.element.parentElement.style.paddingBottom="42px"),getCurrentEditor().protyle.app.plugins.forEach(i=>{i.eventBus.emit("mobile-keyboard-show")}),setTimeout(()=>{const i=hasClosestByClassName(n.startContainer,"protyle-content",!0);if(i){const s=i.getBoundingClientRect().top,o=getSelectionPosition(i).top;if(o<window.innerHeight-42&&o>s)return;i.scroll({top:i.scrollTop+o-window.innerHeight+42+26,left:i.scrollLeft,behavior:"smooth"})}},Constants.TIMEOUT_TRANSITION)},dn=()=>{if(qt)return;const e=document.getElementById("keyboardToolbar");if(e.classList.contains("fn__none"))return;e.classList.add("fn__none"),e.style.height="";const t=getCurrentEditor();t&&(t.protyle.element.parentElement.style.paddingBottom="");const n=document.getElementById("model");n.style.transform==="translateY(0px)"&&(n.style.paddingBottom=""),getCurrentEditor().protyle.app.plugins.forEach(a=>{a.eventBus.emit("mobile-keyboard-hide")})},ds=()=>{document.activeElement.blur()},Tc=()=>{let e=!1;document.addEventListener("selectionchange",()=>{e||wo()},!1);const t=document.getElementById("keyboardToolbar");t.innerHTML=`<div class="fn__flex keyboard__bar">
    <div class="fn__flex-1">
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
            <button class="keyboard__action" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>
            <button class="keyboard__action" data-type="add"><svg><use xlink:href="#iconAdd"></use></svg></button>
            <button class="keyboard__action" data-type="block"><svg><use xlink:href="#iconParagraph"></use></svg></button>
            <button class="keyboard__action" data-type="goinline"><svg class="keyboard__svg--big"><use xlink:href="#iconBIU"></use></svg></button>
            <button class="keyboard__action" data-type="softLine"><svg><use xlink:href="#iconSoftWrap"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
            <button class="keyboard__action" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="moveup"><svg><use xlink:href="#iconUp"></use></svg></button>
            <button class="keyboard__action" data-type="movedown"><svg><use xlink:href="#iconDown"></use></svg></button>
        </div>
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconBack"></use></svg></button>
            <button class="keyboard__action" data-type="block-ref"><svg><use xlink:href="#iconRef"></use></svg></button>
            <button class="keyboard__action" data-type="a"><svg><use xlink:href="#iconLink"></use></svg></button>
            <button class="keyboard__action" data-type="text"><svg><use xlink:href="#iconFont"></use></svg></button>
            <button class="keyboard__action" data-type="strong"><svg><use xlink:href="#iconBold"></use></svg></button>
            <button class="keyboard__action" data-type="em"><svg><use xlink:href="#iconItalic"></use></svg></button>
            <button class="keyboard__action" data-type="u"><svg><use xlink:href="#iconUnderline"></use></svg></button>
            <button class="keyboard__action" data-type="s"><svg><use xlink:href="#iconStrike"></use></svg></button>
            <button class="keyboard__action" data-type="mark"><svg><use xlink:href="#iconMark"></use></svg></button>
            <button class="keyboard__action" data-type="sup"><svg><use xlink:href="#iconSup"></use></svg></button>
            <button class="keyboard__action" data-type="sub"><svg><use xlink:href="#iconSub"></use></svg></button>
            <button class="keyboard__action" data-type="clear"><svg><use xlink:href="#iconClear"></use></svg></button>
            <button class="keyboard__action" data-type="code"><svg><use xlink:href="#iconInlineCode"></use></svg></button>
            <button class="keyboard__action" data-type="kbd"<use xlink:href="#iconKeymap"></use></svg></button>
            <button class="keyboard__action" data-type="tag"><svg><use xlink:href="#iconTags"></use></svg></button>
            <button class="keyboard__action" data-type="inline-math"><svg><use xlink:href="#iconMath"></use></svg></button>
            <button class="keyboard__action" data-type="inline-memo"><svg><use xlink:href="#iconM"></use></svg></button>
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconCloseRound"></use></svg></button>
        </div>
    </div>
    <span class="keyboard__split"></span>
    <button class="keyboard__action" data-type="done"><svg style="width: 36px"><use xlink:href="#iconKeyboardHide"></use></svg></button>
</div>
<div class="keyboard__util"></div>`,t.addEventListener("click",n=>{var a;const i=(a=getCurrentEditor())==null?void 0:a.protyle,s=n.target,o=hasClosestByClassName(n.target,"keyboard__slash-item");if(o&&!o.getAttribute("data-type")){const u=decodeURIComponent(o.getAttribute("data-value"));i.hint.fill(u,i,!1),u!==Constants.ZWSP+3&&(n.preventDefault(),n.stopPropagation()),o.getAttribute("data-focus")==="true"&&focusByRange(i.toolbar.range);return}const l=hasClosestByMatchTag(s,"BUTTON");if(!l||l.getAttribute("disabled"))return;const r=l.getAttribute("data-type");if(["clear","style2","style4","color","backgroundColor","fontSize","style1"].includes(r)){const u=getFontNodeElements(i),f=l.firstElementChild;r==="style1"?fontEvent(i,u,r,f.style.backgroundColor+Constants.ZWSP+f.style.color):r==="fontSize"?fontEvent(i,u,r,f.textContent.trim()):r==="backgroundColor"?fontEvent(i,u,r,f.style.backgroundColor):r==="color"?fontEvent(i,u,r,f.style.color):fontEvent(i,u,r)}if(n.preventDefault(),n.stopPropagation(),getSelection().rangeCount===0)return;const d=getSelection().getRangeAt(0);if(r==="done"){t.clientHeight>100?(Ft(),focusByRange(d)):(ds(),dn());return}if(window.siyuan.config.readonly||!i||i.disabled)return;if(r==="undo"){i.undo.undo(i);return}else if(r==="redo"){i.undo.redo(i);return}if(getSelection().rangeCount===0)return;const c=hasClosestBlock(d.startContainer);if(c){if(r==="goback"){t.querySelector('.keyboard__action[data-type="goinline"]').classList.remove("protyle-toolbar__item--current");const u=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");u[0].classList.remove("fn__none"),u[1].classList.add("fn__none"),focusByRange(d),e=!0,setTimeout(()=>{e=!1},1e3);return}else if(r==="goinline"){l.classList.add("protyle-toolbar__item--current");const u=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");u[1].classList.remove("fn__none"),u[0].classList.add("fn__none"),focusByRange(d);return}else if(["a","block-ref","inline-math","inline-memo"].includes(r)){hasClosestByAttribute(d.startContainer,"data-type","NodeCodeBlock")||(hideElements(["util"],i),i.toolbar.element.querySelector(`[data-type="${r}"]`).dispatchEvent(new CustomEvent("click")));return}else if(l.classList.contains("keyboard__action")&&["strong","em","s","code","mark","tag","u","sup","clear","sub","kbd"].includes(r)){hasClosestByAttribute(d.startContainer,"data-type","NodeCodeBlock")||i.toolbar.setInlineMark(i,r,"toolbar");return}else if(r==="text"){if(l.classList.contains("protyle-toolbar__item--current"))Ft(),focusByRange(d);else{l.classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const u=i.contentElement.scrollTop;ho(i,t),rs(u)}return}else if(r==="moveup"){moveToUp(i,c,d),focusByRange(d);return}else if(r==="movedown"){moveToDown(i,c,d),focusByRange(d);return}else if(r==="softLine"){d.extractContents(),softEnter(d,c,i),focusByRange(d);return}else if(r==="add"){if(l.classList.contains("protyle-toolbar__item--current"))Ft(),focusByRange(d);else{l.classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const u=i.contentElement.scrollTop;yo(i,t),rs(u)}return}else if(r==="block"){i.gutter.renderMenu(i,c),window.siyuan.menus.menu.fullscreen(),ds(),dn();return}else if(r==="outdent"){listOutdent(i,[c.parentElement],d),focusByRange(d);return}else if(r==="indent"){listIndent(i,[c.parentElement],d),focusByRange(d);return}}})},Ic=()=>{document.getElementById("menu").style.transform="",document.getElementById("sidebar").style.transform="",document.getElementById("model").style.transform="";const e=document.querySelector(".side-mask");e.classList.add("fn__none"),e.style.opacity="",window.siyuan.menus.menu.remove()},Dc=()=>{document.getElementById("model").style.transform="",activeBlur(),hideKeyboardToolbar()},Jn=null,vo=e=>{const t=getCurrentEditor().protyle;if(window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:e.id},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),hideElements(["toolbar","hint","util"],t),t.contentElement.classList.contains("fn__none")&&setEditMode(t,"wysiwyg"),t.notebookId=e.data.notebookId,t.path=e.data.path,e.data.startId===t.wysiwyg.element.firstElementChild.getAttribute("data-node-id")&&e.data.endId===t.wysiwyg.element.lastElementChild.getAttribute("data-node-id")){t.contentElement.scrollTo({top:e.scrollTop,behavior:"smooth"});return}if(e.id!==t.block.rootID&&fetchPost("/api/block/getDocInfo",{id:e.id},n=>{setTitle(n.data.name),t.title.setTitle(n.data.name),t.background.render(n.data.ial,t.block.rootID),t.wysiwyg.renderCustom(n.data.ial)}),e.zoomId){e.zoomId!==t.block.id?fetchPost("/api/block/checkBlockExist",{id:e.id},n=>{n.data&&zoomOut({protyle:t,id:e.id,isPushBack:!1,callback:()=>{t.contentElement.scrollTop=e.scrollTop}})}):t.contentElement.scrollTop=e.scrollTop;return}fetchPost("/api/filetree/getDoc",{id:e.id,startID:e.data.startId,endID:e.data.endId},n=>{t.block.parentID=n.data.parentID,t.block.parent2ID=n.data.parent2ID,t.block.rootID=n.data.rootID,t.block.showAll=!1,t.block.mode=n.data.mode,t.block.blockCount=n.data.blockCount,t.block.id=n.data.id,t.block.action=e.callback,t.wysiwyg.element.setAttribute("data-doc-type",n.data.type),t.wysiwyg.element.innerHTML=n.data.content,processRender(t.wysiwyg.element),highlightRender(t.wysiwyg.element),avRender(t.wysiwyg.element,t),blockRender(t,t.wysiwyg.element,e.scrollTop),n.data.isSyncing?disabledForeverProtyle(t):setReadonlyByConfig(t,!0),t.contentElement.scrollTop=e.scrollTop})},Mc=()=>{const e=getCurrentEditor().protyle;e.wysiwyg.element.firstElementChild&&window.siyuan.backStack.push({id:e.block.showAll?e.block.id:e.block.rootID,data:{startId:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:e.notebookId,path:e.path},scrollTop:e.contentElement.scrollTop,callback:e.block.action,zoomId:e.block.showAll?e.block.id:void 0})},$c=()=>{const e=getCurrentEditor();if(window.siyuan.menus.menu.element.classList.contains("b3-menu--fullscreen")&&!window.siyuan.menus.menu.element.classList.contains("fn__none")){window.siyuan.menus.menu.element.dispatchEvent(new CustomEvent("click",{detail:"back"}));return}else if(document.getElementById("model").style.transform==="translateY(0px)"){const n=document.getElementById("searchAssetsPanel");!n||n.classList.contains("fn__none")?document.getElementById("model").style.transform="":n.classList.add("fn__none");return}else if(window.siyuan.viewer&&!window.siyuan.viewer.destroyed){window.siyuan.viewer.destroy();return}else if(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("sidebar").style.transform==="translateX(0px)"){closePanel();return}else if(e&&!e.protyle.toolbar.subElement.classList.contains("fn__none")){hideElements(["util"],e.protyle),closePanel();return}else if(window.siyuan.dialogs.length!==0){hideElements(["dialog"]),closePanel();return}if(window.JSAndroid&&window.siyuan.backStack.length<1){document.querySelector('#message [data-id="exitTip"]')?window.JSAndroid.returnDesktop():showMessage(window.siyuan.languages.returnDesktop,3e3,"info","exitTip");return}if(window.siyuan.backStack.length<1)return;if(Jn.length===0&&e){const n=e.protyle;Jn.push({id:n.block.showAll?n.block.id:n.block.rootID,data:{startId:n.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:n.notebookId,path:n.path},scrollTop:n.contentElement.scrollTop,callback:n.block.action,zoomId:n.block.showAll?n.block.id:void 0})}const t=window.siyuan.backStack.pop();Jn.push(t),vo(t)},Qn=(e,t,n,a=[])=>{fetchPost("/api/search/searchAsset",{k:t,exts:a},i=>{let s="";i.data.forEach((d,c)=>{s+=`<div data-value="${d.path}" class="b3-list-item${c===0?" b3-list-item--focus":""}"><div class="b3-list-item__text">${d.hName}</div></div>`});const o=e.querySelector(".b3-list"),l=e.querySelector("#preview"),r=e.querySelector("input");o.innerHTML=s||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,i.data.length>0?l.innerHTML=renderAssetsPreview(i.data[0].path):l.innerHTML=window.siyuan.languages.emptyContent,window.siyuan.menus.menu.fullscreen(),t||r.select()})},Hc=(e,t,n,a)=>{const i=new Menu("background-asset");i.isOpen||i.addItem({iconHTML:"",type:"readonly",label:`<div class="fn__flex" style="max-height: 50vh">
<div class="fn__flex-column" style="${isMobile()?"width:100%":"min-width: 260px;max-width:420px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div id="preview" style="width: 360px;display: ${isMobile()||window.outerWidth<window.outerWidth/2+260?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;word-break: break-all;"></div>
</div>`,bind(s){s.style.maxWidth="none";const o=s.querySelector(".b3-list"),l=s.querySelector("#preview");o.addEventListener("mouseover",d=>{const c=d.target,u=hasClosestByClassName(c,"b3-list-item");u&&(l.innerHTML=renderAssetsPreview(u.getAttribute("data-value")))});const r=s.querySelector("input");r.addEventListener("keydown",d=>{if(d.isComposing)return;const c=s.querySelector(".b3-list--empty");if(!c){const u=upDownHint(o,d);u&&(l.innerHTML=renderAssetsPreview(u.getAttribute("data-value")),d.stopPropagation())}if(d.key==="Enter"){if(c)n||(window.siyuan.menus.menu.remove(),focusByRange(e.toolbar.range));else{const u=s.querySelector(".b3-list-item--focus");n?n(u.getAttribute("data-value"),u.textContent):(hintRenderAssets(u.getAttribute("data-value"),e),window.siyuan.menus.menu.remove())}d.preventDefault(),d.stopPropagation()}else d.key==="Escape"&&(n||focusByRange(e.toolbar.range))}),r.addEventListener("input",d=>{d.isComposing||(d.stopPropagation(),Qn(s,r.value,t,a))}),r.addEventListener("compositionend",d=>{d.stopPropagation(),Qn(s,r.value,t,a)}),s.lastElementChild.addEventListener("click",d=>{const c=d.target;if(hasClosestByAttribute(c,"data-type","previous")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),d.stopPropagation();return}if(hasClosestByAttribute(c,"data-type","next")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),d.stopPropagation();return}const g=hasClosestByClassName(c,"b3-list-item");if(g){d.stopPropagation();const p=g.getAttribute("data-value");n?n(p,g.textContent):(hintRenderAssets(p,e),window.siyuan.menus.menu.remove())}}),Qn(s,"",t,a)}})},Nc=(e,t)=>{var n;const a=hasClosestBlock(t);if(!a)return;hideElements(["util","toolbar","hint"],e);const i=a.getAttribute("data-node-id");let s=a.outerHTML;window.siyuan.menus.menu.remove();let o;window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",type:"readonly",label:`<div>ID</div>
<textarea spellcheck="false" rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px" class="b3-text-field" readonly>${t.getAttribute("data-id")||""}</textarea>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.anchor}</div>
<textarea rows="1" style="margin:4px 0;width: ${isMobile()?"200":"360"}px" class="b3-text-field"></textarea>`,bind(d){d.style.maxWidth="none",o=d.querySelectorAll(".b3-text-field")[1],o.value=t.textContent;const c=()=>{o.value?t.innerHTML=Lute.EscapeHTMLStr(o.value):t.innerHTML="*"};o.addEventListener("input",u=>{u.isComposing||(c(),u.stopPropagation())}),o.addEventListener("compositionend",u=>{u.isComposing||(c(),u.stopPropagation())}),o.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(electronUndo(u))return}})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),removeInlineType(t,"file-annotation-ref",e.toolbar.range),updateTransaction(e,i,a.outerHTML,s),s=a.outerHTML}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,a.outerHTML,s),focusByWbr(a,e.toolbar.range),s=a.outerHTML}}).element),(n=e==null?void 0:e.app)!=null&&n.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-fileannotationref",detail:{protyle:e,element:t},separatorPosition:"top"});const l=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+26,h:26});const r=hasTopClosestByClassName(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",r?r.dataset.level+"popover":"app"),o.select(),window.siyuan.menus.menu.removeCB=()=>{a.outerHTML!==s&&(a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,a.outerHTML,s));const d=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);d&&!e.element.contains(d.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range))}},Bc=(e,t)=>{var n;const a=hasClosestBlock(t);if(!a)return;hideElements(["util","toolbar","hint"],e);const i=t.getAttribute("data-id"),s=a.getAttribute("data-node-id");let o=a.outerHTML;if(window.siyuan.menus.menu.remove(),e.disabled||(window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}">`,bind(d){const c=d.querySelector("input");c.value=t.getAttribute("data-subtype")==="d"?"":t.textContent,c.addEventListener("input",()=>{c.value?t.innerHTML=Lute.EscapeHTMLStr(c.value):fetchPost("/api/block/getRefText",{id:i},u=>{t.innerHTML=u.data}),t.setAttribute("data-subtype",c.value?"s":"d")}),c.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(electronUndo(u))return}})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element)),!e.disabled){let d=[];t.getAttribute("data-subtype")==="s"?d.push({iconHTML:"",label:window.siyuan.languages.turnToDynamic,click(){t.setAttribute("data-subtype","d"),fetchPost("/api/block/getRefText",{id:i},c=>{t.innerHTML=c.data,a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,a.outerHTML,o),o=a.outerHTML}),focusByRange(e.toolbar.range)}}):d.push({iconHTML:"",label:window.siyuan.languages.turnToStatic,click(){t.setAttribute("data-subtype","s"),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,a.outerHTML,o),focusByRange(e.toolbar.range),o=a.outerHTML}}),d=d.concat([{iconHTML:"",label:window.siyuan.languages.text,click(){a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),removeInlineType(t,"block-ref",e.toolbar.range),updateTransaction(e,s,a.outerHTML,o),o=a.outerHTML}},{iconHTML:"",label:"*",click(){t.setAttribute("data-subtype","s"),t.textContent="*",a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,a.outerHTML,o),focusByRange(e.toolbar.range),o=a.outerHTML}},{iconHTML:"",label:window.siyuan.languages.text+" *",click(){t.insertAdjacentHTML("beforebegin",t.innerHTML+" "),t.setAttribute("data-subtype","s"),t.textContent="*",a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,a.outerHTML,o),focusByRange(e.toolbar.range),o=a.outerHTML}},{label:window.siyuan.languages.link,iconHTML:"",click(){t.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${t.getAttribute("data-id")}">${t.innerHTML}</span><wbr>`,a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,a.outerHTML,o),focusByWbr(a,e.toolbar.range),o=a.outerHTML}}]),t.parentElement.textContent.trim()===t.textContent.trim()&&t.parentElement.tagName==="DIV"&&d.push({iconHTML:"",label:window.siyuan.languages.blockEmbed,click(){const c=`<div data-content="select * from blocks where id='${i}'" data-node-id="${s}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${dayjs().format("YYYYMMDDHHmmss")}">${a.querySelector(".protyle-attr").outerHTML}</div>`;a.outerHTML=c,updateTransaction(e,s,c,o),blockRender(e,e.wysiwyg.element),o=a.outerHTML}}),d.push({iconHTML:"",label:window.siyuan.languages.defBlock,click(){fetchPost("/api/block/swapBlockRef",{refID:s,defID:i,includeChildren:!1})}}),d.push({iconHTML:"",label:window.siyuan.languages.defBlockChildren,click(){fetchPost("/api/block/swapBlockRef",{refID:s,defID:i,includeChildren:!0})}}),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:d}).element)}window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",click(){writeText(e.lute.BlockDOM2StdMd(t.outerHTML))}}).element),e.disabled||(window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.cut,icon:"iconCut",click(){writeText(e.lute.BlockDOM2StdMd(t.outerHTML)),t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,a.outerHTML,o),focusByWbr(a,e.toolbar.range),o=a.outerHTML}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,a.outerHTML,o),focusByWbr(a,e.toolbar.range),o=a.outerHTML}}).element)),(n=e==null?void 0:e.app)!=null&&n.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-blockref",detail:{protyle:e,element:t},separatorPosition:"top"});const l=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+26,h:26});const r=hasTopClosestByClassName(e.element,"block__popover",!0);window.siyuan.menus.menu.data=t,window.siyuan.menus.menu.element.setAttribute("data-from",r?r.dataset.level+"popover":"app"),e.disabled||(window.siyuan.menus.menu.element.querySelector("input").select(),window.siyuan.menus.menu.removeCB=()=>{a.outerHTML!==o&&(a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,s,a.outerHTML,o));const d=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);d&&!e.element.contains(d.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range))})},Pc=(e,t)=>{var n;const a=getEditorRange(t);window.siyuan.menus.menu.remove(),e.toolbar.showContent(e,a,t),(n=e==null?void 0:e.app)!=null&&n.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-content",detail:{protyle:e,range:a,element:t},separatorPosition:"top"})},Rc=(e,t)=>{if(e.block.showAll)Eo({protyle:e,id:e.block.parent2ID,focusId:t});else{const n=e.path.split("/");n.length>2&&openMobileFileById(e.app,n[n.length-2],[Constants.CB_GET_FOCUS,Constants.CB_GET_SCROLL])}},Eo=e=>{var t,n;if(e.protyle.options.backlinkData)return;typeof e.isPushBack=="undefined"&&(e.isPushBack=!0),typeof e.reload=="undefined"&&(e.reload=!1);const a=(t=e.protyle.breadcrumb)==null?void 0:t.element.querySelector(".protyle-breadcrumb__item--active");if(!e.reload&&a&&a.getAttribute("data-node-id")===e.id){if(e.id===e.protyle.block.rootID)return;const i=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.focusId||e.id}"]`);if(i){focusBlock(i),i.scrollIntoView();return}}(n=window.siyuan.mobile)!=null&&n.editor&&(window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:e.id},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),e.isPushBack&&pushBack()),fetchPost("/api/filetree/getDoc",{id:e.id,size:e.id===e.protyle.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:Constants.SIZE_GET_MAX},i=>{if(e.isPushBack?onGet({data:i,protyle:e.protyle,action:e.id===e.protyle.block.rootID?[Constants.CB_GET_FOCUS,Constants.CB_GET_HTML]:[Constants.CB_GET_ALL,Constants.CB_GET_FOCUS,Constants.CB_GET_HTML],afterCB:e.callback}):onGet({data:i,protyle:e.protyle,action:e.id===e.protyle.block.rootID?[Constants.CB_GET_FOCUS,Constants.CB_GET_HTML,Constants.CB_GET_UNUNDO]:[Constants.CB_GET_ALL,Constants.CB_GET_FOCUS,Constants.CB_GET_UNUNDO,Constants.CB_GET_HTML],afterCB:e.callback}),e.focusId){const s=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.focusId}"]`);if(s){let o=s;for(;o.getBoundingClientRect().height===0;)o=o.parentElement;o.classList.contains("protyle-wysiwyg")?o=s.previousElementSibling||s.nextElementSibling:o=getFirstBlock(o),focusBlock(o),o.scrollIntoView()}else if(e.id===e.protyle.block.rootID){fetchPost("/api/filetree/getDoc",{id:e.focusId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{onGet({data:o,protyle:e.protyle,action:e.isPushBack?[Constants.CB_GET_FOCUS]:[Constants.CB_GET_FOCUS,Constants.CB_GET_UNUNDO]})});return}}else e.id!==e.protyle.block.rootID&&(e.protyle.wysiwyg.element.classList.add("protyle-wysiwyg--animate"),setTimeout(()=>{e.protyle.wysiwyg.element.classList.remove("protyle-wysiwyg--animate")},365))})},Oc=(e,t,n,a)=>{var i,s;window.siyuan.menus.menu.remove();const o=hasClosestBlock(n);if(!o)return;hideElements(["util","toolbar","hint"],e);const l=o.getAttribute("data-node-id"),r=n.querySelector("img"),d=n.querySelector(".protyle-action__title"),c=o.outerHTML;if(e.disabled||(window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.imageURL}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea spellcheck="false" style="margin:4px 0;width: ${isMobile()?"200":"360"}px" rows="1" class="b3-text-field">${r.getAttribute("src")}</textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="margin:4px 0;width: ${isMobile()?"200":"360"}px" rows="1" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.tooltipText}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="margin:4px 0;width: ${isMobile()?"200":"360"}px" rows="1" class="b3-text-field"></textarea>`,bind(p){p.style.maxWidth="none";const m=p.querySelectorAll("textarea");m[0].addEventListener("input",y=>{if(y.isComposing)return;const v=y.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"");if(r.setAttribute("src",v),r.setAttribute("data-src",v),v.startsWith("assets/")){const b=n.querySelector(".img__net");b&&b.remove()}else window.siyuan.config.editor.displayNetImgMark&&n.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>')}),m[1].value=d.textContent,m[1].addEventListener("input",y=>{const v=y.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"");r.setAttribute("title",v),d.textContent=v,mathRender(d)}),m[2].value=r.getAttribute("alt")||"",p.addEventListener("click",y=>{let v=y.target;for(;v;){if(v.dataset.action==="copy"){writeText(v.parentElement.nextElementSibling.value),showMessage(window.siyuan.languages.copied);break}v=v.parentElement}})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element)),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,accelerator:"\u2318C",icon:"iconCopy",click(){let p=e.lute.BlockDOM2StdMd(n.outerHTML);p=p.replace(/%20/g," "),writeText(p)}}).element),e.disabled&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy+" "+window.siyuan.languages.imageURL,icon:"iconLink",click(){writeText(r.getAttribute("src"))}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copyAsPNG,accelerator:window.siyuan.config.keymap.editor.general.copyBlockRef.custom,icon:"iconImage",click(){copyPNGByLink(r.getAttribute("src"))}}).element),!e.disabled){window.siyuan.menus.menu.append(new MenuItem({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){let w=e.lute.BlockDOM2StdMd(n.outerHTML);w=w.replace(/%20/g," "),writeText(w),n.outerHTML="<wbr>",o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,l,o.outerHTML,c),focusByWbr(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:function(){n.outerHTML="<wbr>",o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,l,o.outerHTML,c),focusByWbr(e.wysiwyg.element,t)}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element);const p=r.getAttribute("data-src");p.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameAsset(p)}}).element),window.siyuan.menus.menu.append(new MenuItem({label:"OCR",submenu:[{iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" data-type="ocr" style="margin: 4px 0" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.ocrResult}"></textarea>`,bind(w){w.style.maxWidth="none",fetchPost("/api/asset/getImageOCRText",{path:r.getAttribute("src")},h=>{const C=w.querySelector("textarea");C.value=h.data.text,C.dataset.ocrText=h.data.text})}},{type:"separator"},{iconHTML:"",label:window.siyuan.languages.reOCR,click(){fetchPost("/api/asset/ocr",{path:r.getAttribute("src"),force:!0})}}]}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){alignImgCenter(e,o,[n],l,c)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){alignImgLeft(e,o,[n],l,c)}}).element);const m=r.style.width.endsWith("vw")?parseInt(r.style.width):0;let y;window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.width,submenu:[{iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${r.style.width.endsWith("px")?parseInt(r.style.width):""}" type="number" style="margin: 4px" placeholder="${window.siyuan.languages.width}"> px
</div>`,bind(w){const h=w.querySelector("input");h.addEventListener("input",()=>{y.value="0",y.parentElement.setAttribute("aria-label",h.value?h.value+"px":window.siyuan.languages.default),r.style.width=h.value?h.value+"px":"",r.style.height=""}),h.addEventListener("blur",()=>{h.value!==r.style.width.replace("px","")&&(o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,l,o.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(o))})}},ut("25%",r,e,l,o,c),ut("33%",r,e,l,o,c),ut("50%",r,e,l,o,c),ut("67%",r,e,l,o,c),ut("75%",r,e,l,o,c),ut("100%",r,e,l,o,c),{type:"separator"},{iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${r.style.width.endsWith("px")?r.style.width:((i=r.style.width)==null?void 0:i.replace("vw","%"))||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${isMobile()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${m}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(w){y=w.querySelector("input"),y.addEventListener("input",()=>{r.style.width=y.value+"vw",y.parentElement.setAttribute("aria-label",`${y.value}%`)}),y.addEventListener("change",()=>{o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,l,o.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(o)})}},{type:"separator"},ut(window.siyuan.languages.default,r,e,l,o,c)]}).element);let v;const b=r.style.height.endsWith("vh")?parseInt(r.style.height):0;window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.height,submenu:[{iconHTML:"",type:"readonly",label:`<div class="fn__flex-center">
<input class="b3-text-field" value="${r.style.height.endsWith("px")?parseInt(r.style.height):""}" type="number" style="margin: 4px" placeholder="${window.siyuan.languages.height}"> px
</div>`,bind(w){const h=w.querySelector("input");h.addEventListener("input",()=>{v.value="0",v.parentElement.setAttribute("aria-label",h.value?h.value+"px":window.siyuan.languages.default),r.style.height=h.value?h.value+"px":"",n.style.width="",r.style.width=""}),h.addEventListener("blur",()=>{h.value!==r.style.height.replace("px","")&&(o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,l,o.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(o))})}},ft("25%",r,e,l,o,c),ft("33%",r,e,l,o,c),ft("50%",r,e,l,o,c),ft("67%",r,e,l,o,c),ft("75%",r,e,l,o,c),ft("100%",r,e,l,o,c),{type:"separator"},{iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${r.style.height.endsWith("vh")?parseInt(r.style.height)+"%":r.style.height||window.siyuan.languages.default}" class="b3-tooltips b3-tooltips__n${isMobile()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${b}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(w){v=w.querySelector("input"),v.addEventListener("input",()=>{n.style.width="",r.style.width="",r.style.height=v.value+"vh",v.parentElement.setAttribute("aria-label",`${v.value}%`)}),v.addEventListener("change",()=>{o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,l,o.outerHTML,c),window.siyuan.menus.menu.remove(),focusBlock(o)})}},{type:"separator"},ft(window.siyuan.languages.default,r,e,l,o,c)]}).element)}const u=r.getAttribute("src");u&&(window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),openMenu(e.app,u,!1,!1));const f=r.getAttribute("data-src");f&&f.startsWith("assets/")&&window.siyuan.menus.menu.append(new MenuItem(exportAsset(f)).element),(s=e==null?void 0:e.app)!=null&&s.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-image",detail:{protyle:e,element:n},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY});const g=hasTopClosestByClassName(e.element,"block__popover",!0);if(window.siyuan.menus.menu.element.setAttribute("data-from",g?g.dataset.level+"popover":"app"),!e.disabled){const p=window.siyuan.menus.menu.element.querySelectorAll("textarea");p[1].select(),window.siyuan.menus.menu.removeCB=()=>{const m=window.siyuan.menus.menu.element.querySelector('[data-type="ocr"]');m&&m.dataset.ocrText!==m.value&&fetchPost("/api/asset/setImageOCRText",{path:r.getAttribute("src"),text:m.value}),r.setAttribute("alt",p[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),o.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,l,o.outerHTML,c)}}},ko=(e,t,n=!1)=>{var a;window.siyuan.menus.menu.remove();const i=R(t);if(!i)return;vt(["util","toolbar","hint"],e);const s=i.getAttribute("data-node-id");let o=i.outerHTML;const l=t.getAttribute("data-href");let r;e.disabled||(window.siyuan.menus.menu.append(new Ee({iconHTML:"",type:"readonly",label:`<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.link}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea spellcheck="false" rows="1" style="margin:4px 0;width: ${re()?"200":"360"}px" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.anchor}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${re()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="fn__flex">
    <span class="fn__flex-center">${window.siyuan.languages.title}</span>
    <span class="fn__space"></span>
    <span data-action="copy" class="block__icon block__icon--show b3-tooltips b3-tooltips__e fn__flex-center" aria-label="${window.siyuan.languages.copy}">
        <svg><use xlink:href="#iconCopy"></use></svg>
    </span>   
</div>
<textarea style="width: ${re()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>`,bind(u){u.style.maxWidth="none",r=u.querySelectorAll("textarea"),r[0].value=Lute.UnEscapeHTMLStr(l)||"",r[0].addEventListener("keydown",g=>{if((g.key==="Enter"||g.key==="Escape")&&!g.isComposing)g.preventDefault(),g.stopPropagation(),window.siyuan.menus.menu.remove();else if(g.key==="Tab"&&!g.isComposing)g.preventDefault(),g.stopPropagation(),r[1].focus();else if(Fn(g))return});let f=t.textContent.replace(x.ZWSP,"");!f&&l&&(f=l.replace("https://","").replace("http://",""),f.length>x.SIZE_LINK_TEXT_MAX&&(f=f.substring(0,x.SIZE_LINK_TEXT_MAX)+"..."),t.innerHTML=Lute.EscapeHTMLStr(f)),r[1].value=f,r[1].addEventListener("compositionend",()=>{t.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")||"*")}),r[1].addEventListener("input",g=>{g.isComposing||(t.innerHTML=Lute.EscapeHTMLStr(r[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))||"*")}),r[1].addEventListener("keydown",g=>{if((g.key==="Enter"||g.key==="Escape")&&!g.isComposing)g.preventDefault(),g.stopPropagation(),window.siyuan.menus.menu.remove();else if(g.key==="Tab"&&!g.isComposing)g.preventDefault(),g.stopPropagation(),g.shiftKey?r[0].focus():r[2].focus();else if(Fn(g))return}),r[2].value=Lute.UnEscapeHTMLStr(t.getAttribute("data-title")||""),r[2].addEventListener("keydown",g=>{if((g.key==="Enter"||g.key==="Escape")&&!g.isComposing)g.preventDefault(),g.stopPropagation(),window.siyuan.menus.menu.remove();else if(g.key==="Tab"&&g.shiftKey&&!g.isComposing)g.preventDefault(),g.stopPropagation(),r[1].focus();else if(Fn(g))return}),u.addEventListener("click",g=>{let p=g.target;for(;p;){if(p.dataset.action==="copy"){Dt(p.parentElement.nextElementSibling.value),Qe(window.siyuan.languages.copied);break}p=p.parentElement}})}}).element),window.siyuan.menus.menu.append(new Ee({type:"separator"}).element)),l&&(Ho(e.app,l,!1,!0),l!=null&&l.startsWith("assets/")&&window.siyuan.menus.menu.append(new Ee(_i(l)).element)),e.disabled||(l!=null&&l.startsWith("assets/")&&window.siyuan.menus.menu.append(new Ee({label:window.siyuan.languages.rename,icon:"iconEdit",click(){Ai(l)}}).element),l!=null&&l.startsWith("siyuan://blocks/")&&window.siyuan.menus.menu.append(new Ee({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.ref}</b>`,icon:"iconRef",click(){t.setAttribute("data-subtype","s");const u=t.getAttribute("data-type").split(" ");u.push("block-ref"),u.splice(u.indexOf("a"),1),t.setAttribute("data-type",u.join(" ")),t.setAttribute("data-id",r[0].value.replace("siyuan://blocks/","")),r[0].value="",r[2].value="",t.removeAttribute("data-href"),t.removeAttribute("data-title"),i.setAttribute("updated",je().format("YYYYMMDDHHmmss")),Lt(e,s,i.outerHTML,o),e.toolbar.range.selectNode(t),e.toolbar.range.collapse(!1),Re(e.toolbar.range),o=i.outerHTML}}).element),window.siyuan.menus.menu.append(new Ee({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){r[0].value="",r[2].value="",i.setAttribute("updated",je().format("YYYYMMDDHHmmss")),ji(t,"a",e.toolbar.range),Lt(e,s,i.outerHTML,o),o=i.outerHTML}}).element)),window.siyuan.menus.menu.append(new Ee({label:window.siyuan.languages.copy,icon:"iconCopy",click(){Dt(e.lute.BlockDOM2StdMd(t.outerHTML))}}).element),e.disabled&&window.siyuan.menus.menu.append(new Ee({label:window.siyuan.languages.copy+" "+window.siyuan.languages.replaceTypes.aHref,icon:"iconLink",click(){Dt(l)}}).element),e.disabled||(window.siyuan.menus.menu.append(new Ee({icon:"iconCut",label:window.siyuan.languages.cut,click(){Dt(e.lute.BlockDOM2StdMd(t.outerHTML)),t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),i.setAttribute("updated",je().format("YYYYMMDDHHmmss")),Lt(e,s,i.outerHTML,o),Kt(i,e.toolbar.range),o=i.outerHTML}}).element),window.siyuan.menus.menu.append(new Ee({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),i.setAttribute("updated",je().format("YYYYMMDDHHmmss")),Lt(e,s,i.outerHTML,o),Kt(i,e.toolbar.range),o=i.outerHTML}}).element),(a=e==null?void 0:e.app)!=null&&a.plugins&&so({plugins:e.app.plugins,type:"open-menu-link",detail:{protyle:e,element:t},separatorPosition:"top"}));const d=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:d.left,y:d.top+26,h:26});const c=st(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",c?c.dataset.level+"popover":"app"),!e.disabled&&(n||e.lute.GetLinkDest(l)||l!=null&&l.startsWith("assets/")?r[1].select():r[0].select(),window.siyuan.menus.menu.removeCB=()=>{r[2].value?t.setAttribute("data-title",Lute.EscapeHTMLStr(r[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):t.removeAttribute("data-title"),t.getAttribute("data-type").indexOf("a")>-1?t.setAttribute("data-href",Lute.EscapeHTMLStr(r[0].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):t.removeAttribute("data-href");const u=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);u&&!e.element.contains(u.startContainer)&&(e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),Re(e.toolbar.range)),o!==i.outerHTML&&(i.setAttribute("updated",je().format("YYYYMMDDHHmmss")),Lt(e,s,i.outerHTML,o))})},qc=(e,t)=>{var n;window.siyuan.menus.menu.remove();const a=hasClosestBlock(t);if(!a)return;hideElements(["util","toolbar","hint"],e);const i=a.getAttribute("data-node-id");let s=a.outerHTML;window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.tag}">`,bind(r){const d=r.querySelector("input");d.value=t.textContent.replace(Constants.ZWSP,""),d.addEventListener("change",()=>{updateTransaction(e,i,a.outerHTML,s),s=a.outerHTML}),d.addEventListener("compositionend",()=>{t.innerHTML=Constants.ZWSP+Lute.EscapeHTMLStr(d.value||"")}),d.addEventListener("input",c=>{c.isComposing||(t.innerHTML=Constants.ZWSP+Lute.EscapeHTMLStr(d.value||""))}),d.addEventListener("keydown",c=>{if((c.key==="Enter"||c.key==="Escape")&&!c.isComposing){if(c.preventDefault(),c.stopPropagation(),d.value)e.toolbar.range.selectNodeContents(t),e.toolbar.range.collapse(!1),focusByRange(e.toolbar.range);else{const u=a.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,a.outerHTML,u),focusByWbr(a,e.toolbar.range)}window.siyuan.menus.menu.remove()}else if(electronUndo(c))return})}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.search,accelerator:window.siyuan.languages.click,icon:"iconSearch",click(){popSearch(e.app,{hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${t.textContent}#`,r:"",page:1})}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameTag(t.textContent.replace(Constants.ZWSP,""))}}).element),window.siyuan.menus.menu.append(new MenuItem({type:"separator"}).element),window.siyuan.menus.menu.append(new MenuItem({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){e.toolbar.range.setStart(t.firstChild,0),e.toolbar.range.setEnd(t.lastChild,t.lastChild.textContent.length),e.toolbar.setInlineMark(e,"tag","range")}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",click(){writeText(e.lute.BlockDOM2StdMd(t.outerHTML))}}).element),window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.cut,icon:"iconCut",click(){writeText(e.lute.BlockDOM2StdMd(t.outerHTML));const r=a.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,a.outerHTML,r),focusByWbr(a,e.toolbar.range)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const r=a.outerHTML;t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),a.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,i,a.outerHTML,r),focusByWbr(a,e.toolbar.range)}}).element),(n=e==null?void 0:e.app)!=null&&n.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-tag",detail:{protyle:e,element:t},separatorPosition:"top"});const o=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26});const l=hasTopClosestByClassName(e.element,"block__popover",!0);window.siyuan.menus.menu.element.setAttribute("data-from",l?l.dataset.level+"popover":"app"),window.siyuan.menus.menu.element.querySelector("input").select()},Fc=(e,t)=>{window.siyuan.menus.menu.remove();const n=hasClosestBlock(t);if(!n)return;const a=n.getAttribute("data-node-id"),i=n.outerHTML;window.siyuan.menus.menu.append(new MenuItem({label:window.siyuan.languages.copy,icon:"iconCopy",click(){writeText(e.lute.BlockDOM2StdMd(t.outerHTML))}}).element),e.disabled||(window.siyuan.menus.menu.append(new MenuItem({icon:"iconCut",label:window.siyuan.languages.cut,click(){writeText(e.lute.BlockDOM2StdMd(t.outerHTML)),t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,a,n.outerHTML,i),focusByWbr(n,e.toolbar.range)}}).element),window.siyuan.menus.menu.append(new MenuItem({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){t.insertAdjacentHTML("afterend","<wbr>"),t.remove(),n.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(e,a,n.outerHTML,i),focusByWbr(n,e.toolbar.range)}}).element));const s=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:s.left,y:s.top+26,h:26})},ut=(e,t,n,a,i,s)=>({iconHTML:"",label:e,click(){i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),e===window.siyuan.languages.default?t.style.width="":t.style.width=e.replace("%","vw"),t.style.height="",updateTransaction(n,a,i.outerHTML,s),focusBlock(i)}}),ft=(e,t,n,a,i,s)=>({iconHTML:"",label:e,click(){i.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),e===window.siyuan.languages.default?t.style.height="":t.style.height=parseInt(e)+"vh",t.style.width="",updateTransaction(n,a,i.outerHTML,s),focusBlock(i)}}),Yc=(e,t)=>{const n=t.getAttribute("data-node-id"),a=t.querySelector("iframe");let i=t.outerHTML;const s=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.link}" style="margin: 4px 0">${a.getAttribute("src")||""}</textarea>`,bind(l){l.style.maxWidth="none",l.querySelector("textarea").addEventListener("change",r=>{const d=r.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""),c=d.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(d.indexOf("bilibili.com")>-1&&(d.indexOf("bvid=")>-1||c&&c[1])){const u={bvid:getSearch("bvid",d)||c&&c[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true",autoplay:"0"};new URL(d.startsWith("http")?d:"https:"+d).search.split("&").forEach((p,m)=>{if(!p)return;m===0&&(p=p.substr(1));const y=p.split("=");u[y[0]]=y[1]});let f="https://player.bilibili.com/player.html?";const g=Object.keys(u);g.forEach((p,m)=>{f+=`${p}=${u[p]}`,m<g.length-1&&(f+="&")}),a.setAttribute("src",f),a.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),a.style.height||(a.style.height="360px"),a.style.width||(a.style.width="640px")}else a.setAttribute("src",d);updateTransaction(e,n,t.outerHTML,i),i=t.outerHTML,r.stopPropagation()})}}],o=a.getAttribute("src");return o?(s.push({type:"separator"}),s.concat(openMenu(e.app,o,!0,!1))):s},Uc=(e,t,n)=>{const a=t.getAttribute("data-node-id"),i=t.querySelector(n==="NodeVideo"?"video":"audio");let s=t.outerHTML;const o=[{id:"asset",iconHTML:"",type:"readonly",label:`<textarea spellcheck="false" rows="1" style="margin: 4px 0" class="b3-text-field" placeholder="${window.siyuan.languages.link}">${i.getAttribute("src")}</textarea>`,bind(r){r.style.maxWidth="none",r.querySelector("textarea").addEventListener("change",d=>{i.setAttribute("src",d.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),updateTransaction(e,a,t.outerHTML,s),s=t.outerHTML,d.stopPropagation()})}}],l=i.getAttribute("src");return l&&l.startsWith("assets/")&&(o.push({type:"separator"}),o.push({id:"rename",label:window.siyuan.languages.rename,icon:"iconEdit",click(){renameAsset(l)}})),l&&o.push({id:"openBy",label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:openMenu(e.app,l,!0,!1)}),l&&l.startsWith("assets/")&&o.push(exportAsset(l)),o},Wc=(e,t,n,a)=>{var i;const s=[],o=getColIndex(n);(n.rowSpan>1||n.colSpan>1)&&s.push({label:window.siyuan.languages.cancelMerged,click:()=>{const I=t.outerHTML;let T=n.rowSpan,D=n.parentElement;const M=n.colSpan;for(;T>0&&D;){let $=D.children[o],q=M;for(;q>0&&$;)$.classList.remove("fn__none"),$.colSpan=1,$.rowSpan=1,$=$.nextElementSibling,q--;D=D.nextElementSibling,T--}if(n.rowSpan=1,n.colSpan=1,n.tagName==="TH"){let $;if(Array.from(t.querySelectorAll("thead tr")).find(q=>{if($=q,Array.from(q.children).forEach(j=>{(j.rowSpan!==1||j.classList.contains("fn__none"))&&($=void 0)}),$)return!0}),$){const q=t.querySelector("tbody"),j=t.querySelector("thead");for(;!$.isSameNode(j.lastElementChild);)q.insertAdjacentElement("afterbegin",j.lastElementChild)}}focusByRange(a),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,I)}});const l=t.querySelectorAll("col")[o];(l.style.width||l.style.minWidth)&&s.push({label:window.siyuan.languages.useDefaultWidth,click:()=>{const I=t.outerHTML;l.style.width="",l.style.minWidth="",updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,I)}});const r=t.getAttribute("custom-pinthead");s.push({icon:r?"iconUnpin":"iconPin",label:r?window.siyuan.languages.unpinTableHead:window.siyuan.languages.pinTableHead,click:()=>{const I=t.outerHTML;r?t.removeAttribute("custom-pinthead"):t.setAttribute("custom-pinthead","true"),updateTransaction(e,t.getAttribute("data-node-id"),t.outerHTML,I)}}),s.push({type:"separator"}),s.push({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{setTableAlign(e,[n],t,"left",a)}}),s.push({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{setTableAlign(e,[n],t,"center",a)}}),s.push({icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{setTableAlign(e,[n],t,"right",a)}}),s.push({icon:"",label:window.siyuan.languages.useDefaultAlign,click:()=>{setTableAlign(e,[n],t,"",a)}});const d=[];d.push(...s),d.push({type:"separator"});const c=t.querySelector("table"),u=n.parentElement.querySelector(".fn__none");let f=!1,g=!1;Array.from(n.parentElement.children).forEach(I=>{I.colSpan>1&&(f=!0),I.rowSpan>1&&(g=!0)});let p=!1,m=!1,y=!1,v=n.parentElement.previousElementSibling;!v&&n.parentElement.parentElement.tagName==="TBODY"&&(v=c.querySelector("thead").lastElementChild),v&&(p=v.querySelector(".fn__none"),Array.from(v.children).forEach(I=>{I.colSpan>1&&(m=!0),I.rowSpan>1&&(y=!0)}));let b=!1,w=!1,h=!1,C=n.parentElement.nextElementSibling;!C&&n.parentElement.parentElement.tagName==="THEAD"&&(C=(i=c.querySelector("tbody"))==null?void 0:i.firstElementChild),C&&(b=C.querySelector(".fn__none"),Array.from(C.children).forEach(I=>{I.colSpan>1&&(w=!0),I.rowSpan>1&&(h=!0)}));let k=!0;Array.from(c.rows).find(I=>{const T=I.cells[o];if(T.classList.contains("fn__none")||T.colSpan>1||T.rowSpan>1)return k=!1,!0});let E=!0;Array.from(c.rows).find(I=>{const T=I.cells[o+1];if(T&&(T.classList.contains("fn__none")||T.colSpan>1||T.rowSpan>1))return E=!1,!0});let _=!0;Array.from(c.rows).find(I=>{const T=I.cells[o-1];if(T&&(T.classList.contains("fn__none")||T.colSpan>1||T.rowSpan>1))return _=!1,!0});const L=[];L.push({icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{insertRowAbove(e,a,n,t)}}),(!b||b&&!h&&w)&&L.push({icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{insertRow(e,a,n,t)}}),(k||_)&&L.push({icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{insertColumn(e,t,n,"beforebegin",a)}}),(k||E)&&L.push({icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{insertColumn(e,t,n,"afterend",a)}}),d.push(...L);const A=[];((!u||u&&!g&&f)&&(!p||p&&!y&&m)||(!u||u&&!g&&f)&&(!b||b&&!h&&w)||k&&_||k&&E)&&A.push({type:"separator"}),(!u||u&&!g&&f)&&(!p||p&&!y&&m)&&A.push({icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{moveRowToUp(e,a,n,t)}}),(!u||u&&!g&&f)&&(!b||b&&!h&&w)&&A.push({icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{moveRowToDown(e,a,n,t)}}),k&&_&&A.push({icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{moveColumnToLeft(e,a,n,t)}}),k&&E&&A.push({icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{moveColumnToRight(e,a,n,t)}}),d.push(...A),(n.parentElement.parentElement.tagName!=="THEAD"&&(!u&&!g||u&&!g&&f)||k)&&d.push({type:"separator"});const S=[];return n.parentElement.parentElement.tagName!=="THEAD"&&(!u&&!g||u&&!g&&f)&&S.push({icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{deleteRow(e,a,n,t)}}),k&&S.push({icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{deleteColumn(e,a,t,n)}}),d.push(...S),{menus:d,removeMenus:S,insertMenus:L,otherMenus:s,other2Menus:A}},jc=(e,t,n,a,i=!0)=>{if(t.getAttribute("data-type")==="NodeListItem"&&t.childElementCount<4||t.getAttribute("data-type")==="NodeThematicBreak")return-1;const s=t.getAttribute("fold")==="1";if(s){if(typeof n=="boolean"&&!n)return-1;t.removeAttribute("fold"),t.querySelectorAll(".protyle-linenumber__rows").forEach(l=>{lineNumberRender(l.parentElement)})}else{if(typeof n=="boolean"&&n)return-1;if(t.setAttribute("fold","1"),getSelection().rangeCount>0){const l=getSelection().getRangeAt(0),r=hasClosestBlock(l.startContainer);r&&r.getBoundingClientRect().width===0&&focusBlock(t,void 0,!1)}t.querySelectorAll(".img--select, .av__cell--select, .av__cell--active, .av__row--select").forEach(l=>{var r;l.classList.contains("av__row--select")?(l.classList.remove("av__row--select"),l.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),updateHeader(l)):((r=l.querySelector(".av__drag-fill"))==null||r.remove(),l.classList.remove("img--select","av__cell--select","av__cell--active"))})}const o=t.getAttribute("data-node-id");return t.getAttribute("data-type")==="NodeHeading"?s?(i&&t.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" height="24px" src="/stage/loading-pure.svg"></div>'),transaction(e,[{action:"unfoldHeading",id:o,data:a?"remove":void 0}],[{action:"foldHeading",id:o}])):(transaction(e,[{action:"foldHeading",id:o}],[{action:"unfoldHeading",id:o}]),removeFoldHeading(t)):transaction(e,[{action:"setAttrs",id:o,data:JSON.stringify({fold:s?"":"1"})}],[{action:"setAttrs",id:o,data:JSON.stringify({fold:s?"1":""})}]),preventScroll(e),s?0:1},Co=(e,t,n,a)=>{var i,s,o,l,r,d,c;preventScroll(e);const u=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if((u==null?void 0:u.length)>0){const E=[],_=[];let L,A=!1;a==="Backspace"?(L=u[0].previousElementSibling,L||(A=!0,L=u[u.length-1].nextElementSibling)):(L=u[u.length-1].nextElementSibling,A=!0,L||(A=!1,L=u[0].previousElementSibling));let S,I;hideElements(["select"],e);let T;if(u.find(D=>{const M=getTopAloneElement(D);I=M.parentElement;const $=M.getAttribute("data-node-id");if(E.push({action:"delete",id:$}),a==="Backspace"?(L=getPreviousBlock(M),L||(A=!0,L=getNextBlock(M))):(L=getNextBlock(M),A=!0,L||(A=!1,L=getPreviousBlock(M))),L||(L=M.parentElement||e.wysiwyg.element.firstElementChild,A=!1),M.getAttribute("data-type")==="NodeHeading"&&M.getAttribute("fold")==="1"){setFold(e,M,void 0,!0);let q=M.previousElementSibling?M.previousElementSibling.getAttribute("data-node-id"):"";typeof T!="undefined"&&(q=T),_.push({action:"insert",data:M.outerHTML,id:$,previousID:q,parentID:M.parentElement.getAttribute("data-node-id")||e.block.parentID});let j=getPreviousBlock(M);for(;j&&j.childElementCount===3;)j=getPreviousBlock(j);j?T=j.getAttribute("data-node-id"):T="",M.firstElementChild.removeAttribute("contenteditable");const P=M.nextElementSibling;if(P){const G=P.getAttribute("data-type");if(G!=="NodeHeading"||G==="NodeHeading"&&P.getAttribute("data-subtype")>M.getAttribute("data-subtype"))return!0}}else{let q=M.outerHTML;(M.classList.contains("render-node")||M.querySelector("div.render-node"))&&(q=e.lute.SpinBlockDOM(M.outerHTML));let j=M.previousElementSibling?M.previousElementSibling.getAttribute("data-node-id"):"";typeof T!="undefined"&&(j=T),_.push({action:"insert",data:q,id:$,previousID:j,parentID:M.parentElement.getAttribute("data-node-id")||e.block.parentID}),M.getAttribute("data-subtype")==="o"&&M.classList.contains("li")?S=M.parentElement:S=void 0,M.remove()}}),L)if(e.block.showAll&&L.classList.contains("protyle-wysiwyg")&&e.wysiwyg.element.childElementCount===0)setTimeout(()=>{zoomOut({protyle:e,id:e.block.parent2ID,focusId:e.block.parent2ID})},Constants.TIMEOUT_INPUT*2+100);else{if(L.classList.contains("protyle-wysiwyg")&&e.wysiwyg.element.childElementCount===0){const D=Lute.NewNodeID(),M=genEmptyElement(!1,!0,D);L.insertAdjacentElement("afterbegin",M),E.push({action:"insert",data:M.outerHTML,id:D,parentID:L.getAttribute("data-node-id")||e.block.parentID}),_.push({action:"delete",id:D}),L=void 0,focusByWbr(M,n)}a!=="Backspace"&&A?focusBlock(L):focusBlock(L,void 0,!1),scrollCenter(e,L),S&&(_.push({action:"update",id:S.getAttribute("data-node-id"),data:S.outerHTML}),updateListOrder(S,1),E.push({action:"update",id:S.getAttribute("data-node-id"),data:S.outerHTML}))}if(E.length>0)if(I&&I.getAttribute("data-type")==="NodeSuperBlock"&&I.childElementCount===2){const D=cancelSB(e,I);transaction(e,E.concat(D.doOperations),D.undoOperations.concat(_.reverse()))}else transaction(e,E,_.reverse());hideElements(["util"],e);return}const f=t.getAttribute("data-type");if(f==="NodeCodeBlock"&&getContenteditableElement(t).textContent.trim()===""){t.classList.add("protyle-wysiwyg--select"),Co(e,t,n,a);return}if(!t.previousElementSibling&&t.parentElement.getAttribute("data-type")==="NodeBlockquote"){n.insertNode(document.createElement("wbr"));const E=t.parentElement;E.insertAdjacentElement("beforebegin",t),E.childElementCount===1?(transaction(e,[{action:"move",id:t.getAttribute("data-node-id"),previousID:(i=t.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:E.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"delete",id:E.getAttribute("data-node-id")}],[{action:"insert",id:E.getAttribute("data-node-id"),data:E.outerHTML,previousID:(s=t.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:E.parentElement.getAttribute("data-node-id")||e.block.parentID},{action:"move",id:t.getAttribute("data-node-id"),parentID:E.getAttribute("data-node-id")}]),E.remove()):transaction(e,[{action:"move",id:t.getAttribute("data-node-id"),previousID:(o=t.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:E.parentElement.getAttribute("data-node-id")||e.block.parentID}],[{action:"move",id:t.getAttribute("data-node-id"),parentID:E.getAttribute("data-node-id")}]),focusByWbr(t,n);return}if(t.parentElement.classList.contains("li")&&t.getAttribute("data-type")!=="NodeHeading"&&t.previousElementSibling.classList.contains("protyle-action")){Ao(e,t,n,a==="Delete");return}const g=getPreviousBlock(t);if(["NodeCodeBlock","NodeTable","NodeAttributeView"].includes(f)){if(g)if(g.classList.contains("p")&&getContenteditableElement(g).textContent===""){const E=getPreviousBlock(g);transaction(e,[{action:"delete",id:g.getAttribute("data-node-id")}],[{action:"insert",data:g.outerHTML,id:g.getAttribute("data-node-id"),parentID:g.parentElement.getAttribute("data-node-id")||e.block.parentID,previousID:E&&(!g.previousElementSibling||!g.previousElementSibling.classList.contains("protyle-action"))?E.getAttribute("data-node-id"):void 0}]),g.remove()}else focusBlock(g,void 0,!1);return}if(f==="NodeHeading"){turnsIntoTransaction({protyle:e,selectsElement:[t],type:"Blocks2Ps",range:ea(t,n,a==="Delete")});return}if(t.previousElementSibling&&t.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;if(!g){if(e.wysiwyg.element.childElementCount>1&&getContenteditableElement(t).textContent===""){focusBlock(e.wysiwyg.element.firstElementChild.nextElementSibling);const E=getTopAloneElement(t);transaction(e,[{action:"delete",id:E.getAttribute("data-node-id")}],[{action:"insert",data:E.outerHTML,id:E.getAttribute("data-node-id"),parentID:e.block.parentID}]),E.remove()}return}const p=t.parentElement,m=getContenteditableElement(t),y=getLastBlock(g);if(n.toString()===""&&isMobile()&&y&&y.classList.contains("hr")&&getSelectionOffset(m).start===0){transaction(e,[{action:"delete",id:y.getAttribute("data-node-id")}],[{action:"insert",data:y.outerHTML,id:y.getAttribute("data-node-id"),previousID:(l=y.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:y.parentElement.getAttribute("data-node-id")}]),y.remove();return}const v=y&&(y.classList.contains("table")||y.classList.contains("render-node")||y.classList.contains("iframe")||y.classList.contains("hr")||y.classList.contains("av")||y.classList.contains("code-block")),b=y.getAttribute("data-node-id");if(v){if(y.classList.contains("code-block")){if(m.textContent.trim()===""){const E=t.getAttribute("data-node-id"),_=[{action:"delete",id:E}],L=[{action:"insert",data:t.outerHTML,id:E,previousID:(r=t.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:t.parentElement.getAttribute("data-node-id")}];if(t.remove(),p.getAttribute("data-type")==="NodeSuperBlock"&&p.childElementCount===2){const A=cancelSB(e,p);transaction(e,_.concat(A.doOperations),A.undoOperations.concat(L))}else transaction(e,_,L);focusBlock(e.wysiwyg.element.querySelector(`[data-node-id="${b}"]`),void 0,!1)}else focusBlock(y,void 0,!1);return}if(m.textContent!==""||t.classList.contains("av")){focusBlock(y,void 0,!1);return}}const w=getTopEmptyElement(t),h=w.getAttribute("data-node-id");n.insertNode(document.createElement("wbr"));const C=[{action:"update",data:y.outerHTML,id:b},{action:"insert",data:w.outerHTML,id:h,previousID:(d=t.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:p.getAttribute("data-node-id")}],k=[{action:"delete",id:h}];if(v)w.remove(),focusBlock(y,void 0,!1);else{const E=getContenteditableElement(y);if(m&&(m.textContent!==""||m.querySelector(".emoji"))&&(n.setEndAfter(m.lastChild),(((c=E==null?void 0:E.lastElementChild)==null?void 0:c.getAttribute("data-type"))||"").indexOf("inline-math")>-1)){const A=hasNextSibling(E==null?void 0:E.lastElementChild);A&&A.textContent===`
`&&A.remove()}const _=e.contentElement.scrollTop,L=n.extractContents();n.selectNodeContents(E),n.collapse(!1),n.insertNode(L),w.remove(),e.contentElement.scrollTop=_,e.scroll.lastScrollTop=_-1,k.push({action:"update",data:y.outerHTML,id:b})}if(p.getAttribute("data-type")==="NodeSuperBlock"&&p.childElementCount===2){const E=cancelSB(e,p);transaction(e,k.concat(E.doOperations),E.undoOperations.concat(C))}else transaction(e,k,C);focusByWbr(e.wysiwyg.element,n)},ea=(e,t,n)=>{if(n){const a=getPreviousBlock(e);if(a){const i=getContenteditableElement(getLastBlock(a));if(i)return setLastNodeRange(i,t,!1)}}},Vc=(e,t,n,a)=>{const i=t.outerHTML,s=hasPreviousSibling(e);s&&s.textContent.endsWith(Constants.ZWSP)&&(s.textContent=s.textContent.substring(0,s.textContent.length-1));const o=hasNextSibling(e);o&&o.textContent.startsWith(Constants.ZWSP)&&(o.textContent=o.textContent.replace(Constants.ZWSP,"")),e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),updateTransaction(a,t.getAttribute("data-node-id"),t.outerHTML,i),focusByWbr(t,n);const l=getContenteditableElement(t);l.innerHTML.trim()===""&&(l.innerHTML="")},Ao=(e,t,n,a=!1)=>{var i;if(!t.parentElement.previousElementSibling&&t.parentElement.nextElementSibling&&t.parentElement.nextElementSibling.classList.contains("protyle-attr")){listOutdent(e,[t.parentElement],n,a,t);return}if(!t.parentElement.previousElementSibling&&t.parentElement.parentElement.parentElement.classList.contains("list")){n.insertNode(document.createElement("wbr"));const f=t.parentElement.parentElement,g=f.outerHTML,p=t.parentElement.parentElement.previousElementSibling.lastElementChild,m=p.parentElement.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove(),p.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),f.getAttribute("data-subtype")==="o"&&updateListOrder(f),transaction(e,[{action:"update",id:f.getAttribute("data-node-id"),data:f.outerHTML},{action:"update",data:p.parentElement.outerHTML,id:p.parentElement.getAttribute("data-node-id")}],[{action:"update",data:m,id:p.parentElement.getAttribute("data-node-id")},{action:"update",data:g,id:f.getAttribute("data-node-id")}]),focusByWbr(p.parentElement,n);return}if(!t.parentElement.previousElementSibling){if(t.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;ea(t,n,a),n.insertNode(document.createElement("wbr"));const f=t.parentElement.parentElement,g=f.outerHTML;t.parentElement.firstElementChild.remove(),t.parentElement.lastElementChild.remove();const p=document.createElement("div");p.innerHTML=t.parentElement.innerHTML;const m=[],y=[];Array.from(p.children).forEach((v,b)=>{var w;m.push({action:"insert",id:v.getAttribute("data-node-id"),data:v.outerHTML,previousID:b===0?(w=f.previousElementSibling)==null?void 0:w.getAttribute("data-node-id"):m[b-1].id,parentID:f.parentElement.getAttribute("data-node-id")||e.block.parentID}),y.push({action:"delete",id:v.getAttribute("data-node-id")})}),f.insertAdjacentHTML("beforebegin",t.parentElement.innerHTML),t.parentElement.remove(),f.getAttribute("data-subtype")==="o"&&updateListOrder(f,parseInt(f.firstElementChild.getAttribute("data-marker"))-1),m.splice(0,0,{action:"update",id:f.getAttribute("data-node-id"),data:f.outerHTML}),y.push({action:"update",data:g,id:f.getAttribute("data-node-id")}),transaction(e,m,y),focusByWbr(e.wysiwyg.element,n);return}const s=t.parentElement;if(s.previousElementSibling&&s.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const o=s.getAttribute("data-node-id"),l=s.parentElement;ea(t,n,a),n.insertNode(document.createElement("wbr"));const r=l.outerHTML,d=[],c=[{action:"insert",id:o,data:"",previousID:s.previousElementSibling.getAttribute("data-node-id")}],u=s.previousElementSibling.lastElementChild;if(s.previousElementSibling.getAttribute("fold")==="1")if(getContenteditableElement(t).textContent.trim()===""&&t.nextElementSibling.classList.contains("protyle-attr"))d.push({action:"delete",id:o}),c[0].data=s.outerHTML,setLastNodeRange(getContenteditableElement(s.previousElementSibling),n),n.collapse(!0),s.remove();else{setLastNodeRange(getContenteditableElement(s.previousElementSibling),n),n.collapse(!0),focusByRange(n),(i=t.querySelector("wbr"))==null||i.remove();return}else{let f=u.previousElementSibling.getAttribute("data-node-id");Array.from(t.parentElement.children).forEach((g,p)=>{if(g.classList.contains("protyle-action")||g.classList.contains("protyle-attr"))return;const m=g.getAttribute("data-node-id");d.push({action:"move",id:m,previousID:f}),c.push({action:"move",id:m,previousID:p===1?void 0:f,parentID:o}),f=m,u.before(g)}),d.push({action:"delete",id:o}),c[0].data=s.outerHTML,s.remove()}l.classList.contains("protyle-wysiwyg")?transaction(e,d,c):(l.getAttribute("data-subtype")==="o"&&updateListOrder(l),updateTransaction(e,l.getAttribute("data-node-id"),l.outerHTML,r)),focusByWbr(u.parentElement,n)},Ve=(e,t)=>{if(e.getAttribute("data-subtype")!=="o")return;let n;Array.from(e.children).forEach((a,i)=>{i===0?t?(n=t,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+"."):n=parseInt(a.getAttribute("data-marker")):a.classList.contains("li")&&(n++,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+".")})},Lo=(e,t=0,n=!1)=>{const a=document.createElement("template"),i=e.getAttribute("data-subtype");if(i==="o"){const s=parseInt(e.getAttribute("data-marker"))+t;a.innerHTML=`<div data-marker="${s+1}." data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${s+1}.</div>${genEmptyBlock(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`}else i==="t"?a.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${genEmptyBlock(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`:a.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${genEmptyBlock(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`;return a.content.firstElementChild},Gc=(e,t,n)=>{var a;const i=hasClosestByClassName(t,"li");if(!i)return;const s=(a=i.querySelector(".list"))==null?void 0:a.lastElementChild.previousElementSibling;if(!s)return;const o=Lo(s,0,!0),l=o.getAttribute("data-node-id");s.after(o),s.parentElement.getAttribute("fold")==="1"&&setFold(e,s.parentElement,!0),i.getAttribute("fold")==="1"&&setFold(e,i,!0),transaction(e,[{action:"insert",id:l,data:o.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:l}]),focusByWbr(o,n)},zc=(e,t,n)=>{const a=t[0].previousElementSibling;if(!a)return;n.collapse(!1),n.insertNode(document.createElement("wbr")),t.forEach(s=>{s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end")});const i=a.parentElement.outerHTML;if(a.lastElementChild.previousElementSibling.getAttribute("data-type")==="NodeList"){const s=a.lastElementChild.previousElementSibling.outerHTML,o=[],l=[],r=a.lastElementChild.previousElementSibling.getAttribute("data-subtype");let d=a.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");t.forEach((c,u)=>{o.push({action:"move",id:c.getAttribute("data-node-id"),previousID:d}),l.push({action:"move",id:c.getAttribute("data-node-id"),previousID:u===0?a.getAttribute("data-node-id"):d}),d=c.getAttribute("data-node-id"),c.setAttribute("data-subtype",r);const f=c.querySelector(".protyle-action");r==="o"?(f.classList.add("protyle-action--order"),f.classList.remove("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(c)):r==="t"?(c.setAttribute("data-marker","*"),f.innerHTML=`<svg><use xlink:href="#icon${c.classList.contains("protyle-task--done")?"Check":"Uncheck"}"></use></svg>`,f.classList.remove("protyle-action--order"),f.classList.add("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(c)):(c.setAttribute("data-marker","*"),f.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',f.classList.remove("protyle-action--order","protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(c))}),r==="o"?(Ve(a.lastElementChild.previousElementSibling),Ve(a.parentElement)):a.getAttribute("data-subtype")==="o"&&Ve(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")&&(o.push({action:"update",data:a.lastElementChild.previousElementSibling.outerHTML,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),l.push({action:"update",data:s,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),transaction(e,o,l))}else{const s=a.outerHTML,o=t[0].getAttribute("data-subtype"),l=document.createElement("div"),r=Lute.NewNodeID();l.setAttribute("data-node-id",r),l.setAttribute("data-type","NodeList"),l.setAttribute("class","list"),l.setAttribute("data-subtype",o),l.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const d=[{action:"insert",data:l.outerHTML,id:r,previousID:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];a.lastElementChild.before(l);const c=[];let u;t.forEach((f,g)=>{d.push({action:"move",id:f.getAttribute("data-node-id"),parentID:r,previousID:u}),c.push({action:"move",id:f.getAttribute("data-node-id"),previousID:g===0?a.getAttribute("data-node-id"):u}),u=f.getAttribute("data-node-id"),l.lastElementChild.before(f)}),c.push({action:"delete",id:r}),o==="o"&&(Ve(l,1),Ve(a.parentElement)),a.parentElement.classList.contains("protyle-wysiwyg")&&(d.push({action:"update",data:a.outerHTML,id:a.getAttribute("data-node-id")}),c.push({action:"update",data:s,id:a.getAttribute("data-node-id")}),transaction(e,d,c))}a.parentElement.classList.contains("protyle-wysiwyg")||updateTransaction(e,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,i),focusByWbr(a,n)},Kc=(e,t,n)=>{var a,i;const s=t.parentElement,o=s.getAttribute("data-node-id"),l=[],r=[];n.insertNode(document.createElement("wbr"));const d=Lute.NewNodeID();let c="",u=0;Array.from(s.parentElement.children).forEach(g=>{!u&&g.isSameNode(s)?u=1:u&&!g.classList.contains("protyle-attr")&&(r.push({id:g.getAttribute("data-node-id"),action:"move",previousID:o}),l.push({id:g.getAttribute("data-node-id"),action:"delete"}),g.getAttribute("data-subtype")==="o"&&(r.push({id:g.getAttribute("data-node-id"),action:"update",data:g.outerHTML}),g.setAttribute("data-marker",u+"."),g.firstElementChild.innerHTML=u+"."),c+=g.outerHTML,g.remove(),u++)}),r.reverse(),c=`<div data-subtype="${s.getAttribute("data-subtype")}" data-node-id="${d}" data-type="NodeList" class="list" updated="${dayjs().format("YYYYMMDDHHmmss")}">${c}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`,s.parentElement.insertAdjacentHTML("afterend",c),l.push({id:d,action:"insert",previousID:s.parentElement.getAttribute("data-node-id"),data:c}),r.push({id:d,action:"delete"}),Array.from(s.children).reverse().forEach(g=>{!g.classList.contains("protyle-action")&&!g.classList.contains("protyle-attr")&&(l.push({id:g.getAttribute("data-node-id"),action:"move",previousID:s.parentElement.getAttribute("data-node-id")}),r.push({id:g.getAttribute("data-node-id"),action:"move",parentID:o}),s.parentElement.after(g))});const f=s.parentElement.getAttribute("data-node-id");s.parentElement.childElementCount===2?(r.splice(0,0,{id:f,action:"insert",data:s.parentElement.outerHTML,previousID:(a=s.parentElement.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),parentID:s.parentElement.parentElement.getAttribute("data-node-id")||e.block.rootID}),s.parentElement.remove(),l.push({id:f,action:"delete"})):(r.splice(0,0,{id:o,action:"insert",data:s.outerHTML,previousID:(i=s.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:f}),s.remove(),l.push({id:o,action:"delete"})),transaction(e,l,r),focusByWbr(e.wysiwyg.element,n)},Zc=(e,t,n,a=!1,i)=>{var s,o,l,r,d,c,u,f;const g=t[0].parentElement,p=g.getAttribute("data-node-id");if(!p)return;const m=g.parentElement,y=m.parentElement;if((s=g.previousElementSibling)!=null&&s.classList.contains("protyle-action")&&!y.getAttribute("data-node-id"))return;if(m.classList.contains("protyle-wysiwyg")||m.classList.contains("sb")||m.classList.contains("bq")){const _=[],L=[];n.collapse(!1),moveToPrevious(i,n,a),n.insertNode(document.createElement("wbr"));let A;!t[0].previousElementSibling&&g.getAttribute("data-subtype")==="o"&&(A=parseInt(t[0].getAttribute("data-marker")));let S=p,I=g,T=t[t.length-1].nextElementSibling,D=t[t.length-1].lastElementChild.previousElementSibling;if(t.forEach($=>{$.classList.remove("protyle-wysiwyg--select"),$.removeAttribute("select-start"),$.removeAttribute("select-end"),Array.from($.children).forEach((q,j)=>{const P=q.getAttribute("data-node-id");P&&(_.push({action:"move",id:P,previousID:S,parentID:m.getAttribute("data-node-id")||e.block.parentID}),L.push({action:"move",id:P,previousID:j===1?void 0:S,parentID:$.getAttribute("data-node-id"),data:q.contains(n.startContainer)?"focus":""}),S=P,I.after(q),I=q)})}),!window.siyuan.config.editor.listLogicalOutdent&&!T.classList.contains("protyle-attr")){let $;D.getAttribute("data-subtype")!==T.getAttribute("data-subtype")&&($=Lute.NewNodeID(),D=document.createElement("div"),D.classList.add("list"),D.setAttribute("data-subtype",T.getAttribute("data-subtype")),D.setAttribute("data-node-id",$),D.setAttribute("data-type","NodeList"),D.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),D.innerHTML=`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,I.after(D),_.push({action:"insert",id:$,data:D.outerHTML,previousID:I.getAttribute("data-node-id")}));let q;for(;T&&!T.classList.contains("protyle-attr");){_.push({action:"move",id:T.getAttribute("data-node-id"),previousID:q||((o=D.lastElementChild.previousElementSibling)==null?void 0:o.getAttribute("data-node-id")),parentID:D.getAttribute("data-node-id")}),L.push({action:"move",id:T.getAttribute("data-node-id"),parentID:D.getAttribute("data-node-id"),previousID:q||((l=T.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"))}),q=T.getAttribute("data-node-id");const j=T;T=T.nextElementSibling,D.lastElementChild.before(j)}D.getAttribute("data-subtype")==="o"&&(Array.from(D.children).forEach(j=>{const P=j.getAttribute("data-node-id");P&&L.push({action:"update",id:P,data:j.outerHTML})}),Ve(D,1),Array.from(D.children).forEach(j=>{const P=j.getAttribute("data-node-id");P&&_.push({action:"update",id:P,data:j.outerHTML})})),$&&L.push({action:"delete",id:$})}const M=g.outerHTML;t.forEach($=>{$.remove()}),g.childElementCount===1?(_.push({action:"delete",id:p}),p===e.block.id&&(e.block.id=e.block.parentID),L.splice(0,0,{action:"insert",data:M,id:p,previousID:(r=g.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:m.getAttribute("data-node-id")||e.block.parentID}),g.remove()):(g.getAttribute("data-subtype")==="o"&&Ve(g,A),_.push({action:"update",id:p,data:g.outerHTML}),L.splice(0,0,{action:"update",id:p,data:M})),transaction(e,_,L),focusByWbr(m,n);return}if(g.childElementCount===2&&m.childElementCount===3){n.collapse(!1),moveToPrevious(i,n,a),n.insertNode(document.createElement("wbr"));const _=m.outerHTML;t[0].firstElementChild.remove(),t[0].lastElementChild.remove(),g.outerHTML=t[0].innerHTML,updateTransaction(e,m.getAttribute("data-node-id"),m.outerHTML,_),focusByWbr(m,n);return}n.collapse(!1),moveToPrevious(i,n,a),n.insertNode(document.createElement("wbr"));const v=[],b=[],w=(d=t[0].previousElementSibling)==null?void 0:d.getAttribute("data-node-id");t.forEach(_=>{_.classList.remove("protyle-wysiwyg--select"),_.removeAttribute("select-start"),_.removeAttribute("select-end")});let h;!t[0].previousElementSibling&&g.getAttribute("data-subtype")==="o"&&(h=parseInt(t[0].getAttribute("data-marker")));const C=m.parentElement.outerHTML;let k=t[t.length-1].nextElementSibling,E=t[t.length-1].lastElementChild.previousElementSibling;if(t.reverse().forEach(_=>{const L=_.getAttribute("data-node-id");v.push({action:"move",id:L,previousID:m.getAttribute("data-node-id")}),b.push({action:"move",id:L,previousID:w,parentID:g.getAttribute("data-node-id")}),m.after(_),(_.getAttribute("data-subtype")==="o"||_.getAttribute("data-subtype")==="t")&&m.getAttribute("data-subtype")==="u"?(b.push({action:"update",id:L,data:_.outerHTML}),_.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',_.setAttribute("data-subtype","u"),_.setAttribute("data-marker","*"),_.classList.remove("protyle-task--done"),v.push({action:"update",id:L,data:_.outerHTML})):(_.getAttribute("data-subtype")==="u"||_.getAttribute("data-subtype")==="t")&&m.getAttribute("data-subtype")==="o"?(b.push({action:"update",id:L,data:_.outerHTML}),_.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',_.setAttribute("data-subtype","o"),_.setAttribute("data-marker","1."),v.push({action:"update",id:L,data:_.outerHTML})):(_.getAttribute("data-subtype")==="u"||_.getAttribute("data-subtype")==="o")&&m.getAttribute("data-subtype")==="t"&&(b.push({action:"update",id:L,data:_.outerHTML}),_.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',_.setAttribute("data-subtype","t"),_.setAttribute("data-marker","*"),v.push({action:"update",id:L,data:_.outerHTML}))}),!window.siyuan.config.editor.listLogicalOutdent&&!k.classList.contains("protyle-attr")){let _;E.classList.contains("list")||(_=Lute.NewNodeID(),E=document.createElement("div"),E.classList.add("list"),E.setAttribute("data-subtype",k.getAttribute("data-subtype")),E.setAttribute("data-node-id",_),E.setAttribute("data-type","NodeList"),E.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),E.innerHTML=`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,v.push({action:"insert",id:_,data:E.outerHTML,previousID:t[0].lastElementChild.previousElementSibling.getAttribute("data-node-id")}),t[0].lastElementChild.before(E));let L;for(;k&&!k.classList.contains("protyle-attr");){const A=k.getAttribute("data-node-id");k.getAttribute("data-subtype")!==E.getAttribute("data-subtype")&&(b.push({action:"update",id:A,data:k.outerHTML}),k.querySelector(".protyle-action").outerHTML=E.querySelector(".protyle-action").outerHTML,k.setAttribute("data-subtype",E.getAttribute("data-subtype")),k.setAttribute("data-marker",E.getAttribute("data-marker")),v.push({action:"update",id:A,data:k.outerHTML})),v.push({action:"move",id:A,previousID:L||((c=E.lastElementChild.previousElementSibling)==null?void 0:c.getAttribute("data-node-id")),parentID:E.getAttribute("data-node-id")}),b.push({action:"move",id:A,previousID:L||((u=E.parentElement)==null?void 0:u.getAttribute("data-node-id"))}),L=A;const S=k;k=k.nextElementSibling,E.lastElementChild.before(S)}E.getAttribute("data-subtype")==="o"&&(Array.from(E.children).forEach(A=>{const S=A.getAttribute("data-node-id");S&&b.push({action:"update",id:S,data:A.outerHTML})}),Ve(E,1),Array.from(E.children).forEach(A=>{const S=A.getAttribute("data-node-id");S&&v.push({action:"update",id:S,data:A.outerHTML})})),_&&b.push({action:"delete",id:_})}if(!window.siyuan.config.editor.listLogicalOutdent&&g.nextElementSibling){k=g.nextElementSibling;let _;for(;k&&!k.classList.contains("protyle-attr");){const L=k.getAttribute("data-node-id");v.push({action:"move",id:L,previousID:_||E.getAttribute("data-node-id")}),b.push({action:"move",id:L,previousID:_||g.getAttribute("data-node-id")}),_=L;const A=k;k=k.nextElementSibling,E.after(A),E=A}}g.childElementCount===1&&m.childElementCount===3?(v.push({action:"delete",id:m.getAttribute("data-node-id")}),b.splice(0,0,{action:"insert",id:m.getAttribute("data-node-id"),data:m.outerHTML,previousID:(f=m.previousElementSibling)==null?void 0:f.getAttribute("data-node-id"),parentID:m.parentElement.getAttribute("data-node-id")}),m.remove()):g.childElementCount===1?(v.push({action:"delete",id:g.getAttribute("data-node-id")}),b.splice(0,0,{action:"insert",id:g.getAttribute("data-node-id"),data:g.outerHTML,previousID:g.previousElementSibling.getAttribute("data-node-id")}),g.remove()):g.getAttribute("data-subtype")==="o"&&(b.splice(0,0,{action:"update",data:g.outerHTML,id:g.getAttribute("data-node-id")}),Ve(g,h),v.push({action:"update",data:g.outerHTML,id:g.getAttribute("data-node-id")})),y.classList.contains("protyle-wysiwyg")?transaction(e,v,b):(m&&m.getAttribute("data-subtype")==="o"&&Ve(y),updateTransaction(e,y.getAttribute("data-node-id"),y.outerHTML,C)),focusByWbr(y,n)},Xc=(e,t)=>{const n=[],a=[];let i=t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):void 0;t.classList.remove("protyle-wysiwyg--select"),t.removeAttribute("select-start"),t.removeAttribute("select-end");const s=t.getAttribute("data-node-id"),o=t.cloneNode();return o.innerHTML=t.lastElementChild.outerHTML,a.push({action:"insert",id:s,data:o.outerHTML,previousID:t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID}),Array.from(t.children).forEach((l,r)=>{if(r===t.childElementCount-1){n.push({action:"delete",id:s}),t.lastElementChild.remove(),t.outerHTML=t.innerHTML;return}n.push({action:"move",id:l.getAttribute("data-node-id"),previousID:i,parentID:t.parentElement.getAttribute("data-node-id")||e.block.parentID}),a.push({action:"move",id:l.getAttribute("data-node-id"),previousID:l.previousElementSibling?l.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:s}),i=l.getAttribute("data-node-id")}),n.forEach(l=>{const r=e.wysiwyg.element.querySelector(`[data-node-id="${l.id}"]`);r&&r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),blockRender(e,r))}),{doOperations:n,undoOperations:a,previousId:i}},Jc=(e,t,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",t||Lute.NewNodeID()),a.setAttribute("data-type","NodeSuperBlock"),a.setAttribute("class","sb"),a.setAttribute("data-sb-layout",e),a.innerHTML=n||`<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div>`,a},Qc=(e,t,n)=>{fetchPost("/api/block/getBlockSiblingID",{id:t.getAttribute("data-node-id")},a=>{const i=a.data[n];i&&openMobileFileById(e.app,i,[Constants.CB_GET_FOCUS,i!==e.block.rootID&&e.block.showAll?Constants.CB_GET_ALL:""])})},eu=(e,t,n)=>{const a=getEditorRange(e.wysiwyg.element);let i;if(n)i=e.wysiwyg.element.querySelector(`[data-node-id="${n}"]`);else{const d=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");d.length>0?(t==="beforebegin"?i=d[0]:i=d[d.length-1],hideElements(["select"],e)):(i=hasClosestBlock(a.startContainer),i=getTopAloneElement(i))}if(!i)return;let s=ta(!1,!0),o=1;i.getAttribute("data-type")==="NodeListItem"&&(s=genListItemElement(i,0,!0),o=parseInt(i.parentElement.firstElementChild.getAttribute("data-marker")));const l=i.parentElement.outerHTML,r=s.getAttribute("data-node-id");if(i.insertAdjacentElement(t,s),i.getAttribute("data-type")==="NodeListItem"&&i.getAttribute("data-subtype")==="o"&&!s.parentElement.classList.contains("protyle-wysiwyg"))updateListOrder(s.parentElement,o),updateTransaction(e,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,l);else{let d;t==="beforebegin"?d=[{action:"insert",data:s.outerHTML,id:r,nextID:i.getAttribute("data-node-id")}]:d=[{action:"insert",data:s.outerHTML,id:r,previousID:i.getAttribute("data-node-id")}],transaction(e,d,[{action:"delete",id:r}])}focusByWbr(e.wysiwyg.element,a),scrollCenter(e)},tu=(e=!0,t=!0,n)=>{let a="";return e&&(a=Constants.ZWSP),t&&(a+="<wbr>"),n&&(a+=n),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${a}</div><div contenteditable="false" class="protyle-attr">${Constants.ZWSP}</div></div>`},ta=(e=!0,t=!0,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",n||Lute.NewNodeID()),a.setAttribute("data-type","NodeParagraph"),a.classList.add("p"),a.innerHTML=`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${e?x.ZWSP:""}${t?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${x.ZWSP}</div>`,a},nu=e=>{let t=e;switch(e){case"NodeIFrame":t="IFrame";break;case"NodeAttributeView":t=window.siyuan.languages.database;break;case"NodeThematicBreak":t=window.siyuan.languages.line;break;case"NodeWidget":t=window.siyuan.languages.widget;break;case"NodeVideo":t=window.siyuan.languages.video;break;case"NodeAudio":t=window.siyuan.languages.audio;break;case"NodeBlockQueryEmbed":t=window.siyuan.languages.blockEmbed;break}return t},au=(e,t,n,a,i)=>{var s;if(t!=="NodeCodeBlock"&&!((s=n.previousElementSibling)!=null&&s.classList.contains("protyle-action--task"))&&(["[ ]","[x]","[X]","\u3010 \u3011","\u3010x\u3011","\u3010X\u3011"].includes(a.innerHTML.substring(0,3))||["[]","\u3010\u3011"].includes(a.innerHTML.substring(0,2)))){const o=a.innerHTML.indexOf("]")+1||a.innerHTML.indexOf("\u3011")+1,l=a.innerHTML.substring(1,2).toLowerCase()==="x";if(n.parentElement.classList.contains("li")&&n.parentElement.childElementCount===3){if(!n.parentElement.parentElement.classList.contains("protyle-wysiwyg")&&n.parentElement.parentElement.childElementCount===2){const r=n.parentElement.parentElement,d=r.outerHTML;return r.setAttribute("data-subtype","t"),r.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),n.parentElement.setAttribute("data-subtype","t"),l&&n.parentElement.classList.add("protyle-task--done"),n.previousElementSibling.outerHTML=`<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${l?"C":"Unc"}heck"></use></svg></div>`,a.innerHTML=a.innerHTML.substring(o),updateTransaction(e,r.getAttribute("data-node-id"),r.outerHTML,d),focusByWbr(e.wysiwyg.element,i),!0}return!1}else{const r=n.getAttribute("data-node-id"),d=Lute.NewNodeID(),c=Lute.NewNodeID(),u=Lute.NewNodeID(),f=n.outerHTML;return a.innerHTML=a.innerHTML.substring(o),transaction(e,[{action:"update",id:r,data:n.outerHTML},{action:"insert",id:d,data:`<div data-subtype="t" data-node-id="${d}" updated="${d.split("-")[0]}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${u}" data-type="NodeListItem" class="li${l?" protyle-task--done":""}" updated="${u.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${l?"C":"Unc"}heck"></use></svg></div><div data-node-id="${c}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:r},{action:"move",id:r,previousID:c},{action:"delete",id:c}],[{action:"move",id:r,previousID:d},{action:"delete",id:d},{action:"update",id:r,data:f}]),n.outerHTML=`<div data-subtype="t" data-node-id="${d}" data-type="NodeList" class="list" updated="${d.split("-")[0]}"><div data-marker="*" data-subtype="t" data-node-id="${u}" data-type="NodeListItem" class="li${l?" protyle-task--done":""}" updated="${u.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${l?"C":"Unc"}heck"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,focusByWbr(e.wysiwyg.element,i),!0}}return!1},su=(e,t,n,a,i)=>{if(t==="NodeHeading"&&["* ","- "].includes(a.innerHTML.substring(0,2))&&n.parentElement.getAttribute("data-type")!=="NodeListItem"){const s=n.getAttribute("data-node-id"),o=Lute.NewNodeID(),l=Lute.NewNodeID(),r=Lute.NewNodeID(),d=n.outerHTML,c=a.innerHTML.substring(0,1);return a.innerHTML=a.innerHTML.substring(2),transaction(e,[{action:"update",id:s,data:n.outerHTML},{action:"insert",id:o,data:`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${c}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div data-node-id="${l}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:s},{action:"move",id:s,previousID:l},{action:"delete",id:l}],[{action:"update",id:s,data:d},{action:"move",id:s,previousID:o},{action:"delete",id:o}]),n.outerHTML=`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${c}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,focusByWbr(e.wysiwyg.element,i),!0}return!1};var So=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const iu=(e,t,n,a=!0,i)=>So(void 0,null,function*(){var s,o,l,r;if(!t.parentElement)return;if(t.classList.contains("av")){hasClosestByClassName(n.startContainer,"av__cursor")?n.startContainer.textContent=Constants.ZWSP:updateAVName(e,t);return}const d=getContenteditableElement(t),c=t.getAttribute("data-type");if(!d){c==="NodeThematicBreak"?t.innerHTML="<div><wbr></div>":c==="NodeBlockQueryEmbed"?t.lastElementChild.previousElementSibling.innerHTML="<wbr>"+Constants.ZWSP:c==="NodeMathBlock"||c==="NodeHTMLBlock"?t.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+Constants.ZWSP:c==="NodeIFrame"||c==="NodeWidget"?t.innerHTML="<wbr>"+t.firstElementChild.outerHTML+t.lastElementChild.outerHTML:c==="NodeVideo"?t.firstElementChild.innerHTML="<wbr>"+Constants.ZWSP+t.firstElementChild.firstElementChild.outerHTML+t.firstElementChild.lastElementChild.outerHTML:c==="NodeAudio"?t.firstElementChild.innerHTML=t.firstElementChild.firstElementChild.outerHTML+"<wbr>"+Constants.ZWSP:c==="NodeCodeBlock"&&(n.startContainer.textContent=Constants.ZWSP),focusByWbr(t,n);return}t.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss"));const u=document.createElement("wbr");if(n.insertNode(u),i){const w=hasNextSibling(u);if(i.inputType==="deleteContentForward"&&w&&w.nodeType===1&&!w.textContent.startsWith(Constants.ZWSP)){const h=(w.getAttribute("data-type")||"").split(" ");(h.includes("code")||h.includes("kbd")||h.includes("tag"))&&w.insertAdjacentElement("afterbegin",u)}(i.inputType==="deleteContentBackward"||i.inputType==="deleteContentForward")&&w&&w.nodeType===1&&w.tagName==="BR"&&w.remove()}const f=t.getAttribute("data-node-id");if(c!=="NodeCodeBlock"&&c!=="NodeHeading"&&(d.innerHTML.endsWith(`
<wbr>`)||d.innerHTML.endsWith(`
<wbr>
`))){updateTransaction(e,f,t.outerHTML,e.wysiwyg.lastHTMLs[f]||t.outerHTML.replace(`
<wbr>`,"<wbr>")),u.remove();return}if(turnIntoTaskList(e,c,t,d,n)||headingTurnIntoList(e,c,t,d,n))return;const g=t.querySelector("br");g&&g.parentElement.tagName!=="TD"&&g.parentElement.tagName!=="TH"&&(g.parentElement.textContent.trim()===""||((o=(s=g.previousSibling)==null?void 0:s.previousSibling)==null?void 0:o.textContent)===`
`)&&g.remove(),c!=="NodeHeading"&&(d.innerHTML.startsWith("\u300B<wbr>")||d.innerHTML.indexOf(`
\u300B<wbr>`)>-1)&&(d.innerHTML=d.innerHTML.replace("\u300B<wbr>","><wbr>"));const p=d.innerHTML.trimStart();if(!((p.startsWith("````")||p.startsWith("\xB7\xB7\xB7\xB7")||p.startsWith("~~~~"))&&p.indexOf(`
`)===-1)){if((p.startsWith("```")||p.startsWith("\xB7\xB7\xB7")||p.startsWith("~~~"))&&p.indexOf(`
`)===-1&&p.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")===-1){updateTransaction(e,f,t.outerHTML,e.wysiwyg.lastHTMLs[f]),u.remove();return}}(p==="\xA5\xA5<wbr>"||p==="\uFFE5\uFFE5<wbr>")&&(d.innerHTML="$$<wbr>");const m=hasClosestByAttribute(n.startContainer,"data-type","block-ref");m&&m.getAttribute("data-subtype")==="d"&&(yield fetchSyncPost("/api/block/getRefText",{id:m.getAttribute("data-id")})).data!==m.innerHTML.replace("<wbr>","")&&m.setAttribute("data-subtype","s");let y=t.outerHTML,v=!1;if(["---","___","***"].includes(d.textContent)&&c!=="NodeCodeBlock"){y=`<div data-node-id="${f}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const w=t.nextElementSibling;w&&w.getAttribute("data-node-id")?isNotEditBlock(w)?v=!0:focusBlock(w):y+=genEmptyBlock(!1,!0)}else{if(c!=="NodeCodeBlock"&&(p.startsWith("```")||p.startsWith("~~~")||p.startsWith("\xB7\xB7\xB7")||p.indexOf("\n```")>-1||p.indexOf(`
~~~`)>-1||p.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(p.indexOf(`
`)===-1&&p.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let w=d.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();w.endsWith("\n```")||(w=w.replace("<wbr>","")+"<wbr>\n```"),d.innerHTML=w,y=t.outerHTML}y=e.lute.SpinBlockDOM(y)}hideElements(["util"],e,!0);const b=document.createElement("template");if(b.innerHTML=y,a&&(((l=getContenteditableElement(b.content.firstElementChild))==null?void 0:l.innerHTML)!==getContenteditableElement(t).innerHTML||b.content.childElementCount===1&&((r=getContenteditableElement(b.content.firstElementChild))==null?void 0:r.innerHTML)==="<wbr>")&&!(b.content.childElementCount===1&&b.content.firstElementChild.classList.contains("code-block")&&c==="NodeCodeBlock")){log("SpinBlockDOM",t.outerHTML,"argument",e.options.debugger),log("SpinBlockDOM",y,"result",e.options.debugger),t.getAttribute("data-type")==="NodeHeading"&&t.getAttribute("fold")==="1"&&b.content.firstElementChild.getAttribute("data-subtype")!==t.dataset.subtype&&(setFold(e,t,void 0,void 0,!1),y=y.replace(' fold="1"',""),e.wysiwyg.lastHTMLs[f]=t.outerHTML);let w;t.classList.contains("table")&&(w=t.firstElementChild.scrollLeft),/<span data-type="backslash">.+<\/span><wbr>/.test(y)?t.outerHTML=y:t.outerHTML=y.replace("</span><wbr>","</span>"+Constants.ZWSP+"<wbr>"),e.wysiwyg.element.querySelectorAll(`[data-node-id="${f}"]`).forEach(h=>{isInEmbedBlock(h)||(t=h)}),y.split('<span data-type="inline-math" data-subtype="math"').length>1&&Array.from(t.querySelectorAll('[data-type="inline-math"]')).find(h=>{if(h.dataset.content.indexOf("<wbr>")>-1)return h.setAttribute("data-content",h.dataset.content.replace("<wbr>","")),e.toolbar.showRender(e,h),!0}),Array.from(b.content.children).forEach((h,C)=>{const k=h.getAttribute("data-node-id");let E;k===f?E=t:E=e.wysiwyg.element.querySelector(`[data-node-id="${k}"]`);const _=E.getAttribute("data-type");if(_==="NodeCodeBlock"){const L=E.querySelector(".protyle-action__language");L?(window.siyuan.storage[Constants.LOCAL_CODELANG]&&L.textContent===""&&(L.textContent=window.siyuan.storage[Constants.LOCAL_CODELANG]),highlightRender(E)):b.content.childElementCount===1&&e.toolbar.showRender(e,E)}else if(["NodeMathBlock","NodeHTMLBlock"].includes(_))_==="NodeMathBlock"&&mathRender(E),e.toolbar.showRender(e,E);else if(_==="NodeBlockQueryEmbed")blockRender(e,E),e.toolbar.showRender(e,E),hideElements(["hint"],e);else if(_==="NodeThematicBreak"&&v)focusBlock(t);else if(E.querySelectorAll('[data-type="block-ref"][data-subtype="d"]').forEach(L=>{L.textContent===""&&fetchPost("/api/block/getRefText",{id:L.getAttribute("data-id")},A=>{L.innerHTML=A.data})}),mathRender(E),C===b.content.childElementCount-1){const L=t.querySelector("wbr");if(L&&L.parentElement.tagName==="SPAN"&&L.parentElement.innerHTML==="<wbr>"){const A=L.parentElement.getAttribute("data-type")||"";(A.includes("sup")||A.includes("u")||A.includes("sub"))&&L.insertAdjacentText("beforebegin",Constants.ZWSP)}focusByWbr(e.wysiwyg.element,n),e.hint.render(e),w>0&&(t.firstElementChild.scrollLeft=w)}})}else t.getAttribute("data-type")==="NodeCodeBlock"?(d.parentElement.removeAttribute("data-render"),highlightRender(t)):(focusByWbr(e.wysiwyg.element,n),e.hint.render(e));hideElements(["gutter"],e),xo(y,e,f)}),xo=(e,t,n)=>{const a=document.createElement("template");a.innerHTML=e;const i=[],s=[];Array.from(a.content.children).forEach((o,l)=>{var r;o.getAttribute("spellcheck")==="false"&&o.getAttribute("contenteditable")==="false"&&o.setAttribute("contenteditable","true");const d=o.getAttribute("data-node-id");if(d===n)i.push({id:n,data:o.outerHTML,action:"update"}),s.push({id:n,data:t.wysiwyg.lastHTMLs[n],action:"update"});else{let c;l===0&&(c=t.wysiwyg.element.querySelector(`[data-node-id="${d}"]`)),i.push({action:"insert",data:o.outerHTML,id:d,previousID:l===0?(r=c==null?void 0:c.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"):o.previousElementSibling.getAttribute("data-node-id"),parentID:(c==null?void 0:c.parentElement.getAttribute("data-node-id"))||t.block.parentID}),s.push({id:d,action:"delete"})}}),transaction(t,i,s)},To=(e,t,n,a)=>{const i=document.createElement("template");i.innerHTML=t;let s=[];if(t.endsWith("]")&&t.startsWith("["))try{s=JSON.parse(t)}catch(l){console.warn("insert cell: JSON.parse error")}else i.content.querySelector("table")&&i.content.querySelectorAll("tr").forEach(l=>{s.push([]),Array.from(l.children).forEach(r=>{s[s.length-1].push({text:{content:r.textContent},type:"text"})})});const o=a.dataset.avId;fetchPost("/api/av/getAttributeViewKeysByAvID",{avID:o},l=>{var r,d;const c=l.data;if(s&&Array.isArray(s)&&s.length>0){const m=Array.from(a.querySelectorAll(".av__cell--active, .av__cell--select"))||[];m.length===0&&a.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(k=>{k.querySelectorAll(".av__cell").forEach(E=>{m.push(E)})}),m.length===0&&m.push(a.querySelector(".av__row:not(.av__row--header) .av__cell"));const y=[],v=[],b=a.dataset.avId,w=a.dataset.nodeId;let h;const C=m[0].getAttribute("data-col-id");s.find(k=>{if(h?h=h.nextElementSibling:h=m[0].parentElement,!h.classList.contains("av__row"))return!0;let E;k.find(_=>{var L;if(E?E=E.nextElementSibling:E=h.querySelector(`.av__cell[data-col-id="${C}"]`),!E.classList.contains("av__cell"))return!0;const A=getTypeByCellElement(E)||E.dataset.type;if(["created","updated","template","rollup"].includes(A)||A==="block"&&!E.dataset.detached)return;const S=h.getAttribute("data-id"),I=E.getAttribute("data-id"),T=E.getAttribute("data-col-id"),D=genCellValueByElement(A,E);if(_.type!==A&&!(["select","mSelect"].includes(A)&&["select","mSelect"].includes(_.type))){if(A==="date"||!((L=_[_.type])==null?void 0:L.content))return;_=genCellValue(A,_[_.type].content.toString())}if(_.type==="block")_.isDetached=!0,delete _.block.id;else if(A==="select"||A==="mSelect"){const M=mergeAddOption(c.find($=>$.id===E.dataset.colId),_,b);y.push(...M.doOperations),v.push(...M.undoOperations)}_.id=I,!(_.type==="date"&&typeof _.date=="string"||_.type==="relation"&&typeof _.relation=="string")&&(objEquals(_,D)||(y.push({action:"updateAttrViewCell",id:I,avID:b,keyID:T,rowID:S,data:_}),v.push({action:"updateAttrViewCell",id:I,avID:b,keyID:T,rowID:S,data:D}),updateAttrViewCellAnimation(E,_)))})}),y.length>0&&(y.push({action:"doUpdateUpdated",id:w,data:dayjs().format("YYYYMMDDHHmmss")}),v.push({action:"doUpdateUpdated",id:w,data:a.getAttribute("updated")}),transaction(n,y,v));return}const u=getContenteditableElement(i.content.firstElementChild);if(u&&u.childNodes.length===1&&((r=u.firstElementChild)==null?void 0:r.getAttribute("data-type"))==="block-ref"){const m=a.querySelector(".av__cell--select");if(m){const y=u.firstElementChild.getAttribute("data-id"),v=m.dataset.blockId;transaction(n,[{action:"replaceAttrViewBlock",avID:o,previousID:v,nextID:y,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:o,previousID:y,nextID:v,isDetached:m.dataset.detached==="true"}]),updateAttrViewCellAnimation(m,{type:"block",isDetached:!1,block:{content:u.firstElementChild.textContent,id:y}});return}}const f=n.lute.BlockDOM2Content(t),g=Array.from(a.querySelectorAll(".av__cell--select"));a.querySelector(".av__row--select")?updateCellsValue(n,a,f,void 0,c,t):g.length>0?(updateCellsValue(n,a,f,g,c,t),(d=document.querySelector(".av__panel"))==null||d.remove()):hasClosestByClassName(e.startContainer,"av__title")&&(e.insertNode(document.createTextNode(f)),e.collapse(!1),updateAVName(n,a))})},ou=(e,t,n=!1,a=!1,i=!1)=>{var s,o,l,r;if(e==="")return;const d=a?t.toolbar.range:getEditorRange(t.wysiwyg.element);fixTableRange(d);let c;hasClosestByAttribute(d.startContainer,"data-type","NodeTable")&&!n&&(hasClosestByMatchTag(d.startContainer,"TABLE")?c=t.lute.BlockDOM2InlineBlockDOM(e):n=!0);let u=hasClosestBlock(d.startContainer);if(u||(t.toolbar.range?u=hasClosestBlock(t.toolbar.range.startContainer):u=t.wysiwyg.element.firstElementChild),!u)return;if(u.classList.contains("av")){d.deleteContents(),To(d,e,t,u);return}let f=u.getAttribute("data-node-id");d.insertNode(document.createElement("wbr"));let g=u.outerHTML;const p=u.getAttribute("data-type")==="NodeCodeBlock";if(!n&&(p||t.toolbar.getCurrentType(d).includes("code"))){d.deleteContents(),d.insertNode(document.createTextNode(e.replace(/\r\n|\r|\u2028|\u2029/g,`
`))),d.collapse(!1),d.insertNode(document.createElement("wbr")),p?((s=u.querySelector('[data-render="true"]'))==null||s.removeAttribute("data-render"),highlightRender(u)):focusByWbr(u,d),u.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),updateTransaction(t,f,u.outerHTML,g),setTimeout(()=>{scrollCenter(t,u,!1,"smooth")},Constants.TIMEOUT_LOAD);return}const m=[],y=[];if(d.toString()!==""){const _=hasClosestByAttribute(d.commonAncestorContainer,"data-type","inline-math");_?_.remove():(d.startContainer.nodeType===3&&((o=d.startContainer.parentElement.getAttribute("data-type"))==null?void 0:o.indexOf("block-ref"))>-1&&d.startContainer.parentElement.remove(),d.deleteContents()),d.insertNode(document.createElement("wbr")),m.push({action:"update",id:f,data:g}),y.push({action:"update",id:f,data:u.outerHTML})}const v=document.createElement("template");let b=c||t.lute.SpinBlockDOM(e)||e;b=b.replace(/;;;lt;;;/g,"&lt;").replace(/;;;gt;;;/g,"&gt;"),v.innerHTML=b;const w=getContenteditableElement(u);if(!n&&(v.content.firstChild.nodeType===3||v.content.firstChild.nodeType!==3&&(v.content.firstElementChild.classList.contains("p")&&v.content.childElementCount===1||v.content.firstElementChild.tagName!=="DIV"))){v.content.firstChild.nodeType!==3&&v.content.firstElementChild.classList.contains("p")&&(v.innerHTML=v.content.firstElementChild.firstElementChild.innerHTML.trim());const _=d.startContainer.nodeType===3?d.startContainer.parentElement:d.startContainer;if(_.tagName==="SPAN"&&_.isSameNode(d.endContainer.nodeType===3?d.endContainer.parentElement:d.endContainer)&&v.content.querySelector("span, img")){const L=document.createElement("span"),A=_.attributes;for(let S=0;S<A.length;S++)L.setAttribute(A[S].name,A[S].value);d.setEnd(_.lastChild,_.lastChild.textContent.length),L.append(d.extractContents()),_.after(L),d.setStartBefore(L),d.collapse(!0)}d.insertNode(v.content.cloneNode(!0)),d.collapse(!1),(l=u.querySelector("wbr"))==null||l.remove(),t.wysiwyg.lastHTMLs[f]=g,input(t,u,d);return}const h=hasClosestByClassName(u,"li");if(((r=v.content.children[0])==null?void 0:r.getAttribute("data-type"))==="NodeListItem")if(h)u=h,f=u.getAttribute("data-node-id"),g=u.outerHTML;else{const L=v.content.children[0].getAttribute("data-subtype");v.innerHTML=`<div${L==="o"?' data-marker="1."':""} data-subtype="${L}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${e}<div class="protyle-attr" contenteditable="false">${Constants.ZWSP}</div></div>`}let C,k=!1;!d.toString()&&i&&getSelectionOffset(u,t.wysiwyg.element,d).start===0&&w.textContent!==""&&(k=!0),(k?Array.from(v.content.children):Array.from(v.content.children).reverse()).forEach(_=>{let L=_.getAttribute("data-node-id");if(L===f)y.push({action:"update",data:_.outerHTML,id:L}),m.push({action:"update",id:L,data:g});else{if(_.classList.contains("li")&&!u.parentElement.classList.contains("list")){L=Lute.NewNodeID();const A=document.createElement("div");A.setAttribute("data-subtype",_.getAttribute("data-subtype")),A.setAttribute("data-node-id",L),A.setAttribute("data-type","NodeList"),A.setAttribute("updated",dayjs().format("YYYYMMDDHHmmss")),A.classList.add("list"),A.append(_),_=A}y.push({action:"insert",data:_.outerHTML,id:L,nextID:k?f:void 0,previousID:k?void 0:f}),m.push({action:"delete",id:L})}k?u.before(_):u.after(_),C||(C=_)}),w&&w.textContent===""&&u.classList.contains("p")&&(y.find((_,L)=>{if(_.id===f)return y.splice(L,1),!0}),y.push({action:"delete",id:f}),m.find((_,L)=>{if(_.id===f&&_.action==="update")return m.splice(L,1),!0}),m.push({action:"insert",data:g,id:f,previousID:u.previousElementSibling?u.previousElementSibling.getAttribute("data-node-id"):"",parentID:u.parentElement.getAttribute("data-node-id")||t.block.parentID}),u.remove()),C&&focusBlock(C,void 0,!1);const E=t.wysiwyg.element.querySelector("wbr");E&&E.remove(),transaction(t,y,m)};class lu{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}}const Io=(e,t)=>{const n=[];let a="",i="";for(let o=t.length,l=0;l<o;l++){const r=t[l];let d=!0;r.name||(a+=`<li>${window.siyuan.languages.nameEmpty}</li>`,d=!1),r.size>e.options.upload.max&&(a+=`<li>${r.name} ${window.siyuan.languages.over} ${e.options.upload.max/1024/1024}M</li>`,d=!1);const c=r.name.lastIndexOf("."),u=c===-1?"":r.name.substr(c),f=c===-1?r.name:e.options.upload.filename(r.name.substr(0,c))+u;e.options.upload.accept&&(e.options.upload.accept.split(",").some(p=>{const m=p.trim();if(m.indexOf(".")===0){if(u.toLowerCase()===m.toLowerCase())return!0}else if(r.type.split("/")[0]===m.split("/")[0])return!0;return!1})||(a+=`<li>${r.name} ${window.siyuan.languages.fileTypeError}</li>`,d=!1)),d&&(n.push(r),i+=`<li>${f} ${window.siyuan.languages.uploading}</li>`)}let s;return(a!==""||i!=="")&&(s=showMessage(`<ul>${a}${i}</ul>`,-1)),{files:n,msgId:s}},cs=(e,t)=>{var n,a;const i=JSON.parse(e);let s="";i.code===1&&(s=`${i.msg}`),i.data.errFiles&&i.data.errFiles.length>0&&(s=`<ul><li>${s}</li>`,i.data.errFiles.forEach(f=>{const g=f.lastIndexOf("."),p=g===-1?f:t.options.upload.filename(f.substr(0,g))+f.substr(g);s+=`<li>${p} ${window.siyuan.languages.uploadError}</li>`}),s+="</ul>"),s&&showMessage(s);let o=!0;const l=getEditorRange(t.wysiwyg.element);l.toString()===""&&l.startContainer.nodeType===3&&t.toolbar.getCurrentType(l).length>0&&(l.setEndAfter(l.startContainer.parentElement),l.collapse(!1));const r=hasClosestBlock(l.startContainer);if(r)if(r.classList.contains("table"))o=!1;else{const f=getContenteditableElement(r);f&&f.textContent!==""&&r.classList.contains("p")&&(o=!1)}let d="";const c=Object.keys(i.data.succMap),u=[];if(c.forEach((f,g)=>{const p=i.data.succMap[f],m=pathPosix().extname(f).toLowerCase(),y=t.options.upload.filename(f),v=y.substring(0,y.length-m.length);u.push({type:Constants.SIYUAN_ASSETS_IMAGE.includes(m)?"image":"file",content:p,name:v}),d+=genAssetHTML(m,p,v,y),!Constants.SIYUAN_ASSETS_AUDIO.includes(m)&&!Constants.SIYUAN_ASSETS_VIDEO.includes(m)&&c.length-1!==g&&(r&&r.classList.contains("table")?d+="<br>":o?d+=`

`:d+=`
`)}),r&&r.classList.contains("av")){const f=[];if(r.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(g=>{g.querySelectorAll(".av__cell").forEach(p=>{getTypeByCellElement(p)==="mAsset"&&f.push(p)})}),f.length===0&&t.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(g=>{getTypeByCellElement(g)==="mAsset"&&f.push(g)}),f.length>0){updateCellsValue(t,r,u,f),(n=document.querySelector(".av__panel"))==null||n.remove();return}else return}if(document.querySelector(".av__panel")){const f=[document.querySelector('.custom-attr__avvalue[data-type="mAsset"][data-active="true"]')];if(f[0]||(f.splice(0,1),t.wysiwyg.element.querySelectorAll(".av__cell--active").forEach(g=>{getTypeByCellElement(g)==="mAsset"&&f.push(g)})),f.length>0){const g=hasClosestBlock(f[0]);if(g){updateCellsValue(t,g,u,f),(a=document.querySelector(".av__panel"))==null||a.remove();return}}else return}insertHTML(d,t,o)},Do=(e,t,n)=>{const a=showMessage(window.siyuan.languages.uploading,0);fetchPost("/api/asset/insertLocalAssets",{assetPaths:e,isUpload:n,id:t.block.rootID},i=>{hideMessage(a);let s="";Object.keys(i.data.succMap).forEach(o=>{i.data.succMap[o].startsWith("file:")&&(s+=o+", ")}),s&&showMessage(window.siyuan.languages.dndFolderTip.replace("${x}",`<b>${s.substring(0,s.length-2)}</b>`)),cs(JSON.stringify(i),t)})},ru=(e,t,n,a)=>{if(!e){const c=new FormData;for(let f=0,g=t.length;f<g;f++)c.append("file[]",t[f]);const u=new XMLHttpRequest;u.open("POST",Constants.UPLOAD_ADDRESS),u.onreadystatechange=()=>{u.readyState===XMLHttpRequest.DONE&&(u.status===200?a(u.responseText):u.status===0?showMessage(window.siyuan.languages.fileTypeError):showMessage(u.responseText),n&&(n.value=""))},u.send(c);return}let i=[];for(let c=0;c<t.length;c++){let u=t[c];u instanceof DataTransferItem&&(u=u.getAsFile()),u.size===0&&u.type===""&&u.name.indexOf(".")===-1?Do([u.path],e,!1):i.push(u)}if(e.options.upload.handler){const c=e.options.upload.handler(i);if(typeof c=="string"){showMessage(c);return}return}if(!e.options.upload.url||!e.upload){n&&(n.value=""),showMessage("please config: options.upload.url");return}if(e.options.upload.file&&(i=e.options.upload.file(i)),e.options.upload.validate){const c=e.options.upload.validate(i);if(typeof c=="string"){showMessage(c);return}}const s=e.wysiwyg.element,o=Io(e,i);if(o.files.length===0){n&&(n.value="");return}const l=new FormData,r=e.options.upload.extraData;for(const c of Object.keys(r))l.append(c,r[c]);for(let c=0,u=o.files.length;c<u;c++)l.append(e.options.upload.fieldName,o.files[c]);l.append("id",e.block.rootID);const d=new XMLHttpRequest;d.open("POST",e.options.upload.url),e.options.upload.token&&d.setRequestHeader("X-Upload-Token",e.options.upload.token),e.options.upload.withCredentials&&(d.withCredentials=!0),e.upload.isUploading=!0,d.onreadystatechange=()=>{if(d.readyState===XMLHttpRequest.DONE){if(e.upload.isUploading=!1,!document.body.contains(e.element)){destroy(e);return}if(d.status===200)if(hideMessage(o.msgId),e.options.upload.success)e.options.upload.success(s,d.responseText);else if(a)a(d.responseText);else{let c=d.responseText;e.options.upload.format&&(c=e.options.upload.format(t,d.responseText)),cs(c,e)}else d.status===0?showMessage(window.siyuan.languages.fileTypeError):e.options.upload.error?e.options.upload.error(d.responseText):showMessage(d.responseText);n&&(n.value=""),e.upload.element.style.display="none"}},d.upload.onprogress=c=>{if(!c.lengthComputable)return;const u=c.loaded/c.total*100;e.upload.element.style.display="block";const f=e.upload.element;f.style.width=u+"%"},d.send(l)},us=e=>{var t,n,a,i;let s="";switch(e.type){case"block":e!=null&&e.isDetached?s=`<span data-id="${(t=e.block)==null?void 0:t.id}">${((n=e.block)==null?void 0:n.content)||window.siyuan.languages.untitled}</span>`:s=`<span data-type="block-ref" data-id="${(a=e.block)==null?void 0:a.id}" data-subtype="s" class="av__celltext--ref">${((i=e.block)==null?void 0:i.content)||window.siyuan.languages.untitled}</span>`;break;case"text":s=e.text.content;break;case"number":s=e.number.formattedContent||e.number.content.toString();break;case"date":e[e.type]&&e[e.type].isNotEmpty&&(s=dayjs(e[e.type].content).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),e[e.type]&&e[e.type].hasEndDate&&e[e.type].isNotEmpty&&e[e.type].isNotEmpty2&&(s+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${dayjs(e[e.type].content2).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),s&&(s=`<span class="av__celltext">${s}</span>`);break;case"url":s=e.url.content?`<a class="fn__a" href="${e.url.content}" target="_blank">${e.url.content}</a>`:"";break;case"phone":s=e.phone.content?`<a class="fn__a" href="tel:${e.phone.content}" target="_blank">${e.phone.content}</a>`:"";break;case"email":s=e.email.content?`<a class="fn__a" href="mailto:${e.email.content}" target="_blank">${e.email.content}</a>`:"";break}return s},fs=e=>{var t,n,a,i,s,o;let l="";switch(e.type){case"block":l=`<div class="fn__flex-1">${e.block.content}</div>`;break;case"text":l=`<textarea style="resize: vertical" rows="${e.text.content.split(`
`).length}" class="b3-text-field b3-text-field--text fn__flex-1">${e.text.content}</textarea>`;break;case"number":l=`<input value="${e.number.isNotEmpty?e.number.content:""}" type="number" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span><span class="fn__flex-center ft__on-surface b3-tooltips__w b3-tooltips" aria-label="${window.siyuan.languages.format}">${e.number.formattedContent}</span><span class="fn__space"></span>`;break;case"mSelect":case"select":(t=e.mSelect)==null||t.forEach(r=>{l+=`<span class="b3-chip b3-chip--middle" style="background-color:var(--b3-font-background${r.color});color:var(--b3-font-color${r.color})">${r.content}</span>`});break;case"mAsset":(n=e.mAsset)==null||n.forEach(r=>{r.type==="image"?l+=`<img class="av__cellassetimg ariaLabel" aria-label="${r.content}" src="${r.content}">`:l+=`<span class="b3-chip b3-chip--middle av__celltext--url ariaLabel" aria-label="${escapeAttr(r.content)}" data-name="${escapeAttr(r.name)}" data-url="${escapeAttr(r.content)}">${r.name||r.content}</span>`});break;case"date":l=`<span class="av__celltext" data-value='${JSON.stringify(e[e.type])}'>`,e[e.type]&&e[e.type].isNotEmpty&&(l+=dayjs(e[e.type].content).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),e[e.type]&&e[e.type].hasEndDate&&e[e.type].isNotEmpty&&e[e.type].isNotEmpty2&&(l+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${dayjs(e[e.type].content2).format(e[e.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),l+="</span>";break;case"created":case"updated":e[e.type].isNotEmpty&&(l=`<span data-content="${e[e.type].content}">${dayjs(e[e.type].content).format("YYYY-MM-DD HH:mm")}</span>`);break;case"url":l=`<input value="${e.url.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="${e.url.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconLink"></use></svg></a>`;break;case"phone":l=`<input value="${e.phone.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="tel:${e.phone.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconPhone"></use></svg></a>`;break;case"checkbox":l=`<svg class="av__checkbox"><use xlink:href="#icon${e.checkbox.checked?"Check":"Uncheck"}"></use></svg>`;break;case"template":l=`<div class="fn__flex-1">${e.template.content}</div>`;break;case"email":l=`<input value="${e.email.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="mailto:${e.email.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconEmail"></use></svg></a>`;break;case"relation":(i=(a=e==null?void 0:e.relation)==null?void 0:a.contents)==null||i.forEach(r=>{if(r){const d=us(r);d&&(l+=d+",&nbsp;")}}),l&&l.endsWith(",&nbsp;")&&(l=l.substring(0,l.length-7));break;case"rollup":(o=(s=e==null?void 0:e.rollup)==null?void 0:s.contents)==null||o.forEach(r=>{const d=["select","mSelect","mAsset","checkbox","relation"].includes(r.type)?fs(r):us(r);d&&(l+=d+",&nbsp;")}),l&&l.endsWith(",&nbsp;")&&(l=l.substring(0,l.length-7));break}return l},du=(e,t,n,a)=>{fetchPost("/api/av/getAttributeViewKeys",{id:t},i=>{let s="";if(i.data.forEach(o=>{var l;let r=`<div class="custom-attr__avheader block__logo popover__block" data-id='${JSON.stringify(o.blockIDs)}'>
    <div class="fn__flex-1"></div>
    <svg class="block__logoicon"><use xlink:href="#iconDatabase"></use></svg><span>${o.avName||window.siyuan.languages.database}</span>
    <div class="fn__flex-1"></div>
</div>`;(l=o.keyValues)==null||l.forEach(d=>{var c;r+=`<div class="block__icons av__row" data-id="${t}" data-col-id="${d.key.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${escapeAttr(d.key.name)}">
        ${d.key.icon?unicode2Emoji(d.key.icon,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${getColIconByType(d.key.type)}"></use></svg>`}
        <span>${d.key.name}</span>
    </div>
    <div data-av-id="${o.avID}" data-col-id="${d.values[0].keyID}" data-block-id="${d.values[0].blockID}" data-id="${d.values[0].id}" data-type="${d.values[0].type}" 
data-options="${(c=d.key)!=null&&c.options?escapeAttr(JSON.stringify(d.key.options)):"[]"}"
class="fn__flex-1 fn__flex${["url","text","number","email","phone","block"].includes(d.values[0].type)?"":" custom-attr__avvalue"}">
        ${fs(d.values[0])}
    </div>
</div>`}),r+=`<div class="fn__hr"></div>
<div class="fn__flex">
    <div class="fn__space"></div><div class="fn__space"></div>
    <button data-type="addColumn" class="b3-button b3-button--outline"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}</button>
</div><div class="fn__hr--b"></div>`,s+=`<div data-av-id="${o.avID}" data-node-id="${t}" data-type="NodeAttributeView">${r}</div>`,e.innerHTML&&(e.querySelector(`div[data-node-id="${t}"][data-av-id="${o.avID}"]`).innerHTML=r)}),e.innerHTML===""){let o;e.addEventListener("dragstart",r=>{const d=r.target;window.siyuan.dragElement=d.parentElement,window.siyuan.dragElement.style.opacity=".1",o=hasClosestBlock(window.siyuan.dragElement);const c=document.createElement("div");c.className="block__icons",c.innerHTML=d.nextElementSibling.outerHTML,c.setAttribute("style","width: 160px;position:fixed;opacity:.1;"),document.body.append(c),r.dataTransfer.setDragImage(c,0,0),setTimeout(()=>{c.remove()})}),e.addEventListener("drop",()=>{var r,d;l=0,window.siyuan.dragElement.style.opacity="";const c=e.querySelector(".dragover__bottom, .dragover__top");if(c&&o){const u=c.classList.contains("dragover__bottom"),f=u?c.dataset.colId:(r=c.previousElementSibling)==null?void 0:r.getAttribute("data-col-id"),g=(d=window.siyuan.dragElement.previousElementSibling)==null?void 0:d.getAttribute("data-col-id");f!==g&&f!==window.siyuan.dragElement.dataset.colId&&(transaction(n,[{action:"sortAttrViewKey",avID:o.dataset.avId,previousID:f,id:window.siyuan.dragElement.dataset.colId}],[{action:"sortAttrViewKey",avID:o.dataset.avId,previousID:g,id:t}]),u?c.after(window.siyuan.dragElement):c.before(window.siyuan.dragElement)),c.classList.remove("dragover__bottom","dragover__top")}window.siyuan.dragElement=null}),e.addEventListener("dragover",r=>{const d=r.target;let c=hasClosestByClassName(d,"av__row");if(c||(c=hasClosestByClassName(document.elementFromPoint(r.clientX,r.clientY-1),"av__row")),!c||c.isSameNode(window.siyuan.dragElement)||!o)return;const u=hasClosestBlock(c);if(!u||!u.isSameNode(o))return;r.preventDefault();const f=c.getBoundingClientRect();e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(g=>{g.classList.remove("dragover__bottom","dragover__top")}),r.clientY>f.top+f.height/2?c.classList.add("dragover__bottom"):c.classList.add("dragover__top")});let l=0;e.addEventListener("dragleave",()=>{l--,l===0&&e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(r=>{r.classList.remove("dragover__bottom","dragover__top")})}),e.addEventListener("dragenter",r=>{r.preventDefault(),l++}),e.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("paste",r=>{var d;const c=r.clipboardData.files;if(document.querySelector(".av__panel .b3-form__upload"))if(c&&c.length>0)uploadFiles(n,c);else{const u=r.clipboardData.getData("text/plain"),f=r.target,g=hasClosestBlock(f),p=hasClosestByAttribute(f,"data-type","mAsset");g&&p&&u&&(updateCellsValue(n,g,u,[p],void 0,n.lute.Md2BlockDOM(u)),(d=document.querySelector(".av__panel"))==null||d.remove())}}),e.addEventListener("click",r=>{gs(n,e,r)}),e.addEventListener("contextmenu",r=>{gs(n,e,r)}),e.innerHTML=s}e.querySelectorAll(".b3-text-field--text").forEach(o=>{o.addEventListener("change",()=>{let l;const r=o.parentElement.dataset.type;["url","text","email","phone"].includes(r)?(l={[r]:{content:o.value}},r!=="text"&&o.parentElement.querySelector("a").setAttribute("href",(r==="url"?"":r==="email"?"mailto:":"tel:")+o.value)):r==="number"&&(o.value==="undefined"||!o.value?l={number:{content:null,isNotEmpty:!1}}:l={number:{content:parseFloat(o.value)||0,isNotEmpty:!0}}),fetchPost("/api/av/setAttributeViewBlockAttr",{avID:o.parentElement.dataset.avId,keyID:o.parentElement.dataset.colId,rowID:o.parentElement.dataset.blockId,cellID:o.parentElement.dataset.id,value:l},d=>{r==="number"&&(o.parentElement.querySelector(".fn__flex-center").textContent=d.data.value.number.formattedContent)})})}),a&&a(e)})},gs=(e,t,n)=>{let a=n.target;const i=hasClosestBlock(a);if(i)for(;a&&!t.isSameNode(a);){const s=a.getAttribute("data-type");if(a.classList.contains("av__celltext--url")||a.classList.contains("av__cellassetimg")){if(n.type==="contextmenu"||!a.dataset.url&&a.tagName!=="IMG"){let o=0;Array.from(a.parentElement.children).find((l,r)=>{if(l.isSameNode(a))return o=r,!0}),editAssetItem({protyle:e,cellElements:[a.parentElement],blockElement:hasClosestBlock(a),content:a.tagName==="IMG"?a.getAttribute("src"):a.getAttribute("data-url"),type:a.tagName==="IMG"?"image":"file",name:a.tagName==="IMG"?"":a.getAttribute("data-name"),index:o,rect:a.getBoundingClientRect()})}else a.tagName==="IMG"?previewImage(a.getAttribute("src")):openLink(e,a.dataset.url,n,n.ctrlKey||n.metaKey);n.stopPropagation(),n.preventDefault();break}else if(s==="date"){popTextCell(e,[a],"date"),n.stopPropagation(),n.preventDefault();break}else if(s==="select"||s==="mSelect"){popTextCell(e,[a],a.getAttribute("data-type")),n.stopPropagation(),n.preventDefault();break}else if(s==="mAsset"){t.querySelectorAll('.custom-attr__avvalue[data-type="mAsset"]').forEach(o=>{o.removeAttribute("data-active")}),a.setAttribute("data-active","true"),a.focus(),popTextCell(e,[a],"mAsset"),n.stopPropagation(),n.preventDefault();break}else if(s==="checkbox"){popTextCell(e,[a],"checkbox"),n.stopPropagation(),n.preventDefault();break}else if(s==="relation"){popTextCell(e,[a],"relation"),n.stopPropagation(),n.preventDefault();break}else if(s==="template"){popTextCell(e,[a],"template"),n.stopPropagation(),n.preventDefault();break}else if(s==="rollup"){popTextCell(e,[a],"rollup"),n.stopPropagation(),n.preventDefault();break}else if(s==="addColumn"){const o=i.querySelectorAll(".av__row"),l=addCol(e,i,o[o.length-1].getAttribute("data-col-id")),r=a.getBoundingClientRect();l.open({x:r.left,y:r.bottom,h:r.height}),n.stopPropagation(),n.preventDefault();break}else if(s==="editCol"){openMenuPanel({protyle:e,blockElement:i,type:"edit",colId:a.parentElement.dataset.colId}),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}};var Mo=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const ps=(e,t)=>{e.addEventListener("change",()=>{fetchPost("/api/attr/setBlockAttrs",{id:t,attrs:{[e.dataset.name]:e.value}})})},cu=e=>{const t=e.getAttribute("data-node-id"),n=getEditorRange(e),a=e.getAttribute(Constants.CUSTOM_REMINDER_WECHAT);let i="";a&&(i=dayjs(a).format("YYYY-MM-DD HH:mm"));const s=new Dialog({width:isMobile()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${i}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){focusByRange(n)}});s.element.setAttribute("data-key",Constants.DIALOG_WECHATREMINDER);const o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{o[1].getAttribute("disabled")||(o[1].setAttribute("disabled","disabled"),fetchPost("/api/block/setBlockReminder",{id:t,timed:"0"},()=>{e.removeAttribute(Constants.CUSTOM_REMINDER_WECHAT),s.destroy()}))}),o[2].addEventListener("click",()=>{const l=s.element.querySelector("input").value;if(l){if(new Date(l)<=new Date){showMessage(window.siyuan.languages.reminderTip);return}if(o[2].getAttribute("disabled"))return;o[2].setAttribute("disabled","disabled");const r=dayjs(l).format("YYYYMMDDHHmmss");fetchPost("/api/block/setBlockReminder",{id:t,timed:r},()=>{e.setAttribute(Constants.CUSTOM_REMINDER_WECHAT,r),s.destroy()})}else showMessage(window.siyuan.languages.notEmpty)})},uu=e=>{fetchPost("/api/block/getDocInfo",{id:e.block.rootID},t=>{const n=t.data.ial[Constants.CUSTOM_REMINDER_WECHAT];let a="";n&&(a=dayjs(n).format("YYYY-MM-DD HH:mm"));const i=new Dialog({width:isMobile()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${a}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});i.element.setAttribute("data-key",Constants.DIALOG_WECHATREMINDER);const s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{i.destroy()}),s[1].addEventListener("click",()=>{fetchPost("/api/block/setBlockReminder",{id:e.block.rootID,timed:"0"},()=>{i.destroy()})}),s[2].addEventListener("click",()=>{const o=i.element.querySelector("input").value;if(o){if(new Date(o)<=new Date){showMessage(window.siyuan.languages.reminderTip);return}fetchPost("/api/block/setBlockReminder",{id:e.block.rootID,timed:dayjs(o).format("YYYYMMDDHHmmss")},()=>{i.destroy()})}else showMessage(window.siyuan.languages.notEmpty)})})},$o=(e,t="bookmark",n)=>{let a="",i="",s=!1;const o=getSelection().rangeCount>0?getSelection().getRangeAt(0):null;Object.keys(e).forEach(r=>{Constants.CUSTOM_RIFF_DECKS===r||r.startsWith("custom-sy-")||(r===Constants.CUSTOM_REMINDER_WECHAT?i=`<label class="b3-label b3-label--noborder">
    ${window.siyuan.languages.wechatReminder}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" type="datetime-local" max="9999-12-31 23:59" readonly data-name="${r}" value="${dayjs(e[r]).format("YYYY-MM-DD HH:mm")}">
</label>`:r.indexOf("custom-av")>-1?s=!0:r.indexOf("custom")>-1&&(a+=`<label class="b3-label b3-label--noborder">
     <div class="fn__flex">
        <span class="fn__flex-1">${r.replace("custom-","")}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical;" spellcheck="false" class="b3-text-field fn__block" rows="1" data-name="${r}">${e[r]}</textarea>
</label>`))});const l=new Dialog({width:isMobile()?"92vw":"50vw",height:"80vh",content:`<div class="fn__flex-column">
    <div class="layout-tab-bar fn__flex" style="flex-shrink:0;border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div class="item item--full item--focus" data-type="attr">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.builtIn}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full${s?"":" fn__none"}" data-type="NodeAttributeView">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.database}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="custom">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.custom}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="custom-attr" data-type="attr">
            <label class="b3-label b3-label--noborder">
                <div class="fn__flex">
                    <span class="fn__flex-1">${window.siyuan.languages.bookmark}</span>
                    <span data-action="bookmark" class="block__icon block__icon--show"><svg><use xlink:href="#iconDown"></use></svg></span>
                </div>
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrBookmarkTip}" data-name="bookmark">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.name}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrNameTip}" data-name="name">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.alias}
                <div class="fn__hr"></div>
                <input spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrAliasTip}" data-name="alias">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.memo}
                <div class="fn__hr"></div>
                <textarea style="resize: vertical" spellcheck="${window.siyuan.config.editor.spellcheck}" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrMemoTip}" rows="2" data-name="memo">${e.memo||""}</textarea>
            </label>
            ${i}
        </div>
        <div data-type="NodeAttributeView" class="fn__none custom-attr"></div>
        <div data-type="custom" class="fn__none custom-attr">
           ${a}
           <div class="b3-label">
               <button data-action="addCustom" class="b3-button b3-button--outline">
                   <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}
               </button>
           </div>
        </div>
    </div>
</div>`,destroyCallback(){focusByRange(o)}});l.element.setAttribute("data-key",Constants.DIALOG_ATTR),l.element.querySelector('.b3-text-field[data-name="bookmark"]').value=e.bookmark||"",l.element.querySelector('.b3-text-field[data-name="name"]').value=e.name||"",l.element.querySelector('.b3-text-field[data-name="alias"]').value=e.alias||"",l.element.addEventListener("click",r=>{let d=r.target;for(typeof r.detail=="string"&&(d=l.element.querySelector('.item--full[data-type="NodeAttributeView"]'));!d.isSameNode(l.element);){const c=d.dataset.action;if(d.classList.contains("item--full"))d.parentElement.querySelector(".item--focus").classList.remove("item--focus"),d.classList.add("item--focus"),l.element.querySelectorAll(".custom-attr").forEach(u=>{u.dataset.type===d.dataset.type?(u.dataset.type==="NodeAttributeView"&&u.innerHTML===""&&renderAVAttribute(u,e.id,n),u.classList.remove("fn__none")):u.classList.add("fn__none")});else if(c==="remove"){fetchPost("/api/attr/setBlockAttrs",{id:e.id,attrs:{["custom-"+d.previousElementSibling.textContent]:""}}),d.parentElement.parentElement.remove(),r.stopPropagation(),r.preventDefault();break}else if(c==="bookmark"){fetchPost("/api/attr/getBookmarkLabels",{},u=>{window.siyuan.menus.menu.remove(),u.data.length===0?window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.emptyContent,type:"readonly"}).element):u.data.forEach(f=>{window.siyuan.menus.menu.append(new MenuItem({label:f,click(){const g=d.parentElement.parentElement.querySelector("input");g.value=f,g.dispatchEvent(new CustomEvent("change"))}}).element)}),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),window.siyuan.menus.menu.popup({x:r.clientX,y:r.clientY+16,w:16})}),r.stopPropagation(),r.preventDefault();break}else if(c==="addCustom"){const u=new Dialog({title:window.siyuan.languages.attrName,content:`<div class="b3-dialog__content"><input spellcheck="false" class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});u.element.setAttribute("data-key",Constants.DIALOG_SETCUSTOMATTR);const f=u.element.querySelector("input"),g=u.element.querySelectorAll(".b3-button");u.bindInput(f,()=>{g[1].click()}),f.focus(),f.select(),g[0].addEventListener("click",()=>{u.destroy()}),g[1].addEventListener("click",()=>{if(!isValidAttrName(f.value))return showMessage(window.siyuan.languages.attrName+" <b>"+f.value+"</b> "+window.siyuan.languages.invalid),!1;d.parentElement.insertAdjacentHTML("beforebegin",`<div class="b3-label b3-label--noborder">
    <div class="fn__flex">
        <span class="fn__flex-1">${f.value}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea style="resize: vertical" spellcheck="false" data-name="custom-${f.value}" class="b3-text-field fn__block" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>
</div>`);const p=d.parentElement.previousElementSibling.querySelector(".b3-text-field");p.focus(),ps(p,e.id),u.destroy()}),r.stopPropagation(),r.preventDefault();break}d=d.parentElement}}),l.element.querySelectorAll(".b3-text-field").forEach(r=>{t!=="av"&&t===r.getAttribute("data-name")&&r.focus(),ps(r,e.id)}),t==="av"&&l.element.dispatchEvent(new CustomEvent("click",{detail:"av"}))},fu=(e,t="bookmark",n)=>{if(e.getAttribute("data-type")==="NodeThematicBreak")return;const a=e.getAttribute("data-node-id");fetchPost("/api/attr/getBlockAttrs",{id:a},i=>{$o(i.data,t,n)})},gu=(e,t=!0,n)=>[{id:"copyBlockRef",iconHTML:"",accelerator:t?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{fetchPost("/api/block/getRefText",{id:e},a=>{writeText(`((${e} '${a.data}'))`)}),n&&focusBlock(n)}},{id:"copyBlockEmbed",iconHTML:"",label:window.siyuan.languages.copyBlockEmbed,accelerator:t?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{writeText(`{{select * from blocks where id='${e}'}}`),n&&focusBlock(n)}},{id:"copyProtocol",iconHTML:"",label:window.siyuan.languages.copyProtocol,accelerator:t?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{writeText(`siyuan://blocks/${e}`),n&&focusBlock(n)}},{id:"copyProtocolInMd",iconHTML:"",label:window.siyuan.languages.copyProtocolInMd,accelerator:t?window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom:void 0,click:()=>{fetchPost("/api/block/getRefText",{id:e},a=>{writeText(`[${a.data}](siyuan://blocks/${e})`)}),n&&focusBlock(n)}},{id:"copyHPath",iconHTML:"",label:window.siyuan.languages.copyHPath,accelerator:t?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{fetchPost("/api/filetree/getHPathByID",{id:e},a=>{writeText(a.data)})}},{id:"copyID",iconHTML:"",label:window.siyuan.languages.copyID,accelerator:t?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{writeText(e),n&&focusBlock(n)}}],pu=e=>new MenuItem({id:"export",label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{id:"exportTemplate",label:window.siyuan.languages.template,iconClass:"ft__error",icon:"iconMarkdown",click:()=>Mo(void 0,null,function*(){const t=yield fetchSyncPost("/api/block/getRefText",{id:e}),n=new Dialog({title:window.siyuan.languages.fileName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:isMobile()?"92vw":"520px"});n.element.setAttribute("data-key",Constants.DIALOG_EXPORTTEMPLATE);const a=n.element.querySelector("input"),i=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{i[1].click()});let s=replaceFileName(t.data);const o=32;s.length>o&&(s=s.substring(0,o)),a.value=s,a.focus(),a.select(),i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{a.value.trim()===""?a.value=window.siyuan.languages.untitled:a.value=replaceFileName(a.value),s.length>o&&(s=s.substring(0,o)),fetchPost("/api/template/docSaveAsTemplate",{id:e,name:a.value,overwrite:!1},l=>{if(l.code===1){confirmDialog(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,()=>{fetchPost("/api/template/docSaveAsTemplate",{id:e,name:a.value,overwrite:!0},r=>{r.code===0&&showMessage(window.siyuan.languages.exportTplSucc)})});return}showMessage(window.siyuan.languages.exportTplSucc)}),n.destroy()})})},{id:"exportMarkdown",label:"Markdown",icon:"iconMarkdown",click:()=>{const t=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportMd",{id:e},n=>{hideMessage(t),openByMobile(n.data.zip)})}},{id:"exportSiYuanZip",label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const t=showMessage(window.siyuan.languages.exporting,-1);fetchPost("/api/export/exportSY",{id:e},n=>{hideMessage(t),openByMobile(n.data.zip)})}},{id:"exportImage",label:window.siyuan.languages.image,icon:"iconImage",click:()=>{exportImage(e)}}]}).element,Ho=(e,t,n,a)=>{const i=[];if(i.push({label:Mt()?window.siyuan.languages.useDefault:window.siyuan.languages.useBrowserView,accelerator:a?window.siyuan.languages.click:"",click:()=>{ha(t)}}),n)return i;window.siyuan.menus.menu.append(new Ee({label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:i}).element)},mu=e=>new MenuItem({id:"rename",accelerator:window.siyuan.config.keymap.editor.general.rename.custom,icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{rename(e)}}).element,bu=e=>new MenuItem({id:"move",label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){movePathTo((t,n)=>{moveToPath(e,n[0],t[0])},e)}}).element;var No=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const be=e=>{e.menu.addItem({iconHTML:"",label:ms(e.operator,!!e.data),click(){if(!e.data)transaction(e.protyle,[{action:"setAttrViewColCalc",avID:e.avId,id:e.colId,data:{operator:e.operator},blockID:e.blockID}],[{action:"setAttrViewColCalc",avID:e.avId,id:e.colId,data:{operator:e.oldOperator},blockID:e.blockID}]);else{e.target.querySelector(".b3-menu__accelerator").textContent=ms(e.operator,!0);const t=e.data.view.columns.find(n=>{if(n.id===e.colId)return n.rollup||(n.rollup={}),!0});t.rollup.calc={operator:e.operator},transaction(e.protyle,[{action:"updateAttrViewColRollup",id:e.colId,avID:e.avId,parentID:t.rollup.relationKeyID,keyID:t.rollup.keyID,data:{calc:t.rollup.calc}}],[{action:"updateAttrViewColRollup",id:e.colId,avID:e.avId,parentID:t.rollup.relationKeyID,keyID:t.rollup.keyID,data:{calc:{operator:e.oldOperator}}}])}}})},hu=(e,t,n)=>No(void 0,null,function*(){let a,i,s,o,l,r;if(n)o=n.data.id,i=t.dataset.colType,l=t.dataset.calc,s=n.colId,r=n.blockID;else{const f=hasClosestBlock(t);if(!f||(a=hasClosestByClassName(t,"av__row--footer"),!a))return;a.classList.add("av__row--show"),i=t.dataset.dtype,s=t.dataset.colId,o=f.dataset.avId,l=t.dataset.operator,r=f.dataset.nodeId}if(i==="lineNumber")return;const d=new Menu("av-calc",()=>{a&&a.classList.remove("av__row--show")});if(d.isOpen)return;be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Count all",data:n==null?void 0:n.data,blockID:r,target:t}),i!=="checkbox"?(be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Count values",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Count unique values",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Count empty",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Count not empty",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Percent empty",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Percent not empty",data:n==null?void 0:n.data,blockID:r,target:t})):(be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Checked",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Unchecked",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Percent checked",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Percent unchecked",data:n==null?void 0:n.data,blockID:r,target:t}));let c=!1;if(i==="rollup"){let f,g,p=n==null?void 0:n.data;if(p||(p=(yield fetchSyncPost("api/av/renderAttributeView",{id:o})).data),p.view.columns.find(m=>{var y,v;if(m.id===s)return f=(y=m.rollup)==null?void 0:y.relationKeyID,g=(v=m.rollup)==null?void 0:v.keyID,!0}),f&&g){let m;p.view.columns.find(y=>{var v;if(y.id===f)return m=(v=y.relation)==null?void 0:v.avID,!0}),m&&(yield fetchSyncPost("api/av/getAttributeView",{id:m})).data.av.keyValues.find(v=>{if(v.key.id===g)return c=v.key.type==="number",!0})}}["number","template"].includes(i)||c?(be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Sum",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Average",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Median",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Min",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Max",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Range",data:n==null?void 0:n.data,blockID:r,target:t})):["date","created","updated"].includes(i)&&(be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Earliest",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Latest",data:n==null?void 0:n.data,blockID:r,target:t}),be({menu:d,protyle:e,colId:s,avId:o,oldOperator:l,operator:"Range",data:n==null?void 0:n.data,blockID:r,target:t}));const u=t.getBoundingClientRect();d.open({x:u.left,y:u.bottom,h:u.height})}),Bo=e=>{if(!e.calc||!e.calc.result)return"";let t=e.calc.result.number;(e.calc.operator==="Earliest"||e.calc.operator==="Latest"||e.calc.operator==="Range"&&["date","created","updated"].includes(e.type))&&(t=e.calc.result[e.type]);let n="";switch(e.calc.operator){case"Count all":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultCountAll}`;break;case"Count values":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultCountValues}`;break;case"Count unique values":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultCountUniqueValues}`;break;case"Count empty":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultCountEmpty}`;break;case"Count not empty":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultCountNotEmpty}`;break;case"Percent empty":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultPercentEmpty}`;break;case"Percent not empty":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultPercentNotEmpty}`;break;case"Sum":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultSum}`;break;case"Average":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultAverage}`;break;case"Median":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultMedian}`;break;case"Min":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultMin}`;break;case"Max":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultMax}`;break;case"Range":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcResultRange}`;break;case"Earliest":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcOperatorEarliest}`;break;case"Latest":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.calcOperatorLatest}`;break;case"Checked":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.checked}`;break;case"Unchecked":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.unchecked}`;break;case"Percent checked":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.percentChecked}`;break;case"Percent unchecked":n=`<span>${t.formattedContent}</span>${window.siyuan.languages.percentUnchecked}`;break}return n},ms=(e,t)=>{switch(e){case void 0:case"":return t?window.siyuan.languages.original:window.siyuan.languages.calcOperatorNone;case"Count all":return window.siyuan.languages.calcOperatorCountAll;case"Count values":return window.siyuan.languages.calcOperatorCountValues;case"Count unique values":return window.siyuan.languages.calcOperatorCountUniqueValues;case"Count empty":return window.siyuan.languages.calcOperatorCountEmpty;case"Count not empty":return window.siyuan.languages.calcOperatorCountNotEmpty;case"Percent empty":return window.siyuan.languages.calcOperatorPercentEmpty;case"Percent not empty":return window.siyuan.languages.calcOperatorPercentNotEmpty;case"Checked":return window.siyuan.languages.checked;case"Unchecked":return window.siyuan.languages.unchecked;case"Percent checked":return window.siyuan.languages.percentChecked;case"Percent unchecked":return window.siyuan.languages.percentUnchecked;case"Sum":return window.siyuan.languages.calcOperatorSum;case"Average":return window.siyuan.languages.calcOperatorAverage;case"Median":return window.siyuan.languages.calcOperatorMedian;case"Min":return window.siyuan.languages.calcOperatorMin;case"Max":return window.siyuan.languages.calcOperatorMax;case"Range":return window.siyuan.languages.calcOperatorRange;case"Earliest":return window.siyuan.languages.calcOperatorEarliest;case"Latest":return window.siyuan.languages.calcOperatorLatest;default:return""}},yu=(e,t)=>{if(isOnlyMeta(t))return!1;const n=hasClosestBlock(t.target);if(!n)return!1;if(hasClosestByAttribute(t.target,"data-type","av-load-more"))return n.querySelector(".av__row--footer").style.transform="",n.removeAttribute("data-render"),n.dataset.pageSize=(parseInt(n.dataset.pageSize)+parseInt(n.querySelector('[data-type="set-page-size"]').getAttribute("data-size"))).toString(),avRender(n,e),t.preventDefault(),t.stopPropagation(),!0;const i=hasClosestByClassName(t.target,"av__firstcol");if(i)return window.siyuan.menus.menu.remove(),selectRow(i,"toggle"),t.preventDefault(),t.stopPropagation(),!0;const s=hasClosestByClassName(t.target,"av__cellassetimg");if(s)return previewImage(s.src),t.preventDefault(),t.stopPropagation(),!0;if(t.shiftKey){const c=hasClosestByClassName(t.target,"av__row");if(c&&!c.classList.contains("av__row--header"))return selectRow(c.querySelector(".av__firstcol"),"toggle"),t.preventDefault(),t.stopPropagation(),!0}const o=hasClosestByAttribute(t.target,"data-type","copy");if(o)return writeText(getCellText(hasClosestByClassName(o,"av__cell"))),showMessage(window.siyuan.languages.copied),t.preventDefault(),t.stopPropagation(),!0;if(hasClosestByAttribute(t.target,"data-type","av-search-icon")){const c=n.querySelector('input[data-type="av-search"]');return c.style.width="128px",c.style.paddingLeft="",c.style.paddingRight="",setTimeout(()=>{c.focus()},Constants.TIMEOUT_TRANSITION),t.preventDefault(),t.stopPropagation(),!0}const r=hasClosestByClassName(t.target,"item");if(r&&r.parentElement.classList.contains("layout-tab-bar"))return r.classList.contains("item--focus")?openViewMenu({protyle:e,blockElement:n,element:r}):(n.removeAttribute("data-render"),avRender(n,e,void 0,r.dataset.id)),t.preventDefault(),t.stopPropagation(),!0;if(e.disabled)return!1;let d=t.target;for(;d&&!d.isEqualNode(n);){const c=d.getAttribute("data-type");if(c==="av-header-add"){const u=addCol(e,n),f=d.getBoundingClientRect();return u.open({x:f.left,y:f.bottom,h:f.height}),t.preventDefault(),t.stopPropagation(),!0}else{if(c==="av-header-more")return openMenuPanel({protyle:e,blockElement:n,type:"properties"}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-add-more")return insertRows(n,e,1,void 0),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-more")return openMenuPanel({protyle:e,blockElement:n,type:"config"}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-switcher")return openMenuPanel({protyle:e,blockElement:n,type:"switcher"}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-sort")return openMenuPanel({protyle:e,blockElement:n,type:"sorts"}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-filter")return openMenuPanel({protyle:e,blockElement:n,type:"filters"}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-add")return addView(e,n),t.preventDefault(),t.stopPropagation(),!0;if(c==="block-more")return window.siyuan.menus.menu.remove(),e.toolbar.range=document.createRange(),e.toolbar.range.selectNodeContents(d),focusByRange(e.toolbar.range),d.parentElement.classList.add("av__cell--select"),addDragFill(d.parentElement),hintRef(d.previousElementSibling.textContent.trim(),e,"av"),t.preventDefault(),t.stopPropagation(),!0;if(c==="set-page-size")return setPageSize({target:d,protyle:e,avID:n.getAttribute("data-av-id"),nodeElement:n}),t.preventDefault(),t.stopPropagation(),!0;if(c==="av-add-bottom")return insertRows(n,e,1,n.querySelector(".av__row--util").previousElementSibling.getAttribute("data-id")||""),t.preventDefault(),t.stopPropagation(),!0;if(d.classList.contains("av__cell--header"))return showColMenu(e,n,d),t.preventDefault(),t.stopPropagation(),!0;if(d.classList.contains("av__cell")){if(!hasClosestByClassName(d,"av__row--header")){const u=hasClosestByClassName(d,"av__scroll");if(!u||d.querySelector(".av__pulse"))return;const f=hasClosestByClassName(d,"av__row");if(!f)return;const g=getTypeByCellElement(d);g==="updated"||g==="created"||g==="lineNumber"||g==="block"&&!d.getAttribute("data-detached")?selectRow(f.querySelector(".av__firstcol"),"toggle"):(u.querySelectorAll(".av__row--select").forEach(p=>{p.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),p.classList.remove("av__row--select")}),updateHeader(f),popTextCell(e,[d]))}return t.preventDefault(),t.stopPropagation(),!0}else if(d.classList.contains("av__calc"))return openCalcMenu(e,d),t.preventDefault(),t.stopPropagation(),!0}d=d.parentElement}return!1},wu=(e,t,n)=>{var a;if(hideElements(["hint"],e),t.classList.contains("av__row--header"))return!1;const i=hasClosestBlock(t);if(!i)return!1;i.querySelectorAll(".av__cell--select, .av__cell--active").forEach(r=>{var d;r.classList.remove("av__cell--select","av__cell--active"),(d=r.querySelector(".av__drag-fill"))==null||d.remove()}),t.classList.contains("av__row--select")||(i.querySelectorAll(".av__row--select").forEach(r=>{r.classList.remove("av__row--select")}),i.querySelectorAll(".av__firstcol use").forEach(r=>{r.setAttribute("xlink:href","#iconUncheck")}));const s=new Menu;t.classList.add("av__row--select"),t.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck");const o=i.querySelectorAll(".av__row--select:not(.av__row--header)");updateHeader(t);const l=o[0].querySelector(".av__cell[data-block-id]");if(o.length===1&&l.getAttribute("data-detached")!=="true"){const r=o[0].getAttribute("data-id");openEditorTab(e.app,[r]),s.addItem({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:copySubMenu(r)})}if(!e.disabled){s.addItem({label:window.siyuan.languages.addToDatabase,icon:"iconDatabase",click(){openSearchAV(i.getAttribute("data-av-id"),o[0],d=>{const c=[],u=[];o.forEach(g=>{const p=g.getAttribute("data-id"),m=genCellValueByElement("block",g.querySelector(".av__cell[data-block-id]"));c.push({content:m.block.content,id:p,isDetached:m.isDetached}),u.push(p)});const f=d.dataset.avId;transaction(e,[{action:"insertAttrViewBlock",avID:f,ignoreFillFilter:!0,srcs:c,blockID:d.dataset.blockId},{action:"doUpdateUpdated",id:d.dataset.blockId,data:dayjs().format("YYYYMMDDHHmmss")}],[{action:"removeAttrViewBlock",srcIDs:u,avID:f}])})}}),o.length===1&&(l.getAttribute("data-detached")!=="true"&&s.addSeparator(),s.addItem({icon:"iconBefore",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages.insertRowBefore.replace("${x}",'<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" value="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field"><span class="fn__space"></span>')}
</div>`,bind(d){const c=d.querySelector("input");d.addEventListener("click",()=>{document.activeElement.isSameNode(c)||(insertRows(i,e,parseInt(c.value),o[0].previousElementSibling.getAttribute("data-id")),s.close())}),c.addEventListener("keydown",u=>{!u.isComposing&&u.key==="Enter"&&(insertRows(i,e,parseInt(c.value),o[0].previousElementSibling.getAttribute("data-id")),s.close())})}}),s.addItem({icon:"iconAfter",label:`<div class="fn__flex" style="align-items: center;">
${window.siyuan.languages.insertRowAfter.replace("${x}",'<span class="fn__space"></span><input style="width:64px" type="number" step="1" min="1" placeholder="${window.siyuan.languages.enterKey}" class="b3-text-field" value="1"><span class="fn__space"></span>')}
</div>`,bind(d){const c=d.querySelector("input");d.addEventListener("click",()=>{document.activeElement.isSameNode(c)||(insertRows(i,e,parseInt(c.value),o[0].getAttribute("data-id")),s.close())}),c.addEventListener("keydown",u=>{!u.isComposing&&u.key==="Enter"&&(insertRows(i,e,parseInt(c.value),o[0].getAttribute("data-id")),s.close())})}}),s.addSeparator(),l.getAttribute("data-detached")!=="true"&&s.addItem({label:window.siyuan.languages.unbindBlock,icon:"iconLinkOff",click(){updateCellsValue(e,i,l.querySelector(".av__celltext").textContent,[l])}})),s.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){deleteRow(i,e)}});const r=[];t.parentElement.querySelectorAll(".av__row--header .av__cell").forEach(d=>{let c=!1;const u=Array.from(i.querySelectorAll(`.av__row--select:not(.av__row--header) .av__cell[data-col-id="${d.dataset.colId}"]`));d.dataset.dtype==="block"&&u.find(g=>{if(!g.dataset.detached)return c=!0,!0});const f=d.getAttribute("data-dtype");if(!c&&!["updated","created"].includes(f)){const g=d.dataset.icon;r.push({iconHTML:g?unicode2Emoji(g,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(f)}"></use></svg>`,label:d.querySelector(".av__celltext").textContent.trim(),click(){popTextCell(e,u)}})}}),s.addItem({icon:"iconAttr",label:window.siyuan.languages.attr,type:"submenu",submenu:r})}return(a=e==null?void 0:e.app)!=null&&a.plugins&&emitOpenMenu({plugins:e.app.plugins,type:"open-menu-av",detail:{protyle:e,element:i,selectRowElements:o},separatorPosition:"top"}),s.open(n),!0},_u=(e,t)=>{const n=t.getAttribute("data-av-id"),a=t.getAttribute("data-node-id"),i=t.querySelector(".av__title"),s=i.textContent.trim();if(s===i.dataset.title.trim())return;const o=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"setAttrViewName",id:n,data:s},{action:"doUpdateUpdated",id:a,data:o}],[{action:"setAttrViewName",id:n,data:i.dataset.title},{action:"doUpdateUpdated",id:a,data:t.getAttribute("updated")}]),t.setAttribute("updated",o),i.dataset.title=s,Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${n}"]`)).forEach(l=>{if(t.isSameNode(l))return;const r=l.querySelector(".av__title");r&&(r.textContent=s,r.dataset.title=s)})},vu=(e,t,n)=>{if(e)if(n)updateHeaderCell(e,n);else{const a=e.querySelector(".av__drag-fill");e.innerHTML=renderCell(t),a&&addDragFill(e),renderCellAttr(e,t)}},Eu=(e,t)=>{e.querySelectorAll(`.av__cell[data-col-id="${t}"]`).forEach(n=>{n.remove()})},ku=(e,t)=>{fetchPost("/api/av/duplicateAttributeViewBlock",{avID:t.getAttribute("data-av-id")},n=>{t.classList.remove("protyle-wysiwyg--select");const a=document.createElement("template");a.innerHTML=e.lute.SpinBlockDOM(`<div data-node-id="${n.data.blockID}" data-av-id="${n.data.avID}" data-type="NodeAttributeView" data-av-type="table"></div>`);const i=a.content.firstElementChild;t.after(i),avRender(i,e,()=>{focusBlock(i),scrollCenter(e)}),transaction(e,[{action:"insert",data:i.outerHTML,id:n.data.blockID,previousID:t.dataset.nodeId}],[{action:"delete",id:n.data.blockID}])})};let Le;const na=(e,t,n=[])=>{let a="",i=!1;if(n.length===0&&document.querySelectorAll(".av__panel .b3-chips .b3-chip").forEach(s=>{n.push(s.dataset.content)}),t&&t.forEach(s=>{(!e||e.toLowerCase().indexOf(s.name.toLowerCase())>-1||s.name.toLowerCase().indexOf(e.toLowerCase())>-1)&&(a+=`<button data-type="addColOptionOrCell" class="b3-menu__item" data-name="${s.name}" draggable="true" data-color="${s.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${s.color});color:var(--b3-font-color${s.color})">
            <span class="fn__ellipsis">${s.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
    ${n.includes(s.name)?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`),e===s.name&&(i=!0)}),!i&&e){const s=((t==null?void 0:t.length)||0)%13+1;a=`<button data-type="addColOptionOrCell" class="b3-menu__item b3-menu__item--current" data-name="${e}" data-color="${s}">
<svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
<div class="fn__flex-1">
    <span class="b3-chip" style="background-color:var(--b3-font-background${s});color:var(--b3-font-color${s})">
        <span class="fn__ellipsis">${e}</span>
    </span>
</div>
<span class="b3-menu__accelerator">${window.siyuan.languages.enterKey}</span>
</button>${a}`}return a},bs=(e,t,n,a)=>{if(!n)return;const i=t[0].dataset.colId,s=[],o=[];let l;const r=a.getAttribute("data-av-id");t.forEach((d,c)=>{var u;if(!a.contains(d)){const m=hasClosestByClassName(d,"av__row");m&&(d=t[c]=a.querySelector(`.av__row[data-id="${m.dataset.id}"] .av__cell[data-col-id="${d.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${d.dataset.colId}"]`))}const f=hasClosestByClassName(d,"av__row").dataset.id,g=Le[c],p=JSON.parse(JSON.stringify(g));c===0?((u=g.mSelect)==null||u.find((m,y)=>{if(m.content===n.dataset.content)return g.mSelect.splice(y,1),!0}),l=g.mSelect):g.mSelect=l,s.push({action:"updateAttrViewCell",id:g.id,keyID:i,rowID:f,avID:r,data:g}),o.push({action:"updateAttrViewCell",id:g.id,keyID:i,rowID:f,avID:r,data:p}),d.classList.contains("custom-attr__avvalue")?d.innerHTML=genAVValueHTML(g):updateAttrViewCellAnimation(d,g)}),transaction(e,s,o),Array.from(document.querySelectorAll(".av__panel .b3-menu__item")).find(d=>{var c;if(d.dataset.name===n.dataset.content)return(c=d.querySelector(".b3-menu__checked"))==null||c.remove(),!0}),n.remove()},Cu=(e,t,n,a,i,s)=>{const o=hasClosestByClassName(n,"b3-menu");if(!o)return;const l=a.getAttribute("data-node-id"),r=s?s[0].dataset.colId:o.querySelector(".b3-menu__item").getAttribute("data-col-id");let d=n.parentElement.dataset.name,c=n.parentElement.dataset.color;const u=new Menu("av-col-option",()=>{if(d===g.value||!g.value)return;let p=!1;if(t.view.columns.find(b=>{if(b.id===r)return b.options.find(w=>{if(w.name===g.value)return p=!0,!0}),!0}),p)return;transaction(e,[{action:"updateAttrViewColOption",id:r,avID:t.id,data:{newColor:c,oldName:d,newName:g.value}}],[{action:"updateAttrViewColOption",id:r,avID:t.id,data:{newColor:c,oldName:g.value,newName:d}}]),t.view.columns.find(b=>{if(b.id===r)return b.options.find(w=>{if(w.name===d)return w.name=g.value,!0}),!0});const m=o.querySelector(".b3-menu__items").scrollTop,y=o.querySelector(".b3-chips"),v=y?y.clientHeight:0;s?(s.forEach((b,w)=>{const h=hasClosestByClassName(b,"av__row");h&&(b=s[w]=a.querySelector(`.av__row[data-id="${h.dataset.id}"] .av__cell[data-col-id="${b.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${b.dataset.colId}"]`)),Le[w].mSelect.find(C=>{if(C.content===d)return C.content=g.value,!0}),b.classList.contains("custom-attr__avvalue")?b.innerHTML=genAVValueHTML(Le[w]):updateAttrViewCellAnimation(b,Le[w])}),o.innerHTML=un(t.view,s),cn(e,t,o,s,a)):(o.innerHTML=getEditHTML({protyle:e,data:t,colId:r,isCustomAttr:i}),bindEditEvent({protyle:e,data:t,menuElement:o,isCustomAttr:i,blockID:l})),y&&(o.querySelector(".b3-menu__items").scrollTop=m+(o.querySelector(".b3-chips").clientHeight-v))});if(u.isOpen)return;u.addItem({iconHTML:"",type:"readonly",label:`<input class="b3-text-field" style="margin: 4px 0" value="${d}">`,bind(p){p.querySelector("input").addEventListener("keydown",m=>{m.isComposing||m.key==="Enter"&&u.close()})}}),u.addItem({label:window.siyuan.languages.delete,icon:"iconTrashcan",click(){confirmDialog(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete,()=>{let p=[];t.view.columns.find(w=>{if(w.id===r)return p=w.options,!0});const m=n.parentElement.dataset.name;transaction(e,[{action:"removeAttrViewColOption",id:r,avID:t.id,data:m}],[{action:"updateAttrViewColOptions",id:r,avID:t.id,data:p}]),p.find((w,h)=>{if(w.name===m)return p.splice(h,1),!0});const y=o.querySelector(".b3-menu__items").scrollTop,v=o.querySelector(".b3-chips"),b=v?v.clientHeight:0;s?(s.forEach((w,h)=>{const C=hasClosestByClassName(w,"av__row");C&&(w=s[h]=a.querySelector(`.av__row[data-id="${C.dataset.id}"] .av__cell[data-col-id="${w.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${w.dataset.colId}"]`)),Le[h].mSelect.find((k,E)=>{if(k.content===m)return Le[h].mSelect.splice(E,1),!0}),w.classList.contains("custom-attr__avvalue")?w.innerHTML=genAVValueHTML(Le[h]):updateAttrViewCellAnimation(w,Le[h])}),o.innerHTML=un(t.view,s),cn(e,t,o,s,a)):(o.innerHTML=getEditHTML({protyle:e,data:t,colId:r,isCustomAttr:i}),bindEditEvent({protyle:e,data:t,menuElement:o,isCustomAttr:i,blockID:l})),v&&(o.querySelector(".b3-menu__items").scrollTop=y+(o.querySelector(".b3-chips").clientHeight-b))})}}),u.addSeparator(),Array.from(Array(13).keys()).forEach(p=>{u.addItem({checked:parseInt(c)===p+1,iconHTML:"",label:`<span class="color__square"  style="padding: 5px;margin: 2px;color: var(--b3-font-color${p+1});background-color: var(--b3-font-background${p+1});">A</span>`,click(m){var y;if(m.lastElementChild.classList.contains("b3-menu__checked"))return;(y=m.parentElement.querySelector(".b3-menu__checked"))==null||y.remove(),m.insertAdjacentHTML("beforeend",'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>'),transaction(e,[{action:"updateAttrViewColOption",id:r,avID:t.id,data:{oldName:d,newName:g.value,oldColor:c,newColor:(p+1).toString()}}],[{action:"updateAttrViewColOption",id:r,avID:t.id,data:{oldName:g.value,newName:d,oldColor:(p+1).toString(),newColor:c}}]),t.view.columns.find(b=>{if(b.id===r)return b.options.find(w=>{if(w.name===d)return w.name=g.value,w.color=(p+1).toString(),!0}),!0});const v=o.querySelector(".b3-menu__items").scrollTop;return s?(s.forEach((b,w)=>{const h=hasClosestByClassName(b,"av__row");h&&(b=s[w]=a.querySelector(`.av__row[data-id="${h.dataset.id}"] .av__cell[data-col-id="${b.dataset.colId}"]`)||a.querySelector(`.fn__flex-1[data-col-id="${b.dataset.colId}"]`)),Le[w].mSelect.find(C=>{if(C.content===d)return C.content=g.value,C.color=(p+1).toString(),!0}),b.classList.contains("custom-attr__avvalue")?b.innerHTML=genAVValueHTML(Le[w]):updateAttrViewCellAnimation(b,Le[w])}),o.innerHTML=un(t.view,s),cn(e,t,o,s,a)):(o.innerHTML=getEditHTML({protyle:e,data:t,colId:r,isCustomAttr:i}),bindEditEvent({protyle:e,data:t,menuElement:o,isCustomAttr:i,blockID:l})),o.querySelector(".b3-menu__items").scrollTop=v,d=g.value,c=(p+1).toString(),!0}})});const f=n.getBoundingClientRect();u.open({x:f.right,y:f.bottom,w:f.width,h:f.height});const g=window.siyuan.menus.menu.element.querySelector("input");g.select()},cn=(e,t,n,a,i)=>{const s=n.querySelector("input"),o=a[0].dataset.colId;let l;t.view.columns.find(d=>{if(d.id===o){l=d;return}}),l.options||(l.options=[]);const r=n.lastElementChild.lastElementChild;s.addEventListener("input",d=>{d.isComposing||(r.innerHTML=na(s.value,l.options))}),s.addEventListener("compositionend",()=>{r.innerHTML=na(s.value,l.options)}),s.addEventListener("keydown",d=>{if(d.isComposing)return;let c=upDownHint(r,d,"b3-menu__item--current",r.firstElementChild);d.key==="Enter"?(c||(c=n.querySelector(".b3-menu__item--current")),c.querySelector(".b3-menu__checked")?bs(e,a,n.querySelector(`.b3-chips .b3-chip[data-content="${escapeAttr(c.dataset.name)}"]`),i):Po(e,t,a,c,n,i)):d.key==="Backspace"&&s.value===""&&bs(e,a,s.previousElementSibling,i)})},Po=(e,t,n,a,i,s)=>{let o=!1;if(Array.from(i.querySelectorAll(".b3-chips .b3-chip")).find(g=>{if(g.dataset.content===a.dataset.name)return o=!0,!0}),o){i.querySelector("input").focus();return}hasClosestBlock(n[0])||n.forEach((g,p)=>{const m=hasClosestByClassName(g,"av__row");m&&(n[p]=s.querySelector(`.av__row[data-id="${m.dataset.id}"] .av__cell[data-col-id="${g.dataset.colId}"]`)||s.querySelector(`.fn__flex-1[data-col-id="${g.dataset.colId}"]`))});const r=n[0].dataset.colId;let d;t.view.columns.find(g=>{if(g.id===r){d=g,d.options||(d.options=[]);return}});const c=[],u=[];let f;if(n.forEach((g,p)=>{const m=hasClosestByClassName(g,"av__row");if(!m)return;const y=m.dataset.id,v=Le[p],b=JSON.parse(JSON.stringify(v));if(p===0){if(d.type==="mSelect"){let w=!1;v.mSelect.find(h=>{if(h.content===a.dataset.name)return w=!0,!0}),w||v.mSelect.push({color:a.dataset.color,content:a.dataset.name})}else v.mSelect=[{color:a.dataset.color,content:a.dataset.name}];f=v.mSelect}else v.mSelect=f;c.push({action:"updateAttrViewCell",id:v.id,keyID:r,rowID:y,avID:t.id,data:v}),u.push({action:"updateAttrViewCell",id:v.id,keyID:r,rowID:y,avID:t.id,data:b}),g.classList.contains("custom-attr__avvalue")?g.innerHTML=genAVValueHTML(v):updateAttrViewCellAnimation(g,v)}),a.querySelector(".b3-menu__accelerator")?(d.options.push({color:a.dataset.color,name:a.dataset.name}),c.splice(0,0,{action:"updateAttrViewColOptions",id:r,avID:t.id,data:d.options}),transaction(e,c,[{action:"removeAttrViewColOption",id:r,avID:t.id,data:a.dataset.name}])):transaction(e,c,u),d.type==="select")i.parentElement.remove();else{const g=i.querySelector(".b3-menu__items").scrollTop,p=i.querySelector(".b3-chips").clientHeight;i.innerHTML=un(t.view,n),cn(e,t,i,n,s),i.querySelector("input").focus(),i.querySelector(".b3-menu__items").scrollTop=g+(i.querySelector(".b3-chips").clientHeight-p)}},un=(e,t,n=!1)=>{var a;if(n){Le=[];const r=t[0].classList.contains("custom-attr__avvalue");t.forEach(d=>{Le.push(genCellValueByElement(r?d.dataset.type:getTypeByCellElement(d),d))})}const i=t[0].dataset.colId,s=e.columns.find(r=>{if(r.id===i)return r});let o="";const l=[];return(a=Le[0].mSelect)==null||a.forEach(r=>{l.push(r.content),o+=`<div class="b3-chip b3-chip--middle" data-content="${escapeAttr(r.content)}" style="background-color:var(--b3-font-background${r.color});color:var(--b3-font-color${r.color})">${r.content}<svg class="b3-chip__close" data-type="removeCellOption"><use xlink:href="#iconCloseRound"></use></svg></div>`}),`<div class="b3-menu__items">
<div class="b3-chips" style="max-width: 50vw">
    ${o}
    <input>
</div>
<div>${na("",s.options,l)}</div>
</div>`},Au=(e,t,n)=>{const a=[],i=[];return t.mSelect.forEach(s=>{var o;if(e.options||(e.options=[]),!e.options.find(r=>{if(r.name===s.content)return s.color=r.color,!0})){const r=((((o=e.options)==null?void 0:o.length)||0)%13+1).toString();e.options.push({name:s.content,color:r}),s.color=r,a.push({action:"updateAttrViewColOptions",id:e.id,avID:n,data:e.options}),i.push({action:"removeAttrViewColOption",id:e.id,avID:n,data:s.content})}}),{doOperations:a,undoOperations:i}},Lu=e=>{const t=new Menu("av-add-sort");e.data.view.columns.forEach(n=>{let a=!1;n.type==="lineNumber"?a=!0:e.data.view.sorts.find(i=>{if(i.column===n.id)return a=!0,!0}),a||t.addItem({label:n.name,iconHTML:n.icon?unicode2Emoji(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(n.type)}"></use></svg>`,click:()=>{const i=Object.assign([],e.data.view.sorts);e.data.view.sorts.push({column:n.id,order:"ASC"}),transaction(e.protyle,[{action:"setAttrViewSorts",avID:e.data.id,data:e.data.view.sorts,blockID:e.blockID}],[{action:"setAttrViewSorts",avID:e.data.id,data:i,blockID:e.blockID}]),e.menuElement.innerHTML=Oo(e.data.view.columns,e.data.view.sorts),Ro(e.protyle,e.menuElement,e.data,e.blockID),setPosition(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height)}})}),t.open({x:e.rect.left,y:e.rect.bottom,h:e.rect.height})},Ro=(e,t,n,a)=>{t.querySelectorAll("select").forEach(i=>{i.addEventListener("change",()=>{const s=i.parentElement.getAttribute("data-id"),o=JSON.parse(JSON.stringify(n.view.sorts));i.previousElementSibling.classList.contains("b3-menu__icon")?n.view.sorts.find(l=>{if(l.column===s)return l.column=i.value,i.parentElement.setAttribute("data-id",i.value),!0}):n.view.sorts.find(l=>l.column===s).order=i.value,transaction(e,[{action:"setAttrViewSorts",avID:n.id,data:n.view.sorts,blockID:a}],[{action:"setAttrViewSorts",avID:n.id,data:o,blockID:a}])})})},Oo=(e,t)=>{let n="";const a=i=>{let s="";return e.forEach(o=>{s+=`<option value="${o.id}" ${o.id===i?"selected":""}>${o.icon&&unicode2Emoji(o.icon)}${o.name}</option>`}),s};return t.forEach(i=>{n+=`<button draggable="true" class="b3-menu__item" data-id="${i.column}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <select class="b3-select" style="margin: 4px 0">
        ${a(i.column)}
    </select>
    <span class="fn__space"></span>
    <select class="b3-select" style="margin: 4px 0">
        <option value="ASC" ${i.order==="ASC"?"selected":""}>${window.siyuan.languages.asc}</option>
        <option value="DESC" ${i.order==="DESC"?"selected":""}>${window.siyuan.languages.desc}</option>
    </select>
    <svg class="b3-menu__action" data-type="removeSort"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.sort}</span>
</button>
<button class="b3-menu__separator"></button>
${n}
<button class="b3-menu__item${t.length===e.length?" fn__none":""}" data-type="addSort">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
<button class="b3-menu__item${n?"":" fn__none"}" data-type="removeSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},Su=(e,t)=>{var n,a,i,s,o,l,r,d,c,u;let f=!0,g;t.forEach(b=>{e.rows.find(w=>{if(hasClosestByClassName(b,"av__row").dataset.id===w.id)return w.cells.find(h=>{if(h.id===b.dataset.id)return(!h.value||!h.value.date||!h.value.date.hasEndDate)&&(f=!1),g=h,!0}),!0})}),g||(f=!1);const p=!g||((a=(n=g==null?void 0:g.value)==null?void 0:n.date)==null?void 0:a.isNotTime);let m="";const y=new Date().getTime();(s=(i=g==null?void 0:g.value)==null?void 0:i.date)!=null&&s.isNotEmpty?m=dayjs(g.value.date.content).format(p?"YYYY-MM-DD":"YYYY-MM-DD HH:mm"):m=dayjs(y).format(p?"YYYY-MM-DD":"YYYY-MM-DD HH:mm");let v="";return(l=(o=g==null?void 0:g.value)==null?void 0:o.date)!=null&&l.isNotEmpty2?v=dayjs(g.value.date.content2).format(p?"YYYY-MM-DD":"YYYY-MM-DD HH:mm"):f&&(v=dayjs(y).format(p?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),`<div class="b3-menu__items">
<div>
    <input type="${p?"date":"datetime-local"}" max="${p?"9999-12-31":"9999-12-31 23:59"}" value="${m}" data-value="${dayjs(((d=(r=g==null?void 0:g.value)==null?void 0:r.date)==null?void 0:d.content)||y).format("YYYY-MM-DD HH:mm")}" class="b3-text-field fn__size200" style="margin-top: 4px;"><br>
    <input type="${p?"date":"datetime-local"}" max="${p?"9999-12-31":"9999-12-31 23:59"}" value="${v}" data-value="${(u=(c=g==null?void 0:g.value)==null?void 0:c.date)!=null&&u.isNotEmpty2?dayjs(g.value.date.content2).format("YYYY-MM-DD HH:mm"):""}" style="margin-top: 8px;margin-bottom: 4px" class="b3-text-field fn__size200${f?"":" fn__none"}">
    <button class="b3-menu__separator"></button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.endDate}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${f?" checked":""}>
    </label>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.includeTime}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${p?"":" checked"}>
    </label>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="clearDate">
        <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.clear}</span>
    </button>
</div>
</div>`},xu=e=>{const t=e.menuElement.querySelectorAll("input");return t.forEach(n=>{n.addEventListener("keydown",a=>{var i;a.isComposing||a.key==="Enter"&&(updateCellsValue(e.protyle,e.blockElement,{content:new Date(t[0].dataset.value).getTime(),isNotEmpty:t[0].value!=="",content2:new Date(t[1].dataset.value).getTime(),isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements),(i=document.querySelector(".av__panel"))==null||i.remove())})}),t[0].addEventListener("change",()=>{t[0].dataset.value=t[0].value.length>10?t[0].value:t[0].value+" 00:00"}),t[1].addEventListener("change",()=>{t[1].dataset.value=t[1].value.length>10?t[1].value:t[1].value+" 00:00"}),t[2].addEventListener("change",()=>{if(t[2].checked){if(!t[1].dataset.value){const n=new Date().getTime();t[1].dataset.value=dayjs(n).format("YYYY-MM-DD HH:mm"),t[1].value=dayjs(n).format(t[3].checked?"YYYY-MM-DD HH:mm":"YYYY-MM-DD")}t[1].classList.remove("fn__none")}else t[1].classList.add("fn__none")}),t[3].addEventListener("change",()=>{t[3].checked?(t[0].setAttribute("type","datetime-local"),t[1].setAttribute("type","datetime-local"),t[0].setAttribute("max","9999-12-31 23:59"),t[1].setAttribute("max","9999-12-31 23:59"),t[0].value=t[0].dataset.value,t[1].value=t[1].dataset.value):(t[0].setAttribute("type","date"),t[1].setAttribute("type","date"),t[0].setAttribute("max","9999-12-31"),t[1].setAttribute("max","9999-12-31"),t[0].value=t[0].dataset.value.substring(0,10),t[1].value=t[1].dataset.value.substring(0,10))}),()=>{updateCellsValue(e.protyle,e.blockElement,{content:new Date(t[0].dataset.value).getTime(),isNotEmpty:t[0].value!=="",content2:new Date(t[1].dataset.value).getTime(),isNotEmpty2:t[1].value!=="",hasEndDate:t[2].checked,isNotTime:!t[3].checked},e.cellElements)}},$e=e=>{e.menu.addItem({iconHTML:"",label:qo(e.format),click(){transaction(e.protyle,[{action:"updateAttrViewColNumberFormat",id:e.colId,avID:e.avID,format:e.format,type:"number"}],[{action:"updateAttrViewColNumberFormat",id:e.colId,avID:e.avID,format:e.oldFormat,type:"number"}]),e.avPanelElement.remove()}})},Tu=e=>{const t=new Menu("av-col-format-number");$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"commas",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"percent",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"usDollar",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"yuan",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"euro",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"pound",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"yen",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"ruble",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"rupee",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"won",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"canadianDollar",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement}),$e({menu:t,protyle:e.protyle,colId:e.colId,avID:e.avID,format:"franc",oldFormat:e.oldFormat,avPanelElement:e.avPanelElement});const n=e.element.getBoundingClientRect();t.open({x:n.left,y:n.bottom,h:n.height,w:n.width,isLeft:!0})},qo=e=>{switch(e){case"":return window.siyuan.languages.numberFormatNone;case"commas":return window.siyuan.languages.numberFormatCommas;case"percent":return window.siyuan.languages.numberFormatPercent;case"usDollar":return window.siyuan.languages.numberFormatUSDollar;case"yuan":return window.siyuan.languages.numberFormatYuan;case"euro":return window.siyuan.languages.numberFormatEuro;case"pound":return window.siyuan.languages.numberFormatPound;case"yen":return window.siyuan.languages.numberFormatYen;case"ruble":return window.siyuan.languages.numberFormatRuble;case"rupee":return window.siyuan.languages.numberFormatRupee;case"won":return window.siyuan.languages.numberFormatWon;case"canadianDollar":return window.siyuan.languages.numberFormatCanadianDollar;case"franc":return window.siyuan.languages.numberFormatFranc}},hs=(e,t)=>{var n,a;if(t.classList.contains("b3-list--empty"))return;e.target.querySelector(".b3-menu__accelerator").textContent=t.querySelector(".b3-list-item__text").textContent;const i=e.data.view.columns.find(o=>{if(o.id===e.colId)return o.rollup||(o.rollup={}),!0});if(e.isRelation){if(t.dataset.colId===((n=i.rollup)==null?void 0:n.relationKeyID))return;i.rollup={relationKeyID:t.dataset.colId};const o=e.target.nextElementSibling;o.querySelector(".b3-menu__accelerator").textContent="",o.setAttribute("data-av-id",t.dataset.targetAvId);const l=o.nextElementSibling;l.removeAttribute("data-col-type"),l.removeAttribute("data-calc"),l.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}else{if(t.dataset.colId===((a=i.rollup)==null?void 0:a.keyID))return;i.rollup.keyID=t.dataset.colId,delete i.rollup.calc;const o=e.target.nextElementSibling;o.removeAttribute("data-calc"),o.setAttribute("data-col-type",t.dataset.colType),o.querySelector(".b3-menu__accelerator").textContent=window.siyuan.languages.original}const s=JSON.parse(JSON.stringify(i.rollup));transaction(e.protyle,[{action:"updateAttrViewColRollup",id:e.colId,avID:e.data.id,parentID:i.rollup.relationKeyID,keyID:i.rollup.keyID,data:{calc:i.rollup.calc}}],[{action:"updateAttrViewColRollup",id:e.colId,avID:e.data.id,parentID:s.relationKeyID,keyID:s.keyID,data:{calc:s.calc}}])},ys=(e,t,n,a,i)=>{if(!a&&!n){showMessage(window.siyuan.languages.selectRelation);return}fetchPost(a?"/api/av/searchAttributeViewRelationKey":"/api/av/searchAttributeViewNonRelationKey",{avID:n,keyword:t},s=>{let o="";s.data.keys.forEach((l,r)=>{o+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-col-id="${l.id}" ${a?`data-target-av-id="${l.relation.avID}"`:`data-col-type="${l.type}"`}>
        ${l.icon?unicode2Emoji(l.icon,"b3-list-item__graphic",!0):`<svg class="b3-list-item__graphic"><use xlink:href="#${getColIconByType(l.type)}"></use></svg>`}
        <span class="b3-list-item__text">${escapeHtml(l.name||window.siyuan.languages.title)}</span>
</div>`}),e.innerHTML=o||`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,i&&i()})},Iu=e=>{window.siyuan.menus.menu.remove();const t=new Menu;t.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column b3-menu__filter">
    <input class="b3-text-field fn__flex-shrink" placeholder="${window.siyuan.languages[e.isRelation?"searchRelation":"searchRollupProperty"]}"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(n){const a=n.querySelector(".b3-list"),i=n.querySelector("input");i.addEventListener("keydown",s=>{if(s.isComposing)return;upDownHint(a,s)&&s.stopPropagation(),s.key==="Enter"&&(s.preventDefault(),s.stopPropagation(),hs(e,a.querySelector(".b3-list-item--focus")),window.siyuan.menus.menu.remove())}),i.addEventListener("input",s=>{s.stopPropagation(),ys(a,i.value,e.isRelation?e.data.id:e.target.dataset.avId,e.isRelation)}),n.lastElementChild.addEventListener("click",s=>{const o=hasClosestByClassName(s.target,"b3-list-item");o&&(s.stopPropagation(),hs(e,o),window.siyuan.menus.menu.remove())}),ys(a,"",e.isRelation?e.data.id:e.target.dataset.avId,e.isRelation,()=>{const s=e.target.getBoundingClientRect();t.open({x:s.left,y:s.bottom,h:s.height}),n.querySelector("input").focus()})}}),t.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial")},Du=e=>{var t,n;let a;return e.colData?a=e.colData:e.data.view.columns.find(i=>{if(i.id===e.cellElements[0].dataset.colId)return a=i,!0}),`<button class="b3-menu__item" data-type="goSearchRollupCol" data-old-value='${JSON.stringify(a.rollup||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relation}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupTarget">
    <span class="b3-menu__label">${window.siyuan.languages.rollupProperty}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupCalc">
    <span class="b3-menu__label">${window.siyuan.languages.rollupCalc}</span>
    <span class="b3-menu__accelerator">${getNameByOperator((n=(t=a.rollup)==null?void 0:t.calc)==null?void 0:n.operator,!0)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`},Mu=e=>{const t=e.menuElement.querySelector('[data-type="goSearchRollupCol"]');if(t){const n=JSON.parse(t.dataset.oldValue),a=e.menuElement.querySelector('[data-type="goSearchRollupTarget"]');let i="";n.relationKeyID&&e.data.view.columns.find(s=>{if(s.id===n.relationKeyID)return t.querySelector(".b3-menu__accelerator").textContent=s.name,i=s.relation.avID,a.dataset.avId=i,!0}),n.keyID&&i&&fetchPost("/api/av/getAttributeView",{id:i},s=>{s.data.av.keyValues.find(o=>{if(o.key.id===n.keyID){a.querySelector(".b3-menu__accelerator").textContent=o.key.name;const l=e.menuElement.querySelector('[data-type="goSearchRollupCalc"]');return l.dataset.colType=o.key.type,n.calc&&(l.dataset.calc=n.calc.operator),!0}})})}},Fo=e=>{var t;let n=document.querySelector(".av__panel");if(n){n.remove();return}const a=e.blockElement.getAttribute("data-av-id");fetchPost("/api/av/renderAttributeView",{id:a,query:((t=e.blockElement.querySelector('[data-type="av-search"]'))==null?void 0:t.value.trim())||"",pageSize:parseInt(e.blockElement.getAttribute("data-page-size"))||void 0,viewID:e.blockElement.getAttribute(Constants.CUSTOM_SY_AV_VIEW)},i=>{var s;if(n=document.querySelector(".av__panel"),n){n.remove();return}window.siyuan.menus.menu.remove();const o=e.blockElement.getAttribute("data-node-id"),l=!e.blockElement.classList.contains("av"),r=i.data;let d;if(e.type==="config")d=getViewHTML(r);else if(e.type==="properties")d=gt(r.view);else if(e.type==="sorts")d=getSortsHTML(r.view.columns,r.view.sorts);else if(e.type==="switcher")d=getSwitcherHTML(r.views,r.viewID);else if(e.type==="filters")d=getFiltersHTML(r.view);else if(e.type==="select")d=getSelectHTML(r.view,e.cellElements,!0);else if(e.type==="asset")d=getAssetHTML(e.cellElements);else if(e.type==="edit")e.editData&&(e.editData.previousID?r.view.columns.find((m,y)=>{if(m.id===e.editData.previousID)return r.view.columns.splice(y+1,0,e.editData.colData),!0}):r.view.columns.splice(0,0,e.editData.colData)),d=getEditHTML({protyle:e.protyle,data:r,colId:e.colId,isCustomAttr:l});else if(e.type==="date")d=getDateHTML(r.view,e.cellElements);else if(e.type==="rollup")d=`<div class="b3-menu__items">${getRollupHTML({data:r,cellElements:e.cellElements})}</div>`;else if(e.type==="relation"&&(d=getRelationHTML(r,e.cellElements),!d)){Fo({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:e.cellElements[0].dataset.colId});return}document.body.insertAdjacentHTML("beforeend",`<div class="av__panel" style="z-index: ${++window.siyuan.zIndex}">
    <div class="b3-dialog__scrim" data-type="close"></div>
    <div class="b3-menu">${d}</div>
</div>`),n=document.querySelector(".av__panel");let c;const u=n.lastElementChild;let f=(s=e.blockElement.querySelector(`.av__views, .av__row[data-col-id="${e.colId}"] > .block__logo`))==null?void 0:s.getBoundingClientRect();if(["select","date","asset","relation","rollup"].includes(e.type)){const m=e.cellElements[e.cellElements.length-1].getBoundingClientRect();if(e.type==="select"?bindSelectEvent(e.protyle,r,u,e.cellElements,e.blockElement):e.type==="date"?c=bindDateEvent({protyle:e.protyle,data:r,menuElement:u,cellElements:e.cellElements,blockElement:e.blockElement}):e.type==="asset"?(bindAssetEvent({protyle:e.protyle,menuElement:u,cellElements:e.cellElements,blockElement:e.blockElement}),setTimeout(()=>{setPosition(u,m.left,m.bottom,m.height)},Constants.TIMEOUT_LOAD)):e.type==="relation"?bindRelationEvent({menuElement:u,cellElements:e.cellElements,protyle:e.protyle,blockElement:e.blockElement}):e.type==="rollup"&&bindRollupData({protyle:e.protyle,data:r,menuElement:u}),["select","date","relation","rollup"].includes(e.type)){const y=u.querySelector("input");y&&(y.select(),y.focus()),setPosition(u,m.left,m.bottom,m.height)}}else setPosition(u,f.right-u.clientWidth,f.bottom,f.height),e.type==="sorts"?bindSortsEvent(e.protyle,u,r,o):e.type==="edit"?bindEditEvent({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:l,blockID:o}):e.type==="config"?bindViewEvent({protyle:e.protyle,data:r,menuElement:u,blockElement:e.blockElement}):e.type==="switcher"&&bindSwitcherEvent({protyle:e.protyle,menuElement:u,blockElement:e.blockElement});e.cb&&e.cb(n),n.addEventListener("dragstart",m=>{window.siyuan.dragElement=m.target,window.siyuan.dragElement.style.opacity=".1"}),n.addEventListener("drop",m=>{var y,v,b,w;if(p=0,!window.siyuan.dragElement){m.preventDefault(),m.stopPropagation();return}window.siyuan.dragElement.style.opacity="";const h=window.siyuan.dragElement;if(window.siyuan.dragElement=void 0,e.protyle&&e.protyle.disabled){m.preventDefault(),m.stopPropagation();return}if(!e.protyle&&window.siyuan.config.readonly){m.preventDefault(),m.stopPropagation();return}const C=n.querySelector(".dragover__bottom, .dragover__top");if(!C)return;const k=C.classList.contains("dragover__top"),E=h.dataset.id,_=C.dataset.id;if(C.querySelector('[data-type="removeSort"]')){const L=r.view.sorts,A=Object.assign([],L);let S;L.find((I,T)=>{if(I.column===E)return S=L.splice(T,1)[0],!0}),L.find((I,T)=>{if(I.column===_)return k?L.splice(T,0,S):L.splice(T+1,0,S),!0}),transaction(e.protyle,[{action:"setAttrViewSorts",avID:a,data:L,blockID:o}],[{action:"setAttrViewSorts",avID:a,data:A,blockID:o}]),u.innerHTML=getSortsHTML(r.view.columns,r.view.sorts),bindSortsEvent(e.protyle,u,r,o);return}if(C.querySelector('[data-type="removeFilter"]')){const L=r.view.filters,A=Object.assign([],L);let S;L.find((I,T)=>{if(I.column===E)return S=L.splice(T,1)[0],!0}),L.find((I,T)=>{if(I.column===_)return k?L.splice(T,0,S):L.splice(T+1,0,S),!0}),transaction(e.protyle,[{action:"setAttrViewFilters",avID:a,data:L,blockID:o}],[{action:"setAttrViewFilters",avID:a,data:A,blockID:o}]),u.innerHTML=getFiltersHTML(r.view);return}if(C.querySelector('[data-type="av-view-edit"]')){transaction(e.protyle,[{action:"sortAttrViewView",avID:a,blockID:o,id:E,previousID:k?(y=C.previousElementSibling)==null?void 0:y.getAttribute("data-id"):C.getAttribute("data-id")}],[{action:"sortAttrViewView",avID:a,blockID:o,id:E,previousID:(v=h.previousElementSibling)==null?void 0:v.getAttribute("data-id")}]),k?(C.before(h),C.classList.remove("dragover__top")):(C.after(h),C.classList.remove("dragover__bottom"));return}if(C.querySelector('[data-type="editAssetItem"]')){k?C.before(h):C.after(h);const L=[];Array.from(C.parentElement.children).forEach(A=>{A.dataset.content&&L.push({content:A.dataset.content,name:A.dataset.name,type:A.dataset.type})}),updateAssetCell({protyle:e.protyle,cellElements:e.cellElements,replaceValue:L,blockElement:e.blockElement});return}if(C.querySelector('[data-type="setColOption"]')){const L=e.cellElements?e.cellElements[0].dataset.colId:u.querySelector(".b3-menu__item").getAttribute("data-col-id"),A=r.view.columns.find(D=>D.id===L).options,S=Object.assign([],A);let I;A.find((D,M)=>{if(D.name===h.dataset.name)return I=A.splice(M,1)[0],!0}),A.find((D,M)=>{if(D.name===C.dataset.name)return k?A.splice(M,0,I):A.splice(M+1,0,I),!0}),transaction(e.protyle,[{action:"updateAttrViewColOptions",id:L,avID:a,data:A}],[{action:"updateAttrViewColOptions",id:L,avID:a,data:S}]);const T=u.querySelector(".b3-menu__items").scrollTop;e.cellElements?(u.innerHTML=getSelectHTML(r.view,e.cellElements),bindSelectEvent(e.protyle,r,u,e.cellElements,e.blockElement)):(u.innerHTML=getEditHTML({protyle:e.protyle,data:r,colId:L,isCustomAttr:l}),bindEditEvent({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:l,blockID:o})),u.querySelector(".b3-menu__items").scrollTop=T;return}if(C.getAttribute("data-type")==="setRelationCell"){k?C.before(h):C.after(h),C.classList.remove("dragover__bottom","dragover__top");const L=[],A=[];C.parentElement.querySelectorAll(".fn__grab").forEach(S=>{const I=S.nextElementSibling;L.push(I.dataset.id),A.push({isDetached:!I.style.color,type:"block",block:{content:I.textContent,id:I.dataset.id}})}),updateCellsValue(e.protyle,e.blockElement,{blockIDs:L,contents:A},e.cellElements);return}if(C.getAttribute("data-type")==="editCol"){const L=(C.classList.contains("dragover__top")?(b=C.previousElementSibling)==null?void 0:b.getAttribute("data-id"):C.getAttribute("data-id"))||"",A=((w=h.previousElementSibling)==null?void 0:w.getAttribute("data-id"))||"";if(L!==A&&L!==E){transaction(e.protyle,[{action:"sortAttrViewCol",avID:a,previousID:L,id:E,blockID:o}],[{action:"sortAttrViewCol",avID:a,previousID:A,id:E,blockID:o}]);let S;r.view.columns.find((I,T)=>{if(I.id===E)return S=r.view.columns.splice(T,1)[0],!0}),r.view.columns.find((I,T)=>{if(I.id===_)return k?r.view.columns.splice(T,0,S):r.view.columns.splice(T+1,0,S),!0})}u.innerHTML=gt(r.view);return}});let g;n.addEventListener("dragover",m=>{if(m.dataTransfer.types.includes("Files")){m.preventDefault();return}const y=m.target;let v=hasClosestByAttribute(y,"draggable","true");if(v||(v=hasClosestByAttribute(document.elementFromPoint(m.clientX,m.clientY-1),"draggable","true")),!(!v||v.isSameNode(window.siyuan.dragElement))){if(m.preventDefault(),g&&v.isSameNode(g)){const b=v.getBoundingClientRect();n.querySelectorAll(".dragover__bottom, .dragover__top").forEach(w=>{w.classList.remove("dragover__bottom","dragover__top")}),m.clientY>b.top+b.height/2?v.classList.add("dragover__bottom"):v.classList.add("dragover__top");return}g=v}});let p=0;n.addEventListener("dragleave",()=>{p--,p===0&&n.querySelectorAll(".dragover__bottom, .dragover__top").forEach(m=>{m.classList.remove("dragover__bottom","dragover__top")})}),n.addEventListener("dragenter",m=>{m.preventDefault(),p++}),n.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),n.addEventListener("mousedown",m=>{m.button===1&&!hasClosestByClassName(m.target,"b3-menu")&&document.querySelector(".av__panel").dispatchEvent(new CustomEvent("click",{detail:"close"}))}),n.addEventListener("click",m=>{var y;let v;typeof m.detail=="string"&&(v=m.detail);let b=m.target;for(;b&&!b.isSameNode(n)||v;){if(v=(b==null?void 0:b.dataset.type)||v,v==="close"){e.protyle.toolbar.subElement.classList.contains("fn__none")?window.siyuan.menus.menu.element.classList.contains("fn__none")?(c==null||c(),n.remove(),focusBlock(e.blockElement)):window.siyuan.menus.menu.remove():hideElements(["util"],e.protyle),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(v==="go-config"){u.innerHTML=getViewHTML(r),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),bindViewEvent({protyle:e.protyle,data:r,menuElement:u,blockElement:e.blockElement}),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(v==="go-properties"){f=e.blockElement.querySelector(".av__views").getBoundingClientRect(),u.innerHTML=gt(r.view),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(v==="goSorts"){u.innerHTML=getSortsHTML(r.view.columns,r.view.sorts),bindSortsEvent(e.protyle,u,r,o),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(v==="removeSorts"){transaction(e.protyle,[{action:"setAttrViewSorts",avID:a,data:[],blockID:o}],[{action:"setAttrViewSorts",avID:a,data:r.view.sorts,blockID:o}]),r.view.sorts=[],u.innerHTML=getSortsHTML(r.view.columns,r.view.sorts),bindSortsEvent(e.protyle,u,r,o),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),m.preventDefault(),m.stopPropagation();break}else if(v==="addSort"){addSort({data:r,rect:b.getBoundingClientRect(),menuElement:u,tabRect:f,avId:a,protyle:e.protyle,blockID:o}),m.preventDefault(),m.stopPropagation();break}else if(v==="removeSort"){const w=Object.assign([],r.view.sorts);r.view.sorts.find((h,C)=>{if(h.column===b.parentElement.dataset.id)return r.view.sorts.splice(C,1),!0}),transaction(e.protyle,[{action:"setAttrViewSorts",avID:a,data:r.view.sorts,blockID:o}],[{action:"setAttrViewSorts",avID:a,data:w,blockID:o}]),u.innerHTML=getSortsHTML(r.view.columns,r.view.sorts),bindSortsEvent(e.protyle,u,r,o),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),m.preventDefault(),m.stopPropagation();break}else if(v==="goFilters"){u.innerHTML=getFiltersHTML(r.view),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(v==="removeFilters"){transaction(e.protyle,[{action:"setAttrViewFilters",avID:a,data:[],blockID:o}],[{action:"setAttrViewFilters",avID:a,data:r.view.filters,blockID:o}]),r.view.filters=[],u.innerHTML=getFiltersHTML(r.view),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(v==="addFilter"){addFilter({data:r,rect:b.getBoundingClientRect(),menuElement:u,tabRect:f,avId:a,protyle:e.protyle,blockElement:e.blockElement}),m.preventDefault(),m.stopPropagation();break}else if(v==="removeFilter"){window.siyuan.menus.menu.remove();const w=Object.assign([],r.view.filters);r.view.filters.find((h,C)=>{if(h.column===b.parentElement.dataset.id&&h.value.type===b.parentElement.dataset.filterType)return r.view.filters.splice(C,1),!0}),transaction(e.protyle,[{action:"setAttrViewFilters",avID:a,data:r.view.filters,blockID:o}],[{action:"setAttrViewFilters",avID:a,data:w,blockID:o}]),u.innerHTML=getFiltersHTML(r.view),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),m.preventDefault(),m.stopPropagation();break}else if(v==="setFilter"){r.view.filters.find(w=>{if(w.column===b.parentElement.parentElement.dataset.id&&w.value.type===b.parentElement.parentElement.dataset.filterType)return setFilter({filter:w,protyle:e.protyle,data:r,target:b,blockElement:e.blockElement}),!0}),m.preventDefault(),m.stopPropagation();break}else if(v==="numberFormat"){formatNumber({avPanelElement:n,element:b,protyle:e.protyle,oldFormat:b.dataset.format,colId:u.querySelector(".b3-menu__item").getAttribute("data-col-id"),avID:a}),m.preventDefault(),m.stopPropagation();break}else if(v==="newCol"){n.remove(),addCol(e.protyle,e.blockElement).open({x:f.right,y:f.bottom,h:f.height,isLeft:!0}),m.preventDefault(),m.stopPropagation();break}else if(v==="update-view-icon"){const w=b.getBoundingClientRect();openEmojiPanel("","av",{x:w.left,y:w.bottom,h:w.height,w:w.width},h=>{transaction(e.protyle,[{action:"setAttrViewViewIcon",avID:a,id:r.viewID,data:h}],[{action:"setAttrViewViewIcon",id:r.viewID,avID:a,data:b.dataset.icon}]),b.innerHTML=h?unicode2Emoji(h):'<svg><use xlink:href="#iconTable"></use></svg>',b.dataset.icon=h}),m.preventDefault(),m.stopPropagation();break}else if(v==="set-page-size"){setPageSize({target:b,protyle:e.protyle,avID:a,nodeElement:e.blockElement}),m.preventDefault(),m.stopPropagation();break}else if(v==="duplicate-view"){const w=Lute.NewNodeID();transaction(e.protyle,[{action:"duplicateAttrViewView",avID:a,previousID:r.viewID,id:w,blockID:o}],[{action:"removeAttrViewView",avID:a,id:w,blockID:o}]),e.blockElement.setAttribute(Constants.CUSTOM_SY_AV_VIEW,w),n.remove(),m.preventDefault(),m.stopPropagation();break}else if(v==="delete-view"){transaction(e.protyle,[{action:"removeAttrViewView",avID:a,id:r.viewID,blockID:o}]),n.remove(),m.preventDefault(),m.stopPropagation();break}else if(v==="update-icon"){const w=b.getBoundingClientRect();openEmojiPanel("","av",{x:w.left,y:w.bottom,h:w.height,w:w.width},h=>{const C=u.querySelector(".b3-menu__item").getAttribute("data-col-id");if(transaction(e.protyle,[{action:"setAttrViewColIcon",id:C,avID:a,data:h}],[{action:"setAttrViewColIcon",id:C,avID:a,data:b.dataset.icon}]),b.innerHTML=h?unicode2Emoji(h):`<svg><use xlink:href="#${getColIconByType(b.dataset.colType)}"></use></svg>`,l){const k=e.blockElement.querySelector(`.av__row[data-col-id="${C}"] .block__logoicon`);k.outerHTML=h?unicode2Emoji(h,"block__logoicon",!0):`<svg class="block__logoicon"><use xlink:href="#${getColIconByType(k.nextElementSibling.getAttribute("data-type"))}"></use></svg>`}else updateAttrViewCellAnimation(e.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${C}"]`),void 0,{icon:h});b.dataset.icon=h}),m.preventDefault(),m.stopPropagation();break}else if(v==="showAllCol"){const w=[],h=[];r.view.columns.forEach(C=>{C.hidden&&(w.push({action:"setAttrViewColHidden",id:C.id,avID:a,data:!1,blockID:o}),h.push({action:"setAttrViewColHidden",id:C.id,avID:a,data:!0,blockID:o}),C.hidden=!1)}),w.length>0&&(transaction(e.protyle,w,h),u.innerHTML=gt(r.view),setPosition(u,f.right-u.clientWidth,f.bottom,f.height)),m.preventDefault(),m.stopPropagation();break}else if(v==="hideAllCol"){const w=[],h=[];r.view.columns.forEach(C=>{!C.hidden&&C.type!=="block"&&(w.push({action:"setAttrViewColHidden",id:C.id,avID:a,data:!0,blockID:o}),h.push({action:"setAttrViewColHidden",id:C.id,avID:a,data:!1,blockID:o}),C.hidden=!0)}),w.length>0&&(transaction(e.protyle,w,h),u.innerHTML=gt(r.view),setPosition(u,f.right-u.clientWidth,f.bottom,f.height)),m.preventDefault(),m.stopPropagation();break}else if(v==="editCol"){u.innerHTML=getEditHTML({protyle:e.protyle,data:r,colId:b.dataset.id,isCustomAttr:l}),bindEditEvent({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:l,blockID:o}),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),m.preventDefault(),m.stopPropagation();break}else if(v==="updateColType"){if(b.dataset.newType!==b.dataset.oldType){const w=n.querySelector('.b3-text-field[data-type="name"]').value;if(r.view.columns.find(h=>h.id===e.colId).type=b.dataset.newType,transaction(e.protyle,[{action:"updateAttrViewCol",id:e.colId,avID:a,name:w,type:b.dataset.newType}],[{action:"updateAttrViewCol",id:e.colId,avID:a,name:w,type:b.dataset.oldType}]),b.dataset.newType==="lineNumber"){if(r.view.sorts.find(k=>k.column===e.colId)){const k=Object.assign([],r.view.sorts),E=r.view.sorts.filter(_=>_.column!==e.colId);transaction(e.protyle,[{action:"setAttrViewSorts",avID:r.id,data:E,blockID:o}],[{action:"setAttrViewSorts",avID:r.id,data:k,blockID:o}])}if(r.view.filters.find(k=>k.column===e.colId)){const k=JSON.parse(JSON.stringify(r.view.filters)),E=r.view.filters.filter(_=>_.column!==e.colId);transaction(e.protyle,[{action:"setAttrViewFilters",avID:r.id,data:E,blockID:o}],[{action:"setAttrViewFilters",avID:r.id,data:k,blockID:o}])}}}u.innerHTML=getEditHTML({protyle:e.protyle,data:r,colId:e.colId,isCustomAttr:l}),bindEditEvent({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:l,blockID:o}),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),m.preventDefault(),m.stopPropagation();break}else if(v==="goUpdateColType"){const w=hasClosestByClassName(b,"b3-menu");w&&(w.firstElementChild.classList.add("fn__none"),w.lastElementChild.classList.remove("fn__none")),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),m.preventDefault(),m.stopPropagation();break}else if(v==="goSearchAV"){openSearchAV(a,b,void 0,!1),m.preventDefault(),m.stopPropagation();break}else if(v==="goSearchRollupCol"){goSearchRollupCol({target:b,data:r,isRelation:!0,protyle:e.protyle,colId:e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id")}),m.preventDefault(),m.stopPropagation();break}else if(v==="goSearchRollupTarget"){goSearchRollupCol({target:b,data:r,isRelation:!1,protyle:e.protyle,colId:e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id")}),m.preventDefault(),m.stopPropagation();break}else if(v==="goSearchRollupCalc"){openCalcMenu(e.protyle,b,{data:r,colId:e.colId||u.querySelector(".b3-menu__item").getAttribute("data-col-id"),blockID:o}),m.preventDefault(),m.stopPropagation();break}else if(v==="updateRelation"){updateRelation({protyle:e.protyle,avElement:n,avID:a,colsData:r.view.columns,blockElement:e.blockElement}),m.preventDefault(),m.stopPropagation();break}else if(v==="goEditCol"){const w=hasClosestByClassName(b,"b3-menu");w&&(w.firstElementChild.classList.remove("fn__none"),w.lastElementChild.classList.add("fn__none")),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),m.preventDefault(),m.stopPropagation();break}else if(v==="hideCol"){const w=u.querySelector('[data-type="go-properties"]'),h=w?u.querySelector(".b3-menu__item").getAttribute("data-col-id"):b.parentElement.getAttribute("data-id");transaction(e.protyle,[{action:"setAttrViewColHidden",id:h,avID:a,data:!0,blockID:o}],[{action:"setAttrViewColHidden",id:h,avID:a,data:!1,blockID:o}]),r.view.columns.find(C=>C.id===h).hidden=!0,w?(u.innerHTML=getEditHTML({protyle:e.protyle,data:r,colId:h,isCustomAttr:l}),bindEditEvent({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:l,blockID:o})):u.innerHTML=gt(r.view),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),m.preventDefault(),m.stopPropagation();break}else if(v==="showCol"){const w=u.querySelector('[data-type="go-properties"]'),h=w?u.querySelector(".b3-menu__item").getAttribute("data-col-id"):b.parentElement.getAttribute("data-id");transaction(e.protyle,[{action:"setAttrViewColHidden",id:h,avID:a,data:!1,blockID:o}],[{action:"setAttrViewColHidden",id:h,avID:a,data:!0,blockID:o}]),r.view.columns.find(C=>C.id===h).hidden=!1,w?(u.innerHTML=getEditHTML({protyle:e.protyle,data:r,colId:h,isCustomAttr:l}),bindEditEvent({protyle:e.protyle,data:r,menuElement:u,isCustomAttr:l,blockID:o})):u.innerHTML=gt(r.view),setPosition(u,f.right-u.clientWidth,f.bottom,f.height),m.preventDefault(),m.stopPropagation();break}else if(v==="duplicateCol"){duplicateCol({blockElement:e.blockElement,protyle:e.protyle,colId:u.querySelector(".b3-menu__item").getAttribute("data-col-id"),data:r,viewID:r.viewID}),m.preventDefault(),m.stopPropagation();break}else if(v==="removeCol"){l||(f=e.blockElement.querySelector(".av__views").getBoundingClientRect());const w=u.querySelector(".b3-menu__item").getAttribute("data-col-id"),h=r.view.columns.find(k=>{if(k.id===w)return!0}),C=h.type==="relation"&&((y=h.relation)==null?void 0:y.isTwoWay);if(l||C){const k=new Dialog({title:C?window.siyuan.languages.removeCol.replace("${x}",u.querySelector("input").value):window.siyuan.languages.deleteOpConfirm,content:`<div class="b3-dialog__content">
    ${C?window.siyuan.languages.confirmRemoveRelationField.replace("${x}",u.querySelector('.b3-menu__item[data-type="goSearchAV"] .b3-menu__accelerator').textContent):window.siyuan.languages.removeCol.replace("${x}",u.querySelector("input").value)}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--error">${window.siyuan.languages.delete}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--warning${C?"":" fn__none"}">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--info">${window.siyuan.languages.cancel}</button>
</div>`});k.element.addEventListener("click",E=>{let _=E.target;for(;_&&!_.isSameNode(k.element);){if(_.classList.contains("b3-button--error")){removeCol({protyle:e.protyle,data:r,avID:a,blockID:o,menuElement:u,isCustomAttr:l,blockElement:e.blockElement,avPanelElement:n,tabRect:f,isTwoWay:!0}),k.destroy();break}else if(_.classList.contains("b3-button--warning")){removeCol({protyle:e.protyle,data:r,avID:a,blockID:o,menuElement:u,isCustomAttr:l,blockElement:e.blockElement,avPanelElement:n,tabRect:f,isTwoWay:!1}),k.destroy();break}else if(_.classList.contains("b3-button--info")){k.destroy();break}_=_.parentElement}})}else removeCol({protyle:e.protyle,data:r,avID:a,blockID:o,menuElement:u,isCustomAttr:l,blockElement:e.blockElement,avPanelElement:n,tabRect:f,isTwoWay:!1});m.preventDefault(),m.stopPropagation();break}else if(v==="setColOption"){setColOption(e.protyle,r,b,e.blockElement,l,e.cellElements),m.preventDefault(),m.stopPropagation();break}else if(v==="setRelationCell"){setRelationCell(e.protyle,e.blockElement,b,e.cellElements),m.preventDefault(),m.stopPropagation();break}else if(v==="addColOptionOrCell"){b.querySelector(".b3-menu__checked")?removeCellOption(e.protyle,e.cellElements,u.querySelector(`.b3-chips .b3-chip[data-content="${escapeAttr(b.dataset.name)}"]`),e.blockElement):addColOptionOrCell(e.protyle,r,e.cellElements,b,u,e.blockElement),window.siyuan.menus.menu.remove(),m.preventDefault(),m.stopPropagation();break}else if(v==="removeCellOption"){removeCellOption(e.protyle,e.cellElements,b.parentElement,e.blockElement),m.preventDefault(),m.stopPropagation();break}else if(v==="addAssetLink"){addAssetLink(e.protyle,e.cellElements,b,e.blockElement),m.preventDefault(),m.stopPropagation();break}else if(v==="addAssetExist"){const w=b.getBoundingClientRect();assetMenu(e.protyle,{x:w.right,y:w.bottom,w:b.parentElement.clientWidth+8,h:w.height},(h,C)=>{let k;Constants.SIYUAN_ASSETS_IMAGE.includes(pathPosix().extname(h).toLowerCase())?k={type:"image",content:h,name:""}:k={type:"file",content:h,name:C},updateAssetCell({protyle:e.protyle,cellElements:e.cellElements,addValue:[k],blockElement:e.blockElement}),window.siyuan.menus.menu.remove()}),m.preventDefault(),m.stopPropagation();break}else if(v==="openAssetItem"){const w=b.parentElement.dataset.content,h=pathPosix().extname(w);Constants.SIYUAN_ASSETS_IMAGE.includes(h)?previewImage(w):window.open(w),m.preventDefault(),m.stopPropagation();break}else if(v==="editAssetItem"){editAssetItem({protyle:e.protyle,cellElements:e.cellElements,blockElement:e.blockElement,content:b.parentElement.dataset.content,type:b.parentElement.dataset.type,name:b.parentElement.dataset.name,index:parseInt(b.parentElement.dataset.index),rect:b.parentElement.getBoundingClientRect()}),m.preventDefault(),m.stopPropagation();break}else if(v==="clearDate"){updateCellsValue(e.protyle,e.blockElement,{isNotEmpty2:!1,isNotEmpty:!1,content:null,content2:null,hasEndDate:!1,isNotTime:!0},e.cellElements),n.remove(),m.preventDefault(),m.stopPropagation();break}else if(v==="av-add"){window.siyuan.menus.menu.remove(),addView(e.protyle,e.blockElement),n.remove(),m.preventDefault(),m.stopPropagation();break}else if(v==="av-view-switch"){b.querySelector(".b3-chip--primary")||(e.blockElement.removeAttribute("data-render"),avRender(e.blockElement,e.protyle,void 0,b.parentElement.dataset.id)),m.preventDefault(),m.stopPropagation();break}else if(v==="av-view-edit"){b.parentElement.querySelector(".b3-chip--primary")?openViewMenu({protyle:e.protyle,blockElement:e.blockElement,element:b.parentElement}):(e.blockElement.removeAttribute("data-render"),avRender(e.blockElement,e.protyle,()=>{openViewMenu({protyle:e.protyle,blockElement:e.blockElement,element:b.parentElement}),n.querySelector(".b3-chip--primary").classList.remove("b3-chip--primary"),b.parentElement.querySelector(".b3-chip").classList.add("b3-chip--primary")},b.parentElement.dataset.id)),m.preventDefault(),m.stopPropagation();break}if(!b||!b.parentElement)break;b=b.parentElement}})})},gt=e=>{let t="",n="";return e.columns.forEach(a=>{a.hidden?n+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${a.icon?unicode2Emoji(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(a.type)}"></use></svg>`}
        ${a.name||"&nbsp;"}
    </div>
    <svg class="b3-menu__action" data-type="showCol"><use xlink:href="#iconEye"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`:t+=`<button class="b3-menu__item" data-type="editCol" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="b3-menu__label fn__flex">
        ${a.icon?unicode2Emoji(a.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(a.type)}"></use></svg>`}
        ${a.name||"&nbsp;"}
    </div>
    <svg class="b3-menu__action${a.type==="block"?" fn__none":""}" data-type="hideCol"><use xlink:href="#iconEyeoff"></use></svg>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`}),n&&(n=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.hideCol} 
    </span>
    <span class="block__icon" data-type="showAllCol">
        ${window.siyuan.languages.showAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye"></use></svg>
    </span>
</button>
${n}`),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.attr}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.showCol} 
    </span>
    <span class="block__icon" data-type="hideAllCol">
        ${window.siyuan.languages.hideAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEyeoff"></use></svg>
    </span>
</button>
${t}
${n}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="newCol">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
</div>`},$u=e=>e&&e.replace(/&/g,"&amp;").replace(/</g,"&lt;"),Hu=e=>e.replace(/</g,"&lt;"),fn=e=>e&&e.replace(/"/g,"&quot;").replace(/'/g,"&apos;"),Nu=e=>e.replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&amp;lt;").replace(/&lt;/g,"&amp;lt;"),ws=e=>{let t=e,n="";try{const a=new URL(e);a.protocol.startsWith("http")&&(t=a.host,n=a.href.replace(a.origin,""),n.length>12&&(n=n.substring(0,4)+"..."+n.substring(n.length-6)))}catch(a){t=Lute.EscapeHTMLStr(e)}return`<span class="av__celltext av__celltext--url" data-type="url" data-href="${fn(e)}"><span>${t}</span><span class="ft__on-surface">${n}</span></span>`},Yo=e=>{if(!e)return"";let t="";const n=e.querySelectorAll(".b3-chip, .av__celltext--ref, .av__celltext");return n.length>0?(n.forEach(a=>{a.querySelector(".av__cellicon")?t+=`${a.firstChild.textContent} \u2192 ${a.lastChild.textContent}, `:a.getAttribute("data-type")==="url"?t=a.getAttribute("data-href")+", ":a.getAttribute("data-type")!=="block-more"&&(t+=a.textContent+", ")}),t=t.substring(0,t.length-2)):t=e.textContent,t},_s=(e,t)=>{const n={type:e,id:t.dataset.id};if(e==="number"){const a=t.querySelector(".av__celltext").getAttribute("data-content");n.number={content:parseFloat(a)||0,isNotEmpty:!!a}}else if(["text","block","url","phone","email","template"].includes(e)){const a=t.querySelector(".av__celltext");n[e]={content:e==="url"?a.dataset.href:a.textContent},e==="block"&&a.dataset.id&&(n.block.id=a.dataset.id)}else if(e==="mSelect"||e==="select"){const a=[];t.querySelectorAll(".b3-chip").forEach(i=>{a.push({content:i.textContent.trim(),color:i.style.color.replace("var(--b3-font-color","").replace(")","")})}),n.mSelect=a}else if(["date","created","updated"].includes(e))n[e]=JSON.parse(t.querySelector(".av__celltext").getAttribute("data-value"));else if(e==="checkbox")n.checkbox={checked:t.querySelector("use").getAttribute("xlink:href")==="#iconCheck"};else if(e==="relation"){const a=[],i=[];Array.from(t.querySelectorAll("span")).forEach(s=>{a.push(s.dataset.id),i.push({isDetached:!s.classList.contains("av__celltext--ref"),block:{content:s.textContent,id:s.dataset.id},type:"block"})}),n.relation={blockIDs:a,contents:i}}else if(e==="mAsset"){const a=[];Array.from(t.children).forEach(i=>{if(i.classList.contains("av__drag-fill"))return;const s=i.classList.contains("av__cellassetimg");a.push({type:s?"image":"file",content:s?i.getAttribute("src"):i.getAttribute("data-url"),name:s?"":i.getAttribute("data-name")})}),n.mAsset=a}return e==="block"&&(n.isDetached=t.dataset.detached==="true"),n},Uo=(e,t)=>{let n={type:e,[e==="select"?"mSelect":e]:t};if(typeof t=="string"&&t){if(e==="number")n={type:e,number:{content:parseFloat(t)||0,isNotEmpty:!0}};else if(["text","block","url","phone","email","template"].includes(e))n={type:e,[e]:{content:t}};else if(e==="mSelect"||e==="select")n={type:e,mSelect:[{content:t,color:"1"}]};else if(e==="checkbox")n={type:e,checkbox:{checked:!0}};else if(e==="date"){let a=t.split("\u2192");a.length!==2&&(a=t.split("-"),a.length!==2&&(a=t.split("~")));const i=dayjs(a[0]),s=dayjs(a[1]||"");isNaN(i.valueOf())?n={type:e,date:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,formattedContent:"",hasEndDate:!1,isNotTime:!0}}:n={type:e,date:{content:i.valueOf(),isNotEmpty:!0,content2:s.valueOf()||0,isNotEmpty2:!isNaN(s.valueOf()),hasEndDate:!isNaN(s.valueOf()),isNotTime:i.hour()===0,formattedContent:""}}}else if(e==="relation")n={type:e,relation:{blockIDs:[t],contents:[]}};else if(e==="mAsset"){const a=pathPosix().extname(t).toLowerCase();n={type:e,mAsset:[{type:Constants.SIYUAN_ASSETS_IMAGE.includes(a)?"image":"file",content:t,name:""}]}}}else(typeof t=="undefined"||!t)&&(e==="number"?n={type:e,number:{content:null,isNotEmpty:!1}}:["text","block","url","phone","email","template"].includes(e)?n={type:e,[e]:{content:""}}:e==="mSelect"||e==="select"||e==="mAsset"?n={type:e,[e==="select"?"mSelect":e]:[]}:["date","created","updated"].includes(e)?n={type:e,[e]:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1,isNotTime:!0}}:e==="checkbox"?n={type:e,checkbox:{checked:!1}}:e==="relation"?n={type:e,relation:{blockIDs:[],contents:[]}}:e==="rollup"&&(n={type:e,rollup:{contents:[]}}));return e==="block"&&(n.isDetached=!0),n},Wo=(e,t,n=!0)=>{const a=t.getBoundingClientRect();if(!n){const s=e.querySelector(".av__scroll");if(s){const o=s.getBoundingClientRect();if(o.right<a.right)s.scrollLeft=s.scrollLeft+a.right-o.right;else{const l=hasClosestByClassName(t,"av__row");if(l){const r=l.querySelector(".av__colsticky");if(r){if(!r.contains(t)){const d=r.getBoundingClientRect().right;d>a.left&&(s.scrollLeft=s.scrollLeft+a.left-d)}}else o.left>a.left&&(s.scrollLeft=s.scrollLeft+a.left-o.left)}}}}const i=hasClosestByClassName(e,"protyle-content",!0);if(i&&t.getAttribute("data-dtype")!=="checkbox"){const s=document.getElementById("keyboardToolbar"),o=parseInt(s.getAttribute("data-keyboardheight"))||window.outerHeight/2-42;console.log(o,window.innerHeight,a.bottom),a.bottom>window.innerHeight-o-42?i.scrollTop+=a.bottom-window.innerHeight+42+o:a.top<110&&(i.scrollTop-=110-a.top)}},aa=e=>{const t=hasClosestByClassName(e,"av__scroll");if(t)return t.querySelector(".av__row--header").querySelector(`[data-col-id="${e.getAttribute("data-col-id")}"]`).getAttribute("data-dtype")},Bu=(e,t,n)=>{if(t.length===0||t.length===1&&!t[0]||(n||(n=aa(t[0])),n==="updated"||n==="created"||document.querySelector(".av__mask"))||n==="block"&&(t.length>1||!t[0].getAttribute("data-detached")))return;const a=hasClosestBlock(t[0]);if(!a)return;let i=t[0].getBoundingClientRect();const s=hasClosestByClassName(a,"protyle-content",!0);Wo(a,t[0],!1),i=t[0].getBoundingClientRect();let o="",l=i.height;if(s){const f=s.getBoundingClientRect();i.bottom>f.bottom&&(l=f.bottom-i.top)}const r=`style="padding-top: 6.5px;position:absolute;left: ${i.left}px;top: ${i.top}px;width:${Math.max(i.width,25)}px;height: ${l}px"`;if(["text","email","phone","block","template"].includes(n))o=`<textarea ${r} spellcheck="false" class="b3-text-field">${t[0].firstElementChild.textContent}</textarea>`;else if(n==="url")o=`<textarea ${r} spellcheck="false" class="b3-text-field">${t[0].firstElementChild.getAttribute("data-href")}</textarea>`;else if(n==="number")o=`<input type="number" spellcheck="false" value="${t[0].firstElementChild.getAttribute("data-content")}" ${r} class="b3-text-field">`;else{["select","mSelect"].includes(n)?openMenuPanel({protyle:e,blockElement:a,type:"select",cellElements:t}):n==="mAsset"?(openMenuPanel({protyle:e,blockElement:a,type:"asset",cellElements:t}),focusBlock(a)):n==="date"?openMenuPanel({protyle:e,blockElement:a,type:"date",cellElements:t}):n==="checkbox"?sa(e,n,a,t):n==="relation"?openMenuPanel({protyle:e,blockElement:a,type:"relation",cellElements:t}):n==="rollup"&&openMenuPanel({protyle:e,blockElement:a,type:"rollup",cellElements:t,colId:t[0].dataset.colId}),hasClosestByClassName(t[0],"custom-attr")||(t[0].classList.add("av__cell--select"),gn(t[0]));return}window.siyuan.menus.menu.remove(),document.body.insertAdjacentHTML("beforeend",`<div class="av__mask" style="z-index: ${++window.siyuan.zIndex}">
    ${o}
</div>`);const d=document.querySelector(".av__mask"),c=d.querySelector(".b3-text-field");c&&(c.select(),c.focus(),n==="template"&&fetchPost("/api/av/renderAttributeView",{id:a.dataset.avId,viewID:a.getAttribute(Constants.CUSTOM_SY_AV_VIEW)},f=>{f.data.view.columns.find(g=>{if(g.id===t[0].dataset.colId)return c.value=g.template,c.dataset.template=g.template,!0})}),n==="block"&&c.addEventListener("input",f=>{if(Constants.BLOCK_HINT_KEYS.includes(c.value.substring(0,2))){if(e.toolbar.range=document.createRange(),!a.contains(t[0])){const p=hasClosestByClassName(t[0],"av__row");t[0]&&(t[0]=a.querySelector(`.av__row[data-id="${p.dataset.id}"] .av__cell[data-col-id="${t[0].dataset.colId}"]`))}e.toolbar.range.selectNodeContents(t[0].lastChild),focusByRange(e.toolbar.range),t[0].classList.add("av__cell--select"),gn(t[0]);let g=c.value;isDynamicRef(g)?g=g.substring(2,22+2):g=g.substring(2),hintRef(g,e,"av"),d==null||d.remove(),f.preventDefault(),f.stopPropagation()}}),c.addEventListener("keydown",f=>{f.isComposing||electronUndo(f)||(f.key==="Escape"||f.key==="Tab"||f.key==="Enter"&&!f.shiftKey&&isNotCtrl(f))&&(sa(e,n,a,t),f.key==="Tab"&&e.wysiwyg.element.dispatchEvent(new KeyboardEvent("keydown",{shiftKey:f.shiftKey,ctrlKey:f.ctrlKey,altKey:f.altKey,metaKey:f.metaKey,key:"Tab",keyCode:9})),f.preventDefault(),f.stopPropagation())}));const u=f=>{f.target.classList.contains("av__mask")&&document.activeElement.tagName!=="TEXTAREA"&&document.activeElement.tagName!=="INPUT"&&(sa(e,n,a,t),d==null||d.remove())};d.addEventListener("click",f=>{u(f)}),d.addEventListener("contextmenu",f=>{u(f)}),d.addEventListener("mousedown",f=>{f.button===1&&(f.target.classList.contains("av__mask")&&document.activeElement&&document.activeElement.nodeType===1&&document.activeElement.blur(),u(f))})},sa=(e,t,n,a)=>{const i=hasClosestByClassName(a[0],"av__row");if(!i||a.length===1&&a[0].dataset.detached==="true"&&!i.dataset.id)return;const s=document.querySelector(".av__mask"),o=n.getAttribute("data-av-id");if(t==="template"){const l=a[0].getAttribute("data-col-id"),r=s.querySelector(".b3-text-field");r.value!==r.dataset.template&&!n.getAttribute("data-loading")&&(transaction(e,[{action:"updateAttrViewColTemplate",id:l,avID:o,data:r.value,type:"template"}],[{action:"updateAttrViewColTemplate",id:l,avID:o,data:r.dataset.template,type:"template"}]),n.setAttribute("data-loading","true"))}else jo(e,n,t==="checkbox"?{checked:a[0].querySelector("use").getAttribute("xlink:href")==="#iconUncheck"}:s.querySelector(".b3-text-field").value,a);a[0]&&!hasClosestByClassName(a[0],"custom-attr")&&(a[0].classList.add("av__cell--select"),gn(a[0])),document.querySelector(".b3-dialog")||focusBlock(n),document.querySelectorAll(".av__mask").forEach(l=>{l.remove()})},jo=(e,t,n,a,i,s)=>{const o=[],l=[],r=t.dataset.avId,d=t.dataset.nodeId;let c="";const u=[];let f;(a==null?void 0:a.length)>0?f=a:(f=Array.from(t.querySelectorAll(".av__cell--active, .av__cell--select")),f.length===0&&t.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(p=>{p.querySelectorAll(".av__cell").forEach(m=>{f.push(m)})}));const g=hasClosestByClassName(f[0],"custom-attr");return f.forEach((p,m)=>{const y=hasClosestByClassName(p,"av__row");if(!y||(t.contains(p)||(p=f[m]=t.querySelector(`.av__row[data-id="${y.dataset.id}"] .av__cell[data-col-id="${p.dataset.colId}"]`)||t.querySelector(`.fn__flex-1[data-col-id="${p.dataset.colId}"]`)),!p))return;const v=aa(p)||p.dataset.type;if(["created","updated","template","rollup"].includes(v))return;const b=y.getAttribute("data-id"),w=p.dataset.id,h=p.dataset.colId;c+=Yo(p)+(f[m+1]&&p.nextElementSibling&&p.nextElementSibling.isSameNode(f[m+1])?"	":`

`);const C=_s(v,p);if((m===0||!f[m-1].isSameNode(p.previousElementSibling))&&u.push([]),u[u.length-1].push(C),v==="mAsset"){if(Array.isArray(n))n=C.mAsset.concat(n);else if(typeof n!="undefined"){let E=e.lute.GetLinkDest(n),_="",L="";if(s){const A=document.createElement("template");A.innerHTML=s;const S=A.content.querySelector('[data-type~="a"]');if(S)E=S.getAttribute("data-href"),_=S.textContent;else{const I=A.content.querySelector(".img img");I&&(L=I.getAttribute("data-src"))}}if(E||(_=n),!E&&!_&&!L)return;L?n=C.mAsset.concat({type:"image",content:L,name:""}):n=C.mAsset.concat({type:"file",content:E,name:_})}}else v==="mSelect"&&typeof n=="string"&&(n=C.mSelect.concat({content:n,color:(C.mSelect.length+1).toString()}));const k=Uo(v,n);if(k.id=w,!(k.type==="date"&&typeof k.date=="string"||k.type==="relation"&&typeof k.relation=="string")){if(i&&(v==="select"||v==="mSelect")){const E=mergeAddOption(i.find(_=>_.id===h),k,r);o.push(...E.doOperations),l.push(...E.undoOperations)}if(!objEquals(k,C)){if(v==="block"&&!p.dataset.detached){const E=Lute.NewNodeID();o.push({action:"unbindAttrViewBlock",id:b,nextID:E,avID:r}),y.dataset.id=E,p.dataset.blockId=E}else o.push({action:"updateAttrViewCell",id:w,avID:r,keyID:h,rowID:b,data:k});l.push({action:"updateAttrViewCell",id:w,avID:r,keyID:h,rowID:b,data:C}),g?p.innerHTML=genAVValueHTML(k):updateAttrViewCellAnimation(p,k)}}}),o.length>0&&(o.push({action:"doUpdateUpdated",id:d,data:dayjs().format("YYYYMMDDHHmmss")}),l.push({action:"doUpdateUpdated",id:d,data:t.getAttribute("updated")}),transaction(e,o,l)),{text:c.substring(0,c.length-2),json:u}},Vo=(e,t)=>{t.type==="checkbox"?t.checkbox.checked?(e.classList.add("av__cell-check"),e.classList.remove("av__cell-uncheck")):(e.classList.remove("av__cell-check"),e.classList.add("av__cell-uncheck")):t.type==="block"&&(t.block.id&&e.setAttribute("data-block-id",t.block.id),t.isDetached?e.setAttribute("data-detached","true"):e.removeAttribute("data-detached"))},ia=(e,t=0)=>{var n,a,i,s,o,l,r,d,c,u;let f="";if(e.type==="template")f=`<span class="av__celltext">${e&&e.template.content||""}</span>`;else if(e.type==="text")f=`<span class="av__celltext">${e?Lute.EscapeHTMLStr(e.text.content||""):""}</span>`;else if(["email","phone"].includes(e.type))f=`<span class="av__celltext av__celltext--url" data-type="${e.type}">${e?Lute.EscapeHTMLStr(e[e.type].content||""):""}</span>`;else if(e.type==="url")f=ws(((n=e==null?void 0:e.url)==null?void 0:n.content)||"");else if(e.type==="block")e!=null&&e.isDetached?f=`<span class="av__celltext">${e.block.content||""}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.more}</span>`:f=`<span data-type="block-ref" data-id="${e.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${e.block.content||window.siyuan.languages.untitled}</span><span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.update}</span>`;else if(e.type==="number")f=`<span class="av__celltext" data-content="${e!=null&&e.number.isNotEmpty?e==null?void 0:e.number.content:""}">${(e==null?void 0:e.number.formattedContent)||(e==null?void 0:e.number.content)||""}</span>`;else if(e.type==="mSelect"||e.type==="select")(a=e==null?void 0:e.mSelect)==null||a.forEach(g=>{f+=`<span class="b3-chip" style="background-color:var(--b3-font-background${g.color});color:var(--b3-font-color${g.color})">${g.content}</span>`});else if(e.type==="date"){const g=e?e.date:null;f=`<span class="av__celltext" data-value='${JSON.stringify(g)}'>`,g&&g.isNotEmpty&&(f+=je(g.content).format(g.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),g&&g.hasEndDate&&g.isNotEmpty&&g.isNotEmpty2&&(f+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${je(g.content2).format(g.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),f+="</span>"}else if(["created","updated"].includes(e.type)){const g=e?e[e.type]:null;f=`<span class="av__celltext" data-value='${JSON.stringify(g)}'>`,g&&g.isNotEmpty&&(f+=je(g.content).format("YYYY-MM-DD HH:mm")),f+="</span>"}else["lineNumber"].includes(e.type)?f=`<span class="av__celltext" data-value='${t+1}'>${t+1}</span>`:e.type==="mAsset"?(i=e==null?void 0:e.mAsset)==null||i.forEach(g=>{g.type==="image"?f+=`<img class="av__cellassetimg ariaLabel" aria-label="${g.content}" src="${g.content}">`:f+=`<span class="b3-chip av__celltext--url ariaLabel" aria-label="${fn(g.content)}" data-name="${fn(g.name)}" data-url="${fn(g.content)}">${g.name||g.content}</span>`}):e.type==="checkbox"?f+=`<svg class="av__checkbox"><use xlink:href="#icon${(s=e==null?void 0:e.checkbox)!=null&&s.checked?"Check":"Uncheck"}"></use></svg>`:e.type==="rollup"?((l=(o=e==null?void 0:e.rollup)==null?void 0:o.contents)==null||l.forEach(g=>{const p=["select","mSelect","mAsset","checkbox","relation"].includes(g.type)?ia(g):vs(g);p&&(f+=p+", ")}),f&&f.endsWith(", ")&&(f=f.substring(0,f.length-2))):e.type==="relation"&&((d=(r=e==null?void 0:e.relation)==null?void 0:r.contents)==null||d.forEach(g=>{g&&g.block&&(f+=vs(g)+", ")}),f&&f.endsWith(", ")&&(f=f.substring(0,f.length-2)));return(["text","template","url","email","phone","number","date","created","updated"].includes(e.type)&&((c=e[e.type])!=null&&c.content)||e.type==="lineNumber"||e.type==="block"&&((u=e.block)!=null&&u.content))&&(f+=`<span ${e.type!=="number"?"":'style="right:auto;left:5px"'} data-type="copy" class="block__icon"><svg><use xlink:href="#iconCopy"></use></svg></span>`),f},vs=e=>{var t,n,a,i,s;let o="";if(["text"].includes(e.type))o=e&&e[e.type].content||"";else if(["email","phone"].includes(e.type)){const l=e?e[e.type].content:"";l&&(o=`<span class="av__celltext av__celltext--url" data-type="${e.type}">${l}</span>`)}else if(e.type==="url"){const l=((t=e==null?void 0:e.url)==null?void 0:t.content)||"";l&&(o=ws(l))}else if(e.type==="block")e!=null&&e.isDetached?o=`<span class="av__celltext" data-id="${(n=e.block)==null?void 0:n.id}">${((a=e.block)==null?void 0:a.content)||window.siyuan.languages.untitled}</span>`:o=`<span data-type="block-ref" data-id="${(i=e.block)==null?void 0:i.id}" data-subtype="s" class="av__celltext av__celltext--ref">${((s=e.block)==null?void 0:s.content)||window.siyuan.languages.untitled}</span>`;else if(e.type==="number")o=(e==null?void 0:e.number.formattedContent)||(e==null?void 0:e.number.content.toString())||"";else if(e.type==="date"){const l=e?e.date:null;l.formattedContent?o=l.formattedContent:(l&&l.isNotEmpty&&(o=je(l.content).format(l.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),l&&l.hasEndDate&&l.isNotEmpty&&l.isNotEmpty2&&(o=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${je(l.content2).format(l.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`)),o&&(o=`<span class="av__celltext">${o}</span>`)}return o},Pu=(e,t)=>{var n;if(typeof t.icon!="undefined"&&(e.dataset.icon=t.icon,e.querySelector(".av__cellheadericon").outerHTML=t.icon?unicode2Emoji(t.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${getColIconByType(e.dataset.dtype)}"></use></svg>`),typeof t.name!="undefined"&&(e.querySelector(".av__celltext").textContent=t.name),typeof t.pin!="undefined"){const a=e.querySelector(".av__celltext");t.pin?e.querySelector(".av__cellheadericon--pin")||a.insertAdjacentHTML("afterend",'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>'):(n=e.querySelector(".av__cellheadericon--pin"))==null||n.remove()}},Ru=e=>{let t=hasClosestByClassName(e,"av__row");if(!t)return;let n=-1;for(;t;)t=t.previousElementSibling,n++;let a=-2;for(;e;)e=e.previousElementSibling,e&&e.classList.contains("av__colsticky")&&(e=e.lastElementChild),a++;return{rowIndex:n,celIndex:a}},Ou=(e,t,n,a)=>{var i;(i=t.querySelector(".av__drag-fill"))==null||i.remove();const s={};t.querySelectorAll(".av__cell--active").forEach(c=>{if(a.includes(c.dataset.id))return;const u=hasClosestByClassName(c,"av__row");if(!u)return;s[u.dataset.id]||(s[u.dataset.id]=[]);const f=_s(aa(c),c);f.colId=c.dataset.colId,f.element=c,s[u.dataset.id].push(f)});const o=[],l=[],r=t.dataset.avId,d=Object.keys(n);Object.keys(s).forEach((c,u)=>{s[c].forEach((f,g)=>{if(["rollup","template","created","updated"].includes(f.type)||f.type==="block"&&f.element.getAttribute("data-detached")!=="true")return;const p=JSON.parse(JSON.stringify(n[d[u%d.length]][g]));p.id=f.id;const m=f.colId;p.type==="block"&&(p.isDetached=!0,delete p.block.id),o.push({action:"updateAttrViewCell",id:f.id,avID:r,keyID:m,rowID:c,data:p}),f.element.innerHTML=ia(p),Vo(f.element,p),delete f.colId,delete f.element,l.push({action:"updateAttrViewCell",id:f.id,avID:r,keyID:m,rowID:c,data:f})})}),focusBlock(t),o.length>0&&transaction(e,o,l)},gn=e=>{e&&(e.classList.add("av__cell--active"),e.querySelector(".av__drag-fill")||e.insertAdjacentHTML("beforeend",`<div aria-label="${window.siyuan.languages.dragFill}" class="av__drag-fill ariaLabel"></div>`))};var Go=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const zo=e=>{if(["select","number","date","created","updated"].includes(e))return"=";if(["checkbox"].includes(e))return"Is false";if(["rollup","relation","rollup","text","mSelect","url","block","email","phone","template"].includes(e))return"Contains"},Es=(e,t,n)=>{const a=hasClosestByClassName(e,"b3-menu");if(a){if(["date","updated","created"].includes(n)){const i=a.querySelector('.b3-menu__item div[data-type="filter1"]'),s=i.nextElementSibling;t==="Is between"?(s.classList.remove("fn__none"),i.classList.remove("fn__none")):t==="Is empty"||t==="Is not empty"?(s.classList.add("fn__none"),i.classList.add("fn__none")):(i.classList.remove("fn__none"),s.classList.add("fn__none"));return}a.querySelectorAll("input, .b3-chip").forEach(i=>{const s=hasClosestByClassName(i,"b3-menu__item");s&&(t!=="Is empty"&&t!=="Is not empty"?s.classList.remove("fn__none"):s.classList.add("fn__none"))})}},ks=e=>{window.siyuan.menus.menu.element.querySelectorAll(".b3-menu__item").forEach(t=>{const n=t.querySelector(".b3-chip.b3-chip--middle");if(n){const a=n.dataset.name.toLowerCase();!e||e.indexOf(a)>-1||a.indexOf(e)>-1?t.classList.remove("fn__none"):t.classList.add("fn__none")}})},Ko=e=>Go(void 0,null,function*(){var t,n,a,i,s,o,l,r,d,c,u,f,g,p,m,y,v,b;let w=e.target.getBoundingClientRect();w.height===0&&(w=e.protyle.wysiwyg.element.querySelector(`[data-col-id="${e.target.dataset.colId}"]`).getBoundingClientRect());const h=e.blockElement.getAttribute("data-node-id"),C=new Menu("set-filter-"+e.filter.column,()=>{const T=JSON.parse(JSON.stringify(e.data.view.filters)),D=C.element.querySelector(".b3-select");if(!D||!D.value)return;const M={column:e.filter.column,value:{type:e.filter.value.type},operator:D.value};let $=!1,q;if(_.type==="select"||_.type==="mSelect"){const G=[];window.siyuan.menus.menu.element.querySelectorAll("svg").forEach(ne=>{if(ne.firstElementChild.getAttribute("xlink:href")==="#iconCheck"){const ie=ne.nextElementSibling.firstElementChild;G.push({color:ie.dataset.color,content:ie.dataset.name})}}),q=genCellValue(_.type,G)}else if(["date","updated","created"].includes(_.type)){const G=C.element.querySelector('.b3-select[data-type="dateType"]'),ne=C.element.querySelectorAll('.b3-select[data-type="dataDirection"]');G.value==="custom"?(M.relativeDate={count:parseInt(ne[0].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt(ne[0].parentElement.lastElementChild.value),direction:parseInt(ne[0].value)},M.relativeDate2={count:parseInt(ne[1].parentElement.querySelector(".b3-text-field").value||"1"),unit:parseInt(ne[1].parentElement.lastElementChild.value),direction:parseInt(ne[1].value)},q={type:_.type}):(q=genCellValue(_.type,{isNotEmpty2:I[2].value!=="",isNotEmpty:I[0].value!=="",content:I[0].value?new Date(I[0].value+" 00:00").getTime():null,content2:I[2].value?new Date(I[2].value+" 00:00").getTime():null,hasEndDate:M.operator==="Is between",isNotTime:!0}),M.relativeDate=null,M.relativeDate2=null)}else["text","url","block","email","phone","template","relation","number"].includes(_.type)?q=genCellValue(_.type,I[0].value):_.type==="checkbox"?q=genCellValue(_.type,{checked:M.operator==="Is true"}):q=genCellValue(_.type,void 0);e.filter.value.type==="rollup"?M.value={rollup:{contents:[q]},type:"rollup"}:M.value=q;let j=!1;if(e.data.view.filters.find((G,ne)=>{if(G.column===e.filter.column&&G.value.type===e.filter.value.type)return G.value.type==="checkbox"?($=!0,e.data.view.filters[ne]=M,!0):objEquals(G,M)?(j=!0,!0):(e.data.view.filters[ne]=M,$=!0,!0)}),j||!$)return;transaction(e.protyle,[{action:"setAttrViewFilters",avID:e.data.id,data:e.data.view.filters,blockID:h}],[{action:"setAttrViewFilters",avID:e.data.id,data:T,blockID:h}]);const P=hasClosestByClassName(e.target,"b3-menu");P&&(P.innerHTML=oa(e.data.view))});if(C.isOpen)return;let k="",E;e.data.view.columns.find(T=>{if(T.id===e.filter.column)return E=T,!0});let _=JSON.parse(JSON.stringify(e.filter.value));if(E.type==="rollup"){if(!E.rollup||!E.rollup.relationKeyID||!E.rollup.keyID){showMessage(window.siyuan.languages.plsChoose),openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:E.id});return}let T="";e.data.view.columns.find(M=>{if(M.id===E.rollup.relationKeyID)return T=M.relation.avID,!0}),(yield fetchSyncPost("/api/av/getAttributeView",{id:T})).data.av.keyValues.find(M=>{if(M.key.id===E.rollup.keyID)return _.type=M.key.type,!0}),e.data.view.filters.find(M=>{if(M.column===E.id&&M.value.type==="rollup")return!M.value.rollup||!M.value.rollup.contents||M.value.rollup.contents.length===0?_={[_.type]:genCellValue(_.type,_.type==="checkbox"?{checked:void 0}:""),type:_.type}:_=M.value.rollup.contents[0],!0})}let L=!1;switch(_.type==="checkbox"&&(L=typeof _.checkbox=="undefined"||typeof _.checkbox.checked=="undefined"),_.type){case"checkbox":k=`<option ${e.filter.operator==="Is true"&&!L?"selected":""} value="Is true">${window.siyuan.languages.checked}</option>
<option ${e.filter.operator==="Is false"&&!L?"selected":""} value="Is false">${window.siyuan.languages.unchecked}</option>`,L&&(k=`<option selected></option>${k}`);break;case"block":case"text":case"url":case"phone":case"email":k=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${e.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"template":k=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${e.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>
<option ${e.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">&le;</option>`;break;case"date":case"created":case"updated":k=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator===">"?"selected":""} value=">">${window.siyuan.languages.filterOperatorIsAfter}</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">${window.siyuan.languages.filterOperatorIsBefore}</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">${window.siyuan.languages.filterOperatorIsOnOrAfter}</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">${window.siyuan.languages.filterOperatorIsOnOrBefore}</option>
<option ${e.filter.operator==="Is between"?"selected":""} value="Is between">${window.siyuan.languages.filterOperatorIsBetween}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"number":k=`<option ${e.filter.operator==="="?"selected":""} value="=">=</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">!=</option>
<option ${e.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${e.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${e.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${e.filter.operator==="<="?"selected":""} value="<=">&le;</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"mSelect":case"relation":k=`<option ${e.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${e.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"select":k=`<option ${e.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${e.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${e.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${e.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break}if(C.addItem({iconHTML:"",type:"readonly",label:`<select style="margin: 4px 0" class="b3-select fn__size200">${k}</select>`}),_.type==="select"||_.type==="mSelect")((t=E.options)==null?void 0:t.length)>0&&C.addItem({iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__block" style="margin: 4px 0" placeholder="${window.siyuan.languages.search}">`,bind(T){const D=T.querySelector("input");D.addEventListener("keydown",M=>{if(M.isComposing)return;let $=upDownHint(C.element.querySelector(".b3-menu__items"),M,"b3-menu__item--current",T.nextElementSibling);M.key==="Enter"&&($||($=C.element.querySelector(".b3-menu__item--current")),$.dispatchEvent(new CustomEvent("click")))}),D.addEventListener("input",M=>{M.isComposing||ks(D.value.toLowerCase())}),D.addEventListener("compositionend",()=>{ks(D.value.toLowerCase())})}}),(n=E.options)==null||n.forEach(T=>{var D;let M="iconUncheck";(D=_==null?void 0:_.mSelect)==null||D.find($=>{$.content===T.name&&(M="iconCheck")}),C.addItem({icon:M,label:`<span class="b3-chip b3-chip--middle" data-name="${T.name}" data-color="${T.color}" style="margin:3px 0;background-color:var(--b3-font-background${T.color});color:var(--b3-font-color${T.color})">
    <span class="fn__ellipsis">${T.name}</span>
</span>`,bind($){$.addEventListener("click",()=>{const q=$.querySelector("use");q.getAttribute("xlink:href")==="#iconUncheck"?q.setAttribute("xlink:href","#iconCheck"):q.setAttribute("xlink:href","#iconUncheck")})}})});else if(["text","url","block","email","phone","template","relation"].includes(_.type)){let T="";_&&(_.type==="relation"?T=_.relation.blockIDs[0]||"":T=_[_.type].content||""),C.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${T}" class="b3-text-field fn__size200">`})}else if(_.type==="number")C.addItem({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" value="${_!=null&&_.number.isNotEmpty?_.number.content:""}" class="b3-text-field fn__size200">`});else if(["date","updated","created"].includes(_.type)){const T=_?_[_.type]:null,D=!((a=e.filter.relativeDate)!=null&&a.direction),M=!((i=e.filter.relativeDate2)!=null&&i.direction);C.addItem({iconHTML:"",type:"readonly",label:`<div data-type="filter1">
    <div class="fn__size200">
        <select class="b3-select fn__block" data-type="dateType">
            <option value="time"${e.filter.relativeDate?"":" selected"}>${window.siyuan.languages.includeTime}</option>
            <option value="custom"${e.filter.relativeDate?" selected":""}>${window.siyuan.languages.relativeToToday}</option>
        </select>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__size200 ${e.filter.relativeDate?"fn__none":""}">
        <input value="${T&&(T.isNotEmpty||_.type!=="date")?dayjs(T.content).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${e.filter.relativeDate?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${((s=e.filter.relativeDate)==null?void 0:s.direction)===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${((o=e.filter.relativeDate)==null?void 0:o.direction)===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${D?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" step="1" value="${((l=e.filter.relativeDate)==null?void 0:l.count)||1}" class="b3-text-field fn__flex-1${D?" fn__none":""}"/>
        <span class="fn__space${D?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${((r=e.filter.relativeDate)==null?void 0:r.unit)===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!e.filter.relativeDate||((d=e.filter.relativeDate)==null?void 0:d.unit)===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${((c=e.filter.relativeDate)==null?void 0:c.unit)===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${((u=e.filter.relativeDate)==null?void 0:u.unit)===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>
<div data-type="filter2 fn__none">
    <div class="fn__hr--small"></div>
    <div class="fn__size200 ${e.filter.relativeDate2?"fn__none":""}">
        <input value="${T&&T.isNotEmpty2?dayjs(T.content2).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__block">
    </div>
    <div class="fn__flex fn__size200 ${e.filter.relativeDate2?"":"fn__none"}">
        <select class="b3-select" data-type="dataDirection">
            <option value="-1"${((f=e.filter.relativeDate2)==null?void 0:f.direction)===-1?" selected":""}>${window.siyuan.languages.pastDate}</option>
            <option value="1"${((g=e.filter.relativeDate2)==null?void 0:g.direction)===1?" selected":""}>${window.siyuan.languages.nextDate}</option>
            <option value="0"${M?" selected":""}>${window.siyuan.languages.current}</option>
        </select>
        <span class="fn__space"></span>
        <input type="number" min="1" step="1" value="${((p=e.filter.relativeDate2)==null?void 0:p.count)||1}" class="b3-text-field fn__flex-1${M?" fn__none":""}"/>
        <span class="fn__space${M?" fn__none":""}"></span>
        <select class="b3-select fn__flex-1">
            <option value="0"${((m=e.filter.relativeDate2)==null?void 0:m.unit)===0?" selected":""}>${window.siyuan.languages.day}</option>
            <option value="1"${!e.filter.relativeDate2||((y=e.filter.relativeDate2)==null?void 0:y.unit)===1?" selected":""}>${window.siyuan.languages.week}</option>
            <option value="2"${((v=e.filter.relativeDate2)==null?void 0:v.unit)===2?" selected":""}>${window.siyuan.languages.month}</option>
            <option value="3"${((b=e.filter.relativeDate2)==null?void 0:b.unit)===3?" selected":""}>${window.siyuan.languages.year}</option>
        </select>
    </div>
    <div class="fn__hr--small"></div>
</div>`})}C.addItem({icon:"iconTrashcan",label:window.siyuan.languages.removeFilters,click(){const T=Object.assign([],e.data.view.filters);e.data.view.filters.find((M,$)=>{if(M.column===e.filter.column&&e.filter.value.type===M.value.type)return e.data.view.filters.splice($,1),!0}),transaction(e.protyle,[{action:"setAttrViewFilters",avID:e.data.id,data:e.data.view.filters,blockID:h}],[{action:"setAttrViewFilters",avID:e.data.id,data:T,blockID:h}]);const D=hasClosestByClassName(e.target,"b3-menu");D&&(D.innerHTML=oa(e.data.view))}});const A=C.element.querySelector(".b3-select");A.addEventListener("change",()=>{Es(A,A.value,_.type)});const S=C.element.querySelector('.b3-select[data-type="dateType"]');S==null||S.addEventListener("change",()=>{const T=C.element.querySelectorAll('[data-type="dataDirection"]'),D=T[0].parentElement,M=T[1].parentElement,$=D.previousElementSibling,q=M.previousElementSibling;S.value==="custom"?(D.classList.remove("fn__none"),M.classList.remove("fn__none"),$.classList.add("fn__none"),q.classList.add("fn__none")):(D.classList.add("fn__none"),M.classList.add("fn__none"),$.classList.remove("fn__none"),q.classList.remove("fn__none"))}),C.element.querySelectorAll('.b3-select[data-type="dataDirection"]').forEach(T=>{T.addEventListener("change",()=>{const D=T.nextElementSibling.nextElementSibling;T.value==="0"?(D.classList.add("fn__none"),D.nextElementSibling.classList.add("fn__none")):(D.classList.remove("fn__none"),D.nextElementSibling.classList.remove("fn__none"))})});const I=C.element.querySelectorAll(".b3-text-field");_.type!=="select"&&_.type!=="mSelect"&&I.forEach(T=>{T.addEventListener("keydown",D=>{if(D.isComposing){D.preventDefault();return}D.key==="Enter"&&(C.close(),D.preventDefault())})}),Es(A,A.value,_.type),C.open({x:w.left,y:w.bottom}),I.length>0&&I[0].select()}),qu=e=>{const t=new Menu("av-add-filter");e.data.view.columns.forEach(n=>{let a;e.data.view.filters.find(i=>{if(i.column===n.id&&i.value.type===n.type)return a=i,!0}),!a&&n.type!=="mAsset"&&n.type!=="lineNumber"&&t.addItem({label:n.name,iconHTML:n.icon?unicode2Emoji(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${getColIconByType(n.type)}"></use></svg>`,click:()=>{const i=genCellValue(n.type,n.type==="checkbox"?{checked:void 0}:"");a={column:n.id,operator:zo(n.type),value:i},e.data.view.filters.push(a),e.menuElement.innerHTML=oa(e.data.view),setPosition(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height);const s=e.menuElement.querySelector(`[data-id="${n.id}"] .b3-chip`);Ko({filter:a,protyle:e.protyle,data:e.data,target:s,blockElement:e.blockElement})}})}),t.open({x:e.rect.left,y:e.rect.bottom,h:e.rect.height})},oa=e=>{let t="";const n=a=>{let i="";return e.columns.find(s=>{var o,l,r,d,c;if(s.id===a.column&&s.type===a.value.type){let u="";const f=s.type==="rollup"?((l=(o=a.value.rollup)==null?void 0:o.contents)==null?void 0:l.length)>0?a.value.rollup.contents[0]:{type:"rollup"}:a.value;if(a.operator==="Is empty")u=": "+window.siyuan.languages.filterOperatorIsEmpty;else if(a.operator==="Is not empty")u=": "+window.siyuan.languages.filterOperatorIsNotEmpty;else if(a.operator==="Is false")(f.type!=="checkbox"||typeof f.checkbox.checked=="boolean")&&(u=": "+window.siyuan.languages.unchecked);else if(a.operator==="Is true")(f.type!=="checkbox"||typeof f.checkbox.checked=="boolean")&&(u=": "+window.siyuan.languages.checked);else if(["created","updated","date"].includes(f.type)){let g="",p="";a.relativeDate?(g=`${window.siyuan.languages[["pastDate","current","nextDate"][a.relativeDate.direction+1]]}
 ${a.relativeDate.direction?a.relativeDate.count:""}
 ${window.siyuan.languages[["day","week","month","year"][a.relativeDate.unit]]}`,a.relativeDate2&&(p=`${window.siyuan.languages[["pastDate","current","nextDate"][a.relativeDate2.direction+1]]}
 ${a.relativeDate2.direction?a.relativeDate2.count:""}
 ${window.siyuan.languages[["day","week","month","year"][a.relativeDate2.unit]]}`)):f&&((r=f[f.type])!=null&&r.content)&&(g=dayjs(f[f.type].content).format("YYYY-MM-DD"),p=dayjs(f[f.type].content2).format("YYYY-MM-DD")),g&&(a.operator==="Is between"?u=` ${window.siyuan.languages.filterOperatorIsBetween} ${g} ${p}`:a.operator==="="?u=`: ${g}`:[">","<"].includes(a.operator)?u=` ${a.operator} ${g}`:a.operator===">="?u=` \u2265 ${g}`:a.operator==="<="&&(u=` \u2264 ${g}`))}else if(["mSelect","select"].includes(f.type)&&((d=f.mSelect)==null?void 0:d.length)>0){let g="";f.mSelect.forEach((p,m)=>{g+=p.content,m!==f.mSelect.length-1&&(g+=", ")}),a.operator==="Contains"?u=`: ${g}`:a.operator==="Does not contains"?u=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${g}`:a.operator==="="?u=`: ${g}`:a.operator==="!="&&(u=` ${window.siyuan.languages.filterOperatorIsNot} ${g}`)}else if(f.type==="number"&&f.number&&f.number.isNotEmpty)["=","!=",">","<"].includes(a.operator)?u=` ${a.operator} ${f.number.content}`:a.operator===">="?u=` \u2265 ${f.number.content}`:a.operator==="<="&&(u=` \u2264 ${f.number.content}`);else if(["text","block","url","phone","email","relation","template"].includes(f.type)&&f[f.type]){const g=f[f.type].content||((c=f.relation)==null?void 0:c.blockIDs[0])||"";["=","Contains"].includes(a.operator)?u=`: ${g}`:a.operator==="Does not contains"?u=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${g}`:a.operator==="!="?u=` ${window.siyuan.languages.filterOperatorIsNot} ${g}`:a.operator==="Starts with"?u=` ${window.siyuan.languages.filterOperatorStartsWith} ${g}`:a.operator==="Ends with"?u=` ${window.siyuan.languages.filterOperatorEndsWith} ${g}`:[">","<"].includes(a.operator)?u=` ${a.operator} ${g}`:a.operator===">="?u=` \u2265 ${g}`:a.operator==="<="&&(u=` \u2264 ${g}`)}return i+=`<span data-type="setFilter" class="b3-chip${u?" b3-chip--primary":""}">
    ${s.icon?unicode2Emoji(s.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${getColIconByType(s.type)}"></use></svg>`}
    <span class="fn__ellipsis">${s.name}${u}</span>
</span>`,!0}}),i};return e.filters.forEach(a=>{const i=n(a);i&&(t+=`<button class="b3-menu__item" draggable="true" data-id="${a.column}" data-filter-type="${a.value.type}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">${i}</div>
    <svg class="b3-menu__action" data-type="removeFilter"><use xlink:href="#iconTrashcan"></use></svg>
</button>`)}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.filter}</span>
</button>
<button class="b3-menu__separator"></button>
${t}
<button class="b3-menu__item${e.filters.length===e.columns.length?" fn__none":""}" data-type="addFilter">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.addFilter}</span>
</button>
<button class="b3-menu__item${t?"":" fn__none"}" data-type="removeFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeFilters}</span>
</button>
</div>`};var Zo=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const Xo=e=>{let t;e.data.view.columns.find((i,s)=>{if(i.id===e.colId)return t=JSON.parse(JSON.stringify(i)),e.data.view.columns.splice(s+1,0,t),!0}),t.name=duplicateNameAddOne(t.name),t.id=Lute.NewNodeID();const n=dayjs().format("YYYYMMDDHHmmss"),a=e.blockElement.getAttribute("data-node-id");transaction(e.protyle,[{action:"duplicateAttrViewKey",keyID:e.colId,nextID:t.id,avID:e.data.id},{action:"doUpdateUpdated",id:a,data:n}],[{action:"removeAttrViewCol",id:t.id,avID:e.data.id},{action:"doUpdateUpdated",id:a,data:e.blockElement.getAttribute("updated")}]),ke({blockElement:e.blockElement,protyle:e.protyle,type:t.type,name:t.name,icon:t.icon,previousID:e.colId,data:e.data,id:t.id}),e.blockElement.setAttribute("updated",n)},Cs=e=>{var t,n,a,i;let s;e.data.view.columns.find(l=>{if(l.id===e.colId)return s=l,!0});let o=`<button class="b3-menu__item" data-type="nobg" data-col-id="${e.colId}">
    <span class="block__icon${e.isCustomAttr?" fn__none":""}" style="padding: 8px;margin-left: -4px;" data-type="go-properties">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span style="padding: 5px;margin-right: 8px;width: 14px;font-size: 14px;" class="block__icon block__icon--show" data-col-type="${s.type}" data-icon="${s.icon}" data-type="update-icon">${s.icon?unicode2Emoji(s.icon):`<svg><use xlink:href="#${tt(s.type)}"></use></svg>`}</span>
    <span class="b3-menu__label" style="padding: 4px;display: flex;"><input data-type="name" class="b3-text-field fn__block" type="text" value="${s.name}"></span>
</button>
<button class="b3-menu__item" data-type="goUpdateColType" ${s.type==="block"?"disabled":""}>
    <span class="b3-menu__label">${window.siyuan.languages.type}</span>
    <span class="fn__space"></span>
    <svg class="b3-menu__icon"><use xlink:href="#${tt(s.type)}"></use></svg>
    <span class="b3-menu__accelerator" style="margin-left: 0">${pn(s.type)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`;if(["mSelect","select"].includes(s.type))o+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label" style="padding: 4px;display: flex"><input data-type="addOption" class="b3-text-field fn__block fn__size200" type="text" placeholder="${window.siyuan.languages.enterKey} ${window.siyuan.languages.addAttr}"></span>
</button>`,s.options||(s.options=[]),s.options.forEach(l=>{o+=`<button class="b3-menu__item${o?"":" b3-menu__item--current"}" draggable="true" data-name="${l.name}" data-color="${l.color}">
    <svg class="b3-menu__icon fn__grab"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${l.color});color:var(--b3-font-color${l.color})">
            <span class="fn__ellipsis">${l.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`});else if(s.type==="number")o+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="numberFormat" data-format="${s.numberFormat}">
    <svg class="b3-menu__icon"><use xlink:href="#iconFormat"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.format}</span>
    <span class="b3-menu__accelerator">${getLabelByNumberFormat(s.numberFormat)}</span>
</button>`;else if(s.type==="template")o+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <textarea spellcheck="false" rows="${Math.min(s.template.split(`
`).length,8)}" placeholder="${window.siyuan.languages.template}" data-type="updateTemplate" style="margin: 4px 0" rows="1" class="fn__block b3-text-field">${s.template}</textarea>
</button>`;else if(s.type==="relation"){const l=((t=s.relation)==null?void 0:t.avID)===e.data.id;o+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="goSearchAV" data-av-id="${((n=s.relation)==null?void 0:n.avID)||""}" data-old-value='${JSON.stringify(s.relation||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relatedTo}</span>
    <span class="b3-menu__accelerator">${l?window.siyuan.languages.thisDatabase:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.backRelation}</span>
    <svg class="b3-menu__icon b3-menu__icon--small fn__none"><use xlink:href="#iconHelp"></use></svg>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="backRelation" type="checkbox" class="b3-switch b3-switch--menu" ${(a=s.relation)!=null&&a.isTwoWay?"checked":""}>
</label>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <input data-old-value="" data-type="colName" style="margin: 8px 0 4px" class="b3-text-field fn__block" placeholder="${e.data.name} ${s.name}">
</div>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <button style="margin: 4px 0 8px;" class="b3-button fn__block" data-type="updateRelation">${window.siyuan.languages.confirm}</button>
</div>`}else s.type==="rollup"?o+='<button class="b3-menu__separator"></button>'+getRollupHTML({colData:s}):s.type==="date"&&(o+=`<button class="b3-menu__separator"></button>
<label class="b3-menu__item">
    <span class="fn__flex-center">${window.siyuan.languages.fillCreated}</span>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="fillCreated" type="checkbox" class="b3-switch b3-switch--menu" ${(i=s.date)!=null&&i.autoFillNow?"checked":""}>
</label>`);return s.type!=="block"&&(o+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="${s.hidden?"showCol":"hideCol"}">
    <svg class="b3-menu__icon" style=""><use xlink:href="#icon${s.hidden?"Eye":"Eyeoff"}"></use></svg>
    <span class="b3-menu__label">${s.hidden?window.siyuan.languages.showCol:window.siyuan.languages.hideCol}</span>
</button>
<button class="b3-menu__item${s.type==="relation"?" fn__none":""}" data-type="duplicateCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconCopy"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item" data-type="removeCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>`),`<div class="b3-menu__items">
    ${o}
    <button class="b3-menu__separator"></button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.wrap}</span>
        <span class="fn__space fn__flex-1"></span>
        <input data-type="wrap" type="checkbox" class="b3-switch b3-switch--menu" ${s.wrap?" checked":""}>
    </label>
</div>
<div class="b3-menu__items fn__none">
    <button class="b3-menu__item" data-type="nobg" data-col-id="${s.id}">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goEditCol">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
    </button>
    <button class="b3-menu__separator"></button>
    ${Ae("text",s.type)}
    ${Ae("number",s.type)}
    ${Ae("select",s.type)}
    ${Ae("mSelect",s.type)}
    ${Ae("date",s.type)}
    ${Ae("mAsset",s.type)}
    ${Ae("checkbox",s.type)}
    ${Ae("url",s.type)}
    ${Ae("email",s.type)}
    ${Ae("phone",s.type)}
    ${Ae("template",s.type)}
    ${Ae("relation",s.type)}
    ${Ae("rollup",s.type)}
    ${Ae("lineNumber",s.type)}
    ${Ae("created",s.type)}
    ${Ae("updated",s.type)}
</div>`},As=e=>{const t=e.data.id,n=e.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id"),a=e.data.view.columns.find(c=>c.id===n),i=e.menuElement.querySelector('[data-type="name"]');i.addEventListener("blur",()=>{const c=i.value;c!==a.name&&(transaction(e.protyle,[{action:"updateAttrViewCol",id:n,avID:t,name:c,type:a.type}],[{action:"updateAttrViewCol",id:n,avID:t,name:a.name,type:a.type}]),a.name=c,updateAttrViewCellAnimation(e.protyle.wysiwyg.element.querySelector(`.av__row--header .av__cell[data-col-id="${n}"]`),void 0,{name:c}))}),i.addEventListener("keydown",c=>{c.isComposing||(c.key==="Escape"?e.menuElement.parentElement.remove():c.key==="Enter"&&(i.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}),i.addEventListener("keyup",c=>{if(c.isComposing)return;const u=e.menuElement.querySelector('[data-type="colName"]');u&&u.setAttribute("placeholder",`${e.data.name} ${i.value}`)}),i.select();const s=e.menuElement.querySelector('[data-type="updateTemplate"]');s&&(s.addEventListener("blur",()=>{const c=s.value;c!==a.template&&(transaction(e.protyle,[{action:"updateAttrViewColTemplate",id:n,avID:t,data:c,type:a.type}],[{action:"updateAttrViewColTemplate",id:n,avID:t,data:a.template,type:a.type}]),a.template=c)}),s.addEventListener("keydown",c=>{c.isComposing||(c.key==="Escape"?e.menuElement.parentElement.remove():c.key==="Enter"&&!c.shiftKey&&(s.dispatchEvent(new CustomEvent("blur")),e.menuElement.parentElement.remove()))}));const o=e.menuElement.querySelector('.b3-switch[data-type="wrap"]');o&&o.addEventListener("change",()=>{transaction(e.protyle,[{action:"setAttrViewColWrap",id:n,avID:t,data:o.checked,blockID:e.blockID}],[{action:"setAttrViewColWrap",id:n,avID:t,data:!o.checked,blockID:e.blockID}])});const l=e.menuElement.querySelector('[data-type="addOption"]');l&&l.addEventListener("keydown",c=>{if(!c.isComposing&&(c.key==="Escape"&&e.menuElement.parentElement.remove(),c.key==="Enter")){let u=!1;if(a.options.find(f=>{if(l.value===f.name)return u=!0,!0}),u||!l.value)return;a.options.push({color:(a.options.length+1).toString(),name:l.value}),transaction(e.protyle,[{action:"updateAttrViewColOptions",id:n,avID:t,data:a.options}],[{action:"removeAttrViewColOption",id:n,avID:t,data:l.value}]),e.menuElement.innerHTML=Cs({protyle:e.protyle,colId:n,data:e.data,isCustomAttr:e.isCustomAttr}),As({protyle:e.protyle,menuElement:e.menuElement,data:e.data,isCustomAttr:e.isCustomAttr,blockID:e.blockID}),e.menuElement.querySelector('[data-type="addOption"]').focus()}});const r=e.menuElement.querySelector('[data-type="fillCreated"]');r&&r.addEventListener("change",()=>{transaction(e.protyle,[{avID:t,action:"setAttrViewColDate",id:n,data:r.checked}],[{avID:t,action:"setAttrViewColDate",id:n,data:!r.checked}])});const d=e.menuElement.querySelector('[data-type="backRelation"]');if(d){d.addEventListener("change",()=>{toggleUpdateRelationBtn(e.menuElement,t)});const c=e.menuElement.querySelector('[data-type="goSearchAV"]'),u=JSON.parse(c.getAttribute("data-old-value")),f=e.menuElement.querySelector('[data-type="colName"]');f.addEventListener("input",()=>{toggleUpdateRelationBtn(e.menuElement,t)}),u.avID?fetchPost("/api/av/getAttributeView",{id:u.avID},g=>{c.querySelector(".b3-menu__accelerator").textContent=u.avID===t?window.siyuan.languages.thisDatabase:g.data.av.name||window.siyuan.languages.title,g.data.av.keyValues.find(p=>{if(p.key.id===u.backKeyID)return f.setAttribute("data-old-value",p.key.name||window.siyuan.languages.title),f.value=p.key.name||window.siyuan.languages.title,!0}),toggleUpdateRelationBtn(e.menuElement,t)}):toggleUpdateRelationBtn(e.menuElement,t)}bindRollupData(e)},pn=e=>{switch(e){case"text":case"number":case"select":case"date":case"phone":case"email":case"template":return window.siyuan.languages[e];case"mSelect":return window.siyuan.languages.multiSelect;case"relation":return window.siyuan.languages.relation;case"rollup":return window.siyuan.languages.rollup;case"updated":return window.siyuan.languages.updatedTime;case"created":return window.siyuan.languages.createdTime;case"url":return window.siyuan.languages.link;case"mAsset":return window.siyuan.languages.assets;case"checkbox":return window.siyuan.languages.checkbox;case"block":return window.siyuan.languages._attrView.key;case"lineNumber":return window.siyuan.languages.lineNumber}},tt=e=>{switch(e){case"text":return"iconAlignLeft";case"block":return"iconKey";case"number":return"iconNumber";case"select":return"iconListItem";case"mSelect":return"iconList";case"relation":return"iconOpen";case"rollup":return"iconSearch";case"date":return"iconCalendar";case"updated":case"created":return"iconClock";case"url":return"iconLink";case"mAsset":return"iconImage";case"email":return"iconEmail";case"phone":return"iconPhone";case"template":return"iconMath";case"checkbox":return"iconCheck";case"lineNumber":return"iconOrderedList"}},ke=e=>{if(!e.blockElement)return;const t=e.blockElement.getAttribute("data-node-id");e.blockElement.classList.contains("av")?e.blockElement.querySelectorAll(".av__row").forEach((a,i)=>{let s;e.previousID?s=a.querySelector(`[data-col-id="${e.previousID}"]`):s=a.lastElementChild.previousElementSibling;let o="";i===0?o=`<div class="av__cell av__cell--header" draggable="true" data-icon="${e.icon||""}" data-col-id="${e.id}" data-dtype="${e.type}" data-wrap="false" style="width: 200px;">
    ${e.icon?unicode2Emoji(e.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${tt(e.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${e.name}</span>
    <div class="av__widthdrag av__pulse"></div>
</div>`:o='<div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>',s.insertAdjacentHTML("afterend",o)}):e.blockElement.querySelector(".fn__hr").insertAdjacentHTML("beforebegin",`<div class="block__icons av__row" data-id="${t}" data-col-id="${e.id}">
    <div class="block__icon" draggable="true"><svg><use xlink:href="#iconDrag"></use></svg></div>
    <div class="block__logo ariaLabel fn__pointer" data-type="editCol" data-position="parentW" aria-label="${pn(e.type)}">
        <svg class="block__logoicon"><use xlink:href="#${tt(e.type)}"></use></svg>
        <span>${pn(e.type)}</span>
    </div>
    <div data-col-id="${e.id}" data-block-id="${t}" data-type="${e.type}" data-options="[]" class="fn__flex-1 fn__flex">
        <div class="fn__flex-1"></div>
    </div>
</div>`);const n=document.querySelector(".av__panel .b3-menu");if(n&&e.data&&e.blockElement.classList.contains("av")){n.innerHTML=Cs({protyle:e.protyle,data:e.data,colId:e.id,isCustomAttr:!1}),As({protyle:e.protyle,data:e.data,menuElement:n,isCustomAttr:!1,blockID:t});const a=e.blockElement.querySelector(".av__views").getBoundingClientRect();a&&setPosition(n,a.right-n.clientWidth,a.bottom,a.height);return}openMenuPanel({protyle:e.protyle,blockElement:e.blockElement,type:"edit",colId:e.id,editData:{previousID:e.previousID,colData:Jo(e.type,e.id,e.name)}}),window.siyuan.menus.menu.remove()},Fu=(e,t,n)=>{const a=n.getAttribute("data-dtype"),i=n.getAttribute("data-col-id"),s=t.getAttribute("data-av-id"),o=t.getAttribute("data-node-id"),l=n.querySelector(".av__celltext").textContent.trim(),r=new Menu("av-header-cell",()=>{const f=r.element.querySelector(".b3-text-field").value;f!==l&&(transaction(e,[{action:"updateAttrViewCol",id:i,avID:s,name:f,type:a}],[{action:"updateAttrViewCol",id:i,avID:s,name:l,type:a}]),updateAttrViewCellAnimation(t.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{name:f}),focusBlock(t))});r.addItem({iconHTML:`<span style="align-self: center;margin-right: 8px;width: 14px;" class="block__icon block__icon--show">${n.dataset.icon?unicode2Emoji(n.dataset.icon):`<svg><use xlink:href="#${tt(a)}"></use></svg>`}</span>`,type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block fn__size200" type="text" value="${l}">`,bind(f){const g=f.querySelector(".block__icon");g.setAttribute("data-icon",n.dataset.icon),g.addEventListener("click",p=>{const m=g.getBoundingClientRect();openEmojiPanel("","av",{x:m.left,y:m.bottom,h:m.height,w:m.width},y=>{transaction(e,[{action:"setAttrViewColIcon",id:i,avID:s,data:y}],[{action:"setAttrViewColIcon",id:i,avID:s,data:n.dataset.icon}]),g.setAttribute("data-icon",y),g.innerHTML=y?unicode2Emoji(y):`<svg><use xlink:href="#${tt(a)}"></use></svg>`,updateAttrViewCellAnimation(t.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{icon:y})}),p.preventDefault(),p.stopPropagation()}),f.querySelector("input").addEventListener("keydown",p=>{p.isComposing||p.key==="Enter"&&(r.close(),p.preventDefault())})}}),r.addItem({icon:"iconEdit",label:window.siyuan.languages.edit,click(){const f=r.element.querySelector(".b3-text-field").value;openMenuPanel({protyle:e,blockElement:t,type:"edit",colId:i,cb(g){const p=g.querySelector('.b3-text-field[data-type="name"]');p.value=f,p.select()}})}}),r.addSeparator(),a!=="lineNumber"&&(r.addItem({icon:"iconUp",label:window.siyuan.languages.asc,click(){fetchPost("/api/av/renderAttributeView",{id:s},f=>{transaction(e,[{action:"setAttrViewSorts",avID:f.data.id,data:[{column:i,order:"ASC"}],blockID:o}],[{action:"setAttrViewSorts",avID:f.data.id,data:f.data.view.sorts,blockID:o}])})}}),r.addItem({icon:"iconDown",label:window.siyuan.languages.desc,click(){fetchPost("/api/av/renderAttributeView",{id:s},f=>{transaction(e,[{action:"setAttrViewSorts",avID:f.data.id,data:[{column:i,order:"DESC"}],blockID:o}],[{action:"setAttrViewSorts",avID:f.data.id,data:f.data.view.sorts,blockID:o}])})}}),a!=="mAsset"&&r.addItem({icon:"iconFilter",label:window.siyuan.languages.filter,click(){fetchPost("/api/av/renderAttributeView",{id:s},f=>{const g=f.data;let p;g.view.filters.find(m=>{if(m.column===i&&m.value.type===a)return p=m,!0}),p||(p={column:i,operator:getDefaultOperatorByType(a),value:genCellValue(a,"")},g.view.filters.push(p)),setFilter({filter:p,protyle:e,data:g,blockElement:t,target:t.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`)})})}}),r.addSeparator()),r.addItem({icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,click(){var f;const g=Ls(e,t,((f=n.previousElementSibling)==null?void 0:f.getAttribute("data-col-id"))||"");t.contains(n)||(n=t.querySelector(`.av__row--header .av__cell--header[data-col-id="${i}"]`));const p=n.getBoundingClientRect();g.open({x:p.left,y:p.bottom,h:p.height})}}),r.addItem({icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,click(){const f=Ls(e,t,i);t.contains(n)||(n=t.querySelector(`.av__row--header .av__cell--header[data-col-id="${i}"]`));const g=n.getBoundingClientRect();f.open({x:g.left,y:g.bottom,h:g.height})}}),a!=="block"&&r.addItem({icon:"iconEyeoff",label:window.siyuan.languages.hide,click(){transaction(e,[{action:"setAttrViewColHidden",id:i,avID:s,data:!0,blockID:o}],[{action:"setAttrViewColHidden",id:i,avID:s,data:!1,blockID:o}])}});const d=n.dataset.pin==="true";if(r.addItem({icon:d?"iconUnpin":"iconPin",label:d?window.siyuan.languages.unfreezeCol:window.siyuan.languages.freezeCol,click(){transaction(e,[{action:"setAttrViewColPin",id:i,avID:s,data:!d,blockID:o}],[{action:"setAttrViewColPin",id:i,avID:s,data:d,blockID:o}]),updateAttrViewCellAnimation(t.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{pin:!d})}}),a!=="block"){let f;a!=="relation"&&r.addItem({icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){fetchPost("/api/av/renderAttributeView",{id:s},g=>{Xo({blockElement:t,viewID:t.getAttribute(Constants.CUSTOM_SY_AV_VIEW),protyle:e,colId:i,data:g.data})})}}),r.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){return Zo(this,null,function*(){var g;if(a==="relation"){const m=(yield fetchSyncPost("/api/av/getAttributeView",{id:s})).data.av.keyValues.find(y=>y.key.id===i);if((g=m.key.relation)!=null&&g.isTwoWay){const y=yield fetchSyncPost("/api/av/getAttributeView",{id:m.key.relation.avID}),v=new Dialog({title:window.siyuan.languages.removeCol.replace("${x}",m.key.name),content:`<div class="b3-dialog__content">
    ${window.siyuan.languages.confirmRemoveRelationField.replace("${x}",y.data.av.name)}
    <div class="fn__hr--b"></div>
    <button class="fn__block b3-button b3-button--error">${window.siyuan.languages.delete}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--warning">${window.siyuan.languages.removeButKeepRelationField}</button>
    <div class="fn__hr"></div>
    <button class="fn__block b3-button b3-button--info">${window.siyuan.languages.cancel}</button>
</div>`});v.element.addEventListener("click",b=>{let w=b.target;for(;w&&!w.isSameNode(v.element);){if(w.classList.contains("b3-button--error")){la({protyle:e,colId:i,avID:s,blockID:o,oldValue:l,type:a,cellElement:n,blockElement:t,removeDest:!0}),v.destroy();break}else if(w.classList.contains("b3-button--warning")){la({protyle:e,colId:i,avID:s,blockID:o,oldValue:l,type:a,cellElement:n,blockElement:t,removeDest:!1}),v.destroy();break}else if(w.classList.contains("b3-button--info")){v.destroy();break}w=w.parentElement}});return}}la({protyle:e,colId:i,avID:s,blockID:o,oldValue:l,type:a,cellElement:n,blockElement:t,removeDest:!1})})}}),r.addSeparator()}r.addItem({label:`<label class="fn__flex"><span class="fn__flex-center">${window.siyuan.languages.wrap}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch b3-switch--menu"${n.dataset.wrap==="true"?" checked":""}></label>`,bind(f){const g=f.querySelector("input");g.addEventListener("change",()=>{transaction(e,[{action:"setAttrViewColWrap",id:i,avID:s,data:g.checked,blockID:o}],[{action:"setAttrViewColWrap",id:i,avID:s,data:!g.checked,blockID:o}])})}});const c=n.getBoundingClientRect();r.open({x:c.left,y:c.bottom,h:c.height});const u=window.siyuan.menus.menu.element.querySelector(".b3-text-field");u&&(u.select(),u.focus())},la=e=>{var t;const n=dayjs().format("YYYYMMDDHHmmss");transaction(e.protyle,[{action:"removeAttrViewCol",id:e.colId,avID:e.avID,removeDest:e.removeDest},{action:"doUpdateUpdated",id:e.blockID,data:n}],[{action:"addAttrViewCol",name:e.oldValue,avID:e.avID,type:e.type,id:e.colId,previousID:((t=e.cellElement.previousElementSibling)==null?void 0:t.getAttribute("data-col-id"))||""},{action:"doUpdateUpdated",id:e.blockID,data:e.blockElement.getAttribute("updated")}]),removeAttrViewColAnimation(e.blockElement,e.colId),e.blockElement.setAttribute("updated",n)},Yu=e=>{const t=e.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let n="";const a=e.data.view.columns.find((s,o)=>{var l;if(s.id===t)return n=(l=e.data.view.columns[o-1])==null?void 0:l.id,e.data.view.columns.splice(o,1),!0}),i=dayjs().format("YYYYMMDDHHmmss");transaction(e.protyle,[{action:"removeAttrViewCol",id:t,avID:e.avID,removeDest:e.isTwoWay},{action:"doUpdateUpdated",id:e.blockID,data:i}],[{action:"addAttrViewCol",name:a.name,avID:e.avID,type:a.type,id:t,previousID:n},{action:"doUpdateUpdated",id:e.blockID,data:e.blockElement.getAttribute("updated")}]),removeAttrViewColAnimation(e.blockElement,t),e.blockElement.setAttribute("updated",i),e.isCustomAttr?e.avPanelElement.remove():(e.menuElement.innerHTML=getPropertiesHTML(e.data.view),setPosition(e.menuElement,e.tabRect.right-e.menuElement.clientWidth,e.tabRect.bottom,e.tabRect.height))},Ae=(e,t)=>`<button class="b3-menu__item" data-type="updateColType" data-old-type="${t}" data-new-type="${e}">
    <svg class="b3-menu__icon"><use xlink:href="#${tt(e)}"></use></svg>
    <span class="b3-menu__label">${pn(e)}</span>
    ${e===t?'<svg class="b3-menu__checked"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`,Ls=(e,t,n)=>{const a=new Menu("av-header-add"),i=t.getAttribute("data-av-id");typeof n=="undefined"&&(n=Array.from(t.querySelectorAll(".av__row--header .av__cell")).pop().getAttribute("data-col-id"));const s=t.getAttribute("data-node-id");return a.addItem({icon:"iconAlignLeft",label:window.siyuan.languages.text,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.text,avID:i,type:"text",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"text",name:window.siyuan.languages.text,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconNumber",label:window.siyuan.languages.number,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.number,avID:i,type:"number",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"number",name:window.siyuan.languages.number,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconListItem",label:window.siyuan.languages.select,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.select,avID:i,type:"select",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"select",name:window.siyuan.languages.select,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconList",label:window.siyuan.languages.multiSelect,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.multiSelect,avID:i,type:"mSelect",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"mSelect",name:window.siyuan.languages.multiSelect,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconCalendar",label:window.siyuan.languages.date,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.date,avID:i,type:"date",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"date",name:window.siyuan.languages.date,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconImage",label:window.siyuan.languages.assets,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.assets,avID:i,type:"mAsset",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"mAsset",name:window.siyuan.languages.assets,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconCheck",label:window.siyuan.languages.checkbox,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.checkbox,avID:i,type:"checkbox",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"checkbox",name:window.siyuan.languages.checkbox,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconLink",label:window.siyuan.languages.link,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.link,avID:i,type:"url",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"url",name:window.siyuan.languages.link,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconEmail",label:window.siyuan.languages.email,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.email,avID:i,type:"email",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"email",name:window.siyuan.languages.email,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconPhone",label:window.siyuan.languages.phone,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.phone,avID:i,type:"phone",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"phone",name:window.siyuan.languages.phone,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconMath",label:window.siyuan.languages.template,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.template,avID:i,type:"template",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"template",name:window.siyuan.languages.template,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconOpen",label:window.siyuan.languages.relation,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.relation,avID:i,type:"relation",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"relation",name:window.siyuan.languages.relation,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconSearch",label:window.siyuan.languages.rollup,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.rollup,avID:i,type:"rollup",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"rollup",name:window.siyuan.languages.rollup,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconOrderedList",label:window.siyuan.languages.lineNumber,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.lineNumber,avID:i,type:"lineNumber",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"lineNumber",name:window.siyuan.languages.lineNumber,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconClock",label:window.siyuan.languages.createdTime,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.createdTime,avID:i,type:"created",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"created",name:window.siyuan.languages.createdTime,id:o,previousID:n}),t.setAttribute("updated",l)}}),a.addItem({icon:"iconClock",label:window.siyuan.languages.updatedTime,click(){const o=Lute.NewNodeID(),l=dayjs().format("YYYYMMDDHHmmss");transaction(e,[{action:"addAttrViewCol",name:window.siyuan.languages.updatedTime,avID:i,type:"updated",id:o,previousID:n},{action:"doUpdateUpdated",id:s,data:l}],[{action:"removeAttrViewCol",id:o,avID:i},{action:"doUpdateUpdated",id:s,data:t.getAttribute("updated")}]),ke({blockElement:t,protyle:e,type:"updated",name:window.siyuan.languages.updatedTime,id:o,previousID:n}),t.setAttribute("updated",l)}}),a},Jo=(e,t,n)=>({hidden:!1,icon:"",id:t,name:n,numberFormat:"",pin:!1,template:"",type:e,width:"",wrap:!1,calc:null}),ra=(e,t,n)=>{e.value===""?(t.classList.add("fn__none"),typeof n=="number"&&(e.style.paddingRight=e.dataset.oldPaddingRight)):(t.classList.remove("fn__none"),typeof n=="number"&&e.style.setProperty("padding-right",`${n*2+t.clientWidth}px`,"important"))},Qo=e=>{e.inputElement.dataset.oldPaddingRight=e.inputElement.style.paddingRight,e.inputElement.insertAdjacentHTML("afterend",`<svg class="${e.className||"b3-form__icon-clear"} ariaLabel" aria-label="${window.siyuan.languages.clear}" style="${e.right?"right: "+e.right+"px;":""}${e.height?"height:"+e.height+"px;":""}${e.width?"width:"+e.width:""}">
<use xlink:href="#iconCloseRound"></use></svg>`);const t=e.inputElement.nextElementSibling;t.addEventListener("click",()=>{e.inputElement.value="",e.inputElement.focus(),ra(e.inputElement,t,e.right),e.clearCB&&e.clearCB()}),e.inputElement.addEventListener("input",()=>{ra(e.inputElement,t,e.right)}),ra(e.inputElement,t,e.right)},Xe=(e,t,n,a)=>{let i=[];e.getAttribute("data-type")==="NodeAttributeView"?i=[e]:i=Array.from(e.querySelectorAll('[data-type="NodeAttributeView"]')),i.length!==0&&i.length>0&&i.forEach(s=>{var o,l,r,d,c;if(s.getAttribute("data-render")==="true")return;const u=s.style.alignSelf;if(s.firstElementChild.innerHTML===""){s.style.alignSelf="";let S="";[1,2,3].forEach(()=>{S+=`<div class="av__row">
    <div style="width: 24px;flex-shrink: 0"></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
</div>`}),s.firstElementChild.innerHTML=S}const f=((o=s.querySelector(".av__scroll"))==null?void 0:o.scrollLeft)||0,g=(l=s.querySelector(".av__row--header"))==null?void 0:l.style.transform,p=(r=s.querySelector(".av__row--footer"))==null?void 0:r.style.transform,m=[];s.querySelectorAll(".av__row--select").forEach(S=>{const I=S.getAttribute("data-id");I&&m.push(I)});let y="";const v=s.querySelector(".av__cell--select");v&&(y=B(v,"av__row").dataset.id+x.ZWSP+v.getAttribute("data-col-id"));let b="";const w=s.querySelector(".av__drag-fill");w&&(b=B(w,"av__row").dataset.id+x.ZWSP+w.parentElement.getAttribute("data-col-id"));const h=[];s.querySelectorAll(".av__cell--active").forEach(S=>{h.push(B(S,"av__row").dataset.id+x.ZWSP+S.getAttribute("data-col-id"))});const C=(d=t.options.history)==null?void 0:d.created,k=(c=t.options.history)==null?void 0:c.snapshot;let E=s.getAttribute(x.CUSTOM_SY_AV_VIEW)||"";if(typeof a=="string"){const S=s.querySelector(`.av__views > .layout-tab-bar > .item[data-id="${a}"]`);S&&(s.dataset.pageSize=S.dataset.page),E=a,Se("/api/av/setDatabaseBlockView",{id:s.dataset.nodeId,viewID:a}),s.setAttribute(x.CUSTOM_SY_AV_VIEW,E)}let _=s.querySelector('[data-type="av-search"]');const L=_&&document.activeElement.isSameNode(_),A=(_==null?void 0:_.value)||"";Se(C?"/api/av/renderHistoryAttributeView":k?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:s.getAttribute("data-av-id"),created:C,snapshot:k,pageSize:parseInt(s.dataset.pageSize)||void 0,viewID:E,query:A.trim()},S=>{var I;const T=S.data.view;s.dataset.pageSize||(s.dataset.pageSize=T.pageSize.toString());let D='<div class="av__row av__row--header"><div class="av__firstcol av__colsticky"><svg><use xlink:href="#iconUncheck"></use></svg></div>',M="",$=-1,q=-1,j=0;const P=s.clientWidth;let G=!1;T.columns.forEach((F,ye)=>{G||T.filters.find(fe=>{if(fe.value.type===F.type&&F.id===fe.column)return G=!0,!0}),F.hidden||(F.pin&&($=ye),j<P-200&&(j+=parseInt(F.width)||200,q=ye))}),$=Math.min($,q),$>-1&&(D='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>',M='<div class="av__colsticky">');let ne=!1;T.columns.forEach((F,ye)=>{var fe;F.hidden||(D+=`<div class="av__cell av__cell--header" data-col-id="${F.id}"  draggable="true" 
data-icon="${F.icon}" data-dtype="${F.type}" data-wrap="${F.wrap}" data-pin="${F.pin}" 
style="width: ${F.width||"200px"};">
    ${F.icon?Me(F.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${tt(F.type)}"></use></svg>`}
    <span class="av__celltext fn__flex-1">${F.name}</span>
    ${F.pin?'<svg class="av__cellheadericon av__cellheadericon--pin"><use xlink:href="#iconPin"></use></svg>':""}
    <div class="av__widthdrag"></div>
</div>`,$===ye&&(D+="</div>"),F.type==="lineNumber"?M+=`<div data-col-id="${F.id}" data-dtype="${F.type}" class="av__calc" style="width: ${F.width||"200px"}">&nbsp;</div>`:M+=`<div class="av__calc${F.calc&&F.calc.operator!==""?" av__calc--ashow":""}" data-col-id="${F.id}" data-dtype="${F.type}" data-operator="${((fe=F.calc)==null?void 0:fe.operator)||""}" 
style="width: ${F.width||"200px"}">${Bo(F)||'<svg><use xlink:href="#iconDown"></use></svg>'+window.siyuan.languages.calc}</div>`,F.calc&&F.calc.operator!==""&&(ne=!0),$===ye&&(M+="</div>"))}),D+=`<div class="block__icons" style="min-height: auto">
    <div class="block__icon block__icon--show" data-type="av-header-more"><svg><use xlink:href="#iconMore"></use></svg></div>
    <div class="fn__space"></div>
    <div class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.newCol}" data-type="av-header-add" data-position="4bottom"><svg><use xlink:href="#iconAdd"></use></svg></div>
</div>
</div>`,T.rows.forEach((F,ye)=>{D+=`<div class="av__row" data-id="${F.id}">`,$>-1?D+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>':D+='<div class="av__firstcol av__colsticky"><svg><use xlink:href="#iconUncheck"></use></svg></div>',F.cells.forEach((fe,St)=>{var Ks,Zs,Xs;if(T.columns[St].hidden)return;let Js="";fe.valueType==="checkbox"&&(Js=(Zs=(Ks=fe.value)==null?void 0:Ks.checkbox)!=null&&Zs.checked?" av__cell-check":" av__cell-uncheck"),D+=`<div class="av__cell${Js}" data-id="${fe.id}" data-col-id="${T.columns[St].id}"
${fe.valueType==="block"?'data-block-id="'+(fe.value.block.id||"")+'"':""} data-wrap="${T.columns[St].wrap}" 
data-dtype="${T.columns[St].type}" 
${(Xs=fe.value)!=null&&Xs.isDetached?' data-detached="true"':""} 
style="width: ${T.columns[St].width||"200px"};
${fe.valueType==="number"?"text-align: right;":""}
${fe.bgColor?`background-color:${fe.bgColor};`:""}
${fe.color?`color:${fe.color};`:""}">${ia(fe.value,ye)}</div>`,$===St&&(D+="</div>")}),D+="<div></div></div>"});let ie="",W;S.data.views.forEach(F=>{ie+=`<div data-id="${F.id}" data-page="${F.pageSize}" class="item${F.id===S.data.viewID?" item--focus":""}">
    ${F.icon?Me(F.icon,"item__graphic",!0):'<svg class="item__graphic"><use xlink:href="#iconTable"></use></svg>'}
    <span class="item__text">${F.name}</span>
</div>`,F.id===S.data.viewID&&(W=F)});let Fe="--av-background:var(--b3-theme-background)";s.style.backgroundColor?Fe="--av-background:"+s.style.backgroundColor:V(s)&&(Fe="--av-background:var(--b3-theme-surface)"),s.firstElementChild.outerHTML=`<div class="av__container" style="${Fe}">
    <div class="av__header">
        <div class="fn__flex av__views${L||A?" av__views--show":""}">
            <div class="layout-tab-bar fn__flex">
                ${ie}
            </div>
            <div class="fn__space"></div>
            <span data-type="av-add" class="block__icon ariaLabel" data-position="8bottom" aria-label="${window.siyuan.languages.newView}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__flex-1"></div>
            <div class="fn__space"></div>
            <span data-type="av-switcher" class="block__icon${S.data.views.length>0?"":" fn__none"}">
                <svg><use xlink:href="#iconDown"></use></svg>
                <span class="fn__space"></span>
                <small>${S.data.views.length}</small>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-filter" class="block__icon${G?" block__icon--active":""}">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-sort" class="block__icon${T.sorts.length>0?" block__icon--active":""}">
                <svg><use xlink:href="#iconSort"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-search-icon" class="block__icon">
                <svg><use xlink:href="#iconSearch"></use></svg>
            </span>
            <div style="position: relative" class="fn__flex">
                <input style="${L||A?"width:128px":"width:0;padding-left: 0;padding-right: 0;"}" data-type="av-search" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <span data-type="av-more" class="block__icon">
                <svg><use xlink:href="#iconMore"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-add-more" class="block__icon ariaLabel" data-position="8bottom" aria-label="${window.siyuan.languages.newRow}">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            ${S.data.isMirror?` <span data-av-id="${S.data.id}" data-popover-url="/api/av/getMirrorDatabaseBlocks" class="popover__block block__icon block__icon--show ariaLabel" data-position="8bottom" aria-label="${window.siyuan.languages.mirrorTip}">
    <svg><use xlink:href="#iconSplitLR"></use></svg></span><div class="fn__space"></div>`:""}
        </div>
        <div contenteditable="${t.disabled?"false":"true"}" spellcheck="${window.siyuan.config.editor.spellcheck.toString()}" class="av__title${W.hideAttrViewName?" fn__none":""}" data-title="${S.data.name||""}" data-tip="${window.siyuan.languages.title}">${S.data.name||""}</div>
        <div class="av__counter fn__none"></div>
    </div>
    <div class="av__scroll">
        <div class="av__body">
            ${D}
            <div class="av__row--util${T.rowCount>T.rows.length?" av__readonly--show":""}">
                <div class="av__colsticky">
                    <button class="b3-button" data-type="av-add-bottom">
                        <svg><use xlink:href="#iconAdd"></use></svg>
                        ${window.siyuan.languages.addAttr}
                    </button>
                    <span class="fn__space"></span>
                    <button class="b3-button${T.rowCount>T.rows.length?"":" fn__none"}">
                        <svg data-type="av-load-more"><use xlink:href="#iconArrowDown"></use></svg>
                        <span data-type="av-load-more">
                            ${window.siyuan.languages.loadMore}
                        </span>
                        <svg data-type="set-page-size" data-size="${T.pageSize}"><use xlink:href="#iconMore"></use></svg>
                    </button>
                </div>
            </div>
            <div class="av__row--footer${ne?" av__readonly--show":""}">${M}</div>
        </div>
    </div>
    <div class="av__cursor" contenteditable="true">${x.ZWSP}</div>
</div>`,s.setAttribute("data-render","true"),s.style.margin="",f&&(s.querySelector(".av__scroll").scrollLeft=f),u&&(s.style.alignSelf=u);const te=t.contentElement.getBoundingClientRect();if(g?s.querySelector(".av__row--header").style.transform=g:bn(s,te,"top"),p?s.querySelector(".av__row--footer").style.transform=p:bn(s,te,"bottom"),y){const F=s.querySelector(`.av__row[data-id="${y.split(x.ZWSP)[0]}"] .av__cell[data-col-id="${y.split(x.ZWSP)[1]}"]`);F&&F.classList.add("av__cell--select");const ye=document.querySelector(".av__mask");ye?(I=ye.querySelector("textarea, input"))==null||I.focus():!document.querySelector(".av__panel")&&!L&&Je(s)}if(m.forEach((F,ye)=>{const fe=s.querySelector(`.av__row[data-id="${F}"]`);fe&&(fe.classList.add("av__row--select"),fe.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck")),ye===m.length-1&&fe&&fa(fe)}),b&&gn(s.querySelector(`.av__row[data-id="${b.split(x.ZWSP)[0]}"] .av__cell[data-col-id="${b.split(x.ZWSP)[1]}"]`)),h.forEach(F=>{var ye;(ye=s.querySelector(`.av__row[data-id="${F.split(x.ZWSP)[0]}"] .av__cell[data-col-id="${F.split(x.ZWSP)[1]}"]`))==null||ye.classList.add("av__cell--active")}),getSelection().rangeCount>0){const F=getSelection().getRangeAt(0);if(!B(F.startContainer,"av__title")){const ye=R(F.startContainer);ye&&s.isSameNode(ye)&&!L&&Je(s)}}s.querySelector(".layout-tab-bar").scrollLeft=s.querySelector(".layout-tab-bar .item--focus").offsetLeft,n&&n();const xe=s.querySelector(".av__views");_=s.querySelector('[data-type="av-search"]'),_.value=A||"",L&&_.focus(),_.addEventListener("input",F=>{F.isComposing||(_.value?xe.classList.add("av__views--show"):xe.classList.remove("av__views--show"),da(s,t))}),_.addEventListener("compositionend",()=>{da(s,t)}),_.addEventListener("blur",F=>{F.isComposing||_.value||(xe.classList.remove("av__views--show"),_.style.width="0",_.style.paddingLeft="0",_.style.paddingRight="0")}),Qo({inputElement:_,right:0,width:"1em",height:_.clientHeight,clearCB(){xe.classList.remove("av__views--show"),_.style.width="0",_.style.paddingLeft="0",_.style.paddingRight="0",Je(s),da(s,t)}})})})};let Ss;const da=(e,t)=>{clearTimeout(Ss),Ss=window.setTimeout(()=>{e.removeAttribute("data-render"),Xe(e,t)},x.TIMEOUT_INPUT)},xs={},Uu=(e,t)=>{t.action==="setAttrViewName"&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${t.id}"]`)).forEach(n=>{const a=n.querySelector(".av__title");a&&(a.textContent=t.data,a.dataset.title=t.data)}),clearTimeout(xs[e.id]),xs[e.id]=window.setTimeout(()=>{if(t.action==="setAttrViewColWidth")Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${t.avID}"]`)).forEach(n=>{const a=n.querySelector(`.av__cell[data-col-id="${t.id}"]`);!a||a.style.width===t.data||n.getAttribute("custom-sy-av-view")!==t.keyID||n.querySelectorAll(".av__row").forEach(i=>{i.querySelector(`[data-col-id="${t.id}"]`).style.width=t.data})});else{const n=t.action==="setAttrViewName"?t.id:t.avID;Array.from(e.wysiwyg.element.querySelectorAll(`[data-av-id="${n}"]`)).forEach(a=>{a.removeAttribute("data-render");const i=a.querySelector('.av__row[data-need-update="true"]');(t.action==="sortAttrViewCol"||t.action==="sortAttrViewRow")&&(a.querySelectorAll(".av__cell--active").forEach(s=>{var o;s.classList.remove("av__cell--active"),(o=s.querySelector(".av__drag-fill"))==null||o.remove()}),addDragFill(a.querySelector(".av__cell--select"))),Xe(a,e,()=>{var s;const o=document.querySelector(`.b3-dialog--open[data-key="${Constants.DIALOG_ATTR}"] div[data-av-id="${n}"]`);o?renderAVAttribute(o.parentElement,o.dataset.nodeId,e):t.action==="insertAttrViewBlock"&&i&&!a.querySelector(`.av__row[data-id="${i.getAttribute("data-id")}"]`)&&(showMessage(window.siyuan.languages.insertRowTip),(s=document.querySelector(".av__mask"))==null||s.remove()),a.removeAttribute("data-loading")})})}},["insertAttrViewBlock"].includes(t.action)?2:100)},Wu=(e,t,n)=>{if(isMobile())return;const a=t.getBoundingClientRect();if(a.height===0||!e){ca();return}let i=document.getElementById("tooltip");i?i.innerHTML=e:(document.body.insertAdjacentHTML("beforeend",`<div class="tooltip" id="tooltip">${e}</div>`),i=document.getElementById("tooltip")),n?i.classList.add("tooltip--"+n):i.className="tooltip";let s=a.left,o=a.bottom;const l=t.getAttribute("data-position"),r=t.parentElement.getBoundingClientRect();l!=null&&l.startsWith("right")&&(s=a.right-i.clientWidth),l!=null&&l.endsWith("bottom")?o+=parseInt(l.replace("right","").replace("left","")):l!=null&&l.endsWith("top")?o=a.top-i.clientHeight:l==="parentE"?(o=r.top,s=r.right+8):l==="parentW"&&(o=r.top+8,s=r.left-i.clientWidth);const d=l==="parentE"?o:a.top,c=window.innerHeight-o;i.style.maxHeight=Math.max(d,c)+"px",o+i.clientHeight>window.innerHeight&&d>c?i.style.top=(l==="parentE"?r.bottom:a.top)-i.clientHeight+"px":i.style.top=o+"px",s+i.clientWidth>window.innerWidth?l==="parentE"?i.style.left=r.left-8-i.clientWidth+"px":i.style.left=window.innerWidth-i.clientWidth+"px":i.style.left=Math.max(0,s)+"px"},ca=()=>{const e=document.getElementById("tooltip");e&&e.remove()},Ts=e=>{if(e.action||(e.action=[]),e.protyle.wysiwyg.element.removeAttribute("data-top"),e.data.code===1){e.action.includes(x.CB_GET_APPEND)||(e.protyle.model?e.protyle.model.parent.parent.removeTab(e.protyle.model.parent.id,!1):e.protyle.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`);return}if(e.data.code!==3&&(e.protyle.notebookId=e.data.data.box,e.protyle.path=e.data.data.path,!(e.data.data.eof&&!e.scrollAttr&&(e.action.includes(x.CB_GET_BEFORE)?e.protyle.wysiwyg.element.firstElementChild.setAttribute("data-eof","1"):e.protyle.wysiwyg.element.lastElementChild.setAttribute("data-eof","2"),e.data.data.mode!==4)))){if(vt(["gutterOnly"],e.protyle),e.protyle.block.parentID=e.data.data.parentID,e.protyle.block.parent2ID=e.data.data.parent2ID,e.protyle.block.rootID=e.data.data.rootID,e.protyle.block.showAll=!1,e.protyle.block.mode=e.data.data.mode,e.protyle.block.blockCount=e.data.data.blockCount,e.protyle.block.scroll=e.data.data.scroll,e.protyle.block.action=e.action,e.action.includes(x.CB_GET_UNCHANGEID)||(e.protyle.block.id=e.data.data.id,e.protyle.scroll.lastScrollTop=0,e.protyle.contentElement.scrollTop=0,e.protyle.wysiwyg.element.setAttribute("data-doc-type",e.data.data.type)),e.action.includes(x.CB_GET_APPEND)||e.action.includes(x.CB_GET_BEFORE)||e.action.includes(x.CB_GET_HTML)){Is({content:e.data.data.content,expand:e.data.data.isBacklinkExpand,action:e.action,scrollAttr:e.scrollAttr,updateReadonly:e.updateReadonly,isSyncing:e.data.data.isSyncing,afterCB:e.afterCB},e.protyle),Ws(e.protyle);return}Se("/api/block/getDocInfo",{id:e.protyle.block.rootID},t=>{e.protyle.options.render.title?e.protyle.title.render(e.protyle,t):(e.protyle.options.render.background&&e.protyle.background.render(t.data.ial,e.protyle.block.rootID),e.protyle.wysiwyg.renderCustom(t.data.ial)),Is({content:e.data.data.content,expand:e.data.data.isBacklinkExpand,action:e.action,scrollAttr:e.scrollAttr,updateReadonly:e.updateReadonly,isSyncing:e.data.data.isSyncing,afterCB:e.afterCB},e.protyle),Ws(e.protyle)})}},Is=(e,t)=>{if(t.contentElement.classList.contains("fn__none")&&t.wysiwyg.element.innerHTML!=="")return;t.block.showAll=e.action.includes(x.CB_GET_ALL);const n=t.contentElement.clientHeight*8,a=typeof e.updateReadonly=="undefined"?t.wysiwyg.element.innerHTML==="":e.updateReadonly;if(e.action.includes(x.CB_GET_APPEND)){if(!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!t.scroll.keepLazyLoad&&t.contentElement.scrollHeight>n){let i=t.wysiwyg.element.firstElementChild;const s=[];for(;t.wysiwyg.element.childElementCount>2&&s&&!t.wysiwyg.element.lastElementChild.isSameNode(i)&&t.contentElement.scrollHeight-i.offsetTop>n;){s.push(i);i=i.nextElementSibling}const o=i.getBoundingClientRect().top;s.forEach(l=>{l.remove()}),t.contentElement.scrollTop=t.contentElement.scrollTop+(i.getBoundingClientRect().top-o),t.scroll.lastScrollTop=t.contentElement.scrollTop,vt(["toolbar"],t)}t.wysiwyg.element.insertAdjacentHTML("beforeend",e.content)}else if(e.action.includes(x.CB_GET_BEFORE)){const i=t.wysiwyg.element.firstElementChild,s=i.getBoundingClientRect().top;if(t.wysiwyg.element.insertAdjacentHTML("afterbegin",e.content),t.contentElement.scrollTop=t.contentElement.scrollTop+(i.getBoundingClientRect().top-s),t.scroll.lastScrollTop=t.contentElement.scrollTop,!t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!t.scroll.keepLazyLoad){const o=[];let l=t.wysiwyg.element.childElementCount,r=t.contentElement.scrollHeight,d=t.wysiwyg.element.lastElementChild;for(;l>2&&r>n&&d.getBoundingClientRect().top>window.innerHeight;)o.push(d),d=d.previousElementSibling,l--,r-=d.clientHeight+8;o.forEach(c=>{c.remove()}),vt(["toolbar"],t)}}else t.wysiwyg.element.innerHTML=e.content;if(!t.block.showAll&&t.wysiwyg.element.childElementCount===1&&t.wysiwyg.element.firstElementChild.classList.contains("p")){const i=Ce(t.wysiwyg.element.firstElementChild);i&&i.textContent===""&&(i.classList.add("protyle-wysiwyg--empty"),i.setAttribute("placeholder",window.siyuan.languages.emptyMobilePlaceholder))}if(e.action.includes(x.CB_GET_BACKLINK)&&Ms(e.expand,t.wysiwyg.element),_t(t.wysiwyg.element),mt(t.wysiwyg.element),Xe(t.wysiwyg.element,t),Ge(t,t.wysiwyg.element),!e.action.includes(x.CB_GET_HISTORY)){if(t.options.render.scroll&&t.scroll.update(t),e.action.includes(x.CB_GET_FOCUSFIRST)){const i=t.wysiwyg.element.offsetTop-16;Pn(t,i,256),t.contentElement.scrollTop=i}if(e.isSyncing?el(t):(t.breadcrumb&&(t.breadcrumb.element.nextElementSibling.textContent=""),t.element.removeAttribute("disabled-forever"),nl(t,a),e.action.includes(x.CB_GET_OPENNEW)&&window.siyuan.config.editor.readOnly&&Pi(t.breadcrumb.element.parentElement.querySelector('.block__icon[data-type="readonly"]'),t)),tl(t,e.action,e.scrollAttr),e.action.includes(x.CB_GET_SETID)&&(t.block.id=t.block.rootID,t.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),t.options.defId&&(t.wysiwyg.element.querySelectorAll(`[data-id="${t.options.defId}"]`).forEach(i=>{i.classList.add("def--mark")}),t.options.defId=void 0),e.action.includes(x.CB_GET_APPEND)||e.action.includes(x.CB_GET_BEFORE)){t.app.plugins.forEach(i=>{i.eventBus.emit("loaded-protyle-dynamic",{protyle:t,position:e.action.includes(x.CB_GET_APPEND)?"afterend":"beforebegin"})});return}!t.disabled&&!e.action.includes(x.CB_GET_ALL)&&t.background.element.classList.add("protyle-background--mobileshow"),t.options.render.breadcrumb&&(t.breadcrumb.toggleExit(!e.action.includes(x.CB_GET_ALL)),t.breadcrumb.render(t)),e.afterCB&&e.afterCB(),e.scrollAttr&&!t.scroll.element.classList.contains("fn__none")&&!t.element.classList.contains("block__edit")&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&t.contentElement.scrollHeight>0&&!e.action.includes(x.CB_GET_FOCUSFIRST)&&t.contentElement.scrollHeight<=t.contentElement.clientHeight&&Se("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},i=>{Ts({data:i,protyle:t,action:[x.CB_GET_APPEND,x.CB_GET_UNCHANGEID]})}),e.scrollAttr&&!t.scroll.element.classList.contains("fn__none")&&!t.element.classList.contains("fn__none")&&t.scroll.updateIndex(t,e.scrollAttr.startId,i=>{i>1&&t.block.blockCount>1&&t.contentElement.scrollHeight<=t.contentElement.clientHeight&&Qe(window.siyuan.languages.scrollGetMore)}),t.app.plugins.forEach(i=>{i.eventBus.emit("loaded-protyle",t),i.eventBus.emit("loaded-protyle-static",{protyle:t})})}},el=e=>{mn(e),e.breadcrumb&&!re()?e.breadcrumb.element.nextElementSibling.textContent=window.siyuan.languages._kernel[81]:Qe(window.siyuan.languages._kernel[81]),e.element.setAttribute("disabled-forever","true")},mn=e=>{if(window.siyuan.menus.menu.remove(),vt(["gutter","toolbar","select","hint","util"],e),e.disabled=!0,e.title&&e.title.editElement&&(e.title.editElement.setAttribute("contenteditable","false"),e.title.editElement.style.userSelect="text"),document.getElementById("toolbarName").setAttribute("readonly","readonly"),e.background&&(e.background.element.classList.remove("protyle-background--enable"),e.background.element.classList.remove("protyle-background--mobileshow")),e.wysiwyg.element.querySelectorAll(".protyle-icons--show").forEach(t=>{t.classList.remove("protyle-icons--show")}),e.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(t=>{var n;t.classList.add("fn__none"),t.classList.contains("protyle-icon--first")&&((n=t.nextElementSibling)==null||n.classList.add("protyle-icon--first"))}),e.wysiwyg.element.style.userSelect="text",e.wysiwyg.element.setAttribute("contenteditable","false"),e.wysiwyg.element.setAttribute("data-readonly","true"),e.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(t=>{t.setAttribute("contenteditable","false")}),e.wysiwyg.element.querySelectorAll('.protyle-action[draggable="true"]').forEach(t=>{t.setAttribute("draggable","false")}),e.breadcrumb){e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconLock"),e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.tempUnlock:window.siyuan.languages.unlockEdit);const t=e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');t&&!t.classList.contains("fn__none")&&(t.classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.add("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.add("fn__none"))}ca()},Ds=e=>{if(e.element.getAttribute("disabled-forever")==="true")return;e.disabled=!1,re()?document.getElementById("toolbarName").removeAttribute("readonly"):(e.wysiwyg.element.setAttribute("contenteditable","true"),e.wysiwyg.element.style.userSelect=""),e.wysiwyg.element.setAttribute("data-readonly","false"),e.title&&e.title.editElement&&(e.title.editElement.setAttribute("contenteditable","true"),e.title.editElement.style.userSelect=""),e.background&&e.background.element.classList.add("protyle-background--enable"),e.wysiwyg.element.querySelectorAll(".render-node .protyle-action__edit").forEach(n=>{var a;n.classList.remove("fn__none"),n.classList.contains("protyle-icon--first")&&((a=n.nextElementSibling)==null||a.classList.remove("protyle-icon--first"))}),e.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{B(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),e.wysiwyg.element.querySelectorAll('.protyle-action[draggable="false"]').forEach(n=>{n.setAttribute("draggable","true")});const t=e.contentElement.getBoundingClientRect();if(e.wysiwyg.element.querySelectorAll(".av").forEach(n=>{n.querySelector(".av__title")&&bn(n,t,"all")}),e.breadcrumb){e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconUnlock"),e.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.cancelTempUnlock:window.siyuan.languages.lockEdit);const n=e.breadcrumb.element.parentElement.querySelector('[data-type="undo"]');n&&n.classList.contains("fn__none")&&(n.classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="redo"]').classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="indent"]').classList.remove("fn__none"),e.breadcrumb.element.parentElement.querySelector('[data-type="outdent"]').classList.remove("fn__none"))}ca()},tl=(e,t,n)=>{var a;let i;if(n&&n.focusId?i=e.wysiwyg.element.querySelector(`[data-node-id="${n.focusId}"]`):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${e.block.id}"]`)).find(o=>{if(!O(o,"data-type","block-render",!0))return i=o,!0}),e.block.mode===4?(Pn(e),i=e.wysiwyg.element.lastElementChild):(!i||t.includes(x.CB_GET_FOCUSFIRST))&&(i=e.wysiwyg.element.firstElementChild),t.includes(x.CB_GET_HL)&&(Pn(e),Jt(i)),t.includes(x.CB_GET_FOCUS)||t.includes(x.CB_GET_FOCUSFIRST)){let o;n&&n.focusId?o=ma(i,n.focusStart,n.focusEnd):Je(i)}const s=n&&typeof n.scrollTop=="number";if(s&&(e.contentElement.scrollTop=n.scrollTop),(a=e.observerLoad)==null||a.disconnect(),t.includes(x.CB_GET_FOCUS)||t.includes(x.CB_GET_SCROLL)||t.includes(x.CB_GET_HL)||t.includes(x.CB_GET_FOCUSFIRST)){const o=e.contentElement.getBoundingClientRect(),l=i.getBoundingClientRect();!s&&(o.top>l.top||o.bottom<l.bottom)&&Bn(e,i,!0)}else return;e.observerLoad=new ResizeObserver(()=>{if(s&&(e.contentElement.scrollTop=n.scrollTop),t.includes(x.CB_GET_FOCUS)||t.includes(x.CB_GET_HL)||t.includes(x.CB_GET_FOCUSFIRST)){const o=e.contentElement.getBoundingClientRect(),l=i.getBoundingClientRect();!s&&(o.top>l.top||o.bottom<l.bottom)&&Bn(e,i,!0)}}),e.observerLoad.observe(e.wysiwyg.element),e.observer.unobserve(e.wysiwyg.element),setTimeout(()=>{e.observerLoad.disconnect(),e.observer.observe(e.wysiwyg.element)},1e3*3),i.isSameNode(e.wysiwyg.element.firstElementChild)&&!s&&e.observerLoad.disconnect()},nl=(e,t)=>{let n=window.siyuan.config.readonly?"true":"false";t?n==="false"&&(n=window.siyuan.config.editor.readOnly?"true":"false",n==="false"&&(n=e.wysiwyg.element.getAttribute(x.CUSTOM_SY_READONLY))):n=e.disabled?"true":"false",n==="true"?mn(e):Ds(e)},ju=(e,t)=>{e.block.showAll=!0;let n="";t.forEach(a=>{n+=Hs(a.blockPaths,!1,t.length)+$s(a.dom,a.expand)}),e.wysiwyg.element.innerHTML=n,processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element),removeLoading(e),(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&disabledProtyle(e)},Ms=(e,t)=>{t.firstElementChild.classList.contains("li")?e?t.querySelectorAll(".li .li").forEach(n=>{n.childElementCount>3&&n.setAttribute("fold","1")}):t.firstElementChild.setAttribute("fold","1"):t.firstElementChild.getAttribute("data-type")==="NodeHeading"&&Array.from(t.children).forEach((n,a)=>{(e&&a>2||!e&&a>1)&&((e&&a===3||!e&&a===2)&&n.insertAdjacentHTML("beforebegin",'<div style="max-width: 100%;justify-content: center;" contenteditable="false" class="protyle-breadcrumb__item"><svg><use xlink:href="#iconMore"></use></svg></div>'),n.classList.add("fn__none"))})},$s=(e,t)=>{const n=document.createElement("template");return n.innerHTML=e,Ms(t,n.content),n.innerHTML},Vu=(e,t)=>{fetchPost("/api/filetree/getDoc",{id:t.getAttribute("data-id"),size:Constants.SIZE_GET_MAX},n=>{t.parentElement.querySelector(".protyle-breadcrumb__item--active").classList.remove("protyle-breadcrumb__item--active"),t.classList.add("protyle-breadcrumb__item--active");let a=t.parentElement.nextElementSibling;for(;a&&!a.classList.contains("protyle-breadcrumb__bar");){const i=a;a=a.nextElementSibling,i.remove()}t.parentElement.insertAdjacentHTML("afterend",$s(n.data.content,!0)),processRender(t.parentElement.parentElement),avRender(t.parentElement.parentElement,e),blockRender(e,t.parentElement.parentElement),n.data.isSyncing?disabledForeverProtyle(e):window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?disabledProtyle(e):t.parentElement.parentElement.classList.contains("protyle-wysiwyg__embed")&&t.parentElement.parentElement.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(i=>{i.setAttribute("contenteditable","false")})})},Gu=e=>{let t=e.nextElementSibling;for(;t&&!t.classList.contains("protyle-breadcrumb__bar");)t.classList.remove("fn__none"),t=t.nextElementSibling;e.remove()},Hs=(e,t,n)=>{if(1>e.length)return`<div contenteditable="false" style="border-top: ${n===1?0:1}px solid var(--b3-border-color);min-height: 0;width: 100%;" class="protyle-breadcrumb__bar"><span></span></div>`;let a="";return e.forEach((i,s)=>{s===0&&!t||(a+=`<span class="protyle-breadcrumb__item${s===e.length-1?" protyle-breadcrumb__item--active":""}" data-id="${i.id}">
    <svg class="popover__block" data-id="${i.id}"><use xlink:href="#${Sa(i.type,i.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${i.name}">${i.name}</span>
</span>`,s!==e.length-1&&(a+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>'))}),`<div contenteditable="false" style="margin-bottom: 8px" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap">${a}</div>`},Ge=(e,t,n)=>{let a=[];t.getAttribute("data-type")==="NodeBlockQueryEmbed"?a=[t]:a=Array.from(t.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),a.length!==0&&a.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.setAttribute("data-render","true"),i.style.height=i.clientHeight-8+"px",i.innerHTML=`<div class="protyle-icons${V(i)?" fn__none":""}">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.update} SQL" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>${i.lastElementChild.outerHTML}`;const s=Lute.UnEscapeHTMLStr(i.getAttribute("data-content"));let o=i.getAttribute("breadcrumb");if(o?o=o==="true":o=window.siyuan.config.editor.embedBlockBreadcrumb,st(i,"sb")&&(o=!1),s.startsWith("//!js"))try{const r=new Function("fetchSyncPost","item","protyle","top",s)(yl,i,e,n);if(r instanceof Promise)r.then(d=>{if(Array.isArray(d))Se("/api/search/getEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),includeIDs:d,headingMode:i.getAttribute("custom-heading-mode")==="1"?1:0,breadcrumb:o},c=>{Yt(c.data.blocks||[],e,i,n)});else return}).catch(()=>{Yt([],e,i,n)});else if(Array.isArray(r))Se("/api/search/getEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),includeIDs:r,headingMode:i.getAttribute("custom-heading-mode")==="1"?1:0,breadcrumb:o},d=>{Yt(d.data.blocks||[],e,i,n)});else return}catch(r){Yt([],e,i,n)}else Se("/api/search/searchEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),stmt:s,headingMode:i.getAttribute("custom-heading-mode")==="1"?1:0,excludeIDs:[i.getAttribute("data-node-id"),e.block.rootID],breadcrumb:o},r=>{Yt(r.data.blocks,e,i,n)})})},Yt=(e,t,n,a)=>{const i=n.querySelector(".fn__rotate");i&&i.classList.remove("fn__rotate");let s="";e.forEach(r=>{let d="";r.blockPaths.length!==0&&(d=Hs(r.blockPaths,!0)),s+=`<div class="protyle-wysiwyg__embed" data-id="${r.block.id}">${d}${r.block.content}</div>`}),e.length>0?n.lastElementChild.insertAdjacentHTML("beforebegin",s+`<div style="position: absolute;">${x.ZWSP}</div>`):n.lastElementChild.insertAdjacentHTML("beforebegin",`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>
<div style="position: absolute;">${x.ZWSP}</div>`),_t(n),mt(n),Xe(n,t),a&&(t.contentElement.scrollTop=a);let o=0,l=n;for(;o<4&&l;)l=O(l.parentElement,"data-type","NodeBlockQueryEmbed"),o++;o<4&&n.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(r=>{Ge(t,r)}),n.style.height=""},zu=(e=!1)=>{};let al,sl;const Ku=(e,t)=>{},il=(e,t,n=!1)=>{},Zu=()=>{al="",document.querySelector("#status .status__counter").innerHTML="",clearTimeout(sl)},Xu=e=>{if(!e)return;let t=`<span class="ft__on-surface">${window.siyuan.languages.runeCount}</span>&nbsp;${e.runeCount}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.wordCount}</span>&nbsp;${e.wordCount}<span class="fn__space"></span>`;0<e.linkCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.linkCount}</span>&nbsp;${e.linkCount}<span class="fn__space"></span>`),0<e.imageCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.imgCount}</span>&nbsp;${e.imageCount}<span class="fn__space"></span>`),0<e.refCount&&(t+=`<span class="ft__on-surface">${window.siyuan.languages.refCount}</span>&nbsp;${e.refCount}<span class="fn__space"></span>`),document.querySelector("#status .status__counter").innerHTML=t};var ol=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())}),ll=(e,t,n)=>(t=e[Symbol.asyncIterator],n=(a,i)=>(i=e[a])&&(t[a]=s=>new Promise((o,l,r)=>(s=i.call(e,s),r=s.done,Promise.resolve(s.value).then(d=>o({value:d,done:r}),l)))),t?t.call(e):(e=e[Symbol.iterator](),t={},n("next"),n("return"),t));const Ns=(e,t)=>{const n=Pe(e),a=[];if(n.isSameNode(e)||(e.remove(),a.push({action:"delete",id:n.getAttribute("data-node-id")})),n.remove(),t.block.rootID===t.block.id&&t.wysiwyg.element.childElementCount===0){const i=Lute.NewNodeID(),s=ta(!1,!1,i);a.push({action:"insert",data:s.outerHTML,id:i,parentID:t.block.parentID}),t.wysiwyg.element.innerHTML=s.outerHTML}a.length>0&&pt(t,a,[])},Bs=()=>{if(window.siyuan.transactions.length===0)return;const e=window.siyuan.transactions[0].protyle,t=window.siyuan.transactions[0].doOperations,n=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),Se("/api/transactions",{session:e.id,app:x.SIYUAN_APPID,transactions:[{doOperations:t,undoOperations:n}]},a=>{window.siyuan.transactions.length===0?il([],e.block.rootID,!0):Bs(),(window.siyuan.config.sync.provider!==0&&mi()||window.siyuan.config.sync.provider===0&&!pi(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none");let i;if(getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0)),a.data[0].doOperations.forEach(s=>{if(s.action==="unfoldHeading"||s.action==="foldHeading"){Fs(s,e);return}if(s.action==="update"){e.options.backlinkData&&(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(o=>{V(o)||i&&(o.isSameNode(i.startContainer)||o.contains(i.startContainer))||(o.outerHTML=s.data.replace("<wbr>",""))}),_t(e.wysiwyg.element),mt(e.wysiwyg.element),Xe(e.wysiwyg.element,e),Ge(e,e.wysiwyg.element)),ua(e,s);return}if(s.action==="delete"||s.action==="append"){e.options.backlinkData&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(o=>{V(o)||o.remove()}),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${s.id}"]`)&&(o.removeAttribute("data-render"),Ge(e,o))}),vt(["gutter"],e);return}if(s.action==="move"){if(e.options.backlinkData){const o=[];Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(r=>{if(!V(r)){o.push(r);return}});let l=!1;s.previousID&&o.length>0?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(r=>{V(r)||(r.after(pe(o[0].cloneNode(!0))),l=!0)}):o.length>0&&Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(r=>{var d;V(r)||((d=r.firstElementChild)!=null&&d.classList.contains("protyle-action")?r.firstElementChild.after(pe(o[0].cloneNode(!0))):r.prepend(pe(o[0].cloneNode(!0))),l=!0)}),o.forEach(r=>{l?r.remove():!l&&r.parentElement&&Ns(r,e)})}e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${s.id}"]`)&&(o.removeAttribute("data-render"),Ge(e,o))});return}if(s.action==="insert"&&e.options.backlinkData){const o=[];s.previousID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(l=>{var r;((r=l.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"))!==s.id&&!O(l,"data-node-id",s.id)&&!V(l)&&(l.insertAdjacentHTML("afterend",s.data),o.push(l.nextElementSibling))}):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(l=>{V(l)||(l.firstElementChild&&l.firstElementChild.classList.contains("protyle-action")&&l.firstElementChild.nextElementSibling.getAttribute("data-node-id")!==s.id?(l.firstElementChild.insertAdjacentHTML("afterend",s.data),o.push(l.firstElementChild.nextElementSibling)):l.firstElementChild&&l.firstElementChild.getAttribute("data-node-id")!==s.id&&(l.insertAdjacentHTML("afterbegin",s.data),o.push(l.firstElementChild)))}),e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(l=>{l.lastElementChild.getAttribute("spin")==="1"&&l.lastElementChild.remove()}),o.forEach(l=>{_t(l),mt(l),Xe(l,e),Ge(e,l);const r=l.querySelector("wbr");r&&r.remove()})}}),e.wysiwyg.element.childElementCount===0&&!e.block.showAll){const s=Lute.NewNodeID(),o=ta(!1,!0,s);e.wysiwyg.element.insertAdjacentElement("afterbegin",o),pt(e,[{action:"insert",data:o.outerHTML,id:s,parentID:e.block.parentID}]),Kt(o,i)}})},ua=(e,t)=>{let n=!1;e.wysiwyg.element.querySelectorAll(`[data-type="NodeBlockQueryEmbed"] [data-node-id="${t.id}"]`).forEach(a=>{const i=document.createElement("div");i.innerHTML=t.data,i.querySelectorAll('[contenteditable="true"]').forEach(o=>{o.setAttribute("contenteditable","false")});const s=i.querySelector("wbr");s&&s.remove(),a.outerHTML=i.innerHTML,n=!0}),n&&(_t(e.wysiwyg.element),mt(e.wysiwyg.element),Xe(e.wysiwyg.element,e))},Ps=(e,t,n,a)=>{a&&focusSideBlock(e[0]),e.forEach(i=>{const s=getTopAloneElement(i);s&&s.remove()}),n.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(i=>{i.querySelector(`[data-node-id="${t}"]`)&&(i.removeAttribute("data-render"),blockRender(n,i))})},Rs=(e,t,n,a)=>{e.forEach(s=>{s.getAttribute("data-subtype")==="echarts"?s.outerHTML=t.lute.SpinBlockDOM(n.data):s.outerHTML=n.data}),Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${n.id}"]`)).find(s=>{if(!isInEmbedBlock(s))return e[0]=s,!0});const i=e[0].querySelector("wbr");if(a){const s=getEditorRange(e[0]);i?focusByWbr(e[0],s):focusBlock(e[0])}else i&&i.remove();processRender(e.length===1?e[0]:t.wysiwyg.element),highlightRender(e.length===1?e[0]:t.wysiwyg.element),avRender(e.length===1?e[0]:t.wysiwyg.element,t),blockRender(t,e.length===1?e[0]:t.wysiwyg.element),ua(t,n)},Ju=(e,t,n)=>{var a,i;const s=[];if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(o=>{isInEmbedBlock(o)||s.push(o)}),t.action==="setAttrs"){e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(o=>{JSON.parse(t.data).fold==="1"?o.setAttribute("fold","1"):o.removeAttribute("fold")});return}if(t.action==="unfoldHeading"){const o=e.contentElement.scrollTop;e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(l=>{if(l.removeAttribute("fold"),n)return;const r=isInEmbedBlock(l);if(r){r.removeAttribute("data-render"),blockRender(e,r);return}t.retData&&(Os(t.retData,e),l.insertAdjacentHTML("afterend",t.retData)),t.data==="remove"&&l.remove()}),t.retData&&(e.disabled&&disabledProtyle(e),processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element),e.contentElement.scrollTop=o,e.scroll.lastScrollTop=o);return}if(t.action==="foldHeading"){if(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(o=>{o.setAttribute("fold","1"),t.retData||removeFoldHeading(o)}),n)return;t.retData&&(t.retData.forEach(o=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${o}"]`).forEach(l=>{l.remove()})}),e.wysiwyg.element.childElementCount===0&&zoomOut({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id}));return}if(t.action==="delete"){s.length>0?Ps(s,t.id,e,n):n&&zoomOut({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id,callback(){Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(o=>{isInEmbedBlock(o)||s.push(o)}),Ps(s,t.id,e,n)}});return}if(t.action==="update"){s.length>0?Rs(s,e,t,n):n?zoomOut({protyle:e,id:e.block.rootID,isPushBack:!1,focusId:t.id,callback(){Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).forEach(o=>{isInEmbedBlock(o)||s.push(o)}),Rs(s,e,t,n)}}):ua(e,t);return}if(t.action==="updateAttrs"){const o=t.data,l={};let r="",d="",c="",u="",f="";Object.keys(o.new).forEach(p=>{l[p]=o.new[p];const m=Lute.EscapeHTMLStr(o.new[p]);p==="bookmark"?r=`<div class="protyle-attr--bookmark">${m}</div>`:p==="name"?d=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${m}</div>`:p==="alias"?c=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${m}</div>`:p==="memo"?u=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${m}"><svg><use xlink:href="#iconM"></use></svg></div>`:p==="custom-avs"&&o.new["av-names"]&&(f=`<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg>${o.new["av-names"]}</div>`)});let g=r+d+c+u+f;if(e.block.rootID===t.id){if(e.title){o.new["custom-avs"]&&!o.new["av-names"]&&(g+=((a=e.title.element.querySelector(".protyle-attr--av"))==null?void 0:a.outerHTML)||"");const p=e.title.element.querySelector(".protyle-attr--refcount");p&&(g+=p.outerHTML),o.new[Constants.CUSTOM_RIFF_DECKS]&&o.new[Constants.CUSTOM_RIFF_DECKS]!==o.old[Constants.CUSTOM_RIFF_DECKS]?(e.title.element.style.animation="addCard 450ms linear",e.title.element.setAttribute(Constants.CUSTOM_RIFF_DECKS,o.new[Constants.CUSTOM_RIFF_DECKS]),setTimeout(()=>{e.title.element.style.animation=""},450)):o.new[Constants.CUSTOM_RIFF_DECKS]||e.title.element.removeAttribute(Constants.CUSTOM_RIFF_DECKS),e.title.element.querySelector(".protyle-attr").innerHTML=g}if(e.wysiwyg.renderCustom(l),o.new[Constants.CUSTOM_SY_FULLWIDTH]!==o.old[Constants.CUSTOM_SY_FULLWIDTH]&&resize(e),o.new[Constants.CUSTOM_SY_READONLY]!==o.old[Constants.CUSTOM_SY_READONLY]){let p=o.new[Constants.CUSTOM_SY_READONLY];p||(p=window.siyuan.config.editor.readOnly?"true":"false"),p==="true"?disabledProtyle(e):enableProtyle(e)}o.new.icon!==o.old.icon&&window.siyuan.mobile.editor.protyle.background.ial.icon!==o.new.icon&&(window.siyuan.mobile.editor.protyle.background.ial.icon=o.new.icon,window.siyuan.mobile.editor.protyle.background.render(window.siyuan.mobile.editor.protyle.background.ial,window.siyuan.mobile.editor.protyle.block.rootID));return}e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(p=>{var m;if(p.getAttribute("data-type")==="NodeThematicBreak")return;Object.keys(o.old).forEach(v=>{p.removeAttribute(v)}),o.new.style&&o.new[Constants.CUSTOM_RIFF_DECKS]&&o.new[Constants.CUSTOM_RIFF_DECKS]!==o.old[Constants.CUSTOM_RIFF_DECKS]&&(o.new.style+=";animation:addCard 450ms linear"),Object.keys(o.new).forEach(v=>{p.setAttribute(v,o.new[v]),v===Constants.CUSTOM_RIFF_DECKS&&o.new[Constants.CUSTOM_RIFF_DECKS]!==o.old[Constants.CUSTOM_RIFF_DECKS]&&(p.style.animation="addCard 450ms linear",setTimeout(()=>{p.parentElement?p.style.animation="":e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`).forEach(b=>{b.style.animation=""})},450))}),o.new["custom-avs"]&&!o.new["av-names"]&&(g+=((m=p.lastElementChild.querySelector(".protyle-attr--av"))==null?void 0:m.outerHTML)||"");const y=p.lastElementChild.querySelector(".protyle-attr--refcount");y&&(g+=y.outerHTML),p.lastElementChild.innerHTML=g+Constants.ZWSP});return}if(t.action==="move"){let o;n&&getSelection().rangeCount>0&&(o=getSelection().getRangeAt(0),o.insertNode(document.createElement("wbr")));let l=!1;t.previousID&&s.length>0?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`)).forEach(r=>{isInEmbedBlock(r)||(r.after(processClonePHElement(s[0].cloneNode(!0))),l=!0)}):s.length>0&&(!e.options.backlinkData&&t.parentID===e.block.parentID?(e.wysiwyg.element.prepend(processClonePHElement(s[0].cloneNode(!0))),l=!0):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`)).forEach(r=>{var d;isInEmbedBlock(r)||((d=r.firstElementChild)!=null&&d.classList.contains("protyle-action")?r.firstElementChild.after(processClonePHElement(s[0].cloneNode(!0))):r.prepend(processClonePHElement(s[0].cloneNode(!0))),l=!0)})),s.forEach(r=>{l?r.remove():!l&&r.parentElement&&Ns(r,e)}),n&&o&&(t.data==="focus"?(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).find(r=>{if(!isInEmbedBlock(r))return focusBlock(r),!0}),(i=document.querySelector("wbr"))==null||i.remove()):focusByWbr(e.wysiwyg.element,o)),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(r=>{r.querySelector(`[data-node-id="${t.id}"],[data-node-id="${t.parentID}"],[data-node-id="${t.previousID}"]`)&&(r.removeAttribute("data-render"),blockRender(e,r))});return}if(t.action==="insert"){const o=[];if(t.previousID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.previousID}"]`)).forEach(l=>{const r=isInEmbedBlock(l);r?(r.removeAttribute("data-render"),blockRender(e,r)):(l.insertAdjacentHTML("afterend",t.data),o.push(l.nextElementSibling))}):t.nextID?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.nextID}"]`)).forEach(l=>{const r=isInEmbedBlock(l);r?(r.removeAttribute("data-render"),blockRender(e,r)):(l.insertAdjacentHTML("beforebegin",t.data),o.push(l.previousElementSibling))}):!e.options.backlinkData&&t.parentID===e.block.parentID?(e.wysiwyg.element.insertAdjacentHTML("afterbegin",t.data),o.push(e.wysiwyg.element.firstElementChild)):Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.parentID}"]`)).forEach(l=>{var r;isInEmbedBlock(l)||((r=l.firstElementChild)!=null&&r.classList.contains("protyle-action")?(l.firstElementChild.insertAdjacentHTML("afterend",t.data),o.push(l.firstElementChild.nextElementSibling)):(l.insertAdjacentHTML("afterbegin",t.data),o.push(l.firstElementChild)))}),e.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(l=>{l.lastElementChild.getAttribute("spin")==="1"&&l.lastElementChild.remove()}),o.length===0)return;o.forEach(l=>{processRender(l),highlightRender(l),avRender(l,e),blockRender(e,l);const r=l.querySelector("wbr");if(n){const d=getEditorRange(l);r?focusByWbr(l,d):focusBlock(l)}else r&&r.remove()});return}if(t.action==="append"){e.options.backlinkData||reloadProtyle(e,!1);return}if(["addAttrViewCol","insertAttrViewBlock","updateAttrViewCol","updateAttrViewColOptions","updateAttrViewColOption","updateAttrViewCell","sortAttrViewRow","sortAttrViewCol","setAttrViewColHidden","setAttrViewColWrap","setAttrViewColWidth","removeAttrViewColOption","setAttrViewName","setAttrViewFilters","setAttrViewSorts","setAttrViewColCalc","removeAttrViewCol","updateAttrViewColNumberFormat","removeAttrViewBlock","replaceAttrViewBlock","updateAttrViewColTemplate","setAttrViewColPin","addAttrViewView","setAttrViewColIcon","removeAttrViewView","setAttrViewViewName","setAttrViewViewIcon","duplicateAttrViewView","sortAttrViewView","updateAttrViewColRelation","setAttrViewPageSize","updateAttrViewColRollup","sortAttrViewKey","duplicateAttrViewKey"].includes(t.action)){refreshAV(e,t);return}if(t.action==="doUpdateUpdated"){s.forEach(o=>{o.setAttribute("updated",t.data)});return}},Qu=e=>{let t;const n=Lute.NewNodeID();if(e.type==="BlocksMergeSuperBlock")t=genSBElement(e.level,n);else if(e.type==="Blocks2Blockquote")t=document.createElement("div"),t.classList.add("bq"),t.setAttribute("data-node-id",n),t.setAttribute("data-type","NodeBlockquote"),t.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(e.type.endsWith("Ls")){t=document.createElement("div"),t.classList.add("list"),t.setAttribute("data-node-id",n),t.setAttribute("data-type","NodeList"),e.type==="Blocks2ULs"?t.setAttribute("data-subtype","u"):e.type==="Blocks2OLs"?t.setAttribute("data-subtype","o"):t.setAttribute("data-subtype","t");let r="";e.selectsElement.forEach((d,c)=>{e.type==="Blocks2ULs"?r+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:e.type==="Blocks2OLs"?r+=`<div data-marker="${c+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${c+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:r+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`}),t.innerHTML=r+'<div class="protyle-attr" contenteditable="false"></div>'}const a=e.selectsElement[0].getAttribute("data-node-id"),i=e.selectsElement[0].parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,s=[{action:"insert",id:n,data:t.outerHTML,nextID:a,parentID:i}],o=[];e.selectsElement[0].previousElementSibling?e.selectsElement[0].before(t):e.selectsElement[0].parentElement.prepend(t);let l;e.selectsElement.forEach((r,d)=>{r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end");const c=r.getAttribute("data-node-id");o.push({action:"move",id:c,previousID:l||n,parentID:i}),e.type.endsWith("Ls")?(s.push({action:"move",id:c,parentID:t.children[d].getAttribute("data-node-id")}),t.children[d].firstElementChild.after(r)):(s.push({action:"move",id:c,previousID:l,parentID:n}),t.lastElementChild.before(r)),l=r.getAttribute("data-node-id"),d===e.selectsElement.length-1&&o.push({action:"delete",id:n}),r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),blockRender(e.protyle,r))}),pt(e.protyle,s,o),focusBlock(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.selectsElement[0].getAttribute("data-node-id")}"]`)),hideElements(["gutter"],e.protyle)},Os=(e,t)=>{const n=document.createElement("template");n.innerHTML=e,Array.from(n.content.children).forEach(a=>{var i;(i=t.wysiwyg.element.querySelector(`:scope > [data-node-id="${a.getAttribute("data-node-id")}"]`))==null||i.remove()})},ef=e=>{let t=e.selectsElement,n;if(e.nodeElement){n=getSelection().getRangeAt(0),n.insertNode(document.createElement("wbr")),t=Array.from(e.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),t.length===0&&(t=[e.nodeElement]);let l=!1,r=!1,d=!1;if(t.find((c,u)=>{if(c.classList.contains("li"))return d=!0,!0;if((c.classList.contains("bq")||c.classList.contains("sb")||c.classList.contains("p"))&&(r=!0),c.nextElementSibling&&t[u+1]&&c.nextElementSibling.isSameNode(t[u+1]))l=!0;else if(u!==t.length-1)return l=!1,!0}),d||r&&e.type==="Blocks2Ps")return;t.length===1&&e.type==="Blocks2Hs"&&t[0].getAttribute("data-type")==="NodeHeading"&&e.level===parseInt(t[0].getAttribute("data-subtype").substr(1))&&(e.type="Blocks2Ps"),e.isContinue=l}let a="";const i=[],s=[],o=document.createElement("div");t.forEach((l,r)=>{var d,c,u;(e.type==="Blocks2Ps"||e.type==="Blocks2Hs")&&l.getAttribute("data-type")==="NodeHeading"&&l.getAttribute("fold")==="1"&&setFold(e.protyle,l,void 0,void 0,!1),l.classList.remove("protyle-wysiwyg--select"),l.removeAttribute("select-start"),l.removeAttribute("select-end"),a+=l.outerHTML;const f=l.getAttribute("data-node-id");s.push({action:"update",id:f,data:l.outerHTML,parentID:((d=l.parentElement)==null?void 0:d.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID,previousID:((c=s[s.length-1])==null?void 0:c.id)||((u=l.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"))}),e.isContinue?r===t.length-1?(o.innerHTML=e.protyle.lute[e.type](a,e.level),l.outerHTML=o.innerHTML):l.remove():l.outerHTML=e.protyle.lute[e.type](l.outerHTML,e.level)}),s.forEach(l=>{const r=e.protyle.wysiwyg.element.querySelector(`[data-node-id="${l.id}"]`);r?i.push({action:"update",id:l.id,data:r.outerHTML}):(l.action="insert",i.push({action:"delete",id:l.id}))}),Array.from(o.children).forEach(l=>{var r,d;const c=l.getAttribute("data-node-id");let u=!1;s.find(f=>{if(c===f.id)return u=!0,!0}),u||(i.push({action:"insert",id:c,previousID:((r=l.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"))||s[0].previousID,data:l.outerHTML,parentID:((d=l.parentElement)==null?void 0:d.getAttribute("data-node-id"))||e.protyle.block.parentID||e.protyle.block.rootID}),s.splice(0,0,{action:"delete",id:c}))}),pt(e.protyle,i,s),processRender(e.protyle.wysiwyg.element),highlightRender(e.protyle.wysiwyg.element),avRender(e.protyle.wysiwyg.element,e.protyle),blockRender(e.protyle,e.protyle.wysiwyg.element),n||e.range?focusByWbr(e.protyle.wysiwyg.element,n||e.range):focusBlock(e.protyle.wysiwyg.element.querySelector(`[data-node-id="${t[0].getAttribute("data-node-id")}"]`)),hideElements(["gutter"],e.protyle)},tf=e=>ol(void 0,null,function*(){var t,n;if(e.nodeElement.querySelector("wbr")||(t=getContenteditableElement(e.nodeElement))==null||t.insertAdjacentHTML("afterbegin","<wbr>"),e.type==="CancelList"||e.type==="CancelBlockquote")try{for(var a=ll(e.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]')),i,s,o;i=!(s=yield a.next()).done;i=!1){const u=s.value,f=u.getAttribute("data-node-id");u.removeAttribute("fold");const g=yield fetchSyncPost("/api/transactions",{session:e.protyle.id,app:Constants.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:f}],undoOperations:[{action:"foldHeading",id:f}]}]});e.protyle.undo.add([{action:"unfoldHeading",id:f}],[{action:"foldHeading",id:f}],e.protyle),u.insertAdjacentHTML("afterend",g.data[0].doOperations[0].retData)}}catch(u){o=[u]}finally{try{i&&(s=a.return)&&(yield s.call(a))}finally{if(o)throw o[0]}}const l=e.nodeElement.outerHTML,r=(n=e.nodeElement.previousElementSibling)==null?void 0:n.getAttribute("data-node-id"),d=e.nodeElement.parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,c=e.protyle.lute[e.type](e.nodeElement.outerHTML,e.level);if(e.nodeElement.outerHTML=c,e.type==="CancelList"||e.type==="CancelBlockquote"){const u=document.createElement("template");u.innerHTML=c;const f=[{action:"delete",id:e.id}],g=[];let p=r;Array.from(u.content.children).forEach(m=>{const y=m.getAttribute("data-node-id");f.push({action:"insert",data:m.outerHTML,id:y,previousID:p,parentID:d}),g.push({action:"delete",id:y}),p=y}),g.push({action:"insert",data:l,id:e.id,previousID:r,parentID:d}),pt(e.protyle,f,g)}else Lt(e.protyle,e.id,c,l);focusByWbr(e.protyle.wysiwyg.element,getEditorRange(e.protyle.wysiwyg.element)),e.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(u=>{u.textContent===""&&fetchPost("/api/block/getRefText",{id:u.getAttribute("data-id")},f=>{u.innerHTML=f.data})}),blockRender(e.protyle,e.protyle.wysiwyg.element),processRender(e.protyle.wysiwyg.element),highlightRender(e.protyle.wysiwyg.element),avRender(e.protyle.wysiwyg.element,e.protyle)});let qs;const pt=(e,t,n)=>{if(t.length===0)return;if(!e){Se("/api/transactions",{session:x.SIYUAN_APPID,app:x.SIYUAN_APPID,transactions:[{doOperations:t}]});return}const a=window.siyuan.transactions[window.siyuan.transactions.length-1];let i=!1;const s=new Date().getTime();if(a&&a.doOperations.length===1&&a.doOperations[0].action==="update"&&t.length===1&&t[0].action==="update"&&a.doOperations[0].id===t[0].id&&e.transactionTime-s<x.TIMEOUT_INPUT&&(i=!0),e.wysiwyg.lastHTMLs={},n&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.model&&e.model.headElement.classList.remove("item--unupdate"),e.updated=!0,i?e.undo.replace(t,e):e.undo.add(t,n,e)),window.clearTimeout(qs),t.length===1&&(t[0].action==="unfoldHeading"||t[0].action==="setAttrs"&&t[0].data.startsWith('{"fold":'))){e.transactionTime=s+x.TIMEOUT_INPUT*2,Se("/api/transactions",{session:e.id,app:x.SIYUAN_APPID,transactions:[{doOperations:t,undoOperations:n}]},o=>{o.data[0].doOperations.forEach(l=>{if(l.action==="unfoldHeading"||l.action==="foldHeading")Fs(l,e);else if(l.action==="setAttrs"){const r=e.gutter.element.querySelector('[data-type="fold"]');r&&r.removeAttribute("disabled"),e.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(d=>{d.querySelector(`[data-node-id="${l.id}"]`)&&(d.removeAttribute("data-render"),Ge(e,d))})}})});return}i?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=e,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=t):window.siyuan.transactions.push({protyle:e,doOperations:t,undoOperations:n}),e.transactionTime=s,qs=window.setTimeout(()=>{Bs()},x.TIMEOUT_INPUT*2),t.find(o=>{var l;if(o.action==="insert")return(l=e.observerLoad)==null||l.disconnect(),!0})},Fs=(e,t)=>{if(e.action==="unfoldHeading"||e.action==="foldHeading"){const n=t.gutter.element.querySelector('[data-type="fold"]');if(n&&n.removeAttribute("disabled"),e.action==="unfoldHeading"){const a=t.contentElement.scrollTop;t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(i=>{const s=V(i);if(s){s.removeAttribute("data-render"),Ge(t,s);return}if(i.lastElementChild.classList.contains("protyle-attr")||i.lastElementChild.remove(),Os(e.retData,t),i.insertAdjacentHTML("afterend",e.retData),e.data==="remove"){const o=getSelection();o.rangeCount>0&&i.contains(o.getRangeAt(0).startContainer)&&Je(i.nextElementSibling,void 0,!0),i.remove()}}),t.disabled&&mn(t),_t(t.wysiwyg.element),mt(t.wysiwyg.element),Xe(t.wysiwyg.element,t),Ge(t,t.wysiwyg.element),t.contentElement.scrollTop=a,t.scroll.lastScrollTop=a;return}t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(a=>{const i=V(a);i&&(i.removeAttribute("data-render"),Ge(t,i))}),t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.scrollHeight-t.contentElement.scrollTop<t.contentElement.clientHeight*2&&Se("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{Ts({data:a,protyle:t,action:[x.CB_GET_APPEND,x.CB_GET_UNCHANGEID]})});return}},Lt=(e,t,n,a)=>{n!==a&&pt(e,[{id:t,data:n,action:"update"}],[{id:t,data:a,action:"update"}])},rl=(e,t,n)=>{const a=[],i=[];e.forEach(s=>{const o=s.getAttribute("data-node-id");s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end"),i.push({action:"update",id:o,data:s.outerHTML}),n(s),a.push({action:"update",id:o,data:s.outerHTML})}),pt(t,a,i)},nf=(e,t)=>{const n=hasClosestByClassName(e,"av__row");if(!n)return;const a=e.querySelector("use");n.classList.contains("av__row--header")||t==="unselectAll"?a.getAttribute("xlink:href")==="#iconCheck"||t==="unselectAll"?n.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconUncheck");const s=hasClosestByClassName(i,"av__row");s&&s.classList.remove("av__row--select")}):n.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconCheck");const s=hasClosestByClassName(i,"av__row");s&&s.classList.add("av__row--select")}):t==="select"||a.getAttribute("xlink:href")==="#iconUncheck"&&t==="toggle"?(n.classList.add("av__row--select"),a.setAttribute("xlink:href","#iconCheck")):(t==="unselect"||a.getAttribute("xlink:href")==="#iconCheck"&&t==="toggle")&&(n.classList.remove("av__row--select"),a.setAttribute("xlink:href","#iconUncheck")),focusBlock(hasClosestBlock(n)),fa(n)},fa=e=>{const t=R(e);if(!t)return;const n=e.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").length,a=e.parentElement.childElementCount-3-n,i=e.parentElement.firstElementChild,s=i.querySelector("use"),o=t.querySelector(".av__counter"),l=t.querySelector(".av__header");if(a===0&&e.parentElement.childElementCount-3!==0)i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconCheck");else if(a===e.parentElement.childElementCount-3){i.classList.remove("av__row--select"),s.setAttribute("xlink:href","#iconUncheck"),o.classList.add("fn__none"),l.style.position="";return}else a>0&&(i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconIndeterminateCheck"));o.classList.remove("fn__none"),o.innerHTML=`${n} ${window.siyuan.languages.selected}`,l.style.position="sticky"},Ys=e=>{const t=parseInt(e.getAttribute("data-page-size"));if(t){const n=e.querySelectorAll(".av__row:not(.av__row--header)").length;t<n&&e.setAttribute("data-page-size",n.toString())}},dl=(e,t,n,a,i)=>{if(t.querySelector('[data-type="av-search"]').value!==""){showMessage(window.siyuan.languages.insertRowTip);return}let s=t.querySelector(`.av__row[data-id="${a}"]`)||t.querySelector(".av__row--header");t.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&(s=t.querySelector(".av__row--util").previousElementSibling);let o='<div class="av__firstcol av__colsticky"><svg><use xlink:href="#iconUncheck"></use></svg></div>';const l=s.querySelectorAll(".av__colsticky .av__cell").length-1;l>-1&&(o='<div class="av__colsticky"><div class="av__firstcol av__colsticky"><svg><use xlink:href="#iconUncheck"></use></svg></div>'),s.querySelectorAll(".av__cell").forEach((d,c)=>{var u;let f="";if(getTypeByCellElement(d)==="lineNumber"){const g=(u=d.querySelector(".av__celltext"))==null?void 0:u.getAttribute("data-value");g&&(f=(parseInt(g)+1).toString())}o+=`<div class="av__cell" data-col-id="${d.dataset.colId}" 
style="width: ${d.style.width};${d.dataset.dtype==="number"?"text-align: right;":""}" 
${getTypeByCellElement(d)==="block"?' data-detached="true"':""}><span class="${i?"av__celltext":"av__pulse"}">${f}</span></div>`,l===c&&(o+="</div>")});let r="";if(n.forEach(d=>{const c=t.querySelector(`[data-block-id="${d}"]`);c?(t.querySelectorAll(".av__cell--select, .av__cell--active").forEach(u=>{var f;u.classList.remove("av__cell--select","av__cell--active"),(f=u.querySelector(".av__drag-fill"))==null||f.remove()}),addDragFill(c),c.classList.add("av__cell--select")):r+=`<div class="av__row" data-type="ghost" data-id="${d}" data-avid="${i}" data-previous-id="${a}">
    ${o}
</div>`}),s.insertAdjacentHTML("afterend",r),i){const d=s.nextElementSibling;t.querySelector('.av__views [data-type="av-sort"]').classList.contains("block__icon--active")&&!t.querySelector('[data-type="av-load-more"]').parentElement.classList.contains("fn__none")&&d.setAttribute("data-need-update","true");const c=s.classList.contains("av__row--header")?d.nextElementSibling:s;fetchPost("/api/av/getAttributeViewFilterSort",{id:i,blockID:t.getAttribute("data-node-id")},u=>{let f=!1;u.data.filters.find(g=>{const p=t.querySelector(`.av__cell--header[data-col-id="${g.column}"]`);if(!p)return;const m=p.getAttribute("data-dtype");if(g.value&&m!==g.value.type)return;if(["relation","rollup","template"].includes(m))return f=!0,!0;["created","updated"].includes(m)?d.setAttribute("data-need-update","true"):u.data.sorts.find(v=>{if(v.column===g.column)return d.setAttribute("data-need-update","true"),!0});let y=!0;if(g.operator!=="Is empty"&&g.operator!=="Is not empty")switch(g.value.type){case"select":case"mSelect":(!g.value.mSelect||g.value.mSelect.length===0)&&(y=!1);break;case"block":(!g.value.block||!g.value.block.content)&&(y=!1);break;case"number":(!g.value.number||!g.value.number.isNotEmpty)&&(y=!1);break;case"date":case"created":case"updated":(!g.value[g.value.type]||!g.value[g.value.type].isNotEmpty)&&(y=!1);break;case"mAsset":(!g.value.mAsset||g.value.mAsset.length===0)&&(y=!1);break;case"checkbox":g.value.checkbox||(y=!1);break;case"text":case"url":case"phone":case"email":(!g.value[g.value.type]||!g.value[g.value.type].content)&&(y=!1);break}if(c.classList.contains("av__row")&&y){const v=c.querySelector(`.av__cell[data-col-id="${g.column}"]`),b=d.querySelector(`.av__cell[data-col-id="${g.column}"]`),w=genCellValueByElement(getTypeByCellElement(v),v);b.innerHTML=renderCell(w),renderCellAttr(b,w)}}),f?(d.remove(),showMessage(window.siyuan.languages.insertRowTip)):n.length===1&&popTextCell(e,[d.querySelector('.av__cell[data-detached="true"]')],"block"),Ys(t)})}Ys(t)},bn=(e,t,n)=>{const a=e.querySelector(".av__scroll").getBoundingClientRect(),i=e.querySelector(".av__row--header");if(i&&(n==="top"||n==="all")){const o=Math.floor(t.top-a.top);o>0&&o<a.height?i.style.transform=`translateY(${o}px)`:i.style.transform=""}const s=e.querySelector(".av__row--footer");if(s&&(n==="bottom"||n==="all"))if(s.querySelector(".av__calc--ashow")){const o=Math.ceil(t.bottom-s.parentElement.getBoundingClientRect().bottom);o<0&&-o<a.height?s.style.transform=`translateY(${o}px)`:s.style.transform=""}else s.style.transform=""},Ut=e=>{var t;if(e.currentPageSize===e.newPageSize)return;e.nodeElement.setAttribute("data-page-size",e.newPageSize);const n=e.nodeElement.getAttribute("data-node-id");transaction(e.protyle,[{action:"setAttrViewPageSize",avID:e.avID,data:parseInt(e.newPageSize),blockID:n}],[{action:"setAttrViewPageSize",data:parseInt(e.currentPageSize),avID:e.avID,blockID:n}]),(t=document.querySelector(".av__panel"))==null||t.remove()},af=e=>{const t=new Menu("av-page-size");if(t.isOpen)return;const n=e.target.dataset.size;t.addItem({iconHTML:"",label:"10",checked:n==="10",click(){Ut({currentPageSize:n,newPageSize:"10",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:n==="25",label:"25",click(){Ut({currentPageSize:n,newPageSize:"25",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:n==="50",label:"50",click(){Ut({currentPageSize:n,newPageSize:"50",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:n==="100",label:"100",click(){Ut({currentPageSize:n,newPageSize:"100",protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}}),t.addItem({iconHTML:"",checked:n===Constants.SIZE_DATABASE_MAZ_SIZE.toString(),label:window.siyuan.languages.all,click(){Ut({currentPageSize:n,newPageSize:Constants.SIZE_DATABASE_MAZ_SIZE.toString(),protyle:e.protyle,avID:e.avID,nodeElement:e.nodeElement})}});const a=e.target.getBoundingClientRect();t.open({x:a.left,y:a.bottom})},sf=(e,t)=>{const n=e.querySelectorAll(".av__row--select:not(.av__row--header)");if(n.length===0)return;const a=e.getAttribute("data-av-id"),i=[],s=[];n.forEach(l=>{s.push(l.querySelector(".av__cell[data-block-id]").getAttribute("data-block-id"))}),n.forEach(l=>{var r;const d=genCellValueByElement("block",l.querySelector(".av__cell[data-block-id]"));i.push({action:"insertAttrViewBlock",avID:a,previousID:((r=l.previousElementSibling)==null?void 0:r.getAttribute("data-id"))||"",srcs:[{id:l.getAttribute("data-id"),isDetached:d.isDetached,content:d.block.content}],blockID:e.dataset.nodeId})});const o=dayjs().format("YYYYMMDDHHmmss");i.push({action:"doUpdateUpdated",id:e.dataset.nodeId,data:e.getAttribute("updated")}),transaction(t,[{action:"removeAttrViewBlock",srcIDs:s,avID:a},{action:"doUpdateUpdated",id:e.dataset.nodeId,data:o}],i),n.forEach(l=>{l.remove()}),bn(e,t.contentElement.getBoundingClientRect(),"all"),fa(e.querySelector(".av__row")),e.setAttribute("updated",o)},of=(e,t,n,a)=>{const i=e.getAttribute("data-av-id"),s=[],o=[];new Array(n).fill(0).forEach(()=>{const r=Lute.NewNodeID();s.push(r),o.push({id:r,isDetached:!0,content:""})});const l=dayjs().format("YYYYMMDDHHmmss");transaction(t,[{action:"insertAttrViewBlock",avID:i,previousID:a,srcs:o,blockID:e.dataset.nodeId},{action:"doUpdateUpdated",id:e.dataset.nodeId,data:l}],[{action:"removeAttrViewBlock",srcIDs:s,avID:i},{action:"doUpdateUpdated",id:e.dataset.nodeId,data:e.getAttribute("updated")}]),dl(t,e,s,a,i),e.setAttribute("updated",l)},lf=e=>{hideElements(["gutterOnly"],e);const t=setPadding(e),n=4;setTimeout(()=>{if(!e.disabled){const a=e.contentElement.getBoundingClientRect();e.wysiwyg.element.querySelectorAll(".av").forEach(i=>{i.querySelector(".av__title")&&stickyRow(i,a,"all")})}if((t.width>n||isNaN(t.width))&&(typeof window.echarts!="undefined"&&e.wysiwyg.element.querySelectorAll('[data-subtype="echarts"], [data-subtype="mindmap"]').forEach(a=>{const i=window.echarts.getInstanceById(a.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));i&&i.resize()}),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(a=>{a.nextElementSibling.style.wordBreak==="break-word"&&lineNumberRender(a.parentElement)}),!e.disabled&&e.toolbar.range)){let a=e.toolbar.range.getBoundingClientRect();if(a.height===0){const s=hasClosestBlock(e.toolbar.range.startContainer);s&&(a=s.getBoundingClientRect())}if(a.height===0)return;const i=e.element.getBoundingClientRect();(i.top+30>a.top||i.bottom<a.bottom)&&e.toolbar.range.startContainer.parentElement.scrollIntoView(i.top>a.top)}},Constants.TIMEOUT_TRANSITION)},rf=(e,t)=>{var n,a,i,s;if(t==="preview"){if(!e.preview.element.classList.contains("fn__none"))return;e.preview.element.classList.remove("fn__none"),e.contentElement.classList.add("fn__none"),(n=e.scroll)==null||n.element.classList.add("fn__none"),e.options.render.breadcrumb&&((a=e.breadcrumb)==null||a.element.classList.add("fn__none"),e.breadcrumb.toggleExit(!0)),e.preview.render(e)}else if(t==="wysiwyg"){if(!e.contentElement.classList.contains("fn__none"))return;e.preview.element.classList.add("fn__none"),e.contentElement.classList.remove("fn__none"),e.options.render.scroll&&((i=e.scroll)==null||i.element.classList.remove("fn__none")),e.options.render.breadcrumb&&((s=e.breadcrumb)==null||s.element.classList.remove("fn__none"),e.breadcrumb.toggleExit(!e.block.showAll)),resize(e)}hideElements(["gutterOnly","toolbar","select","hint","util"],e)};let Us;const df=(e,t)=>{t.addEventListener("scroll",()=>{const n=t.getBoundingClientRect();if(!e.toolbar.element.classList.contains("fn__none")){const a=e.toolbar.element.getAttribute("data-inity").split(Constants.ZWSP),i=parseInt(a[0])+(parseInt(a[1])-t.scrollTop);i<n.top-e.toolbar.toolbarHeight||i>n.bottom-e.toolbar.toolbarHeight?e.toolbar.element.style.display="none":(e.toolbar.element.style.top=i+"px",e.toolbar.element.style.display="")}e.wysiwyg.element.querySelectorAll(".av").forEach(a=>{a.dataset.render==="true"&&stickyRow(a,n,"all")}),!e.element.classList.contains("block__edit")&&!isMobile()&&e.contentElement.setAttribute("data-scrolltop",t.scrollTop.toString()),window.siyuan.dragElement||hideElements(["gutterOnly"],e),e.scroll&&!e.scroll.element.classList.contains("fn__none")&&(clearTimeout(Us),Us=window.setTimeout(()=>{let a=document.elementFromPoint(n.left+n.width/2,n.top+10);a.classList.contains("protyle-wysiwyg")&&(a=document.elementFromPoint(n.left+n.width/2,n.top+20));const i=hasClosestBlock(a);if(!i){if((e.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||e.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0")&&(hasClosestByClassName(a,"protyle-background")||hasClosestByClassName(a,"protyle-title"))){const s=e.scroll.element.querySelector(".b3-slider");s.value="1",e.scroll.element.setAttribute("aria-label",`Blocks 1/${e.block.blockCount}`)}return}e.scroll.updateIndex(e,i.getAttribute("data-node-id"))},Constants.TIMEOUT_LOAD)),!(e.wysiwyg.element.getAttribute("data-top")||e.block.showAll||e.scroll&&e.scroll.element.classList.contains("fn__none")||!e.scroll||e.scroll.lastScrollTop===t.scrollTop||e.scroll.lastScrollTop===-1)&&(e.scroll.lastScrollTop-t.scrollTop>0?t.scrollTop<t.clientHeight&&e.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(e.contentElement.style.width=e.contentElement.clientWidth+"px",e.contentElement.style.overflow="hidden",e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{e.contentElement.style.overflow="",e.contentElement.style.width="",onGet({data:a,protyle:e,action:[Constants.CB_GET_BEFORE,Constants.CB_GET_UNCHANGEID]})})):t.scrollTop>t.scrollHeight-t.clientHeight*1.8&&e.wysiwyg.element.lastElementChild&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&(e.wysiwyg.element.setAttribute("data-top",t.scrollTop.toString()),fetchPost("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{onGet({data:a,protyle:e,action:[Constants.CB_GET_APPEND,Constants.CB_GET_UNCHANGEID]})})),e.scroll.lastScrollTop=Math.max(t.scrollTop,0))},{capture:!1,passive:!0,once:!1})},cf=e=>{e.contentElement=document.createElement("div"),e.contentElement.className="protyle-content",e.contentElement.innerHTML='<div class="protyle-top"></div>',e.options.render.background&&e.contentElement.firstElementChild.appendChild(e.background.element),e.options.render.title&&e.contentElement.firstElementChild.appendChild(e.title.element),e.contentElement.appendChild(e.wysiwyg.element),e.options.action.includes(Constants.CB_GET_HISTORY)||scrollEvent(e,e.contentElement),e.element.append(e.contentElement),e.element.appendChild(e.preview.element),e.upload&&e.element.appendChild(e.upload.element),e.options.render.scroll&&e.element.appendChild(e.scroll.element.parentElement),e.gutter&&e.element.appendChild(e.gutter.element),e.element.appendChild(e.hint.element),e.selectElement=document.createElement("div"),e.selectElement.className="protyle-select fn__none",e.element.appendChild(e.selectElement),e.element.appendChild(e.toolbar.element),e.element.appendChild(e.toolbar.subElement),cl(e),setEditMode(e,e.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p");let t;const n=genUUID(),a=isMac();e.contentElement.addEventListener("mousewheel",i=>{if(!(!window.siyuan.config.editor.fontSizeScrollZoom||a&&!i.metaKey||!a&&!i.ctrlKey||i.deltaX!==0)){if(i.preventDefault(),i.stopPropagation(),i.deltaY<0)if(window.siyuan.config.editor.fontSize<72)window.siyuan.config.editor.fontSize++;else return;else if(i.deltaY>0)if(window.siyuan.config.editor.fontSize>9)window.siyuan.config.editor.fontSize--;else return;setInlineStyle(),clearTimeout(t),showMessage(`${window.siyuan.languages.fontSize} ${window.siyuan.config.editor.fontSize}px<span class="fn__space"></span>
<button class="b3-button b3-button--small b3-button--white">${window.siyuan.languages.reset} 16px</button>`,void 0,void 0,n),t=window.setTimeout(()=>{var s;fetchPost("/api/setting/setEditor",window.siyuan.config.editor),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(o=>{lineNumberRender(o.parentElement)}),(s=document.querySelector(`#message [data-id="${n}"] button`))==null||s.addEventListener("click",()=>{window.siyuan.config.editor.fontSize=16,setInlineStyle(),fetchPost("/api/setting/setEditor",window.siyuan.config.editor),hideMessage(n),e.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber__rows").forEach(o=>{lineNumberRender(o.parentElement)})})},Constants.TIMEOUT_LOAD)}},{passive:!1}),e.contentElement.addEventListener("click",i=>{if(e.disabled||!i.target.classList.contains("protyle-content")&&!i.target.classList.contains("protyle-wysiwyg"))return;const s=e.wysiwyg.element.lastElementChild.getBoundingClientRect(),o=document.createRange();if(i.y>s.bottom){const l=getContenteditableElement(getLastBlock(e.wysiwyg.element.lastElementChild));if(!l||e.wysiwyg.element.lastElementChild.getAttribute("data-type")!=="NodeParagraph"&&e.wysiwyg.element.getAttribute("data-doc-type")!=="NodeListItem"||e.wysiwyg.element.lastElementChild.getAttribute("data-type")==="NodeParagraph"&&getContenteditableElement(l).innerHTML!==""){const r=genEmptyElement(!1,!1);e.wysiwyg.element.insertAdjacentElement("beforeend",r),transaction(e,[{action:"insert",data:r.outerHTML,id:r.getAttribute("data-node-id"),previousID:r.previousElementSibling.getAttribute("data-node-id"),parentID:e.block.parentID}],[{action:"delete",id:r.getAttribute("data-node-id")}]);const d=getContenteditableElement(r);o.selectNodeContents(d),o.collapse(!0),focusByRange(o),e.options.render.breadcrumb&&setTimeout(()=>{e.breadcrumb.render(e)},Constants.TIMEOUT_TRANSITION)}else l&&(o.selectNodeContents(l),o.collapse(!1),focusByRange(o))}})},cl=(e,t)=>{e.element.removeAttribute("data-loading"),setTimeout(()=>{e.element.getAttribute("data-loading")!=="finished"&&e.element.insertAdjacentHTML("beforeend",`<div style="background-color: var(--b3-theme-background);flex-direction: column;" class="fn__loading wysiwygLoading">
    <img width="48px" src="/stage/loading-pure.svg">
    <div style="color: var(--b3-theme-on-surface);margin-top: 8px;">${t||""}</div>
</div>`)},Constants.TIMEOUT_LOAD)},Ws=e=>{e.element.setAttribute("data-loading","finished"),e.element.querySelectorAll(".wysiwygLoading").forEach(t=>{t.remove()})},uf=e=>{if(e.options.action.includes(Constants.CB_GET_HISTORY))return{width:0,padding:0};const t=parseInt(e.wysiwyg.element.style.paddingLeft),n=ul(e),a=n.left,i=n.right;if(e.options.backlinkData?e.wysiwyg.element.style.padding=`4px ${i}px 4px ${a}px`:e.wysiwyg.element.style.padding=`${n.top}px ${i}px ${n.bottom}px ${a}px`,e.options.render.background&&e.background.element.querySelector(".protyle-background__ia").setAttribute("style",`margin-left:${a}px;margin-right:${i}px`),e.options.render.title&&(e.title.element.style.margin=`16px ${i}px 0 ${a}px`),window.siyuan.config.editor.displayBookmarkIcon){const l=document.getElementById("editorAttr");l&&(l.innerHTML=`.protyle-wysiwyg--attr .b3-tooltips:after { max-width: ${e.wysiwyg.element.clientWidth-a-i}px; }`)}const s=e.wysiwyg.element.getAttribute("data-realwidth"),o=e.wysiwyg.element.clientWidth-parseInt(e.wysiwyg.element.style.paddingLeft)-parseInt(e.wysiwyg.element.style.paddingRight);return e.wysiwyg.element.setAttribute("data-realwidth",o.toString()),{width:Math.abs(parseInt(s)-o),padding:Math.abs(t-parseInt(e.wysiwyg.element.style.paddingLeft))}},ul=e=>{let t=16,n=24,a=16;if(e.options.typewriterMode&&(isMobile()?a=window.innerHeight/5:a=e.element.clientHeight/2),!isMobile()){let i=e.wysiwyg.element.getAttribute(Constants.CUSTOM_SY_FULLWIDTH);i||(i=window.siyuan.config.editor.fullWidth?"true":"false");let s=(e.element.clientWidth-Constants.SIZE_EDITOR_WIDTH)/2;i==="false"&&s>96?(s>Constants.SIZE_EDITOR_WIDTH&&(s=e.element.clientWidth*.382/1.382),s=Math.ceil(s),n=s,t=s):e.element.clientWidth>Constants.SIZE_EDITOR_WIDTH&&(n=96,t=96)}return{left:n,right:t,bottom:a,top:16}},ff=(e,t,n)=>{if(!e.preview.element.classList.contains("fn__none")){e.preview.render(e);return}if(window.siyuan.config.editor.displayBookmarkIcon?e.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):e.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),e.title&&(e.title.element.removeAttribute("data-render"),e.title.element.setAttribute("spellcheck",window.siyuan.config.editor.spellcheck.toString()),window.siyuan.config.editor.displayBookmarkIcon?e.title.element.classList.add("protyle-wysiwyg--attr"):e.title.element.classList.remove("protyle-wysiwyg--attr")),e.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),e.lute.SetSpellcheck(window.siyuan.config.editor.spellcheck),e.lute.SetInlineAsterisk(window.siyuan.config.editor.markdown.inlineAsterisk),e.lute.SetInlineUnderscore(window.siyuan.config.editor.markdown.inlineUnderscore),e.lute.SetSup(window.siyuan.config.editor.markdown.inlineSup),e.lute.SetSub(window.siyuan.config.editor.markdown.inlineSub),e.lute.SetTag(window.siyuan.config.editor.markdown.inlineTag),e.lute.SetInlineMath(window.siyuan.config.editor.markdown.inlineMath),e.lute.SetGFMStrikethrough(window.siyuan.config.editor.markdown.inlineStrikethrough),e.lute.SetGFMStrikethrough1(!1),addLoading(e),e.options.backlinkData){const a=e.element.getAttribute("data-ismention")==="true",i=hasClosestByClassName(e.element,"sy__backlink");if(i){const s=i.querySelectorAll(".b3-text-field");fetchPost(a?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:e.element.getAttribute("data-defid"),refTreeID:e.block.rootID,keyword:a?s[1].value:s[0].value},o=>{e.options.backlinkData=a?o.data.backmentions:o.data.backlinks,renderBacklink(e,e.options.backlinkData)})}}else preventScroll(e),getDocByScroll({protyle:e,focus:t,scrollAttr:saveScroll(e,!0),updateReadonly:n})};var fl=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const gf=(e,t,n)=>{fetchPost("/api/block/getDocInfo",{id:e},a=>{t.updateTitle(a.data.name),n&&n.title&&n.title.setTitle(a.data.name)})},pf=(e,t,n=!0,a=!0,i=!1)=>{n&&hideMessage(),window.siyuan.mobile.popEditor&&(t.removeRootIDs.includes(window.siyuan.mobile.popEditor.protyle.block.rootID)?hideElements(["dialog"]):reloadProtyle(window.siyuan.mobile.popEditor.protyle,!1,a)),window.siyuan.mobile.editor&&(t.removeRootIDs.includes(window.siyuan.mobile.editor.protyle.block.rootID)?setEmpty(e):(reloadProtyle(window.siyuan.mobile.editor.protyle,!1,a),fetchPost("/api/block/getDocInfo",{id:window.siyuan.mobile.editor.protyle.block.rootID},s=>{bl(s.data.name),window.siyuan.mobile.editor.protyle.title.setTitle(s.data.name)}))),setNoteBook(()=>{window.siyuan.mobile.files.init(!1)})},mf=e=>{getAllEditor().forEach(t=>{t.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.blockID}"] span[data-type="block-ref"][data-subtype="d"][data-id="${e.defBlockID}"]`).forEach(n=>{n.innerHTML=e.refText})})},bf=e=>{getAllEditor().forEach(n=>{if(e.rootID===e.blockID&&n.protyle.block.rootID===e.rootID){const a=n.protyle.title.element.querySelector(".protyle-attr"),i=a.querySelector(".protyle-attr--refcount");i?e.refCount===0?i.remove():(i.textContent=e.refCount.toString(),i.setAttribute("data-id",e.refIDs.toString())):e.refCount>0&&a.insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block" data-defids="[&quot;${e.blockID}&quot;]" data-id="${e.refIDs.toString()}" style="">${e.refCount}</div>`);return}n.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.blockID}"]`).forEach(a=>{const i=a.lastElementChild.querySelector(".protyle-attr--refcount");if(i)e.refCount===0?i.remove():i.textContent=e.refCount.toString();else if(e.refCount>0){const s=a.lastElementChild;s.childElementCount>0?s.lastElementChild.insertAdjacentHTML("afterend",`<div class="protyle-attr--refcount popover__block">${e.refCount}</div>`):s.innerHTML=`<div class="protyle-attr--refcount popover__block">${e.refCount}</div>${Constants.ZWSP}`}e.refCount===0?a.removeAttribute("refcount"):a.setAttribute("refcount",e.refCount.toString())})});let t;if(t=window.siyuan.mobile.files.element.querySelector(`li[data-node-id="${e.rootID}"]`),t){const n=t.querySelector(".counter");n?e.rootRefCount===0?n.remove():n.textContent=e.rootRefCount.toString():e.rootRefCount>0&&t.insertAdjacentHTML("beforeend",`<span class="popover__block counter b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.ref}">${e.rootRefCount}</span>`)}},hf=e=>{window.siyuan.config.readonly||(e.plugins.forEach(t=>{t.eventBus.emit("lock-screen")}),fetchPost("/api/system/logoutAuth",{},()=>{redirectToCheckAuth()}))},gl=()=>{if(document.querySelector("#errorLog"))return;let e="";Zt()&&(e=`<div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const t=new va({disableClose:!0,title:`\u{1F494} ${window.siyuan.languages.kernelFault0} <small>v${x.SIYUAN_VERSION}</small>`,width:re()?"92vw":"520px",content:`<div class="b3-dialog__content">
<div class="ft__breakword">
    <div>${window.siyuan.languages.kernelFault1}</div>
    <div class="fn__hr"></div>
    <div>${window.siyuan.languages.kernelFault2}</div>
    ${e}
</div>
</div>`});t.element.id="errorLog",t.element.setAttribute("data-key",x.DIALOG_KERNELFAULT);const n=t.element.querySelector(".b3-button");n&&n.addEventListener("click",()=>{t.destroy(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")})},pl=()=>fl(void 0,null,function*(){hideAllElements(["util"]),window.siyuan.mobile.editor&&(yield saveScroll(window.siyuan.mobile.editor.protyle)),fetchPost("/api/system/exit",{force:!1},e=>{if(e.code===1){const t=showMessage(e.msg,e.data.closeTimeout,"error"),n=document.querySelector(`#message [data-id="${t}"] button`);n&&n.addEventListener("click",()=>{fetchPost("/api/system/exit",{force:!0},()=>{(isInIOS()||isInAndroid())&&(window.location.href="siyuan://api/system/exit")})})}else e.code===2?(hideMessage(),confirmDialog(window.siyuan.languages.tip,e.msg,()=>{fetchPost("/api/system/exit",{force:!0,execInstallPkg:2},()=>{})},()=>{fetchPost("/api/system/exit",{force:!0,execInstallPkg:1},()=>{})})):(isInIOS()||isInAndroid())&&(window.location.href="siyuan://api/system/exit")})}),yf=()=>{if(document.getElementById("transactionError"))return;const e=new Dialog({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${Constants.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>
    <div class="fn__space"></div>
    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>
</div>`,width:isMobile()?"92vw":"520px"});e.element.setAttribute("data-key",Constants.DIALOG_STATEEXCEPTED);const t=e.element.querySelectorAll(".b3-button");t[0].addEventListener("click",()=>{pl()}),t[1].addEventListener("click",()=>{ml(),e.destroy()})},ml=e=>{window.siyuan.storage[Constants.LOCAL_FILEPOSITION]={},setStorageVal(Constants.LOCAL_FILEPOSITION,window.siyuan.storage[Constants.LOCAL_FILEPOSITION]),fetchPost("/api/filetree/refreshFiletree",{},()=>{e&&e()})};let hn;const wf=e=>{const t=document.querySelector("#status");if(t)if(isMobile()){if(!document.querySelector("#keyboardToolbar").classList.contains("fn__none"))return;clearTimeout(hn),t.innerHTML=e.msg,t.style.bottom="0",hn=window.setTimeout(()=>{t.style.bottom=""},7e3)}else{const n=t.querySelector(".status__msg");n&&(clearTimeout(hn),n.innerHTML=e.msg,hn=window.setTimeout(()=>{n.innerHTML=""},7e3))}},_f=e=>{let t=document.getElementById("progress");if(t||(document.body.insertAdjacentHTML("beforeend",`<div id="progress" style="z-index: ${++window.siyuan.zIndex}"></div>`),t=document.getElementById("progress")),e.code===2){t.remove();return}e.code===0?t.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="text-align: right">${e.data.current}/${e.data.total}</div>
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="width: ${e.data.current/e.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>
    <div>${e.msg}</div>
</div>`:e.code===1&&(t.lastElementChild?t.lastElementChild.lastElementChild.innerHTML=e.msg:t.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div class="b3-dialog__loading">
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>
    <div>${e.msg}</div>
</div>`)},vf=e=>{const t=document.querySelector(".status__backgroundtask");t&&(e.length===0?(t.classList.add("fn__none"),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusBackgroundTask"&&window.siyuan.menus.menu.remove()):(t.classList.remove("fn__none"),t.setAttribute("data-tasks",JSON.stringify(e)),t.innerHTML=e[0].action+"<div><div></div></div>"))},Ef=()=>{fetchPost("/api/sync/getBootSync",{},e=>{if(e.code===1){const t=new Dialog({width:isMobile()?"92vw":"50vw",title:"\u{1F329}\uFE0F "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${e.msg}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>
</div>`});t.element.setAttribute("data-key",Constants.DIALOG_BOOTSYNCFAILED);const n=t.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{n[1].getAttribute("disabled")||(n[1].setAttribute("disabled","disabled"),fetchPost("/api/sync/performBootSync",{},a=>{a.code===0&&t.destroy(),n[1].removeAttribute("disabled")}))})}})},bl=e=>{const t=document.getElementById("drag"),n=getWorkspaceName();if(e===window.siyuan.languages.siyuanNote){const a=`${n} - ${window.siyuan.languages.siyuanNote} v${Constants.SIYUAN_VERSION}`;document.title=a,t&&(t.textContent=a,t.setAttribute("title",a))}else{if(e=e||window.siyuan.languages.untitled,document.title=`${e} - ${n} - ${window.siyuan.languages.siyuanNote} v${Constants.SIYUAN_VERSION}`,!t)return;t.setAttribute("title",e),t.innerHTML=escapeHtml(e)}},kf=e=>{const t=document.querySelector("#configBazaarReadme .item__side");if(!t||e.id!==JSON.parse(t.getAttribute("data-obj")).repoURL)return;const n=t.querySelector('[data-type="install"]');n&&(e.percent>=1?(n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-button--progress"),n.parentElement.nextElementSibling.firstElementChild.classList.add("b3-button--progress"),n.innerHTML=`<span style="width: ${e.percent*100}%"></span>`,n.parentElement.nextElementSibling.firstElementChild.innerHTML=`<span style="width: ${e.percent*100}%"></span>`))},Cf=(e,t)=>{const n=document.querySelector("#menuSyncNow use"),a=document.querySelector("#toolbarSync use");if(!e){!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&needSubscribe("")?(n==null||n.setAttribute("xlink:href","#iconCloudOff"),a.setAttribute("xlink:href","#iconCloudOff")):(n==null||n.setAttribute("xlink:href","#iconCloudSucc"),a.setAttribute("xlink:href","#iconCloudSucc"));return}n==null||n.parentElement.classList.remove("fn__rotate"),a.parentElement.classList.remove("fn__rotate"),e.code===0?(n==null||n.parentElement.classList.add("fn__rotate"),a.parentElement.classList.add("fn__rotate"),n==null||n.setAttribute("xlink:href","#iconRefresh"),a.setAttribute("xlink:href","#iconRefresh")):e.code===2?(n==null||n.setAttribute("xlink:href","#iconCloudError"),a.setAttribute("xlink:href","#iconCloudError")):e.code===1&&(n==null||n.setAttribute("xlink:href","#iconCloudSucc"),a.setAttribute("xlink:href","#iconCloudSucc")),t.forEach(i=>{e.code===0?i.eventBus.emit("sync-start",e):e.code===1?i.eventBus.emit("sync-end",e):e.code===2&&i.eventBus.emit("sync-fail",e)})};var hl=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const Se=(e,t,n,a)=>{const i={method:"POST"};t&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(e)&&(window.siyuan.reqIds[e]=new Date().getTime(),t.type==="local"&&e==="/api/graph/getLocalGraph"||(t.reqId=window.siyuan.reqIds[e])),e==="/api/transactions"&&(t.reqId=new Date().getTime()),t instanceof FormData?i.body=t:i.body=JSON.stringify(t)),a&&(i.headers=a),fetch(e,i).then(s=>{var o;switch(s.status){case 403:case 404:return{data:null,msg:s.statusText,code:-s.status};default:return((o=s.headers.get("content-type"))==null?void 0:o.indexOf("application/json"))>-1?s.json():s.text()}}).then(s=>{if(typeof s=="string"){n&&n(s);return}["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(e)&&s.data.reqId&&window.siyuan.reqIds[e]&&window.siyuan.reqIds[e]>s.data.reqId||(typeof s=="object"&&typeof s.msg=="string"&&typeof s.code=="number"?_a(s)&&n&&n(s):n&&n(s))}).catch(s=>{if(console.warn("fetch post failed ["+s+"], url ["+e+"]"),e==="/api/transactions"&&(s.message==="Failed to fetch"||s.message==="Unexpected end of JSON input")){gl();return}})},yl=(e,t)=>hl(void 0,null,function*(){const n={method:"POST"};t&&(t instanceof FormData?n.body=t:n.body=JSON.stringify(t));const i=yield(yield fetch(e,n)).json();return _a(i),i}),Af=(e,t)=>{fetch(e).then(n=>{var a;return((a=n.headers.get("content-type"))==null?void 0:a.indexOf("application/json"))>-1?n.json():n.text()}).then(n=>{t(n)})};var wl=(e,t,n)=>new Promise((a,i)=>{var s=r=>{try{l(n.next(r))}catch(d){i(d)}},o=r=>{try{l(n.throw(r))}catch(d){i(d)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((n=n.apply(e,t)).next())});const js=(e,t)=>{addScript(e,"iconDefaultScript").then(()=>{if(!["ant","material"].includes(t.icon)){const n=document.getElementById("iconScript");n&&n.remove(),addScript(`/appearance/icons/${t.icon}/icon.js?v=${t.iconVer}`,"iconScript")}})},_l=e=>{const t=document.getElementsByTagName("html")[0];t.setAttribute("lang",window.siyuan.config.appearance.lang),t.setAttribute("data-theme-mode",El()),t.setAttribute("data-light-theme",window.siyuan.config.appearance.themeLight),t.setAttribute("data-dark-theme",window.siyuan.config.appearance.themeDark);const n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===1&&n==="light"||window.siyuan.config.appearance.mode===0&&n==="dark")&&(fetchPost("/api/system/setAppearanceMode",{mode:n==="light"?0:1}),window.siyuan.config.appearance.mode=n==="light"?0:1);const a=document.getElementById("themeDefaultStyle"),i=`/appearance/themes/${e.mode===1?"midnight":"daylight"}/theme.css?v=${Constants.SIYUAN_VERSION}`;a?a.getAttribute("href").startsWith(i)||a.setAttribute("href",i):addStyle(i,"themeDefaultStyle");const s=document.getElementById("themeStyle");if(e.mode===1&&e.themeDark!=="midnight"||e.mode===0&&e.themeLight!=="daylight"){const c=`/appearance/themes/${e.mode===1?e.themeDark:e.themeLight}/theme.css?v=${e.themeVer}`;s?s.getAttribute("href").startsWith(c)||s.setAttribute("href",c):addStyle(c,"themeStyle")}else s&&s.remove();Vs();const o=document.getElementById("themeScript"),l=`/appearance/themes/${e.mode===1?e.themeDark:e.themeLight}/theme.js?v=${e.themeVer}`;o&&o.remove(),addScript(l,"themeScript");const r=document.getElementById("iconDefaultScript"),d=`/appearance/icons/${["ant","material"].includes(e.icon)?e.icon:"material"}/icon.js?v=${Constants.SIYUAN_VERSION}`;if(r){r.remove();let c=document.body.firstElementChild;for(;c.tagName==="svg";){const u=c;c=c.nextElementSibling,u.getAttribute("data-name")||u.remove()}js(d,e)}else js(d,e)},Lf=()=>{const e=document.getElementById("loading");e&&setTimeout(()=>{e.remove()},160),Gs(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",t=>{const n=t.matches?"dark":"light";Gs(n),window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===0&&n==="light"||window.siyuan.config.appearance.mode===1&&n==="dark"||fetchPost("/api/system/setAppearanceMode",{mode:n==="light"?0:1},a=>wl(void 0,null,function*(){if(window.siyuan.config.appearance.themeJS)if(window.destroyTheme)try{yield window.destroyTheme(),window.destroyTheme=void 0}catch(i){console.error("destroyTheme error: "+i)}else{window.location.reload();return}window.siyuan.config.appearance=a.data.appearance,_l(a.data.appearance)})))})},Sf=()=>{if(!window.siyuan.config.system.disableGoogleAnalytics){addScript("https://www.googletagmanager.com/gtag/js?id=G-L7WEXVQCR9","gaScript"),window.dataLayer=window.dataLayer||[];const e=function(...n){window.dataLayer.push(arguments)};e("js",new Date),e("config","G-L7WEXVQCR9",{send_page_view:!1});const t={version:Constants.SIYUAN_VERSION,container:window.siyuan.config.system.container,os:window.siyuan.config.system.os,osPlatform:window.siyuan.config.system.osPlatform,isLoggedIn:!1,subscriptionStatus:-1,subscriptionPlan:-1,subscriptionType:-1,oneTimePayStatus:-1,syncEnabled:!1,syncProvider:-1,cTreeCount:window.siyuan.config.stat.cTreeCount,cBlockCount:window.siyuan.config.stat.cBlockCount,cDataSize:window.siyuan.config.stat.cDataSize,cAssetsSize:window.siyuan.config.stat.cAssetsSize};window.siyuan.user&&(t.isLoggedIn=!0,t.subscriptionStatus=window.siyuan.user.userSiYuanSubscriptionStatus,t.subscriptionPlan=window.siyuan.user.userSiYuanSubscriptionPlan,t.subscriptionType=window.siyuan.user.userSiYuanSubscriptionType,t.oneTimePayStatus=window.siyuan.user.userSiYuanOneTimePayStatus),window.siyuan.config.sync&&(t.syncEnabled=window.siyuan.config.sync.enabled,t.syncProvider=window.siyuan.config.sync.provider),e("event",Constants.ANALYTICS_EVT_ON_GET_CONFIG,t)}},xf=(e=!0)=>{const t=Math.floor(window.siyuan.config.editor.fontSize*1.625);let n=`.b3-typography, .protyle-wysiwyg, .protyle-title {font-size:${window.siyuan.config.editor.fontSize}px !important}
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }
.li > .protyle-action {height:${t+8}px;line-height: ${t+8}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h1, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h2, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h3, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h4, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h5, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h6 {line-height:${t+8}px;}
.protyle-wysiwyg [data-node-id].li > .protyle-action:after {height: ${window.siyuan.config.editor.fontSize}px;width: ${window.siyuan.config.editor.fontSize}px;margin:-${window.siyuan.config.editor.fontSize/2}px 0 0 -${window.siyuan.config.editor.fontSize/2}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action svg {height: ${Math.max(14,window.siyuan.config.editor.fontSize-8)}px}
.protyle-wysiwyg [data-node-id].li:before {height: calc(100% - ${t+8}px);top:${t+8}px}
.protyle-wysiwyg [data-node-id] [spellcheck] {min-height:${t}px;}
.protyle-wysiwyg .p,
.protyle-wysiwyg .code-block .hljs,
.protyle-wysiwyg .table,
.protyle-wysiwyg .render-node protyle-html,
.protyle-wysiwyg .render-node > div[spin="1"],
.protyle-wysiwyg [data-type="NodeHeading"] {${window.siyuan.config.editor.rtl?" direction: rtl;":""}}
.protyle-wysiwyg [data-node-id] {${window.siyuan.config.editor.justify?" text-align: justify;":""}}
.protyle-wysiwyg .li {min-height:${t+8}px}
.protyle-gutters button svg {height:${t}px}`;if(window.siyuan.config.editor.fontFamily&&(n+=`
.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title {font-family: "${window.siyuan.config.editor.fontFamily}", var(--b3-font-family-protyle)}`),"ontouchend"in document&&(n+=`
.b3-menu .b3-menu__action {opacity: 0.68;}`),e){const a=document.getElementById("siyuanStyle");a?a.innerHTML=n:document.querySelector("#pluginsStyle").insertAdjacentHTML("beforebegin",`<style id="siyuanStyle">${n}</style>`)}return n},Vs=(e=x.PROTYLE_CDN)=>{const t=document.getElementById("protyleHljsStyle");let n;window.siyuan.config.appearance.mode===0?(n=window.siyuan.config.appearance.codeBlockThemeLight,x.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(n)||(n="default")):(n=window.siyuan.config.appearance.codeBlockThemeDark,x.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(n)||(n="github-dark"));const a=`${e}/js/highlight.js/styles/${n}.min.css?v=11.5.0`;t?t.href.includes(a)||(t.remove(),_n(a,"protyleHljsStyle")):_n(a,"protyleHljsStyle")},Tf=e=>{},vl=e=>{if(e.startsWith("#"))return e;let t;const n=e.replace(/\s/g,"").match(/^rgba?\((\d+),(\d+),(\d+),?([^,\s)]+)?/i),a=(n&&n[4]||"").trim();let i=n?(n[1]|1<<8).toString(16).slice(1)+(n[2]|1<<8).toString(16).slice(1)+(n[3]|1<<8).toString(16).slice(1):e;return a!==""?t=a:t=1,t=(t*255|1<<8).toString(16).slice(1),i=i+t,i},Gs=e=>{(isInIOS()||isInAndroid())&&setTimeout(()=>{const t=vl(getComputedStyle(document.body).getPropertyValue("--b3-theme-background").trim());let n=window.siyuan.config.appearance.mode;window.siyuan.config.appearance.modeOS&&(e==="dark"?n=1:n=0),isInIOS()?window.webkit.messageHandlers.changeStatusBar.postMessage((t||(n===0?"#fff":"#1e1e1e"))+" "+n):isInAndroid()&&window.JSAndroid.changeStatusBarColor(t,n)},500)},El=()=>{const e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return window.siyuan.config.appearance.modeOS?e:window.siyuan.config.appearance.mode===0?"light":"dark"},mt=(e,t=x.PROTYLE_CDN)=>{let n,a=!1;e.classList.contains("code-block")?n=e.querySelectorAll(".hljs"):e.classList.contains("item__readme")?(n=e.querySelectorAll("pre code"),n.forEach(i=>{i.parentElement.setAttribute("lineNumber","false")})):e.classList.contains("b3-typography")?(n=e.querySelectorAll(".code-block code"),a=!0):n=e.querySelectorAll(".code-block .hljs"),n.length!==0&&(Vs(t),ae(`${t}/js/highlight.js/highlight.min.js?v=11.7.0`,"protyleHljsScript").then(()=>{ae(`${t}/js/highlight.js/third-languages.js?v=1.0.1`,"protyleHljsThirdScript").then(()=>{n.forEach(i=>{const s=i.parentElement.querySelectorAll(".protyle-icon");if(s.length===2&&(s[0].setAttribute("aria-label",window.siyuan.languages.copy),s[1].setAttribute("aria-label",window.siyuan.languages.more)),i.getAttribute("data-render")==="true")return;const o=i.querySelector("wbr");let l=0;if(o){let p=o.previousSibling;for(;p;){for(l+=p.textContent.length;!p.previousSibling&&p.parentElement.tagName!=="DIV";)p=p.parentElement;p=p.previousSibling}o.remove()}let r;a?r=i.parentElement.getAttribute("data-language"):i.previousElementSibling?r=i.previousElementSibling.firstElementChild.textContent:r=i.className.replace("language-",""),window.hljs.getLanguage(r)||(r="plaintext"),i.classList.add("hljs"),i.setAttribute("data-render","true");const d=i.parentElement.getAttribute("linewrap"),c=i.parentElement.getAttribute("ligatures"),u=i.parentElement.getAttribute("linenumber"),f=i.lastElementChild?i.lastElementChild:i;d==="true"||d!=="false"&&window.siyuan.config.editor.codeLineWrap?(f.style.setProperty("white-space","pre-wrap"),f.style.setProperty("word-break","break-word")):(f.style.setProperty("white-space","pre"),f.style.setProperty("word-break","initial")),c==="true"||c!=="false"&&window.siyuan.config.editor.codeLigatures?f.style.fontVariantLigatures="normal":f.style.fontVariantLigatures="none";const g=f.textContent;i.firstElementChild&&(!a&&(u==="true"||u!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(i.firstElementChild.className="protyle-linenumber__rows",i.firstElementChild.setAttribute("contenteditable","false"),zs(i)):(i.firstElementChild.className="fn__none",i.firstElementChild.innerHTML="",f.style.paddingLeft="")),f.innerHTML=window.hljs.highlight(g+(g.endsWith(`
`)?"":`
`),{language:r,ignoreIllegals:!0}).value,o&&getSelection().rangeCount>0&&ma(i,l,l)})})}))},zs=e=>{const t=e.parentElement.getAttribute("lineNumber");if(t==="false"||!window.siyuan.config.editor.codeSyntaxHighlightLineNum&&t!=="true")return;e.parentElement.style.lineHeight=`${((parseInt(e.parentElement.style.fontSize)||window.siyuan.config.editor.fontSize)*1.625*.85).toFixed(0)}px`;const n=e.lastElementChild;let a="";const i=n.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);i[i.length-1]===""&&i.length>1&&i.pop(),e.firstElementChild.innerHTML=`<span>${i.length}</span>`,n.style.paddingLeft=`${e.firstElementChild.clientWidth+16}px`;const s=document.createElement("div");s.className="hljs",s.setAttribute("style",`padding-left:${n.style.paddingLeft};
width: ${n.clientWidth}px;
white-space:${n.style.whiteSpace};
word-break:${n.style.wordBreak};
font-variant-ligatures:${n.style.fontVariantLigatures};
box-sizing: border-box;position: absolute;padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;`),s.setAttribute("contenteditable","true"),e.insertAdjacentElement("afterend",s);const o=n.style.wordBreak==="break-word";i.map(l=>{let r="";o&&(s.textContent=l.trim()?l:"<br>",r=` style="height:${s.clientHeight}px;"`),a+=`<span${r}></span>`}),s.remove(),e.firstElementChild.innerHTML=a};class He{}He.graphvizRender=J,He.highlightRender=mt,He.mathRender=In,He.mermaidRender=Dn,He.flowchartRender=$n,He.chartRender=Tn,He.abcRender=xn,He.mindmapRender=Mn,He.plantumlRender=Hn,He.avRender=Xe,He.htmlRender=Nn,window.Protyle=He;const kl=He})(),jt=jt.default,jt})())});Al();})();
